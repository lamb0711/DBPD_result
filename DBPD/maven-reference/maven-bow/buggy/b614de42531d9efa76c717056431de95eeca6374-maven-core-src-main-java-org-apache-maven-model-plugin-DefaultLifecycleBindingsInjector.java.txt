[MNG-4341] [regression] Plugins are not executed in POM order

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@812259 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.HashMap;
-                Map<Object, Plugin> merged = new LinkedHashMap<Object, Plugin>( ( src.size() + tgt.size() ) * 2 );
+                Map<Object, Plugin> merged = new LinkedHashMap<Object, Plugin>( src.size() * 2 );
+                Map<Object, List<Plugin>> predecessors = new HashMap<Object, List<Plugin>>();
+
+                List<Plugin> pending = new ArrayList<Plugin>( tgt.size() );
+
+                        merged.put( key, element );
+
+                        if ( !pending.isEmpty() )
+                        {
+                            predecessors.put( key, pending );
+                            pending = new ArrayList<Plugin>();
+                        }
-                    merged.put( key, element );
+                    else
+                    {
+                        pending.add( element );
+                    }
-                target.setPlugins( new ArrayList<Plugin>( merged.values() ) );
+                List<Plugin> result = new ArrayList<Plugin>( src.size() + tgt.size() );
+
+                for ( Map.Entry<Object, Plugin> entry : merged.entrySet() )
+                {
+                    List<Plugin> pre = predecessors.get( entry.getKey() );
+
+                    if ( pre != null )
+                    {
+                        result.addAll( pre );
+                    }
+
+                    result.add( entry.getValue() );
+                }
+
+                result.addAll( pending );
+
+                target.setPlugins( result );
