o Revised extension caching to be insensitive to POM repos

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@819868 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.plugin.PluginArtifactsCache;
+    private PluginArtifactsCache pluginArtifactsCache;
+
+    @Requirement
-            ClassRealm extensionRealm;
-            ExtensionDescriptor extensionDescriptor = null;
-            ExtensionRealmCache.CacheRecord record = extensionRealmCache.get( plugin, repositoryRequest );
+            PluginArtifactsCache.CacheRecord recordArtifacts =
+                pluginArtifactsCache.get( plugin, repositoryRequest, null );
-            if ( record != null )
+            if ( recordArtifacts != null )
-                extensionRealm = record.realm;
-                artifacts = record.artifacts;
-                extensionDescriptor = record.desciptor;
+                artifacts = recordArtifacts.artifacts;
+                recordArtifacts = pluginArtifactsCache.put( plugin, repositoryRequest, null, artifacts );
+            }
+
+            pluginArtifactsCache.register( project, recordArtifacts );
+
+            ClassRealm extensionRealm;
+            ExtensionDescriptor extensionDescriptor = null;
+
+            ExtensionRealmCache.CacheRecord recordRealm = extensionRealmCache.get( artifacts );
+
+            if ( recordRealm != null )
+            {
+                extensionRealm = recordRealm.realm;
+                extensionDescriptor = recordRealm.desciptor;
+            }
+            else
+            {
-                extensionRealmCache.put( plugin, repositoryRequest, extensionRealm, artifacts, extensionDescriptor );
+                recordRealm = extensionRealmCache.put( artifacts, extensionRealm, extensionDescriptor );
-            extensionRealmCache.register( project, extensionRealm );
+            extensionRealmCache.register( project, recordRealm );
