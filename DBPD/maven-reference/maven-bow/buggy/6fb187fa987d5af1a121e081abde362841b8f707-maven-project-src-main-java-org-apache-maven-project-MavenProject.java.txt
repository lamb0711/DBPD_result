[MNG-2006] Fixing url rewriting for child POMs in sibling directories of parent POM (or anything other than subdir). First guess is based on parent POM file, but if parent POM is built from repository, will use the module artifactId as a basis instead.

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@379572 13f79535-47bb-0310-9956-ffa450edef68

-    private Map moduleFiles;
+    private Map moduleAdjustments;
-        File module = moduleProject.getFile();
+        // FIXME: This is hacky. What if module directory doesn't match artifactid, and parent
+        // is coming from the repository??
+        String module = moduleProject.getArtifactId();
-        if ( module == null )
+        File moduleFile = moduleProject.getFile();
+        
+        if ( moduleFile != null )
-            return null;
+            File moduleDir = moduleFile.getCanonicalFile().getParentFile();
+            
+            module = moduleDir.getName();
-        module = module.getCanonicalFile();
-        
-        if ( moduleFiles == null )
+        if ( moduleAdjustments == null )
-            moduleFiles = new HashMap();
+            moduleAdjustments = new HashMap();
-            File myFile = getFile();
-            
-            if ( myFile != null )
+            if ( modules != null )
-                File myDir = myFile.getCanonicalFile().getParentFile();
-                if ( modules != null )
+                for ( Iterator it = modules.iterator(); it.hasNext(); )
-                    for ( Iterator it = modules.iterator(); it.hasNext(); )
+                    String modulePath = (String) it.next();
+                    String moduleName = modulePath;
+                    
+                    if ( moduleName.endsWith( "/" ) || moduleName.endsWith( "\\" ) )
-                        String modulePath = (String) it.next();
-
-                        File moduleFile = new File( myDir, modulePath ).getCanonicalFile();
-
-                        moduleFiles.put( moduleFile, modulePath );
+                        moduleName = moduleName.substring( 0, moduleName.length() - 1 );
+                    
+                    int lastSlash = moduleName.lastIndexOf( '/' );
+                    
+                    if ( lastSlash < 0 )
+                    {
+                        lastSlash = moduleName.lastIndexOf( '\\' );
+                    }
+                    
+                    String adjustment = null;
+                    
+                    if ( lastSlash > -1 )
+                    {
+                        moduleName = moduleName.substring( lastSlash + 1 );
+                        adjustment = modulePath.substring( 0, lastSlash );
+                    }
+
+                    moduleAdjustments.put( moduleName, adjustment );
-            }            
+            }
-        return (String) moduleFiles.get( module );
+        return (String) moduleAdjustments.get( module );
