[MNG-3106,3983,4107] - profile fixes.

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@761825 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.maven.model.Parent;
+import org.apache.maven.profiles.matchers.FileMatcher;
-        Collections.unmodifiableList( Arrays.asList( new DefaultMatcher(), new PropertyMatcher() ) );    
+        (List<ProfileMatcher>) Collections.unmodifiableList( Arrays.asList( new DefaultMatcher(), new PropertyMatcher(), new FileMatcher() ) );    
-
-            boolean shouldAdd = false;
-            if ( profileActivationContext.isExplicitlyActive( profileId ) )
-            {
-                shouldAdd = true;
-            }
-            else if ( isActive( profile, profileActivationContext ) )
-            {
-                shouldAdd = true;
-            }
-
-            if ( !profileActivationContext.isExplicitlyInactive( profileId ) && shouldAdd )
+            if ( !profileActivationContext.isExplicitlyInactive( profileId )
+            		&& (profileActivationContext.isExplicitlyActive( profileId ) || isActive( profile, profileActivationContext ) ) )
-	    ProfileActivationContext profileActivationContext = (externalProfileManager == null) ? new ProfileActivationContext( config.getExecutionProperties(), false ):
+	    Properties props = new Properties(config.getExecutionProperties());
+	    props.putAll(config.getUserProperties());
+	    
+	    ProfileActivationContext profileActivationContext = (externalProfileManager == null) ? new ProfileActivationContext( props, false ):
-	 
+	    
