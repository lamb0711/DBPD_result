[MNG-4895] Plugins depending on 3rd party JARs that contain the Maven API can't be configured/run due to type incompatibilities

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@1034880 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.HashMap;
-        ClassRealm pluginRealm = classRealmManager.createPluginRealm( plugin, parent, imports, pluginArtifacts );
+        Map<String, ClassLoader> foreignImports = calcImports( project, parent, imports );
+
+        ClassRealm pluginRealm =
+            classRealmManager.createPluginRealm( plugin, parent, null, foreignImports, pluginArtifacts );
+    private Map<String, ClassLoader> calcImports( MavenProject project, ClassLoader parent, List<String> imports )
+    {
+        Map<String, ClassLoader> foreignImports = new HashMap<String, ClassLoader>();
+
+        ClassLoader projectRealm = project.getClassRealm();
+        if ( projectRealm != null )
+        {
+            foreignImports.put( "", projectRealm );
+        }
+        else
+        {
+            foreignImports.put( "", classRealmManager.getMavenApiRealm() );
+        }
+
+        if ( parent != null && imports != null )
+        {
+            for ( String parentImport : imports )
+            {
+                foreignImports.put( parentImport, parent );
+            }
+        }
+
+        return foreignImports;
+    }
+
