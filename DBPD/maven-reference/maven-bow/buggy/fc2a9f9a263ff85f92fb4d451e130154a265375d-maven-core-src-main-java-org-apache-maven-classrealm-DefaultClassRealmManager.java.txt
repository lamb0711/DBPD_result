[MNG-4787] Allow class realm manager delegates to alter public part of Maven core realm

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@991347 13f79535-47bb-0310-9956-ffa450edef68

+
+
+
+            List<ClassRealmManagerDelegate> delegates = getDelegates();
+            if ( !delegates.isEmpty() )
+            {
+                List<ClassRealmConstituent> constituents = new ArrayList<ClassRealmConstituent>();
+
+                ClassRealmRequest request =
+                    new DefaultClassRealmRequest( RealmType.Core, null, new ArrayList<String>(), constituents );
+
+                for ( ClassRealmManagerDelegate delegate : delegates )
+                {
+                    delegate.setupRealm( mavenRealm, request );
+                }
+
+                populateRealm( mavenRealm, constituents );
+            }
-        ClassRealmRequest request = new DefaultClassRealmRequest( type, parent, imports, constituents );
-
-        for ( ClassRealmManagerDelegate delegate : getDelegates() )
+        List<ClassRealmManagerDelegate> delegates = getDelegates();
+        if ( !delegates.isEmpty() )
-            delegate.setupRealm( classRealm, request );
+            ClassRealmRequest request = new DefaultClassRealmRequest( type, parent, imports, constituents );
+
+            for ( ClassRealmManagerDelegate delegate : delegates )
+            {
+                delegate.setupRealm( classRealm, request );
+            }
-        if ( logger.isDebugEnabled() )
-        {
-            logger.debug( "Populating class realm " + classRealm.getId() );
-        }
-
-        for ( ClassRealmConstituent constituent : constituents )
-        {
-            File file = constituent.getFile();
-
-            String id = getId( constituent );
-            artifactIds.remove( id );
-
-            if ( logger.isDebugEnabled() )
-            {
-                logger.debug( "  Included: " + id );
-            }
-
-            try
-            {
-                classRealm.addURL( file.toURI().toURL() );
-            }
-            catch ( MalformedURLException e )
-            {
-                // Not going to happen
-            }
-        }
+        Set<String> includedIds = populateRealm( classRealm, constituents );
+            artifactIds.removeAll( includedIds );
+
+            logger.error( "Failed to lookup class realm delegates: " + e.getMessage(), e );
+
+    private Set<String> populateRealm( ClassRealm classRealm, List<ClassRealmConstituent> constituents )
+    {
+        Set<String> includedIds = new LinkedHashSet<String>();
+
+        if ( logger.isDebugEnabled() )
+        {
+            logger.debug( "Populating class realm " + classRealm.getId() );
+        }
+
+        for ( ClassRealmConstituent constituent : constituents )
+        {
+            File file = constituent.getFile();
+
+            String id = getId( constituent );
+            includedIds.add( id );
+
+            if ( logger.isDebugEnabled() )
+            {
+                logger.debug( "  Included: " + id );
+            }
+
+            try
+            {
+                classRealm.addURL( file.toURI().toURL() );
+            }
+            catch ( MalformedURLException e )
+            {
+                // Not going to happen
+                logger.error( e.getMessage(), e );
+            }
+        }
+
+        return includedIds;
+    }
+
