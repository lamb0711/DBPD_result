[MNG-553] Secure Storage of Server Passwords

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@803510 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.FileNotFoundException;
-import org.apache.maven.toolchain.ToolchainsBuilder;
+import org.codehaus.plexus.logging.Logger;
+import org.sonatype.plexus.components.sec.dispatcher.SecDispatcher;
+import org.sonatype.plexus.components.sec.dispatcher.SecDispatcherException;
+
+    @Requirement
+    private Logger logger;
+
-    @Requirement
-    private ToolchainsBuilder toolchainsBuilder;
+    @Requirement( hint = "maven" )
+    private SecDispatcher securityDispatcher;
-            repositorySystem.addProxy( proxy.getProtocol(), proxy.getHost(), proxy.getPort(), proxy.getUsername(), proxy.getPassword(), proxy.getNonProxyHosts() );
+            String password = decrypt( proxy.getPassword(), "password for proxy " + proxy.getId() );
+
+            repositorySystem.addProxy( proxy.getProtocol(), proxy.getHost(), proxy.getPort(), proxy.getUsername(),
+                                       password, proxy.getNonProxyHosts() );
-            repositorySystem.addAuthenticationForArtifactRepository( server.getId(), server.getUsername(), server.getPassword() );
+            String password = decrypt( server.getPassword(), "password for server " + server.getId() );
+
+            repositorySystem.addAuthenticationForArtifactRepository( server.getId(), server.getUsername(), password );
+    private String decrypt( String encrypted, String source )
+    {
+        try
+        {
+            return securityDispatcher.decrypt( encrypted );
+        }
+        catch ( SecDispatcherException e )
+        {
+            logger.warn( "Not decrypting " + source + " due to exception in security handler: " + e.getMessage() );
+
+            Throwable cause = e;
+
+            while ( cause.getCause() != null )
+            {
+                cause = cause.getCause();
+            }
+
+            if ( cause instanceof FileNotFoundException )
+            {
+                logger.warn( "Ensure that you have configured your master password file (and relocation if appropriate)." );
+                logger.warn( "See the installation instructions for details." );
+            }
+
+            logger.debug( "Full stack trace follows", e );
+
+            return encrypted;
+        }
+    }
+
