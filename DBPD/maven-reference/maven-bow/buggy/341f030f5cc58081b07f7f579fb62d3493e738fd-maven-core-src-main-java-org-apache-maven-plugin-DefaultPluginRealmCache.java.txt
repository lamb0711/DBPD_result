o Generalized plugin realm cache

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@817669 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Collections;
-import org.apache.maven.project.MavenProject;
-        private final ClassRealm projectRealm;
+        private final ClassLoader parentRealm;
+
+        private final List<String> parentImports;
-        public CacheKey( Plugin plugin, MavenProject project, ArtifactRepository localRepository,
+        public CacheKey( Plugin plugin, ClassLoader parentRealm, List<String> parentImports, ArtifactRepository localRepository,
-            this.projectRealm = project.getClassRealm();
+            this.parentRealm = parentRealm;
+            this.parentImports = ( parentImports != null ) ? parentImports : Collections.<String> emptyList();
-            hash = hash * 31 + ( projectRealm != null ? projectRealm.hashCode() : 0 );
+            hash = hash * 31 + ( parentRealm != null ? parentRealm.hashCode() : 0 );
+            hash = hash * 31 + this.parentImports.hashCode();
-            return projectRealm == other.projectRealm && pluginEquals( plugin, other.plugin )
+            return parentRealm == other.parentRealm && pluginEquals( plugin, other.plugin )
-    public CacheRecord get( Plugin plugin, MavenProject project, ArtifactRepository localRepository,
-                            List<ArtifactRepository> remoteRepositories )
+    public CacheRecord get( Plugin plugin, ClassLoader parentRealm, List<String> parentImports,
+                            ArtifactRepository localRepository, List<ArtifactRepository> remoteRepositories )
-        return cache.get( new CacheKey( plugin, project, localRepository, remoteRepositories ) );
+        return cache.get( new CacheKey( plugin, parentRealm, parentImports, localRepository, remoteRepositories ) );
-    public void put( Plugin plugin, MavenProject project, ArtifactRepository localRepository,
-                     List<ArtifactRepository> remoteRepositories, ClassRealm pluginRealm, List<Artifact> pluginArtifacts )
+    public void put( Plugin plugin, ClassLoader parentRealm, List<String> parentImports,
+                     ArtifactRepository localRepository, List<ArtifactRepository> remoteRepositories,
+                     ClassRealm pluginRealm, List<Artifact> pluginArtifacts )
-        CacheKey key = new CacheKey( plugin, project, localRepository, remoteRepositories );
+        CacheKey key = new CacheKey( plugin, parentRealm, parentImports, localRepository, remoteRepositories );
-            throw new IllegalStateException( "Duplicate plugin realm for plugin " + plugin );
+            throw new IllegalStateException( "Duplicate plugin realm for plugin " + plugin.getId() );
