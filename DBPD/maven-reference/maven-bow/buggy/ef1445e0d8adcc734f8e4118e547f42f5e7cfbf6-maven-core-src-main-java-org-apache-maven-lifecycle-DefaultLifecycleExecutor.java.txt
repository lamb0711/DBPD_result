o Fixed CLI invovations of plugins with project-level plugin dependencies

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@784452 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.model.Dependency;
-                     
+
+        injectPluginDeclarationFromProject( plugin, project );
+
-            // We need to get it from the POM first before anything else
-            //
-            plugin.setVersion( attemptToGetPluginVersionFromProject( plugin, project ) );
-            
-                
-    private String attemptToGetPluginVersionFromProject( Plugin plugin, MavenProject project )
+
+    private void injectPluginDeclarationFromProject( Plugin plugin, MavenProject project )
-        for ( Plugin pluginInPom : project.getBuildPlugins() )
+        Plugin pluginInPom = findPlugin( plugin, project.getBuildPlugins() );
+
+        if ( pluginInPom == null && project.getPluginManagement() != null )
-            if ( pluginInPom.getArtifactId().equals( plugin.getArtifactId() ) )
-            {
-                return pluginInPom.getVersion();
-            }
+            pluginInPom = findPlugin( plugin, project.getPluginManagement().getPlugins() );
-        if ( plugin.getVersion() == null && project.getPluginManagement() != null )
+        if ( pluginInPom != null )
-            for ( Plugin pluginInPom : project.getPluginManagement().getPlugins() )
+            if ( plugin.getVersion() == null )
-                if ( pluginInPom.getArtifactId().equals( plugin.getArtifactId() ) )
-                {
-                    return pluginInPom.getVersion();
-                }
+                plugin.setVersion( pluginInPom.getVersion() );
+            }
+
+            plugin.setDependencies( new ArrayList<Dependency>( pluginInPom.getDependencies() ) );
+        }
+    }
+
+    private Plugin findPlugin( Plugin plugin, Collection<Plugin> plugins )
+    {
+        for ( Plugin p : plugins )
+        {
+            if ( p.getKey().equals( plugin.getKey() ) )
+            {
+                return p;
-        
-    
+
