transform deployment of SNAPSHOT.
Currently, the POM and artifact are deployed separately, causing an inconsistent version to be written out.


git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@163684 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.artifact.metadata.ArtifactMetadata;
+import org.apache.maven.artifact.metadata.ArtifactMetadataRetrievalException;
+import org.apache.maven.artifact.repository.layout.ArtifactPathFormatException;
+import org.apache.maven.artifact.transform.ArtifactTransformation;
+import org.apache.maven.wagon.TransferFailedException;
+import java.util.Iterator;
-    public void deploy( String basedir, Artifact artifact, ArtifactRepository deploymentRepository )
+    public void deploy( String basedir, Artifact artifact, ArtifactRepository deploymentRepository,
+                        ArtifactRepository localRepository )
-        deploy( source, artifact, deploymentRepository );
+        deploy( source, artifact, deploymentRepository, localRepository );
-    public void deploy( File source, Artifact artifact, ArtifactRepository deploymentRepository )
+    public void deploy( File source, Artifact artifact, ArtifactRepository deploymentRepository,
+                        ArtifactRepository localRepository )
-        // TODO: perform transformations
-
+            // TODO: better to have a transform manager, or reuse the handler manager again so we don't have these requirements duplicated all over?
+            for ( Iterator i = artifactTransformations.iterator(); i.hasNext(); )
+            {
+                ArtifactTransformation transform = (ArtifactTransformation) i.next();
+                artifact = transform.transformForDeployment( artifact, deploymentRepository );
+            }
+
+
+            // must be after the artifact is installed
+            for ( Iterator i = artifact.getMetadataList().iterator(); i.hasNext(); )
+            {
+                ArtifactMetadata metadata = (ArtifactMetadata) i.next();
+                metadata.storeInLocalRepository( localRepository );
+                // TODO: shouldn't need to calculate this
+                File f = new File( localRepository.getBasedir(), localRepository.pathOfMetadata( metadata ) );
+                wagonManager.putArtifactMetadata( f, metadata, deploymentRepository );
+            }
-        catch ( Exception e )
+        catch ( TransferFailedException e )
+        {
+            throw new ArtifactDeploymentException( "Error deploying artifact: ", e );
+        }
+        catch ( ArtifactMetadataRetrievalException e )
+        {
+            throw new ArtifactDeploymentException( "Error deploying artifact: ", e );
+        }
+        catch ( ArtifactPathFormatException e )
