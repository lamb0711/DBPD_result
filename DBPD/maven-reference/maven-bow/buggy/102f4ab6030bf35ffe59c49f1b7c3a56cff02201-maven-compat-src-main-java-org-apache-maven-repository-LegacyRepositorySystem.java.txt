[MNG-4334] maven core caches settings.xml

o Last pass: proxies moved out of the components into the requests

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@810444 13f79535-47bb-0310-9956-ffa450edef68

-    // TODO: move this out, the component needs to be stateless for safe reuse
-    private Map<String, Proxy> proxies = new HashMap<String,Proxy>();
-
+            effectiveRepository.setProxy( aliasedRepo.getProxy() );
+
+    private org.apache.maven.settings.Proxy getProxy( ArtifactRepository repository,
+                                                      List<org.apache.maven.settings.Proxy> proxies )
+    {
+        if ( proxies != null && repository.getProtocol() != null )
+        {
+            for ( org.apache.maven.settings.Proxy proxy : proxies )
+            {
+                if ( proxy.isActive() && repository.getProtocol().equalsIgnoreCase( proxy.getProtocol() ) )
+                {
+                    return proxy;
+                }
+            }
+        }
+
+        return null;
+    }
+
+    public void injectProxy( List<ArtifactRepository> repositories, List<org.apache.maven.settings.Proxy> proxies )
+    {
+        if ( repositories != null )
+        {
+            for ( ArtifactRepository repository : repositories )
+            {
+                org.apache.maven.settings.Proxy proxy = getProxy( repository, proxies );
+
+                if ( proxy != null )
+                {
+                    Proxy p = new Proxy();
+                    p.setHost( proxy.getHost() );
+                    p.setProtocol( proxy.getProtocol() );
+                    p.setPort( proxy.getPort() );
+                    p.setNonProxyHosts( proxy.getNonProxyHosts() );
+                    p.setUserName( proxy.getUsername() );
+                    p.setPassword( proxy.getPassword() );
+
+                    repository.setProxy( p );
+                }
+                else
+                {
+                    repository.setProxy( null );
+                }
+            }
+        }
+    }
+
-        Proxy proxy = proxies.get( artifactRepository.getProtocol() );
-        
-        if ( proxy != null )
-        {
-            artifactRepository.setProxy( proxy );
-        }
-        
-    public void addProxy( String protocol, String host, int port, String username, String password, String nonProxyHosts )
-    {
-        Proxy proxy = new Proxy();
-        proxy.setHost( host );
-        proxy.setProtocol( protocol );
-        proxy.setPort( port );
-        proxy.setNonProxyHosts( nonProxyHosts );
-        proxy.setUserName( username );
-        proxy.setPassword( password );
-        proxies.put( protocol, proxy );        
-    }   
