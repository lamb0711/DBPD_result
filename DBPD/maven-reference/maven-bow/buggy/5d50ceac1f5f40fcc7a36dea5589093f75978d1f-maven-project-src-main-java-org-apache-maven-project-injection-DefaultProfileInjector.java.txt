[MNG-1891] Fixed plugin ordering in profile injection AND model inheritance, to be consistent and to preserve as much ordering information as possible, to make plugin ordering more predictable. Also added several unit tests to express the problem(s) and verify the solutions. Ordering is in javadoc comments, and should be added to the plugin-configuration documentation on the site.

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@425919 13f79535-47bb-0310-9956-ffa450edef68

-    private void injectPlugins( PluginContainer profileContainer, PluginContainer modelContainer )
+    /**
+     * This should be the resulting ordering of plugins after injection:
+     * 
+     * Given:
+     * 
+     *   model: X -> A -> B -> D -> E
+     *   profile: Y -> A -> C -> D -> F
+     *  
+     * Result: 
+     * 
+     *   X -> Y -> A -> B -> C -> D -> E -> F
+     */
+    protected void injectPlugins( PluginContainer profileContainer, PluginContainer modelContainer )
-            Map mergedPlugins = new TreeMap();
+            List mergedPlugins = new ArrayList();
-                Plugin mergedPlugin = modelPlugin;
-
-                if ( profilePlugin != null )
+                if ( profilePlugin != null && !mergedPlugins.contains( profilePlugin ) )
-                    mergedPlugin = modelPlugin;
+                    Plugin mergedPlugin = modelPlugin;
-                }
-                mergedPlugins.put( mergedPlugin.getKey(), mergedPlugin );
-            }
-
-            for ( Iterator it = profilePlugins.values().iterator(); it.hasNext(); )
-            {
-                Plugin profilePlugin = (Plugin) it.next();
-
-                if ( !mergedPlugins.containsKey( profilePlugin.getKey() ) )
-                {
-                    mergedPlugins.put( profilePlugin.getKey(), profilePlugin );
+                    mergedPlugins.add( mergedPlugin );
-            modelContainer.setPlugins( new ArrayList( mergedPlugins.values() ) );
+            List results = ModelUtils.orderAfterMerge( mergedPlugins, modelPlugins, profileContainer.getPlugins() );
+
+            modelContainer.setPlugins( results );
