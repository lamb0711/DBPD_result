Resolving: MNG-251

o Added transformation manager
o snapshot timestamp/buildnumber is now managed from the transformation rather than the metadata
o maven-archiver now clones the MavenProject and resolves snapshot versions for introduction into manifest and exported pom.



git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@239219 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.artifact.ArtifactUtils;
+import java.util.Date;
+import java.util.HashMap;
+import java.util.Map;
+    private String deploymentTimestamp;
+
+    private int deploymentBuildNumber = 1;
+
+    private Map buildNumbers = new HashMap();
+
+                
+                updateDeploymentBuildNumber( artifact, metadata.getTimestamp(), metadata.getBuildNumber() );
-            metadata.update();
+            metadata.setVersion( getDeploymentTimestamp(), deploymentBuildNumber );
+    private void updateDeploymentBuildNumber( Artifact artifact, String timestamp, int buildNumberFromMetadata )
+    {
+        // we only have to handle bumping the build number if we're on the same timestamp, somehow...miraculously
+        if ( deploymentTimestamp.equals( timestamp ) )
+        {
+            String artifactKey = ArtifactUtils.versionlessKey( artifact );
+            
+            Integer buildNum = (Integer) buildNumbers.get( artifactKey );
+            
+            if ( buildNum == null || buildNum.intValue() <= buildNumberFromMetadata )
+            {
+                buildNum = new Integer( buildNumberFromMetadata + 1 );
+                
+                buildNumbers.put( artifactKey, buildNum );
+            }
+        }
+    }
+
+    public String getDeploymentTimestamp()
+    {
+        if ( deploymentTimestamp == null )
+        {
+            deploymentTimestamp = SnapshotArtifactMetadata.getUtcDateFormatter().format( new Date() );
+        }
+        return deploymentTimestamp;
+    }
+    
+    public int getDeploymentBuildNumber( Artifact artifact )
+    {
+        String artifactKey = ArtifactUtils.versionlessKey( artifact );
+        
+        Integer buildNum = (Integer) buildNumbers.get( artifactKey );
+        
+        if ( buildNum == null )
+        {
+            buildNum = new Integer( 1 );
+            buildNumbers.put( artifactKey, buildNum );
+        }
+        
+        return buildNum.intValue();
+    }
+
+    public String getDeploymentVersion( Artifact artifact )
+    {
+        int buildnum = getDeploymentBuildNumber( artifact );
+        
+        SnapshotArtifactMetadata metadata = (SnapshotArtifactMetadata) createMetadata( artifact );
+        
+        metadata.setVersion( getDeploymentTimestamp(), buildnum );
+        
+        return metadata.constructVersion();
+    }
+
