refactor plugin configuration finding and mergine into MavenProject


git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@163724 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.maven.model.Goal;
-import org.apache.maven.util.Xpp3DomUtils;
+            String goalId = null;
+
+            // TODO: much less of this magic is needed - make the mojoDescriptor just store the first and second part
+            int index = goalName.indexOf( ':' );
+            if ( index >= 0 )
+            {
+                goalId = goalName.substring( index + 1 );
+            }
+
-            PlexusConfiguration configuration = getProjectDefinedPluginConfiguration( session.getProject(),
-                                                                                      mojoDescriptor.getId() );
+            Xpp3Dom dom = session.getProject().getGoalConfiguration( getPluginId( goalName ), goalId );
+
+            PlexusConfiguration configuration;
+            if ( dom == null )
+            {
+                configuration = new XmlPlexusConfiguration( "configuration" );
+            }
+            else
+            {
+                configuration = new XmlPlexusConfiguration( dom );
+            }
-    private static PlexusConfiguration getProjectDefinedPluginConfiguration( MavenProject project, String goalId )
-    {
-        Xpp3Dom dom = null;
-
-        // ----------------------------------------------------------------------
-        // I would like to be able to lookup the Plugin object using a key but
-        // we have a limitation in modello that will be remedied shortly. So
-        // for now I have to iterate through and see what we have.
-        // ----------------------------------------------------------------------
-
-        if ( project.getPlugins() != null )
-        {
-            String pluginId = getPluginId( goalId );
-
-            for ( Iterator iterator = project.getPlugins().iterator(); iterator.hasNext(); )
-            {
-                org.apache.maven.model.Plugin plugin = (org.apache.maven.model.Plugin) iterator.next();
-
-                // TODO: groupID not handled
-                if ( pluginId.equals( plugin.getArtifactId() ) )
-                {
-                    dom = (Xpp3Dom) plugin.getConfiguration();
-
-                    // TODO: much less of this magic is needed - make the mojoDescriptor just store the first and second part
-                    int index = goalId.indexOf( ':' );
-                    if ( index >= 0 )
-                    {
-                        String goalName = goalId.substring( index + 1 );
-                        for ( Iterator j = plugin.getGoals().iterator(); j.hasNext(); )
-                        {
-                            Goal goal = (Goal) j.next();
-                            if ( goal.getId().equals( goalName ) )
-                            {
-                                Xpp3Dom goalConfiguration = (Xpp3Dom) goal.getConfiguration();
-                                if ( goalConfiguration != null )
-                                {
-                                    Xpp3Dom newDom = Xpp3DomUtils.copyXpp3Dom( goalConfiguration );
-                                    dom = Xpp3DomUtils.mergeXpp3Dom( newDom, dom );
-                                }
-                                break;
-                            }
-                        }
-                    }
-                    break;
-                }
-            }
-        }
-
-        PlexusConfiguration configuration;
-        if ( dom == null )
-        {
-            configuration = new XmlPlexusConfiguration( "configuration" );
-        }
-        else
-        {
-            configuration = new XmlPlexusConfiguration( dom );
-        }
-
-        return configuration;
-    }
-
