fix issue with goal fork

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@292143 13f79535-47bb-0310-9956-ffa450edef68

-        getLogger().info(
-            "Preparing " + mojoDescriptor.getPluginDescriptor().getGoalPrefix() + ":" + mojoDescriptor.getGoal() );
+        PluginDescriptor pluginDescriptor = mojoDescriptor.getPluginDescriptor();
+        getLogger().info( "Preparing " + pluginDescriptor.getGoalPrefix() + ":" + mojoDescriptor.getGoal() );
-                    lifecycleOverlay = mojoDescriptor.getPluginDescriptor().getLifecycleMapping( executeLifecycle );
+                    lifecycleOverlay = pluginDescriptor.getLifecycleMapping( executeLifecycle );
-                            MojoDescriptor desc = mojoDescriptor.getPluginDescriptor().getMojo( goal );
-
-                            if ( desc == null )
-                            {
-                                String message = "Required goal '" + goal + "' not found in plugin '" +
-                                    mojoDescriptor.getPluginDescriptor().getGoalPrefix() + "'";
-                                int index = goal.indexOf( ':' );
-                                if ( index >= 0 )
-                                {
-                                    String prefix = goal.substring( index + 1 );
-                                    if ( prefix.equals( mojoDescriptor.getPluginDescriptor().getGoalPrefix() ) )
-                                    {
-                                        message = message + " (goals should not be prefixed - try '" + prefix + "')";
-                                    }
-                                }
-                                throw new LifecycleExecutionException( message );
-                            }
+                            MojoDescriptor desc = getMojoDescriptor( pluginDescriptor, goal );
-            executeStandaloneGoal( mojoDescriptor.getExecuteGoal(), session, executionProject );
+            String goal = mojoDescriptor.getExecuteGoal();
+            MojoDescriptor desc = getMojoDescriptor( pluginDescriptor, goal );
+            executeGoals( Collections.singletonList( new MojoExecution( desc ) ), session, executionProject );
+    private MojoDescriptor getMojoDescriptor( PluginDescriptor pluginDescriptor, String goal )
+        throws LifecycleExecutionException
+    {
+        MojoDescriptor desc = pluginDescriptor.getMojo( goal );
+
+        if ( desc == null )
+        {
+            String message = "Required goal '" + goal + "' not found in plugin '" + pluginDescriptor.getGoalPrefix() +
+                "'";
+            int index = goal.indexOf( ':' );
+            if ( index >= 0 )
+            {
+                String prefix = goal.substring( index + 1 );
+                if ( prefix.equals( pluginDescriptor.getGoalPrefix() ) )
+                {
+                    message = message + " (goals should not be prefixed - try '" + prefix + "')";
+                }
+            }
+            throw new LifecycleExecutionException( message );
+        }
+        return desc;
+    }
+
