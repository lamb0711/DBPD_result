[MNG-4332] [regression] Default plugin executions contributed by packaging execute after executions from plugin management

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@809751 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.model.PluginManagement;
+import org.apache.maven.model.building.ModelBuildingRequest;
-    public void injectLifecycleBindings( Model model, ModelProblemCollector problems )
+    public void injectLifecycleBindings( Model model, ModelBuildingRequest request, ModelProblemCollector problems )
+        private static final String PLUGIN_MANAGEMENT = "plugin-management";
+
-            mergePluginContainer_Plugins( target.getBuild(), source.getBuild(), false, Collections.emptyMap() );
+
+            Map<Object, Object> context =
+                Collections.<Object, Object> singletonMap( PLUGIN_MANAGEMENT, target.getBuild().getPluginManagement() );
+
+            mergePluginContainer_Plugins( target.getBuild(), source.getBuild(), false, context );
+                Map<Object, Plugin> unmanaged = new LinkedHashMap<Object, Plugin>( merged );
+
+                        unmanaged.remove( key );
+                if ( !unmanaged.isEmpty() )
+                {
+                    PluginManagement pluginMgmt = (PluginManagement) context.get( PLUGIN_MANAGEMENT );
+                    if ( pluginMgmt != null )
+                    {
+                        for ( Iterator<Plugin> it = pluginMgmt.getPlugins().iterator(); it.hasNext(); )
+                        {
+                            Plugin managedPlugin = it.next();
+                            Object key = getPluginKey( managedPlugin );
+                            Plugin unmanagedPlugin = unmanaged.get( key );
+                            if ( unmanagedPlugin != null )
+                            {
+                                Plugin plugin = managedPlugin.clone();
+                                mergePlugin( plugin, unmanagedPlugin, sourceDominant, Collections.emptyMap() );
+                                merged.put( key, plugin );
+                            }
+                        }
+                    }
+                }
+
