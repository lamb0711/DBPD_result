MNG-2364 make sure the system properties are passed from the execution/embed requests, to make the on-property profile activation work in embedded environment

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@415000 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Properties;
+    
+    // default fallback..
+    private Properties systemProperties = System.getProperties();
+    /**
+     * @deprecated without passing in the system properties, the SystemPropertiesProfileActivator will not work correctly
+     * in embedded envirnments.
+     */
-        this( container, null );
+        this( container, (Settings)null);
+    }
+    
+    /**
+     * the properties passed to the profile manager are the props that
+     * are passed to maven, possibly containing profile activator properties
+     *
+     */
+    public DefaultProfileManager( PlexusContainer container, Properties props )
+    {
+        this( container, (Settings)null );
+        if (props != null) {
+            systemProperties = props;
+        }
+        
-    public DefaultProfileManager( PlexusContainer container, Settings settings )
+    private DefaultProfileManager( PlexusContainer container, Settings settings )
+    
+    public Properties getSystemProperties() {
+        return systemProperties;
+    }
+        container.addContextValue("SystemProperties", systemProperties);
-            try
+            container.getContext().put("SystemProperties", null);
+            if ( activators != null )
-                container.releaseAll( activators );
-            }
-            catch ( ComponentLifecycleException e )
-            {
-                container.getLogger().debug( "Error releasing profile activators - ignoring.", e );
+                try
+                {
+                    container.releaseAll( activators );
+                }
+                catch ( ComponentLifecycleException e )
+                {
+                    container.getLogger().debug( "Error releasing profile activators - ignoring.", e );
+                }
