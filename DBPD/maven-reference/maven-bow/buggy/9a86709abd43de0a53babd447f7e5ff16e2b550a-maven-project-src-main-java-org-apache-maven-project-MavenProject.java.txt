PR: MNG-249
make compile and package reactor aware



git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@225731 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.HashMap;
+import java.util.HashSet;
+    private Map projectReferences = new HashMap();
+
-                    File file = a.getFile();
-                    if ( file == null )
+                    String refId = getProjectReferenceId( a.getGroupId(), a.getArtifactId() );
+                    MavenProject project = (MavenProject) projectReferences.get( refId );
+                    if ( project != null )
-                        throw new DependencyResolutionRequiredException( a );
+                        list.add( project.getBuild().getOutputDirectory() );
-                    list.add( file.getPath() );
+                    else
+                    {
+                        File file = a.getFile();
+                        if ( file == null )
+                        {
+                            throw new DependencyResolutionRequiredException( a );
+                        }
+                        list.add( file.getPath() );
+                    }
-    public static Set createArtifacts( ArtifactFactory artifactFactory, List dependencies )
+    public Set createArtifacts( ArtifactFactory artifactFactory )
-        return MavenMetadataSource.createArtifacts( artifactFactory, dependencies, null, null );
+        Set artifacts = new HashSet( getDependencies().size() );
+
+        List list = new ArrayList( getDependencies().size() );
+        for ( Iterator i = getDependencies().iterator(); i.hasNext(); )
+        {
+            Dependency dependency = (Dependency) i.next();
+            String refId = getProjectReferenceId( dependency.getGroupId(), dependency.getArtifactId() );
+            MavenProject project = (MavenProject) projectReferences.get( refId );
+            if ( project != null && project.getArtifact() != null )
+            {
+                // TODO: actually these need to be funnelled through the same process and the artifacts cloned somehow
+                project.getArtifact().setScope( dependency.getScope() );
+                artifacts.add( project.getArtifact() );
+            }
+            else
+            {
+                list.add( dependency );
+            }
+        }
+
+        artifacts.addAll( MavenMetadataSource.createArtifacts( artifactFactory, list, null, null ) );
+
+        return artifacts;
+    }
+
+    public void addProjectReference( MavenProject project )
+    {
+        projectReferences.put( getProjectReferenceId( project.getGroupId(), project.getArtifactId() ), project );
+    }
+
+    private static String getProjectReferenceId( String groupId, String artifactId )
+    {
+        return groupId + ":" + artifactId;
