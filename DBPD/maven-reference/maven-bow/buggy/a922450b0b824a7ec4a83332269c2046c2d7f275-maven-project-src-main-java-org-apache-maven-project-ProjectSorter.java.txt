PR: MNG-1045
ensure parent always come first, but doesn't introduce a cycle


git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@293200 13f79535-47bb-0310-9956-ffa450edef68

-            // TODO: this MUST be fixed before beta-3, but it is required for a sane release plugin.
+                    // Parent is added as an edge, but must not cause a cycle - so we remove any other edges it has in conflict
+                    if ( dag.hasEdge( parentId, id ) )
+                    {
+                        dag.removeEdge( parentId, id );
+                    }
-                        project.addProjectReference( (MavenProject) projectMap.get( pluginId ) );
-
-                        dag.addEdge( id, pluginId );
+                        addEdgeWithParentCheck( projectMap, pluginId, project, id );
-                        project.addProjectReference( (MavenProject) projectMap.get( pluginId ) );
-
-                        dag.addEdge( id, pluginId );
+                        addEdgeWithParentCheck( projectMap, pluginId, project, id );
-                    project.addProjectReference( (MavenProject) projectMap.get( extensionId ) );
-
-                    dag.addEdge( id, extensionId );
+                    addEdgeWithParentCheck( projectMap, extensionId, project, id );
+    private void addEdgeWithParentCheck( Map projectMap, String extensionId, MavenProject project, String id )
+        throws CycleDetectedException
+    {
+        MavenProject extProject = (MavenProject) projectMap.get( extensionId );
+        project.addProjectReference( extProject );
+
+        MavenProject extParent = extProject.getParent();
+        String parentId = ArtifactUtils.versionlessKey( extParent.getGroupId(), extParent.getArtifactId() );
+        // Don't add edge from parent to extension if a reverse edge already exists
+        if ( !dag.hasEdge( extensionId, id ) || !parentId.equals( id ) )
+        {
+            dag.addEdge( id, extensionId );
+        }
+    }
+
