[MNG-4796] add a warning when profiles.xml is used (Maven 2) or detected (Maven 3)

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@992683 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.HashMap;
+import java.util.Map;
-                initProject( project, result );
+                initProject( project, result, new HashMap<File, Boolean>() );
-            noErrors = build( results, new ArrayList<MavenProject>(), interimResults, config ) && noErrors;
+            noErrors =
+                build( results, new ArrayList<MavenProject>(), interimResults, config, new HashMap<File, Boolean>() )
+                    && noErrors;
-                           List<InterimResult> interimResults, ProjectBuildingRequest config )
+                           List<InterimResult> interimResults, ProjectBuildingRequest config, Map<File, Boolean> profilesXmls )
-                initProject( project, result );
+                initProject( project, result, profilesXmls );
-                noErrors = build( results, modules, interimResult.modules, config ) && noErrors;
+                noErrors = build( results, modules, interimResult.modules, config, profilesXmls ) && noErrors;
-    private void initProject( MavenProject project, ModelBuildingResult result )
+    private void initProject( MavenProject project, ModelBuildingResult result, Map<File, Boolean> profilesXmls )
+
+        String modelId = findProfilesXml( result, profilesXmls );
+        if ( modelId != null )
+        {
+            ModelProblem problem =
+                new DefaultModelProblem( "Detected profiles.xml alongside " + modelId
+                    + ", this file is no longer supported and was ignored" + ", please use the settings.xml instead",
+                                         ModelProblem.Severity.WARNING, model, -1, -1, null );
+            result.getProblems().add( problem );
+        }
+    }
+
+    private String findProfilesXml( ModelBuildingResult result, Map<File, Boolean> profilesXmls )
+    {
+        for ( String modelId : result.getModelIds() )
+        {
+            Model model = result.getRawModel( modelId );
+
+            File basedir = model.getProjectDirectory();
+            if ( basedir == null )
+            {
+                break;
+            }
+
+            Boolean profilesXml = profilesXmls.get( basedir );
+            if ( profilesXml == null )
+            {
+                profilesXml = Boolean.valueOf( new File( basedir, "profiles.xml" ).exists() );
+                profilesXmls.put( basedir, profilesXml );
+            }
+            if ( profilesXml.booleanValue() )
+            {
+                return modelId;
+            }
+        }
+
+        return null;
