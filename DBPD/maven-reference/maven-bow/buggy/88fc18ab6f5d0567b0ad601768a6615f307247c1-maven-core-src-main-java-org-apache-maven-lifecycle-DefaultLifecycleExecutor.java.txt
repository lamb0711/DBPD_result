o Fixed configuration for direct invocation of goals

git-svn-id: https://svn.apache.org/repos/asf/maven/components/branches/MNG-2766@778173 13f79535-47bb-0310-9956-ffa450edef68

-                populateMojoExecutionConfiguration( project, mojoExecution );
+                populateMojoExecutionConfiguration( project, mojoExecution, true );
-            populateMojoExecutionConfiguration( project, mojoExecution );
+            populateMojoExecutionConfiguration( project, mojoExecution, false );
-    private void populateMojoExecutionConfiguration( MavenProject project, MojoExecution mojoExecution )
-    {        
+    private void populateMojoExecutionConfiguration( MavenProject project, MojoExecution mojoExecution,
+                                                     boolean directInvocation )
+    {
-        if ( p == null )
+        if ( p != null )
-            // goal was invoked directly from command line and has no declaration in the POM itself
-            return;
+            for ( PluginExecution e : p.getExecutions() )
+            {
+                if ( mojoExecution.getExecutionId().equals( e.getId() ) )
+                {
+                    Xpp3Dom executionConfiguration = (Xpp3Dom) e.getConfiguration();
+
+                    Xpp3Dom mojoConfiguration =
+                        extractMojoConfiguration( executionConfiguration, mojoExecution.getMojoDescriptor() );
+
+                    mojoExecution.setConfiguration( mojoConfiguration );
+
+                    return;
+                }
+            }
-        for ( PluginExecution e : p.getExecutions() )
+        if ( directInvocation )
-            if ( mojoExecution.getExecutionId().equals( e.getId() ) )
+            Xpp3Dom defaultDom = convert( mojoExecution.getMojoDescriptor() );
+
+            if ( p != null && p.getConfiguration() != null )
-                Xpp3Dom executionConfiguration = (Xpp3Dom) e.getConfiguration();
-
-                Xpp3Dom mojoConfiguration = extractMojoConfiguration( executionConfiguration, mojoExecution.getMojoDescriptor() );
-
-                mojoExecution.setConfiguration( mojoConfiguration );
+                Xpp3Dom projectDom = (Xpp3Dom) p.getConfiguration();
+                projectDom = extractMojoConfiguration( projectDom, mojoExecution.getMojoDescriptor() );
+                mojoExecution.setConfiguration( Xpp3Dom.mergeXpp3Dom( projectDom, defaultDom, Boolean.TRUE ) );
+            }
+            else
+            {
+                mojoExecution.setConfiguration( defaultDom );
-    
+
