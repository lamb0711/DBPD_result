PR: MNG-1048
make sure the scope in the current POM wins over all

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@293514 13f79535-47bb-0310-9956-ffa450edef68

-    private void checkScopeUpdate( ResolutionNode node, ResolutionNode previous, List listeners )
+    private void checkScopeUpdate( ResolutionNode farthest, ResolutionNode nearest, List listeners )
-        Artifact newArtifact = node.getArtifact();
-        Artifact previousArtifact = previous.getArtifact();
+        Artifact farthestArtifact = farthest.getArtifact();
+        Artifact nearestArtifact = nearest.getArtifact();
-        if ( Artifact.SCOPE_RUNTIME.equals( newArtifact.getScope() ) && (
-            Artifact.SCOPE_TEST.equals( previousArtifact.getScope() ) ||
-                Artifact.SCOPE_PROVIDED.equals( previousArtifact.getScope() ) ) )
+        if ( Artifact.SCOPE_RUNTIME.equals( farthestArtifact.getScope() ) && (
+            Artifact.SCOPE_TEST.equals( nearestArtifact.getScope() ) ||
+                Artifact.SCOPE_PROVIDED.equals( nearestArtifact.getScope() ) ) )
-        if ( Artifact.SCOPE_COMPILE.equals( newArtifact.getScope() ) &&
-            !Artifact.SCOPE_COMPILE.equals( previousArtifact.getScope() ) )
+        if ( Artifact.SCOPE_COMPILE.equals( farthestArtifact.getScope() ) &&
+            !Artifact.SCOPE_COMPILE.equals( nearestArtifact.getScope() ) )
+        // current POM rules all
+        if ( nearest.getDepth() < 2 && updateScope )
+        {
+            updateScope = false;
+
+            fireEvent( ResolutionListener.UPDATE_SCOPE_CURRENT_POM, listeners, nearest, farthestArtifact );
+        }
+
-            int event;
-            if ( previous.getDepth() < 2 )
-            {
-                event = ResolutionListener.UPDATE_SCOPE_CURRENT_POM;
-            }
-            else
-            {
-                event = ResolutionListener.UPDATE_SCOPE;
-            }
-
-            fireEvent( event, listeners, previous, newArtifact );
+            fireEvent( ResolutionListener.UPDATE_SCOPE, listeners, nearest, farthestArtifact );
-            previousArtifact.setScope( newArtifact.getScope() );
+            nearestArtifact.setScope( farthestArtifact.getScope() );
