improved error handling and other clean up


git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@163979 13f79535-47bb-0310-9956-ffa450edef68

-                throw new PluginManagerException( "Internal configuration error while retrieving " + groupId + ":" + artifactId, e );
-            }
-            finally
-            {
-                if ( artifactFactory != null )
-                {
-                    try
-                    {
-                        container.release( artifactFactory );
-                    }
-                    catch ( ComponentLifecycleException e )
-                    {
-                        getLogger().error( "Error releasing component - ignoring", e );
-                    }
-                }
+                throw new PluginManagerException(
+                    "Internal configuration error while retrieving " + groupId + ":" + artifactId, e );
-                try
-                {
-                    container.release( artifactResolver );
-                }
-                catch ( ComponentLifecycleException e )
-                {
-                    getLogger().error( "Error releasing component - ignoring", e );
-                }
+                releaseComponent( artifactResolver );
-                try
-                {
-                    container.release( mavenProjectBuilder );
-                }
-                catch ( ComponentLifecycleException e )
-                {
-                    getLogger().error( "Error releasing component - ignoring", e );
-                }
+                releaseComponent( mavenProjectBuilder );
+    private void releaseComponent( Object component )
+    {
+        try
+        {
+            container.release( component );
+        }
+        catch ( ComponentLifecycleException e )
+        {
+            getLogger().error( "Error releasing component - ignoring", e );
+        }
+    }
+
-        throws PluginExecutionException, PluginNotFoundException
+        throws PluginExecutionException, PluginNotFoundException, PluginManagerException, ArtifactResolutionException
-        try
-        {
-            verifyPluginForGoal( goalName, session );
-        }
-        catch ( Exception e )
-        {
-            throw new PluginExecutionException( "Unable to execute goal: " + goalName, e );
-        }
+        verifyPluginForGoal( goalName, session );
-        try
+        if ( mojoDescriptor.getRequiresDependencyResolution() != null )
-            if ( mojoDescriptor.getRequiresDependencyResolution() != null )
+
+            ArtifactResolver artifactResolver = null;
+            MavenProjectBuilder mavenProjectBuilder = null;
+
+            try
+                artifactResolver = (ArtifactResolver) container.lookup( ArtifactResolver.ROLE );
+                mavenProjectBuilder = (MavenProjectBuilder) container.lookup( MavenProjectBuilder.ROLE );
-                ArtifactResolver artifactResolver = null;
-                MavenProjectBuilder mavenProjectBuilder = null;
-
-                try
+                resolveTransitiveDependencies( session, artifactResolver, mavenProjectBuilder,
+                                               mojoDescriptor.getRequiresDependencyResolution() );
+                downloadDependencies( session, artifactResolver );
+            }
+            catch ( ComponentLookupException e )
+            {
+                throw new PluginManagerException( "Internal configuration error in plugin manager", e );
+            }
+            finally
+            {
+                if ( artifactResolver != null )
-                    artifactResolver = (ArtifactResolver) container.lookup( ArtifactResolver.ROLE );
-                    mavenProjectBuilder = (MavenProjectBuilder) container.lookup( MavenProjectBuilder.ROLE );
-
-                    resolveTransitiveDependencies( session, artifactResolver, mavenProjectBuilder,
-                                                   mojoDescriptor.getRequiresDependencyResolution() );
-                    downloadDependencies( session, artifactResolver );
+                    releaseComponent( artifactResolver );
-                finally
+                if ( mavenProjectBuilder != null )
-                    // TODO: watch out for the exceptions being thrown
-                    if ( artifactResolver != null )
-                    {
-                        container.release( artifactResolver );
-                    }
-                    if ( mavenProjectBuilder != null )
-                    {
-                        container.release( mavenProjectBuilder );
-                    }
+                    releaseComponent( mavenProjectBuilder );
-        catch ( Exception e )
-        {
-            throw new PluginExecutionException( "Unable to resolve required dependencies for goal", e );
-        }
+            ExpressionEvaluator expressionEvaluator = new PluginParameterExpressionEvaluator( session, pathTranslator );
+
-            ExpressionEvaluator expressionEvaluator = new PluginParameterExpressionEvaluator( session, pathTranslator );
-            try
-            {
-                container.release( plugin );
-            }
-            catch ( Exception e )
-            {
-                // TODO: better error handling, needed!
-                e.printStackTrace();
-            }
+            releaseComponent( plugin );
-                    throw new PluginConfigurationException( "Unable to set field '" + key + "' on '" + clazz + "'" );
+                    throw new PluginConfigurationException( "Unable to set field '" + key + "' on '" + clazz + "'", e );
-                    throw new PluginConfigurationException( "Unable to set field '" + key + "' on '" + clazz + "'" );
+                    throw new PluginConfigurationException( "Unable to set field '" + key + "' on '" + clazz + "'", e );
