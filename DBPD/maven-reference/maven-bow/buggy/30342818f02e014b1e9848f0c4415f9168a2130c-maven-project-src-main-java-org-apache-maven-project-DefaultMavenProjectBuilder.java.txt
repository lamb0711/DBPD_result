Make sure that all calls to buildFromRepository use a normalized List of remote repositories (a list of ArtifactRepository instances, not of model Repository instances, for example)...this should be less of a concern when we can use Java5 generics (someday).

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@616610 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.artifact.UnknownRepositoryLayoutException;
+import org.apache.maven.model.Repository;
-    
+
-    
+
+        String projectId = safeVersionlessKey( artifact.getGroupId(), artifact.getArtifactId() );
+
+        remoteArtifactRepositories = normalizeToArtifactRepositories( remoteArtifactRepositories, projectId );
+
-        String projectId = ArtifactUtils.versionlessKey( projectArtifact );
-
+    private List normalizeToArtifactRepositories( List remoteArtifactRepositories,
+                                                  String projectId )
+        throws ProjectBuildingException
+    {
+        List normalized = new ArrayList( remoteArtifactRepositories.size() );
+
+        boolean normalizationNeeded = false;
+        for ( Iterator it = remoteArtifactRepositories.iterator(); it.hasNext(); )
+        {
+            Object item = it.next();
+
+            if ( item instanceof ArtifactRepository )
+            {
+                normalized.add( item );
+            }
+            else if ( item instanceof Repository )
+            {
+                Repository repo = (Repository) item;
+                try
+                {
+                    item = mavenTools.buildArtifactRepository( repo );
+
+                    normalized.add( item );
+                    normalizationNeeded = true;
+                }
+                catch ( UnknownRepositoryLayoutException e )
+                {
+                    throw new ProjectBuildingException( projectId, "Error building artifact repository for id: " + repo.getId(), e );
+                }
+            }
+            else
+            {
+                throw new ProjectBuildingException( projectId, "Error building artifact repository from non-repository information item: " + item );
+            }
+        }
+
+        if ( normalizationNeeded )
+        {
+            return normalized;
+        }
+        else
+        {
+            return remoteArtifactRepositories;
+        }
+    }
+
