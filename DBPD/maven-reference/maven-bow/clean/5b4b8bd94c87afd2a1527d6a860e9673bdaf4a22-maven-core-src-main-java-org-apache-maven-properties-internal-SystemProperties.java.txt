[MNG-6105] properties.internal.SystemProperties.addSystemProperties() is not really thread-safe

Refactoring the current code setting system properties to synchronize correctly on the given ones: avoids ConcurrentModificationException and NullPointerException if the properties is modified by another thread.

-        for ( String key : System.getProperties().stringPropertyNames() )
-        {
-            props.put( key, System.getProperty( key ) );
-        }
+        props.putAll( getSystemProperties() );
-     * Returns System.properties copy.
+     * Returns a copy of {@link System#getProperties()} in a thread-safe manner.
+     * 
+     * @return {@link System#getProperties()} obtained in a thread-safe manner. 
-        Properties systemProperties = new Properties();
-        addSystemProperties( systemProperties );
-        return systemProperties;
+        return copyProperties( System.getProperties() );
+
+    /**
+     * Copies the given {@link Properties} object into a new {@link Properties} object, in a thread-safe manner.
+     * @param properties Properties to copy.
+     * @return Copy of the given properties.
+     */
+    public static Properties copyProperties( Properties properties )
+    {
+        final Properties copyProperties = new Properties();
+        // guard against modification/removal of keys in the given properties (MNG-5670, MNG-6053, MNG-6105)
+        synchronized ( properties )
+        {
+            copyProperties.putAll( properties );
+        }
+        return copyProperties;
+    }
+
