[MNG-4432] reimplement parallel artifacts download

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@900982 13f79535-47bb-0310-9956-ffa450edef68

-    private ArtifactTransferListener listener;
+    private final ArtifactTransferListener listener;
-    private Map<Resource, ArtifactTransferResource> artifacts;
+    private final Map<Resource, ArtifactTransferResource> artifacts;
-    private Map<Resource, Long> transfers;
+    private final Map<Resource, Long> transfers;
-        Long transferred = transfers.get( transferEvent.getResource() );
+        Long transferred = null;
+        synchronized ( transfers )
+        {
+            transferred = transfers.remove( transferEvent.getResource() );
+        }
-        listener.transferCompleted( event );
+        synchronized ( artifacts )
+        {
+            artifacts.remove( transferEvent.getResource() );
+        }
-        artifacts.remove( transferEvent.getResource() );
-        transfers.remove( transferEvent.getResource() );
+        listener.transferCompleted( event );
-        artifacts.remove( transferEvent.getResource() );
-        transfers.remove( transferEvent.getResource() );
+        synchronized ( transfers )
+        {
+            transfers.remove( transferEvent.getResource() );
+        }
+        synchronized ( artifacts )
+        {
+            artifacts.remove( transferEvent.getResource() );
+        }
-        Long transferred = transfers.get( transferEvent.getResource() );
-        if ( transferred == null )
+        Long transferred;
+        synchronized ( transfers )
-            transferred = Long.valueOf( length );
+            transferred = transfers.get( transferEvent.getResource() );
+            if ( transferred == null )
+            {
+                transferred = Long.valueOf( length );
+            }
+            else
+            {
+                transferred = Long.valueOf( transferred.longValue() + length );
+            }
+            transfers.put( transferEvent.getResource(), transferred );
-        else
-        {
-            transferred = Long.valueOf( transferred.longValue() + length );
-        }
-        transfers.put( transferEvent.getResource(), transferred );
-            ArtifactTransferResource artifact = artifacts.get( resource );
-
-            if ( artifact == null )
+            synchronized ( artifacts )
-                artifact = new MavenArtifact( repository.getUrl(), resource );
-                artifacts.put( resource, artifact );
-            }
+                ArtifactTransferResource artifact = artifacts.get( resource );
-            return artifact;
+                if ( artifact == null )
+                {
+                    artifact = new MavenArtifact( repository.getUrl(), resource );
+                    artifacts.put( resource, artifact );
+                }
+
+                return artifact;
+            }
