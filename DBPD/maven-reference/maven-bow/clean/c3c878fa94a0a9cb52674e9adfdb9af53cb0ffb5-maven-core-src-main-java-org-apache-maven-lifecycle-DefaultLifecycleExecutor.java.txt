o Fixed merging of lifecycle plugins that contribute more than one execution
o Fixed conversion of default value for plugin configuration

git-svn-id: https://svn.apache.org/repos/asf/maven/components/branches/MNG-2766@771154 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Collection;
-import java.util.LinkedHashSet;
-        Set<Plugin> plugins = new LinkedHashSet<Plugin>();
+        Map<Plugin, Plugin> plugins = new LinkedHashMap<Plugin, Plugin>();
-                for ( String s : lifecyclePhasesForPackaging.values() )
-                {
-                    plugins.add( populatePluginWithInformationSpecifiedInLifecyclePhaseDefinition( s ) );
-                }
+                parseLifecyclePhaseDefinitions( plugins, lifecyclePhasesForPackaging.values() );
-                for ( String s : lifecycle.getDefaultPhases() )
-                {
-                    plugins.add( populatePluginWithInformationSpecifiedInLifecyclePhaseDefinition( s ) );
-                }                
+                parseLifecyclePhaseDefinitions( plugins, lifecycle.getDefaultPhases() );
-        return plugins;
+        return plugins.keySet();
-    
+
+    private void parseLifecyclePhaseDefinitions( Map<Plugin, Plugin> plugins,
+                                                 Collection<String> lifecyclePhaseDefinitions )
+    {
+        for ( String lifecyclePhaseDefinition : lifecyclePhaseDefinitions )
+        {
+            Plugin plugin = populatePluginWithInformationSpecifiedInLifecyclePhaseDefinition( lifecyclePhaseDefinition );
+            Plugin existing = plugins.get( plugin );
+            if ( existing != null )
+            {
+                existing.getExecutions().addAll( plugin.getExecutions() );
+            }
+            else
+            {
+                plugins.put( plugin, plugin );
+            }
+        }
+    }
+
-        execution.setGoals( Arrays.asList( new String[]{ p[2] } ) );
-        plugin.setExecutions( Arrays.asList( new PluginExecution[]{ execution } ) );
+        // FIXME: Find a better execution id
+        execution.setId( "default-" + p[2] );
+        execution.setGoals( new ArrayList<String>( Arrays.asList( new String[] { p[2] } ) ) );
+        plugin.setExecutions( new ArrayList<PluginExecution>( Arrays.asList( new PluginExecution[] { execution } ) ) );
-                    e.setConfiguration( dom );
+                    e.setConfiguration( Xpp3Dom.mergeXpp3Dom( (Xpp3Dom) e.getConfiguration(), dom, Boolean.TRUE ) );
-            if ( ce.getValue( null ) != null )
+            String defaultValue = ce.getAttribute( "default-value", null );
+            if ( ce.getValue( null ) != null || defaultValue != null )
-                String defaultValue = ce.getAttribute( "default-value", null );
