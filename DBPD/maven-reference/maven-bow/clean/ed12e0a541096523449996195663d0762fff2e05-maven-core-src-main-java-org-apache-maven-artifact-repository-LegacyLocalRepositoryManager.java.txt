[MNG-4990] RepositorySystem#resolve(request) uses two different local repositories

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@1073928 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.maven.artifact.repository.layout.DefaultRepositoryLayout;
+import org.sonatype.aether.util.DefaultRepositorySystemSession;
+import org.sonatype.aether.util.FilterRepositorySystemSession;
-    public static LocalRepositoryManager wrap( ArtifactRepository repository, RepositorySystem system )
+    public static RepositorySystemSession overlay( ArtifactRepository repository, RepositorySystemSession session,
+                                                   RepositorySystem system )
-        ArtifactRepositoryLayout layout = repository.getLayout();
-        if ( layout != null && layout.getClass().equals( DefaultRepositoryLayout.class ) )
+        if ( repository == null || repository.getBasedir() == null )
-            // map the default layout to the default impl of the repo system
-            return system.newLocalRepositoryManager( new LocalRepository( repository.getBasedir() ) );
+            return session;
-        return new LegacyLocalRepositoryManager( repository );
+        if ( session != null )
+        {
+            LocalRepositoryManager lrm = session.getLocalRepositoryManager();
+            if ( lrm != null && lrm.getRepository().getBasedir().equals( new File( repository.getBasedir() ) ) )
+            {
+                return session;
+            }
+        }
+        else
+        {
+            session = new DefaultRepositorySystemSession();
+        }
+
+        final LocalRepositoryManager llrm = new LegacyLocalRepositoryManager( repository );
+
+        return new FilterRepositorySystemSession( session )
+        {
+            @Override
+            public LocalRepositoryManager getLocalRepositoryManager()
+            {
+                return llrm;
+            }
+        };
