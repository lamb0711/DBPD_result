make sure local snapshot is used in mboot

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@280362 13f79535-47bb-0310-9956-ffa450edef68

+                        remoteFile.delete();
+                    boolean legacy = false;
-
-                    boolean found = false;
-                    if ( file.exists() )
-                    {
-                        log( "Using metadata: " + file );
-
-                        RepositoryMetadata metadata;
-                        metadata = RepositoryMetadata.read( file );
-
-                        if ( version.equals( metadata.getVersion() ) )
-                        {
-                            found = true;
-                            version = metadata.constructVersion( version );
-                            log( "Resolved version: " + version );
-                            dep.setResolvedVersion( version );
-                            if ( !version.endsWith( "SNAPSHOT" ) )
-                            {
-                                String ver = version.substring(
-                                    version.lastIndexOf( "-", version.lastIndexOf( "-" ) - 1 ) + 1 );
-                                String extension = url.substring( url.length() - 4 );
-                                url = getSnapshotMetadataFile( url, ver + extension );
-                            }
-                            else if ( destinationFile.exists() )
-                            {
-                                // It's already there
-                                return true;
-                            }
-                        }
-                        else
-                        {
-                            log( "WARNING: versions did not match, not using metadata (" + version + " vs " +
-                                metadata.getVersion() + ")" );
-                        }
-                    }
-
-                    if ( !found )
+                    else
-                        file = localRepository.getMetadataFile( dep.getGroupId(), dep.getArtifactId(), dep.getVersion(),
-                                                                dep.getType(), filename );
+                        File f = localRepository.getMetadataFile( dep.getGroupId(), dep.getArtifactId(),
+                                                                  dep.getVersion(), dep.getType(), filename );
-                            HttpUtils.getFile( metaUrl, file, ignoreErrors, true, proxyHost, proxyPort, proxyUserName,
+                            HttpUtils.getFile( metaUrl, f, ignoreErrors, true, proxyHost, proxyPort, proxyUserName,
+                            f.delete();
-                        if ( file.exists() )
+                        if ( f.exists() )
-                            version = FileUtils.fileRead( file );
-                            log( "Resolved version: " + version );
-                            dep.setResolvedVersion( version );
-                            if ( !version.endsWith( "SNAPSHOT" ) )
+                            if ( !localFile.exists() || localFile.lastModified() < f.lastModified() )
-                                String ver = version.substring(
-                                    version.lastIndexOf( "-", version.lastIndexOf( "-" ) - 1 ) + 1 );
-                                String extension = url.substring( url.length() - 4 );
-                                url = getSnapshotMetadataFile( url, ver + extension );
-                            }
-                            else if ( destinationFile.exists() )
-                            {
-                                // It's already there
-                                return true;
+                                version = FileUtils.fileRead( f );
+                                log( "Resolved version: " + version );
+                                dep.setResolvedVersion( version );
+                                if ( !version.endsWith( "SNAPSHOT" ) )
+                                {
+                                    String ver = version.substring(
+                                        version.lastIndexOf( "-", version.lastIndexOf( "-" ) - 1 ) + 1 );
+                                    String extension = url.substring( url.length() - 4 );
+                                    url = getSnapshotMetadataFile( url, ver + extension );
+                                }
+                                else if ( destinationFile.exists() )
+                                {
+                                    // It's already there
+                                    return true;
+                                }
+                                legacy = true;
+
+                    if ( !legacy && file.exists() )
+                    {
+                        log( "Using metadata: " + file );
+
+                        RepositoryMetadata metadata = RepositoryMetadata.read( file );
+
+                        version = metadata.constructVersion( version );
+                        log( "Resolved version: " + version );
+                        dep.setResolvedVersion( version );
+                        if ( !version.endsWith( "SNAPSHOT" ) )
+                        {
+                            String ver = version.substring(
+                                version.lastIndexOf( "-", version.lastIndexOf( "-" ) - 1 ) + 1 );
+                            String extension = url.substring( url.length() - 4 );
+                            url = getSnapshotMetadataFile( url, ver + extension );
+                        }
+                        else if ( destinationFile.exists() )
+                        {
+                            // It's already there
+                            return true;
+                        }
+                    }
