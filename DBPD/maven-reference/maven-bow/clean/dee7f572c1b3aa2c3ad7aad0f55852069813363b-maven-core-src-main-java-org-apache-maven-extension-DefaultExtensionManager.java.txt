Adding support for pre-scanning POMs for build extensions. NOTE: Plugins-as-extensions is not yet supported in this way.

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@497993 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.artifact.factory.ArtifactFactory;
+import org.apache.maven.model.Model;
+import org.apache.maven.model.Parent;
+import java.util.List;
+    private ArtifactFactory artifactFactory;
+    
+    public void addExtension( Extension extension, Model originatingModel, List remoteRepositories,
+                              ArtifactRepository localRepository )
+        throws ArtifactResolutionException, PlexusContainerException, ArtifactNotFoundException
+    {
+        Artifact extensionArtifact = artifactFactory.createBuildArtifact( extension.getGroupId(), extension.getArtifactId(), extension.getVersion(), "jar" );
+        
+        Parent originatingParent = originatingModel.getParent();
+        
+        String groupId = originatingModel.getGroupId();
+        if ( groupId == null && originatingParent != null )
+        {
+            groupId = originatingParent.getGroupId();
+        }
+        
+        String artifactId = originatingModel.getArtifactId();
+        
+        String version = originatingModel.getVersion();
+        if ( version == null && originatingParent != null )
+        {
+            version = originatingParent.getVersion();
+        }
+        
+        Artifact projectArtifact = artifactFactory.createProjectArtifact( groupId, artifactId, version );
+
+        addExtension( extensionArtifact, projectArtifact, remoteRepositories, localRepository, null );
+    }
+    
-
-        if ( artifact != null )
+        
+        addExtension( artifact, project.getArtifact(), project.getRemoteArtifactRepositories(), localRepository,
+                      new ActiveArtifactResolver( project ) );
+    }
+    
+    private void addExtension( Artifact extensionArtifact, Artifact projectArtifact, List remoteRepositories,
+                               ArtifactRepository localRepository, ActiveArtifactResolver activeArtifactResolver )
+        throws ArtifactResolutionException, PlexusContainerException, ArtifactNotFoundException
+    {
+        if ( extensionArtifact != null )
-            ArtifactFilter filter = new ProjectArtifactExceptionFilter( artifactFilterManager.getArtifactFilter(), project.getArtifact() );
+            ArtifactFilter filter = new ProjectArtifactExceptionFilter( artifactFilterManager.getArtifactFilter(), projectArtifact );
-            ArtifactResolutionResult result = artifactResolver.resolveTransitively( Collections.singleton( artifact ),
-                                                                                    project.getArtifact(),
+            ArtifactResolutionResult result = artifactResolver.resolveTransitively( Collections.singleton( extensionArtifact ),
+                                                                                    projectArtifact,
-                                                                                    project.getRemoteArtifactRepositories(),
+                                                                                    remoteRepositories,
-                a = project.replaceWithActiveArtifact( a );
+                if ( activeArtifactResolver != null )
+                {
+                    a = activeArtifactResolver.replaceWithActiveArtifact( a );
+                }
+    
+    private static final class ActiveArtifactResolver
+    {
+        private MavenProject project;
+        
+        ActiveArtifactResolver( MavenProject project )
+        {
+            this.project = project;
+        }
+        
+        Artifact replaceWithActiveArtifact( Artifact artifact )
+        {
+            return project.replaceWithActiveArtifact( artifact );
+        }
+    }
+
