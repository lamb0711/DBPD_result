Rearranging project-builder caching so it's done externally and available for use in the model-lineage builder and during artifact resolution as well.

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@509692 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.model.Parent;
+import java.util.ArrayList;
-                                        ProfileManager globalProfileManager, Map pomFilesById )
+                                        ProfileManager globalProfileManager )
+        scanInternal( pom, localRepository, globalProfileManager, new ArrayList() );
+    }
+    
+    private void scanInternal( File pom, ArtifactRepository localRepository, ProfileManager globalProfileManager,
+                               List visitedModelIds )
+        throws ExtensionScanningException
+    {
+        
-                                                      globalProfileManager, pomFilesById );
+                                                      globalProfileManager );
+                String key = createKey( model );
+                
+                if ( visitedModelIds.contains( key ) )
+                {
+                    getLogger().debug( "Already visited: " + key + "; continuing." );
+                    continue;
+                }
+                
+                visitedModelIds.add( key );
+                
+                File modelPom = lineageIterator.getPOMFile();
-                getLogger().debug( "Checking: " + model.getId() + " for extensions." );
+                getLogger().debug( "Checking: " + model.getId() + " for extensions. (It has " + model.getModules().size() + " modules.)" );
-                checkModulesForExtensions( pom, model, localRepository, originalRemoteRepositories, globalProfileManager,
-                                           pomFilesById );
+                checkModulesForExtensions( modelPom, model, localRepository, originalRemoteRepositories, globalProfileManager, visitedModelIds );
+    private String createKey( Model model )
+    {
+        Parent parent = model.getParent();
+        
+        String groupId = model.getGroupId();
+        if ( groupId == null )
+        {
+            groupId = parent.getGroupId();
+        }
+        
+        String artifactId = model.getArtifactId();
+        
+        return groupId + ":" + artifactId;
+    }
+
-                                            Map pomFilesById )
+                                            List visitedModelIds )
+            getLogger().debug( "Basedir is: " + basedir );
-                                           + "; continuing scan with next module." );
+                                           + "; continuing scan with next module. (Full path was: " + modulePomDirectory + ")" );
-                scanForBuildExtensions( modulePomDirectory, localRepository, globalProfileManager, pomFilesById );
+                scanInternal( modulePomDirectory, localRepository, globalProfileManager, visitedModelIds );
-                                            List originalRemoteRepositories, ProfileManager globalProfileManager,
-                                            Map cache )
+                                            List originalRemoteRepositories, ProfileManager globalProfileManager )
-                                                             globalProfileManager, cache );
+                                                             globalProfileManager );
