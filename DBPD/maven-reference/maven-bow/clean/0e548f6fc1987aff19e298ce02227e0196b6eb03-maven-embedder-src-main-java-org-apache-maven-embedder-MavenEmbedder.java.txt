MNG-1937, MNG-1665
allow custom configuration of embedder.
correct settings location handling for embedder's project reading methods

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@395691 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.maven.settings.MavenSettingsBuilder;
-    private MavenSettingsBuilder settingsBuilder;
+     * @deprecated not used
+    /**
+     * @deprecated not used.
+     */
+    /**
+     * @deprecated not used.
+     */
+    /**
+     * @deprecated not used.
+     */
+    /**
+     * @deprecated not used.
+     */
+    /**
+     * @deprecated not used.
+     */
+    /**
+     * @deprecated not used.
+     */
+    /**
+     * @deprecated not used.
+     */
+    /**
+     * @deprecated not used
+     */
+    /**
+     * @deprecated not used.
+     */
+    /**
+     * @deprecated not used.
+     */
-        return createLocalRepository( settings.getLocalRepository(), DEFAULT_LOCAL_REPO_ID );
+        return createLocalRepository( mavenTools.getLocalRepositoryPath( settings ), DEFAULT_LOCAL_REPO_ID );
-        detectUserInstallation();
+        start(new DefaultMavenEmbedRequest());
+        
+    }
+    
+    public void start(MavenEmbedRequest req)
+        throws MavenEmbedderException
+    {
-
-
+            
+            if (req.getContainerCustomizer() != null) 
+            {
+                req.getContainerCustomizer().customize(embedder.getContainer());
+            }
+            
+            
+            profileManager.explicitlyActivate(req.getActiveProfiles());
+            
+            profileManager.explicitlyDeactivate(req.getInactiveProfiles());
+            
+            settings = mavenTools.buildSettings( req.getUserSettingsFile(), 
+                                                 req.getGlobalSettingsFile(), 
+                                                 null );
+            
+            localRepository = createLocalRepository( settings );
+            
-        }
-    }
-
-    // ----------------------------------------------------------------------
-    //
-    // ----------------------------------------------------------------------
-
-    private void detectUserInstallation()
-    {
-        if ( new File( userHome, ".m2" ).exists() )
+        } 
+        catch (SettingsConfigurationException e ) 
-            alignWithUserInstallation = true;
+            throw new MavenEmbedderException( "Cannot create settings configuration", e );
+
-            embedder.release( settingsBuilder );
-
+    
+    public Settings buildSettings( File userSettingsPath,
+                                   File globalSettingsPath,
+                                   Boolean pluginUpdateOverride )
+        throws SettingsConfigurationException
+    {
+        return mavenTools.buildSettings( userSettingsPath,
+                                         globalSettingsPath,
+                                         pluginUpdateOverride );
+    }
+    
