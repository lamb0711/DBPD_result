MNG-2813: Fix OutOfMemoryError when using profiles and pom inheritance
Submitted by: Jochen Kuhnle


git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@543373 13f79535-47bb-0310-9956-ffa450edef68

+    
+    /**
+     * Merge two DOMs. Copy the dominant DOM so the original one is left unchanged.
+     * <p>
+     * Use this method instead of a direct call to {@link Xpp3Dom#mergeXpp3Dom(Xpp3Dom, Xpp3Dom)}.
+     * Profiles are dominant, thus they are merge targets, but they may be merged in several times
+     * (e.g. if they are inherited). So with the second merge, you don't get the profile's original
+     * DOM, but an already merged one.
+     * 
+     * @param dominant Dominant DOM
+     * @param recessive Recessive DOM
+     * @return Merged DOM
+     */
+    private Xpp3Dom merge( Xpp3Dom dominant, Xpp3Dom recessive )
+    {
+        Xpp3Dom dominantCopy = ( dominant == null ) ? null : new Xpp3Dom( dominant );
+        return Xpp3Dom.mergeXpp3Dom( dominantCopy, recessive );
+    }
-        configuration = Xpp3Dom.mergeXpp3Dom( configuration, parentConfiguration );
+        configuration = merge( configuration, parentConfiguration );
-        recessive.setConfiguration( Xpp3Dom.mergeXpp3Dom( dominantConfig, recessiveConfig ) );
+        recessive.setConfiguration( merge( dominantConfig, recessiveConfig ) );
-                merged.setConfiguration( Xpp3Dom.mergeXpp3Dom( dominantRSConfig, mergedRSConfig ) );
+                merged.setConfiguration( merge( dominantRSConfig, mergedRSConfig ) );
