Merge branch 'master' of https://git-wip-us.apache.org/repos/asf/maven into trunk

+import java.util.concurrent.atomic.AtomicReference;
+
-    private static final ThreadLocal<MavenSession[]> session = new InheritableThreadLocal<MavenSession[]>();
+    private static final ThreadLocal<AtomicReference<MavenSession>> SESSION = new InheritableThreadLocal<AtomicReference<MavenSession>>();
-        if ( session == null )
+        AtomicReference<MavenSession> reference = DefaultLegacySupport.SESSION.get();
+        if ( reference != null )
-            MavenSession[] oldSession = DefaultLegacySupport.session.get();
-            if ( oldSession != null )
-            {
-                oldSession[0] = null;
-                DefaultLegacySupport.session.remove();
-            }
+            reference.set( null );
+        }
+
+        if ( session == null && reference != null )
+        {
+            DefaultLegacySupport.SESSION.remove();
-            DefaultLegacySupport.session.set( new MavenSession[] { session } );
+            DefaultLegacySupport.SESSION.set( new AtomicReference<MavenSession>( session ) );
-        MavenSession[] currentSession = DefaultLegacySupport.session.get();
-        return currentSession != null ? currentSession[0] : null;
+        AtomicReference<MavenSession> currentSession = DefaultLegacySupport.SESSION.get();
+        return currentSession != null ? currentSession.get() : null;
