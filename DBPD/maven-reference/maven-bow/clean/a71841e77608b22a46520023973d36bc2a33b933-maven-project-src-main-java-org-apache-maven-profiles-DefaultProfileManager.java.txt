Fixed profile activation for profiles in pom. Profile injection was causing double injection of some elements from plugin mng. Partial fix.

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@758473 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.maven.model.io.xpp3.MavenXpp3Writer;
-import org.apache.maven.shared.model.ModelContainer;
-import org.apache.maven.shared.model.ModelProperty;
-import org.apache.maven.shared.model.ModelMarshaller;
+import org.apache.maven.profiles.matchers.DefaultMatcher;
+import org.apache.maven.profiles.matchers.ProfileMatcher;
+import org.apache.maven.profiles.matchers.PropertyMatcher;
-import org.apache.maven.project.builder.factories.IdModelContainerFactory;
-import org.apache.maven.project.builder.ProjectUri;
-import org.apache.maven.project.builder.PomTransformer;
-import org.apache.maven.project.builder.profile.*;
-import org.codehaus.plexus.util.xml.pull.XmlSerializer;
-import org.codehaus.plexus.util.xml.pull.MXSerializer;
-import java.io.*;
-import java.lang.reflect.Method;
-
-
+        List<Profile> defaults = getDefaultProfiles(allActive);
+        if(defaults.size() < allActive.size())
+        {
+            allActive.removeAll( defaults );
+        }
+    
+    private static List<Profile> getDefaultProfiles(List<Profile> profiles)
+    {
+        List<Profile> defaults = new ArrayList<Profile>();
+        for(Profile p : profiles)
+        {
+            if(p.getActivation() != null && p.getActivation().isActiveByDefault() )
+            {
+                defaults.add( p );
+            }
+        }
+        return defaults;
+    }
-    private static List<ActiveProfileMatcher> matchers = Arrays.asList(new FileMatcher(),
-        new JdkMatcher(), new OperatingSystemMatcher(), new PropertyMatcher());
+    private static List<ProfileMatcher> matchers = Arrays.asList( (ProfileMatcher) new DefaultMatcher(),
+        (ProfileMatcher) new PropertyMatcher());
-    {
+    {/*
+        */
+        List<InterpolatorProperty> interpolatorProperties = new ArrayList<InterpolatorProperty>();
+        if(context.getExecutionProperties() != null)
+        {
+            interpolatorProperties.addAll(InterpolatorProperty.toInterpolatorProperties(
+                                                                                        context.getExecutionProperties(),
+                                                                                        PomInterpolatorTag.EXECUTION_PROPERTIES.name()));              
+        }
+     
+        for(ProfileMatcher matcher : matchers)
+        {
+            if(matcher.isMatch(profile, interpolatorProperties))
+            {
+                return true;
+            }
+        }
+        return false;
