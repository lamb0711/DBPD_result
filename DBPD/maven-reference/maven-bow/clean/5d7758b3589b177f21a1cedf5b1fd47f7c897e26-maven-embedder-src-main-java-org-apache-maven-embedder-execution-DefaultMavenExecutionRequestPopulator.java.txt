o pull from trunky dunk dunk


git-svn-id: https://svn.apache.org/repos/asf/maven/components/branches/MNG-2766@767707 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.model.Model;
+import org.apache.maven.profiles.ProfileActivationException;
+import org.apache.maven.toolchain.ToolchainsBuilder;
+    @Requirement
+    private ToolchainsBuilder toolchainsBuilder;
+
+        toolchains( request, configuration );
+
+            }
-                // We need to convert profile repositories to artifact repositories
-
-                for ( Repository r : profile.getRepositories() )
+            // We need to convert profile repositories to artifact repositories
+            try
+            {
+                for ( Profile profile : profileManager.getActiveProfiles() )
-                    try
+                    for ( Repository r : profile.getRepositories() )
-                        request.addRemoteRepository( repositorySystem.buildArtifactRepository( r ) );
+                        try
+                        {
+                            request.addRemoteRepository( repositorySystem.buildArtifactRepository( r ) );
+                        }
+                        catch ( InvalidRepositoryException e )
+                        {
+                            throw new MavenEmbedderException( "Cannot create remote repository " + r.getId(), e );
+                        }
-                    catch ( InvalidRepositoryException e )
+                    for ( Repository r : profile.getPluginRepositories() )
-                        throw new MavenEmbedderException( "Cannot create remote repository " + r.getId(), e );
-                    }
+                        try
+                        {
+                            request.addRemoteRepository( repositorySystem.buildArtifactRepository( r ) );
+                        }
+                        catch ( InvalidRepositoryException e )
+                        {
+                            throw new MavenEmbedderException( "Cannot create remote repository " + r.getId(), e );
+                        }
+                    }                    
+            catch ( ProfileActivationException e )
+            {
+                throw new MavenEmbedderException( "Cannot determine active profiles", e );
+            }
-        ProfileManager globalProfileManager = new DefaultProfileManager( container, activationContext );
+        ProfileManager globalProfileManager = new DefaultProfileManager( activationContext );
+
+    private void toolchains( MavenExecutionRequest request, Configuration configuration )
+    {
+        toolchainsBuilder.setUserToolchainsFile( request.getUserToolchainsFile() );
+    }
+
