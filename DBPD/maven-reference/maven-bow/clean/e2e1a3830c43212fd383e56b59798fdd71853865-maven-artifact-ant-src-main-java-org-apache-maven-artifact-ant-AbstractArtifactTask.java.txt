PR: MNG-440
read settings.xml for the local repository


git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@189484 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.settings.Settings;
+import org.apache.maven.settings.io.xpp3.SettingsXpp3Reader;
+import org.apache.tools.ant.Project;
+import org.codehaus.plexus.util.IOUtil;
+import org.codehaus.plexus.util.StringUtils;
+import org.codehaus.plexus.util.xml.pull.XmlPullParserException;
+import java.io.FileReader;
+import java.io.IOException;
-    protected ArtifactRepository createArtifactRepository( LocalRepository repository )
+    private Settings settings;
+
+    protected ArtifactRepository createLocalArtifactRepository( LocalRepository repository )
-    protected ArtifactRepository createArtifactRepository( RemoteRepository repository )
+    protected ArtifactRepository createRemoteArtifactRepository( RemoteRepository repository )
+        Settings settings = getSettings();
-        localRepository.setLocation( new File( System.getProperty( "user.home" ), ".m2/repository" ) );
+        localRepository.setLocation( new File( settings.getLocalRepository() ) );
+
+    protected synchronized Settings getSettings()
+    {
+        if ( settings == null )
+        {
+            settings = new Settings();
+
+            File settingsFile = new File( System.getProperty( "user.home" ), ".ant/settings.xml" );
+            if ( !settingsFile.exists() )
+            {
+                settingsFile = new File( System.getProperty( "user.home" ), ".m2/settings.xml" );
+            }
+
+            if ( settingsFile.exists() )
+            {
+                FileReader reader = null;
+                try
+                {
+                    reader = new FileReader( settingsFile );
+
+                    SettingsXpp3Reader modelReader = new SettingsXpp3Reader();
+
+                    settings = modelReader.read( reader );
+                }
+                catch ( IOException e )
+                {
+                    log( "Error reading settings file '" + settingsFile + "' - ignoring. Error was: " + e.getMessage(),
+                         Project.MSG_WARN );
+                }
+                catch ( XmlPullParserException e )
+                {
+                    log( "Error parsing settings file '" + settingsFile + "' - ignoring. Error was: " + e.getMessage(),
+                         Project.MSG_WARN );
+                }
+                finally
+                {
+                    IOUtil.close( reader );
+                }
+            }
+
+            if ( StringUtils.isEmpty( settings.getLocalRepository() ) )
+            {
+                String location = new File( System.getProperty( "user.home" ), ".m2/repository" ).getAbsolutePath();
+                settings.setLocalRepository( location );
+            }
+        }
+        return settings;
+    }
