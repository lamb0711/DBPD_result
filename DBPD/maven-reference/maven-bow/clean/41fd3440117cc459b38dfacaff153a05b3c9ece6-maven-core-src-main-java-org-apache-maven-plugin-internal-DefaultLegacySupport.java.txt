MNG-4866 use intermediate array to make sure we can purge all inherited MavenSession instances

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@1022613 13f79535-47bb-0310-9956-ffa450edef68

-    private ThreadLocal<MavenSession> session = new InheritableThreadLocal<MavenSession>();
+    private static final ThreadLocal<MavenSession[]> session = new InheritableThreadLocal<MavenSession[]>();
-            this.session.remove();
+            MavenSession[] oldSession = DefaultLegacySupport.session.get();
+            if ( oldSession != null )
+            {
+                oldSession[0] = null;
+                DefaultLegacySupport.session.remove();
+            }
-            this.session.set( session );
+            DefaultLegacySupport.session.set( new MavenSession[] { session } );
-        return session.get();
+        MavenSession[] currentSession = DefaultLegacySupport.session.get();
+        return currentSession != null ? currentSession[0] : null;
