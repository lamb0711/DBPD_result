various release plugin fixes

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@279240 13f79535-47bb-0310-9956-ffa450edef68

+import org.codehaus.plexus.util.StringUtils;
-        Model model = project.getModel();
-
-        Scm scm = model.getScm();
-
-        if ( scm == null )
+        if ( project.getScm() == null )
-        String tag = model.getScm().getTag();
+        Model model = project.getOriginalModel();
-        String connection = model.getScm().getConnection();
+        Scm scm = model.getScm();
+        // If SCM is null in original model, it is inherited, no mods needed
+        if ( scm != null )
+        {
+            String tag = scm.getTag();
-        String developerConnection = model.getScm().getDeveloperConnection();
+            String connection = scm.getConnection();
-        ScmInfo info = new ScmInfo( tag, connection, developerConnection );
+            String developerConnection = scm.getDeveloperConnection();
-        originalScmInformation.put( projectId, info );
+            String url = scm.getUrl();
-        scm.setTag( tagLabel );
+            ScmInfo info = new ScmInfo( tag, connection, developerConnection, url );
-        scm.setConnection( rewriteScmConnection( connection, tagLabel ) );
+            originalScmInformation.put( projectId, info );
-        scm.setDeveloperConnection( rewriteScmConnection( developerConnection, tagLabel ) );
+            rewriteScmConnection( scm, tagLabel );
+        }
-    // TODO: Add other SCM types for rewriting...
-    private String rewriteScmConnection( String scmConnection, String tag )
+    // TODO: Add other SCM types for rewriting, and allow other layouts
+    private void rewriteScmConnection( Scm scm, String tag )
-        if ( scmConnection != null )
+        if ( scm != null )
-            if ( scmConnection.startsWith( "svn" ) )
+            String scmConnection = scm.getConnection();
+            if ( scmConnection != null && scmConnection.startsWith( "scm:svn" ) )
-                if ( scmConnection.endsWith( "trunk/" ) )
-                {
-                    scmConnection = scmConnection.substring( 0, scmConnection.length() - "trunk/".length() );
-                }
-                if ( scmConnection.endsWith( "branches/" ) )
-                {
-                    scmConnection = scmConnection.substring( 0, scmConnection.length() - "branches/".length() );
-                }
-                scmConnection += "tags/" + tag;
+                scm.setConnection( convertSvnConnectionString( scmConnection, tag ) );
+                scm.setDeveloperConnection( convertSvnConnectionString( scm.getDeveloperConnection(), tag ) );
+                scm.setUrl( convertSvnConnectionString( scm.getUrl(), tag ) );
+    }
+    private String convertSvnConnectionString( String scmConnection, String tag )
+    {
+        if ( scmConnection.indexOf( "/trunk" ) >= 0 )
+        {
+            scmConnection = StringUtils.replace( scmConnection, "/trunk", "/tags/" + tag );
+        }
+        else
+        {
+            int begin = scmConnection.indexOf( "/branches/" );
+            if ( begin >= 0 )
+            {
+                int end = scmConnection.indexOf( '/', begin + "/branches/".length() );
+                scmConnection = scmConnection.substring( 0, begin ) + "/tags/" + tag;
+                if ( end >= 0 && end < scmConnection.length() - 1 )
+                {
+                    scmConnection += scmConnection.substring( end );
+                }
+            }
+        }
-        ScmInfo( String tag, String connection, String developerConnection )
+        private String url;
+
+        ScmInfo( String tag, String connection, String developerConnection, String url )
+            this.url = url;
-            Model model = project.getModel();
+            Model model = project.getOriginalModel();
-            if ( model.getScm() != null )
+            Scm scm = model.getScm();
+            if ( scm != null )
-                model.getScm().setTag( tag );
+                scm.setTag( tag );
-                model.getScm().setConnection( connection );
+                scm.setConnection( connection );
-                model.getScm().setDeveloperConnection( developerConnection );
+                scm.setDeveloperConnection( developerConnection );
+
+                scm.setUrl( url );
