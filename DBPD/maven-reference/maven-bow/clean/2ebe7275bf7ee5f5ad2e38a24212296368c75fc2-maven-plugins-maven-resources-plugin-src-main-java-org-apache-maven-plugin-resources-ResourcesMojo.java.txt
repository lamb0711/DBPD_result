PR: MNG-178
Submitted by: Kenney Westerhof
Reviewed by:  Brett Porter

add filtering support to the resources
(applied with modifications)



git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@191749 13f79535-47bb-0310-9956-ffa450edef68

+import org.codehaus.plexus.util.IOUtil;
+import org.codehaus.plexus.util.InterpolationFilterReader;
+import java.io.BufferedReader;
+import java.io.FileReader;
+import java.io.FileWriter;
+import java.io.IOException;
+import java.io.Reader;
+import java.io.Writer;
+import java.util.Properties;
+    /**
+     * Wheter to apply filters during transfer.
+     *
+     * @parameter
+     */
+    private boolean filtering = false;
+
+    /**
+     * The name of the filter property file to use.
+     *
+     * @parameter expression="${basedir}/filter.properties"
+     */
+    private File filterPropertiesFile;
+
+    private Properties filterProperties;
+
+        initializeFiltering();
-                FileUtils.copyFile( source, destinationFile );
+                copyFile( source, destinationFile );
-        throws Exception
+    private void initializeFiltering()
+        throws MojoExecutionException
+    {
+        if ( filtering )
+        {
+            try
+            {
+                filterProperties = PropertyUtils.loadPropertyFile( filterPropertiesFile, true, true );
+            }
+            catch ( IOException e )
+            {
+                throw new MojoExecutionException( "Error loading property file '" + filterPropertiesFile + "'", e );
+            }
+        }
+    }
+
+    private void copyFile( File from, File to )
+        throws IOException
+    {
+        if ( !filtering )
+        {
+            FileUtils.copyFile( from, to );
+        }
+        else
+        {
+            // buffer so it isn't reading a byte at a time!
+            Reader fileReader = new BufferedReader( new FileReader( from ) );
+            Writer fileWriter = null;
+            try
+            {
+                // support ${token}
+                Reader reader = new InterpolationFilterReader( fileReader, filterProperties, "${", "}" );
+
+                // support @token@
+                reader = new InterpolationFilterReader( reader, filterProperties, "@", "@" );
+
+                fileWriter = new FileWriter( to );
+
+                IOUtil.copy( reader, fileWriter );
+            }
+            finally
+            {
+                IOUtil.close( fileReader );
+                IOUtil.close( fileWriter );
+            }
+        }
+    }
