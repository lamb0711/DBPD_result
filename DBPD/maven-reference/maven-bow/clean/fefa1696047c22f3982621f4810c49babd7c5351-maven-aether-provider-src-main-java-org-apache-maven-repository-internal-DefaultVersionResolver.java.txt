[MNG-4814] Eary dependency resolution attempts for reactor projects prevent their later resolution from the reactor

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@997938 13f79535-47bb-0310-9956-ffa450edef68

+import org.sonatype.aether.ConfigurationProperties;
+import org.sonatype.aether.util.artifact.SubArtifact;
-        if ( cache != null )
+        if ( cache != null && !ConfigurationProperties.get( session, "aether.versionResolver.noCache", false ) )
-        if ( cacheKey != null && metadata != null )
+        if ( cacheKey != null && metadata != null && isSafelyCacheable( session, artifact ) )
+    private boolean isSafelyCacheable( RepositorySystemSession session, Artifact artifact )
+    {
+        /*
+         * The workspace/reactor is in flux so we better not assume definitive information for any of its
+         * artifacts/projects.
+         */
+
+        WorkspaceReader workspace = session.getWorkspaceReader();
+        if ( workspace == null )
+        {
+            return true;
+        }
+
+        Artifact pomArtifact = artifact;
+        if ( pomArtifact.getClassifier().length() > 0 || !"pom".equals( pomArtifact.getExtension() ) )
+        {
+            pomArtifact = new SubArtifact( artifact, "", "pom" );
+        }
+
+        return workspace.findArtifact( pomArtifact ) == null;
+    }
+
