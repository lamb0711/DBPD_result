honour an installed SNAPSHOT in favour of the remote version, until a newer remote version is deployed


git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@163713 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.File;
-            // TODO: this mostly works, however...
-            //  - we definitely need the manual/daily check as this is quite slow given the large number of snapshots inside m2 presently
-
-            if ( !alreadyResolved( artifact ) )
+            boolean alreadyResolved = alreadyResolved( artifact );
+            if ( !alreadyResolved )
+                resolvedArtifactCache.add( getCacheKey( artifact ) );
+            }
+
+            // TODO: if the POM and JAR are inconsistent, this might mean that different version of each are used
+            if ( artifact.getFile().exists() && artifact.getFile().lastModified() > localMetadata.getLastModified() )
+            {
+                if ( !alreadyResolved )
+                {
+                    // Locally installed file is newer, don't use the resolved version
+                    getLogger().info( artifact.getArtifactId() + ": using locally installed snapshot" );
+                }
+            }
+            else
+            {
-                    if ( !version.equals( artifact.getBaseVersion() ) )
+                    if ( !version.equals( artifact.getBaseVersion() ) && !alreadyResolved )
-                resolvedArtifactCache.add( getCacheKey( artifact ) );
+                artifact.setVersion( version );
+                try
+                {
+                    artifact.setFile( new File( localRepository.getBasedir(), localRepository.pathOf( artifact ) ) );
+                }
+                catch ( ArtifactPathFormatException e )
+                {
+                    throw new ArtifactMetadataRetrievalException( "Error reading local metadata", e );
+                }
-            artifact.setVersion( version );
