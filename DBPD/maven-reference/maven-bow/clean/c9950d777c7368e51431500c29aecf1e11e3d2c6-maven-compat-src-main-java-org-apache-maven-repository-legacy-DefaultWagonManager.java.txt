[MNG-5509] org.apache.maven.repository.legacy.DefaultWagonManager should
set User-Agent
+import java.lang.reflect.Method;
+import java.util.Properties;
+import org.apache.maven.plugin.LegacySupport;
+import org.eclipse.aether.ConfigurationProperties;
+import org.eclipse.aether.util.ConfigUtils;
+    @Requirement
+    private LegacySupport legacySupport;
+    
+    
+        // MNG-5509 
+        // See org.eclipse.aether.connector.wagon.WagonRepositoryConnector.connectWagon(Wagon)
+        if( legacySupport.getRepositorySession() != null )
+        {
+            Properties headers = new Properties();
+            
+            headers.put( "User-Agent", ConfigUtils.getString( legacySupport.getRepositorySession(), "Maven",
+                                                              ConfigurationProperties.USER_AGENT ) );
+            try
+            {
+                Method setHttpHeaders = wagon.getClass().getMethod( "setHttpHeaders", Properties.class );
+                setHttpHeaders.invoke( wagon, headers );
+            }
+            catch ( NoSuchMethodException e )
+            {
+                // normal for non-http wagons
+            }
+            catch ( Exception e )
+            {
+                logger.debug( "Could not set user agent for wagon " + wagon.getClass().getName() + ": " + e );
+            }
+        }
+        
-
+        
