[MNG-4717] Repository Ids containing ":" will lead to checksum errors on Windows machines

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@965233 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.settings.building.SettingsProblem.Severity;
+    private static final String ILLEGAL_FS_CHARS = "\\/:\"<>|?*";
+
+    private static final String ILLEGAL_REPO_ID_CHARS = ILLEGAL_FS_CHARS;
+
-            addWarn( problems, "'usePluginRegistry' is deprecated and has no effect." );
+            addViolation( problems, Severity.WARNING, "usePluginRegistry", null, "is deprecated and has no effect." );
-                    addError( problems, "'pluginGroups.pluginGroup[" + i + "]' must not be empty." );
+                    addViolation( problems, Severity.ERROR, "pluginGroups.pluginGroup[" + i + "]", null,
+                                  "must not be empty" );
-                    addError( problems, "'pluginGroups.pluginGroup[" + i
-                        + "]' must denote a valid group id and match the pattern " + ID_REGEX );
+                    addViolation( problems, Severity.ERROR, "pluginGroups.pluginGroup[" + i + "]", null,
+                                  "must denote a valid group id and match the pattern " + ID_REGEX );
+                validateBannedCharacters( problems, "mirrors.mirror.id", Severity.WARNING, mirror.getId(), null,
+                                          ILLEGAL_REPO_ID_CHARS );
+
-                    addWarn( problems, "'mirrors.mirror.id' must not be 'local'"
+                    addViolation( problems, Severity.WARNING, "mirrors.mirror.id", null, "must not be 'local'"
+            validateBannedCharacters( problems, prefix + ".id", Severity.WARNING, repository.getId(), null,
+                                      ILLEGAL_REPO_ID_CHARS );
+
-                addWarn( problems, "'" + prefix + ".id' must not be 'local'"
+                addViolation( problems, Severity.WARNING, prefix + ".id", null, "must not be 'local'"
-                addWarn( problems, "'" + prefix + ".layout' for " + repository.getId()
-                    + " uses the deprecated value 'legacy'." );
+                addViolation( problems, Severity.WARNING, prefix + ".layout", repository.getId(),
+                              "uses the unsupported value 'legacy', artifact resolution might fail." );
-        String msg;
-        if ( sourceHint != null )
-        {
-            msg = "'" + fieldName + "' is missing for " + sourceHint;
-        }
-        else
-        {
-            msg = "'" + fieldName + "' is missing.";
-        }
-        addError( problems, msg );
+        addViolation( problems, Severity.ERROR, fieldName, sourceHint, "is missing" );
-        String msg;
-        if ( sourceHint != null )
-        {
-            msg = "'" + fieldName + "' is missing for " + sourceHint;
-        }
-        else
-        {
-            msg = "'" + fieldName + "' is missing.";
-        }
-        addError( problems, msg );
+        addViolation( problems, Severity.ERROR, fieldName, sourceHint, "is missing" );
-    private void addError( SettingsProblemCollector problems, String msg )
+    private boolean validateBannedCharacters( SettingsProblemCollector problems, String fieldName, Severity severity,
+                                              String string, String sourceHint, String banned )
-        problems.add( SettingsProblem.Severity.ERROR, msg, -1, -1, null );
+        if ( string != null )
+        {
+            for ( int i = string.length() - 1; i >= 0; i-- )
+            {
+                if ( banned.indexOf( string.charAt( i ) ) >= 0 )
+                {
+                    addViolation( problems, severity, fieldName, sourceHint,
+                                  "must not contain any of these characters " + banned + " but found "
+                                      + string.charAt( i ) );
+                    return false;
+                }
+            }
+        }
+
+        return true;
-    private void addWarn( SettingsProblemCollector problems, String msg )
+    private void addViolation( SettingsProblemCollector problems, Severity severity, String fieldName,
+                               String sourceHint, String message )
-        problems.add( SettingsProblem.Severity.WARNING, msg, -1, -1, null );
+        StringBuilder buffer = new StringBuilder( 256 );
+        buffer.append( '\'' ).append( fieldName ).append( '\'' );
+
+        if ( sourceHint != null )
+        {
+            buffer.append( " for " ).append( sourceHint );
+        }
+
+        buffer.append( ' ' ).append( message );
+
+        problems.add( severity, buffer.toString(), -1, -1, null );
