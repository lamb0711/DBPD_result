PR: MNG-1251
Submitted By: Jerome Lacoste
Reviewed By: John Casey

I did not apply this patch. A better solution was to initialize the artifact data a little more thoroughly, and only delegate those methods which must track changes to the main artifact (like version info, groupId, and artifactId...essentially, the things that determine how to locate metadata on the repository). For these delegating methods, I've disabled the corresponding setter methods with UnsupportedOperationException to indicate that these attributes must be managed via the main artifact, and why. The MavenProjectHelper will now lookup the proper ArtifactHandler for the given attachment type, and pass that on to the AttachedArtifact constructor also.

Jerome, thanks very much for the effort in exploring this issue. I appreciate the help.



git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@330392 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.artifact.handler.ArtifactHandler;
+import org.apache.maven.artifact.handler.manager.ArtifactHandlerManager;
+    
+    private ArtifactHandlerManager artifactHandlerManager;
-        Artifact artifact = new AttachedArtifact( project.getArtifact(), artifactType, artifactClassifier );
+        String type = artifactType;
+        
+        ArtifactHandler handler = null;
+        
+        if ( type != null )
+        {
+            handler = artifactHandlerManager.getArtifactHandler( artifactType );
+        }
+        
+        if ( handler == null )
+        {
+            handler = artifactHandlerManager.getArtifactHandler( "jar" );
+        }
+        
+        Artifact artifact = new AttachedArtifact( project.getArtifact(), artifactType, artifactClassifier, handler );
+        
+        artifact.setFile( artifactFile );
+        artifact.setResolved( true );
+        
+        project.addAttachedArtifact( artifact );
+    }
+
+    public void attachArtifact( MavenProject project, String artifactType, File artifactFile )
+    {
+        ArtifactHandler handler = artifactHandlerManager.getArtifactHandler( artifactType );
+        
+        Artifact artifact = new AttachedArtifact( project.getArtifact(), artifactType, handler );
+        
+        artifact.setFile( artifactFile );
+        artifact.setResolved( true );
+        
+        project.addAttachedArtifact( artifact );
+    }
+
+    public void attachArtifact( MavenProject project, File artifactFile, String artifactClassifier )
+    {
+        Artifact projectArtifact = project.getArtifact();
+        
+        Artifact artifact = new AttachedArtifact( projectArtifact, projectArtifact.getType(), artifactClassifier, projectArtifact.getArtifactHandler() );
