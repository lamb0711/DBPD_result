[MNG-1898] improve the diagnostics and switch on it0094


git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@379426 13f79535-47bb-0310-9956-ffa450edef68

-import java.lang.reflect.Field;
-import java.net.URL;
-import java.net.URLClassLoader;
-
-import javax.xml.parsers.SAXParserFactory;
-
+import javax.xml.parsers.SAXParserFactory;
+import java.lang.reflect.Field;
+import java.net.URL;
+import java.net.URLClassLoader;
+
- * 
+ *
- * 
-        
+
-        this.getLog().info(t);
-        URL url = originalLoader.getResource(t);
+        this.getLog().info( t );
+        URL url = originalLoader.getResource( t );
-        this.getLog().info("Loaded from: "+url.toString());
-        
+        this.getLog().info( "Loaded from: " + url.toString() );
+
-     * 
+     *
-        this.getLog().info( originalLoader.toString() );
+        this.getLog().info( "orig classloader:" );
+        printURLClassPath( Thread.currentThread().getContextClassLoader(), "" );
-        printURLClassPath();
+        this.getLog().info( "new classloader:" );
+        printURLClassPath( Thread.currentThread().getContextClassLoader(), "" );
-    public void printURLClassPath()
+    public void printURLClassPath( ClassLoader sysClassLoader, String s )
+        throws MojoExecutionException
-        ClassLoader sysClassLoader = Thread.currentThread().getContextClassLoader();
-        URL[] urls = ( (URLClassLoader) sysClassLoader ).getURLs();
-        this.getLog().info( "Added to Classpath:" );
+        URL[] urls;
+        if ( sysClassLoader instanceof URLClassLoader )
+        {
+            urls = ( (URLClassLoader) sysClassLoader ).getURLs();
+        }
+        else
+        {
+            try
+            {
+                Field f = sysClassLoader.getClass().getDeclaredField( "realm" );
+                f.setAccessible( true );
+                ClassRealm r = (ClassRealm) f.get( sysClassLoader );
+                urls = r.getConstituents();
+            }
+            catch ( NoSuchFieldException e )
+            {
+                throw new MojoExecutionException( "mee ", e );
+            }
+            catch ( IllegalAccessException e )
+            {
+                throw new MojoExecutionException( "mee ", e );
+            }
+        }
-            this.getLog().info( urls[i].getFile() );
+            this.getLog().info( s + urls[i].getFile() );
+        }
+
+        if ( sysClassLoader.getParent() != null )
+        {
+            printURLClassPath( sysClassLoader.getParent(), s + "  " );
