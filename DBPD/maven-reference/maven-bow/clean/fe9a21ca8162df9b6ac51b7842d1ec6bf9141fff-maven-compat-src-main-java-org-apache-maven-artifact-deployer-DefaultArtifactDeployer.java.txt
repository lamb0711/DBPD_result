[MNG-4571] mvn deploy -DaltDeploymentRepository errors out

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@917058 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Arrays;
+import java.util.List;
+import org.apache.maven.artifact.repository.DefaultArtifactRepository;
+import org.apache.maven.execution.MavenExecutionRequest;
+import org.apache.maven.repository.RepositorySystem;
+    private RepositorySystem repositorySystem;
+
+    @Requirement
+        deploymentRepository = injectSession( deploymentRepository );
+
+    private ArtifactRepository injectSession( ArtifactRepository repository )
+    {
+        /*
+         * NOTE: This provides backward-compat with maven-deploy-plugin:2.4 which bypasses the repository factory when
+         * using an alternative deployment location.
+         */
+        if ( repository instanceof DefaultArtifactRepository && repository.getAuthentication() == null )
+        {
+            MavenSession session = legacySupport.getSession();
+
+            if ( session != null )
+            {
+                MavenExecutionRequest request = session.getRequest();
+
+                if ( request != null )
+                {
+                    List<ArtifactRepository> repositories = Arrays.asList( repository );
+
+                    repositorySystem.injectProxy( repositories, request.getProxies() );
+
+                    repositorySystem.injectAuthentication( repositories, request.getServers() );
+                }
+            }
+        }
+
+        return repository;
+    }
+
