[MNG-2985] DefaultWagonManager does not safely remove TransferListeners from the wagon
Submitted By: Abel Mui√±o

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@538041 13f79535-47bb-0310-9956-ffa450edef68

-        package org.apache.maven.artifact.manager;
+package org.apache.maven.artifact.manager;
+    private static final String[] CHECKSUM_IDS = { "md5", "sha1" };
+
+    /** have to match the CHECKSUM_IDS */
+    private static final String[] CHECKSUM_ALGORITHMS = { "MD5", "SHA-1" };
+
-        try
+        for ( int i = 0; i < CHECKSUM_IDS.length; i++ )
-            ChecksumObserver checksumObserver = new ChecksumObserver( "MD5" );
-            wagon.addTransferListener( checksumObserver );
-            checksums.put( "md5", checksumObserver );
-            checksumObserver = new ChecksumObserver( "SHA-1" );
-            wagon.addTransferListener( checksumObserver );
-            checksums.put( "sha1", checksumObserver );
-        }
-        catch ( NoSuchAlgorithmException e )
-        {
-            throw new TransferFailedException( "Unable to add checksum methods: " + e.getMessage(), e );
+            checksums.put( CHECKSUM_IDS[i], addChecksumObserver( wagon, CHECKSUM_ALGORITHMS[i] ) );
-            Repository artifactRepository = new Repository( repository.getId(), repository.getUrl() );
-
-            if ( serverPermissionsMap.containsKey( repository.getId() ) )
+            try
-                RepositoryPermissions perms = (RepositoryPermissions) serverPermissionsMap.get( repository.getId() );
+                Repository artifactRepository = new Repository( repository.getId(), repository.getUrl() );
-                getLogger().debug(
-                    "adding permissions to wagon connection: " + perms.getFileMode() + " " + perms.getDirectoryMode() );
+                if ( serverPermissionsMap.containsKey( repository.getId() ) )
+                {
+                    RepositoryPermissions perms = (RepositoryPermissions) serverPermissionsMap.get( repository.getId() );
-                artifactRepository.setPermissions( perms );
+                    getLogger().debug( 
+                        "adding permissions to wagon connection: " + perms.getFileMode() + " " + perms.getDirectoryMode() );
+
+                    artifactRepository.setPermissions( perms );
+                }
+                else
+                {
+                    getLogger().debug( "not adding permissions to wagon connection" );
+                }
+
+                wagon.connect( artifactRepository, getAuthenticationInfo( repository.getId() ), getProxy( protocol ) );
+
+                wagon.put( source, remotePath );
-            else
+            finally
-                getLogger().debug( "not adding permissions to wagon connection" );
+                if ( downloadMonitor != null )
+                {
+                    wagon.removeTransferListener( downloadMonitor );
+                }
-            wagon.connect( artifactRepository, getAuthenticationInfo( repository.getId() ), getProxy( protocol ) );
-
-            wagon.put( source, remotePath );
-
-            wagon.removeTransferListener( downloadMonitor );
-
+            // Remove every checksum listener
+            for ( int i = 0; i < CHECKSUM_IDS.length; i++ )
+            {
+                TransferListener checksumListener = (TransferListener) checksums.get( CHECKSUM_IDS[i] );
+                if ( checksumListener != null )
+                {
+                    wagon.removeTransferListener( checksumListener );
+                }
+            }
+
+    private ChecksumObserver addChecksumObserver( Wagon wagon, String algorithm )
+        throws TransferFailedException
+    {
+        try
+        {
+            ChecksumObserver checksumObserver = new ChecksumObserver( algorithm );
+            wagon.addTransferListener( checksumObserver );
+            return checksumObserver;
+        }
+        catch ( NoSuchAlgorithmException e )
+        {
+            throw new TransferFailedException( "Unable to add checksum for unsupported algorithm " + algorithm, e );
+        }
+    }
+
-        ChecksumObserver md5ChecksumObserver;
-        ChecksumObserver sha1ChecksumObserver;
-        try
-        {
-            md5ChecksumObserver = new ChecksumObserver( "MD5" );
-            wagon.addTransferListener( md5ChecksumObserver );
-
-            sha1ChecksumObserver = new ChecksumObserver( "SHA-1" );
-            wagon.addTransferListener( sha1ChecksumObserver );
-        }
-        catch ( NoSuchAlgorithmException e )
-        {
-            throw new TransferFailedException( "Unable to add checksum methods: " + e.getMessage(), e );
-        }
+        int i = 0;
+        ChecksumObserver md5ChecksumObserver = addChecksumObserver( wagon, CHECKSUM_ALGORITHMS[i++] );
+        ChecksumObserver sha1ChecksumObserver = addChecksumObserver( wagon, CHECKSUM_ALGORITHMS[i++] );
+            // Remove every TransferListener
+            wagon.removeTransferListener( md5ChecksumObserver );
+            wagon.removeTransferListener( sha1ChecksumObserver );
+            if ( downloadMonitor != null )
+            {
+                wagon.removeTransferListener( downloadMonitor );
+            }
+
