o fix for testitMNG4091_InvalidDescriptor(org.apache.maven.it.MavenITmng4091BadPluginDescriptorTest)


git-svn-id: https://svn.apache.org/repos/asf/maven/components/branches/MNG-2766@777230 13f79535-47bb-0310-9956-ffa450edef68

+     * @throws InvalidPluginDescriptorException 
-        throws PluginNotFoundException, PluginResolutionException, PluginDescriptorParsingException, CycleDetectedInPluginGraphException
+        throws PluginNotFoundException, PluginResolutionException, PluginDescriptorParsingException, CycleDetectedInPluginGraphException, InvalidPluginDescriptorException
-                 
+        
+        String pluginKey = constructPluginKey( plugin );
+        
+        // Check the internal consistent of a plugin descriptor when it is discovered. Most of the time the plugin descriptor is generated
+        // by the maven-plugin-plugin, but if you happened to have created one by hand and it's incorrect this validator will report
+        // the problem to the user.
+        //
+        MavenPluginValidator validator = new MavenPluginValidator( pluginArtifact );
+        
-            container.discoverComponents( pluginRealm );
+            container.discoverComponents( pluginRealm, validator );
-        pluginClassLoaderCache.put( constructPluginKey( plugin ), pluginRealm );
+        if ( validator.hasErrors() )                                                                                                                        
+        {          
+            throw new InvalidPluginDescriptorException( "Invalid Plugin Descriptor for " + pluginKey, validator.getErrors() );
+        }        
+        
+        pluginClassLoaderCache.put( pluginKey, pluginRealm );
-        throws PluginNotFoundException, PluginResolutionException, PluginDescriptorParsingException, CycleDetectedInPluginGraphException, MojoNotFoundException
+        throws PluginNotFoundException, PluginResolutionException, PluginDescriptorParsingException, CycleDetectedInPluginGraphException, MojoNotFoundException, InvalidPluginDescriptorException
-        throws PluginNotFoundException, PluginResolutionException, PluginDescriptorParsingException, CycleDetectedInPluginGraphException, MojoNotFoundException
+        throws PluginNotFoundException, PluginResolutionException, PluginDescriptorParsingException, CycleDetectedInPluginGraphException, MojoNotFoundException, InvalidPluginDescriptorException
+            MavenPluginValidator validator = (MavenPluginValidator) event.getData();
+            
+            validator.validate( pluginDescriptor );
+            
+            if ( validator.hasErrors() )
+            {
+                return;
+            }
+            
