PR: MNG-207
scope must be considered globally - redefining it weaker must not win.


git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@163589 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.artifact.DefaultArtifact;
+import java.util.Collection;
+import java.util.HashSet;
+
+    public void addArtifacts( Collection newArtifacts )
+    {
+//        project.getArtifacts().addAll( result.getArtifacts().values() );
+        // We need to override the scope if one declared it higher
+        // TODO: could surely be more efficient, and use the scope handler, be part of maven-artifact...
+        Map artifacts = new HashMap();
+        for ( Iterator i = getArtifacts().iterator(); i.hasNext(); )
+        {
+            Artifact a = (Artifact) i.next();
+            artifacts.put( a.getId(), a );
+        }
+        for ( Iterator i = newArtifacts.iterator(); i.hasNext(); )
+        {
+            Artifact a = (Artifact) i.next();
+            String id = a.getId();
+            if ( artifacts.containsKey( id ) )
+            {
+                Artifact existing = (Artifact) artifacts.get( id );
+                boolean updateScope = false;
+                if ( Artifact.SCOPE_RUNTIME.equals( a.getScope() ) &&
+                    Artifact.SCOPE_TEST.equals( existing.getScope() ) )
+                {
+                    updateScope = true;
+                }
+
+                if ( Artifact.SCOPE_COMPILE.equals( a.getScope() ) &&
+                    !Artifact.SCOPE_COMPILE.equals( existing.getScope() ) )
+                {
+                    updateScope = true;
+                }
+
+                if ( updateScope )
+                {
+                    // TODO: Artifact factory?
+                    Artifact artifact = new DefaultArtifact( existing.getGroupId(), existing.getArtifactId(),
+                                                             existing.getVersion(), a.getScope(), existing.getType(),
+                                                             existing.getExtension() );
+                    artifacts.put( id, artifact );
+                }
+            }
+            else
+            {
+                artifacts.put( id, a );
+            }
+        }
+        setArtifacts( new HashSet( artifacts.values() ) );
+    }
