fix missing optional dependencies in .wtpmodules, cleanup test and introduce a test using MavenEmbedder (currently disabled due to a couple of issues, but it should replace the command line test)

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@330946 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.artifact.repository.ArtifactRepository;
+import org.apache.maven.artifact.resolver.ArtifactNotFoundException;
+import org.apache.maven.artifact.resolver.ArtifactResolutionException;
+import org.apache.maven.artifact.resolver.ArtifactResolver;
+    /**
+     * @todo MNG-1379 Wrong path for artifacts with system scope
+     * Artifacts with a system scope have a wrong path in mvn 2.0. This is a temporary workaround.
+     */
+    /**
+     * @todo MNG-1384 optional dependencies not resolved while compiling from a master project 
+     * Direct optional artifacts are not included in the list returned by project.getTestArtifacts()
+     * .classpath should include ANY direct dependency, and optional dependencies are required to compile
+     */
+    public static void fixMissingOptionalArtifacts(                                                   Collection artifacts, Collection depArtifacts, ArtifactRepository localRepository,
+                                                   ArtifactResolver artifactResolver, List remoteArtifactRepositories,Log log )
+    {
+        for ( Iterator it = depArtifacts.iterator(); it.hasNext(); )
+        {
+            Artifact artifact = (Artifact) it.next();
+            if ( artifact.isOptional() && !artifacts.contains( artifact ) )
+            {
+                try
+                {
+                    artifactResolver.resolve( artifact, remoteArtifactRepositories, localRepository );
+                }
+                catch ( ArtifactResolutionException e )
+                {
+                    log.error( "Unable to resolve optional artifact " + artifact.getId() );
+                    continue;
+                }
+                catch ( ArtifactNotFoundException e )
+                {
+                    log.error( "Unable to resolve optional artifact " + artifact.getId() );
+                    continue;
+                }
+                artifacts.add( artifact );
+            }
+        }
+    }
