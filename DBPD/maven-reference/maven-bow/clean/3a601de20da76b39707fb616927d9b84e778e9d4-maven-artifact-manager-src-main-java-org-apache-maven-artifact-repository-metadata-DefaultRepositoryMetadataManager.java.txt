- ensure we only blacklist a repository on resolve, not deploy
- fail if offline when attempting to deploy or retrieve essential metadata

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@307317 13f79535-47bb-0310-9956-ffa450edef68

-                        resolveAlways( metadata, repository, file, policy.getChecksumPolicy() );
+                        resolveAlways( metadata, repository, file, policy.getChecksumPolicy(), true );
-            getLogger().debug( "System is offline. Cannot resolve metadata:\n" + metadata.extendedToString() + "\n\n" );
-            return;
+            // metadata is required for deployment, can't be offline
+            throw new ArtifactMetadataRetrievalException(
+                "System is offline. Cannot resolve required metadata:\n" + metadata.extendedToString() );
-        resolveAlways( metadata, remoteRepository, file, ArtifactRepositoryPolicy.CHECKSUM_POLICY_WARN );
+        resolveAlways( metadata, remoteRepository, file, ArtifactRepositoryPolicy.CHECKSUM_POLICY_WARN, false );
-                                String checksumPolicy )
+                                String checksumPolicy, boolean allowBlacklisting )
+        throws ArtifactMetadataRetrievalException
-            getLogger().debug( "System is offline. Cannot resolve metadata:\n" + metadata.extendedToString() + "\n\n" );
-            return;
+            if ( !allowBlacklisting )
+            {
+                getLogger().debug(
+                    "System is offline. Cannot resolve metadata:\n" + metadata.extendedToString() + "\n\n" );
+                return;
+            }
+            else
+            {
+                // metadata is required for deployment, can't be offline
+                throw new ArtifactMetadataRetrievalException(
+                    "System is offline. Cannot resolve required metadata:\n" + metadata.extendedToString() );
+            }
-            repository.setBlacklisted( true );
+            repository.setBlacklisted( allowBlacklisting );
-            getLogger().warn( "System is offline. Cannot deploy metadata:\n" + metadata.extendedToString() + "\n\n" );
-            return;
+            // deployment shouldn't silently fail when offline
+            throw new ArtifactMetadataRetrievalException(
+                "System is offline. Cannot deploy metadata:\n" + metadata.extendedToString() );
-        resolveAlways( metadata, deploymentRepository, file, ArtifactRepositoryPolicy.CHECKSUM_POLICY_WARN );
+        resolveAlways( metadata, deploymentRepository, file, ArtifactRepositoryPolicy.CHECKSUM_POLICY_WARN, false );
