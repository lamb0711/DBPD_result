Use plugin realm to lookup plugin components - fixes custom lifecycle mappings

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@497491 13f79535-47bb-0310-9956-ffa450edef68

-    public Object getPluginComponent( Plugin plugin,
-                                      String role,
-                                      String roleHint )
+    public Object getPluginComponent( Plugin plugin, String role, String roleHint )
-        // XXX this needs the plugin realm!
-        return container.lookup( role, roleHint );
+        ClassRealm pluginRealm = pluginCollector.getPluginDescriptor( plugin ).getClassRealm();
+
+        if ( pluginRealm == null )
+        {
+            getLogger().warn( "getPluginComponent(" + plugin + ", " + role + "): descriptor is missing classRealm" );
+            pluginRealm = DefaultPlexusContainer.getLookupRealm();
+        }
+
+        return container.lookup( role, roleHint, pluginRealm );
-    public Map getPluginComponents( Plugin plugin,
-                                    String role )
+    public Map getPluginComponents( Plugin plugin, String role )
-        // XXX this needs the plugin realm!
-        return container.lookupMap( role );
+        ClassRealm pluginRealm = pluginCollector.getPluginDescriptor( plugin ).getClassRealm();
+
+        if ( pluginRealm == null )
+        {
+            getLogger().warn( "getPluginComponent(" + plugin + ", " + role + "): descriptor is missing classRealm" );
+            pluginRealm = DefaultPlexusContainer.getLookupRealm();
+        }
+
+        return container.lookupMap( role, pluginRealm );
