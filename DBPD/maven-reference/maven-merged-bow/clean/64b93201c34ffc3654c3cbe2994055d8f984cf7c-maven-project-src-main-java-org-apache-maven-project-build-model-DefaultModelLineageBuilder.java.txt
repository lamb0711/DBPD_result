Fixing it0103, which in this case had to do with when to use the relativePath to lookup the parent model from the project workspace.

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@644767 13f79535-47bb-0310-9956-ffa450edef68

-                                           boolean validProfilesXmlLocation )
+                                           boolean isReactorProject )
-            current = new ModelAndFile( readModel( pom ), pom, validProfilesXmlLocation );
+            current = new ModelAndFile( readModel( pom ), pom, isReactorProject );
-                                        allowStubs );
+                                        allowStubs,
+                                        isReactorProject );
-                                            boolean allowStubs )
+                                            boolean allowStubs,
+                                            boolean isReactorProject )
-                                    allowStubs );
+                                    allowStubs,
+                                    isReactorProject);
-                                        allowStubs );
+                                        allowStubs,
+                                        isReactorProject );
-        File projectDir = pomFile == null ? null : pomFile.getParentFile();
-
-                                               projectDir,
+                                               pomFile,
+     * @param childIsReactorProject
-                                           boolean allowStubs )
+                                           boolean allowStubs,
+                                           boolean childIsReactorProject )
-            getLogger().debug( "Checking cache for parent model-and-file instance: " + key );
-            result = projectWorkspace.getModelAndFile( modelParent.getGroupId(), modelParent.getArtifactId(), modelParent.getVersion() );
+            File parentPomFile = null;
+
+            if ( childIsReactorProject && modelPomFile != null )
+            {
+                getLogger().debug( "Attempting to locate parent model using relativePath and local filesystem; child is a reactor project." );
+
+                // if the child isn't a reactor project, don't resolve the parent from the local filesystem...use the repository.
+                String relativePath = modelParent.getRelativePath();
+                File modelDir = modelPomFile.getParentFile();
+
+                parentPomFile = new File( modelDir, relativePath );
+
+                if ( parentPomFile.isDirectory() )
+                {
+                    parentPomFile = new File( parentPomFile, "pom.xml" );
+                }
+
+                getLogger().debug( "Checking cache for parent model-and-file instance: " + key + " using file: " + parentPomFile );
+
+                result = projectWorkspace.getModelAndFile( parentPomFile );
+                if ( result != null && !parentModelMatches( modelParent, result.getModel() ) )
+                {
+                    result = null;
+                }
+            }
+
+            if ( result == null )
+            {
+                getLogger().debug( "Checking cache for parent model-and-file instance: " + key + " using project groupId:artifactId:version." );
+
+                result = projectWorkspace.getModelAndFile( modelParent.getGroupId(), modelParent.getArtifactId(), modelParent.getVersion() );
+            }
-            File parentPomFile = null;
-
-            if ( ( modelPomFile != null ) )
+            if ( parentPomFile != null && parentPomFile.exists() )
-                parentPomFile = resolveParentWithRelativePath( modelParent, modelPomFile );
+                Model parentModel = readModel( parentPomFile );
+                if ( !parentModelMatches( modelParent, parentModel ) )
+                {
+                    parentPomFile = null;
+                }
+    private boolean parentModelMatches( Parent modelParent, Model parentModel )
+    {
+
+        boolean groupsMatch = ( parentModel.getGroupId() == null )
+                              || parentModel.getGroupId().equals( modelParent.getGroupId() );
+        boolean versionsMatch = ( parentModel.getVersion() == null )
+                                || parentModel.getVersion().equals( modelParent.getVersion() );
+
+        if ( groupsMatch && !versionsMatch
+             && parentModel.getArtifactId().equals( modelParent.getArtifactId() ) )
+        {
+            return true;
+        }
+
+        return false;
+    }
+
-    private File resolveParentWithRelativePath( Parent modelParent,
-                                                File modelPomFile )
-        throws ProjectBuildingException
-    {
-        String relativePath = modelParent.getRelativePath();
-        File modelDir = modelPomFile.getParentFile();
-
-        File parentPomFile = new File( modelDir, relativePath );
-
-        if ( parentPomFile.isDirectory() )
-        {
-//            getLogger().debug( "Parent relative-path is a directory; assuming \'pom.xml\' file exists within." );
-            parentPomFile = new File( parentPomFile, "pom.xml" );
-        }
-
-//        getLogger().debug( "Looking for parent: " + modelParent.getId() + " in: " + parentPomFile );
-
-        if ( parentPomFile.exists() )
-        {
-            Model parentModel = readModel( parentPomFile );
-
-            boolean groupsMatch = ( parentModel.getGroupId() == null )
-                                  || parentModel.getGroupId().equals( modelParent.getGroupId() );
-            boolean versionsMatch = ( parentModel.getVersion() == null )
-                                    || parentModel.getVersion().equals( modelParent.getVersion() );
-
-            if ( groupsMatch && versionsMatch
-                 && parentModel.getArtifactId().equals( modelParent.getArtifactId() ) )
-            {
-                return parentPomFile;
-            }
-        }
-
-        return null;
-    }
-

MOV31 INS44 INS44 INS39 UPD42 MOV8 UPD42 INS39 INS42 INS65 INS39 INS42 UPD43 UPD42 INS41 INS42 MOV60 UPD42 INS9 INS25 INS25 INS38 INS42 INS27 INS8 INS27 INS8 INS27 INS42 INS9 INS42 MOV27 INS21 MOV60 MOV60 INS21 MOV25 MOV21 INS21 INS25 INS42 INS33 INS21 MOV21 INS27 MOV32 MOV60 INS25 UPD42 INS42 INS42 INS32 INS7 INS7 INS27 INS8 INS32 INS42 INS33 INS38 INS8 UPD42 MOV32 INS42 INS45 INS42 MOV14 INS32 INS42 INS32 INS27 INS38 INS21 INS32 INS42 INS27 INS32 INS21 INS42 INS45 INS42 INS42 INS42 INS42 INS42 INS33 INS32 INS7 INS42 INS45 INS42 INS45 UPD42 MOV42 MOV42 UPD42 MOV42 INS7 INS42 INS42 INS32 INS42 INS33 INS42 INS33 INS42 INS42 DEL42 DEL43 DEL42 DEL42 DEL33 DEL27 DEL33 DEL42 DEL42 DEL32 DEL16 DEL59 DEL60 DEL36 DEL42 DEL32 DEL7 DEL21 DEL42 DEL43 DEL42 DEL42 DEL42 DEL43 DEL42 DEL43 DEL42 DEL59 DEL60 DEL25 DEL33 DEL41 DEL8