o changing the strategy for downloading to make File.renameTo workable.


git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@162964 13f79535-47bb-0310-9956-ffa450edef68

+import org.codehaus.plexus.util.FileUtils;
+import java.io.IOException;
-            temp = File.createTempFile( "wagon", "tmp" );
+            temp = new File( destination + ".tmp" );
-
-                transfered = true;
-
+
+                continue;
-        }
-        if ( transfered )
-        {
-            transfered = temp.renameTo( destination );
+            // The temporary file is named destination + ".tmp" and is done this way to ensure
+            // that the temporary file is in the same file system as the destination because the
+            // File.renameTo operation doesn't really work across file systems. So we will attempt
+            // to do a File.renameTo for efficiency and atomicity, if this fails then we will use
+            // a brute force copy and delete the temporary file.
+
+            if ( !temp.renameTo( destination ) )
+            {
+                try
+                {
+                    FileUtils.copyFile( temp, destination );
+
+                    temp.delete();
+                }
+                catch ( IOException e )
+                {
+                    throw new TransferFailedException( "Error copying temporary file to the final destination: ", e );
+                }
+            }
-        else
-        {
-            temp.delete();
-            throw new TransferFailedException( "Resource doesn't exist in any remote repository" );
-        }
+        throw new TransferFailedException( "Resource doesn't exist in any remote repository" );

INS26 INS26 INS40 INS40 MOV53 MOV25 INS25 INS41 INS38 INS8 INS14 MOV32 INS54 INS43 INS27 INS18 INS8 INS12 INS42 INS42 INS45 INS21 MOV21 INS44 INS8 INS32 INS43 INS42 INS53 INS42 INS42 INS42 INS42 INS42 INS14 INS43 INS45 INS42 INS42 DEL42 DEL42 DEL45 DEL45 DEL32 DEL42 DEL9 DEL7 DEL21 DEL42 DEL42 DEL7 DEL21 DEL41 DEL8 DEL8 DEL25