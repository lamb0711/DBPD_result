[MNG-4990] RepositorySystem#resolve(request) uses two different local repositories

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@1073928 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.maven.artifact.repository.layout.DefaultRepositoryLayout;
+import org.sonatype.aether.util.DefaultRepositorySystemSession;
+import org.sonatype.aether.util.FilterRepositorySystemSession;
-    public static LocalRepositoryManager wrap( ArtifactRepository repository, RepositorySystem system )
+    public static RepositorySystemSession overlay( ArtifactRepository repository, RepositorySystemSession session,
+                                                   RepositorySystem system )
-        ArtifactRepositoryLayout layout = repository.getLayout();
-        if ( layout != null && layout.getClass().equals( DefaultRepositoryLayout.class ) )
+        if ( repository == null || repository.getBasedir() == null )
-            // map the default layout to the default impl of the repo system
-            return system.newLocalRepositoryManager( new LocalRepository( repository.getBasedir() ) );
+            return session;
-        return new LegacyLocalRepositoryManager( repository );
+        if ( session != null )
+        {
+            LocalRepositoryManager lrm = session.getLocalRepositoryManager();
+            if ( lrm != null && lrm.getRepository().getBasedir().equals( new File( repository.getBasedir() ) ) )
+            {
+                return session;
+            }
+        }
+        else
+        {
+            session = new DefaultRepositorySystemSession();
+        }
+
+        final LocalRepositoryManager llrm = new LegacyLocalRepositoryManager( repository );
+
+        return new FilterRepositorySystemSession( session )
+        {
+            @Override
+            public LocalRepositoryManager getLocalRepositoryManager()
+            {
+                return llrm;
+            }
+        };

MOV26 INS26 UPD40 INS40 INS43 INS42 INS44 INS8 INS42 INS43 INS42 INS25 INS25 INS60 INS41 UPD42 MOV42 INS27 INS8 INS27 MOV8 INS8 INS83 MOV43 INS59 INS14 INS27 INS27 INS41 UPD42 MOV42 MOV33 INS60 INS25 INS21 INS42 MOV14 INS43 INS42 INS1 INS42 INS33 INS32 INS33 INS42 INS43 INS59 INS27 INS8 INS7 INS42 INS31 MOV42 UPD42 MOV42 INS42 INS42 INS32 INS27 MOV32 MOV41 INS42 INS14 INS78 INS83 INS43 INS42 INS8 INS42 INS42 INS42 INS33 INS32 INS42 INS42 INS43 INS42 UPD42 MOV42 MOV41 INS32 INS42 UPD43 INS42 INS42 UPD42 MOV42 UPD42 MOV42 UPD42 DEL42 DEL43 DEL42 DEL32 DEL59 DEL60 DEL27 DEL42 DEL42 DEL32 DEL42 DEL43 DEL57 DEL32 DEL27 DEL25 DEL8