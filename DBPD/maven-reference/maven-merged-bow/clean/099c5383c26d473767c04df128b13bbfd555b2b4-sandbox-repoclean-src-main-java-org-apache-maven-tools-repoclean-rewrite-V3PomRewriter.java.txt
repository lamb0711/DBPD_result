o Refactored RepositoryCleaner to use DiscoveryPhase and RewritePhase.
o Added the ability to read a pom and figure out whether it's a v4 pom (based on presence of modelVersion)
o Added a more accurate counter for artifacts that are actually rewritten successfully, rather than just the ones that enter the rewriting process.
o Probably need to add the phases still...


git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@169041 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.maven.tools.repoclean.report.FileReporter;
+import org.apache.maven.tools.repoclean.report.Reporter;
-import org.codehaus.plexus.util.IOUtil;
-import java.io.File;
-import java.io.FileReader;
-import java.io.FileWriter;
+import java.io.Reader;
+import java.io.Writer;
-public class V3PomRewriter implements ArtifactPomRewriter
+public class V3PomRewriter
+    implements ArtifactPomRewriter
-    public void rewrite( Artifact artifact, File from, File to, FileReporter reporter, boolean reportOnly )
+    public void rewrite( Artifact artifact, Reader from, Writer to, Reporter reporter, boolean reportOnly )
-        if ( from.exists() )
+        if( from != null )
-            FileReader fromReader = null;
+            org.apache.maven.model.v3_0_0.Model v3Model = null;
-                org.apache.maven.model.v3_0_0.Model v3Model = null;
-                try
-                {
-                    fromReader = new FileReader( from );
+                MavenXpp3Reader v3Reader = new MavenXpp3Reader();
-                    MavenXpp3Reader v3Reader = new MavenXpp3Reader();
-
-                    v3Model = v3Reader.read( fromReader );
-                }
-                catch ( Exception e )
-                {
-                    reporter.error( "Invalid v3 POM at: \'" + from + "\'. Cannot read.", e );
-
-                    throw e;
-                }
-
-                if ( v3Model != null )
-                {
-                    v4Model = translator.translate( v3Model, reporter );
-                }
+                v3Model = v3Reader.read( from );
-            finally
+            catch ( Exception e )
-                IOUtil.close( fromReader );
+                reporter.error( "Invalid v3 POM at: \'" + from + "\'. Cannot read.", e );
+
+                throw e;
+            }
+            
+            if ( v3Model != null )
+            {
+                v4Model = translator.translate( v3Model, reporter );
-            reporter.warn( "POM for artifact[" + artifact.getId() +
-                           "] does not exist in source repository. We will create a skeletal one here." );
-
-                File toParent = to.getParentFile();
-                if ( !toParent.exists() )
-                {
-                    toParent.mkdirs();
-                }
-
-                FileWriter toWriter = null;
-                try
-                {
-                    toWriter = new FileWriter( to );
-                    MavenXpp3Writer v4Writer = new MavenXpp3Writer();
-                    v4Writer.write( toWriter, v4Model );
-                }
-                finally
-                {
-                    IOUtil.close( toWriter );
-                }
+                MavenXpp3Writer v4Writer = new MavenXpp3Writer();
+                v4Writer.write( to, v4Model );
-    private void validateV4Basics( Model model, Artifact artifact, FileReporter reporter )
+    private void validateV4Basics( Model model, Artifact artifact, Reporter reporter )

UPD40 UPD40 UPD40 MOV8 UPD43 UPD43 UPD43 MOV60 INS25 INS25 UPD43 UPD42 UPD42 UPD42 INS27 MOV8 INS8 MOV27 INS8 UPD42 INS42 INS33 MOV21 MOV21 INS25 MOV38 INS8 MOV60 MOV21 MOV59 MOV42 MOV14 UPD42 UPD42 UPD42 INS42 UPD42 DEL40 DEL26 DEL40 DEL26 DEL42 DEL42 DEL43 DEL42 DEL14 DEL7 DEL21 DEL33 DEL8 DEL54 DEL42 DEL42 DEL32 DEL42 DEL42 DEL45 DEL42 DEL42 DEL32 DEL45 DEL27 DEL32 DEL21 DEL8 DEL25 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL32 DEL38 DEL42 DEL42 DEL32 DEL21 DEL8 DEL25 DEL42 DEL43 DEL42 DEL33 DEL59 DEL60 DEL42 DEL42 DEL43 DEL42 DEL14 DEL7 DEL21 DEL42 DEL42 DEL42 DEL42 DEL32 DEL21 DEL8 DEL42 DEL42 DEL42 DEL32 DEL21 DEL8 DEL54 DEL8 DEL25 DEL8 DEL25 DEL8