MNG-4866 use intermediate array to make sure we can purge all inherited MavenSession instances

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@1022613 13f79535-47bb-0310-9956-ffa450edef68

-    private ThreadLocal<MavenSession> session = new InheritableThreadLocal<MavenSession>();
+    private static final ThreadLocal<MavenSession[]> session = new InheritableThreadLocal<MavenSession[]>();
-            this.session.remove();
+            MavenSession[] oldSession = DefaultLegacySupport.session.get();
+            if ( oldSession != null )
+            {
+                oldSession[0] = null;
+                DefaultLegacySupport.session.remove();
+            }
-            this.session.set( session );
+            DefaultLegacySupport.session.set( new MavenSession[] { session } );
-        return session.get();
+        MavenSession[] currentSession = DefaultLegacySupport.session.get();
+        return currentSession != null ? currentSession[0] : null;

INS83 INS83 UPD74 INS5 INS60 INS41 MOV43 INS85 UPD74 INS8 INS5 INS59 INS16 INS5 INS60 INS25 INS43 INS85 INS42 INS32 INS27 INS2 INS33 MOV43 INS85 INS5 INS59 INS27 MOV8 INS42 INS40 MOV42 INS42 INS33 INS42 INS34 INS43 INS85 INS42 INS32 INS42 INS33 INS21 INS40 INS42 INS3 INS42 INS40 INS42 INS7 INS5 INS4 INS2 INS33 INS40 INS43 INS85 INS42 INS42 INS34 INS42 DEL52 DEL42 DEL22 DEL52 DEL42 DEL22 DEL42 DEL42 DEL42 DEL32 DEL41