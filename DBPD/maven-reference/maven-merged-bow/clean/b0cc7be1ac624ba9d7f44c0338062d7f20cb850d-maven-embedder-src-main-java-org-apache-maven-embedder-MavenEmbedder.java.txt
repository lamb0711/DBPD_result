Improving the use of project sessions in the embedder, and exporting control over the project session map to the embedder instead of Maven.execute().

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@588144 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.execution.MavenProjectSession;
-        MavenSession session = new MavenSession( container, request, null, null, new HashMap() );
+        MavenSession session = new MavenSession( container, request, null, null, projectSessions );
-        try
-        {
-        }
-        finally
-        {
-            session.dispose();
-        }
-        extensionScanner.scanForBuildExtensions( mavenProject, request.getLocalRepository(), request.getProfileManager(), new HashMap() );
+        extensionScanner.scanForBuildExtensions( mavenProject, request.getLocalRepository(), request.getProfileManager(), projectSessions );
-            //TODO: ok this is crappy, now there are active collections so when new artifact handlers 
+            //TODO: ok this is crappy, now there are active collections so when new artifact handlers
-        ReactorManager reactorManager = maven.createReactorManager( request, result, new HashMap() );
+        ReactorManager reactorManager = maven.createReactorManager( request, result, projectSessions );
+    private Map projectSessions;
+
+    public void clearProjectSessions()
+    {
+        if ( ( projectSessions != null ) && !projectSessions.isEmpty() )
+        {
+            for ( Iterator it = projectSessions.values().iterator(); it.hasNext(); )
+            {
+                MavenProjectSession session = (MavenProjectSession) it.next();
+                session.dispose();
+            }
+
+            projectSessions.clear();
+        }
+    }
+
+        projectSessions = new HashMap();
+
-            ContainerConfiguration cc = new DefaultContainerConfiguration()                
-                .addComponentDiscoverer( new MavenPluginDiscoverer() )                
+            ContainerConfiguration cc = new DefaultContainerConfiguration()
+                .addComponentDiscoverer( new MavenPluginDiscoverer() )
-            return maven.execute( request );
+            return maven.execute( request, projectSessions );

INS26 INS40 INS23 INS31 INS83 INS43 INS59 INS83 INS39 INS42 INS8 MOV21 INS42 INS42 INS25 INS21 MOV43 INS27 INS8 INS7 INS42 INS36 INS38 INS24 INS21 INS42 MOV14 MOV43 INS42 INS42 INS27 INS32 INS58 INS32 INS8 INS32 INS42 INS33 INS42 INS42 INS43 INS59 INS42 INS42 INS60 MOV21 INS42 INS42 INS42 INS42 INS42 INS32 INS43 INS59 INS32 INS42 INS42 INS42 INS11 INS42 INS42 INS43 INS32 INS42 INS42 INS42 DEL42 DEL43 DEL14 DEL8 DEL8 DEL54 DEL42 DEL43 DEL14