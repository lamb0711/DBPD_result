o adjusting the internals to deal with root-based resolution
o gross hack to work around someone hardcoding a dummy:dummy root artifact in the surefire plugin



git-svn-id: https://svn.apache.org/repos/asf/maven/components/branches/MNG-2766@756885 13f79535-47bb-0310-9956-ffa450edef68

- * Licensed to the Apache Software Foundation (ASF) under one
- * or more contributor license agreements.  See the NOTICE file
- * distributed with this work for additional information
- * regarding copyright ownership.  The ASF licenses this file
- * to you under the Apache License, Version 2.0 (the
- * "License"); you may not use this file except in compliance
- * with the License.  You may obtain a copy of the License at
- *
- *  http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing,
- * software distributed under the License is distributed on an
- * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
- * KIND, either express or implied.  See the License for the
- * specific language governing permissions and limitations
- * under the License.
+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license
+ * agreements. See the NOTICE file distributed with this work for additional information regarding
+ * copyright ownership. The ASF licenses this file to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance with the License. You may obtain a
+ * copy of the License at
+ * 
+ * http://www.apache.org/licenses/LICENSE-2.0
+ * 
+ * Unless required by applicable law or agreed to in writing, software distributed under the License
+ * is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
+ * or implied. See the License for the specific language governing permissions and limitations under
+ * the License.
-@Component(role=WagonManager.class)
+@Component(role = WagonManager.class)
-    private static final String[] CHECKSUM_IDS = {"md5", "sha1"};
+    private static final String[] CHECKSUM_IDS = { "md5", "sha1" };
-    private static final String[] CHECKSUM_ALGORITHMS = {"MD5", "SHA-1"};
+    private static final String[] CHECKSUM_ALGORITHMS = { "MD5", "SHA-1" };
-    
+
-    private Map<String,ProxyInfo> proxies = new HashMap<String,ProxyInfo>();
+    private Map<String, ProxyInfo> proxies = new HashMap<String, ProxyInfo>();
-    private static Map<String,AuthenticationInfo> authenticationInfoMap = new HashMap<String,AuthenticationInfo>();
+    private static Map<String, AuthenticationInfo> authenticationInfoMap = new HashMap<String, AuthenticationInfo>();
-    private Map<String,RepositoryPermissions> serverPermissionsMap = new HashMap<String,RepositoryPermissions>();
+    private Map<String, RepositoryPermissions> serverPermissionsMap = new HashMap<String, RepositoryPermissions>();
-    private Map<String,ArtifactRepository> mirrors = new LinkedHashMap<String,ArtifactRepository>();
+    private Map<String, ArtifactRepository> mirrors = new LinkedHashMap<String, ArtifactRepository>();
-    private Map<String,XmlPlexusConfiguration> serverConfigurationMap = new HashMap<String,XmlPlexusConfiguration>();
+    private Map<String, XmlPlexusConfiguration> serverConfigurationMap = new HashMap<String, XmlPlexusConfiguration>();
-    @Requirement(role=Wagon.class)
+    @Requirement(role = Wagon.class)
-    
+
-        this.downloadMonitor = downloadMonitor;        
+        this.downloadMonitor = downloadMonitor;
-    
+
-        
-        
-            throw new UnsupportedProtocolException(
-                "Cannot find wagon which supports the requested protocol: " + protocol );
+            throw new UnsupportedProtocolException( "Cannot find wagon which supports the requested protocol: " + protocol );
-    
+
-        Map<String,ChecksumObserver> checksums = new HashMap<String,ChecksumObserver>( 2 );
+        Map<String, ChecksumObserver> checksums = new HashMap<String, ChecksumObserver>( 2 );
-        Map<String,String> sums = new HashMap<String,String>( 2 );
+        Map<String, String> sums = new HashMap<String, String>( 2 );
-                AuthenticationInfo authenticationInfo = getAuthenticationInfo( repository.getId() ); 
-                                
+                AuthenticationInfo authenticationInfo = getAuthenticationInfo( repository.getId() );
+
-                });
+                } );
-            for (String extension : checksums.keySet()) {
-                ChecksumObserver observer = checksums.get(extension);
-                sums.put(extension, observer.getActualChecksum());
+            for ( String extension : checksums.keySet() )
+            {
+                ChecksumObserver observer = checksums.get( extension );
+                sums.put( extension, observer.getActualChecksum() );
-            for (String extension : checksums.keySet()) {
+            for ( String extension : checksums.keySet() )
+            {
-                File temp = File.createTempFile("maven-artifact", null);
+                File temp = File.createTempFile( "maven-artifact", null );
-                FileUtils.fileWrite(temp.getAbsolutePath(), "UTF-8", sums.get(extension));
+                FileUtils.fileWrite( temp.getAbsolutePath(), "UTF-8", sums.get( extension ) );
-                wagon.put(temp, remotePath + "." + extension);
+                wagon.put( temp, remotePath + "." + extension );
-            for (String aCHECKSUM_IDS : CHECKSUM_IDS) {
-                TransferListener checksumListener = checksums.get(aCHECKSUM_IDS);
-                if (checksumListener != null) {
-                    wagon.removeTransferListener(checksumListener);
+            for ( String aCHECKSUM_IDS : CHECKSUM_IDS )
+            {
+                TransferListener checksumListener = checksums.get( aCHECKSUM_IDS );
+                if ( checksumListener != null )
+                {
+                    wagon.removeTransferListener( checksumListener );
-    private ChecksumObserver addChecksumObserver( Wagon wagon,
-                                                  String algorithm )
+    private ChecksumObserver addChecksumObserver( Wagon wagon, String algorithm )
-
-    throws TransferFailedException, ResourceDoesNotExistException
+        throws TransferFailedException, ResourceDoesNotExistException
-    
+
-    
-    public void getArtifact( Artifact artifact, List<ArtifactRepository> remoteRepositories, TransferListener downloadMonitor  )
+
+    public void getArtifact( Artifact artifact, List<ArtifactRepository> remoteRepositories, TransferListener downloadMonitor )
-	{
-    	getArtifact( artifact, remoteRepositories, downloadMonitor, true );
-	}
+    {
+        getArtifact( artifact, remoteRepositories, downloadMonitor, true );
+    }
-        for (ArtifactRepository repository : remoteRepositories) {
+        for ( ArtifactRepository repository : remoteRepositories )
+        {
-                if (artifact.isResolved())
+                if ( artifact.isResolved() )
-                	break;
+                    break;
-                logger.debug( "Unable to get resource '" + artifact.getId() + "' from repository " +
-                    repository.getId() + " (" + repository.getUrl() + ")", e );
+                logger.debug( "Unable to get resource '" + artifact.getId() + "' from repository " + repository.getId() + " (" + repository.getUrl() + ")", e );
-                logger.debug( "Unable to get resource '" + artifact.getId() + "' from repository " +
-                    repository.getId() + " (" + repository.getUrl() + ")", e );
+                logger.debug( "Unable to get resource '" + artifact.getId() + "' from repository " + repository.getId() + " (" + repository.getUrl() + ")", e );
-        throws TransferFailedException,
-               ResourceDoesNotExistException
+        throws TransferFailedException, ResourceDoesNotExistException
-            	updateCheckManager.touch( artifact, repository );
+                updateCheckManager.touch( artifact, repository );
-                    
+
-        
+
-    public void getArtifactMetadata( ArtifactMetadata metadata,
-                                     ArtifactRepository repository,
-                                     File destination,
-                                     String checksumPolicy )
+    public void getArtifactMetadata( ArtifactMetadata metadata, ArtifactRepository repository, File destination, String checksumPolicy )
-    public void getArtifactMetadataFromDeploymentRepository( ArtifactMetadata metadata, ArtifactRepository repository,
-                                                             File destination, String checksumPolicy )
+    public void getArtifactMetadataFromDeploymentRepository( ArtifactMetadata metadata, ArtifactRepository repository, File destination, String checksumPolicy )
-    private void getRemoteFile( ArtifactRepository repository,
-                                File destination,
-                                String remotePath,
-                                TransferListener downloadMonitor,
-                                String checksumPolicy,
-                                boolean force )
+    private void getRemoteFile( ArtifactRepository repository, File destination, String remotePath, TransferListener downloadMonitor, String checksumPolicy, boolean force )
-            wagon.connect( new Repository( repository.getId(), repository.getUrl() ),
-                           getAuthenticationInfo( repository.getId() ), new ProxyInfoProvider()
+            wagon.connect( new Repository( repository.getId(), repository.getUrl() ), getAuthenticationInfo( repository.getId() ), new ProxyInfoProvider()
-            });
+            } );
-                            handleChecksumFailure( checksumPolicy, "Error retrieving checksum file for " + remotePath,
-                                md5TryException );
+                            handleChecksumFailure( checksumPolicy, "Error retrieving checksum file for " + remotePath, md5TryException );
-                    throw new TransferFailedException(
-                        "Error copying temporary file to the final destination: " + e.getMessage(), e );
+                    throw new TransferFailedException( "Error copying temporary file to the final destination: " + e.getMessage(), e );
-    private void handleChecksumFailure( String checksumPolicy,
-                                        String message,
-                                        Throwable cause )
+    private void handleChecksumFailure( String checksumPolicy, String message, Throwable cause )
-    private void verifyChecksum( ChecksumObserver checksumObserver,
-                                 File destination,
-                                 File tempDestination,
-                                 String remotePath,
-                                 String checksumFileExtension,
-                                 Wagon wagon )
+    private void verifyChecksum( ChecksumObserver checksumObserver, File destination, File tempDestination, String remotePath, String checksumFileExtension, Wagon wagon )
-            if ( expectedChecksum.regionMatches( true, 0, "MD", 0, 2 )
-                || expectedChecksum.regionMatches( true, 0, "SHA", 0, 3 ) )
+            if ( expectedChecksum.regionMatches( true, 0, "MD", 0, 2 ) || expectedChecksum.regionMatches( true, 0, "SHA", 0, 3 ) )
-                throw new ChecksumFailedException( "Checksum failed on download: local = '" + actualChecksum +
-                    "'; remote = '" + expectedChecksum + "'" );
+                throw new ChecksumFailedException( "Checksum failed on download: local = '" + actualChecksum + "'; remote = '" + expectedChecksum + "'" );
-
-    private void releaseWagon( String protocol,
-                               Wagon wagon )
+    private void releaseWagon( String protocol, Wagon wagon )
-    
+
-     *
+     * 
-            return !( url.getHost().equals( "localhost" ) || url.getHost().equals( "127.0.0.1" ) || url.getProtocol().equals("file" ) );
+            return !( url.getHost().equals( "localhost" ) || url.getHost().equals( "127.0.0.1" ) || url.getProtocol().equals( "file" ) );
-     *
+     * 
-     * @param nonProxyHosts the set of hosts not to use the proxy for. Follows Java system property format:
-     *            <code>*.foo.com|localhost</code>.
+     * @param nonProxyHosts the set of hosts not to use the proxy for. Follows Java system property
+     *            format: <code>*.foo.com|localhost</code>.
-    public void addProxy( String protocol,
-                          String host,
-                          int port,
-                          String username,
-                          String password,
-                          String nonProxyHosts )
+    public void addProxy( String protocol, String host, int port, String username, String password, String nonProxyHosts )
-    public void addAuthenticationInfo( String repositoryId,
-                                       String username,
-                                       String password,
-                                       String privateKey,
-                                       String passphrase
-    )
+    public void addAuthenticationInfo( String repositoryId, String username, String password, String privateKey, String passphrase )
-    public void addPermissionInfo( String repositoryId,
-                                   String filePermissions,
-                                   String directoryPermissions )
+    public void addPermissionInfo( String repositoryId, String filePermissions, String directoryPermissions )
-     *
-     * @param wagon      the wagon to configure
+     * 
+     * @param wagon the wagon to configure
-     * @throws WagonConfigurationException wraps any error given during configuration of the wagon instance
+     * @throws WagonConfigurationException wraps any error given during configuration of the wagon
+     *             instance
-        PlexusConfiguration config = (PlexusConfiguration) serverConfigurationMap.get( repositoryId ); 
-        
+        PlexusConfiguration config = (PlexusConfiguration) serverConfigurationMap.get( repositoryId );
+
-    
+
-    
+

UPD66 UPD66 UPD66 UPD66 INS66