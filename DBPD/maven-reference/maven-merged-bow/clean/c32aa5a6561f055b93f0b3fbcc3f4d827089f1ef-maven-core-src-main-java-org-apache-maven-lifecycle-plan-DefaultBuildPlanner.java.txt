Fixing unit test problems from it0103 fix, and fixing it0042...just 4 more failing ITs before this is back on its feet.

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@645015 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.HashSet;
+import java.util.Set;
-            plan = constructBuildPlan( Collections.EMPTY_LIST, project, session );
+            plan = constructBuildPlan( Collections.EMPTY_LIST, project, session, true );
-    public BuildPlan constructBuildPlan( final List tasks,
-                                         final MavenProject project,
-                                         final MavenSession session )
+    public BuildPlan constructBuildPlan( List tasks,
+                                         MavenProject project,
+                                         MavenSession session,
+                                         boolean allowUnbindableMojos )
+        boolean pluginResolutionAttempted = false;
+
-            LifecycleBindings projectBindings = lifecycleBindingManager.getProjectCustomBindings( project,
-                                                                                                  session );
-            plan = new BuildPlan( packagingBindings, projectBindings, defaultBindings, tasks );
+            Set unbindableMojos = new HashSet();
+            LifecycleBindings projectBindings = lifecycleBindingManager.getProjectCustomBindings( project,
+                                                                                                  session,
+                                                                                                  unbindableMojos );
+
+            plan = new BuildPlan( packagingBindings, projectBindings, defaultBindings, unbindableMojos, tasks );
+            pluginResolutionAttempted = true;
+        }
+
+        if ( ( !pluginResolutionAttempted || !allowUnbindableMojos ) && plan.hasUnbindableMojos() )
+        {
+            lifecycleBindingManager.resolveUnbindableMojos( plan.getUnbindableMojos(), project, session, plan.getLifecycleBindings() );
+            plan.clearUnbindableMojos();
-        addForkedLifecycleModifiers( plan, project, session, new LinkedList() );
-        addReportingLifecycleModifiers( plan, project, session, new LinkedList() );
+        addForkedLifecycleModifiers( plan, project, session, new LinkedList(), allowUnbindableMojos );
+        addReportingLifecycleModifiers( plan, project, session, new LinkedList(), allowUnbindableMojos );
-                                              MavenSession session,
-                                              LinkedList callStack )
+                                              final MavenSession session,
+                                              LinkedList callStack,
+                                              final boolean allowUnbindableMojos )
-                findForkModifiers( mojoBinding, plan, project, session, callStack );
+                findForkModifiers( mojoBinding, plan, project, session, callStack, allowUnbindableMojos );
-                                    LinkedList callStack )
+                                    LinkedList callStack,
+                                    final boolean allowUnbindableMojos )
-                                                                  session );
+                                                                  session,
+                                                                  allowUnbindableMojos );
-        findForkModifiers( mojoBinding, pluginDescriptor, plan, project, session, false, callStack );
+        findForkModifiers( mojoBinding, pluginDescriptor, plan, project, session, callStack, false, allowUnbindableMojos );
-     * @param callStack
-     * @param session
-                                                 MavenSession session,
-                                                 LinkedList callStack )
+                                                 final MavenSession session,
+                                                 LinkedList callStack,
+                                                 final boolean allowUnbindableMojos )
-                                                                      session );
+                                                                      session,
+                                                                      allowUnbindableMojos );
-                                                                    session );
+                                                                    session,
+                                                                    allowUnbindableMojos );
+                                               callStack,
-                                               callStack );
+                                               allowUnbindableMojos );
-                                                   final MavenSession session )
+                                                   final MavenSession session,
+                                                   final boolean allowUnbindableMojos )
+        throws LifecyclePlannerException
-            String message = "Failed to load plugin: "
-                             + MojoBindingUtils.createPluginKey( mojoBinding )
-                             + ". Adding to late-bound plugins list.\nReason: " + e.getMessage();
-
-            if ( logger.isDebugEnabled() )
+            if ( allowUnbindableMojos )
-                logger.debug( message, e );
+                String message = "Failed to load plugin: "
+                + MojoBindingUtils.createPluginKey( mojoBinding )
+                + ". Adding to late-bound plugins list.\nReason: " + e.getMessage();
+
+                if ( logger.isDebugEnabled() )
+                {
+                    logger.debug( message, e );
+                }
+                else
+                {
+                    logger.warn( message );
+                }
+
+                plan.addUnbindableMojo( mojoBinding );
-                logger.warn( message );
+                throw new LifecyclePlannerException( "Failed to resolve plugin for mojo binding: " + MojoBindingUtils.toString( mojoBinding ), e );
-
-            mojoBinding.setLateBound( true );
+                                    LinkedList callStack,
-                                    LinkedList callStack )
+                                    final boolean allowUnbindableMojos )
+                                  callStack,
-                                  callStack );
+                                  allowUnbindableMojos );
+                                       LinkedList callStack,
-                                       LinkedList callStack )
+                                       final boolean allowUnbindableMojos )
-            addForkedLifecycleModifiers( clonedPlan, project, session, callStack );
+            addForkedLifecycleModifiers( clonedPlan, project, session, callStack, allowUnbindableMojos );

INS26 INS26 INS40 INS40 MOV44 MOV44 MOV44 INS44 INS44 MOV44 INS44 INS44 INS44 INS43 INS44 INS44 MOV43 MOV42 INS39 INS42 INS60 INS25 INS83 INS39 INS42 INS83 INS39 INS42 INS83 INS83 INS39 INS42 INS83 INS39 INS42 INS42 INS83 INS39 INS42 INS83 INS39 INS42 INS39 INS59 INS27 INS8 INS42 INS9 INS60 INS21 INS36 INS32 INS21 INS21 MOV14 INS42 MOV14 INS42 INS42 UPD42 INS8 INS43 INS59 INS7 INS27 INS42 INS42 INS32 INS32 INS42 MOV43 INS25 INS42 INS42 INS14 INS42 INS9 INS38 INS38 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS42 MOV8 INS8 INS42 INS9 INS43 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS53 INS42 UPD42 INS42 INS42 INS14 INS42 UPD42 UPD42 INS43 INS27 INS42 INS42 INS45 INS32 MOV43 INS42 INS42 INS42 INS42 INS42 UPD42 DEL83 DEL83 DEL42 DEL65 DEL42 DEL65 DEL9