Merge branch 'master' of https://git-wip-us.apache.org/repos/asf/maven into trunk

+import java.util.concurrent.atomic.AtomicReference;
+
-    private static final ThreadLocal<MavenSession[]> session = new InheritableThreadLocal<MavenSession[]>();
+    private static final ThreadLocal<AtomicReference<MavenSession>> SESSION = new InheritableThreadLocal<AtomicReference<MavenSession>>();
-        if ( session == null )
+        AtomicReference<MavenSession> reference = DefaultLegacySupport.SESSION.get();
+        if ( reference != null )
-            MavenSession[] oldSession = DefaultLegacySupport.session.get();
-            if ( oldSession != null )
-            {
-                oldSession[0] = null;
-                DefaultLegacySupport.session.remove();
-            }
+            reference.set( null );
+        }
+
+        if ( session == null && reference != null )
+        {
+            DefaultLegacySupport.SESSION.remove();
-            DefaultLegacySupport.session.set( new MavenSession[] { session } );
+            DefaultLegacySupport.SESSION.set( new AtomicReference<MavenSession>( session ) );
-        MavenSession[] currentSession = DefaultLegacySupport.session.get();
-        return currentSession != null ? currentSession[0] : null;
+        AtomicReference<MavenSession> currentSession = DefaultLegacySupport.SESSION.get();
+        return currentSession != null ? currentSession.get() : null;

INS26 INS40 UPD74 INS74 UPD42 MOV60 INS25 INS25 INS43 MOV43 UPD74 INS74 MOV27 INS8 INS27 INS8 MOV8 INS74 INS42 INS74 INS43 MOV43 UPD42 UPD42 MOV21 MOV27 INS27 MOV21 INS43 MOV43 INS32 INS43 MOV43 INS42 UPD40 INS32 INS42 INS33 INS42 UPD40 INS42 INS42 INS42 INS42 INS42 INS33 UPD40 UPD40 INS14 INS74 INS42 INS43 MOV43 INS42 DEL85 DEL5 DEL85 DEL5 DEL85 DEL5 DEL42 DEL34 DEL2 DEL33 DEL7 DEL85 DEL5 DEL42 DEL4 DEL3 DEL8 DEL25 DEL8 DEL25 DEL85 DEL5 DEL42 DEL34 DEL2