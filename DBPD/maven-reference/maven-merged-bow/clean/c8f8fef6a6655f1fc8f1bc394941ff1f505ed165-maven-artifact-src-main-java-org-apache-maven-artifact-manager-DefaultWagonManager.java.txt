[MNG-2985] DefaultWagonManager does not safely remove TransferListeners from the wagon
Submitted By: Abel Mui√±o

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@538041 13f79535-47bb-0310-9956-ffa450edef68

-        package org.apache.maven.artifact.manager;
+package org.apache.maven.artifact.manager;
+    private static final String[] CHECKSUM_IDS = { "md5", "sha1" };
+
+    /** have to match the CHECKSUM_IDS */
+    private static final String[] CHECKSUM_ALGORITHMS = { "MD5", "SHA-1" };
+
-        try
+        for ( int i = 0; i < CHECKSUM_IDS.length; i++ )
-            ChecksumObserver checksumObserver = new ChecksumObserver( "MD5" );
-            wagon.addTransferListener( checksumObserver );
-            checksums.put( "md5", checksumObserver );
-            checksumObserver = new ChecksumObserver( "SHA-1" );
-            wagon.addTransferListener( checksumObserver );
-            checksums.put( "sha1", checksumObserver );
-        }
-        catch ( NoSuchAlgorithmException e )
-        {
-            throw new TransferFailedException( "Unable to add checksum methods: " + e.getMessage(), e );
+            checksums.put( CHECKSUM_IDS[i], addChecksumObserver( wagon, CHECKSUM_ALGORITHMS[i] ) );
-            Repository artifactRepository = new Repository( repository.getId(), repository.getUrl() );
-
-            if ( serverPermissionsMap.containsKey( repository.getId() ) )
+            try
-                RepositoryPermissions perms = (RepositoryPermissions) serverPermissionsMap.get( repository.getId() );
+                Repository artifactRepository = new Repository( repository.getId(), repository.getUrl() );
-                getLogger().debug(
-                    "adding permissions to wagon connection: " + perms.getFileMode() + " " + perms.getDirectoryMode() );
+                if ( serverPermissionsMap.containsKey( repository.getId() ) )
+                {
+                    RepositoryPermissions perms = (RepositoryPermissions) serverPermissionsMap.get( repository.getId() );
-                artifactRepository.setPermissions( perms );
+                    getLogger().debug( 
+                        "adding permissions to wagon connection: " + perms.getFileMode() + " " + perms.getDirectoryMode() );
+
+                    artifactRepository.setPermissions( perms );
+                }
+                else
+                {
+                    getLogger().debug( "not adding permissions to wagon connection" );
+                }
+
+                wagon.connect( artifactRepository, getAuthenticationInfo( repository.getId() ), getProxy( protocol ) );
+
+                wagon.put( source, remotePath );
-            else
+            finally
-                getLogger().debug( "not adding permissions to wagon connection" );
+                if ( downloadMonitor != null )
+                {
+                    wagon.removeTransferListener( downloadMonitor );
+                }
-            wagon.connect( artifactRepository, getAuthenticationInfo( repository.getId() ), getProxy( protocol ) );
-
-            wagon.put( source, remotePath );
-
-            wagon.removeTransferListener( downloadMonitor );
-
+            // Remove every checksum listener
+            for ( int i = 0; i < CHECKSUM_IDS.length; i++ )
+            {
+                TransferListener checksumListener = (TransferListener) checksums.get( CHECKSUM_IDS[i] );
+                if ( checksumListener != null )
+                {
+                    wagon.removeTransferListener( checksumListener );
+                }
+            }
+
+    private ChecksumObserver addChecksumObserver( Wagon wagon, String algorithm )
+        throws TransferFailedException
+    {
+        try
+        {
+            ChecksumObserver checksumObserver = new ChecksumObserver( algorithm );
+            wagon.addTransferListener( checksumObserver );
+            return checksumObserver;
+        }
+        catch ( NoSuchAlgorithmException e )
+        {
+            throw new TransferFailedException( "Unable to add checksum for unsupported algorithm " + algorithm, e );
+        }
+    }
+
-        ChecksumObserver md5ChecksumObserver;
-        ChecksumObserver sha1ChecksumObserver;
-        try
-        {
-            md5ChecksumObserver = new ChecksumObserver( "MD5" );
-            wagon.addTransferListener( md5ChecksumObserver );
-
-            sha1ChecksumObserver = new ChecksumObserver( "SHA-1" );
-            wagon.addTransferListener( sha1ChecksumObserver );
-        }
-        catch ( NoSuchAlgorithmException e )
-        {
-            throw new TransferFailedException( "Unable to add checksum methods: " + e.getMessage(), e );
-        }
+        int i = 0;
+        ChecksumObserver md5ChecksumObserver = addChecksumObserver( wagon, CHECKSUM_ALGORITHMS[i++] );
+        ChecksumObserver sha1ChecksumObserver = addChecksumObserver( wagon, CHECKSUM_ALGORITHMS[i++] );
+            // Remove every TransferListener
+            wagon.removeTransferListener( md5ChecksumObserver );
+            wagon.removeTransferListener( sha1ChecksumObserver );
+            if ( downloadMonitor != null )
+            {
+                wagon.removeTransferListener( downloadMonitor );
+            }
+

INS23 INS23 INS31 INS83 INS83 INS83 INS5 INS59 INS29 INS83 INS83 INS83 INS5 INS59 INS83 MOV43 INS42 INS44 INS44 MOV43 INS8 INS43 INS85 INS42 INS4 INS65 INS43 INS85 INS42 INS4 INS24 INS43 INS42 INS43 INS42 INS54 INS60 INS60 INS42 INS45 INS45 INS66 INS42 INS45 INS45 INS58 INS27 INS37 INS8 INS8 INS42 INS42 INS8 INS12 INS39 MOV43 INS59 MOV43 INS59 INS39 INS59 INS42 INS40 INS42 INS21 INS54 INS24 MOV21 MOV21 INS60 MOV21 INS41 MOV44 INS8 UPD42 INS34 UPD42 MOV42 INS32 INS42 INS32 INS21 INS21 INS25 INS42 INS34 INS32 INS8 INS8 INS58 INS27 INS37 INS8 MOV43 INS59 INS42 INS53 INS42 MOV42 INS2 INS42 MOV42 INS2 INS32 INS32 INS27 INS8 MOV42 MOV42 INS2 INS32 MOV60 MOV25 MOV21 MOV21 INS25 INS39 INS59 INS42 INS40 INS42 INS60 INS25 INS42 INS14 INS14 INS42 INS37 INS42 INS37 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS33 INS21 INS42 INS42 INS42 MOV42 INS2 INS27 INS8 INS42 INS34 INS43 INS59 INS27 INS8 MOV43 INS42 MOV43 INS27 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS33 MOV21 INS42 INS42 INS11 INS42 INS33 INS21 INS45 INS42 INS42 INS42 INS42 INS43 INS32 INS32 INS42 INS42 INS42 INS2 INS42 INS42 INS42 INS42 INS42 DEL42 DEL43 DEL42 DEL42 DEL43 DEL45 DEL14 DEL59 DEL60 DEL45 DEL42 DEL32 DEL21 DEL42 DEL45 DEL14 DEL7 DEL21 DEL42 DEL42 DEL32 DEL21 DEL42 DEL42 DEL45 DEL42 DEL32 DEL21 DEL8 DEL42 DEL43 DEL42 DEL44 DEL45 DEL42 DEL42 DEL32 DEL27 DEL42 DEL14 DEL53 DEL8 DEL12 DEL54 DEL8 DEL59 DEL60 DEL42 DEL45 DEL14 DEL7 DEL21 DEL42 DEL42 DEL32 DEL21 DEL42 DEL45 DEL14 DEL7 DEL21 DEL42 DEL42 DEL32 DEL21 DEL8 DEL45 DEL42 DEL42 DEL32 DEL27 DEL42 DEL14 DEL53 DEL8 DEL12 DEL54