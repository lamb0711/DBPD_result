Adding more unit tests for error reporting. Almost done with project-based errors now.

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@612333 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.maven.model.Model;
+import org.apache.maven.project.ModelUtils;
+import org.codehaus.plexus.classworlds.realm.ClassRealm;
-    /* (non-Javadoc)
-    * @see org.apache.maven.profiles.ProfileManager#getActiveProfiles()
-    */
-        List activeFromPom = new ArrayList();
-        List activeExternal = new ArrayList();
+         return getActiveProfiles( null );
+    }
-        for ( Iterator it = profilesById.entrySet().iterator(); it.hasNext(); )
+    public List getActiveProfiles( Model model )
+        throws ProfileActivationException
+    {
+        MavenRealmManager realmManager = profileActivationContext.getRealmManager();
+
+        ClassRealm projectRealm = null;
+        ClassRealm oldLookupRealm = null;
+
+        if ( ( model != null ) && ( realmManager != null ) )
-            Map.Entry entry = (Entry) it.next();
-
-            String profileId = (String) entry.getKey();
-            Profile profile = (Profile) entry.getValue();
-
-            boolean shouldAdd = false;
-            if ( profileActivationContext.isExplicitlyActive( profileId ) )
-            {
-                shouldAdd = true;
-            }
-            else if ( !profileActivationContext.isExplicitlyInactive( profileId ) && isActive( profile, profileActivationContext ) )
-            {
-                shouldAdd = true;
-            }
-
-            if ( shouldAdd )
-            {
-                if ( "pom".equals( profile.getSource() ) )
-                {
-                    activeFromPom.add( profile );
-                }
-                else
-                {
-                    activeExternal.add( profile );
-                }
-            }
+            projectRealm = realmManager.getProjectRealm( ModelUtils.getGroupId( model ), model.getArtifactId(), ModelUtils.getVersion( model ) );
+            oldLookupRealm = container.setLookupRealm( projectRealm );
-        if ( activeFromPom.isEmpty() )
+        try
-            List defaultIds = profileActivationContext.getActiveByDefaultProfileIds();
+            List activeFromPom = new ArrayList();
+            List activeExternal = new ArrayList();
-            for ( Iterator it = defaultIds.iterator(); it.hasNext(); )
+            for ( Iterator it = profilesById.entrySet().iterator(); it.hasNext(); )
-                String profileId = (String) it.next();
+                Map.Entry entry = (Entry) it.next();
-                Profile profile = (Profile) profilesById.get( profileId );
+                String profileId = (String) entry.getKey();
+                Profile profile = (Profile) entry.getValue();
-                if ( profile != null )
+                boolean shouldAdd = false;
+                if ( profileActivationContext.isExplicitlyActive( profileId ) )
-                    activeFromPom.add( profile );
+                    shouldAdd = true;
+                }
+                else if ( !profileActivationContext.isExplicitlyInactive( profileId ) && isActive( profile, profileActivationContext ) )
+                {
+                    shouldAdd = true;
+                }
+
+                if ( shouldAdd )
+                {
+                    if ( "pom".equals( profile.getSource() ) )
+                    {
+                        activeFromPom.add( profile );
+                    }
+                    else
+                    {
+                        activeExternal.add( profile );
+                    }
+
+            if ( activeFromPom.isEmpty() )
+            {
+                List defaultIds = profileActivationContext.getActiveByDefaultProfileIds();
+
+                for ( Iterator it = defaultIds.iterator(); it.hasNext(); )
+                {
+                    String profileId = (String) it.next();
+
+                    Profile profile = (Profile) profilesById.get( profileId );
+
+                    if ( profile != null )
+                    {
+                        activeFromPom.add( profile );
+                    }
+                }
+            }
+
+            List allActive = new ArrayList( activeFromPom.size() + activeExternal.size() );
+
+            allActive.addAll( activeExternal );
+            allActive.addAll( activeFromPom );
+
+            return allActive;
-
-        List allActive = new ArrayList( activeFromPom.size() + activeExternal.size() );
-
-        allActive.addAll( activeExternal );
-        allActive.addAll( activeFromPom );
-
-        return allActive;
+        finally
+        {
+            if ( projectRealm != null )
+            {
+                container.setLookupRealm( oldLookupRealm );
+            }
+        }

INS26 INS26 INS26 INS40 INS40 INS40 INS31 INS83 INS43 INS42 INS43 INS8 INS44 INS8 INS42 INS42 INS41 INS43 INS42 INS60 INS60 INS60 INS25 INS54 INS32 INS42 INS43 INS59 INS43 INS59 INS43 INS59 INS27 INS8 MOV8 INS8 INS42 INS33 INS42 INS42 INS32 INS42 INS42 INS33 INS42 INS42 INS33 INS36 INS36 INS21 INS21 INS25 INS42 INS42 INS27 INS27 INS7 INS7 INS27 INS8 INS42 INS33 INS42 INS33 INS42 INS32 INS42 INS32 INS42 INS33 INS21 INS42 INS42 INS32 INS32 INS32 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42