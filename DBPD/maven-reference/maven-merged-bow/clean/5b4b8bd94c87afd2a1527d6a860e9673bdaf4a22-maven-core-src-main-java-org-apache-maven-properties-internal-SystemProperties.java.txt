[MNG-6105] properties.internal.SystemProperties.addSystemProperties() is not really thread-safe

Refactoring the current code setting system properties to synchronize correctly on the given ones: avoids ConcurrentModificationException and NullPointerException if the properties is modified by another thread.

-        for ( String key : System.getProperties().stringPropertyNames() )
-        {
-            props.put( key, System.getProperty( key ) );
-        }
+        props.putAll( getSystemProperties() );
-     * Returns System.properties copy.
+     * Returns a copy of {@link System#getProperties()} in a thread-safe manner.
+     * 
+     * @return {@link System#getProperties()} obtained in a thread-safe manner. 
-        Properties systemProperties = new Properties();
-        addSystemProperties( systemProperties );
-        return systemProperties;
+        return copyProperties( System.getProperties() );
+
+    /**
+     * Copies the given {@link Properties} object into a new {@link Properties} object, in a thread-safe manner.
+     * @param properties Properties to copy.
+     * @return Copy of the given properties.
+     */
+    public static Properties copyProperties( Properties properties )
+    {
+        final Properties copyProperties = new Properties();
+        // guard against modification/removal of keys in the given properties (MNG-5670, MNG-6053, MNG-6105)
+        synchronized ( properties )
+        {
+            copyProperties.putAll( properties );
+        }
+        return copyProperties;
+    }
+

INS31 INS8 INS29 INS83 INS83 INS43 INS42 INS8 INS42 INS44 MOV21 INS65 INS65 INS42 INS41 INS65 UPD65 INS65 INS43 INS42 INS51 INS66 INS65 INS66 INS66 INS65 INS66 MOV32 MOV32 INS66 INS65 INS66 INS65 INS66 INS42 UPD66 INS66 INS42 INS83 INS42 INS8 UPD42 UPD42 INS68 INS68 UPD42 INS42 INS42 UPD42 MOV21 UPD42 INS42 INS42 INS42 INS42 UPD42 INS42 UPD42 DEL42 DEL42 DEL42 DEL42 DEL43 DEL42 DEL44 DEL8 DEL70 DEL8 DEL42