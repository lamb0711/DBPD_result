[MNG-4633] Fixed weave mode bug when building m3 itself in weave mode.

Updated testcase for MEP.

Also removed all unused/unecessar code from weave mode.

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@934201 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.maven.lifecycle.*;
+import org.apache.maven.lifecycle.LifecycleExecutionException;
+import org.apache.maven.lifecycle.MavenExecutionPlan;
+import org.apache.maven.lifecycle.Schedule;
-import java.util.*;
+import java.util.ArrayList;
+import java.util.Collections;
+import java.util.HashMap;
+import java.util.Iterator;
+import java.util.List;
+import java.util.Map;
+import java.util.Properties;
-    private LifecycleDependencyResolver lifecycleDependencyResolver;
-
-    @Requirement
-                                  LifecycleDependencyResolver lifecycleDependencyResolver, ExecutionEventCatapult eventCatapult )
+                                  ExecutionEventCatapult eventCatapult )
-        this.lifecycleDependencyResolver = lifecycleDependencyResolver;
-                       MavenSession session, CompletionService<ProjectSegment> service, ReactorBuildStatus reactorBuildStatus )
+                       MavenSession session, CompletionService<ProjectSegment> service,
+                       ReactorBuildStatus reactorBuildStatus )
-                ProjectBuildList segmentChunks = projectBuilds.getByTaskSegment(  taskSegment );
+                ProjectBuildList segmentChunks = projectBuilds.getByTaskSegment( taskSegment );
-                                                                    dependencyContext, concurrentBuildLogger,
-                                                                    projectBuilds );
+                                                                    dependencyContext, concurrentBuildLogger );
-                                                                           final MavenSession rootSession,
-                                                                           final ReactorBuildStatus reactorBuildStatus,
-                                                                           final MavenExecutionPlan executionPlan,
-                                                                           final ProjectSegment projectBuild,
-                                                                           final ThreadOutputMuxer muxer,
-                                                                           final DependencyContext dependencyContext,
-                                                                           final ConcurrentBuildLogger concurrentBuildLogger,
-                                                                           final ProjectBuildList projectBuilds )
+                                                                             final MavenSession rootSession,
+                                                                             final ReactorBuildStatus reactorBuildStatus,
+                                                                             final MavenExecutionPlan executionPlan,
+                                                                             final ProjectSegment projectBuild,
+                                                                             final ThreadOutputMuxer muxer,
+                                                                             final DependencyContext dependencyContext,
+                                                                             final ConcurrentBuildLogger concurrentBuildLogger )
-                boolean packagePhaseSeen = false;
-                boolean runBAbyRun = false;
-                        final String phase = current.getMojoExecution().getMojoDescriptor().getPhase();
-                        if ( !packagePhaseSeen && phase != null && phase.equals( "package" ) )
-                        {
-                            // Re-resolve. A bit of a kludge ATM
-                            packagePhaseSeen = true;
-                            lifecycleDependencyResolver.reResolveReactorArtifacts( projectBuilds, false,
-                                                                                   projectBuild.getProject(),
-                                                                                   projectBuild.getSession(),
-                                                                                   executionPlan );
-
-                        }
-
-                        ExecutionPlanItem next = planItems.hasNext() ? planItems.next() : null;
-                        if ( next != null )
+                        ExecutionPlanItem nextPlanItem = planItems.hasNext() ? planItems.next() : null;
+                        if ( nextPlanItem != null )
-                            final Schedule scheduleOfNext = next.getSchedule();
-                            if ( !runBAbyRun && ( scheduleOfNext == null || !scheduleOfNext.isParallel() ) )
+                            final Schedule scheduleOfNext = nextPlanItem.getSchedule();
+                            if ( scheduleOfNext == null || !scheduleOfNext.isParallel() )
-                                    final ExecutionPlanItem inSchedule = upstreamPlan.findLastInPhase( next );
+                                    final String nextPhase = nextPlanItem.getLifecyclePhase();
+                                    final ExecutionPlanItem inSchedule = upstreamPlan.findLastInPhase( nextPhase );
-                        current = next;
-
-                        if ( packagePhaseSeen && !runBAbyRun )
-                        {
-                            runBAbyRun = true;
-                        }
+                        current = nextPlanItem;

INS26 INS26 INS26 INS26 INS26 INS26 INS26 INS26 INS40 INS40 UPD40 INS40 INS40 INS40 INS40 INS40 UPD40 INS40 UPD42 UPD42 UPD42 MOV27 UPD42 INS60 INS83 MOV43 INS59 INS42 INS32 INS42 INS42 UPD42 DEL42 DEL78 DEL83 DEL42 DEL43 DEL42 DEL59 DEL23 DEL42 DEL43 DEL42 DEL44 DEL52 DEL42 DEL22 DEL42 DEL7 DEL21 DEL42 DEL83 DEL42 DEL43 DEL42 DEL44 DEL39 DEL42 DEL9 DEL59 DEL60 DEL39 DEL42 DEL9 DEL59 DEL60 DEL83 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL42 DEL32 DEL59 DEL60 DEL42 DEL38 DEL42 DEL33 DEL27 DEL27 DEL42 DEL42 DEL45 DEL32 DEL27 DEL42 DEL9 DEL7 DEL21 DEL42 DEL42 DEL42 DEL9 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL32 DEL21 DEL8 DEL25 DEL42 DEL38 DEL36 DEL27 DEL42 DEL42 DEL38 DEL27 DEL42 DEL9 DEL7 DEL21 DEL8 DEL25