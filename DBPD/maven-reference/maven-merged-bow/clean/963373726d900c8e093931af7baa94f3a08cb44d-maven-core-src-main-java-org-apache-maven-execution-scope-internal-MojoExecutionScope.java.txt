MNG-5655 deduplicate WeakMojoExecutionListener instances

Signed-off-by: Igor Fedorenko <ifedorenko@apache.org>

+import java.util.Collection;
+import java.util.IdentityHashMap;
-        for ( Object provided : getScopeState().provided.values() )
+        for ( WeakMojoExecutionListener provided : getProvidedListeners() )
-            if ( provided instanceof WeakMojoExecutionListener )
-            {
-                ( (WeakMojoExecutionListener) provided ).beforeMojoExecution( event );
-            }
+            provided.beforeMojoExecution( event );
-        for ( Object provided : getScopeState().provided.values() )
+        for ( WeakMojoExecutionListener provided : getProvidedListeners() )
-            if ( provided instanceof WeakMojoExecutionListener )
-            {
-                ( (WeakMojoExecutionListener) provided ).afterMojoExecutionSuccess( event );
-            }
+            provided.afterMojoExecutionSuccess( event );
+        for ( WeakMojoExecutionListener provided : getProvidedListeners() )
+        {
+            provided.afterExecutionFailure( event );
+        }
+    }
+
+    private Collection<WeakMojoExecutionListener> getProvidedListeners()
+    {
+        // the same instance can be provided multiple times under different Key's
+        // deduplicate instances to avoid redundant beforeXXX/afterXXX callbacks
+        IdentityHashMap<WeakMojoExecutionListener, Object> listeners =
+            new IdentityHashMap<WeakMojoExecutionListener, Object>();
-                ( (WeakMojoExecutionListener) provided ).afterExecutionFailure( event );
+                listeners.put( (WeakMojoExecutionListener) provided, null );
+        return listeners.keySet();
-

INS26 INS26 INS40 INS40 INS31 INS31 MOV83 MOV39 MOV42 MOV44 MOV43 INS8 INS83 INS39 INS42 MOV44 INS8 UPD83 INS74 INS42 INS70 INS70 INS43 INS43 INS60 INS41 INS8 MOV44 INS32 INS8 INS44 INS32 INS8 INS42 INS42 INS74 INS59 INS32 UPD43 INS42 MOV21 UPD43 UPD42 MOV42 INS21 INS43 INS42 INS42 MOV21 INS43 INS43 INS43 INS42 INS14 INS42 INS42 UPD42 UPD42 INS32 MOV42 INS42 INS42 INS42 INS74 INS42 INS42 UPD42 MOV42 INS42 INS42 UPD42 INS43 INS43 INS43 INS42 INS42 INS42 UPD42 UPD42 MOV11 INS33 DEL42 DEL32 DEL42 DEL22 DEL42 DEL42 DEL43 DEL42 DEL11 DEL36 DEL42 DEL42 DEL43 DEL62 DEL8 DEL25 DEL8 DEL42 DEL43 DEL42 DEL11 DEL36 DEL32 DEL42 DEL22 DEL32 DEL42 DEL43 DEL62 DEL8 DEL25 DEL8 DEL70 DEL8 DEL31 DEL39 DEL42 DEL36