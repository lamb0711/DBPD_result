o Generalized plugin realm cache

git-svn-id: https://svn.apache.org/repos/asf/maven/maven-3/trunk@817669 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Collections;
-import org.apache.maven.project.MavenProject;
-        private final ClassRealm projectRealm;
+        private final ClassLoader parentRealm;
+
+        private final List<String> parentImports;
-        public CacheKey( Plugin plugin, MavenProject project, ArtifactRepository localRepository,
+        public CacheKey( Plugin plugin, ClassLoader parentRealm, List<String> parentImports, ArtifactRepository localRepository,
-            this.projectRealm = project.getClassRealm();
+            this.parentRealm = parentRealm;
+            this.parentImports = ( parentImports != null ) ? parentImports : Collections.<String> emptyList();
-            hash = hash * 31 + ( projectRealm != null ? projectRealm.hashCode() : 0 );
+            hash = hash * 31 + ( parentRealm != null ? parentRealm.hashCode() : 0 );
+            hash = hash * 31 + this.parentImports.hashCode();
-            return projectRealm == other.projectRealm && pluginEquals( plugin, other.plugin )
+            return parentRealm == other.parentRealm && pluginEquals( plugin, other.plugin )
-    public CacheRecord get( Plugin plugin, MavenProject project, ArtifactRepository localRepository,
-                            List<ArtifactRepository> remoteRepositories )
+    public CacheRecord get( Plugin plugin, ClassLoader parentRealm, List<String> parentImports,
+                            ArtifactRepository localRepository, List<ArtifactRepository> remoteRepositories )
-        return cache.get( new CacheKey( plugin, project, localRepository, remoteRepositories ) );
+        return cache.get( new CacheKey( plugin, parentRealm, parentImports, localRepository, remoteRepositories ) );
-    public void put( Plugin plugin, MavenProject project, ArtifactRepository localRepository,
-                     List<ArtifactRepository> remoteRepositories, ClassRealm pluginRealm, List<Artifact> pluginArtifacts )
+    public void put( Plugin plugin, ClassLoader parentRealm, List<String> parentImports,
+                     ArtifactRepository localRepository, List<ArtifactRepository> remoteRepositories,
+                     ClassRealm pluginRealm, List<Artifact> pluginArtifacts )
-        CacheKey key = new CacheKey( plugin, project, localRepository, remoteRepositories );
+        CacheKey key = new CacheKey( plugin, parentRealm, parentImports, localRepository, remoteRepositories );
-            throw new IllegalStateException( "Duplicate plugin realm for plugin " + plugin );
+            throw new IllegalStateException( "Duplicate plugin realm for plugin " + plugin.getId() );

MOV26 UPD40 INS23 INS44 INS44 UPD43 INS83 INS83 INS74 INS59 INS44 INS43 INS42 INS74 UPD42 INS43 INS42 INS74 UPD42 UPD42 UPD42 INS43 INS43 INS42 INS43 INS42 INS74 UPD42 INS21 INS21 INS42 INS43 INS43 INS42 INS43 INS43 MOV43 INS42 INS42 INS42 INS43 INS43 INS7 INS7 UPD42 MOV42 INS42 UPD42 MOV42 INS42 UPD42 MOV42 INS42 INS22 INS42 INS16 INS42 INS27 MOV43 UPD42 INS42 MOV43 UPD42 INS42 INS52 INS42 UPD42 INS36 INS42 INS32 INS27 INS32 INS27 UPD42 MOV42 INS43 INS42 INS42 INS34 INS22 INS42 UPD42 UPD40 INS32 INS42 INS33 INS42 INS52 INS42 INS42 INS42 UPD42 UPD42 DEL43 DEL42 DEL32 DEL43 DEL43 DEL42