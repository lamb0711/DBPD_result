make sure plugin repositories don't get used to resolve parents and dependencies

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@227164 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.maven.model.io.xpp3.MavenXpp3Writer;
-import java.io.FileWriter;
-                                List remoteArtifactRepositories, List externalProfiles, File projectDir )
+                                List parentSearchRepositories, List externalProfiles, File projectDir )
-        if ( remoteArtifactRepositories != null && !remoteArtifactRepositories.isEmpty() )
-        {
-            aggregatedRemoteWagonRepositories.addAll( remoteArtifactRepositories );
-        }
-        List repositories = new ArrayList( aggregatedRemoteWagonRepositories );
-
-        MavenProject project = assembleLineage( model, lineage, repositories, localRepository, externalProfiles,
-                                                projectDir );
+        MavenProject project = assembleLineage( model, lineage, localRepository, externalProfiles, projectDir,
+                                                parentSearchRepositories, aggregatedRemoteWagonRepositories );
-            project = processProjectLogic( pomLocation, project, repositories, externalProfiles );
+            project = processProjectLogic( pomLocation, project, new ArrayList( aggregatedRemoteWagonRepositories ),
+                                           externalProfiles );
-    private MavenProject assembleLineage( Model model, LinkedList lineage, List aggregatedRemoteWagonRepositories,
-                                          ArtifactRepository localRepository, List externalProfiles, File projectDir )
+    private MavenProject assembleLineage( Model model, LinkedList lineage, ArtifactRepository localRepository,
+                                          List externalProfiles, File projectDir, List parentSearchRepositories,
+                                          Set aggregatedRemoteWagonRepositories )
-                model = findModelFromRepository( parentArtifact, aggregatedRemoteWagonRepositories, localRepository );
+                // we must add the repository this POM was found in too, by chance it may be located where the parent is
+                // we can't query the parent to ask where it is :)
+                List remoteRepositories = new ArrayList( aggregatedRemoteWagonRepositories );
+                remoteRepositories.addAll( parentSearchRepositories );
+                model = findModelFromRepository( parentArtifact, remoteRepositories, localRepository );
-            MavenProject parent = assembleLineage( model, lineage, aggregatedRemoteWagonRepositories, localRepository,
-                                                   externalProfiles, parentProjectDir );
+            MavenProject parent = assembleLineage( model, lineage, localRepository, externalProfiles, parentProjectDir,
+                                                   parentSearchRepositories, aggregatedRemoteWagonRepositories );
-                    artifact = artifactFactory.createExtensionArtifact( ext.getGroupId(), ext.getArtifactId(), VersionRange
-                        .createFromVersionSpec( version ) );
+                    artifact = artifactFactory.createExtensionArtifact( ext.getGroupId(), ext.getArtifactId(),
+                                                                        VersionRange
+                                                                            .createFromVersionSpec( version ) );

MOV44 INS44 UPD42 UPD42 INS43 INS42 INS42 INS42 INS42 MOV60 INS21 INS14 INS32 INS42 INS42 INS43 INS42 UPD42 INS42 INS42 INS42 INS42 UPD42 DEL40 DEL26 DEL40 DEL26 DEL42 DEL33 DEL27 DEL42 DEL42 DEL32 DEL38 DEL27 DEL42 DEL42 DEL42 DEL32 DEL21 DEL8 DEL25 DEL42 DEL42 DEL42