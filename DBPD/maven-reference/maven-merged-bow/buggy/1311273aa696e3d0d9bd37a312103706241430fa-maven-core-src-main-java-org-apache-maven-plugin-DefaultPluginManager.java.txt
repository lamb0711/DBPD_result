Made buildTopDownMergedConfiguration really recursive - in most cases it didn't.

Fixed a merge problem where only direct children of <configuration> in the POM
appeared in the merged configuration.

(like maven-antrun-plugin, the 'tasks' configuration tag didn't have any
value, but has children. After the merge, the children were gone,
and it was marked as having no value, and hence the field was not updated.)


git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@232281 13f79535-47bb-0310-9956-ffa450edef68

-		// FIXME: need to find out how a plugin gets marked as 'installed'
-		// and no ChildContainer exists. The check for that below fixes
-		// the 'Can't find plexus container for plugin: xxx' error.
+        // FIXME: need to find out how a plugin gets marked as 'installed'
+        // and no ChildContainer exists. The check for that below fixes
+        // the 'Can't find plexus container for plugin: xxx' error.
-                if ( fieldValue == null )
+                // only mark as invalid if there are no child nodes
+                if ( fieldValue == null && (value == null || value.getChildCount() == 0 ) )
-            
+
-            
+
-            
+
-                
+
-                
+                // TODO: recessive seems to be dominant here?
-            
-            mergeConfiguration( result, recessive );
-        
+
+        PlexusConfiguration[] children = dominant.getChildren();
+
+        for ( int i = 0; i < children.length; i++ )
+        {
+            PlexusConfiguration childDom = children[i];
+            PlexusConfiguration childRec = recessive == null ? null : recessive.getChild( childDom.getName(), false );
+
+            if ( childRec != null )
+            {
+                result.addChild( buildTopDownMergedConfiguration( childDom, childRec ) );
+            }
+            else
+            {   // FIXME: copy, or use reference?
+                result.addChild( copyConfiguration( childDom ) );
+            }
+        }
+    

INS60 INS24 INS5 INS59 INS58 INS27 INS37 INS8 INS43 INS85 INS42 INS32 INS39 INS59 INS42 INS40 INS42 INS60 INS60 INS25 INS42 INS42 INS42 INS42 INS34 INS43 INS59 INS43 INS59 INS27 INS8 INS8 INS42 INS42 INS2 INS42 INS42 INS16 INS42 INS33 INS21 INS21 INS27 INS42 INS42 INS27 INS33 INS32 INS32 INS32 MOV27 INS36 INS42 INS33 INS42 INS42 INS32 INS9 INS42 INS42 INS32 INS42 INS42 INS32 INS27 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS27 INS27 INS42 INS33 INS32 INS34 INS42 INS42 DEL42 DEL42 DEL42 DEL32 DEL21