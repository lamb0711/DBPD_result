Fixing some things:

o Artifact attachment via MavenProjectHelper was using string literals of the variables I was trying to use to fill in type and classifier (dumb, I know!)

o Source plugin didn't have an @phase for the JarSourceMojo...added, then added the goal configuration in the release profile in the super-pom

o Removed the source plugin bindings for the lifecycle mappings in maven-core

o Re-added [deprecated] method MavenProjectBuilder.build( File, ArtifactRepository, List )...you should use MavenProjectBuilder.build( File, ArtifactRepository, ProfileManager ) instead.

o Added profile handling/injection for the super-pom in two places: in buildStandaloneSuperPom() and in private build(..). This enables injection of the release profile which is provided in the super-pom.

o Added integration test to verify that using -DperformRelease=true results in the sources being attached...to override this behavior, another profile keyed on -DperformRelease could turn the 'attach' param for the source plugin off.



git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@233245 13f79535-47bb-0310-9956-ffa450edef68

+    
+    /**
+     * @deprecated Use build( File, ArtifactRepository, ProfileManager)
+     */
+    public MavenProject build( File projectDescriptor, ArtifactRepository localRepository, List activeExternalProfiles )
+        throws ProjectBuildingException
+    {
+        ProfileManager profileManager = new DefaultProfileManager( container );
+        
+        if ( activeExternalProfiles != null )
+        {
+            for ( Iterator it = activeExternalProfiles.iterator(); it.hasNext(); )
+            {
+                Profile profile = (Profile) it.next();
+                
+                // since it's already determined to be active, we'll explicitly set it as activated in the mgr.
+                profileManager.explicitlyActivate( profile.getId() );
+                
+                profileManager.addProfile( profile );
+            }
+        }
+        
+        return buildFromSourceFile( projectDescriptor, localRepository, profileManager );
+    }
+        
+        ProfileManager superProjectProfileManager = new DefaultProfileManager( container );
+        
+        List activeProfiles;
+        
+        Properties profileProperties = new Properties();
+        superProjectProfileManager.addProfiles( superModel.getProfiles() );
+        
+        activeProfiles = injectActiveProfiles( superProjectProfileManager, superModel, profileProperties );
+
+        MavenProject superProject = new MavenProject( superModel );
+
+        superProject.addProfileProperties( profileProperties );
+
+        superProject.setActiveProfiles( activeProfiles );
+        
-        Model previous = superModel;
+        Model previous = superProject.getModel();
+        ProfileManager profileManager = new DefaultProfileManager( container );
+        
+        List activeProfiles;
+        
+        Properties profileProperties = new Properties();
+
+        profileManager.addProfiles( superModel.getProfiles() );
+        
+        activeProfiles = injectActiveProfiles( profileManager, superModel, profileProperties );
+
+
+        project.addProfileProperties( profileProperties );
+
+        project.setActiveProfiles( activeProfiles );

INS31 INS29 INS83 INS43 INS42 INS44 INS44 INS44 INS43 INS8 INS65 INS42 INS43 INS42 INS43 INS42 INS43 INS42 INS42 INS60 INS25 INS41 INS60 INS60 INS60 INS21 INS21 INS60 INS21 INS21 INS60 INS60 INS60 INS21 INS21 INS21 INS21 INS66 INS42 INS42 INS42 INS43 INS59 INS27 INS8 INS32 INS43 INS59 INS43 INS59 INS43 INS59 INS32 INS7 INS43 INS59 INS32 INS32 INS43 INS59 INS43 INS59 INS43 INS59 INS32 INS7 INS32 INS32 INS42 INS42 INS14 INS42 INS33 INS24 INS42 INS42 INS42 INS42 INS42 INS42 INS14 INS42 INS42 INS42 INS42 INS14 INS42 INS42 INS32 INS42 INS32 INS42 INS42 INS14 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS14 INS42 INS42 INS42 INS42 INS14 INS42 INS42 INS32 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS43 INS42 INS58 INS32 INS8 INS43 INS42 INS43 INS42 INS42 INS42 INS42 INS42 INS42 INS43 INS42 INS42 INS42 INS43 INS42 INS43 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS43 INS59 INS42 INS42 INS60 INS21 INS21 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS43 INS59 INS32 INS32 INS42 INS42 INS42 INS42 INS11 INS42 INS42 INS32 INS42 INS42 INS42 INS43 INS32 INS42 INS42 INS42 INS42 INS42 DEL42