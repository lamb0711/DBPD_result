MNG-2364 make sure the system properties are passed from the execution/embed requests, to make the on-property profile activation work in embedded environment

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@415000 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Properties;
+    
+    // default fallback..
+    private Properties systemProperties = System.getProperties();
+    /**
+     * @deprecated without passing in the system properties, the SystemPropertiesProfileActivator will not work correctly
+     * in embedded envirnments.
+     */
-        this( container, null );
+        this( container, (Settings)null);
+    }
+    
+    /**
+     * the properties passed to the profile manager are the props that
+     * are passed to maven, possibly containing profile activator properties
+     *
+     */
+    public DefaultProfileManager( PlexusContainer container, Properties props )
+    {
+        this( container, (Settings)null );
+        if (props != null) {
+            systemProperties = props;
+        }
+        
-    public DefaultProfileManager( PlexusContainer container, Settings settings )
+    private DefaultProfileManager( PlexusContainer container, Settings settings )
+    
+    public Properties getSystemProperties() {
+        return systemProperties;
+    }
+        container.addContextValue("SystemProperties", systemProperties);
-            try
+            container.getContext().put("SystemProperties", null);
+            if ( activators != null )
-                container.releaseAll( activators );
-            }
-            catch ( ComponentLifecycleException e )
-            {
-                container.getLogger().debug( "Error releasing profile activators - ignoring.", e );
+                try
+                {
+                    container.releaseAll( activators );
+                }
+                catch ( ComponentLifecycleException e )
+                {
+                    container.getLogger().debug( "Error releasing profile activators - ignoring.", e );
+                }

INS26 INS40 INS23 INS31 INS31 INS83 INS43 INS59 INS29 INS44 INS29 INS83 INS42 MOV44 INS44 INS8 UPD83 INS83 INS43 INS42 INS8 INS42 INS42 INS32 INS65 INS43 INS42 INS65 INS43 INS42 INS17 INS25 INS42 INS41 INS21 INS42 INS42 INS66 INS66 INS42 INS11 INS66 INS66 INS42 INS42 INS11 INS27 INS8 INS42 INS32 INS8 INS43 INS33 INS43 INS33 INS42 INS33 INS21 INS42 INS42 INS45 INS42 INS21 INS25 INS42 INS42 INS7 INS32 INS27 MOV8 INS42 INS42 INS32 INS42 INS45 INS33 INS42 INS33 INS42 INS42 DEL33