[MNG-2228] put extensions in a child container. This guarantees separation avoiding root classloader pollution that was causing plugins such as the release plugin to fail when using wagon-webdav.
Merged from: r492068, maven-2.0.x branch


git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@492071 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Collection;
+    private Map availableWagons = new HashMap();
+
+    // TODO: this leaks the component in the public api - it is never released back to the container
-        Wagon wagon;
+        PlexusContainer container = getWagonContainer( protocol );
+        Wagon wagon;
-            wagon.setInteractive( interactive );
-        catch ( ComponentLookupException e )
+        catch ( ComponentLookupException e1 )
-                "Cannot find wagon which supports the requested protocol: " + protocol, e );
+                "Cannot find wagon which supports the requested protocol: " + protocol, e1 );
+        wagon.setInteractive( interactive );
+
-    public void putArtifact( File source, Artifact artifact, ArtifactRepository repository )
+    private PlexusContainer getWagonContainer( String protocol )
+    {
+        PlexusContainer container = this.container;
+
+        if ( availableWagons.containsKey( protocol ) )
+        {
+            container = (PlexusContainer) availableWagons.get( protocol );
+        }
+        return container;
+    }
+
+    public void putArtifact( File source, Artifact artifact, ArtifactRepository deploymentRepository )
-        putRemoteFile( repository, source, repository.pathOf( artifact ), downloadMonitor );
+        putRemoteFile( deploymentRepository, source, deploymentRepository.pathOf( artifact ), downloadMonitor );
-            releaseWagon( wagon );
+            releaseWagon( protocol, wagon );
-        Wagon wagon;
-
+        Wagon wagon;
-            releaseWagon( wagon );
+            releaseWagon( protocol, wagon );
-    private void releaseWagon( Wagon wagon )
+    private void releaseWagon( String protocol, Wagon wagon )
+        PlexusContainer container = getWagonContainer( protocol );
+    public void registerWagons( Collection wagons, PlexusContainer extensionContainer )
+    {
+        for ( Iterator i = wagons.iterator(); i.hasNext(); )
+        {
+            availableWagons.put( i.next(), extensionContainer );
+        }
+    }

INS26 INS40 INS23 INS31 INS31 INS83 INS43 INS59 INS83 INS43 INS42 INS44 INS8 MOV60 INS44 INS83 INS39 INS42 INS44 INS44 INS8 INS42 INS42 INS14 INS60 MOV21 INS42 INS43 INS42 INS60 INS25 INS41 UPD42 INS43 INS42 INS60 INS43 INS42 INS43 INS42 INS24 INS43 INS43 INS59 INS42 INS43 INS59 INS32 INS8 INS42 INS42 INS43 INS59 INS42 INS42 INS58 INS32 INS8 INS42 INS42 INS42 INS32 INS42 INS42 INS22 INS42 INS42 INS42 INS21 UPD42 INS42 INS42 INS32 INS43 INS59 INS42 INS42 INS21 INS42 INS42 UPD42 INS52 INS42 INS7 UPD42 INS42 INS42 INS42 INS42 INS32 INS32 INS42 INS11 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS42 UPD42 INS43 INS32 INS42 INS42 INS42 INS42 INS42 INS42