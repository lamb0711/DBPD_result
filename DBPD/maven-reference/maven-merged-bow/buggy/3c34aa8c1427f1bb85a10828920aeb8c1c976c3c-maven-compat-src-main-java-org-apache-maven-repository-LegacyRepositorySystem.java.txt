[MNG-4334] maven core caches settings.xml

o First pass: auth & mirror moved out of the components into the requests

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@810296 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.maven.repository.MirrorBuilder;
+import org.apache.maven.settings.Mirror;
+import org.apache.maven.settings.Server;
-    
-    @Requirement
-    private MirrorBuilder mirrorBuilder;
-    private Map<String, Authentication> authentications = new HashMap<String, Authentication>();
-
+    // TODO: move this out, the component needs to be stateless for safe reuse
-    
+
-    // Mirror 
-    public void addMirror( String id, String mirrorOf, String url )
-    {
-        Authentication auth = id != null ? authentications.get( id ) : null;
-        mirrorBuilder.addMirror( id, mirrorOf, url, auth );
-    }
-
-    public List<ArtifactRepository> getMirrors( List<ArtifactRepository> repositories )
-    {
-        return mirrorBuilder.getMirrors( repositories );
-    }
-
+            effectiveRepository.setAuthentication( aliasedRepo.getAuthentication() );
+
+    private Mirror getMirror( ArtifactRepository repository, List<Mirror> mirrors )
+    {
+        String repoId = repository.getId();
+
+        if ( repoId != null )
+        {
+            for ( Mirror mirror : mirrors )
+            {
+                if ( repoId.equals( mirror.getMirrorOf() ) )
+                {
+                    return mirror;
+                }
+            }
+
+            for ( Mirror mirror : mirrors )
+            {
+                if ( DefaultMirrorBuilder.matchPattern( repository, mirror.getMirrorOf() ) )
+                {
+                    return mirror;
+                }
+            }
+        }
+
+        return null;
+    }
+
+    public void injectMirror( List<ArtifactRepository> repositories, List<Mirror> mirrors )
+    {
+        if ( repositories != null && mirrors != null )
+        {
+            for ( ArtifactRepository repository : repositories )
+            {
+                Mirror mirror = getMirror( repository, mirrors );
+
+                if ( mirror != null )
+                {
+                    repository.setId( mirror.getId() );
+                    repository.setUrl( mirror.getUrl() );
+                }
+            }
+        }
+    }
+
+    public void injectAuthentication( List<ArtifactRepository> repositories, List<Server> servers )
+    {
+        if ( repositories != null )
+        {
+            Map<String, Server> serversById = new HashMap<String, Server>();
+
+            if ( servers != null )
+            {
+                for ( Server server : servers )
+                {
+                    if ( !serversById.containsKey( server.getId() ) )
+                    {
+                        serversById.put( server.getId(), server );
+                    }
+                }
+            }
+
+            for ( ArtifactRepository repository : repositories )
+            {
+                Server server = serversById.get( repository.getId() );
+
+                if ( server != null )
+                {
+                    Authentication authentication = new Authentication( server.getUsername(), server.getPassword() );
+
+                    repository.setAuthentication( authentication );
+                }
+                else
+                {
+                    repository.setAuthentication( null );
+                }
+            }
+        }
+    }
+
-    // serverId = repository id
-    //
-    public void addAuthenticationForArtifactRepository( String repositoryId, String username, String password )
-    {
-        Authentication authentication = new Authentication( username, password );
-        authentications.put( repositoryId, authentication );
-    }
-
-    //
-        Authentication authentication = authentications.get( repositoryId );
-        
-        if ( authentication != null )
-        {
-            artifactRepository.setAuthentication( authentication );
-        }
-        
-        Proxy proxy = proxies.get(  artifactRepository.getProtocol() );
+        Proxy proxy = proxies.get( artifactRepository.getProtocol() );

MOV26 INS26 MOV31 UPD40 INS40 INS31 INS31 INS83 INS43 INS42 INS44 INS44 INS8 UPD42 MOV44 INS8 MOV83 INS39 INS42 INS44 INS44 INS8 UPD42 MOV42 INS43 INS42 INS74 INS42 INS60 INS25 INS41 INS74 INS42 INS25 INS74 INS42 INS74 INS42 INS25 INS42 INS43 INS43 MOV43 INS59 INS27 INS8 INS33 INS43 INS43 INS27 INS8 MOV43 MOV43 INS43 INS43 INS27 INS8 INS21 INS42 INS42 UPD42 MOV42 INS32 INS42 INS33 INS70 INS70 UPD42 MOV42 INS42 INS27 INS27 INS70 INS42 INS42 INS42 INS33 INS60 INS25 INS70 INS32 INS42 INS42 INS44 INS42 INS8 INS44 INS42 INS8 INS42 INS33 INS42 INS33 INS44 INS42 INS8 UPD74 MOV74 MOV59 INS27 INS8 INS44 INS42 INS8 INS42 INS42 INS32 INS43 INS42 INS25 INS43 INS42 INS25 UPD43 MOV43 UPD42 MOV42 INS60 INS25 UPD43 UPD42 INS42 INS33 INS70 INS43 INS42 INS60 INS25 INS42 INS42 INS42 INS32 INS8 INS42 INS32 INS8 UPD42 UPD43 MOV43 INS59 INS27 INS8 UPD42 UPD74 INS44 INS42 INS8 INS42 INS43 INS59 INS27 INS8 INS8 INS42 INS42 INS32 INS41 INS42 INS42 INS42 INS32 INS41 UPD42 UPD42 MOV42 INS32 UPD42 MOV42 MOV33 INS21 MOV21 UPD43 UPD43 MOV43 UPD42 MOV42 INS25 UPD42 MOV42 INS42 INS32 INS42 INS33 MOV60 MOV21 INS21 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS32 UPD42 UPD42 INS38 INS8 INS42 INS42 INS32 MOV43 INS32 UPD42 MOV42 UPD42 MOV42 INS32 UPD42 UPD42 INS32 INS32 INS21 INS42 INS42 UPD42 UPD42 INS42 INS42 INS33 INS42 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 INS42 INS42 INS32 INS32 MOV43 INS32 INS32 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL42 DEL78 DEL83 DEL43 DEL59 DEL23 DEL83 DEL23 DEL74 DEL42 DEL42 DEL42 DEL42 DEL32 DEL41 DEL8 DEL31 DEL43 DEL42 DEL42 DEL42 DEL42 DEL43 DEL42 DEL44 DEL44 DEL27 DEL32 DEL33 DEL16 DEL59 DEL60 DEL8 DEL42 DEL42 DEL42 DEL83 DEL39 DEL42 DEL44 DEL42 DEL44 DEL43 DEL42 DEL44 DEL8 DEL31 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL33 DEL27 DEL42 DEL42 DEL42 DEL32 DEL21 DEL8 DEL25