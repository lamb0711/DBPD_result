PR: MNG-680
set file in USD, don't return a dummy basedir if it is in the repository

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@280333 13f79535-47bb-0310-9956-ffa450edef68

-            project = processProjectLogic( pomLocation, project, repositories, profileManager );
+            project = processProjectLogic( pomLocation, project, repositories, profileManager, projectDir );
-                                              ProfileManager profileMgr )
+                                              ProfileManager profileMgr, File projectDir )
-        // FIXME: why is project.file not filled in here? MavenProject.getBasedir() defaults
-        // to the current directory which causes all sorts of problems; might be better off
-        // setting that to null and just filling in the project file name and removing this.
-
-        if ( pomLocation != null && new File( pomLocation ).getParent() != null )
+        if ( projectDir != null )
-            context.put( "basedir", new File( pomLocation ).getParent() );
-        }
-        else
-        {
-            context.put( "basedir", project.getBasedir() );
+            context.put( "basedir", projectDir.getAbsolutePath() );
-            File parentProjectDir = null;
+            File parentDescriptor = null;
-                File parentDescriptor = new File( projectDir, parentRelativePath );
+                parentDescriptor = new File( projectDir, parentRelativePath );
+                    boolean versionMatches = parentModel.getVersion().equals( candidateParent.getVersion() );
+                    if ( !versionMatches && candidateParent.getParent() != null )
+                    {
+                        versionMatches = parentModel.getVersion().equals( candidateParent.getParent().getVersion() );
+                    }
-                        parentModel.getArtifactId().equals( candidateParent.getArtifactId() ) && (
-                        parentModel.getVersion().equals( candidateParent.getVersion() ) || (
-                            candidateParent.getParent() != null &&
-                                parentModel.getVersion().equals( candidateParent.getParent().getVersion() ) ) ) )
+                        parentModel.getArtifactId().equals( candidateParent.getArtifactId() ) && versionMatches )
-                        parentProjectDir = parentDescriptor.getParentFile();
-
+            File parentProjectDir = null;
+            if ( parentDescriptor != null )
+            {
+                parentProjectDir = parentDescriptor.getParentFile();
+            }
+            parent.setFile( parentDescriptor );
-            project.setFile( new File( ".", "pom.xml" ) );
+            // TODO: remove - confirm this was a correct decision
+//            project.setFile( new File( ".", "pom.xml" ) );
-            project = processProjectLogic( "<Super-POM>", project, remoteRepositories, null );
+            project = processProjectLogic( "<Super-POM>", project, remoteRepositories, null, null );

INS44 MOV8 INS43 INS42 MOV25 MOV60 MOV60 MOV54 MOV60 MOV21 MOV21 MOV60 MOV41 INS42 INS27 MOV27 UPD42 MOV42 MOV33 MOV25 MOV21 MOV60 MOV60 MOV25 MOV60 INS25 MOV60 INS21 MOV21 MOV21 MOV27 INS27 INS8 INS32 INS33 INS21 MOV54 INS42 INS33 MOV21 INS42 INS42 INS42 INS42 UPD42 UPD42 INS7 MOV27 INS8 INS33 INS42 MOV14 MOV60 INS60 INS25 INS25 INS39 INS59 INS27 INS8 MOV27 MOV8 MOV8 INS42 MOV32 INS38 MOV27 INS21 INS42 INS42 INS7 INS42 MOV32 DEL27 DEL42 DEL43 DEL42 DEL14 DEL42 DEL32 DEL33 DEL27 DEL27 DEL42 DEL42 DEL45 DEL42 DEL43 DEL42 DEL14 DEL42 DEL32 DEL32 DEL21 DEL8 DEL27 DEL36 DEL27 DEL36 DEL25 DEL8 DEL42 DEL42 DEL42 DEL43 DEL45 DEL45 DEL14 DEL32 DEL21