[MNG-4312] Magic expressions injected by PluginParameterExpressionEvalutor conflict with expressions used by plugins to access system properties

git-svn-id: https://svn.apache.org/repos/asf/maven/components/trunk@806286 13f79535-47bb-0310-9956-ffa450edef68

-import org.codehaus.plexus.component.configurator.expression.ExpressionEvaluator;
+import org.codehaus.plexus.component.configurator.expression.TypeAwareExpressionEvaluator;
-    implements ExpressionEvaluator
+    implements TypeAwareExpressionEvaluator
+        return evaluate( expr, null );
+    }
+
+    public Object evaluate( String expr, Class<?> type )
+        throws ExpressionEvaluationException
+    {
+        /*
+         * MNG-4312: We neither have reserved all of the above magic expressions nor is their set fixed/well-known (it
+         * gets occasionally extended by newer Maven versions). This imposes the risk for existing plugins to
+         * unintentionally use such a magic expression for an ordinary system property. So here we check whether we
+         * ended up with a magic value that is not compatible with the type of the configured mojo parameter (a string
+         * could still be converted by the configurator so we leave those alone). If so, back off to evaluating the
+         * expression from properties only.
+         */
+        if ( value != null && type != null && !( value instanceof String ) && !type.isInstance( value ) )
+        {
+            value = null;
+        }
+

UPD40 UPD43 INS31 UPD42 INS83 INS43 INS42 INS44 INS43 INS8 INS44 INS42 INS43 INS42 INS42 INS41 INS74 INS42 INS25 INS42 INS32 INS43 INS76 INS27 INS8 INS42 INS42 INS33 INS42 INS27 INS38 INS21 INS27 INS38 INS32 INS7 INS27 INS27 INS36 INS42 INS42 INS42 INS42 INS33 INS42 INS33 INS42 INS33 INS62 INS42 INS43 INS42