o remove the profile manager and profile activation context from public view


git-svn-id: https://svn.apache.org/repos/asf/maven/components/branches/MNG-2766@775281 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.Properties;
+import org.apache.maven.profiles.ProfileActivationContext;
+        ProfileActivationContext profileActivationContext = new ProfileActivationContext( configuration.getExecutionProperties(), true );
+        profileActivationContext.setExplicitlyActiveProfileIds( configuration.getActiveProfileIds() );
+        if (configuration.getExecutionProperties() != null )
+        {
+            profileActivationContext.getExecutionProperties().putAll( configuration.getExecutionProperties() );
+        }
+        ProfileManager profileManager = new DefaultProfileManager( profileActivationContext );
+        
-            domainModel = build( "unknown", pomFile, configuration );
+            domainModel = build( "unknown", pomFile, profileManager, configuration );
+        //
+        // Active profiles can be contributed to the MavenExecutionRequest as well as from the POM
-        Properties props = new Properties();
-        props.putAll( configuration.getExecutionProperties() );
-            projectProfiles = DefaultProfileManager.getActiveProfilesFrom( configuration.getGlobalProfileManager(), props, domainModel.getModel() );
+            projectProfiles = new ArrayList<Profile>();            
+            profileManager.addProfiles( domainModel.getModel().getProfiles() );
+            if ( configuration.getProfiles() != null )
+            {
+                profileManager.addProfiles( configuration.getProfiles() );
+            }
+            projectProfiles.addAll( profileManager.getActiveProfiles() );                         
-            .setLocalRepository( localRepository )
-            .setGlobalProfileManager( profileManager );
+            .setLocalRepository( localRepository );
-    private DomainModel build( String projectId, File pomFile, ProjectBuilderConfiguration projectBuilderConfiguration )
+    private DomainModel build( String projectId, File pomFile, ProfileManager profileManager, ProjectBuilderConfiguration projectBuilderConfiguration )
-        List<String> activeProfileIds = ( projectBuilderConfiguration != null && projectBuilderConfiguration.getGlobalProfileManager() != null && projectBuilderConfiguration.getGlobalProfileManager()
-            .getProfileActivationContext() != null ) ? projectBuilderConfiguration.getGlobalProfileManager().getProfileActivationContext().getExplicitlyActiveProfileIds() : new ArrayList<String>();
+        List<String> activeProfileIds = ( projectBuilderConfiguration != null && profileManager != null && profileManager.getProfileActivationContext() != null ) ? profileManager
+            .getProfileActivationContext().getExplicitlyActiveProfileIds() : new ArrayList<String>();
-        List<String> inactiveProfileIds = ( projectBuilderConfiguration != null && projectBuilderConfiguration.getGlobalProfileManager() != null && projectBuilderConfiguration
-            .getGlobalProfileManager().getProfileActivationContext() != null ) ? projectBuilderConfiguration.getGlobalProfileManager().getProfileActivationContext().getExplicitlyInactiveProfileIds()
-                                                                              : new ArrayList<String>();
+        List<String> inactiveProfileIds = ( projectBuilderConfiguration != null && profileManager != null && profileManager.getProfileActivationContext() != null ) ? profileManager
+            .getProfileActivationContext().getExplicitlyInactiveProfileIds() : new ArrayList<String>();
-        MavenProject topProject = projectBuilderConfiguration.getTopLevelProjectFromReactor();
-        

MOV26 UPD40 MOV60 INS44 INS21 INS25 INS60 INS43 INS42 UPD43 INS32 INS27 INS8 INS43 INS59 INS8 INS42 MOV74 MOV74 UPD42 UPD42 INS42 INS42 INS32 INS32 INS33 MOV21 INS42 INS42 INS14 INS21 MOV21 INS25 INS21 MOV32 UPD43 INS32 INS9 INS42 INS42 INS42 INS42 INS43 INS42 INS7 INS32 INS27 INS8 INS32 MOV14 MOV14 UPD42 INS42 INS42 INS32 INS42 INS42 INS14 INS42 INS42 MOV32 MOV42 INS32 INS33 INS21 INS42 INS42 INS32 UPD42 MOV42 INS42 INS42 INS74 UPD42 INS42 INS42 INS32 INS42 INS42 UPD42 MOV42 UPD42 MOV42 INS43 INS43 INS42 INS42 INS32 MOV27 MOV27 INS42 INS42 INS42 INS42 INS42 UPD42 MOV42 INS42 UPD42 MOV42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL42 DEL7 DEL8 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL32 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL32 DEL42 DEL32 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60