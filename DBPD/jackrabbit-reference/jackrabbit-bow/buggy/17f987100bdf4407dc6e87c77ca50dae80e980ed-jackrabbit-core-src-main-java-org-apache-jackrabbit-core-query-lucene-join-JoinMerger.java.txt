JCR-2715: Improved join query performance

Improved row handling

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1023787 13f79535-47bb-0310-9956-ffa450edef68

-import javax.jcr.Node;
-import javax.jcr.Value;
-    private final String[] columnNames;
+    private final Map<String, PropertyValue> columns;
-    private final PropertyValue[] operands;
+    private final String[] columnNames;
+        this.columns = columns;
-        this.operands =
-            columns.values().toArray(new PropertyValue[columns.size()]);
-        Node[] nodes = new Node[selectorNames.length];
-        double[] scores = new double[selectorNames.length];
-        for (int i = 0; i < selectorNames.length; i++) {
-            String selector = selectorNames[i];
-            if (left != null && leftSelectors.contains(selector)) {
-                nodes[i] = left.getNode(selector);
-                scores[i] = left.getScore(selector);
-            } else if (right != null && rightSelectors.contains(selector)) {
-                nodes[i] = right.getNode(selector);
-                scores[i] = right.getScore(selector);
-            } else {
-                nodes[i] = null;
-                scores[i] = 0.0;
-            }
-        }
-
-        Value[] values = new Value[operands.length];
-        Row row = new SimpleRow(
-                columnNames, values, selectorNames, nodes, scores);
-        for (int i = 0; i < operands.length; i++) {
-            values[i] = evaluator.getValue(operands[i], row);
-        }
-
-        return row;
+        return new JoinRow(
+                columns, evaluator, left, leftSelectors, right, rightSelectors);
