[#JCR-168] Observation events are not triggered for intermediate nodes in version storage

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@219336 13f79535-47bb-0310-9956-ffa450edef68

-        recursiveAdd(events, (NodeImpl) vh.getParent(), vh);
+        NodeImpl parent = (NodeImpl) vh.getParent();
+        generateAddedEvents(events, parent, vh, true);
+        // in case the history was created 'deep' also add events for its ancestors
+        while (!parent.internalGetUUID().equals(historyRoot.getUUID())) {
+            NodeImpl child = parent;
+            parent = (NodeImpl) parent.getParent();
+            generateAddedEvents(events, parent, child, false);
+        }
-        recursiveAdd(events, (NodeImpl) v.getParent(), v);
+        generateAddedEvents(events, (NodeImpl) v.getParent(), v, true);
-        recursiveRemove(events, (NodeImpl) history, version);
+        generateRemovedEvents(events, (NodeImpl) history, version, true);
-    private void recursiveAdd(List events, NodeImpl parent, NodeImpl node)
+    private void generateAddedEvents(List events, NodeImpl parent, NodeImpl node,
+                                     boolean recursive)
-        NodeIterator niter = node.getNodes();
-        while (niter.hasNext()) {
-            NodeImpl n = (NodeImpl) niter.nextNode();
-            recursiveAdd(events, node, n);
+        if (recursive) {
+            NodeIterator niter = node.getNodes();
+            while (niter.hasNext()) {
+                NodeImpl n = (NodeImpl) niter.nextNode();
+                generateAddedEvents(events, node, n, true);
+            }
-    private void recursiveRemove(List events, NodeImpl parent, NodeImpl node)
+    private void generateRemovedEvents(List events, NodeImpl parent,
+                                       NodeImpl node, boolean recursive)
-        NodeIterator niter = node.getNodes();
-        while (niter.hasNext()) {
-            NodeImpl n = (NodeImpl) niter.nextNode();
-            recursiveRemove(events, node, n);
+        if (recursive) {
+            NodeIterator niter = node.getNodes();
+            while (niter.hasNext()) {
+                NodeImpl n = (NodeImpl) niter.nextNode();
+                generateRemovedEvents(events, node, n, true);
+            }
