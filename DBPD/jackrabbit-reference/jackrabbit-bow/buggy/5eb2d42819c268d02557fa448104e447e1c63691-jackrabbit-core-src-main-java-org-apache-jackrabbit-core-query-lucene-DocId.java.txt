JSR 283: Shareable nodes support in query

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@763188 13f79535-47bb-0310-9956-ffa450edef68

+    static final int[] EMPTY = new int[0];
+
-         * Always returns <code>-1</code>.
+         * Always returns an empty array.
-         * @return always <code>-1</code>.
+         * @param docNumbers a int array for reuse as return value.
+         * @return always an empty array.
-        final int getDocumentNumber(MultiIndexReader reader) {
-            return -1;
+        final int[] getDocumentNumbers(MultiIndexReader reader,
+                                       int[] docNumbers) {
+            return EMPTY;
-     * Returns the document number of this <code>DocId</code>. If this id is
-     * invalid <code>-1</code> is returned.
+     * Returns the document numbers of this <code>DocId</code>. An empty array
+     * is returned if this id is invalid.
-     * @param reader the IndexReader to resolve this <code>DocId</code>.
-     * @return the document number of this <code>DocId</code> or <code>-1</code>
-     *         if it is invalid (e.g. does not exist).
+     * @param reader     the IndexReader to resolve this <code>DocId</code>.
+     * @param docNumbers an array for reuse. An implementation should use the
+     *                   passed array as a container for the return value,
+     *                   unless the length of the returned array is different
+     *                   from <code>docNumbers</code>. In which case an
+     *                   implementation will create a new array with an
+     *                   appropriate size.
+     * @return the document numbers of this <code>DocId</code> or
+     *         empty if it is invalid (e.g. does not exist).
-    abstract int getDocumentNumber(MultiIndexReader reader) throws IOException;
+    abstract int[] getDocumentNumbers(MultiIndexReader reader, int[] docNumbers)
+            throws IOException;
+    /**
+     * Creates a <code>DocId</code> that references multiple UUIDs.
+     *
+     * @param uuids the UUIDs of the referenced nodes.
+     * @return a <code>DocId</code> based on multiple node UUIDs.
+     */
+    static DocId create(String[] uuids)  {
+        return new MultiUUIDDocId(uuids);
+    }
+
-        int getDocumentNumber(MultiIndexReader reader) {
-            return docNumber;
+        int[] getDocumentNumbers(MultiIndexReader reader, int[] docNumbers) {
+            if (docNumbers.length == 1) {
+                docNumbers[0] = docNumber;
+                return docNumbers;
+            } else {
+                return new int[]{docNumber};
+            }
-        int getDocumentNumber(MultiIndexReader reader) throws IOException {
+        int[] getDocumentNumbers(MultiIndexReader reader, int[] docNumbers)
+                throws IOException {
-            return realDoc;
+
+            if (docNumbers.length == 1) {
+                docNumbers[0] = realDoc;
+                return docNumbers;
+            } else {
+                return new int[]{realDoc};
+            }
-         * not known until resolved in {@link #getDocumentNumber(MultiIndexReader)}.
+         * not known until resolved in {@link #getDocumentNumbers(MultiIndexReader,int[])}.
+
+    /**
+     * A DocId based on multiple UUIDDocIds.
+     */
+    private static final class MultiUUIDDocId extends DocId {
+
+        /**
+         * The internal uuid based doc ids.
+         */
+        private final UUIDDocId[] docIds;
+
+        /**
+         * @param uuids the uuids of the referenced nodes.
+         * @throws IllegalArgumentException if one of the uuids is malformed.
+         */
+        MultiUUIDDocId(String[] uuids) {
+            this.docIds = new UUIDDocId[uuids.length];
+            for (int i = 0; i < uuids.length; i++) {
+                docIds[i] = new UUIDDocId(UUID.fromString(uuids[i]));
+            }
+        }
+
+        /**
+         * @inheritDoc
+         */
+        int[] getDocumentNumbers(MultiIndexReader reader, int[] docNumbers)
+                throws IOException {
+            int[] tmp = new int[1];
+            docNumbers = new int[docIds.length];
+            for (int i = 0; i < docNumbers.length; i++) {
+                docNumbers[i] = docIds[i].getDocumentNumbers(reader, tmp)[0];
+            }
+            return docNumbers;
+        }
+
+        /**
+         * This implementation will return <code>this</code>. Document number is
+         * not known until resolved in {@link #getDocumentNumbers(MultiIndexReader,int[])}.
+         *
+         * @inheritDoc
+         */
+        DocId applyOffset(int offset) {
+            return this;
+        }
+
+        /**
+         * Always returns <code>true</code>.
+         *
+         * @param deleted the deleted documents.
+         * @return always <code>true</code>.
+         */
+        boolean isValid(BitSet deleted) {
+            return true;
+        }
+
+        /**
+         * Returns a String representation for this <code>DocId</code>.
+         *
+         * @return a String representation for this <code>DocId</code>.
+         */
+        public String toString() {
+            StringBuffer sb = new StringBuffer("MultiUUIDDocId(");
+            String separator = "";
+            for (int i = 0; i < docIds.length; i++) {
+                sb.append(separator);
+                separator = ", ";
+                sb.append(new UUID(docIds[i].msb, docIds[i].lsb));
+            }
+            sb.append(")");
+            return sb.toString();
+        }
+    }
