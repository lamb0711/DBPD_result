JCR-2646 : AccessControlManager#getEffectivePolicies(String) may expose AC content without proper permissions
JCR-2657 : DefaultAccessManager#hasPrivileges(String,Set,Privilege[]) doesn't close compiled permissions
JCR-2649 : Provide means to display the effective policies for a given set of principals

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@954964 13f79535-47bb-0310-9956-ffa450edef68

-     * @see AccessControlProvider#getEffectivePolicies(Path)
+     * @see AccessControlProvider#getEffectivePolicies(org.apache.jackrabbit.spi.Path,org.apache.jackrabbit.core.security.authorization.CompiledPermissions)
-    public AccessControlPolicy[] getEffectivePolicies(Path absPath)
+    public AccessControlPolicy[] getEffectivePolicies(Path absPath, CompiledPermissions permissions)
-            l.addAll(Arrays.asList(provider.getEffectivePolicies(absPath)));
+            l.addAll(Arrays.asList(provider.getEffectivePolicies(absPath, permissions)));
+        }
+        return l.toArray(new AccessControlPolicy[l.size()]);
+    }
+
+    /**
+     * @see AccessControlProvider#getEffectivePolicies(java.util.Set, CompiledPermissions)
+     */
+    public AccessControlPolicy[] getEffectivePolicies(Set<Principal> principals, CompiledPermissions permissions) throws RepositoryException {
+        List<AccessControlPolicy> l = new ArrayList<AccessControlPolicy>();
+        for (AccessControlProvider provider : providers) {
+            l.addAll(Arrays.asList(provider.getEffectivePolicies(principals, permissions)));
