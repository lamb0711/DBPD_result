JCR-193, JCR-216, JCR-203, JCR 184 + various minor fixes

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@293331 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.webdav.DavConstants;
-import org.apache.jackrabbit.webdav.DavException;
-import org.apache.jackrabbit.webdav.DavLocatorFactory;
-import org.apache.jackrabbit.webdav.DavMethods;
-import org.apache.jackrabbit.webdav.DavResource;
-import org.apache.jackrabbit.webdav.DavResourceFactory;
-import org.apache.jackrabbit.webdav.DavServletResponse;
-import org.apache.jackrabbit.webdav.DavSessionProvider;
-import org.apache.jackrabbit.webdav.MultiStatus;
-import org.apache.jackrabbit.webdav.WebdavRequest;
-import org.apache.jackrabbit.webdav.WebdavRequestImpl;
-import org.apache.jackrabbit.webdav.WebdavResponse;
-import org.apache.jackrabbit.webdav.WebdavResponseImpl;
+import org.apache.jackrabbit.webdav.*;
-import org.apache.jackrabbit.webdav.property.DavProperty;
-import org.apache.jackrabbit.webdav.property.DavPropertyName;
-import org.apache.jackrabbit.webdav.property.DavPropertyNameSet;
-import org.apache.jackrabbit.webdav.property.DavPropertySet;
+import org.apache.jackrabbit.webdav.property.*;
-                webdavResponse.sendErrorResponse(e);
+                webdavResponse.sendError(e);
-        response.sendMultiStatusResponse(mstatus);
+        response.sendMultiStatus(mstatus);
-        // first resolve merge conflicts
-        // TODO: not correct resolution of merge conflicts are immediately perstisted
-        // TODO: rfc 2518 requires, that no changes must only be persisted if the complete proppatch-req succeeds
-        if (resource instanceof VersionControlledResource) {
-            ((VersionControlledResource) resource).resolveMergeConflict(setProperties, removeProperties);
+        MultiStatus ms = new MultiStatus();
+        try {
+            MultiStatusResponse msr = resource.alterProperties(setProperties, removeProperties);
+            ms.addResponse(msr);
+        } catch (DavException e) {
+            /* NOTE: known bug with litmus, which expects the exception (e.g. 423)
+               to the set instead of the MultiStatus Code. RFC 2518 explicitely
+               expects the errors to be included in the multistatus.
+               Remove the catch if this turns out to be an problem with clients
+               in general. */
+            ms.addResourceStatus(resource, e.getErrorCode(), DEPTH_0);
-
-        // complete any other property setting or removing
-        resource.alterProperties(setProperties, removeProperties);
-        response.setStatus(DavServletResponse.SC_OK);
-
-        // todo return multistatus response in case of failure
+        response.sendMultiStatus(ms);
+        // shortcut: mkcol is only allowed on deleted/non-existing resources
+        if (resource.exists()) {
+            response.sendError(DavServletResponse.SC_METHOD_NOT_ALLOWED);
+        }
-     * 
+     *
-                
-                // todo: do not ignore etag
-                if (request.matchesIfHeader(resource.getHref(), activeLocks[i].getToken(), "")) {
+
+                DavProperty etagProp = resource.getProperty(DavPropertyName.GETETAG);
+                String etag = etagProp != null ? String.valueOf(etagProp.getValue()) : "";
+                if (request.matchesIfHeader(resource.getHref(), activeLocks[i].getToken(), etag)) {
-
-        // TODO multistatus in case of failure...
-        // NOTE: spec says 409 status, but example says 207 (multistatus)
-
-        //TODO: in case of failure Multistatus is required...
-        response.sendMultiStatusResponse(ms);
+        response.sendMultiStatus(ms);
-        response.sendMultiStatusResponse(ms);
+        response.sendMultiStatus(ms);
-                response.sendMultiStatusResponse(((SearchResource) resource).search(sR));
+                response.sendMultiStatus(((SearchResource) resource).search(sR));
-                response.sendMultiStatusResponse(((SearchResource) resource).search(null));
+                response.sendMultiStatus(((SearchResource) resource).search(null));
