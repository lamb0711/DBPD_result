Added ItemStateManager#hasNodeReferences()
Added check for targets of modified node references in XAResource#prepare
Removed duplicated checkLock() in NodeImpl#addMixin


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@164071 13f79535-47bb-0310-9956-ffa450edef68

-                try {
-                    NodeReferencesId refsId = new NodeReferencesId(targetState.getUUID());
-                    NodeReferences refs = stateMgr.getNodeReferences(refsId);
-                    if (refs.hasReferences()) {
-                        throw new ReferentialIntegrityException(hierMgr.safeGetJCRPath(targetId)
-                                + ": cannot remove node with references");
+                NodeReferencesId refsId = new NodeReferencesId(targetState.getUUID());
+                if (stateMgr.hasNodeReferences(refsId)) {
+                    try {
+                        NodeReferences refs = stateMgr.getNodeReferences(refsId);
+                        if (refs.hasReferences()) {
+                            throw new ReferentialIntegrityException(
+                                    hierMgr.safeGetJCRPath(targetId) +
+                                    ": cannot remove node with references");
+                        }
+                    } catch (ItemStateException ise) {
+                        String msg = "internal error: failed to check references on "
+                                + hierMgr.safeGetJCRPath(targetId);
+                        log.error(msg, ise);
+                        throw new RepositoryException(msg, ise);
-                } catch (ItemStateException ise) {
-                    String msg = "internal error: failed to check references on "
-                            + hierMgr.safeGetJCRPath(targetId);
-                    log.error(msg, ise);
-                    throw new RepositoryException(msg, ise);
