JCR-2706 - Evaluate if membershipcache (JCR-2703) obsoletes the cache in DefaultPrincipalProvider

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@985147 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.commons.collections.map.LRUMap;
-import java.util.Map;
-     * a cache for group memberships: maps principal-name to a set of principals
-     * representing the members.
-     */
-    private final Map<String, Set<Principal>> membershipCache;
-
-    /**
-
-    private final String pMembers;
-        membershipCache = new LRUMap();
-        // listen to modifications of group-membership
-        String[] ntNames = new String[2];
+        String[] ntNames = new String[1];
-            ntNames[0] = resolver.getJCRName(UserManagerImpl.NT_REP_GROUP);
-            ntNames[1] = resolver.getJCRName(UserManagerImpl.NT_REP_AUTHORIZABLE_FOLDER);
-            pMembers = resolver.getJCRName(UserManagerImpl.P_MEMBERS);
+            ntNames[0] = resolver.getJCRName(UserManagerImpl.NT_REP_AUTHORIZABLE_FOLDER);
-            ntNames[0] = "rep:Group";
-            ntNames[1] = "rep:AuthorizableFolder";
-            pMembers = "rep:members";
+            ntNames[0] = "rep:AuthorizableFolder";
-                Event.NODE_ADDED | Event.NODE_REMOVED | Event.PROPERTY_ADDED | Event.PROPERTY_CHANGED | Event.PROPERTY_REMOVED,
-                targetPath,
-                true,
-                null,
-                ntNames,
-                false);
+                Event.NODE_ADDED | Event.NODE_REMOVED, targetPath, true, null, ntNames, false);
-        Set<Principal> mship;
-        synchronized (membershipCache) {
-            mship = membershipCache.get(userPrincipal.getName());
-            if (mship == null) {
-                // recursively collect group membership
-                mship = collectGroupMembership(userPrincipal);
-
-                // make sure everyone-group is not missing
-                if (!mship.contains(everyonePrincipal) && everyonePrincipal.isMember(userPrincipal)) {
-                    mship.add(everyonePrincipal);
-                }
-                membershipCache.put(userPrincipal.getName(), mship);
-            }
+        Set<Principal> mship = collectGroupMembership(userPrincipal);
+        // make sure everyone-group is not missing
+        if (!mship.contains(everyonePrincipal) && everyonePrincipal.isMember(userPrincipal)) {
+            mship.add(everyonePrincipal);
-        membershipCache.clear();
-
-        // membership cache:
-        while (eventIterator.hasNext()) {
-            Event ev = eventIterator.nextEvent();
-            int type = ev.getType();
-            if (type == Event.PROPERTY_ADDED || type == Event.PROPERTY_CHANGED
-                    || type == Event.PROPERTY_REMOVED) {
-                try {
-                    if (pMembers.equals(Text.getName(ev.getPath()))) {
-                        synchronized (membershipCache) {
-                            membershipCache.clear();
-                        }
-                        break;
-                    }
-                } catch (RepositoryException e) {
-                    // should never get here
-                    log.warn(e.getMessage());
-                }
-            }
-        }
