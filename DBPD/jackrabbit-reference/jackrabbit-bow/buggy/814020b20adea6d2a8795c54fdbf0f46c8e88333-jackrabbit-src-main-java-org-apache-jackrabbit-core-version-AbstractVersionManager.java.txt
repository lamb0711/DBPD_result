JCR-455: InternalXAResource.rollback() can be called twice and without prepare
JCR-414: jcr:successors property not persisted correctly within a transaction


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@412995 13f79535-47bb-0310-9956-ffa450edef68

+ * <p/>
+ * All read operations must aquire the read lock before reading, all write
+ * operations must aquire the write lock.
+        // lock handling via getItem()
-
+        // lock handling via getItem()
+        // lock handling via hasItem()
+        // lock handling via hasItem()
-
-        NodeId vhId = getVersionHistoryId(node);
-        if (vhId == null) {
-            return null;
+        aquireReadLock();
+        try {
+            NodeId vhId = getVersionHistoryId(node);
+            if (vhId == null) {
+                return null;
+            }
+            return (VersionHistory) ((SessionImpl) session).getNodeById(vhId);
+        } finally {
+            releaseReadLock();
-        return (VersionHistory) ((SessionImpl) session).getNodeById(vhId);
+     * <p/>
+     * Please note, that the overridden method must aquire the readlock before
+     * reading the state manager.
+     *
+     * <p/>
+     * Please note, that the overridden method must aquire the readlock before
+     * reading the state manager.
+     *
-    NodeId getVersionHistoryId(NodeState node) throws RepositoryException {
-
+    private NodeId getVersionHistoryId(NodeState node)
+            throws RepositoryException {
