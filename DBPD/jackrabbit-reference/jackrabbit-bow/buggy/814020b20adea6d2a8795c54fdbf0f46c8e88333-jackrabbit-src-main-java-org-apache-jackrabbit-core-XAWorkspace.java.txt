JCR-455: InternalXAResource.rollback() can be called twice and without prepare
JCR-414: jcr:successors property not persisted correctly within a transaction


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@412995 13f79535-47bb-0310-9956-ffa450edef68

+     * the name of the workspace info attribute in the transaction context
+     */
+    private static final String ATTR_NAME_WORKSPACE_INFO =
+            RepositoryImpl.WorkspaceInfo.class.getName();
+
+    /**
-
-            public void prepare(TransactionContext tx) throws TransactionException {
+            public void prepare(TransactionContext tx)
+                    throws TransactionException {
-                    rep.getWorkspaceInfo(wspConfig.getName()).lockAcquire();
+                    RepositoryImpl.WorkspaceInfo wspInfo =
+                            rep.getWorkspaceInfo(wspConfig.getName());
+                    wspInfo.lockAcquire();
+                    tx.setAttribute(ATTR_NAME_WORKSPACE_INFO, wspInfo);
-            public void commit(TransactionContext tx) throws TransactionException {
-                try {
-                    rep.getWorkspaceInfo(wspConfig.getName()).lockRelease();
-                } catch (NoSuchWorkspaceException e) {
-                    throw new TransactionException("Error while commit transaction", e);
+            public void commit(TransactionContext tx) {
+                RepositoryImpl.WorkspaceInfo wspInfo =
+                        (RepositoryImpl.WorkspaceInfo)
+                                tx.getAttribute(ATTR_NAME_WORKSPACE_INFO);
+                if (wspInfo != null) {
+                    wspInfo.lockRelease();
+                    tx.removeAttribute(ATTR_NAME_WORKSPACE_INFO);
-            public void rollback(TransactionContext tx) throws TransactionException {
-                try {
-                    rep.getWorkspaceInfo(wspConfig.getName()).lockRelease();
-                } catch (NoSuchWorkspaceException e) {
-                    throw new TransactionException("Error while rollback transaction", e);
+            public void rollback(TransactionContext tx) {
+                RepositoryImpl.WorkspaceInfo wspInfo =
+                        (RepositoryImpl.WorkspaceInfo)
+                                tx.getAttribute(ATTR_NAME_WORKSPACE_INFO);
+                if (wspInfo != null) {
+                    wspInfo.lockRelease();
+                    tx.removeAttribute(ATTR_NAME_WORKSPACE_INFO);
-}
-
+}
