JCR-2140: Baselines & Configurations


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@797094 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.Arrays;
-import java.util.HashSet;
-            if (child.getState().getMixinTypeNames().contains(NameConstants.REP_BASELINE)) {
-                v = new InternalBaselineImpl(this, child, child.getName());
-            } else {
-                v = new InternalVersionImpl(this, child, child.getName());
+            try {
+                NodeStateEx frozen = child.getNode(NameConstants.JCR_FROZENNODE, 1);
+                Name frozenType = frozen.getPropertyValue(NameConstants.JCR_FROZENPRIMARYTYPE).getName();
+                if (NameConstants.NT_CONFIGURATION.equals(frozenType)) {
+                    v = new InternalBaselineImpl(this, child, child.getName());
+                } else {
+                    v = new InternalVersionImpl(this, child, child.getName());
+                }
+            } catch (RepositoryException e) {
+                throw new InternalError("Version does not have a jcr:frozenNode: " + child.getNodeId());
-     * @param configuration the set of versions in case a configuration is checked in
-    InternalVersionImpl checkin(Name name, NodeStateEx src, Set<NodeId> configuration)
+    InternalVersionImpl checkin(Name name, NodeStateEx src)
-        // check configuration
-        if (configuration != null) {
-            vNode.setMixins(new HashSet<Name>(Arrays.asList(NameConstants.REP_BASELINE)));
-            InternalValue[] values = new InternalValue[configuration.size()];
-            int i=0;
-            for (NodeId id: configuration) {
-                values[i++] = InternalValue.create(id);
-            }
-            vNode.setPropertyValues(NameConstants.REP_BASEVERSIONS, PropertyType.REFERENCE, values, true);
-        }
-        InternalVersionImpl version = configuration == null
-                ? new InternalVersionImpl(this, vNode, name)
-                : new InternalBaselineImpl(this, vNode, name);
+        boolean isConfiguration = src.getEffectiveNodeType().includesNodeType(NameConstants.NT_CONFIGURATION);
+        InternalVersionImpl version = isConfiguration
+                ? new InternalBaselineImpl(this, vNode, name)
+                : new InternalVersionImpl(this, vNode, name);
-        if (nodeState.getNodeTypeName().equals(NameConstants.NT_CONFIGURATION)) {
-            // add baseline mixin for configurations
-            vNode.setMixins(new HashSet<Name>(Arrays.asList(NameConstants.REP_BASELINE)));
-        }
