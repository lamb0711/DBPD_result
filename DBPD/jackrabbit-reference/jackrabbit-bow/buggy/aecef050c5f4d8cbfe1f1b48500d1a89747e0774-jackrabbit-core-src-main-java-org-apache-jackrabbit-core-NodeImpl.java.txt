JCR-2650: don't silently merge session-local transient changes with external changes before save().

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@966697 13f79535-47bb-0310-9956-ffa450edef68

-        NodeState persistentState = (NodeState) transientState.getOverlayedState();
-        if (persistentState == null) {
+        NodeState localState = (NodeState) transientState.getOverlayedState();
+        if (localState == null) {
-            persistentState = stateMgr.createNew(transientState);
+            localState = stateMgr.createNew(transientState);
-        synchronized (persistentState) {
-            // check staleness of transient state first
-            if (transientState.isStale()) {
-                String msg =
-                    this + ": the node cannot be saved because it has been"
-                    + " modified externally.";
-                log.debug(msg);
-                throw new InvalidItemStateException(msg);
-            }
+        synchronized (localState) {
-            persistentState.setParentId(transientState.getParentId());
+            localState.setParentId(transientState.getParentId());
-            persistentState.setNodeTypeName(transientState.getNodeTypeName());
+            localState.setNodeTypeName(transientState.getNodeTypeName());
-            persistentState.setMixinTypeNames(transientState.getMixinTypeNames());
+            localState.setMixinTypeNames(transientState.getMixinTypeNames());
-            persistentState.setChildNodeEntries(transientState.getChildNodeEntries());
+            localState.setChildNodeEntries(transientState.getChildNodeEntries());
-            persistentState.setPropertyNames(transientState.getPropertyNames());
+            localState.setPropertyNames(transientState.getPropertyNames());
-            persistentState.setSharedSet(transientState.getSharedSet());
+            localState.setSharedSet(transientState.getSharedSet());
+            // modCount
+            if (localState.getModCount() != transientState.getModCount()) {
+                localState.setModCount(transientState.getModCount());
+            }
-            stateMgr.store(persistentState);
+            stateMgr.store(localState);
-        // swap transient state with persistent state
-        data.setState(persistentState);
+        // swap transient state with local state
+        data.setState(localState);
-            data.setPrimaryParentId(persistentState.getParentId());
+            data.setPrimaryParentId(localState.getParentId());
