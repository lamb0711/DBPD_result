JCR-2547: Setting a property which has been transiently removed fails with a PathNotFoundException


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@921779 13f79535-47bb-0310-9956-ffa450edef68

-            setProperty(p, value);
+            setProperty(p, value, false);
-            setProperty(p, values);
+            setProperty(p, values, false);
-            setProperty(getPath(propertyId, sessionInfo), value);
+            Path p = getPath(propertyId, sessionInfo);
+            setProperty(p, value, false);
-            setProperty(p, values);
+            setProperty(p, values, false);
+            // clear the uri-lookup in case the itemID contains a uniqueID part.
-            addProperty(nodeId, NameConstants.JCR_MIXINTYPES, vs);
+            Path p = getPathFactory().create(getPath(nodeId, sessionInfo), NameConstants.JCR_MIXINTYPES, true);
+            // register the diff entry including clearing previous calls to
+            // setMixins for the same node.
+            setProperty(p, vs, true);
-            addProperty(nodeId, NameConstants.JCR_PRIMARYTYPE, v);
+            Path p = getPathFactory().create(getPath(nodeId, sessionInfo), NameConstants.JCR_PRIMARYTYPE, true);
+            // register the diff entry including clearing previous calls to
+            // setPrimaryType for the same node.
+            setProperty(p, v, true);
-        private void setProperty(Path propPath, QValue value) throws RepositoryException {
+        private void setProperty(Path propPath, QValue value, boolean clearPrevious) throws RepositoryException {
-            clearPreviousSetProperty(jcrPropPath);
+            if (clearPrevious) {
+                clearPreviousSetProperty(jcrPropPath);
+            }
-        private void setProperty(Path propPath, QValue[] values) throws RepositoryException {
+        private void setProperty(Path propPath, QValue[] values, boolean clearPrevious) throws RepositoryException {
-            clearPreviousSetProperty(jcrPropPath);
+            if (clearPrevious) {
+                clearPreviousSetProperty(jcrPropPath);
+            }
