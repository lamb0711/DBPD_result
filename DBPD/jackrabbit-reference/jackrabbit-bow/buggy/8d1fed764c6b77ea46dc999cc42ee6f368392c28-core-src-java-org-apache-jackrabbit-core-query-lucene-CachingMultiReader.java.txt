JCR-178: Allow concurrent index updates and queries

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@232801 13f79535-47bb-0310-9956-ffa450edef68

+     * Reference count. Every time close is called refCount is decremented. If
+     * refCount drops to zero the underlying readers are closed as well.
+     */
+    private int refCount = 1;
+
+    /**
-     * {@link CachingIndexReader}. The single allowed sub reader not of type
-     * {@link CachingIndexReader} must be the last reader in
+     * {@link ReadOnlyIndexReader}. The single allowed sub reader not of type
+     * {@link ReadOnlyIndexReader} must be the last reader in
-        // check readers, all but last must be a CachingIndexReader
+        // check readers, all but last must be a ReadOnlyIndexReader
-            if (!(subReaders[i] instanceof CachingIndexReader)) {
-                throw new IllegalArgumentException("subReader " + i + " must be of type CachingIndexReader");
+            if (!(subReaders[i] instanceof ReadOnlyIndexReader)) {
+                throw new IllegalArgumentException("subReader " + i + " must be of type ReadOnlyIndexReader");
+     * Increments the reference count of this reader. Each call to this method
+     * must later be acknowledged by a call to {@link #close()}
+     */
+    synchronized void incrementRefCount() {
+        refCount++;
+    }
+
+    /**
+     * Decrements the reference count and closes the underlying readers if this
+     * reader is not in use anymore.
+     * @throws IOException if an error occurs while closing this reader.
+     */
+    protected synchronized void doClose() throws IOException {
+        if (--refCount == 0) {
+            super.doClose();
+        }
+    }
+
+    /**
