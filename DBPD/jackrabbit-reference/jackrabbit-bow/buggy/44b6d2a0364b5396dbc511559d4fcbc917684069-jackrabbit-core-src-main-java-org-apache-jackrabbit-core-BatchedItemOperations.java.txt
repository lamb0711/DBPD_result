JCR-1775: Transaction-safe versioning

Avoid instantiating full VersionHistoryImpl objects when all we need are the identifiers of the version history and root version nodes.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@702453 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.version.VersionHistoryInfo;
-import javax.jcr.version.VersionHistory;
-                        VersionHistory vh =
+                        VersionHistoryInfo history =
-                        newChildState.setValues(new InternalValue[]{InternalValue.create(new UUID(vh.getUUID()))});
-                    } else if (propName.equals(NameConstants.JCR_BASEVERSION)) {
-                        // jcr:baseVersion
-                        VersionHistory vh =
+                        InternalValue value = InternalValue.create(
+                                history.getVersionHistoryId().getUUID());
+                        newChildState.setValues(new InternalValue[] { value });
+                    } else if (propName.equals(NameConstants.JCR_BASEVERSION)
+                            || propName.equals(NameConstants.JCR_PREDECESSORS)) {
+                        // jcr:baseVersion or jcr:predecessors
+                        VersionHistoryInfo history =
-                        newChildState.setValues(new InternalValue[]{InternalValue.create(new UUID(vh.getRootVersion().getUUID()))});
-                    } else if (propName.equals(NameConstants.JCR_PREDECESSORS)) {
-                        // jcr:predecessors
-                        VersionHistory vh =
-                            manager.getVersionHistory(session, newState);
-                        newChildState.setValues(new InternalValue[]{InternalValue.create(new UUID(vh.getRootVersion().getUUID()))});
+                        InternalValue value = InternalValue.create(
+                                history.getRootVersionId().getUUID());
+                        newChildState.setValues(new InternalValue[] { value });
