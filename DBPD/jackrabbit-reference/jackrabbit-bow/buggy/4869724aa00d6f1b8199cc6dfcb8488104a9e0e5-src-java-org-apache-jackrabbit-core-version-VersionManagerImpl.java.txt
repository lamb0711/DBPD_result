- moved virtual nodestate providers down to shared states (part of solving JCR-45)

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@156034 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.nodetype.NodeTypeManagerImpl;
+import org.apache.jackrabbit.core.nodetype.NodeTypeRegistry;
+import org.apache.jackrabbit.core.state.ItemStateException;
-    private NodeTypeManagerImpl ntMgr;
+    private NodeTypeRegistry ntReg;
-    public VersionManagerImpl(PersistentVersionManager vMgr, String rootUUID) {
+    public VersionManagerImpl(PersistentVersionManager vMgr, NodeTypeRegistry ntReg, String rootUUID) {
+        this.ntReg = ntReg;
-    public synchronized VirtualItemStateProvider getVirtualItemStateProvider(SessionImpl session, ItemStateManager base) {
+    public synchronized VirtualItemStateProvider getVirtualItemStateProvider(ItemStateManager base) {
-                ntMgr = session.getNodeTypeManager();
-                virtProvider = new VersionItemStateProvider(this, ntMgr, VERSION_STORAGE_NODE_UUID, virtRootState.getParentUUID());
+                virtProvider = new VersionItemStateProvider(this, ntReg, VERSION_STORAGE_NODE_UUID, virtRootState.getParentUUID());
-     * returns the node type manager
-     *
-     * @return
-     */
-    NodeTypeManagerImpl getNodeTypeManager() {
-        return ntMgr;
-    }
-
-    /**
+        try {
+            virtProvider.getItemState(new NodeId(VERSION_STORAGE_NODE_UUID)).discard();
+        } catch (ItemStateException e) {
+            e.printStackTrace();  //To change body of catch statement use File | Settings | File Templates.
+        }
+        try {
+            virtProvider.getItemState(new NodeId(version.getVersionHistory().getId())).discard();
+        } catch (ItemStateException e) {
+            e.printStackTrace();  //To change body of catch statement use File | Settings | File Templates.
+        }
