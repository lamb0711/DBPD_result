JCR-264: TextFilters get called three times within checkin()

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@392211 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.InputStream;
+import org.xml.sax.SAXException;
-        ZipInputStream zis = null;
-            BLOBFileValue blob = (BLOBFileValue) values[0].internalValue();
+            final BLOBFileValue blob = (BLOBFileValue) values[0].internalValue();
-            try {
-                zis = new ZipInputStream(blob.getStream());
-                ZipEntry ze = zis.getNextEntry();
-                while (!ze.getName().equals("content.xml"))
-                    ze = zis.getNextEntry();
-                OOoContentHandler contentHandler = new OOoContentHandler();
-                xmlReader.setContentHandler(contentHandler);
-                xmlReader.parse(new InputSource(zis));
-                zis.close();
-
-                Map result = new HashMap();
-                result.put(FieldNames.FULLTEXT, new StringReader(contentHandler.getContent()));
-                return result;
-            } catch (Exception ex) {
-                throw new RepositoryException(ex);
-            } finally {
-                if (zis != null) {
+            LazyReader reader = new LazyReader() {
+                protected void initializeReader() throws IOException {
+                    InputStream in;
-                        zis.close();
-                    } catch (IOException ioe) {
-                        ioe.printStackTrace();
+                        in = blob.getStream();
+                    } catch (RepositoryException e) {
+                        throw new IOException(e.getMessage());
+                    }
+                    try {
+                        ZipInputStream zis = new ZipInputStream(in);
+                        ZipEntry ze = zis.getNextEntry();
+                        while (!ze.getName().equals("content.xml")) {
+                            ze = zis.getNextEntry();
+                        }
+                        OOoContentHandler contentHandler = new OOoContentHandler();
+                        xmlReader.setContentHandler(contentHandler);
+                        try {
+                            xmlReader.parse(new InputSource(zis));
+                        } catch (SAXException e) {
+                            throw new IOException(e.getMessage());
+                        } finally {
+                            zis.close();
+                        }
+
+                        delegate = new StringReader(contentHandler.getContent());
+                    } finally {
+                        in.close();
-            }
+            };
+
+            Map result = new HashMap();
+            result.put(FieldNames.FULLTEXT, reader);
+            return result;
