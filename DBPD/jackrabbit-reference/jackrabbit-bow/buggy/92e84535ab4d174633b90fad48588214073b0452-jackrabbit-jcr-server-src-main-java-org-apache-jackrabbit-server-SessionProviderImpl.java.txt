JCR-2539: spi2dav: Observation's user data not property handled

User Data is transported in a Link header field using a JCR-specific extension link relation and a "data" URI.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1200319 13f79535-47bb-0310-9956-ffa450edef68

+import java.net.URI;
+import java.net.URISyntaxException;
+import java.util.Enumeration;
+import java.util.Locale;
+
+import org.apache.jackrabbit.commons.webdav.JcrRemotingConstants;
+import org.apache.jackrabbit.util.Text;
+import org.apache.jackrabbit.webdav.util.LinkHeaderFieldParser;
+
+     * 
-    public Session getSession(HttpServletRequest request, Repository repository,
-                              String workspace)
-        throws LoginException, RepositoryException, ServletException {
+    public Session getSession(HttpServletRequest request,
+            Repository repository, String workspace) throws LoginException,
+            RepositoryException, ServletException {
+        Session s;
-            return repository.login(workspace);
+            s = repository.login(workspace);
-            return repository.login(creds, workspace);
+            s = repository.login(creds, workspace);
+        String userData = getJcrUserData(request);
+        s.getWorkspace().getObservationManager().setUserData(userData);
+        return s;
+
+    // find first link relation for JCR User Data
+    private String getJcrUserData(HttpServletRequest request) {
+        String jcrUserData = null;
+        Enumeration<?> fieldValues = request.getHeaders("link");
+        if (fieldValues.hasMoreElements()) {
+            LinkHeaderFieldParser lhfp = new LinkHeaderFieldParser(fieldValues);
+            String target = lhfp
+                    .getFirstTargetForRelation(JcrRemotingConstants.RELATION_USER_DATA);
+            if (target != null) {
+                jcrUserData = getJcrUserData(target);
+            }
+        }
+        return jcrUserData;
+    }
+
+    // extracts User Data string from RFC 2397 "data" URI
+    // only supports the simple case of "data:,..." for now
+    private String getJcrUserData(String target) {
+        try {
+            URI datauri = new URI(target);
+
+            String scheme = datauri.getScheme();
+
+            // Poor Man's data: URI parsing
+            if (scheme != null
+                    && "data".equals(scheme.toLowerCase(Locale.ENGLISH))) {
+
+                String sspart = datauri.getRawSchemeSpecificPart();
+
+                if (sspart.startsWith(",")) {
+                    return Text.unescape(sspart.substring(1));
+                }
+            }
+        } catch (URISyntaxException ex) {
+            // not a URI, skip
+        }
+
+        return null;
+    }
