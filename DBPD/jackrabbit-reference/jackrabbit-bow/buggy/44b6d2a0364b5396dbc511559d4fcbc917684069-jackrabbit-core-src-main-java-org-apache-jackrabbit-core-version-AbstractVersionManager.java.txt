JCR-1775: Transaction-safe versioning

Avoid instantiating full VersionHistoryImpl objects when all we need are the identifiers of the version history and root version nodes.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@702453 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.SessionImpl;
-import javax.jcr.version.VersionHistory;
-    public VersionHistory getVersionHistory(Session session, NodeState node)
+    public VersionHistoryInfo getVersionHistory(Session session, NodeState node)
-        NodeId id = null;
+        VersionHistoryInfo info = null;
-                id = parent.getState().getChildNodeEntry(name, 1).getId();
+                NodeStateEx history = parent.getNode(name, 1);
+                Name root = NameConstants.JCR_ROOTVERSION;
+                info = new VersionHistoryInfo(
+                        history.getNodeId(),
+                        history.getState().getChildNodeEntry(root, 1).getId());
-        if (id == null) {
-            id = createVersionHistory(session, node);
+        if (info == null) {
+            info = createVersionHistory(session, node);
-        return (VersionHistory) ((SessionImpl) session).getNodeById(id);
+        return info;
-    protected abstract NodeId createVersionHistory(
+    protected abstract VersionHistoryInfo createVersionHistory(
-     * @return the newly created version history.
+     * @return the identifiers of the newly created version history and root version
-    InternalVersionHistory createVersionHistory(NodeState node)
+    NodeStateEx createVersionHistory(NodeState node)
-            InternalVersionHistoryImpl hist =
+            NodeStateEx history =
-            log.debug("Created new version history " + hist.getId() + " for " + node + ".");
-            return hist;
-
+            log.debug(
+                    "Created new version history " + history.getNodeId()
+                    + " for " + node + ".");
+            return history;
