JCR-2056: Binary interfaces



git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@779642 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.RandomAccessFile;
-    public InputStream getStream()
-            throws IllegalStateException, RepositoryException {
+    public boolean isSmall() {
+        return false;
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public InputStream getStream() throws RepositoryException {
-    public boolean isSmall() {
-        return false;
+    public int read(byte[] b, long position) throws IOException, RepositoryException {
+        if (file != null) {
+            // this instance is backed by a temp file
+            RandomAccessFile raf = new RandomAccessFile(file, "r");
+            raf.seek(position);
+            return raf.read(b);
+        } else if (fsResource != null) {
+            // this instance is backed by a resource in the virtual file system
+            InputStream in;
+            try {
+                in = fsResource.getInputStream();
+            } catch (FileSystemException fse) {
+                throw new RepositoryException(fsResource.getPath()
+                        + ": the specified resource does not exist", fse);
+            }
+            in.skip(position);
+            return in.read(b);
+        } else {
+            // this instance is backed by an in-memory buffer
+            int length = Math.min(b.length, buffer.length - (int) position);
+            if (length > 0) {
+                System.arraycopy(buffer, (int) position, b, 0, length);
+                return length;
+            } else {
+                return -1;
+            }
+        }
+
