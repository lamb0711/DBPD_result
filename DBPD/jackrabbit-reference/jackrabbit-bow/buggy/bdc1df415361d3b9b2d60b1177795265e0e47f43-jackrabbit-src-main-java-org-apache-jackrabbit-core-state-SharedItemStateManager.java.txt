JCR-552 Move listeners from item state to item state managers


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@438851 13f79535-47bb-0310-9956-ffa450edef68

+     * State change dispatcher.
+     */
+    private final transient StateChangeDispatcher dispatcher = new StateChangeDispatcher();
+
+    /**
+
+     * <p/>
+     * Notifications are received for items that this manager created itself or items that are
+     * managed by one of the virtual providers.
-        cache.cache(created);
+        if (created.getContainer() == this) {
+            // shared state was created
+            cache.cache(created);
+        }
+        dispatcher.notifyStateCreated(created);
+     * <p/>
+     * Notifications are received for items that this manager created itself or items that are
+     * managed by one of the virtual providers.
-        // not interested
+        dispatcher.notifyStateModified(modified);
+     * <p/>
+     * Notifications are received for items that this manager created itself or items that are
+     * managed by one of the virtual providers.
-        destroyed.removeListener(this);
-        cache.evict(destroyed.getId());
+        if (destroyed.getContainer() == this) {
+            // shared state was destroyed
+            cache.evict(destroyed.getId());
+        }
+        dispatcher.notifyStateDestroyed(destroyed);
+     * <p/>
+     * Notifications are received for items that this manager created itself or items that are
+     * managed by one of the virtual providers.
-        discarded.removeListener(this);
-        cache.evict(discarded.getId());
+        if (discarded.getContainer() == this) {
+            // shared state was discarded
+            cache.evict(discarded.getId());
+        }
+        dispatcher.notifyStateDiscarded(discarded);
+
+        prov.addListener(this);
+    /**
+     * Add an <code>ItemStateListener</code>
+     * @param listener the new listener to be informed on modifications
+     */
+    public void addListener(ItemStateListener listener) {
+        dispatcher.addListener(listener);
+    }
+
+    /**
+     * Remove an <code>ItemStateListener</code>
+     * @param listener an existing listener
+     */
+    public void removeListener(ItemStateListener listener) {
+        dispatcher.removeListener(listener);
+    }
+
+
-        state.addListener(this);
+        state.setContainer(this);
-                // register as listener
-                state.addListener(this);
+                // set parent container
+                state.setContainer(this);
-        state.addListener(this);
+        state.setContainer(this);
