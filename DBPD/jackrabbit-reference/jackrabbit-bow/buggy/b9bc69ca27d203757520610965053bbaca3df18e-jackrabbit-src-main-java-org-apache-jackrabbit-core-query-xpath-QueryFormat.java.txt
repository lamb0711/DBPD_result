JCR-638: Support lower-/upper-case functions

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@475677 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.query.PropertyFunctionQueryNode;
-            String propName = "@";
+            StringBuffer propName = new StringBuffer();
-                propName += NameFormat.format(node.getProperty(), resolver);
+                NameFormat.format(node.getProperty(), resolver, propName);
-                propName += NameFormat.format(ISO9075.encode(node.getProperty()), resolver);
+                propName.append("@");
+                NameFormat.format(ISO9075.encode(node.getProperty()), resolver, propName);
+            // surround name with property function
+            node.acceptOperands(this, propName);
+
+    public Object visit(PropertyFunctionQueryNode node, Object data) {
+        StringBuffer sb = (StringBuffer) data;
+        String functionName = node.getFunctionName();
+        try {
+            if (functionName.equals(PropertyFunctionQueryNode.LOWER_CASE)) {
+                sb.insert(0, NameFormat.format(XPathQueryBuilder.FN_LOWER_CASE, resolver) + "(");
+                sb.append(")");
+            } else if (functionName.equals(PropertyFunctionQueryNode.UPPER_CASE)) {
+                sb.insert(0, NameFormat.format(XPathQueryBuilder.FN_UPPER_CASE, resolver) + "(");
+                sb.append(")");
+            } else {
+                exceptions.add(new InvalidQueryException("Unsupported function: " + functionName));
+            }
+        } catch (NoPrefixDeclaredException e) {
+            exceptions.add(e);
+        }
+        return sb;
+    }
+
