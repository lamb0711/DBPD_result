JCR-623 - Clustering
+ Synchronize journal before updating
+ Leave journal in valid state, when error occurs


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@486054 13f79535-47bb-0310-9956-ffa450edef68

+            /* let listener know about change */
+            if (eventChannel != null) {
+                eventChannel.updateCreated();
+            }
+
-                    eventChannel.updateCreated(local, events);
+                    eventChannel.updatePrepared(local, events);
-                //todo check whether local states are now stale...
-
-                /* let listener know about preparation */
-                if (eventChannel != null) {
-                    eventChannel.updatePrepared();
-                }
-
-                        state.copy(loadItemState(state.getId()));
+                        ItemState currentState = loadItemState(state.getId());
+                        state.copy(currentState);
+                        state.setModCount(currentState.getModCount());
