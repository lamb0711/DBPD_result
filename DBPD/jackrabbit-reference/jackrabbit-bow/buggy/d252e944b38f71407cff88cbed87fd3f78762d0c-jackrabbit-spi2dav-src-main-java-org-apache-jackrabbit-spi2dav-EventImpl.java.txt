JCR-2542: spi2dav: EventFilters not respected

Add node type information to Jackrabbit events through an extension interface; serialize them in JCR server, process them in spi2dav repository service; this fixes filtering by node types. 

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1202201 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.spi.commons.conversion.IllegalNameException;
+import javax.jcr.NamespaceException;
+
+import java.util.ArrayList;
+import java.util.List;
-                     Element eventElement, NamePathResolver resolver, QValueFactory qvFactory) {
+                     Element eventElement, NamePathResolver resolver, QValueFactory qvFactory) throws NamespaceException, IllegalNameException {
-                null, // TODO not available from XML_EVENT element
-                null, // TODO not available from XML_EVENT element
+                resolver.getQName(DomUtil.getChildTextTrim(eventElement, "primarynodetype", NAMESPACE)),
+                getNames(DomUtil.getChildren(eventElement, "mixinnodetype", NAMESPACE), resolver),
-}
+
+    private static Name[] getNames(ElementIterator elements,
+            NamePathResolver resolver) {
+
+        List<Name> results = Collections.emptyList();
+
+        while (elements.hasNext()) {
+            String rawname = DomUtil.getText(elements.nextElement());
+            Name name = null;
+
+            try {
+                name = resolver.getQName(rawname);
+
+                if (results.size() == 0) {
+                    results = Collections.singletonList(name);
+                } else if (results.size() == 1) {
+                    results = new ArrayList<Name>(results);
+                    results.add(name);
+                } else {
+                    results.add(name);
+                }
+            } catch (Exception ex) {
+                log.error("Exception converting name " + rawname, ex);
+            }
+        }
+
+        return results.toArray(new Name[results.size()]);
+    }
+}
