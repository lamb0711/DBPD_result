JCR-2334: Tika-based type detection in jcr-server

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@830670 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.tika.detect.Detector;
+import org.apache.tika.mime.MimeTypeException;
+import org.apache.tika.mime.MimeTypesFactory;
+
+import java.io.IOException;
+import java.net.URL;
+     * Name of the parameter that specifies the servlet resource path of
+     * a custom &lt;mime-info/&gt; configuration file. The default setting
+     * is to use the MIME media type database included in Apache Tika.
+     */
+    public static final String INIT_PARAM_MIME_INFO = "mime-info";
+
+    /**
+        config = new ResourceConfig(getDetector());
-                config = new ResourceConfig();
+     * Reads and returns the configured &lt;mime-info/&gt; database.
+     *
+     * @see #INIT_PARAM_MIME_INFO
+     * @return MIME media type database
+     * @throws ServletException if the database is invalid or can not be read
+     */
+    private Detector getDetector() throws ServletException {
+        URL url;
+
+        String mimeInfo = getInitParameter(INIT_PARAM_MIME_INFO);
+        if (mimeInfo != null) {
+            try {
+                url = getServletContext().getResource(mimeInfo);
+            } catch (MalformedURLException e) {
+                throw new ServletException(
+                        "Invalid " + INIT_PARAM_MIME_INFO
+                        + " configuration setting: " + mimeInfo, e);
+            }
+        } else {
+            url = MimeTypesFactory.class.getResource("tika-mimetypes.xml");
+        }
+
+        try {
+            return MimeTypesFactory.create(url);
+        } catch (MimeTypeException e) {
+            throw new ServletException(
+                    "Invalid MIME media type database: " + url, e);
+        } catch (IOException e) {
+            throw new ServletException(
+                    "Unable to read MIME media type database: " + url, e);
+        }
+    }
+
+    /**
-        // fallback if no config present
-        if (config == null) {
-            config = new ResourceConfig();
-        }
