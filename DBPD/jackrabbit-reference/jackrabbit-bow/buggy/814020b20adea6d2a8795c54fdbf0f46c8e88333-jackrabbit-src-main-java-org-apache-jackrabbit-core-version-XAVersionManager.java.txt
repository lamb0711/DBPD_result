JCR-455: InternalXAResource.rollback() can be called twice and without prepare
JCR-414: jcr:successors property not persisted correctly within a transaction


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@412995 13f79535-47bb-0310-9956-ffa450edef68

+     * flag that indicates if the version manager was locked during prepare
+     */
+    private boolean vmgrLocked = false;
+
+    /**
+        vMgr.aquireWriteLock();
+        vmgrLocked = true;
-        vMgr.aquireWriteLock();
+        vmgrLocked = false;
-        vMgr.getSharedStateMgr().setNoLockHack(false);
+        if (vmgrLocked) {
+            vMgr.getSharedStateMgr().setNoLockHack(false);
+            vMgr.releaseWriteLock();
+            vmgrLocked = false;
+        }
+        aquireReadLock();
+        } finally {
+            releaseReadLock();
