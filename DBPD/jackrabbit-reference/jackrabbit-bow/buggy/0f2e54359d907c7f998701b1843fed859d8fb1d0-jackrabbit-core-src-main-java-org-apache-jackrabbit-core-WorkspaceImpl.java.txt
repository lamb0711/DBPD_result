JCR-1588 - JSR 283: Access Control (work in progress)
JCR-1590 - JSR 283: Locking
JCR-1915 - Node.setPrimaryNodeType should only redefine child-definitions that are not covered by the new effective nt
JCR-1875 - Failing Node.unlock() might leave inconsistent transient state
JCR-538 - Failing Node.checkin() or Node.checkout() might leave inconsistent transient state

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@732693 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.lock.SessionLockManager;
+    private org.apache.jackrabbit.api.jsr283.lock.LockManager jcr283LockManager;
+
+    /**
+     * @see org.apache.jackrabbit.api.jsr283.Workspace#getLockManager()
+     * @see org.apache.jackrabbit.api.jsr283.lock.LockManager
+     */
+    // TODO: rename to 'getLockManager'.
+    // TODO  in order not to break compatilibiy with the 1.x releases
+    // TODO  the 283 method has been tmp. renamed since it conflicts with an
+    // TODO  existing public method, exposing the internal lock manager.
+    public org.apache.jackrabbit.api.jsr283.lock.LockManager get283LockManager() throws UnsupportedRepositoryOperationException, RepositoryException {
+        if (jcr283LockManager == null) {
+            jcr283LockManager = new SessionLockManager(session, session.getLockManager());
+        }
+        return jcr283LockManager;
+    }
+
+        boolean success = false;
-        } catch (RepositoryException e) {
-            // revert session
-            try {
-                log.error("reverting changes applied during restore...");
-                session.refresh(false);
-            } catch (RepositoryException e1) {
-                // ignore this
+            session.save();
+            success = true;
+        } finally {
+            if (!success) {
+                // revert session
+                try {
+                    log.debug("reverting changes applied during restore...");
+                    session.refresh(false);
+                } catch (RepositoryException e) {
+                    log.error("Error while reverting changes applied during restore.", e);
+                }
-            throw e;
-        session.save();
