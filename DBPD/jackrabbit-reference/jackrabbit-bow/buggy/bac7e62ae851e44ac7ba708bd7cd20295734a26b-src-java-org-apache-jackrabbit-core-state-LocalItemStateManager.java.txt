- Redesigned observation to also include workspace modifications
- Extended observation tests and moved them into the api.observation package

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@155583 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.WorkspaceImpl;
+import javax.jcr.RepositoryException;
+     * Local WorkspaceImpl instance.
+     */
+    protected final WorkspaceImpl wspImpl;
+
+    /**
+     * todo LocalItemStateManager without a wspImpl will not generate observation events!
+     * @param wspImpl the workspace instance where this item state manager
+     * belongs to, or <code>null</code> if this item state manager is not
+     * associated with a workspace. This is the case for the version item state
+     * manager. Version item states are not associated with a specific workspace
+     * instance.
-    public LocalItemStateManager(SharedItemStateManager sharedStateMgr) {
+    public LocalItemStateManager(SharedItemStateManager sharedStateMgr, WorkspaceImpl wspImpl) {
+        this.wspImpl = wspImpl;
-        sharedStateMgr.store(changeLog);
+        try {
+            sharedStateMgr.store(changeLog, (wspImpl != null) ? wspImpl.getObservationManagerImpl() : null);
+        } catch (RepositoryException e) {
+            // should never get here
+            String msg = "ObservationManager unavailable";
+            log.error(msg);
+            throw new ItemStateException(msg, e);
+        }
