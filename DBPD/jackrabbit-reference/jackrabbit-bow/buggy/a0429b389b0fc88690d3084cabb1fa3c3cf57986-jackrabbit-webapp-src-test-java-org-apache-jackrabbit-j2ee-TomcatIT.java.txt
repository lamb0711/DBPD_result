JCR-3598: Oak in Jackrabbit deployment packages

Add Oak dependencies to jackrabbit-webapp.
Move backwards compatibility tests to -webapp.
Update the Tomcat dependency and streamline test setup.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1489772 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.File;
-import org.apache.catalina.Engine;
-import org.apache.catalina.Host;
-import org.apache.catalina.connector.Connector;
-import org.apache.catalina.core.StandardContext;
-import org.apache.catalina.startup.Embedded;
+import org.apache.catalina.startup.Tomcat;
+import org.apache.commons.io.FileUtils;
+    static {
+        SLF4JBridgeHandler.install();
+    }
+
-    private Embedded tomcat;
+    private Tomcat tomcat;
-        SLF4JBridgeHandler.install();
+        File war = null;
+        for (File f : new File("target").listFiles()) {
+            if (f.isDirectory() && new File(f, "WEB-INF/web.xml").isFile()) {
+                war = f;
+                break;
+            }
+        }
+        assertNotNull(war);
+
+        File bootstrap = new File("target", "bootstrap.properties");
+        bootstrap.delete();
+        RepositoryAccessServlet.bootstrapOverride = bootstrap.getPath();
+        RepositoryStartupServlet.bootstrapOverride = bootstrap.getPath();
+
+        File baseDir = new File("target", "tomcat");
+        FileUtils.deleteQuietly(baseDir);
+
+        File repoDir = new File("target", "repository");
+        FileUtils.deleteQuietly(repoDir);
-        tomcat = new Embedded();
-        tomcat.setCatalinaBase("tomcat");
-        tomcat.setCatalinaHome("tomcat");
+        tomcat = new Tomcat();
+        tomcat.setSilent(true);
+        tomcat.setBaseDir(baseDir.getPath());
+        tomcat.setHostname(url.getHost());
+        tomcat.setPort(url.getPort());
-        Engine engine = tomcat.createEngine();
-        engine.setName("localengine");
-        engine.setDefaultHost(url.getHost());
+        tomcat.addWebapp("", war.getAbsolutePath());
-        Host host = tomcat.createHost(url.getHost(), "webapps");
-        host.setAutoDeploy(false);
-        engine.addChild(host);
-
-        String webapp = System.getProperty("webapp.directory");
-        StandardContext context =
-            (StandardContext) tomcat.createContext("", webapp);
-        context.setDefaultWebXml(System.getProperty("default.webxml"));
-        host.addChild(context);
-
-        tomcat.addEngine(engine);
-
-        Connector connector =
-            tomcat.createConnector(url.getHost(), url.getPort(), false);
-        tomcat.addConnector(connector);
-
-        tomcat.setAwait(true);
-                        home.setValueAttribute("repository");
+                        home.setValueAttribute("target/repository");
