JCR-1773 - shareable nodes: wrong path returned, causes remove() to delete wrong node


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@790127 13f79535-47bb-0310-9956-ffa450edef68

-    public ItemImpl getItem(Path path)
-            throws PathNotFoundException, AccessDeniedException, RepositoryException {
+    public ItemImpl getItem(Path path) throws PathNotFoundException,
+            AccessDeniedException, RepositoryException {
-            return getItem(id, path);
+            ItemImpl item = getItem(id, path);
+            // Test, if this item is a shareable node.
+            if (item.isNode() && ((NodeImpl) item).isShareable()) {
+                return getNode(path);
+            }
+            return item;
-    public NodeImpl getNode(Path path)
-            throws PathNotFoundException, AccessDeniedException, RepositoryException {
+    public NodeImpl getNode(Path path) throws PathNotFoundException,
+            AccessDeniedException, RepositoryException {
+        NodeId parentId = null;
+        if (!path.denotesRoot()) {
+            parentId = hierMgr.resolveNodePath(path.getAncestor(1));
+        }
-            return (NodeImpl) getItem(id, path);
+            if (parentId == null) {
+                return (NodeImpl) getItem(id, path);
+            }
+            // if the node is shareable, it now returns the node with the right
+            // parent
+            return getNode(id, parentId);
