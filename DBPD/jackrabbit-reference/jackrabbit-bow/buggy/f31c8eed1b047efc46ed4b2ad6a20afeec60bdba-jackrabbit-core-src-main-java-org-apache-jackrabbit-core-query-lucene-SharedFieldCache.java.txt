JCR-974: Manage Lucene FieldCaches per index segment

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@550429 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.lucene.search.FieldCache;
+     * Expert: Stores term text values and document ordering data.
+     */
+    public static class StringIndex {
+
+        /**
+         * All the term values, in natural order.
+         */
+        public final String[] lookup;
+
+        /**
+         * Terms indexed by document id.
+         */
+        public final String[] terms;
+
+        /**
+         * Creates one of these objects
+         */
+        public StringIndex(String[] terms, String[] lookup) {
+            this.terms = terms;
+            this.lookup = lookup;
+        }
+    }
+
+    /**
-    public FieldCache.StringIndex getStringIndex(IndexReader reader,
+    public SharedFieldCache.StringIndex getStringIndex(IndexReader reader,
+        
+        if (reader instanceof ReadOnlyIndexReader) {
+            reader = ((ReadOnlyIndexReader) reader).getBase();
+        }
+        
-        FieldCache.StringIndex ret = lookup(reader, field, prefix, comparator);
+        SharedFieldCache.StringIndex ret = lookup(reader, field, prefix, comparator);
-            final int[] retArray = new int[reader.maxDoc()];
+            final String[] retArray = new String[reader.maxDoc()];
-                int t = 1;  // current term number
-                            retArray[termDocs.doc()] = t;
+                            retArray[termDocs.doc()] = term.text().substring(prefix.length());
-
-                        t++;
-            FieldCache.StringIndex value = new FieldCache.StringIndex(retArray, lookup);
+            SharedFieldCache.StringIndex value = new SharedFieldCache.StringIndex(retArray, lookup);
-    FieldCache.StringIndex lookup(IndexReader reader, String field,
+    SharedFieldCache.StringIndex lookup(IndexReader reader, String field,
-            return (FieldCache.StringIndex) readerCache.get(key);
+            return (SharedFieldCache.StringIndex) readerCache.get(key);
-                 SortComparator comparer, FieldCache.StringIndex value) {
+                 SortComparator comparer, SharedFieldCache.StringIndex value) {
