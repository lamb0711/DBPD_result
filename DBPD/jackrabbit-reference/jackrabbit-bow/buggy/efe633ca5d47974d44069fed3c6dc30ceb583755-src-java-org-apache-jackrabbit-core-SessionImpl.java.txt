JCR-72 Session.impersonate non-functional: 'impersonate' is now delegated to LoginModule; added dummy 'impersonator' handling to SimpleLoginModule

- also fixed Session.getAccessibleWorkspaceNames()


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@158069 13f79535-47bb-0310-9956-ffa450edef68

+import javax.jcr.SimpleCredentials;
+import java.util.ArrayList;
+     * @throws RepositoryException if an error occurs
-    protected String[] getWorkspaceNames() {
-        // @todo filter workspace names based on credentials of this session
-        return rep.getWorkspaceNames();
+    protected String[] getWorkspaceNames() throws RepositoryException {
+        // filter workspaces according to access rights
+        ArrayList list = new ArrayList();
+        String names[] = rep.getWorkspaceNames();
+        for (int i = 0; i < names.length; i++) {
+            try {
+                if (getAccessManager().canAccess(names[i])) {
+                    list.add(names[i]);
+                }
+            } catch (NoSuchWorkspaceException nswe) {
+                // should never happen, ignore...
+            }
+        }
+        return names;
-        // @todo reimplement impersonate(Credentials) correctly
+        if (!(otherCredentials instanceof SimpleCredentials)) {
+            String msg = "impersonate failed: incompatible credentials, SimpleCredentials expected";
+            log.debug(msg);
+            throw new RepositoryException(msg);
+        }
-        // check if the credentials of this session allow to 'impersonate'
-        // the user represented by tha supplied credentials
+        // set IMPERSONATOR_ATTRIBUTE attribute of given credentials
+        // with subject of current session
+        SimpleCredentials creds = (SimpleCredentials) otherCredentials;
+        creds.setAttribute(IMPERSONATOR_ATTRIBUTE, subject);
-        // FIXME: the original purpose of this method is to enable
-        // a 'superuser' to impersonate another user without needing
-        // to know its password.
-            log.debug(msg);
-            throw new LoginException(msg, nswe);
+            log.error(msg, nswe);
+            throw new RepositoryException(msg, nswe);
