- some versioning issues

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@191181 13f79535-47bb-0310-9956-ffa450edef68

-    public Version checkin(NodeImpl node) throws RepositoryException {
+    public synchronized Version checkin(NodeImpl node) throws RepositoryException {
+        // need to recalc successor prop
+        InternalVersion[] preds = version.getPredecessors();
+        for (int i=0; i<preds.length; i++) {
+            ItemState state = (ItemState) items.remove(new PropertyId(preds[i].getId(), JCR_SUCCESSORS));
+            if (state != null) {
+                state.discard();
+            }
+        }
-        ItemState state = (ItemState) items.remove(id);
+        ItemState state = (ItemState) items.get(id);
-            if (recursive) {
-                if (state instanceof NodeState) {
-                    NodeState nState = (NodeState) state;
-                    Iterator iter = nState.getPropertyEntries().iterator();
-                    while (iter.hasNext()) {
-                        NodeState.PropertyEntry pe = (NodeState.PropertyEntry) iter.next();
-                        invalidateItem(new PropertyId(nState.getUUID(), pe.getName()), false);
-                    }
-                    iter = nState.getChildNodeEntries().iterator();
-                    while (iter.hasNext()) {
-                        NodeState.ChildNodeEntry pe = (NodeState.ChildNodeEntry) iter.next();
-                        invalidateItem(new NodeId(pe.getUUID()), true);
-                    }
+            if (recursive && state instanceof NodeState) {
+                NodeState nState = (NodeState) state;
+                Iterator iter = nState.getPropertyEntries().iterator();
+                while (iter.hasNext()) {
+                    NodeState.PropertyEntry pe = (NodeState.PropertyEntry) iter.next();
+                    invalidateItem(new PropertyId(nState.getUUID(), pe.getName()), false);
+                }
+                iter = nState.getChildNodeEntries().iterator();
+                while (iter.hasNext()) {
+                    NodeState.ChildNodeEntry pe = (NodeState.ChildNodeEntry) iter.next();
+                    invalidateItem(new NodeId(pe.getUUID()), true);
