JCR-2883 : Node.orderBefore and JackrabbitNode.rename should check for ability to modify children-collection on parent node

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1072087 13f79535-47bb-0310-9956-ffa450edef68

-        if (!acMgr.isGranted(childPath, Permission.ADD_NODE | Permission.REMOVE_NODE)) {
+        if (!acMgr.isGranted(childPath, Permission.MODIFY_CHILD_NODE_COLLECTION)) {
-        // check permissions
+        // check permissions:
+        // 1. on the parent node the session must have permission to manipulate the child-entries
-        if (!(acMgr.isGranted(getPrimaryPath(), Permission.REMOVE_NODE) &&
-                acMgr.isGranted(parent.getPrimaryPath(), qName, Permission.ADD_NODE | Permission.NODE_TYPE_MNGMT))) {
+        if (!acMgr.isGranted(parent.getPrimaryPath(), qName, Permission.MODIFY_CHILD_NODE_COLLECTION)) {
+            String msg = "Not allowed to rename node " + safeGetJCRPath() + " to " + newName;
+            log.debug(msg);
+            throw new AccessDeniedException(msg);
+        }
+        // 2. in case of nt-changes the session must have permission to change
+        //    the primary node type on this node itself.
+        if (!nt.getName().equals(newTargetDef.getName()) && !(acMgr.isGranted(getPrimaryPath(), Permission.NODE_TYPE_MNGMT))) {
