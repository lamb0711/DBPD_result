Move preparation of events out of write lock to prevent possible deadlock situations.

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@239609 13f79535-47bb-0310-9956-ffa450edef68

+ * <p/>
+ * The basic sequence of method calls is:
+ * <ul>
+ * <li>{@link #createEventStates} or {@link #addAll} to create or add event
+ * states to the collection</li>
+ * <li>{@link #prepare} or {@link #prepareDeleted} to prepare the events. If
+ * this step is omitted, EventListeners might see events of deleted item
+ * they are not allowed to see.</li>
+ * <li>{@link #dispatch()} to dispatch the events to the EventListeners.</li>
+ * </ul>
-     * Prepares the events for dispatching.
+     * Prepares already added events for dispatching.
+     * Prepares deleted items from <code>changes</code>.
+     *
+     * @param changes the changes to prepare.
+     */
+    public void prepareDeleted(ChangeLog changes) {
+        dispatcher.prepareDeleted(this, changes);
+    }
+
+    /**
