JCR-1034: Unable to save session after saving a renamed node


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@561000 13f79535-47bb-0310-9956-ffa450edef68

-                        NodeId oldParentId =
-                                nodeState.getOverlayedState().getParentId();
+                        NodeState overlayedState =
+                                (NodeState) nodeState.getOverlayedState();
+                        NodeId oldParentId = overlayedState.getParentId();
-                                    // node has been moved, add old and new parent
-                                    // to dependencies
+                                    // node has been moved to a new location,
+                                    // add old and new parent to dependencies
+                                } else {
+                                    // edge case: check whether definition id
+                                    // has changed (indicating that the node
+                                    // had been renamed, subsequently acquiring
+                                    // a new definition) (JCR-1034)
+                                    if (!nodeState.getDefinitionId().equals(
+                                            overlayedState.getDefinitionId())) {
+                                        // node has been renamed and as result
+                                        // got redefined, add parent to dependencies
+                                        dependentIDs.add(newParentId);
+                                    }
+
+                    // note that there's no need to check removed/added
+                    // child node entries since those, being descendants, 
+                    // will automatically be included in the hierarchical
+                    // scope of this save operation.
+/*
-
+  */
