JCR-412 JCA Concurrent Modification Exception when JCAManagedConnection.cleanup() called
JCR-461 ManagedConnection#cleanup doesn't refresh the session

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@414703 13f79535-47bb-0310-9956-ffa450edef68

+import javax.jcr.RepositoryException;
-        closeHandles();
+        synchronized (handles) {
+            try {
+                this.session.refresh(false);
+            } catch (RepositoryException e) {
+                throw new ResourceException("unable to cleanup connection", e);
+            }
+            this.handles.clear();
+        }
-            for (Iterator i = handles.iterator(); i.hasNext();) {
-                JCASessionHandle handle = (JCASessionHandle) i.next();
-                closeHandle(handle);
+            JCASessionHandle[] handlesArray = new JCASessionHandle[handles
+                    .size()];
+            handles.toArray(handlesArray);
+            for (int i = 0; i < handlesArray.length; i++) {
+                this.closeHandle(handlesArray[i]);
-
-            handles.clear();
