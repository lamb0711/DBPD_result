JCR-293 Property.setValue(InputStream) closes stream

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@357013 13f79535-47bb-0310-9956-ffa450edef68

-                values[i] = InternalValue.create(blobStore.get(blobId));
+                if (blobStore instanceof ResourceBasedBLOBStore) {
+                    // optimization: if the BLOB store is resource-based
+                    // retrieve the resource directly rather than having
+                    // to read the BLOB from an input stream
+                    FileSystemResource fsRes =
+                            ((ResourceBasedBLOBStore) blobStore).getResource(blobId);
+                    values[i] = InternalValue.create(fsRes);
+                } else {
+                    in = blobStore.get(blobId);
+                    try {
+                        values[i] = InternalValue.create(in);
+                    } finally {
+                        try {
+                            in.close();
+                        } catch (IOException e) {
+                            // ignore
+                        }
+                    }
+                }
+                 * Strings are serialized as <length><byte[]>
-                    val = InternalValue.create(blobStore.get(s));
+                    InputStream is = blobStore.get(s);
+                    try {
+                        val = InternalValue.create(is);
+                    } finally {
+                        try {
+                            is.close();
+                        } catch (IOException e) {
+                            // ignore
+                        }
+                    }
