JCR-920: rep:excerpt() should also work on properties

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@537791 13f79535-47bb-0310-9956-ffa450edef68

-                    throw new ItemNotFoundException(propertyName);
+                    if (isExcerptFunction(propertyName)) {
+                        // excerpt function with parameter
+                        return getExcerpt(propertyName);
+                    } else {
+                        throw new ItemNotFoundException(propertyName);
+                    }
+            String decodedPath = ISO9075.decode(pathStr);
-                NodeImpl n = (NodeImpl) node.getNode(ISO9075.decode(pathStr));
+                NodeImpl n = (NodeImpl) node.getNode(decodedPath);
-                // does not exist
-                return null;
+                // does not exist or references a property
+                try {
+                    Property p = node.getProperty(decodedPath);
+                    return highlight(p.getValue().getString());
+                } catch (PathNotFoundException e1) {
+                    // does not exist
+                    return null;
+                }
+
+        /**
+         * Highlights the matching terms in the passed <code>text</code>.
+         *
+         * @return a StringValue or <code>null</code> if highlighting fails.
+         */
+        private Value highlight(String text) {
+            if (!(excerptProvider instanceof HighlightingExcerptProvider)) {
+                return null;
+            }
+            HighlightingExcerptProvider hep =
+                    (HighlightingExcerptProvider) excerptProvider;
+            try {
+                long time = System.currentTimeMillis();
+                text = hep.highlight(text);
+                time = System.currentTimeMillis() - time;
+                log.debug("Highlighted text in {} ms.", new Long(time));
+                return new StringValue(text);
+            } catch (IOException e) {
+                return null;
+            }
+        }
