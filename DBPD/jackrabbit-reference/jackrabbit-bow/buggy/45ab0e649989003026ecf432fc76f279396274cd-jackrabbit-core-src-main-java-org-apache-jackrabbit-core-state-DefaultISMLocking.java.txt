JCR-1334 Deadlock due different Thread access in same Transaction

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@734400 13f79535-47bb-0310-9956-ffa450edef68

+import javax.transaction.xa.Xid;
+
+import org.apache.jackrabbit.core.TransactionContext;
+
+                rwLock.setActiveXid(TransactionContext.getCurrentXid());
+                rwLock.setActiveXid(null);
+        private Xid activeXid;
+
-            return activeWriter_ == null
-                    || activeWriter_ == Thread.currentThread();
+            return TransactionContext.isCurrentXid(activeXid, (activeWriter_ == null || activeWriter_ == Thread.currentThread()));
+
+        /**
+         * Sets the active Xid
+         * @param id
+         */
+        synchronized void setActiveXid(Xid xid) {
+            activeXid = xid;
+        }
+        
