JCR-1213: UUIDDocId cache does not work properly because of weakReferences in combination with new instance for combined indexreader

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@601342 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.lucene.index.IndexReader;
-import org.apache.lucene.index.Term;
-import org.apache.lucene.index.TermDocs;
-import java.lang.ref.Reference;
-import java.lang.ref.WeakReference;
-        final int getDocumentNumber(IndexReader reader) {
+        final int getDocumentNumber(MultiIndexReader reader) {
-    abstract int getDocumentNumber(IndexReader reader) throws IOException;
+    abstract int getDocumentNumber(MultiIndexReader reader) throws IOException;
-        int getDocumentNumber(IndexReader reader) {
+        int getDocumentNumber(MultiIndexReader reader) {
-         * The index reader that was used to calculate the document number.
-         * If <code>null</code> then the document number has not yet been
-         * calculated.
+         * The previously calculated foreign segment document id.
-        private Reference reader;
-
-        /**
-         * The previously calculated document number.
-         */
-        private int docNumber;
-
+        private ForeignSegmentDocId doc;
+        
-        int getDocumentNumber(IndexReader reader) throws IOException {
-            synchronized (this) {
-                if (this.reader != null && reader.equals(this.reader.get())) {
-                    return docNumber;
+        int getDocumentNumber(MultiIndexReader reader) throws IOException {
+            int realDoc = -1;
+            ForeignSegmentDocId segDocId = doc;
+            if (segDocId != null) {
+                realDoc = reader.getDocumentNumber(segDocId);
+            }
+            if (realDoc == -1) {
+                // Cached doc was invalid => create new one
+                segDocId = reader.createDocId(new UUID(msb, lsb));
+                if (segDocId != null) {
+                    realDoc = reader.getDocumentNumber(segDocId);
+                    doc = segDocId;
-            Term id = new Term(FieldNames.UUID, new UUID(msb, lsb).toString());
-            TermDocs docs = reader.termDocs(id);
-            int doc = -1;
-            try {
-                if (docs.next()) {
-                    doc = docs.doc();
-                }
-            } finally {
-                docs.close();
-            }
-            synchronized (this) {
-                docNumber = doc;
-                this.reader = new WeakReference(reader);
-            }
-            return doc;
+            return realDoc;
-         * not known until resolved in {@link #getDocumentNumber(IndexReader)}.
+         * not known until resolved in {@link #getDocumentNumber(MultiIndexReader)}.
