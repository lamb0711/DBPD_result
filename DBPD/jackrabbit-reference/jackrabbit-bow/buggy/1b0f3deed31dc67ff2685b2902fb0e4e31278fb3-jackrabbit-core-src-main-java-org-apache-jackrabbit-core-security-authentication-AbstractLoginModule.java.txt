JCR-2087 Upgrade to Java 5 as the base platform
minor improvement



git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@786147 13f79535-47bb-0310-9956-ffa450edef68

-                           Map sharedState, Map options) {
+                           Map<String,?> sharedState, Map<String,?> options) {
-            // retrieve the principal-provider configured for this module.
-            // if not configured -> retrieve the provider from the callback.
+            // check if the class name of a PrincipalProvider implementation
+            // is present with the module configuration.
-                principalProviderClassName = (String) options.get(LoginModuleConfig.PARAM_PRINCIPAL_PROVIDER_CLASS);
-                principalProvider = registry.getProvider(principalProviderClassName);
-            } else if (principalProviderClassName != null) {
+                Object pcOption = options.get(LoginModuleConfig.PARAM_PRINCIPAL_PROVIDER_CLASS);
+                if (pcOption != null) {
+                    principalProviderClassName = pcOption.toString();
+                }
+            }
+            if (principalProviderClassName != null) {
-                    sharedState.put(KEY_CREDENTIALS, credentials);
+                    if (credentials != null) {
+                        sharedState.put(KEY_CREDENTIALS, credentials);
+                    }
-        // ask subject if still no credentials
+        // if still no credentials -> try to retrieve them from the subject.
+        if (null == credentials) {
+            // try if subject contains GuestCredentials
+            Set<GuestCredentials> preAuthCreds = subject.getPublicCredentials(GuestCredentials.class);
+            if (!preAuthCreds.isEmpty()) {
+                credentials = preAuthCreds.iterator().next();
+            }
+        }
