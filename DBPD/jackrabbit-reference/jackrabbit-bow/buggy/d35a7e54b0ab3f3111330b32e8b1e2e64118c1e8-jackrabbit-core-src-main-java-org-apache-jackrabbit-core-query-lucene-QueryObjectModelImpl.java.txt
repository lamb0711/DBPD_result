JCR-890: concurrent read-only access to a session

Use the SessionContext and SessionOperations in search

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@983708 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.List;
+import java.util.List;
-import javax.jcr.query.QueryResult;
+import javax.jcr.query.QueryResult;
-import org.apache.jackrabbit.core.ItemManager;
-import org.apache.jackrabbit.core.nodetype.NodeTypeManagerImpl;
+import org.apache.jackrabbit.core.nodetype.NodeTypeManagerImpl;
+import org.apache.jackrabbit.core.session.SessionContext;
+import org.apache.jackrabbit.spi.commons.nodetype.PropertyDefinitionImpl;
+import org.apache.jackrabbit.spi.commons.query.qom.OrderingImpl;
-import org.apache.jackrabbit.spi.commons.query.qom.OrderingImpl;
-import org.apache.jackrabbit.spi.commons.nodetype.PropertyDefinitionImpl;
-     * @param session the session of the user executing this query.
-     * @param itemMgr the item manager of the session executing this query.
+     * @param sessionContext component context of the current session
-    public QueryObjectModelImpl(SessionImpl session,
-                                ItemManager itemMgr,
-                                SearchIndex index,
-                                PropertyTypeRegistry propReg,
-                                QueryObjectModelTree qomTree)
+    public QueryObjectModelImpl(
+            SessionContext sessionContext, SearchIndex index,
+            PropertyTypeRegistry propReg, QueryObjectModelTree qomTree)
-        super(session, itemMgr, index, propReg);
+        super(sessionContext, index, propReg);
-
-        LuceneQueryFactory factory = new LuceneQueryFactoryImpl(session,
-                index.getSortComparatorSource(),
+        SessionImpl session = sessionContext.getSessionImpl();
+        LuceneQueryFactory factory = new LuceneQueryFactoryImpl(
+                session, index.getSortComparatorSource(),
-        return new MultiColumnQueryResult(index, itemMgr,
-                session, session.getAccessManager(),
+        return new MultiColumnQueryResult(
+                index, sessionContext,
+            final NodeTypeManagerImpl manager =
+                sessionContext.getSessionImpl().getNodeTypeManager();
-                    if (!session.getNodeTypeManager().hasNodeType(ntName)) {
+                    if (!manager.hasNodeType(ntName)) {
