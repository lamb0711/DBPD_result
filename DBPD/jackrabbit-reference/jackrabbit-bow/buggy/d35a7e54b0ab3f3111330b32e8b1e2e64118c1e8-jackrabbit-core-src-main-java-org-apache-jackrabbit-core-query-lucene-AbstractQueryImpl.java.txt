JCR-890: concurrent read-only access to a session

Use the SessionContext and SessionOperations in search

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@983708 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.SessionImpl;
-import org.apache.jackrabbit.core.ItemManager;
+import org.apache.jackrabbit.core.session.SessionContext;
+import javax.jcr.Workspace;
-     * The session of the user executing this query
+     * Component context of the current session
-    protected final SessionImpl session;
-
-    /**
-     * The item manager of the user executing this query
-     */
-    protected final ItemManager itemMgr;
+    protected final SessionContext sessionContext;
-     * @param session the session of the user executing this query.
-     * @param itemMgr the item manager of the session executing this query.
+     * @param sessionContext component context of the current session
-    public AbstractQueryImpl(SessionImpl session,
-                             ItemManager itemMgr,
-                             SearchIndex index,
-                             PropertyTypeRegistry propReg) {
-        this.session = session;
-        this.itemMgr = itemMgr;
+    public AbstractQueryImpl(
+            SessionContext sessionContext, SearchIndex index,
+            PropertyTypeRegistry propReg) {
+        this.sessionContext = sessionContext;
-        return session.getWorkspace().getQueryManager().getQOMFactory();
+        Workspace workspace = sessionContext.getSessionImpl().getWorkspace();
+        return workspace.getQueryManager().getQOMFactory();
