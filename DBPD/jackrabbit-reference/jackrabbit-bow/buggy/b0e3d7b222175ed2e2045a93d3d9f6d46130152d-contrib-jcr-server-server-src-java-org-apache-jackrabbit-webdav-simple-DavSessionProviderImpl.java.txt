JCR-193, JCR-216, JCR-203, JCR 184 + various minor fixes

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@293331 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.log4j.Logger;
+    private static Logger log = Logger.getLogger(DavSessionProviderImpl.class);
+
+                log.debug("Could not to retrieve a repository session.");
+            log.debug("Attaching session '"+ ds + "' to request '" + request + "'");
-     * No further actions required, since <code>DavSessionImpl</code> does not
-     * allow to keep track of references to it.
+     * and remove all the lock tokens from the underlaying repository session
+     * in order make sure they can be reset when attaching a session to the
+     * next request. Finally the session is logged-out. The latter is a workaround
+     * only, since the SessionProvider may not clean up unused sessions properly.
+        DavSession ds = request.getDavSession();
+        if (ds != null) {
+            Session repSession = ds.getRepositorySession();
+            String[] lockTokens = repSession.getLockTokens();
+            for (int i = 0; i < lockTokens.length; i++) {
+                repSession.removeLockToken(lockTokens[i]);
+            }
+            // TODO: not quite correct. the SessionProvider should take care of removing session.
+            repSession.logout();
+            log.debug("Releasing session '"+ ds + "' from request '" + request + "'");
+        } else {
+            // session is null. nothing to be done.
+        }
