- fixing VersionHistory.removeVersion()

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@157348 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.PropertyImpl;
+import javax.jcr.PropertyIterator;
+import java.util.List;
-        try {
-            InternalVersionImpl v = (InternalVersionImpl) getVersion(versionName);
-            if (v.equals(rootVersion)) {
-                String msg = "Removal of " + versionName + " not allowed.";
-                log.debug(msg);
-                throw new VersionException(msg);
-            }
+        InternalVersionImpl v = (InternalVersionImpl) getVersion(versionName);
+        if (v.equals(rootVersion)) {
+            String msg = "Removal of " + versionName + " not allowed.";
+            log.debug(msg);
+            throw new VersionException(msg);
+        }
+        // check if any references (from outside the version storage) exist on this version
+        List refs = getVersionManager().getItemReferences(v);
+        if (!refs.isEmpty()) {
+            throw new VersionException("Unable to remove version. At least once referenced.");
+        }
+        try {
