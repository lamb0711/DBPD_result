JCR-1082 - cache getting out of sync with transientstore causes pathnotfoundexception


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@570736 13f79535-47bb-0310-9956-ffa450edef68

-            return remove(nameIndex, true);
+            return remove(nameIndex, true, true);
-         * removed to the left. If there are no more children left in
+         * removed to the left. If <code>removeIfEmpty</code> is set to
+         * <code>true</code> and there are no more children left in
+         * @param removeIfEmpty remove this element itself if it contains
+         *                      no more children and is not associated to
+         *                      an element
-        private Element remove(Path.PathElement nameIndex, boolean shift) {
+        private Element remove(Path.PathElement nameIndex, boolean shift,
+                               boolean removeIfEmpty) {
+
-            if (childrenCount == 0 && obj == null && parent != null) {
-                parent.remove(getPathElement(), shift);
+            if (removeIfEmpty && childrenCount == 0 && obj == null && parent != null) {
+                parent.remove(getPathElement(), shift, true);
-                parent.remove(getPathElement(), shift);
+                parent.remove(getPathElement(), shift, true);
-                parent.remove(getPathElement(), false);
+                parent.remove(getPathElement(), false, true);
+         * Move a child of this element to a different location inside the
+         * same parent.
+         *
+         * @param oldNameIndex old name/index 
+         * @param newNameIndex new name/index
+         * @return <code>true</code> if the element was successfully moved;
+         *         otherwise <code>false</code>
+         */
+        public boolean move(Path.PathElement oldNameIndex, 
+                            Path.PathElement newNameIndex) {
+            
+            Element child = remove(oldNameIndex, false, false);
+            if (child != null) {
+                put(newNameIndex, child);
+                return true;
+            }
+            return false;
+        }
+
+        /**
-                parent.remove(getPathElement(), false);
+                parent.remove(getPathElement(), false, true);
