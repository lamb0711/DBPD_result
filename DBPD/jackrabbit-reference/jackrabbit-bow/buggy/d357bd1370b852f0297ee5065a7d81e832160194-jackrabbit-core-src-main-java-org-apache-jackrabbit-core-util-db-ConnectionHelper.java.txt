JCR-2767: Database connection leak with DBCP, MySQL, and Observers

Patch by Christian Trimble

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1004576 13f79535-47bb-0310-9956-ffa450edef68

-    private boolean inBatchMode = false;
-
-    private Connection batchConnection = null;
+    private ThreadLocal<Connection> batchConnectionTl = new ThreadLocal<Connection>();
+     * Returns true if we are currently in a batch mode, false otherwise.
+     * @return true if the current thread is running in batch mode, false otherwise.
+     */
+    protected boolean inBatchMode()
+    {
+      return batchConnectionTl.get() != null;
+    }
+
+    /**
-        if (inBatchMode) {
+        if (inBatchMode()) {
+        Connection batchConnection = null;
-            inBatchMode = true;
+            batchConnectionTl.set(batchConnection);
-            batchConnection = null;
+            batchConnectionTl.remove();
-        if (!inBatchMode) {
+        if (!inBatchMode()) {
-                batchConnection.commit();
+                batchConnectionTl.get().commit();
-                batchConnection.rollback();
+                batchConnectionTl.get().rollback();
-            DbUtility.close(batchConnection, null, null);
-            batchConnection = null;
-            inBatchMode = false;
+            DbUtility.close(batchConnectionTl.get(), null, null);
+            batchConnectionTl.set(null);
-            if (inBatchMode) {
+            if (inBatchMode()) {
-        if (inBatchMode) {
-            return batchConnection;
+        if (inBatchMode()) {
+            return batchConnectionTl.get();
-        if (inBatchMode) {
+        if (inBatchMode()) {
-            if (inBatchMode) {
+            if (inBatchMode()) {
