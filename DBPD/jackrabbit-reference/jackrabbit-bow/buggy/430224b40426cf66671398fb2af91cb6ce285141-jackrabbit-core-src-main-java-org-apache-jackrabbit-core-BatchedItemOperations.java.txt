JCR-2058 JSR 283: VersionManager and new versioning methods
- added jcr:copiedFrom property to version history


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@778802 13f79535-47bb-0310-9956-ffa450edef68

+            // init version history if needed
+            VersionHistoryInfo history = null;
+            if (versionable && flag == COPY) {
+                NodeId copiedFrom = null;
+                if (fullVersionable) {
+                    // base version of copied versionable node is reference value of
+                    // the histories jcr:copiedFrom property
+                    PropertyId propId = new PropertyId(srcState.getNodeId(), NameConstants.JCR_BASEVERSION);
+                    PropertyState prop = (PropertyState) srcStateMgr.getItemState(propId);
+                    copiedFrom = new NodeId(prop.getValues()[0].getUUID());
+                }
+                VersionManager manager = session.getVersionManager();
+                history = manager.getVersionHistory(session, newState, copiedFrom);
+            }
-                if (versionable && flag == COPY) {
-                    /**
-                     * a versionable node is being copied:
-                     * copied properties declared by mix:versionable need to be
-                     * adjusted accordingly.
-                     */
-                    VersionManager manager = session.getVersionManager();
+                if (history != null) {
-                            VersionHistoryInfo history =
-                                manager.getVersionHistory(session, newState);
-                            VersionHistoryInfo history =
-                                manager.getVersionHistory(session, newState);
-                            manager.getVersionHistory(session, newState);
