JCR-108
- Reload shared states from persistent storage, if PersistenceManager#store operation fails


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@161276 13f79535-47bb-0310-9956-ffa450edef68

+     * Load item state from persistent storage.
+     * @param id item id
+     * @return item state
+     */
+    private ItemState loadItemState(ItemId id)
+            throws NoSuchItemStateException, ItemStateException {
+
+        if (id.denotesNode()) {
+            return persistMgr.load((NodeId) id);
+        } else {
+            return persistMgr.load((PropertyId) id);
+        }
+    }
+
+    /**
-             * If some store operation was unsuccessful, we have to restore
-             * the original state of all items in the local change log.
+             * If some store operation was unsuccessful, we have to reload
+             * the state of modified and deleted items from persistent
+             * storage.
+
+                iter = shared.modifiedStates();
+                while (iter.hasNext()) {
+                    ItemState state = (ItemState) iter.next();
+                    try {
+                        state.copy(loadItemState(state.getId()));
+                    } catch (ItemStateException e) {
+                        state.discard();
+                    }
+                }
+                iter = shared.deletedStates();
+                while (iter.hasNext()) {
+                    ItemState state = (ItemState) iter.next();
+                    try {
+                        state.copy(loadItemState(state.getId()));
+                    } catch (ItemStateException e) {
+                        state.discard();
+                    }
+                }
+                iter = shared.addedStates();
+                while (iter.hasNext()) {
+                    ItemState state = (ItemState) iter.next();
+                    state.discard();
+                }
