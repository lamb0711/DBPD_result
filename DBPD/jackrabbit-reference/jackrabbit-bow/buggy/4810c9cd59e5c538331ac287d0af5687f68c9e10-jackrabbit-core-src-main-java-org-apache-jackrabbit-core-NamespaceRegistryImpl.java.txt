JCR-623 - Clustering
+ Transmit namespace registrations
+ Transmit nodetype registrations


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@482707 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.cluster.NamespaceEventChannel;
+import org.apache.jackrabbit.core.cluster.NamespaceEventListener;
-        implements NamespaceRegistry, NameCache {
+        implements NamespaceRegistry, NameCache, NamespaceEventListener {
+     * Namespace event channel.
+     */
+    private NamespaceEventChannel eventChannel;
+
+    /**
+    /**
+     * Set an event channel to inform about changes.
+     *
+     * @param eventChannel event channel
+     */
+    public void setEventChannel(NamespaceEventChannel eventChannel) {
+        this.eventChannel = eventChannel;
+        eventChannel.setListener(this);
+    }
+
+        if (eventChannel != null) {
+            eventChannel.remapped(oldPrefix, prefix, uri);
+        }
+
+
+    //-----------------------------------------------< NamespaceEventListener >
+
+    /**
+     * {@inheritDoc}
+     */
+    public void externalRemap(String oldPrefix, String newPrefix, String uri)
+            throws RepositoryException {
+
+        if (newPrefix == null) {
+            /**
+             * as we can't guarantee that there are no references to the specified
+             * namespace (in names of nodes/properties/node types etc.) we simply
+             * don't allow it.
+             */
+            throw new NamespaceException("unregistering namespaces is not supported.");
+        }
+
+        if (oldPrefix != null) {
+            // remove old prefix mapping
+            prefixToURI.remove(oldPrefix);
+            uriToPrefix.remove(uri);
+        }
+
+        // add new prefix mapping
+        prefixToURI.put(newPrefix, uri);
+        uriToPrefix.put(uri, newPrefix);
+
+        // persist mappings
+        store();
+
+        // notify listeners
+        if (oldPrefix != null) {
+            // remapped existing namespace uri to new prefix
+            notifyNamespaceRemapped(oldPrefix, newPrefix, uri);
+        } else {
+            // added new namespace uri mapped to prefix
+            notifyNamespaceAdded(newPrefix, uri);
+        }
+
+    }
