JCR-2542: spi2dav: EventFilters not respected

- spi.commons extension interface for Session extension
- noLocal flag support
- client sends session identifier (in Link header field) on write operations so that POLL can compute the flag
- SUBSCRIBE returns flags indicating extension features 

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1203173 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.Enumeration;
+import org.apache.jackrabbit.spi.commons.SessionExtensions;
+    public static final String ATTRIBUTE_SESSION_ID = SessionProviderImpl.class + "#sessionid()";
+    
-        String userData = getJcrUserData(request);
+
+        // extract information from Link header fields
+        LinkHeaderFieldParser lhfp = new LinkHeaderFieldParser(
+                request.getHeaders("Link"));
+        String userData = getJcrUserData(lhfp);
+
+        String sessionId = getSessionIdentifier(lhfp);
+        if (s instanceof SessionExtensions) {
+            SessionExtensions xs = (SessionExtensions) s;
+            xs.setAttribute(ATTRIBUTE_SESSION_ID, sessionId);
+        }
-    private String getJcrUserData(HttpServletRequest request) {
+    private String getJcrUserData(LinkHeaderFieldParser lhfp) {
-        Enumeration<?> fieldValues = request.getHeaders("link");
-        if (fieldValues.hasMoreElements()) {
-            LinkHeaderFieldParser lhfp = new LinkHeaderFieldParser(fieldValues);
-            String target = lhfp
-                    .getFirstTargetForRelation(JcrRemotingConstants.RELATION_USER_DATA);
-            if (target != null) {
-                jcrUserData = getJcrUserData(target);
-            }
+        String target = lhfp
+                .getFirstTargetForRelation(JcrRemotingConstants.RELATION_USER_DATA);
+        if (target != null) {
+            jcrUserData = getJcrUserData(target);
+
+    // find first link relation for remote session identifier
+    private String getSessionIdentifier(LinkHeaderFieldParser lhfp) {
+        return lhfp
+                .getFirstTargetForRelation(JcrRemotingConstants.RELATION_REMOTE_SESSION_ID);
+    }
+
