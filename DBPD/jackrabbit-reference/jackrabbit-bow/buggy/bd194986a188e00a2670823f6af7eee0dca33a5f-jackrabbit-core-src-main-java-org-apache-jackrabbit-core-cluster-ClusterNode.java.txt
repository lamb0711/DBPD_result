JCR-780 - Simultaneous updates by multiple sessions might not appear in the journal


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@516324 13f79535-47bb-0310-9956-ffa450edef68

+         * Attribute name used to store record.
+         */
+        private static final String ATTRIBUTE_RECORD = "record";
+
+        /**
-         * Record being appended.
-         */
-        private Record record;
-
-        /**
-        public void updateCreated() {
+        public void updateCreated(Update update) {
-            if (record != null) {
-                String msg = "Record already created.";
-                log.warn(msg);
-                return;
-            }
-                sync();
-                record = journal.getProducer(PRODUCER_ID).append();
-                //sync();
+                Record record = journal.getProducer(PRODUCER_ID).append();
+                update.setAttribute(ATTRIBUTE_RECORD, record);
-        public void updatePrepared(ChangeLog changes, EventStateCollection esc) {
+        public void updatePrepared(Update update) {
+            Record record = (Record) update.getAttribute(ATTRIBUTE_RECORD);
+            EventStateCollection events = update.getEvents();
+            ChangeLog changes = update.getChanges();
-                write(record, changes, esc);
+                write(record, changes, events);
-                    record = null;
+                    update.setAttribute(ATTRIBUTE_RECORD, null);
-        public void updateCommitted() {
+        public void updateCommitted(Update update) {
+            Record record = (Record) update.getAttribute(ATTRIBUTE_RECORD);
-                record = null;
+                update.setAttribute(ATTRIBUTE_RECORD, null);
-        public void updateCancelled() {
+        public void updateCancelled(Update update) {
+            Record record = (Record) update.getAttribute(ATTRIBUTE_RECORD);
-                record = null;
+                update.setAttribute(ATTRIBUTE_RECORD, null);
