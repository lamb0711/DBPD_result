JCR-2946 - Improve implementation of DavResource#getProperty(DavPropertyName)
JCR-2948 - Add possibility to PROPFIND the JCR_NODETYPES_CND_LN property

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1155296 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.webdav.jcr.property.JcrDavPropertyNameSet;
+import org.apache.jackrabbit.webdav.property.DavPropertyNameSet;
-     * logic is applyed to spool the property content:
+     * logic is applied to spool the property content:
+    @Override
+    public DavProperty<?> getProperty(DavPropertyName name) {
+        DavProperty prop = super.getProperty(name);
+
+        if (prop == null && exists()) {
+            try {
+                Property p = (Property) item;
+                if (JCR_LENGTH.equals(name) && !isMultiple()) {
+                    long length = p.getLength();
+                    prop = new DefaultDavProperty<String>(JCR_LENGTH, String.valueOf(length), true);
+                } else if (JCR_LENGTHS.equals(name) && isMultiple()) {
+                    prop = new LengthsProperty(p.getLengths());
+                }
+            } catch (RepositoryException e) {
+                log.error("Failed to retrieve resource properties: "+e.getMessage());
+            }
+        }
+
+        return prop;
+    }
+
+    @Override
+    protected void initPropertyNames() {
+        super.initPropertyNames();
+        if (exists()) {
+            DavPropertyNameSet propNames = (isMultiple() ?
+                    JcrDavPropertyNameSet.PROPERTY_MV_SET :
+                    JcrDavPropertyNameSet.PROPERTY_SET);
+            names.addAll(propNames);
+        }
+    }
+
-                    properties.add(new LengthsProperty(prop.getLengths()));
-                    long length = prop.getLength();
-                    properties.add(new DefaultDavProperty<String>(JCR_LENGTH, String.valueOf(length), true));
