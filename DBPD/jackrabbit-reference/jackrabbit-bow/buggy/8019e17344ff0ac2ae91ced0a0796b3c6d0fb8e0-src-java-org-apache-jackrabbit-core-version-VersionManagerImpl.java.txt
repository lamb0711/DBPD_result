reviewed references stuff in respect to VirtualItemStateProviders and added some clarifying comments

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@328088 13f79535-47bb-0310-9956-ffa450edef68

-     * todo FIXME quick&dirty workaround for failing referential integrity-related junit tests
+     * Spezialized SharedItemStateManager that filters out NodeReferences to
+     * non-versioning states.
-        protected void updateReferences(ChangeLog changes)
-                throws ItemStateException {
-            //super.updateReferences(changes);
-        }
-
-            //super.checkReferentialIntegrity(changes);
+            // only store VV-type references and NV-type references
+
+            // check whether targets of modified node references exist
+            for (Iterator iter = changes.modifiedRefs(); iter.hasNext();) {
+                NodeReferences refs = (NodeReferences) iter.next();
+                NodeId id = new NodeId(refs.getUUID());
+                // no need to check existence of target if there are no references
+                if (refs.hasReferences()) {
+                    if (!changes.has(id) && !hasItemState(id)) {
+                        // remove references
+                        iter.remove();
+                    }
+                }
+            }
