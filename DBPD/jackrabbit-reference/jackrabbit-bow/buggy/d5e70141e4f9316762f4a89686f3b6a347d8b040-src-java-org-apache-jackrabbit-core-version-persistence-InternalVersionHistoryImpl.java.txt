- reset updateable item state mgr in case an update operation fails
- import on workspace (work in progress!)

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@156972 13f79535-47bb-0310-9956-ffa450edef68

+            boolean succeeded = false;
-            stateMgr.edit();
+            try {
+                stateMgr.edit();
-            // remove from persistance state
-            node.removeNode(v.getNode().getName());
+                // remove from persistance state
+                node.removeNode(v.getNode().getName());
-            // unregister from labels
-            QName[] labels = v.internalGetLabels();
-            for (int i = 0; i < labels.length; i++) {
-                v.internalRemoveLabel(labels[i]);
-                labelNode.removeNode(labels[i]);
+                // unregister from labels
+                QName[] labels = v.internalGetLabels();
+                for (int i = 0; i < labels.length; i++) {
+                    v.internalRemoveLabel(labels[i]);
+                    labelNode.removeNode(labels[i]);
+                }
+                // detach from the version graph
+                v.internalDetach();
+
+                // and remove from history
+                versionCache.remove(v.getId());
+
+                // store changes
+                node.store();
+
+                stateMgr.update();
+                succeeded = true;
+            } finally {
+                // update operation failed, cancel all modifications
+                if (!succeeded) {
+                    stateMgr.cancel();
+                }
-            // detach from the version graph
-            v.internalDetach();
-
-            // and remove from history
-            versionCache.remove(v.getId());
-
-            // store changes
-            node.store();
-
-            stateMgr.update();
+        UpdatableItemStateManager stateMgr = getVersionManager().getItemStateMgr();
+        boolean succeeded = false;
-            UpdatableItemStateManager stateMgr = getVersionManager().getItemStateMgr();
+            succeeded = true;
+        } finally {
+            // update operation failed, cancel all modifications
+            if (!succeeded) {
+                stateMgr.cancel();
+            }
+        UpdatableItemStateManager stateMgr = getVersionManager().getItemStateMgr();
+        boolean succeeded = false;
-            UpdatableItemStateManager stateMgr = getVersionManager().getItemStateMgr();
+            succeeded = true;
+        } finally {
+            // update operation failed, cancel all modifications
+            if (!succeeded) {
+                stateMgr.cancel();
+            }
