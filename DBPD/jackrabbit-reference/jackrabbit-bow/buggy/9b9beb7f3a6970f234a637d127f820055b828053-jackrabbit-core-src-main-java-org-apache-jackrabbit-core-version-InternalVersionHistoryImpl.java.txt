JCR-1440: NPE Thrown when two Cluster Nodes are hitting the same underlying database

Patch by Ryan Brush

This needs more work (the solution reminds me of the double checked-locking antipattern), but at least it solves the most pressing issue and does not seem to cause any notable risk to other use cases.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@911856 13f79535-47bb-0310-9956-ffa450edef68

+        InternalVersion v = getCachedVersion(id);
+
+        // If the version was not found, our cache may not have been
+        // synchronized with updates from another cluster node.  Reload the history
+        // to be sure we have the latest updates and try again.
+        if (v == null) {
+            try {
+                reload();
+            } catch (RepositoryException e) {
+
+                // We should add the checked exception to this method definition
+                // so we don't need to wrap it.
+                // Avoiding it for now to limit impact of this fix.
+                throw new RuntimeException(e);
+            }
+            v = getCachedVersion(id);
+        }
+
+        return v;
+    }
+
+    /**
+     * Returns the version from cache, or <code>null</code> if it is not
+     * present.
+     */
+    private InternalVersion getCachedVersion(NodeId id) {
