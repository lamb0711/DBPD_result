JCR-3040: JMX Stats for the Session

Measure read and write duration of SessionOperations

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1182408 13f79535-47bb-0310-9956-ffa450edef68

-     * Number of nanoseconds in a microsecond.
-     */
-    private static final int NS_PER_US = 1000;
-
-    /**
-     * Number of nanoseconds in a millisecond.
-     */
-    private static final int NS_PER_MS = 1000000;
-
-    /**
+     * Duration of read operations.
+     */
+    private final AtomicLong readDuration;
+
+    /**
+     * Duration of write operations.
+     */
+    private final AtomicLong writeDuration;
+
+    /**
+        this.readDuration = statistics.getCounter("read.duration");
+        this.writeDuration = statistics.getCounter("write.duration");
-                // JCR-3040: Increment the operation counters
-                if (isWriteOperation) {
-                    writeCounter.incrementAndGet();
-                } else {
-                    readCounter.incrementAndGet();
-                }
-
-                // Perform the actual operation, optionally with debug logs
-                if (log.isDebugEnabled()) {
-                    log.debug("Performing {}", operation);
-                    long start = System.nanoTime();
-                    try {
-                        return operation.perform(context);
-                    } finally {
-                        long time = System.nanoTime() - start;
-                        if (time > NS_PER_MS) {
-                            log.debug("Performed {} in {}ms",
-                                    operation, time / NS_PER_MS);
-                        } else {
-                            log.debug("Performed {} in {}us",
-                                    operation, time / NS_PER_US);
-                        }
-                    }
-                } else {
+                // Perform the actual operation
+                log.debug("Performing {}", operation);
+                long start = System.nanoTime();
+                try {
+                } finally {
+                    long time = System.nanoTime() - start;
+
+                    // JCR-3040: Increment the operation counters
+                    if (isWriteOperation) {
+                        writeCounter.incrementAndGet();
+                        writeDuration.addAndGet(time);
+                    } else {
+                        readCounter.incrementAndGet();
+                        readDuration.addAndGet(time);
+                    }
+
+                    log.debug("Performed {} in {}us", operation, time);
