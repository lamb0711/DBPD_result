JCR-906: Introduce similarity function
- initial version which uses a copy of the class MoreLikeThis from the lucene similar contrib.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@536515 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.HierarchyManager;
+import org.apache.jackrabbit.core.HierarchyManagerImpl;
+import org.apache.jackrabbit.core.NodeImpl;
+import org.apache.jackrabbit.core.NodeId;
+import org.apache.jackrabbit.core.ItemId;
+     * A hierarchy manager based on {@link #sharedItemMgr} to resolve paths.
+     */
+    private HierarchyManager hmgr;
+
+    /**
+     * @param hmgr            a hierarchy manager based on sharedItemMgr.
+                               HierarchyManager hmgr,
+        this.hmgr = hmgr;
-        LuceneQueryBuilder builder = new LuceneQueryBuilder(root, session,
-                sharedItemMgr, nsMappings, analyzer, propReg, synonymProvider);
+        NodeId id = ((NodeImpl) session.getRootNode()).getNodeId();
+        HierarchyManager hmgr = new HierarchyManagerImpl(
+                id, sharedItemMgr, session);
+        LuceneQueryBuilder builder = new LuceneQueryBuilder(
+                root, session, sharedItemMgr, hmgr, nsMappings,
+                analyzer, propReg, synonymProvider);
+        if (node.getOperation() == QueryConstants.OPERATION_SIMILAR) {
+            try {
+                ItemId id = hmgr.resolvePath(session.getQPath(node.getStringValue()));
+                String uuid = "";
+                if (id != null && id.denotesNode()) {
+                    uuid = ((NodeId) id).getUUID().toString();
+                }
+                return new SimilarityQuery(uuid, analyzer);
+            } catch (Exception e) {
+                exceptions.add(e);
+            }
+        }
+
