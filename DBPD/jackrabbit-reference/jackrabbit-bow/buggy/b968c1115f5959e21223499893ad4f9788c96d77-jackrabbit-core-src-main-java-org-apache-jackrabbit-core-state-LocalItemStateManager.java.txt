JCR-798: ConcurrentModificationException during logout

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@519892 13f79535-47bb-0310-9956-ffa450edef68

-        Iterator iter = cache.values().iterator();
-        while (iter.hasNext()) {
-            ItemState state = (ItemState) iter.next();
-            dispatcher.notifyStateDiscarded(state);
-            // let the item state know that it has been disposed
-            state.onDisposed();
+
+        // JCR-798: copy cached item states to array
+        // to avoid ConcurrentModificationException
+        ItemState[] isa = (ItemState[]) cache.values().toArray(
+                new ItemState[cache.size()]);
+        for (int i = 0; i < isa.length; i++) {
+            ItemState state = isa[i];
+            if (state != null) {
+                dispatcher.notifyStateDiscarded(state);
+                // let the item state know that it has been disposed
+                state.onDisposed();
+            }
+
