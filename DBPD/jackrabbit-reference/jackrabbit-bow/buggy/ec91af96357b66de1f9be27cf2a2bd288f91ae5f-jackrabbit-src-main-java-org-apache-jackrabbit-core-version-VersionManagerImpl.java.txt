JCR-449 inconsistency in internal version items during commits


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@411154 13f79535-47bb-0310-9956-ffa450edef68

-            synchronized (versionItems) {
-                InternalVersionItem item = (InternalVersionItem) versionItems.get(id);
-                if (item == null) {
-                    if (stateMgr.hasItemState(id)) {
-                        NodeState state = (NodeState) stateMgr.getItemState(id);
-                        NodeStateEx pNode = new NodeStateEx(stateMgr, ntReg, state, null);
-                        NodeId parentId = pNode.getParentId();
-                        InternalVersionItem parent = getItem(parentId);
-                        QName ntName = state.getNodeTypeName();
-                        if (ntName.equals(QName.NT_FROZENNODE)) {
-                            item = new InternalFrozenNodeImpl(this, pNode, parent);
-                        } else if (ntName.equals(QName.NT_VERSIONEDCHILD)) {
-                            item = new InternalFrozenVHImpl(this, pNode, parent);
-                        } else if (ntName.equals(QName.NT_VERSION)) {
-                            item = ((InternalVersionHistory) parent).getVersion(id);
-                        } else if (ntName.equals(QName.NT_VERSIONHISTORY)) {
-                            item = new InternalVersionHistoryImpl(this, pNode);
-                        } else {
-                            return null;
-                        }
+            aquireReadLock();
+            InternalVersionItem item = (InternalVersionItem) versionItems.get(id);
+            if (item == null) {
+                if (stateMgr.hasItemState(id)) {
+                    NodeState state = (NodeState) stateMgr.getItemState(id);
+                    NodeStateEx pNode = new NodeStateEx(stateMgr, ntReg, state, null);
+                    NodeId parentId = pNode.getParentId();
+                    InternalVersionItem parent = getItem(parentId);
+                    QName ntName = state.getNodeTypeName();
+                    if (ntName.equals(QName.NT_FROZENNODE)) {
+                        item = new InternalFrozenNodeImpl(this, pNode, parent);
+                    } else if (ntName.equals(QName.NT_VERSIONEDCHILD)) {
+                        item = new InternalFrozenVHImpl(this, pNode, parent);
+                    } else if (ntName.equals(QName.NT_VERSION)) {
+                        item = ((InternalVersionHistory) parent).getVersion(id);
+                    } else if (ntName.equals(QName.NT_VERSIONHISTORY)) {
+                        item = new InternalVersionHistoryImpl(this, pNode);
+                    } else {
+                        return null;
-                    versionItems.put(id, item);
-                return item;
+                versionItems.put(id, item);
+            return item;
+        } finally {
+            releaseReadLock();
-        synchronized (versionItems) {
+        try {
+            aquireReadLock();
+        } finally {
+            releaseReadLock();
