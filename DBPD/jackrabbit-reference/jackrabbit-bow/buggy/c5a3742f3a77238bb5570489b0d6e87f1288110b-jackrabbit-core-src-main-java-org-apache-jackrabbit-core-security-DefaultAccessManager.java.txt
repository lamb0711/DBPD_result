JCR-2646 : AccessControlManager#getEffectivePolicies(String) may expose AC content without proper permissions
JCR-2657 : DefaultAccessManager#hasPrivileges(String,Set,Privilege[]) doesn't close compiled permissions
JCR-2649 : Provide means to display the effective policies for a given set of principals

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@954964 13f79535-47bb-0310-9956-ffa450edef68

-        return acProvider.getEffectivePolicies(getPath(absPath));
+        return acProvider.getEffectivePolicies(getPath(absPath), compiledPermissions);
+     * @see org.apache.jackrabbit.api.security.JackrabbitAccessControlManager#getEffectivePolicies(Set)
+     */
+    public AccessControlPolicy[] getEffectivePolicies(Set<Principal> principals) throws AccessDeniedException, AccessControlException, UnsupportedRepositoryOperationException, RepositoryException {
+        checkInitialized();
+        return acProvider.getEffectivePolicies(principals, compiledPermissions);
+    }
+
+    /**
-            return (acProvider.compilePermissions(principals).getPrivileges(p) | ~privs) == -1;
+            CompiledPermissions perms = acProvider.compilePermissions(principals);
+            try {
+                return (perms.getPrivileges(p) | ~privs) == -1;
+            } finally {
+                perms.close();
+            }
+
