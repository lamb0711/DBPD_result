JCR-3069: add new ConsistencyChecker interface, implement it in BundleDbPersistenceManager, use it in ConcurrentImportTest, extend AutoFixCorruptNode to check it (work-in-progress)

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1181777 13f79535-47bb-0310-9956-ffa450edef68

+
+
+
+import org.apache.jackrabbit.core.TestHelper;
+import org.apache.jackrabbit.core.persistence.check.ConsistencyReport;
+    /**
+     * Unit test for <a
+     * href="https://issues.apache.org/jira/browse/JCR-3069">JCR-3069</a>
+     */
+    public void testAutoFixWithConsistencyCheck() throws Exception {
+
+        // new repository
+        TransientRepository rep = new TransientRepository(new File(TEST_DIR));
+        Session s = openSession(rep, false);
+        Node root = s.getRootNode();
+
+        // add nodes /test and /test/missing
+        Node test = root.addNode("test");
+        Node missing = test.addNode("missing");
+        missing.addMixin("mix:referenceable");
+        UUID id = UUID.fromString(missing.getIdentifier());
+        s.save();
+        s.logout();
+
+        // remove the bundle for /test/missing directly in the database
+        Connection conn = DriverManager.getConnection("jdbc:derby:" + TEST_DIR
+                + "/workspaces/default/db");
+        PreparedStatement prep = conn
+                .prepareStatement("delete from DEFAULT_BUNDLE  where NODE_ID_HI=? and NODE_ID_LO=?");
+        prep.setLong(1, id.getMostSignificantBits());
+        prep.setLong(2, id.getLeastSignificantBits());
+        prep.executeUpdate();
+        conn.close();
+
+        s = openSession(rep, false);
+        try {
+            ConsistencyReport r = TestHelper.checkConsistency(s);
+            assertNotNull(r);
+            assertNotNull(r.getItems());
+            assertEquals(1, r.getItems().size());
+            assertEquals(test.getIdentifier(), r.getItems().iterator().next()
+                    .getNodeId());
+        } finally {
+            s.logout();
+            rep.shutdown();
+            FileUtils.deleteDirectory(new File("repository"));
+        }
+
+    }
+
-        Connection conn = DriverManager.getConnection(
-                "jdbc:derby:"+TEST_DIR+"/workspaces/default/db");
-        PreparedStatement prep = conn.prepareStatement(
-                "delete from DEFAULT_BUNDLE  where NODE_ID_HI=? and NODE_ID_LO=?");
+        Connection conn = DriverManager.getConnection("jdbc:derby:" + TEST_DIR
+                + "/workspaces/default/db");
+        PreparedStatement prep = conn
+                .prepareStatement("delete from DEFAULT_BUNDLE  where NODE_ID_HI=? and NODE_ID_LO=?");
-    private Session openSession(Repository rep, boolean autoFix) throws RepositoryException {
-        SimpleCredentials cred = new SimpleCredentials("admin", "admin".toCharArray());
+    private Session openSession(Repository rep, boolean autoFix)
+            throws RepositoryException {
+        SimpleCredentials cred = new SimpleCredentials("admin",
+                "admin".toCharArray());
-            cred.setAttribute("org.apache.jackrabbit.autoFixCorruptions", "true");
+            cred.setAttribute("org.apache.jackrabbit.autoFixCorruptions",
+                    "true");
