JCR-1016: Allow RepositoryAccessServlet to get the Repository from a ServletContext attribute
    - Applied patch from Bertrand Delacretaz

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@558192 13f79535-47bb-0310-9956-ffa450edef68

-
+    
+    /**
+     * if this is set we try to get a Repository from the ServletContext
+     */
+    private String repositoryContextAttributeName;
+    
+        
+        repositoryContextAttributeName = getServletConfig().getInitParameter("repository.context.attribute.name");
+            
-        return (RepositoryAccessServlet) ctx.getAttribute(CTX_PARAM_THIS);
+        final RepositoryAccessServlet instance = (RepositoryAccessServlet) ctx.getAttribute(CTX_PARAM_THIS);
+        if(instance==null) {
+            throw new IllegalStateException(
+                "No RepositoryAccessServlet instance in ServletContext, RepositoryAccessServlet servlet not initialized?"
+            );
+        }
+        return instance;
+    
+    /**
+     *  If our config said so, try to retrieve a Repository from the ServletContext 
+     */
+    protected Repository getRepositoryByContextAttribute() {
+        Repository result = null;
+        if(repositoryContextAttributeName!=null) {
+            result = (Repository)getServletContext().getAttribute(repositoryContextAttributeName);
+            
+            if(log.isDebugEnabled()) {
+                if(result!=null) {
+                    log.debug("Got Repository from ServletContext attribute '" + repositoryContextAttributeName + "'");
+                } else {
+                    log.debug("ServletContext attribute '" + repositoryContextAttributeName + "' does not provide a Repository");
+                }
+            }
+        }
+        return result;
+    }
+                // try to get via context attribute
+                repository = getRepositoryByContextAttribute();
+            }
+            if (repository == null) {
