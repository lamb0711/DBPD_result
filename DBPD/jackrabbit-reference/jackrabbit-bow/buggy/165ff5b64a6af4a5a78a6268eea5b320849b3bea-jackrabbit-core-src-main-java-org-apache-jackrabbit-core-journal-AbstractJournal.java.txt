JCR-2881 - Deadlock on version operations in a clustered environment


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1067901 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.version.InternalVersionManagerImpl;
+import org.apache.jackrabbit.core.version.VersioningLock;
+     * Internal version manager.
+     */
+    private InternalVersionManagerImpl internalVersionManager;
+
+    /**
+        if (internalVersionManager != null) {
+            VersioningLock.ReadLock lock =
+                internalVersionManager.acquireReadLock();
+            try {
+                internalSync();
+            } finally {
+                lock.release();
+            }
+        } else {
+            internalSync();
+        }
+    }
+
+    private void internalSync() throws JournalException {
+        if (internalVersionManager != null) {
+            VersioningLock.ReadLock lock =
+                internalVersionManager.acquireReadLock();
+            try {
+                internalLockAndSync();
+            } finally {
+                lock.release();
+            }
+        } else {
+            internalLockAndSync();
+        }
+    }
+
+    private void internalLockAndSync() throws JournalException {
+     * Set the version manager.
+     */
+    public void setInternalVersionManager(InternalVersionManagerImpl internalVersionManager) {
+        this.internalVersionManager = internalVersionManager;
+    }
+
+    /**
