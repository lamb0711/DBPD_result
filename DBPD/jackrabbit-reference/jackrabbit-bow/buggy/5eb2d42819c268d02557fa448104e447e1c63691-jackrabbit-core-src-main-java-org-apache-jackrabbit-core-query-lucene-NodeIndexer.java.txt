JSR 283: Shareable nodes support in query

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@763188 13f79535-47bb-0310-9956-ffa450edef68

-                Field.Store.YES, Field.Index.NOT_ANALYZED_NO_NORMS, Field.TermVector.NO));
+                Field.Store.YES, Field.Index.NOT_ANALYZED_NO_NORMS));
-                doc.add(new Field(FieldNames.PARENT, "", Field.Store.YES, Field.Index.NOT_ANALYZED_NO_NORMS, Field.TermVector.NO));
+                doc.add(new Field(FieldNames.PARENT, "", Field.Store.YES,
+                        Field.Index.NOT_ANALYZED_NO_NORMS));
+            } else if (node.getSharedSet().isEmpty()) {
+                addParentChildRelation(doc, node.getParentId());
-                doc.add(new Field(
-                        FieldNames.PARENT, node.getParentId().toString(),
-                        Field.Store.YES, Field.Index.NOT_ANALYZED_NO_NORMS, Field.TermVector.NO));
-                NodeState parent = (NodeState) stateProvider.getItemState(node.getParentId());
-                ChildNodeEntry child = parent.getChildNodeEntry(node.getNodeId());
-                if (child == null) {
-                    // this can only happen when jackrabbit
-                    // is running in a cluster.
-                    throw new RepositoryException(
-                            "Missing child node entry for node with id: "
-                            + node.getNodeId());
+                // shareable node
+                for (Iterator it = node.getSharedSet().iterator(); it.hasNext(); ) {
+                    addParentChildRelation(doc, (NodeId) it.next());
-                Name name = child.getName();
-                addNodeName(doc, name.getNamespaceURI(), name.getLocalName());
+                // mark shareable nodes
+                doc.add(new Field(FieldNames.SHAREABLE_NODE, "",
+                        Field.Store.NO, Field.Index.NOT_ANALYZED_NO_NORMS));
+
+    /**
+     * Adds a parent child relation to the given <code>doc</code>.
+     *
+     * @param doc      the document.
+     * @param parentId the id of the parent node.
+     * @throws ItemStateException  if the parent node cannot be read.
+     * @throws RepositoryException if the parent node does not have a child node
+     *                             entry for the current node.
+     */
+    protected void addParentChildRelation(Document doc,
+                                          NodeId parentId)
+            throws ItemStateException, RepositoryException {
+        doc.add(new Field(
+                FieldNames.PARENT, parentId.toString(),
+                Field.Store.YES, Field.Index.NOT_ANALYZED_NO_NORMS, Field.TermVector.NO));
+        NodeState parent = (NodeState) stateProvider.getItemState(parentId);
+        ChildNodeEntry child = parent.getChildNodeEntry(node.getNodeId());
+        if (child == null) {
+            // this can only happen when jackrabbit
+            // is running in a cluster.
+            throw new RepositoryException(
+                    "Missing child node entry for node with id: "
+                    + node.getNodeId());
+        }
+        Name name = child.getName();
+        addNodeName(doc, name.getNamespaceURI(), name.getLocalName());
+    }
