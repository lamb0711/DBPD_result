JCR-1254 - DatabaseJournal commits twice inside a transaction, causing an error with MySQL

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@600980 13f79535-47bb-0310-9956-ffa450edef68

+    
+    /**
+     * Auto commit level.
+     */
+    private int lockLevel;
-
-            connection.setAutoCommit(false);
+            if (lockLevel++ == 0) {
+                setAutoCommit(connection, false);
+            }
-                rollback(connection);
-                setAutoCommit(connection, true);
+                doUnlock(false);
-        if (!successful) {
-            rollback(connection);
+        if (--lockLevel == 0) {
+            if (successful) {
+                commit(connection);
+            } else {
+                rollback(connection);
+            }
+            setAutoCommit(connection, true);
-        setAutoCommit(connection, true);
-            try {
-                insertRevisionStmt.clearParameters();
-                insertRevisionStmt.clearWarnings();
-                insertRevisionStmt.setLong(1, record.getRevision());
-                insertRevisionStmt.setString(2, getId());
-                insertRevisionStmt.setString(3, record.getProducerId());
-                insertRevisionStmt.setBinaryStream(4, in, length);
-                insertRevisionStmt.execute();
+            insertRevisionStmt.clearParameters();
+            insertRevisionStmt.clearWarnings();
+            insertRevisionStmt.setLong(1, record.getRevision());
+            insertRevisionStmt.setString(2, getId());
+            insertRevisionStmt.setString(3, record.getProducerId());
+            insertRevisionStmt.setBinaryStream(4, in, length);
+            insertRevisionStmt.execute();
-                connection.commit();
-            } finally {
-                setAutoCommit(connection, true);
-            }
+     * Commit a connection. Does nothing if the connection passed is
+     * <code>null</code> and logs any exception as warning.
+     *
+     * @param connection connection.
+     */
+    private static void commit(Connection connection) {
+        if (connection != null) {
+            try {
+                connection.commit();
+            } catch (SQLException e) {
+                String msg = "Error while committing connection: " + e.getMessage();
+                log.warn(msg);
+            }
+        }
+    }
+    
+    /**
