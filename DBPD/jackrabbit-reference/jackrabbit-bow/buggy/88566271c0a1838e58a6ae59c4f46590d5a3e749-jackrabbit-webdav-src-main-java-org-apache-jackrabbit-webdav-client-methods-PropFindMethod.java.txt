JCR-1769: add support for PROPFIND type allprop/include (see RFC4918), includes updates to client method impl and test case


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@702428 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.webdav.DavConstants;
+import org.w3c.dom.Node;
- * <code>PropFindMethod</code>...
+ * <code>PropFindMethod</code>, as specified in
+ * <a href="http://www.webdav.org/specs/rfc4918.html#rfc.section.9.1">RFC 4918, Section 9.1</a>
+ * <p>
+ * Supported types:
+ * <ul>
+ *   <li>{@link DavConstants#PROPFIND_ALL_PROP}: all custom properties, 
+ *   plus the live properties defined in RFC2518/RFC4918
+ *   <li>{@link DavConstants#PROPFIND_ALL_PROP_INCLUDE}: same as 
+ *   {@link DavConstants#PROPFIND_ALL_PROP} plus the properties specified
+ *   in <code>propNameSet</code>
+ *   <li>{@link DavConstants#PROPFIND_BY_PROPERTY}: just the properties
+ *   specified in <code>propNameSet</code>
+ *   <li>{@link DavConstants#PROPFIND_PROPERTY_NAMES}: just the property names
+ * </ul>
+ * <p>
+ * Note: only WebDAV level 3 servers support {@link DavConstants#PROPFIND_ALL_PROP_INCLUDE},
+ * older servers will ignore the extension and act as if {@link DavConstants#PROPFIND_ALL_PROP}
+ * was used.
-    private PropFindMethod(String uri, int propfindType, DavPropertyNameSet propNameSet,
+    public PropFindMethod(String uri, int propfindType, DavPropertyNameSet propNameSet,
+                    
-                default:
+                    
+                case PROPFIND_BY_PROPERTY:
-                        propfind.appendChild(DomUtil.createElement(document, XML_PROP, NAMESPACE));
+                        // name set missing, ask for a property that is known to exist
+                        Element prop = DomUtil.createElement(document, XML_PROP, NAMESPACE);
+                        Element resourcetype = DomUtil.createElement(document, PROPERTY_RESOURCETYPE, NAMESPACE);
+                        prop.appendChild(resourcetype);
+                        propfind.appendChild(prop);
+                    
+                case PROPFIND_ALL_PROP_INCLUDE:
+                    propfind.appendChild(DomUtil.createElement(document, XML_ALLPROP, NAMESPACE));
+                    if (propNameSet != null && ! propNameSet.isEmpty()) {
+                        Element include = DomUtil.createElement(document, XML_INCLUDE, NAMESPACE);
+                        Element prop = propNameSet.toXml(document);
+                        for (Node c = prop.getFirstChild(); c != null; c = c.getNextSibling()) {
+                            // copy over the children of <prop> to <include> element
+                            include.appendChild(c.cloneNode(true));
+                        }
+                        propfind.appendChild(include);
+                    }
+                    break;
+                  
+               default:
+                   throw new IllegalArgumentException("unknown propfind type");
-}
+}
