JCR-2456 Repository is corrupt after concurrent changes with the same session

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@900453 13f79535-47bb-0310-9956-ffa450edef68

+                checkAddedChildNodes();
+
-                long t1 = System.currentTimeMillis();
+                    long t1 = System.currentTimeMillis();
+         * Verify the added child nodes of the added or modified states exist.
+         * If they don't exist, most likely the problem is that the same session
+         * is used concurrently.
+         */
+        private void checkAddedChildNodes() throws ItemStateException {
+            for (ItemState state : local.addedStates()) {
+                checkAddedChildNode(state);
+            }
+            for (ItemState state : local.modifiedStates()) {
+                checkAddedChildNode(state);
+            }
+        }
+
+        private void checkAddedChildNode(ItemState state) throws ItemStateException {
+            if (state.isNode()) {
+                NodeState node = (NodeState) state;
+                for (ChildNodeEntry child : node.getAddedChildNodeEntries()) {
+                    NodeId id = child.getId();
+                    if (local.get(id) == null &&
+                            !id.equals(RepositoryImpl.VERSION_STORAGE_NODE_ID) &&
+                            !id.equals(RepositoryImpl.ACTIVITIES_NODE_ID) &&
+                            !id.equals(RepositoryImpl.NODETYPES_NODE_ID) &&
+                            !cache.isCached(id) &&
+                            !persistMgr.exists(id)) {
+                        String msg = "Trying to add a non-existing child node: " + id;
+                        log.debug(msg);
+                        throw new ItemStateException(msg);
+                    }
+                }
+            }
+        }
+
+        /**
