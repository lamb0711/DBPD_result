JCR-1963: Determination of property state difference should skip binary values

Property states are now only diffed when necessary

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@747839 13f79535-47bb-0310-9956-ffa450edef68

+import javax.jcr.PropertyType;
+import javax.jcr.RepositoryException;
+import javax.jcr.ValueFormatException;
+import javax.jcr.nodetype.ConstraintViolationException;
+
-import javax.jcr.PropertyType;
-import javax.jcr.RepositoryException;
-import javax.jcr.ValueFormatException;
-import javax.jcr.nodetype.ConstraintViolationException;
-
-    public boolean merge(ItemState another, boolean keepChanges) {
-        if (another == null || another == this) {
-            return false;
+    public MergeResult merge(ItemState another, boolean keepChanges) {
+        boolean modified = false;
+        if (another != null && another != this) {
+            if (another.isNode()) {
+                throw new IllegalArgumentException("Attempt to merge property state with node state.");
+            }
+            PropertyDiffer result = new PropertyDiffer(data, ((PropertyState) another).data);
+
+            // reset the pInfo to point to the pInfo of another state.
+            this.data = ((PropertyState) another).data;
+            // if transient changes should be preserved OR if there are not
+            // transient changes, simply return diff to indicate if this state
+            // was internally changed.
+            if (keepChanges || transientData == null) {
+                return result;
+            } else {
+                transientData.discardValues();
+                transientData = null;
+                modified = true;
+            }
-        if (another.isNode()) {
-            throw new IllegalArgumentException("Attempt to merge property state with node state.");
-        }
-        // calculate if the persistent values of this state differ from the
-        // other state.
-        boolean diff = diff(data, ((PropertyState) another).data);
-        // reset the pInfo to point to the pInfo of another state.
-        this.data = ((PropertyState) another).data;
-        // if transient changes should be preserved OR if there are not
-        // transient changes, simply return diff to indicate if this state
-        // was internally changed.
-        if (keepChanges || transientData == null) {
-            return diff;
-        } else {
-            transientData.discardValues();
-            transientData = null;
-            return true;
-        }
+        return new SimpleMergeResult(modified);
-
+        private boolean discarded;
+            discarded = true;
+
+    /**
+     * Helper class for delayed determination of property differences.
+     */
+    private class PropertyDiffer implements MergeResult {
+        private final PropertyData thisData;
+        private final PropertyData thatData;
+
+        PropertyDiffer(PropertyData thisData, PropertyData thatData) {
+            super();
+            this.thisData = thisData;
+            this.thatData = thatData;
+        }
+
+        public boolean modified() {
+            if (thisData.discarded || thatData.discarded) {
+                log.warn("Property data has been discarded");
+                return true;
+            }
+            return diff(thisData, thatData);
+        }
+    }
+
