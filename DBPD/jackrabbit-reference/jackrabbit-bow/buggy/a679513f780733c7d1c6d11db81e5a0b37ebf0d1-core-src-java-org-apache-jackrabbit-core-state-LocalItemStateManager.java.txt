JCR-188: Item states cached in UpdatableItemStateManager not discarded on logout

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@233459 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Iterator;
-     * Disposes this <code>LocalItemStateManager</code> and frees resources.
-     */
-    public void dispose() {
-        // clear cache
-        cache.evictAll();
-    }
-
-    /**
+    /**
+     * {@inheritDoc}
+     */
+    public void dispose() {
+        // this LocalItemStateManager instance is no longer needed;
+        // cached item states can now be safely discarded
+        Iterator iter = cache.values().iterator();
+        while (iter.hasNext()) {
+            ItemState state = (ItemState) iter.next();
+            // we're no longer interested in status changes of this item state
+            state.removeListener(this);
+            // discard item state; any remaining listeners will be informed
+            // about this status change
+            state.discard();
+            // let the item state know that it has been disposed
+            state.onDisposed();
+        }
+        // clear cache
+        cache.evictAll();
+    }
+
