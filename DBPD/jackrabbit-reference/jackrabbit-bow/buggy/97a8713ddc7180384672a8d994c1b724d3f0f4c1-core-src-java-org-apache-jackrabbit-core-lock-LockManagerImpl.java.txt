Fixed JCR-155 and JCR-207


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@279325 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.ItemId;
+import javax.jcr.ItemNotFoundException;
+import javax.jcr.AccessDeniedException;
-            Path path = node.getPrimaryPath();
+            Path path = getPath(node.getId());
-                Path path = node.getPrimaryPath();
+                Path path = getPath(node.getId());
-                Path path = node.getPrimaryPath();
+                Path path = getPath(node.getId());
-            Path path = node.getPrimaryPath();
+            Path path = getPath(node.getId());
-                Path path = node.getPrimaryPath();
-
-                PathMap.Element element = lockMap.map(path, true);
+                PathMap.Element element = lockMap.map(getPath(node.getId()), true);
-            PathMap.Element element = lockMap.map(node.getPrimaryPath(), true);
+            PathMap.Element element = lockMap.map(getPath(node.getId()), true);
-        Path path = node.getPrimaryPath();
-
+            Path path = getPath(node.getId());
+
-        checkLock(node.getPrimaryPath(), node.getSession());
+        checkLock(getPath(node.getId()), node.getSession());
-            NodeImpl node = (NodeImpl) session.getItemManager().
+            NodeImpl node = (NodeImpl) this.session.getItemManager().
-            NodeImpl node = (NodeImpl) session.getItemManager().
+            NodeImpl node = (NodeImpl) this.session.getItemManager().
+    /**
+     * Return the path of an item given its id. This method will lookup the
+     * item inside the system session and will therefore not find transiently
+     * created but not yet saved items
+     */
+    private Path getPath(ItemId id)
+            throws ItemNotFoundException, AccessDeniedException,
+                   RepositoryException {
+
+        return session.getHierarchyManager().getPath(id);
+    }
+    
