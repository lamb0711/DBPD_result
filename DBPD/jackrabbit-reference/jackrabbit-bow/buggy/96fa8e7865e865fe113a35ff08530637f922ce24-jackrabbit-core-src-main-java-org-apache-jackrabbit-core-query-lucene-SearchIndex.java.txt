JCR-1213: UUIDDocId cache does not work properly because of weakReferences in combination with new instance for combined indexreader

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@601342 13f79535-47bb-0310-9956-ffa450edef68

-        IndexReader parentReader = null;
+        CachingMultiReader parentReader = null;
-        IndexReader reader = index.getIndexReader();
+        CachingMultiReader reader = index.getIndexReader();
-            // todo FIXME not type safe
-            CachingMultiReader[] readers = {(CachingMultiReader) reader,
-                                            (CachingMultiReader) parentReader};
-            reader = new CombinedIndexReader(readers);
+            CachingMultiReader[] readers = {reader, parentReader};
+            return new CombinedIndexReader(readers);
+        } else {
+            return reader;
-        return reader;
+
+        /**
+         * {@inheritDoc}
+         */
+        public ForeignSegmentDocId createDocId(UUID uuid) throws IOException {
+            for (int i = 0; i < subReaders.length; i++) {
+                CachingMultiReader subReader = subReaders[i];
+                ForeignSegmentDocId doc = subReader.createDocId(uuid);
+                if (doc != null) {
+                    return doc;
+                }
+            }
+            return null;
+        }
+
+        /**
+         * {@inheritDoc}
+         */
+        public int getDocumentNumber(ForeignSegmentDocId docId) {
+            for (int i = 0; i < subReaders.length; i++) {
+                CachingMultiReader subReader = subReaders[i];
+                int realDoc = subReader.getDocumentNumber(docId);
+                if (realDoc >= 0) {
+                    return realDoc;
+                }
+            }
+            return -1;
+        }
