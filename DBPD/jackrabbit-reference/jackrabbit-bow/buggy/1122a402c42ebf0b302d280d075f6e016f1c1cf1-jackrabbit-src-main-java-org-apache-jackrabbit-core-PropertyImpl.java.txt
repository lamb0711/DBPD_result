JCR-288: inconsistent session state after Item/Session.save() throwing ReferentialIntegrityException

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@355510 13f79535-47bb-0310-9956-ffa450edef68

+    protected void restoreTransient(PropertyState transientState)
+            throws RepositoryException {
+        PropertyState thisState = (PropertyState) getOrCreateTransientItemState();
+        if (transientState.getStatus() == ItemState.STATUS_NEW
+                && thisState.getStatus() != ItemState.STATUS_NEW) {
+            thisState.setStatus(ItemState.STATUS_NEW);
+            stateMgr.disconnectTransientItemState(thisState);
+        }
+        // reapply transient changes
+        thisState.setDefinitionId(transientState.getDefinitionId());
+        thisState.setType(transientState.getType());
+        thisState.setMultiValued(transientState.isMultiValued());
+        thisState.setValues(transientState.getValues());
+    }
+
