JCR-2640: Internal repository context

Commit the first draft patch, more updates to come...

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@948757 13f79535-47bb-0310-9956-ffa450edef68

+     * The component context of the repository that issued this session.
+     */
+    protected final RepositoryContext repositoryContext;
+
+    /**
-     * @param rep
+     * @param repositoryContext repository context
-    protected SessionImpl(RepositoryImpl rep, AuthContext loginContext,
-                          WorkspaceConfig wspConfig)
+    protected SessionImpl(
+            RepositoryContext repositoryContext, AuthContext loginContext,
+            WorkspaceConfig wspConfig)
-        this(rep, loginContext.getSubject(), wspConfig);
+        this(repositoryContext, loginContext.getSubject(), wspConfig);
-     * @param rep
+     * @param repositoryContext repository context
-    protected SessionImpl(RepositoryImpl rep, Subject subject,
-                          WorkspaceConfig wspConfig)
+    protected SessionImpl(
+            RepositoryContext repositoryContext, Subject subject,
+            WorkspaceConfig wspConfig)
-        this.rep = rep;
+        this.repositoryContext = repositoryContext;
+        this.rep = repositoryContext.getRepository();
-        ntMgr = new NodeTypeManagerImpl(rep.getNodeTypeRegistry(), this, rep.getDataStore());
+        ntMgr = new NodeTypeManagerImpl(
+                repositoryContext.getNodeTypeRegistry(), this, rep.getDataStore());
-        wsp = createWorkspaceInstance(wspConfig,
-                rep.getWorkspaceStateManager(wspName), rep, this);
+        wsp = createWorkspaceInstance(
+                wspConfig, rep.getWorkspaceStateManager(wspName));
-                rep.getRootNodeId(), manager, rep.getNodeTypeRegistry());
+                repositoryContext.getRootNodeId(),
+                manager,
+                repositoryContext.getNodeTypeRegistry());
-     * @param rep       The repository
-     * @param session   The session
-    protected WorkspaceImpl createWorkspaceInstance(WorkspaceConfig wspConfig,
-                                                    SharedItemStateManager stateMgr,
-                                                    RepositoryImpl rep,
-                                                    SessionImpl session) {
-        return new WorkspaceImpl(wspConfig, stateMgr, rep, session);
+    protected WorkspaceImpl createWorkspaceInstance(
+            WorkspaceConfig wspConfig, SharedItemStateManager stateMgr) {
+        return new WorkspaceImpl(wspConfig, stateMgr, repositoryContext, this);
-        return ItemManager.createInstance(itemStateMgr, hierMgr, this,
-                ntMgr.getRootNodeDefinition(), rep.getRootNodeId());
+        return ItemManager.createInstance(
+                itemStateMgr, hierMgr, this,
+                ntMgr.getRootNodeDefinition(),
+                repositoryContext.getRootNodeId());
-
-        return rep.getVersionManager();
+        return repositoryContext.getInternalVersionManager();
-            validator = new ItemValidator(rep.getNodeTypeRegistry(), getHierarchyManager(), this);
+            validator = new ItemValidator(
+                    repositoryContext.getNodeTypeRegistry(),
+                    getHierarchyManager(), this);
-        InternalVersionManagerImpl vm = (InternalVersionManagerImpl) rep.getVersionManager();
+        InternalVersionManagerImpl vm = repositoryContext.getInternalVersionManager();
-            SessionImpl session = SystemSession.create(rep, wspInfo.getConfig());
+            SessionImpl session =
+                SystemSession.create(repositoryContext, wspInfo.getConfig());
