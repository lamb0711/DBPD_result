JCR-3395 : separate entries used for permission eval from ACEs exposed in JCR

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1370139 13f79535-47bb-0310-9956-ffa450edef68

-import javax.jcr.security.AccessControlEntry;
-import java.util.Collections;
-                    // retrieve the entries for the access controlled node
-                    List<AccessControlEntry> entries = entryCollector.collectEntries(null, new EntryFilterImpl(null, (NodeId) null, session));
-                    acls.add(new UnmodifiableAccessControlList(entries));
+                    acls.add(getACL(targetNode, N_REPO_POLICY, null));
-                    List<AccessControlEntry> aces = entryCollector.getEntries(accessControlledNode).getACEs();
-                    acls.add(new UnmodifiableAccessControlList(aces, accessControlledNode.getPath(), Collections.<String, Integer>emptyMap()));
+                    acls.add(getACL(accessControlledNode, N_POLICY, accessControlledNode.getPath()));
-                    List<AccessControlEntry> aces = entryCollector.collectEntries(null, new EntryFilterImpl(null, (NodeId) null, session));
-                    acls.add(new UnmodifiableAccessControlList(aces));
+                    acls.add(getACL(accessControlledNode, N_REPO_POLICY, null));
-                // retrieve the entries for the access controlled node
-                List<AccessControlEntry> aces = entryCollector.getEntries(node).getACEs();
-                acls.add(new UnmodifiableAccessControlList(aces, node.getPath(), Collections.<String, Integer>emptyMap()));
+                acls.add(getACL(node, N_POLICY, node.getPath()));
+    private AccessControlList getACL(NodeImpl accessControlledNode, Name policyName, String path) throws RepositoryException {
+        // collect the aces of that node.
+        NodeImpl aclNode = accessControlledNode.getNode(policyName);
+        AccessControlList acl = new ACLTemplate(aclNode, path);
+
+        return new UnmodifiableAccessControlList(acl);
+    }
+
