work in progress

- add check for existing property or node, that does not allow SNS
  at move-destination

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@463316 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.jcr2spi.state.ItemStateException;
+import org.apache.jackrabbit.jcr2spi.state.entry.ChildNodeEntry;
-    public static Operation create(Path srcPath, Path destPath, HierarchyManager hierMgr, NamespaceResolver nsResolver) throws RepositoryException , NoSuchNodeTypeException {
+    public static Operation create(Path srcPath, Path destPath,
+                                   HierarchyManager hierMgr, NamespaceResolver nsResolver)
+        throws ItemExistsException, NoSuchNodeTypeException, RepositoryException {
-        Move move = new Move(srcState, srcParentState, destParentState, destElement.getName());
+        QName destName = destElement.getName();
+
+        if (destParentState.hasPropertyName(destName)) {
+            throw new ItemExistsException("Move destination already exists (Property).");
+        } else if (destParentState.hasChildNodeEntry(destName)) {
+            ChildNodeEntry existing = destParentState.getChildNodeEntry(destName, Path.INDEX_DEFAULT);
+            try {
+                if (!existing.getNodeState().getDefinition().allowsSameNameSiblings()) {
+                    throw new ItemExistsException("Node existing at move destination does not allow same name siblings.");
+                }
+            } catch (ItemStateException e) {
+                throw new RepositoryException(e);
+            }
+        }
+
+        Move move = new Move(srcState, srcParentState, destParentState, destName);
