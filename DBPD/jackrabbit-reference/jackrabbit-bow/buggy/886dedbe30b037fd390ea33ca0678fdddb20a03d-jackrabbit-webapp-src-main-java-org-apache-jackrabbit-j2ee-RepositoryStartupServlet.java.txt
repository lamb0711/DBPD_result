JCR-3598: Oak in Jackrabbit deployment packages

Upgrade to Oak 0.15.
Make it possible to use Oak repositories in webapp/standalone.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1566604 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.oak.jcr.Jcr;
+import org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore;
+import org.apache.jackrabbit.oak.plugins.segment.SegmentStore;
+import org.apache.jackrabbit.oak.plugins.segment.file.FileStore;
+     * the TarMK segment store
+     */
+    private SegmentStore store;
+
+    /**
-                || config.getRepositoryHome() == null
-                || config.getRepositoryConfig() == null) {
+                || config.getRepositoryHome() == null) {
-        InputStream in = getServletContext().getResourceAsStream(repConfig);
-        if (in == null) {
-            try {
-                in = new FileInputStream(new File(repConfig));
-            } catch (FileNotFoundException e) {
-                // fallback to old config
+        if (repConfig != null) { // Jackrabbit Classic
+            InputStream in = getServletContext().getResourceAsStream(repConfig);
+            if (in == null) {
-                    in = new FileInputStream(new File(repHome, repConfig));
-                } catch (FileNotFoundException e1) {
-                    throw new ServletExceptionWithCause(
-                            "Repository configuration not found: " + repConfig, e);
+                    in = new FileInputStream(new File(repConfig));
+                } catch (FileNotFoundException e) {
+                    // fallback to old config
+                    try {
+                        in = new FileInputStream(new File(repHome, repConfig));
+                    } catch (FileNotFoundException e1) {
+                        throw new ServletExceptionWithCause(
+                                "Repository configuration not found: " + repConfig, e);
+                    }
-        }
-        try {
-            repository = createRepository(new InputSource(in), repHome);
-        } catch (RepositoryException e) {
-            throw new ServletExceptionWithCause("Error while creating repository", e);
+            try {
+                repository = createRepository(new InputSource(in), repHome);
+            } catch (RepositoryException e) {
+                throw new ServletExceptionWithCause("Error while creating repository", e);
+            }
+        } else { // Jackrabbit Oak
+            try {
+                String model = System.getProperty("sun.arch.data.model", "32");
+                store = new FileStore(repHome, 256*1024*1024, "64".equals(model));
+                repository = new Jcr(new SegmentNodeStore(store)).createRepository();
+            } catch (IOException e) {
+                throw new ServletExceptionWithCause("Error while creating repository", e);
+            }
-        if (repository instanceof JackrabbitRepository) {
+        if (store != null) {
+            store.close();
+            store = null;
+        } else if (repository instanceof JackrabbitRepository) {
