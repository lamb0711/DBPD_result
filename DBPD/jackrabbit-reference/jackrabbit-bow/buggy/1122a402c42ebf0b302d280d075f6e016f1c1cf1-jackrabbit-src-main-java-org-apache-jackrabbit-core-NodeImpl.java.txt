JCR-288: inconsistent session state after Item/Session.save() throwing ReferentialIntegrityException

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@355510 13f79535-47bb-0310-9956-ffa450edef68

+    protected void restoreTransient(NodeState transientState)
+            throws RepositoryException {
+        NodeState thisState = (NodeState) getOrCreateTransientItemState();
+        if (transientState.getStatus() == ItemState.STATUS_NEW
+                && thisState.getStatus() != ItemState.STATUS_NEW) {
+            thisState.setStatus(ItemState.STATUS_NEW);
+            stateMgr.disconnectTransientItemState(thisState);
+        }
+        // reapply transient changes
+        thisState.setParentUUID(transientState.getParentUUID());
+        thisState.setMixinTypeNames(transientState.getMixinTypeNames());
+        thisState.setDefinitionId(transientState.getDefinitionId());
+        thisState.setChildNodeEntries(transientState.getChildNodeEntries());
+        thisState.setPropertyNames(transientState.getPropertyNames());
+    }
+
