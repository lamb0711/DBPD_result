JCR-1138: Data store garbage collection deleted transient objects

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@583413 13f79535-47bb-0310-9956-ffa450edef68

+import java.lang.ref.WeakReference;
+import java.util.WeakHashMap;
+    
+    /**
+     * All data identifiers that are currently in use are in this set until they are garbage collected.
+     */
+    private WeakHashMap inUse = new WeakHashMap();
+        usesIdentifier(identifier);
+    
+    private void usesIdentifier(DataIdentifier identifier) {
+        inUse.put(identifier, new WeakReference(identifier));
+    }
+            usesIdentifier(identifier);
+        usesIdentifier(identifier);
-                file.delete();
-                count++;
+                DataIdentifier id = new DataIdentifier(file.getName());
+                if (!inUse.containsKey(id)) {
+                    file.delete();
+                    count++;
+                }
+    
+    /**
+     * Clear the in-use list. This is only used for testing to make the the garbage collection
+     * think that objects are no longer in use.
+     */
+    public void clearInUse() {
+        inUse.clear();
+    }
