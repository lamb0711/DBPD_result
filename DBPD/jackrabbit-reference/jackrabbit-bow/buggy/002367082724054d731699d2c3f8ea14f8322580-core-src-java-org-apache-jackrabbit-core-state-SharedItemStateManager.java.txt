fixed concurrency issue reported by walter raboch:
http://www.mail-archive.com/jackrabbit-dev@incubator.apache.org/msg02127.html

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@233511 13f79535-47bb-0310-9956-ffa450edef68

-    private VirtualItemStateProvider[] virtualProviders = new
-            VirtualItemStateProvider[0];
+    private VirtualItemStateProvider[] virtualProviders =
+            new VirtualItemStateProvider[0];
-     * @throws ItemStateException if an error occurs
+     * @throws StaleItemStateException if at least one of the affected item
+     *                                 states has become stale
+     * @throws ItemStateException if another error occurs
-            throws ItemStateException {
+            throws StaleItemStateException, ItemStateException {
+                    if (state.isStale()) {
+                        String msg = state.getId() + " has been modified externally";
+                        log.debug(msg);
+                        throw new StaleItemStateException(msg);
+                    }
+                    if (state.isStale()) {
+                        String msg = state.getId() + " has been modified externally";
+                        log.debug(msg);
+                        throw new StaleItemStateException(msg);
+                    }
+        ItemState state;
-            return persistMgr.load((NodeId) id);
+            state = persistMgr.load((NodeId) id);
-            return persistMgr.load((PropertyId) id);
+            state = persistMgr.load((PropertyId) id);
+        // init modification counter
+        state.touch();
+        return state;
