JCR-257: Use separate index for jcr:system tree

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@357961 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.name.NoPrefixDeclaredException;
+import javax.jcr.observation.ObservationManager;
+    /**
+     * Search manager for the jcr:system tree. May be <code>null</code> if
+     * none is configured.
+     */
+    private SearchManager systemSearchMgr;
+
+    /**
+     * Returns the system search manager or <code>null</code> if none is
+     * configured.
+     */
+    private SearchManager getSystemSearchManager(String wspName) throws RepositoryException {
+        if (systemSearchMgr == null) {
+            try {
+                if (repConfig.getSearchConfig() != null) {
+                    SystemSession defSysSession = getSystemSession(wspName);
+                    systemSearchMgr = new SystemSearchManager(repConfig.getSearchConfig(),
+                            nsReg, ntReg, defSysSession.getItemStateManager(), SYSTEM_ROOT_NODE_UUID);
+                    ObservationManager obsMgr = defSysSession.getWorkspace().getObservationManager();
+                    obsMgr.addEventListener(systemSearchMgr, Event.NODE_ADDED |
+                            Event.NODE_REMOVED | Event.PROPERTY_ADDED |
+                            Event.PROPERTY_CHANGED | Event.PROPERTY_REMOVED,
+                            "/" + QName.JCR_SYSTEM.toJCRName(defSysSession.getNamespaceResolver()),
+                            true, null, null, false);
+                } else {
+                    systemSearchMgr = null;
+                }
+            } catch (NoPrefixDeclaredException e) {
+                throw new RepositoryException(e);
+            }
+        }
+        return systemSearchMgr;
+    }
+
+        // shutdown system search manager if there is one
+        if (systemSearchMgr != null) {
+            systemSearchMgr.close();
+        }
+
-                searchMgr = new SearchManager(getSystemSession(),
-                        config.getSearchConfig(),
+                searchMgr = new SearchManager(config.getSearchConfig(),
+                        nsReg,
-                        getItemStateProvider());
+                        getItemStateProvider(),
+                        rootNodeUUID,
+                        getSystemSearchManager(getName()),
+                        SYSTEM_ROOT_NODE_UUID);
