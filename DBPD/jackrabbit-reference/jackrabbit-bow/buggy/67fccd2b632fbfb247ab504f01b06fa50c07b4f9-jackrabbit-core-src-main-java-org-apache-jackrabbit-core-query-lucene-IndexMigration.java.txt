JCR-1747: org.apache.jackrabbit.core.query.lucene.SearchIndex with in-memory lucene index

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@718218 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.lucene.store.FSDirectory;
-import org.apache.lucene.store.NoLockFactory;
+import org.apache.lucene.store.Directory;
-import org.apache.jackrabbit.core.fs.local.FileUtil;
+import org.apache.jackrabbit.core.query.lucene.directory.DirectoryManager;
-import java.io.File;
-     * @param indexDir the directory where the index is stored.
+     * @param directoryManager the directory manager.
-    public static void migrate(PersistentIndex index, File indexDir) throws IOException {
-        log.debug("Checking {} ...", indexDir.getAbsolutePath());
+    public static void migrate(PersistentIndex index,
+                               DirectoryManager directoryManager)
+            throws IOException {
+        Directory indexDir = index.getDirectory();
+        log.debug("Checking {} ...", indexDir);
-        log.debug("Index requires migration {}", indexDir.getAbsolutePath());
+        log.debug("Index requires migration {}", indexDir);
-        File migrationDir = new File(indexDir.getAbsoluteFile().getParentFile(), indexDir.getName() + "_v2.3");
-        if (migrationDir.exists()) {
-            FileUtil.delete(migrationDir);
+        String migrationName = index.getName() + "_v2.3";
+        if (directoryManager.hasDirectory(migrationName)) {
+            directoryManager.delete(migrationName);
-        if (!migrationDir.mkdirs()) {
-            throw new IOException("failed to create directory " +
-                    migrationDir.getAbsolutePath());
-        }
-        FSDirectory fsDir = FSDirectory.getDirectory(migrationDir,
-                NoLockFactory.getNoLockFactory());
+
+        Directory migrationDir = directoryManager.getDirectory(migrationName);
-            IndexWriter writer = new IndexWriter(fsDir, new JackrabbitAnalyzer());
+            IndexWriter writer = new IndexWriter(migrationDir, new JackrabbitAnalyzer());
-            fsDir.close();
+            migrationDir.close();
-        FileUtil.delete(indexDir);
-        if (!migrationDir.renameTo(indexDir)) {
+        directoryManager.delete(index.getName());
+        if (!directoryManager.rename(migrationName, index.getName())) {
-                    migrationDir.getAbsolutePath());
+                    migrationDir);
-        log.info("Migrated " + indexDir.getAbsolutePath());
+        log.info("Migrated " + index.getName());
