JCR-1039: Bundle Persistence Manager error - failing to read bundle the first time

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@563900 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.persistence.bundle.util.TrackingInputStream;
- * <li>&lt;param name="{@link #setExternalBLOBs(String)} externalBLOBs}" value="false"/>
-        DataInputStream din = null;
+        InputStream in = null;
-            TrackingInputStream cin = new TrackingInputStream(b.getBinaryStream());
-            din = new DataInputStream(cin);
+            // JCR-1039: pre-fetch/buffer blob data
+            long length = b.length();
+            byte[] bytes = new byte[(int) length];
+            in = b.getBinaryStream();
+            int read, pos = 0;
+            while ((read = in.read(bytes, pos, bytes.length - pos)) > 0) {
+                pos += read;
+            }
+            DataInputStream din = new DataInputStream(new ByteArrayInputStream(bytes));
-            bundle.setSize(cin.getPosition());
+            bundle.setSize(length);
-            closeStream(din);
+            closeStream(in);
