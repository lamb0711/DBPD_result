JCR-1892 Unique ID for org.apache.jackrabbit.value.BinaryValue

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@738119 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.data.DataIdentifier;
-import org.apache.jackrabbit.value.BinaryValue;
+                InternalValue result;
-                    return new InternalValue(getBLOBFileValue(store, value.getStream(), true));
-                }
-                if (value instanceof BLOBFileValue) {
-                    return new InternalValue((BLOBFileValue) value);
+                    BLOBFileValue blob = null;
+                    if (value instanceof BinaryValueImpl) {
+                        BinaryValueImpl bin = (BinaryValueImpl) value;
+                        DataIdentifier identifier = bin.getDataIdentifier();
+                        if (identifier != null) {
+                            // access the record to ensure it is not garbage collected
+                            if (store.getRecordIfStored(identifier) != null) {
+                                // it exists - so we don't need to stream it again
+                                // but we need to create a new object because the original
+                                // one might be in a different data store (repository)
+                                blob = BLOBInDataStore.getInstance(store, identifier);
+                            }
+                        }
+                    }
+                    if (blob == null) {
+                        blob = getBLOBFileValue(store, value.getStream(), true);
+                    }
+                    result = new InternalValue(blob);
+                } else if (value instanceof BLOBFileValue) {
+                    result = new InternalValue((BLOBFileValue) value);
-                        return createTemporary(stream);
+                        result = createTemporary(stream);
+                return result;
-                return new BinaryValue(((BLOBFileValue) val).getStream());
+                return new BinaryValueImpl((BLOBFileValue) val);
