JCR-1730: Background text extraction not possible when supportHighlighting is set true

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@694164 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.lucene.document.Field;
+import org.apache.lucene.document.Fieldable;
-import java.util.Enumeration;
+import java.util.Iterator;
-        Enumeration e = old.fields();
-        while (e.hasMoreElements()) {
-            Field f = (Field) e.nextElement();
-            if (f.readerValue() != null) {
-                try {
+        for (Iterator it = old.getFields().iterator(); it.hasNext(); ) {
+            Fieldable f = (Fieldable) it.next();
+            try {
+                if (f.readerValue() != null) {
-                } catch (IOException ex) {
-                    log.warn("Exception while disposing index document: " + ex);
+                } else if (f instanceof LazyTextExtractorField) {
+                    LazyTextExtractorField field = (LazyTextExtractorField) f;
+                    field.dispose();
+            } catch (IOException ex) {
+                log.warn("Exception while disposing index document: " + ex);
-        Enumeration fields = doc.fields();
-        while (fields.hasMoreElements()) {
-            Field f = (Field) fields.nextElement();
-            if (f.readerValue() instanceof TextExtractorReader) {
-                TextExtractorReader r = (TextExtractorReader) f.readerValue();
-                if (!r.isExtractorFinished()) {
+        for (Iterator it = doc.getFields().iterator(); it.hasNext(); ) {
+            Fieldable f = (Fieldable) it.next();
+            if (f instanceof LazyTextExtractorField) {
+                LazyTextExtractorField field = (LazyTextExtractorField) f;
+                if (!field.isExtractorFinished()) {
