JCR-1589: JSR 283 Retention & Hold Management (work in progress)
JCR-1957: Move common validation checks to a single place

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@738422 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.security.authorization.Permission;
-
-        // verify that parent node is checked-out
-        if (!parent.internalIsCheckedOut()) {
-            throw new VersionException(
-                    "Cannot set a property of a checked-in node: " + this);
-        }
-
-        // check protected flag
-        if (definition.isProtected()) {
-            throw new ConstraintViolationException(
-                    "Cannot set the value of a protected property: " + this);
-        }
-
-        if (multipleValues) {
-            if (!definition.isMultiple()) {
-                throw new ValueFormatException(
-                        "Single-valued property can not be set to"
-                        + " an array of values: " + this);
-            }
-        } else {
-            if (definition.isMultiple()) {
-                throw new ValueFormatException(
-                        "Multivalued property can not be set to a single"
-                        + " value (an array of lenght one is OK): " + this);
-            }
+        if (multipleValues != definition.isMultiple()) {
+            String msg = (multipleValues) ?
+                    "Single-valued property can not be set to an array of values:" :
+                    "Multivalued property can not be set to a single value (an array of lenght one is OK): ";
+            throw new ValueFormatException(msg + this);
-        // check lock status
-        parent.checkLock();
+        // check protected flag and for retention/hold      
+        int options = ItemValidator.CHECK_CONSTRAINTS;
+        session.getValidator().checkModify(this, options, Permission.NONE);
+        
+        // make sure the parent is checked-out and neither locked nor under retention
+        options = ItemValidator.CHECK_VERSIONING | ItemValidator.CHECK_LOCK |
+                ItemValidator.CHECK_HOLD | ItemValidator.CHECK_RETENTION;
+        session.getValidator().checkModify(parent, options, Permission.NONE);
