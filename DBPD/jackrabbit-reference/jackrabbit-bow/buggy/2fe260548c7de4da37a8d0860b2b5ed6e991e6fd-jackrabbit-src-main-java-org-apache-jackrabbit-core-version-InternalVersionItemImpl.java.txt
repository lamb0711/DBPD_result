JCR-486: Removed version is not invalidated


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@423943 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.state.ItemStateListener;
+import org.apache.jackrabbit.core.state.ItemState;
-abstract class InternalVersionItemImpl implements InternalVersionItem {
+abstract class InternalVersionItemImpl implements InternalVersionItem, ItemStateListener {
+
+    /**
+     * the underlying persistance node
+     */
+    protected final NodeStateEx node;
-    protected InternalVersionItemImpl(AbstractVersionManager vMgr) {
+    protected InternalVersionItemImpl(AbstractVersionManager vMgr, NodeStateEx node) {
+        this.node = node;
+        // register as listener. this is not the best solution since this item
+        // could be discarded by the GC and then later be recreated. this will
+        // unnecessarily increase the number of listeners.
+        node.getState().addListener(this);
+    //-----------------------------------------------------< ItemStateListener >
+    // handle notifications from underlying item states. currently, we only need
+    // to care about removals, since the versioning items do not cache their
+    // values
+
+    /**
+     * {@inheritDoc}
+     */
+    public void stateCreated(ItemState item) {
+        // ignore
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void stateModified(ItemState item) {
+        // ignore
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void stateDestroyed(ItemState item) {
+        vMgr.itemDiscarded(this);
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void stateDiscarded(ItemState item) {
+        // ignore
+    }
+
+
+
+
