JCR-1326: Log path of missing node when re-indexing fails

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@643369 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.spi.Path;
+import org.apache.jackrabbit.spi.PathFactory;
+import org.apache.jackrabbit.spi.commons.name.PathFactoryImpl;
+import org.apache.jackrabbit.spi.commons.conversion.NamePathResolver;
+import org.apache.jackrabbit.spi.commons.conversion.DefaultNamePathResolver;
+     * A path factory.
+     */
+    private static final PathFactory PATH_FACTORY = PathFactoryImpl.getInstance();
+
+    /**
-    void createInitialIndex(ItemStateManager stateMgr, NodeId rootId)
+    void createInitialIndex(ItemStateManager stateMgr, NodeId rootId, Path rootPath)
-                createIndex(rootState, stateMgr);
+                createIndex(rootState, rootPath, stateMgr);
-    private void createIndex(NodeState node, ItemStateManager stateMgr)
+    private void createIndex(NodeState node, Path path, ItemStateManager stateMgr)
-            NodeState childState = (NodeState) stateMgr.getItemState(child.getId());
-            createIndex(childState, stateMgr);
+            Path childPath = PATH_FACTORY.create(path, child.getName(),
+                    child.getIndex(), false);
+            NodeState childState;
+            try {
+                childState = (NodeState) stateMgr.getItemState(child.getId());
+            } catch (NoSuchItemStateException e) {
+                NamePathResolver resolver = new DefaultNamePathResolver(
+                        handler.getContext().getNamespaceRegistry());
+                log.error("Node {} ({}) has missing child '{}' ({})",
+                        new Object[]{
+                            resolver.getJCRPath(path),
+                            node.getNodeId().getUUID().toString(),
+                            resolver.getJCRName(child.getName()),
+                            child.getId().getUUID().toString()
+                        });
+                throw e;
+            }
+            if (childState != null) {
+                createIndex(childState, childPath, stateMgr);
+            }
