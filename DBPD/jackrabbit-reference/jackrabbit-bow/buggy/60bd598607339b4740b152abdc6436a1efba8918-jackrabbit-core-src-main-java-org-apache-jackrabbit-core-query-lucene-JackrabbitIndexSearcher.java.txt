JCR-1365: Query path constraints like foo//*/bar do not scale
- more performance improvements

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@629453 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.lucene.search.MatchAllDocsQuery;
-import javax.jcr.RepositoryException;
-        // optimize certain queries
-        if (sort.getSort().length == 0) {
-            query = query.rewrite(reader);
-            if (query instanceof MatchAllDocsQuery) {
-                try {
-                    return new NodeTraversingQueryHits(
-                            session.getRootNode(), true);
-                } catch (RepositoryException e) {
-                    IOException ex = new IOException(e.getMessage());
-                    ex.initCause(e);
-                    throw ex;
-                }
-            }
+        query = query.rewrite(reader);
+        QueryHits hits = null;
+        if (query instanceof JackrabbitQuery) {
+            hits = ((JackrabbitQuery) query).execute(this, session, sort);
-        return new LuceneQueryHits(search(query, sort), reader);
+        if (hits == null) {
+            hits = new LuceneQueryHits(search(query, sort), reader);
+        }
+        return hits;
