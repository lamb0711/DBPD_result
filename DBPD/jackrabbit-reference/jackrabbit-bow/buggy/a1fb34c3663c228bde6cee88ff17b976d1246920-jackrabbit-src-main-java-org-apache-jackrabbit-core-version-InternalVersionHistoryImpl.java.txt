JCR-414 jcr:successors property not persisted correctly within a transaction

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@398589 13f79535-47bb-0310-9956-ffa450edef68

-        // resolve successors and predecessors
-        Iterator iter = versionCache.values().iterator();
-        while (iter.hasNext()) {
-            InternalVersionImpl v = (InternalVersionImpl) iter.next();
-            v.resolvePredecessors();
+        // check for legacy version nodes that had 'virtual' jcr:successor property
+        if (rootVersion.getSuccessors().length==0 && versionCache.size()>1) {
+            // resolve successors and predecessors
+            Iterator iter = versionCache.values().iterator();
+            while (iter.hasNext()) {
+                InternalVersionImpl v = (InternalVersionImpl) iter.next();
+                v.legacyResolveSuccessors();
+            }
-        }
-        if (v == null) {
+        } else {
-        // remove from persistance state
-        node.removeNode(v.getName());
-
+        // remove from persistance state
+        node.removeNode(v.getName());
+
-        // initialize 'created' and 'predecessors'
+        // initialize 'created', 'predecessors' and 'successors'
-
-        // initialize 'empty' successors; their values are dynamically resolved
-        version.resolvePredecessors();
-        vMgr.versionCreated(version);
+        version.internalAttach();
+        vMgr.versionCreated(version);
+
