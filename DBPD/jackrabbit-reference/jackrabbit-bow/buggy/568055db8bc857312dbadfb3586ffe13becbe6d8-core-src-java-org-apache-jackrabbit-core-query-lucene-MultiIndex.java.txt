JCR-160: Query index not in sync with workspace
- A possible commit.lock is now also removed on startup. Previously only a write.lock was removed.
- An integrity check is run if the search index detects a commit or write lock on startup. This check removes nodes from the index that are not available anymore through the ItemStateManager.
- Applying the redo log on startup is now more failsafe.

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@216142 13f79535-47bb-0310-9956-ffa450edef68

+                maybeMergeIndexes();
+
+            // execute integrity check on persistent indexes with locks on startup
+            for (Iterator it = indexes.iterator(); it.hasNext(); ) {
+                PersistentIndex index = (PersistentIndex) it.next();
+                if (index.getLockEncountered()) {
+                    log.info("Running integrity check on index: " + index.getName());
+                    index.integrityCheck(stateMgr);
+                }
+            }
+
+     * <p/>
+     * If an error occurs when reading from the ItemStateManager an error log
+     * message is written and the node is ignored.
-     * @throws RepositoryException if any other error occurs
-            throws IOException, RepositoryException {
-        Document doc = handler.createDocument(node, nsMappings);
+            throws IOException {
+        Document doc;
+        try {
+            doc = handler.createDocument(node, nsMappings);
+        } catch (RepositoryException e) {
+            log.warn("RepositoryException: " + e.getMessage());
+            return;
+        }
-        maybeMergeIndexes();
