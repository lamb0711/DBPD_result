JCR-890: concurrent read-only access to a session

Leverage SessionContext in more places.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@957141 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.state.LocalItemStateManager;
-    protected final SessionContext context = new SessionContext(this);
+    protected final SessionContext context;
+        this.context = new SessionContext(repositoryContext, this);
-        context.setItemStateManager(
-                createSessionItemStateManager(wsp.getItemStateManager()));
+        context.setItemStateManager(createSessionItemStateManager());
-    protected SessionItemStateManager createSessionItemStateManager(LocalItemStateManager manager) {
-        return SessionItemStateManager.createInstance(
-                repositoryContext.getRootNodeId(),
-                manager,
+    protected SessionItemStateManager createSessionItemStateManager() {
+        SessionItemStateManager mgr = new SessionItemStateManager(
+                context.getRootNodeId(),
+                wsp.getItemStateManager(),
+        wsp.getItemStateManager().addListener(mgr);
+        return mgr;
-        return ItemManager.createInstance(
-                context, ntMgr.getRootNodeDefinition(),
-                repositoryContext.getRootNodeId(),
-                repositoryContext.getDataStore());
+        ItemManager mgr =
+            new ItemManager(context, ntMgr.getRootNodeDefinition());
+        context.getItemStateManager().addListener(mgr);
+        return mgr;
-                new ValueFactoryImpl(this, repositoryContext.getDataStore());
+                new ValueFactoryImpl(this, context.getDataStore());
