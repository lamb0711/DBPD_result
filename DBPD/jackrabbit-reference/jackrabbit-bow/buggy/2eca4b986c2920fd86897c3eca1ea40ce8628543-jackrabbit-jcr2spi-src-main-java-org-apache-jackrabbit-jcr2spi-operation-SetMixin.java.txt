JCR-1799 updating events swallowed (CacheBehavior.OBSERVATION)   	
JCR-1783 incomplete changelog when combining move with removal of new destination parent

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@704361 13f79535-47bb-0310-9956-ffa450edef68

-    private SetMixin(NodeState nodeState, Name[] mixinNames) {
+    private SetMixin(NodeState nodeState, Name[] mixinNames) throws RepositoryException {
+        assert status == STATUS_PENDING;
-     * Throws UnsupportedOperationException
-     *
-    public void persisted() {
-        throw new UnsupportedOperationException("persisted() not implemented for transient modification.");
+    public void persisted() throws RepositoryException {
+        assert status == STATUS_PENDING;
+        status = STATUS_PERSISTED;
+        nodeState.getHierarchyEntry().complete(this);
+    }
+
+    /**
+     * @see Operation#undo()
+     */
+    public void undo() throws RepositoryException {
+        assert status == STATUS_PENDING;
+        status = STATUS_UNDO;
+        nodeState.getHierarchyEntry().complete(this);
-    public static Operation create(NodeState nodeState, Name[] mixinNames) {
+    public static Operation create(NodeState nodeState, Name[] mixinNames)
+            throws RepositoryException {
+        if (nodeState == null || mixinNames == null) {
+            throw new IllegalArgumentException();
+        }
