JCR-2946 - Improve implementation of DavResource#getProperty(DavPropertyName)
JCR-2948 - Add possibility to PROPFIND the JCR_NODETYPES_CND_LN property

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1155296 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.webdav.jcr.property.JcrDavPropertyNameSet;
+import org.apache.jackrabbit.webdav.property.DavProperty;
+import org.apache.jackrabbit.webdav.property.DavPropertyName;
+    @Override
+    public DavProperty<?> getProperty(DavPropertyName name) {
+        DavProperty prop = super.getProperty(name);
+        if (prop == null) {
+            // required, protected version-set property for version-history resource
+            try {
+                if (ROOT_VERSION.equals(name)) {
+                    // required root-version property for version-history resource
+                    String rootVersionHref = getLocatorFromItem(((VersionHistory)item).getRootVersion()).getHref(true);
+                    prop = new HrefProperty(ROOT_VERSION, rootVersionHref, true);
+                } else if (VERSION_SET.equals(name)) {
+                    VersionIterator vIter = ((VersionHistory) item).getAllVersions();
+                    prop = getHrefProperty(VERSION_SET, vIter, true);
+                }
+            } catch (RepositoryException e) {
+                log.error(e.getMessage());
+            }
+        }
+        
+        return prop;
+    }
+
+    @Override
+    protected void initPropertyNames() {
+        super.initPropertyNames();
+
+        if (exists()) {
+            names.addAll(JcrDavPropertyNameSet.VERSIONHISTORY_SET);
+        }
+    }
+
-
-        // required root-version property for version-history resource
-        try {
-            String rootVersionHref = getLocatorFromItem(((VersionHistory)item).getRootVersion()).getHref(true);
-            properties.add(new HrefProperty(VersionHistoryResource.ROOT_VERSION, rootVersionHref, true));
-        } catch (RepositoryException e) {
-            log.error(e.getMessage());
-        }
-
-        // required, protected version-set property for version-history resource
-        try {
-            VersionIterator vIter = ((VersionHistory) item).getAllVersions();
-            addHrefProperty(VersionHistoryResource.VERSION_SET, vIter, true);
-        } catch (RepositoryException e) {
-            log.error(e.getMessage());
-        }
