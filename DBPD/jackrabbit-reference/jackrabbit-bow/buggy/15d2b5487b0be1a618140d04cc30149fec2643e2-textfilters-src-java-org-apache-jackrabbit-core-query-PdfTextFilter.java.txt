JCR-264: TextFilters get called three times within checkin()

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@392211 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.BufferedInputStream;
+import java.io.InputStream;
-            BLOBFileValue blob = (BLOBFileValue) values[0].internalValue();
-                
-            try {
-                PDFParser parser = new PDFParser(blob.getStream());
-                parser.parse();
-    
-                PDDocument document = parser.getPDDocument();
-    
-                CharArrayWriter writer = new CharArrayWriter();
-    
-                PDFTextStripper stripper = new PDFTextStripper();
-                stripper.setLineSeparator("\n");
-                stripper.writeText(document, writer);
-    
-                document.close();
-                writer.close();
-                
-                Map result = new HashMap();
-                result.put(FieldNames.FULLTEXT, new CharArrayReader(writer.toCharArray()));
-                return result;
-            } 
-            catch (IOException ex) {
-                throw new RepositoryException(ex);
-            }
-        } 
-        else {
+            final BLOBFileValue blob = (BLOBFileValue) values[0].internalValue();
+            LazyReader reader = new LazyReader() {
+                protected void initializeReader() throws IOException {
+                    PDFParser parser;
+                    InputStream in;
+                    try {
+                        in = blob.getStream();
+                    } catch (RepositoryException e) {
+                        throw new IOException(e.getMessage());
+                    }
+
+                    try {
+                        parser = new PDFParser(new BufferedInputStream(in));
+                        parser.parse();
+
+                        PDDocument document = parser.getPDDocument();
+                        try {
+                            CharArrayWriter writer = new CharArrayWriter();
+
+                            PDFTextStripper stripper = new PDFTextStripper();
+                            stripper.setLineSeparator("\n");
+                            stripper.writeText(document, writer);
+
+                            delegate = new CharArrayReader(writer.toCharArray());
+                        } finally {
+                            document.close();
+                        }
+                    } finally {
+                        in.close();
+                    }
+                }
+            };
+
+            Map result = new HashMap();
+            result.put(FieldNames.FULLTEXT, reader);
+            return result;
+        } else {
