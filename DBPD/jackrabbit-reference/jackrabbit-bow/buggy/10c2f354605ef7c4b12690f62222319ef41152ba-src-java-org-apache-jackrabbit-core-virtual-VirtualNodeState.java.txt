- improved versioning / virtual node behaviour
  fixes jira issues: JCR-20, JCR-22 and JCR-23

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@111518 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.state.ItemState;
+import org.apache.jackrabbit.core.ItemImpl;
+import org.apache.jackrabbit.core.InternalValue;
+import org.apache.jackrabbit.core.state.ItemState;
+import org.apache.jackrabbit.core.state.NoSuchItemStateException;
+
+import javax.jcr.PropertyType;
+    protected VirtualItemStateProvider provider;
+    
-    protected VirtualNodeState(String uuid, QName nodeTypeName, String parentUUID) {
+    protected VirtualNodeState(VirtualItemStateProvider provider,
+                               String uuid, QName nodeTypeName, String parentUUID) {
+
+        this.provider = provider;
+
+        // add some props
+        addPropertyEntry(ItemImpl.PROPNAME_PRIMARYTYPE);
+        addPropertyEntry(ItemImpl.PROPNAME_MIXINTYPES);
+    public VirtualPropertyState getPropertyState(QName name)
+            throws NoSuchItemStateException {
+        if (name.equals(ItemImpl.PROPNAME_PRIMARYTYPE)) {
+            VirtualPropertyState state = new VirtualPropertyState(name, getUUID());
+            state.setDefinitionId(provider.getPropDefId(ItemImpl.PROPNAME_PRIMARYTYPE));
+            state.setType(PropertyType.NAME);
+            state.setValues(InternalValue.create(new QName[]{getNodeTypeName()}));
+            return state;
+        } else if (name.equals(ItemImpl.PROPNAME_MIXINTYPES)) {
+            VirtualPropertyState state = new VirtualPropertyState(name, getUUID());
+            state.setDefinitionId(provider.getPropDefId(ItemImpl.PROPNAME_MIXINTYPES));
+            state.setType(PropertyType.NAME);
+            state.setValues(InternalValue.create((QName[]) getMixinTypeNames().toArray(new QName[getMixinTypeNames().size()])));
+            return state;
+        } else if (name.equals(ItemImpl.PROPNAME_UUID)) {
+            VirtualPropertyState state = new VirtualPropertyState(name, getUUID());
+            state.setDefinitionId(provider.getPropDefId(ItemImpl.PROPNAME_UUID));
+            state.setType(PropertyType.STRING);
+            state.setValues(InternalValue.create(new String[]{getUUID()}));
+            return state;
+        }
+        throw new NoSuchItemStateException(name.toString());
+    }
