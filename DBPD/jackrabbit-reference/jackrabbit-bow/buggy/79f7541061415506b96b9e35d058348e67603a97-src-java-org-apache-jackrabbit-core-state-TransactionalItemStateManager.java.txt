Added ItemStateManager#hasNodeReferences()
Added check for targets of modified node references in XAResource#prepare
Removed duplicated checkLock() in NodeImpl#addMixin


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@164071 13f79535-47bb-0310-9956-ffa450edef68

+     * Prepare a transaction
+     *
+     * @param tx transaction context
+     * @throws TransactionException if an error occurs
+     */
+    public void prepare(TransactionContext tx) throws TransactionException {
+        ChangeLog changeLog = (ChangeLog) tx.getAttribute(ATTRIBUTE_CHANGE_LOG);
+        if (changeLog != null) {
+            try {
+                sharedStateMgr.checkTargetsExist(changeLog);
+            } catch (ItemStateException e) {
+                log.error(e);
+                changeLog.undo(sharedStateMgr);
+                throw new TransactionException("Unable to prepare transaction.", e);
+            }
+        }
+    }
+
+    /**
-                throw new TransactionException("Unable to end update.", e);
+                throw new TransactionException("Unable to commit transaction.", e);
+     * If this state manager is committing changes, this method first
+     * checks the commitLog ThreadLocal. Else if associated to a transaction
+     * check the transactional change log. Fallback is always the call to
+     * the base class.
+     */
+    public boolean hasNodeReferences(NodeReferencesId id) {
+        ChangeLog changeLog = ((CommitLog) commitLog.get()).getChanges();
+        if (changeLog != null) {
+            // check commit log
+            if (changeLog.get(id) != null) {
+                return true;
+            }
+        } else if (txLog != null) {
+            // check change log
+            if (txLog.get(id) != null) {
+                return true;
+            }
+        }
+        return super.hasNodeReferences(id);
+    }
+
+    /**
+     * {@inheritDoc}
+     * <p/>
