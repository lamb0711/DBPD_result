- fixing problem with virtual overlay
- fixing PersistentNode issue described in JCR-15 [PersistentNode.store() ignores status when storing]

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@56421 13f79535-47bb-0310-9956-ffa450edef68

-    private final VirtualNodeState rootState;
+    //private final VirtualNodeState rootState;
-     * @param overlayedRoot the node state that is overlayed
-    public DefaultItemStateProvider(NodeTypeManagerImpl ntMgr, NodeState overlayedRoot) {
+    public DefaultItemStateProvider(NodeTypeManagerImpl ntMgr) {
-        rootState = new VirtualNodeState(overlayedRoot);
-        items.put(rootState.getId(), rootState);
-    }
-
-    /**
-     * Returns the nodestate of the relative root of this provider
-     *
-     * @return
-     */
-    public VirtualNodeState getRootState() {
-        return rootState;
+    public VirtualNodeState addOverlay(NodeState original) throws RepositoryException {
+        VirtualNodeState ns= new VirtualNodeState(original.getUUID(), original.getNodeTypeName(), original.getParentUUID());
+        ns.setDefinitionId(original.getDefinitionId());
+        setPropertyValue(ns, ItemImpl.PROPNAME_PRIMARYTYPE, InternalValue.create(original.getNodeTypeName()));
+        ns.setMixinTypeNames(original.getMixinTypeNames());
+        items.put(ns.getId(), ns);
+        return ns;
+    }
+
