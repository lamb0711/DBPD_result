Added ItemStateManager#hasNodeReferences()
Added check for targets of modified node references in XAResource#prepare
Removed duplicated checkLock() in NodeImpl#addMixin


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@164071 13f79535-47bb-0310-9956-ffa450edef68

+    /**
+     * Get or create a node references object for a given target id.
+     * @param id target id
+     * @return node references object
+     * @throws ItemStateException if an error occurs
+     */
+    protected NodeReferences getOrCreateNodeReferences(NodeReferencesId id)
+            throws ItemStateException {
+
+        if (stateMgr.hasNodeReferences(id)) {
+            return stateMgr.getNodeReferences(id);
+        }
+        return new NodeReferences(id);
+    }
+
-                                    refs = stateMgr.getNodeReferences(id);
+                                    refs = getOrCreateNodeReferences(id);
-                                refs = stateMgr.getNodeReferences(refsId);
+                                refs = getOrCreateNodeReferences(refsId);
-                                refs = stateMgr.getNodeReferences(id);
+                                refs = getOrCreateNodeReferences(id);
-            NodeReferences refs;
+            NodeReferences refs = null;
-                    refs = stateMgr.getNodeReferences(id);
+                    if (stateMgr.hasNodeReferences(id)) {
+                        refs = stateMgr.getNodeReferences(id);
+                    }
-            if (refs.hasReferences()) {
+            if (refs != null && refs.hasReferences()) {
