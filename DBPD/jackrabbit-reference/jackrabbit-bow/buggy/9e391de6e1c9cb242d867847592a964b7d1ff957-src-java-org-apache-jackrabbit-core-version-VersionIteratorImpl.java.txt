versioning implementation is now stores directly in persistence state.

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@53784 13f79535-47bb-0310-9956-ffa450edef68

+import javax.jcr.Session;
+import java.util.HashSet;
+import java.util.Set;
+     * the set of versions already returned. due to the topology of the version
+     * graph it is possible to reach a version via different paths.
+     */
+    private Set visited = new HashSet();
+
+    /**
+     * the session for wrapping the versions
+     */
+    private final Session session;
+
+    /**
-    public VersionIteratorImpl(Version rootVersion) throws RepositoryException {
+    public VersionIteratorImpl(Session session, InternalVersion rootVersion) {
+        this.session = session;
-        Version ret = (Version) successors.peek();
+        InternalVersion ret = (InternalVersion) successors.peek();
+        visited.add(ret);
+        push(ret.getSuccessors());
+
-            push(ret.getSuccessors());
+            return new VersionImpl(session, ret);
-            // ignore
+            throw new NoSuchElementException("Unable to provide element: " + e.toString());
-        return ret;
-    private void push(Version[] versions) {
+    private void push(InternalVersion[] versions) {
-            successors.push(versions[i]);
+            if (!visited.contains(versions[i])) {
+                successors.push(versions[i]);
+            }
