JCR-1564: JSR 283 namespace handling
    - Removed the query -> LocalNamespaceMappings dependency in jcr2spi
    - Now it works, thanks to revision 655554

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@655556 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.HashMap;
+import java.util.Map;
+
-import org.apache.jackrabbit.jcr2spi.name.LocalNamespaceMappings;
-     * The namespace mappings of the session that executes this query.
-     */
-    private final LocalNamespaceMappings nsResolver;
-
-    /**
-     * @param nsResolver       the namespace resolver to be used.
-    public QueryImpl(Session session, LocalNamespaceMappings nsResolver, NamePathResolver resolver,
+    public QueryImpl(Session session, NamePathResolver resolver,
-        this.nsResolver = nsResolver;
-        this.wspManager.checkQueryStatement(statement, language, nsResolver.getLocalNamespaceMappings());
+        this.wspManager.checkQueryStatement(
+                statement, language, getNamespaceMappings());
-     * @param nsResolver the namespace resolver to be used.
-    public QueryImpl(Session session, LocalNamespaceMappings nsResolver, NamePathResolver resolver,
+    public QueryImpl(Session session, NamePathResolver resolver,
-        this.nsResolver = nsResolver;
-        this.wspManager.checkQueryStatement(statement, language,
-                    nsResolver.getLocalNamespaceMappings());
+        this.wspManager.checkQueryStatement(
+                statement, language, getNamespaceMappings());
-        QueryInfo qI = wspManager.executeQuery(statement, language,
-                nsResolver.getLocalNamespaceMappings());
+        QueryInfo qI = wspManager.executeQuery(
+                statement, language, getNamespaceMappings());
+    /***
+     * Utility method that returns the namespace mappings of the current
+     * session.
+     *
+     * @return namespace mappings (prefix -&gt; uri)
+     * @throws RepositoryException if a repository error occurs
+     */
+    private Map getNamespaceMappings() throws RepositoryException {
+        Map mappings = new HashMap();
+        String[] prefixes = session.getNamespacePrefixes();
+        for (int i = 0; i < prefixes.length; i++) {
+            mappings.put(prefixes[i], session.getNamespaceURI(prefixes[i]));
+        }
+        return mappings;
+    }
+
