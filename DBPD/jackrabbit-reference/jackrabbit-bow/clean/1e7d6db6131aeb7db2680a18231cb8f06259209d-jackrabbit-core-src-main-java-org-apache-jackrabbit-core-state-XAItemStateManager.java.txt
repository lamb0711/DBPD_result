JCR-1587: When trying to reuse version label in transaction, exception is thrown

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@656240 13f79535-47bb-0310-9956-ffa450edef68

+    /**
+     * @throws UnsupportedOperationException always.
+     */
+    protected ChangeLog getChanges() {
+        throw new UnsupportedOperationException("getChanges");
+    }
+
-        ChangeLog changeLog = getChangeLog();
+        // 1) check local changes
+        ChangeLog changeLog = super.getChanges();
+        ItemState state = changeLog.get(id);
+        if (state != null) {
+            return state;
+        }
+        // 2) check tx log
+        changeLog = getChangeLog();
-            ItemState state = changeLog.get(id);
+            state = changeLog.get(id);
+        // 3) fallback to base class
-        ChangeLog changeLog = getChangeLog();
+        // 1) check local changes
+        ChangeLog changeLog = super.getChanges();
+        try {
+            ItemState state = changeLog.get(id);
+            if (state != null) {
+                return true;
+            }
+        } catch (NoSuchItemStateException e) {
+            // marked removed in local ism
+            return false;
+        }
+        // if we get here, then there is no item state with
+        // the given id known to the local ism
+        // 2) check tx log
+        changeLog = getChangeLog();
+                // marked removed in tx log
-        return super.hasItemState(id);
+        // 3) fallback to shared ism
+        return sharedStateMgr.hasItemState(id);
