reworked transaction support, contributed by dominique

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@151380 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.state.UpdateOperation;
+import org.apache.jackrabbit.core.state.UpdatableItemStateManager;
+import org.apache.jackrabbit.core.state.ItemStateException;
-        getVersionManager().removeVersion(this, versionName);
-    }
-
-    /**
-     * Removes the indicated version from this VersionHistory. If the specified
-     * vesion does not exist, if it specifies the root version or if it is
-     * referenced by any node e.g. as base version, a VersionException is thrown.
-     * <p/>
-     * all successors of the removed version become successors of the
-     * predecessors of the removed version and vice versa. then, the entire
-     * version node and all its subnodes are removed.
-     *
-     * @param versionName
-     * @throws VersionException
-     */
-    protected void removeVersion(UpdateOperation upd, QName versionName) throws VersionException {
+            UpdatableItemStateManager stateMgr = getVersionManager().getItemStateMgr();
+            stateMgr.edit();
+
-            node.removeNode(upd, v.getName());
+            node.removeNode(v.getName());
-                labelNode.removeNode(upd, name);
+                labelNode.removeNode(name);
-            v.internalDetach(upd);
+            v.internalDetach();
-            node.store(upd);
+            node.store();
+
+            stateMgr.update();
+        } catch (ItemStateException e) {
+            throw new VersionException("Unable to store modifications", e);
-        return getVersionManager().addVersionLabel(this, versionName, label, move);
-    }
-
-    /**
-     * @see InternalVersionHistory#addVersionLabel(org.apache.jackrabbit.core.QName, String, boolean)
-     */
-    protected InternalVersion addVersionLabel(UpdateOperation upd, QName versionName, String label, boolean move)
-            throws VersionException {
-            PersistentNode lNode = labelNode.addNode(upd, name, NodeTypeRegistry.NT_UNSTRUCTURED);
-            lNode.setPropertyValue(upd, NativePVM.PROPNAME_NAME, InternalValue.create(label));
-            lNode.setPropertyValue(upd, NativePVM.PROPNAME_VERSION, InternalValue.create(version.getId()));
-            labelNode.store(upd);
+            UpdatableItemStateManager stateMgr = getVersionManager().getItemStateMgr();
+            stateMgr.edit();
+
+            PersistentNode lNode = labelNode.addNode(name, NodeTypeRegistry.NT_UNSTRUCTURED);
+            lNode.setPropertyValue(NativePVM.PROPNAME_NAME, InternalValue.create(label));
+            lNode.setPropertyValue(NativePVM.PROPNAME_VERSION, InternalValue.create(version.getId()));
+            labelNode.store();
+
+            stateMgr.update();
+        } catch (ItemStateException e) {
+            throw new VersionException("Error while storing modifications", e);
-        return getVersionManager().removeVersionLabel(this, label);
-    }
-    /**
-     * @see InternalVersionHistory#removeVersionLabel(String)
-     */
-    protected InternalVersion removeVersionLabel(UpdateOperation upd, String label) throws VersionException {
+
-            labelNode.removeNode(upd, name);
-            labelNode.store(upd);
+            UpdatableItemStateManager stateMgr = getVersionManager().getItemStateMgr();
+            stateMgr.edit();
+            labelNode.removeNode(name);
+            labelNode.store();
+            stateMgr.update();
+        } catch (ItemStateException e) {
+            throw new VersionException("Unable to store modifications", e);
-    protected InternalVersionImpl checkin(UpdateOperation upd, QName name, NodeImpl src)
+    protected InternalVersionImpl checkin(QName name, NodeImpl src)
-        PersistentNode vNode = node.addNode(upd, nodeName, NativePVM.NT_REP_VERSION);
-        vNode.setPropertyValue(upd, NativePVM.PROPNAME_VERSION_ID, InternalValue.create(versionId));
-        vNode.setPropertyValue(upd, NativePVM.PROPNAME_VERSION_NAME, InternalValue.create(name));
+        PersistentNode vNode = node.addNode(nodeName, NativePVM.NT_REP_VERSION);
+        vNode.setPropertyValue(NativePVM.PROPNAME_VERSION_ID, InternalValue.create(versionId));
+        vNode.setPropertyValue(NativePVM.PROPNAME_VERSION_NAME, InternalValue.create(name));
-        vNode.setPropertyValue(upd, VersionManager.PROPNAME_CREATED, InternalValue.create(Calendar.getInstance()));
-        vNode.setPropertyValues(upd, VersionManager.PROPNAME_PREDECESSORS, PropertyType.STRING, predecessors);
+        vNode.setPropertyValue(VersionManager.PROPNAME_CREATED, InternalValue.create(Calendar.getInstance()));
+        vNode.setPropertyValues(VersionManager.PROPNAME_PREDECESSORS, PropertyType.STRING, predecessors);
-        InternalFrozenNodeImpl.checkin(upd, vNode, VersionManager.NODENAME_FROZEN, src, false, false);
+        InternalFrozenNodeImpl.checkin(vNode, VersionManager.NODENAME_FROZEN, src, false, false);
-        node.store(upd);
+        node.store();
-    protected static InternalVersionHistoryImpl create(UpdateOperation upd, PersistentVersionManager vMgr, PersistentNode parent, String historyId, QName name, NodeImpl src)
+    protected static InternalVersionHistoryImpl create(PersistentVersionManager vMgr, PersistentNode parent, String historyId, QName name, NodeImpl src)
-        PersistentNode pNode = parent.addNode(upd, name, NativePVM.NT_REP_VERSION_HISTORY);
-        pNode.setPropertyValue(upd, NativePVM.PROPNAME_HISTORY_ID, InternalValue.create(historyId));
+        PersistentNode pNode = parent.addNode(name, NativePVM.NT_REP_VERSION_HISTORY);
+        pNode.setPropertyValue(NativePVM.PROPNAME_HISTORY_ID, InternalValue.create(historyId));
-        pNode.setPropertyValue(upd, NativePVM.PROPNAME_VERSIONABLE_ID, InternalValue.create(src.internalGetUUID()));
+        pNode.setPropertyValue(NativePVM.PROPNAME_VERSIONABLE_ID, InternalValue.create(src.internalGetUUID()));
-        pNode.addNode(upd, NativePVM.NODENAME_VERSION_LABELS, NodeTypeRegistry.NT_UNSTRUCTURED);
+        pNode.addNode(NativePVM.NODENAME_VERSION_LABELS, NodeTypeRegistry.NT_UNSTRUCTURED);
-        PersistentNode vNode = pNode.addNode(upd, nodeName, NativePVM.NT_REP_VERSION);
-        vNode.setPropertyValue(upd, NativePVM.PROPNAME_VERSION_ID, InternalValue.create(versionId));
-        vNode.setPropertyValue(upd, NativePVM.PROPNAME_VERSION_NAME, InternalValue.create(VersionManager.NODENAME_ROOTVERSION));
+        PersistentNode vNode = pNode.addNode(nodeName, NativePVM.NT_REP_VERSION);
+        vNode.setPropertyValue(NativePVM.PROPNAME_VERSION_ID, InternalValue.create(versionId));
+        vNode.setPropertyValue(NativePVM.PROPNAME_VERSION_NAME, InternalValue.create(VersionManager.NODENAME_ROOTVERSION));
-        vNode.setPropertyValue(upd, VersionManager.PROPNAME_CREATED, InternalValue.create(Calendar.getInstance()));
-        vNode.setPropertyValues(upd, VersionManager.PROPNAME_PREDECESSORS, PropertyType.REFERENCE, new InternalValue[0]);
+        vNode.setPropertyValue(VersionManager.PROPNAME_CREATED, InternalValue.create(Calendar.getInstance()));
+        vNode.setPropertyValues(VersionManager.PROPNAME_PREDECESSORS, PropertyType.REFERENCE, new InternalValue[0]);
-        InternalFrozenNodeImpl.checkin(upd, vNode, VersionManager.NODENAME_FROZEN, src, true, false);
+        InternalFrozenNodeImpl.checkin(vNode, VersionManager.NODENAME_FROZEN, src, true, false);
-        parent.store(upd);
+        parent.store();
