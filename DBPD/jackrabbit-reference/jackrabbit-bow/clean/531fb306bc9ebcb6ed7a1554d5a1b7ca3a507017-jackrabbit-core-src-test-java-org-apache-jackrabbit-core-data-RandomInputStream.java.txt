JCR-1154 Database data store: support multiple concurrent connections

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@603499 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.BufferedInputStream;
+import java.io.IOException;
-    private static final int MAX_READ_BLOCK = 15;
+    private static final int DEFAULT_MAX_READ_BLOCK_SIZE = 15;
+    private int maxReadBlockSize;
+        this(seed, len, DEFAULT_MAX_READ_BLOCK_SIZE);
+    }
+
+    public static void compareStreams(InputStream a, InputStream b) throws IOException {
+        a = new BufferedInputStream(a);
+        b = new BufferedInputStream(b);
+        long pos = 0;
+        while (true) {
+            int x = a.read();
+            int y = b.read();
+            if (x == -1 || y == -1) {
+                if (x == y) {
+                    break;
+                }
+            } 
+            if (x != y) {
+                throw new IOException("Incorrect byte at position " + pos + ": x=" + x + " y=" + y);
+            }
+        }
+    }
+
+    public RandomInputStream(long seed, long len, int maxReadBlockSize) {
+        this.maxReadBlockSize = maxReadBlockSize;
-        if (n > MAX_READ_BLOCK) {
-            n = MAX_READ_BLOCK;
+        if (n > maxReadBlockSize) {
+            n = maxReadBlockSize;
