Implement location step with context position index.

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@156923 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.state.ItemStateManager;
+import org.apache.jackrabbit.core.search.QueryNode;
+     * The shared item state manager of the workspace.
+     */
+    private ItemStateManager sharedItemMgr;
+
+    /**
+     * @param sharedItemMgr the shared item state manager of the workspace.
+                               ItemStateManager sharedItemMgr,
+        this.sharedItemMgr = sharedItemMgr;
+     * @param sharedItemMgr the shared item state manager of the workspace.
+                                    ItemStateManager sharedItemMgr,
-        LuceneQueryBuilder builder = new LuceneQueryBuilder(root,
-                session, nsMappings, analyzer, propReg);
+        LuceneQueryBuilder builder = new LuceneQueryBuilder(root, session,
+                sharedItemMgr, nsMappings, analyzer, propReg);
+        // check for position predicate
+        QueryNode[] pred = node.getPredicates();
+        for (int i = 0; i < pred.length; i++) {
+            if (pred[i].getType() == QueryNode.TYPE_RELATION) {
+                RelationQueryNode pos = (RelationQueryNode) pred[i];
+                if (pos.getValueType() == QueryConstants.TYPE_POSITION) {
+                    node.setIndex(pos.getPositionValue());
+                }
+            }
+        }
+
-                    // @todo this will traverse the whole index, optimize!
+                    // todo this will traverse the whole index, optimize!
-                    andQuery.add(new ChildAxisQuery(context), true, false);
+                    andQuery.add(new ChildAxisQuery(sharedItemMgr, context, null, node.getIndex()), true, false);
-            // select child nodes
-            andQuery.add(new ChildAxisQuery(context), true, false);
-
-                andQuery.add(nameTest, true, false);
+                andQuery.add(new ChildAxisQuery(sharedItemMgr, context, nameTest.getTerm().text(), node.getIndex()), true, false);
+            } else {
+                // select child nodes
+                andQuery.add(new ChildAxisQuery(sharedItemMgr, context, null, node.getIndex()), true, false);
+            case QueryConstants.TYPE_POSITION:
+                // ignore position. is handled in the location step
+                return null;
