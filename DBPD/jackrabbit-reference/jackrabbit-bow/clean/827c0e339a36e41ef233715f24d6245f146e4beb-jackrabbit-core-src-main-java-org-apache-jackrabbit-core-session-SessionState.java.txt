JCR-2741: Improved logging for session operations

Add a jcr.operation variable to MDC and clean up the MDC handling code

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@995002 13f79535-47bb-0310-9956-ffa450edef68

-        String previous = MDC.get("jcr.session");
-        MDC.put("jcr.session", context.toString());
+        LogState state = new LogState(
+                "jcr.session", context.toString(),
+                "jcr.operation", operation.toString());
-            if (previous != null) {
-                MDC.put("jcr.session", previous);
-            } else {
-                MDC.remove("jcr.session");
+            state.reset();
+        }
+    }
+
+    /**
+     * Internal utility class for setting MDC variables during the execution
+     * of a session operation.
+     */
+    private static class LogState {
+
+        private final String[] keyValuePairs;
+
+        public LogState(String... keyValuePairs) {
+            this.keyValuePairs = keyValuePairs;
+            for (int i = 0; i + 1 < keyValuePairs.length; i += 2) {
+                if (MDC.get(keyValuePairs[i]) == null) {
+                    MDC.put(keyValuePairs[i], keyValuePairs[i + 1]);
+                } else {
+                    keyValuePairs[i + 1] = null;
+                }
+
+        public void reset() {
+            for (int i = 0; i + 1 < keyValuePairs.length; i += 2) {
+                if (keyValuePairs[i + 1] != null) {
+                    MDC.remove(keyValuePairs[i]);
+                }
+            }
+        }
+
