JCR-1104: JSR 283 support (work in progress)
- NodeLocalName

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@647798 13f79535-47bb-0310-9956-ffa450edef68

-import java.io.IOException;
-import org.apache.lucene.index.TermPositions;
-import org.apache.lucene.index.Term;
-import org.apache.lucene.index.TermEnum;
- * adds support for length queries using the newly added
- * <code>PROPERTY_LENGTHS</code> field. Furthermore a Payload is added to
+ * adds support for length and local name queries using the newly added
+ * fields <code>PROPERTY_LENGTHS</code>, <code>LOCAL_NAME</code> and
+ * <code>NAMESPACE_URI</code>. Furthermore a Payload is added to
-    public static IndexFormatVersion getVersion(IndexReader indexReader)
-            throws IOException {
+    public static IndexFormatVersion getVersion(IndexReader indexReader) {
-        if (hasPayloads(indexReader) || indexReader.numDocs() == 0) {
+        if (fields.contains(FieldNames.LOCAL_NAME) || indexReader.numDocs() == 0) {
-
-    /**
-     * @param reader the index reader.
-     * @return <code>true</code> if the {@link FieldNames#PROPERTIES} fields
-     *         contain payloads; <code>false</code> otherwise.
-     * @throws IOException if an error occurs while reading from the index.
-     */
-    public static boolean hasPayloads(IndexReader reader) throws IOException {
-        TermPositions tp = reader.termPositions();
-        try {
-            TermEnum terms = reader.terms(
-                    new Term(FieldNames.PROPERTIES, ""));
-            try {
-                do {
-                    tp.seek(terms);
-                    if (tp.next()) {
-                        tp.nextPosition();
-                        return tp.isPayloadAvailable();
-                    }
-                } while (terms.next() && terms.term().field() == FieldNames.PROPERTIES);
-            } finally {
-                terms.close();
-            }
-        } finally {
-            tp.close();
-        }
-        return false;
-    }
