JCR-2863: Session#importXML can't handle properly uuid collision if user has insufficient permission 						


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1064213 13f79535-47bb-0310-9956-ffa450edef68

-                                           NodeImpl conflicting,
+                                           NodeId conflictingId,
+
+        NodeImpl conflicting;
+        try {
+            conflicting = session.getNodeById(conflictingId);
+        } catch (ItemNotFoundException infe) {
+            // conflicting node can't be read,
+            // most likely due to lack of read permission
+            conflicting = null;
+        }
+
-            if (conflicting.isNodeType(NameConstants.MIX_SHAREABLE)) {
+            if (conflicting != null
+                    && conflicting.isNodeType(NameConstants.MIX_SHAREABLE)) {
+            if (conflicting == null) {
+                // since the conflicting node can't be read,
+                // we can't remove it
+                String msg = "node with uuid " + conflictingId + " cannot be removed";
+                log.debug(msg);
+                throw new RepositoryException(msg);
+            }
+
+            if (conflicting == null) {
+                // since the conflicting node can't be read,
+                // we can't replace it
+                String msg = "node with uuid " + conflictingId + " cannot be replaced";
+                log.debug(msg);
+                throw new RepositoryException(msg);
+            }
+
-                NodeImpl conflicting;
+                boolean isConflicting;
-                    conflicting = session.getNodeById(id);
+                    // the following is a fail-fast test whether
+                    // an item exists (regardless of access control)
+                    session.getHierarchyManager().getName(id);
+                    isConflicting = true;
-                    conflicting = null;
+                    isConflicting = false;
-                if (conflicting != null) {
+
+                if (isConflicting) {
-                    node = resolveUUIDConflict(parent, conflicting, nodeInfo);
+                    node = resolveUUIDConflict(parent, id, nodeInfo);
