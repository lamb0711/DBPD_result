work in progress

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@425737 13f79535-47bb-0310-9956-ffa450edef68

-        QName nodeName = nodeInfo.getName();
-        if (parent.hasPropertyName(nodeName)) {
+        if (parent.hasPropertyName(nodeInfo.getName())) {
-            PropertyState conflicting = validator.getPropertyState(parent.getNodeId(), nodeName);
+            PropertyState conflicting = validator.getPropertyState(parent.getNodeId(), nodeInfo.getName());
-                QName newName = new QName(nodeName.getNamespaceURI(), nodeName.getLocalName() + "_");
+                QName newName = new QName(nodeInfo.getName().getNamespaceURI(), nodeInfo.getName().getLocalName() + "_");
-            NodeId nId = AddNode.getLastCreated(parent, nodeInfo.getName());
-            NodeState nodeState = validator.getNodeState(nId);
+            // retrieve id of state that has been created during execution of AddNode
+            NodeId childId;
+            List cne = parent.getChildNodeEntries(nodeInfo.getName());
+            if (def.allowsSameNameSiblings()) {
+                // TODO: find proper solution. problem with same-name-siblings
+                childId = ((NodeState.ChildNodeEntry)cne.get(cne.size()-1)).getId();
+            } else {
+                childId = ((NodeState.ChildNodeEntry)cne.get(0)).getId();
+            }
+            NodeState nodeState = validator.getNodeState(childId);
-            PropertyId mixinPId = idFactory.createPropertyId(nId, QName.JCR_MIXINTYPES);
+            PropertyId mixinPId = idFactory.createPropertyId(childId, QName.JCR_MIXINTYPES);
