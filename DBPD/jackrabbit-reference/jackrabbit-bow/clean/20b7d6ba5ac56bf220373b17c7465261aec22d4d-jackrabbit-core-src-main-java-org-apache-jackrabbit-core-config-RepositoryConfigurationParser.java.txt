JCR-1438: Replace Config classes with factories 

Replaced FileSystemConfig with FileSystemFactory.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@688207 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.fs.FileSystem;
+import org.apache.jackrabbit.core.fs.FileSystemException;
+import org.apache.jackrabbit.core.fs.FileSystemFactory;
+import javax.jcr.RepositoryException;
+
-        FileSystemConfig fsc =
-            new FileSystemConfig(parseBeanConfig(root, FILE_SYSTEM_ELEMENT));
+        FileSystemFactory fsf = getFileSystemFactory(root, FILE_SYSTEM_ELEMENT);
-        return new RepositoryConfig(home, securityConfig, fsc,
+        return new RepositoryConfig(home, securityConfig, fsf,
-        FileSystemConfig fsc = new FileSystemConfig(
-                tmpParser.parseBeanConfig(root, FILE_SYSTEM_ELEMENT));
+        FileSystemFactory fsf =
+            tmpParser.getFileSystemFactory(root, FILE_SYSTEM_ELEMENT);
-        return new WorkspaceConfig(home, name, clustered, fsc, pmc, sc, ismLockingConfig, workspaceSecurityConfig);
+        return new WorkspaceConfig(home, name, clustered, fsf, pmc, sc, ismLockingConfig, workspaceSecurityConfig);
-                FileSystemConfig fsc = null;
+                FileSystemFactory fsf = null;
-                    fsc = new FileSystemConfig(
-                            parseBeanConfig(element, FILE_SYSTEM_ELEMENT));
+                    fsf = getFileSystemFactory(element, FILE_SYSTEM_ELEMENT);
-                return new SearchConfig(className, parameters, fsc);
+                return new SearchConfig(className, parameters, fsf);
-        FileSystemConfig fsc = new FileSystemConfig(
-                parseBeanConfig(element, FILE_SYSTEM_ELEMENT));
+        FileSystemFactory fsf =
+            getFileSystemFactory(element, FILE_SYSTEM_ELEMENT);
-        return new VersioningConfig(home, fsc, pmc, ismLockingConfig);
+        return new VersioningConfig(home, fsf, pmc, ismLockingConfig);
+    /**
+     * Creates and returns a factory object that creates {@link FileSystem}
+     * instances based on the bean configuration at the named element.
+     *
+     * @param parent parent element
+     * @param name name of the bean configuration element
+     * @return file system factory
+     * @throws ConfigurationException if the bean configuration is invalid
+     */
+    private FileSystemFactory getFileSystemFactory(Element parent, String name)
+            throws ConfigurationException {
+        final BeanConfig config = parseBeanConfig(parent, name);
+        return new FileSystemFactory() {
+            public FileSystem getFileSystem() throws RepositoryException {
+                try {
+                    FileSystem fs = (FileSystem) config.newInstance();
+                    fs.init();
+                    return fs;
+                } catch (ClassCastException e) {
+                    throw new RepositoryException(
+                            "Invalid file system implementation class: "
+                            + config.getClassName(), e);
+                } catch (FileSystemException e) {
+                    throw new RepositoryException(
+                            "File system initialization failure.", e);
+                }
+            }
+        };
+    }
+
