fixing JIRA issue JCR-25: default value with autocreated fields 

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@111271 13f79535-47bb-0310-9956-ffa450edef68

-    // namespace registry for resolving prefixes and namespace URI's;
-    // used for (de)serializing node type definitions
+    /**
+     * namespace registry for resolving prefixes and namespace URI's;
+     * used for (de)serializing node type definitions
+     */
+     * FIXME
+     * flag used to temporarily disable checking that auto-created properties
+     * have a default value; this check has to be disabled while validating
+     * built-in node types because there are properties defined in built-in
+     * node types which are auto-created but don't have a fixed default value
+     * that can be exposed in a property definition because it is
+     * system-generated (e.g. jcr:primaryType in nt:base).
+     */
+    private boolean checkAutoCreatePropHasDefault = true;
+
+    /**
+        /**
+         * temporarily disable checking that auto-create properties have
+         * default values
+         */
+        checkAutoCreatePropHasDefault = false;
+            /**
+             * re-enable checking that auto-create properties have default values
+             */
+            checkAutoCreatePropHasDefault = true;
-                    String msg = "invalid supertype: " + supertypes[i] + " (infinite recursion))";
+                    String msg = "[" + name + "] invalid supertype: "
+                            + supertypes[i] + " (infinite recursion))";
-                    String msg = "invalid supertype: " + supertypes[i];
+                    String msg = "[" + name + "] invalid supertype: " + supertypes[i];
-                    String msg = "all primary node types except nt:base itself must be (directly or indirectly) derived from nt:base";
+                    String msg = "[" + name
+                            + "] all primary node types except nt:base itself must be (directly or indirectly) derived from nt:base";
-                String msg = "failed to validate supertypes";
+                String msg = "[" + name + "] failed to validate supertypes";
-                String msg = "failed to validate supertypes";
+                String msg = "[" + name + "] failed to validate supertypes";
-                String msg = "all primary node types except nt:base itself must be (directly or indirectly) derived from nt:base";
+                String msg = "[" + name
+                        + "] all primary node types except nt:base itself must be (directly or indirectly) derived from nt:base";
-                    String msg = "primary item must specify a name";
+                    String msg = "[" + name + "#" + pd.getName() + "] primary item must specify a name";
-                    String msg = "more than one primary item specified";
+                    String msg = "[" + name + "#" + pd.getName() + "] more than one primary item specified";
-                String msg = "auto-created properties must specify a name";
+                String msg = "[" + name + "#" + pd.getName()
+                        + "] auto-created properties must specify a name";
-                            String msg = "type of default value(s) is not consistent with required property type";
+                            String msg = "[" + name + "#" + pd.getName()
+                                    + "] type of default value(s) is not consistent with required property type";
+            } else {
+                // no default values specified
+                if (checkAutoCreatePropHasDefault) {
+                    // auto-created properties must have a default value
+                    if (pd.isAutoCreate()) {
+                        String msg = "[" + name + "#" + pd.getName()
+                                + "] auto-created property must have a default value";
+                        log.error(msg);
+                        throw new InvalidNodeTypeDefException(msg);
+                    }
+                }
-            /**
-             * todo check that auto-created properties have have at least either default values or system generated values
-             */
+
-                            String msg = "default value of property "
-                                    + (pd.definesResidual() ? "*" : pd.getName().toString())
-                                    + " does not satisfy value constraint";
+                            String msg = "[" + name + "#" + pd.getName()
+                                    + "] default value does not satisfy value constraint";
-                            String msg = "invalid REFERENCE value constraint '"
-                                    + ntName + "' (unknown node type) in property definition "
-                                    + (pd.definesResidual() ? "*" : pd.getName().toString());
+                            String msg = "[" + name + "#" + pd.getName()
+                                    + "] invalid REFERENCE value constraint '"
+                                    + ntName + "' (unknown node type)";
-                    String msg = "primary item must specify a name";
+                    String msg = "[" + name + "#" + cnd.getName()
+                            + "] primary item must specify a name";
-                    String msg = "more than one primary item specified";
+                    String msg = "[" + name + "#" + cnd.getName()
+                            + "] more than one primary item specified";
-                String msg = "auto-created child-nodes must specify a name";
+                String msg = "[" + name + "#" + cnd.getName()
+                        + "] auto-created child-nodes must specify a name";
-                    String msg = "invalid default primary type '" + dpt
-                            + "' in childnode definition " + cnd.getName();
+                    String msg = "[" + name + "#" + cnd.getName()
+                            + "] invalid default primary type '" + dpt + "'";
-                    String msg = "failed to validate default primary type";
+                    String msg = "[" + name + "#" + cnd.getName()
+                            + "] failed to validate default primary type";
-                    String msg = "failed to validate default primary type";
+                    String msg = "[" + name + "#" + cnd.getName()
+                            + "] failed to validate default primary type";
-                        String msg = "invalid required primary type: " + rpt;
+                        String msg = "[" + name + "#" + cnd.getName()
+                                + "] invalid required primary type: " + rpt;
-                        String msg = "default primary type does not satisfy required primary type constraint " + rpt;
+                        String msg = "[" + name + "#" + cnd.getName()
+                                + "] default primary type does not satisfy required primary type constraint "
+                                + rpt;
-                        String msg = "failed to validate required primary type constraint";
+                        String msg = "[" + name + "#" + cnd.getName()
+                                + "] failed to validate required primary type constraint";
-                        String msg = "failed to validate required primary type constraint";
+                        String msg = "[" + name + "#" + cnd.getName()
+                                + "] failed to validate required primary type constraint";
-                String msg = "failed to resolve node type definition";
+                String msg = "[" + name + "] failed to resolve node type definition";
-                String msg = "failed to resolve node type definition";
+                String msg = "[" + name + "] failed to resolve node type definition";
