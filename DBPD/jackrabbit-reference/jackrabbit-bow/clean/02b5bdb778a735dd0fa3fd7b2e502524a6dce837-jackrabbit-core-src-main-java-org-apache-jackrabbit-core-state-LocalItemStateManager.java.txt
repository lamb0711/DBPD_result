JCR-1271: NullPointerException when iterating over properties

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@605510 13f79535-47bb-0310-9956-ffa450edef68

-    private final ItemStateReferenceCache cache;
+    private final ItemStateCache cache;
-        synchronized (cache) {
+        synchronized (this) {
-
-        // JCR-798: copy cached item states to array
-        // to avoid ConcurrentModificationException
-        ItemState[] isa = (ItemState[]) cache.values().toArray(
-                new ItemState[cache.size()]);
-        for (int i = 0; i < isa.length; i++) {
-            ItemState state = isa[i];
+        ItemState[] states = cache.retrieveAll();
+        for (int i = 0; i < states.length; i++) {
+            ItemState state = states[i];
