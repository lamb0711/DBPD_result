JCR-1104: JSR 283 support
- query (work in progress)

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@643404 13f79535-47bb-0310-9956-ffa450edef68

+     * The index format version.
+     */
+    private final IndexFormatVersion version;
+
+    /**
+     * @param version            the index format version.
-                                    Map bindVariableValues) {
+                                    Map bindVariableValues,
+                                    IndexFormatVersion version) {
+        this.version = version;
+     * @param version            the index format version.
-                                    Map bindVariableValues)
+                                    Map bindVariableValues,
+                                    IndexFormatVersion version)
-                qomTree, session, sharedItemMgr, hmgr, nsMappings,
-                analyzer, propReg, synonymProvider, bindVariableValues);
+                qomTree, session, sharedItemMgr, hmgr, nsMappings, analyzer,
+                propReg, synonymProvider, bindVariableValues, version);
-        // TODO respect index version
-        return new MatchAllQuery(propName);
+        return createMatchAllQuery(propName);
+
+    /**
+     * Depending on the index format this method returns
+     * a query that matches all nodes that have a property named 'field'
+     *
+     * @param field
+     * @return Query that matches all nodes that have a property named 'field'
+     */
+    private Query createMatchAllQuery(String field) {
+        if (version.getVersion() >= IndexFormatVersion.V2.getVersion()) {
+            // new index format style
+            return new TermQuery(new Term(FieldNames.PROPERTIES_SET, field));
+        } else {
+            return new MatchAllQuery(field);
+        }
+    }
