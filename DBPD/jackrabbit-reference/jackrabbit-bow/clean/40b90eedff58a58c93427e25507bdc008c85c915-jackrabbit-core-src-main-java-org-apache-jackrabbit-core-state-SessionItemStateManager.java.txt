JCR-3063: NullPointerException in ItemManager

Restore the JCR-2171 fix to avoid deadlocks.

Introduce extra synchronization and checks to prevent
the CMEs and replace the NPEs with InvalidItemStateExceptions.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1176465 13f79535-47bb-0310-9956-ffa450edef68

-        new HashMap<ItemId, ItemState>();
+            Collections.synchronizedMap(new HashMap<ItemId, ItemState>());
-        new HashMap<ItemId, ItemState>();
+            Collections.synchronizedMap(new HashMap<ItemId, ItemState>());
-            for (ItemState state : store.values()) {
+            ItemState[] states = store.values().toArray(new ItemState[0]);
+            for (ItemState state : states) {
-        Collection<ItemState> tmp = new ArrayList<ItemState>(transientStore.values());
+        ItemState[] tmp;
+        tmp = transientStore.values().toArray(new ItemState[0]);
-        tmp = new ArrayList<ItemState>(atticStore.values());
+        tmp = atticStore.values().toArray(new ItemState[0]);
-                transientState = atticStore.get(destroyed.getId());
+                transientState = atticStore.remove(destroyed.getId());
-                    atticStore.remove(destroyed.getId());
