JCR-814 Oracle bundle PM fails checking schema if 2 users use the same database


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@523680 13f79535-47bb-0310-9956-ffa450edef68

-        DatabaseMetaData metaData = con.getMetaData();
-        String tableName = schemaObjectPrefix + "BUNDLE";
-        if (metaData.storesLowerCaseIdentifiers()) {
-            tableName = tableName.toLowerCase();
-        } else if (metaData.storesUpperCaseIdentifiers()) {
-            tableName = tableName.toUpperCase();
-        }
-        String userName = metaData.getUserName();
-        ResultSet rs = metaData.getTables(null, userName, tableName, null);
-        boolean schemaExists;
-        try {
-            schemaExists = rs.next();
-        } finally {
-            rs.close();
-        }
-
-        if (!schemaExists) {
+        if (!checkTablesExist()) {
+     * Checks if the database table exist.
+     *
+     * @return <code>true</code> if the tables exist;
+     *         <code>false</code> otherwise.
+     *
+     * @throws SQLException if an SQL erro occurs.
+     */
+    protected boolean checkTablesExist() throws SQLException {
+        DatabaseMetaData metaData = con.getMetaData();
+        String tableName = schemaObjectPrefix + "BUNDLE";
+        if (metaData.storesLowerCaseIdentifiers()) {
+            tableName = tableName.toLowerCase();
+        } else if (metaData.storesUpperCaseIdentifiers()) {
+            tableName = tableName.toUpperCase();
+        }
+        String userName = checkTablesWithUser() ? metaData.getUserName() : null;
+        ResultSet rs = metaData.getTables(null, userName, tableName, null);
+        try {
+            return rs.next();
+        } finally {
+            rs.close();
+        }
+    }
+
+    /**
+     * Indicates if the username should be included when retrieving the tables
+     * during {@link #checkTablesExist()}.
+     * <p/>
+     * Please note that this currently only needs to be changed for oracle based
+     * persistence managers.
+     *
+     * @return <code>false</code>
+     */
+    protected boolean checkTablesWithUser() {
+        return false;
+    }
+
+    /**
