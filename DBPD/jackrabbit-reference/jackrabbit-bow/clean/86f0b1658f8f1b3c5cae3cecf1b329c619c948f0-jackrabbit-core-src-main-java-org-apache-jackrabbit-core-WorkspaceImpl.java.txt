JCR-2640: Internal repository context

Streamline WorkspaceImpl creation with the new WorkspaceManager class.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@948857 13f79535-47bb-0310-9956-ffa450edef68

-            WorkspaceConfig wspConfig, SharedItemStateManager stateMgr,
-            RepositoryContext repositoryContext, SessionImpl session) {
+            WorkspaceConfig wspConfig, RepositoryContext repositoryContext,
+            SessionImpl session) throws RepositoryException {
-        this.stateMgr = createItemStateManager(stateMgr);
+        this.stateMgr = createItemStateManager();
+     * Returns the shared item state manager of this workspace.
+     *
+     * @return shared item state manager
+     * @throws RepositoryException if the workspace can not be accessed
+     */
+    protected SharedItemStateManager getSharedItemStateManager()
+            throws RepositoryException {
+        WorkspaceManager manager = repositoryContext.getWorkspaceManager();
+        return manager.getWorkspaceStateManager(getName());
+    }
+
+    /**
-    protected LocalItemStateManager createItemStateManager(SharedItemStateManager shared) {
-        return LocalItemStateManager.createInstance(shared, this, rep.getItemStateCacheFactory());
+    protected LocalItemStateManager createItemStateManager()
+            throws RepositoryException {
+        return LocalItemStateManager.createInstance(
+                getSharedItemStateManager(), this, rep.getItemStateCacheFactory());
