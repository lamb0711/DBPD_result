JCR-623 - Clustering
+ Add close() method to journal
+ Release locks
+ Simplify RecordProcessor callback


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@489377 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.name.Path;
-import org.apache.jackrabbit.name.QName;
-import javax.jcr.observation.Event;
-import javax.jcr.Session;
-import java.util.Set;
-     * {@inheritDoc}
+     * Stops this cluster node.
-        status = STOPPED;
+        if (status == STARTED) {
+            status = STOPPED;
-        notifyAll();
+            journal.close();
+            notifyAll();
+        }
-         * Last used session for event sources.
-         */
-        private Session lastSession;
-
-        /**
-        public void process(int type, NodeId parentId, Path parentPath, NodeId childId,
-                            Path.PathElement childRelPath, QName ntName, Set mixins, String userId) {
-
-            EventState event = null;
-
-            switch (type) {
-                case Event.NODE_ADDED:
-                    event = EventState.childNodeAdded(parentId, parentPath, childId, childRelPath,
-                            ntName, mixins, getOrCreateSession(userId));
-                    break;
-                case Event.NODE_REMOVED:
-                    event = EventState.childNodeRemoved(parentId, parentPath, childId, childRelPath,
-                            ntName, mixins, getOrCreateSession(userId));
-                    break;
-                case Event.PROPERTY_ADDED:
-                    event = EventState.propertyAdded(parentId, parentPath, childRelPath,
-                            ntName, mixins, getOrCreateSession(userId));
-                    break;
-                case Event.PROPERTY_CHANGED:
-                    event = EventState.propertyChanged(parentId, parentPath, childRelPath,
-                            ntName, mixins, getOrCreateSession(userId));
-                    break;
-                case Event.PROPERTY_REMOVED:
-                    event = EventState.propertyRemoved(parentId, parentPath, childRelPath,
-                            ntName, mixins, getOrCreateSession(userId));
-                    break;
-                default:
-                    String msg = "Unexpected event type: " + type;
-                    log.warn(msg);
-            }
+        public void process(EventState event) {
-
-        /**
-         * Return a session matching a certain user id.
-         *
-         * @param userId user id
-         * @return session
-         */
-        private Session getOrCreateSession(String userId) {
-            if (lastSession == null || !lastSession.getUserID().equals(userId)) {
-                lastSession = new ClusterSession(userId);
-            }
-            return lastSession;
-        }
