JCR-489: TCK: Incorrect check of namespace mappings in System View XML export

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@425338 13f79535-47bb-0310-9956-ffa450edef68

-import javax.jcr.NamespaceRegistry;
+import java.util.Iterator;
+import java.util.Map;
-        // check the prefixes exported
+        // check exported namespaces
-            NamespaceRegistry nsr = session.getWorkspace().getNamespaceRegistry();
-            String[] registeredPrefixes = nsr.getPrefixes();
-            // check against the found prefixes
-/*
-            // invalid test: only the referenced namespaces need to be declared;
-            // apart from that, the 'xml' namespace, although registered,
-            // is never declared in the system view xml as this would be illegal
-            checkCondition("Size of included prefixes is not the size of " +
-                    "registered prefixes", registeredPrefixes.length == prefixes.size()) ;
-*/
-            for (int i=0; i<registeredPrefixes.length;i++) {
-                String prefix = registeredPrefixes[1];
-                String uri = nsr.getURI(prefix);
-                checkCondition("Registered prefix "+prefix + " not included",
-                    prefixes.containsKey(prefix) && prefixes.get(prefix).equals(uri) );
+            Map sessionNamespaces = new HashMap();
+            String[] sessionPrefixes = session.getNamespacePrefixes();
+            for (int i = 0; i < sessionPrefixes.length; i++) {
+                sessionNamespaces.put(sessionPrefixes[i], session.getNamespaceURI(sessionPrefixes[i]));
+            }
+
+            // check prefixes against namespace mapping in session
+            for (Iterator it = prefixes.keySet().iterator(); it.hasNext(); ) {
+                String prefix = (String) it.next();
+                if ("xml".equals(prefix)) {
+                    Assert.fail("Prefix mapping for 'xml' must not be exported.");
+                }
+
+                String uri = (String) prefixes.get(prefix);
+                checkCondition("Exported uri " + uri + " is not a registered namespace.",
+                        sessionNamespaces.containsValue(uri));
+                checkCondition("Exported prefix " + prefix + " does not match " +
+                        "current namespacce mapping in Session",
+                        sessionNamespaces.containsKey(prefix));
-            //
+            throw new SAXException(re);
