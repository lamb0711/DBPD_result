JCR-2740 On missing child node, automatically remove the entry

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1040601 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.session.SessionContext;
+import org.apache.jackrabbit.core.state.ItemStateManager;
+    /**
+     * The session context used to access the repository.
+     */
+    private final SessionContext sessionContext;
+
-     * @param itemMgr item manager
+     * @param sessionContext session context
-    public LazyItemIterator(ItemManager itemMgr, List< ? extends ItemId> idList) {
-        this(itemMgr, idList, null);
+    public LazyItemIterator(SessionContext sessionContext, List< ? extends ItemId> idList) {
+        this(sessionContext, idList, null);
-     * @param itemMgr item manager
+     * @param sessionContext session context
-    public LazyItemIterator(ItemManager itemMgr, List< ? extends ItemId> idList, NodeId parentId) {
-        this.itemMgr = itemMgr;
+    public LazyItemIterator(SessionContext sessionContext, List< ? extends ItemId> idList, NodeId parentId) {
+        this.sessionContext = sessionContext;
+        this.itemMgr = sessionContext.getSessionImpl().getItemManager();
+
+                // maybe fix the root cause
+                if (parentId != null && sessionContext.getSessionImpl().autoFixCorruptions()) {
+                    try {
+                        // it might be an access right problem
+                        // we need to check if the item doesn't exist in the ism
+                        ItemStateManager ism = sessionContext.getItemStateManager();
+                        if (!ism.hasItemState(id)) {
+                            NodeImpl p = (NodeImpl) itemMgr.getItem(parentId);
+                            p.removeChildNode((NodeId) id);
+                            p.save();
+                        }
+                    } catch (RepositoryException e2) {
+                        log.error("could not fix repository inconsistency", e);
+                        // ignore
+                    }
+                }
+
