JCR-1564: JSR 283 namespace handling
    - Reverted revision 653751 that broke API tests.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@653763 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.HashMap;
-import java.util.Map;
-
+import org.apache.jackrabbit.jcr2spi.name.LocalNamespaceMappings;
+     * The namespace mappings of the session that executes this query.
+     */
+    private final LocalNamespaceMappings nsResolver;
+
+    /**
-    public QueryImpl(Session session, NamePathResolver resolver,
+    public QueryImpl(Session session, LocalNamespaceMappings nsResolver, NamePathResolver resolver,
+        this.nsResolver = nsResolver;
-        this.wspManager.checkQueryStatement(
-                statement, language, getNamespaceMappings());
-    }
-
-    private Map getNamespaceMappings() throws RepositoryException {
-        Map map = new HashMap();
-        String[] prefixes = session.getNamespacePrefixes();
-        for (int i = 0; i < prefixes.length; i++) {
-            map.put(prefixes[i], session.getNamespaceURI(prefixes[i]));
-        }
-        return map;
+        this.wspManager.checkQueryStatement(statement, language, nsResolver.getLocalNamespaceMappings());
-    public QueryImpl(Session session, NamePathResolver resolver,
+    public QueryImpl(Session session, LocalNamespaceMappings nsResolver, NamePathResolver resolver,
-            throws InvalidQueryException, RepositoryException {
+        throws InvalidQueryException, RepositoryException {
+
+        this.nsResolver = nsResolver;
-        this.wspManager.checkQueryStatement(
-                statement, language, getNamespaceMappings());
+        this.wspManager.checkQueryStatement(statement, language,
+                    nsResolver.getLocalNamespaceMappings());
-        QueryInfo qI = wspManager.executeQuery(
-                statement, language, getNamespaceMappings());
+        QueryInfo qI = wspManager.executeQuery(statement, language,
+                nsResolver.getLocalNamespaceMappings());
