JCR-2836: Unclosed threads in Jackrabbit

Merge all timers into a single repository-wide timer instance and arrange for it to be cancelled when the repository is shutdown.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1055071 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.RepositoryContext;
+import org.apache.jackrabbit.util.Timer;
+     * Repository context.
+     */
+    private final RepositoryContext repositoryContext;
+
+    /**
-     * The node type registry of the repository
-     */
-    private final NodeTypeRegistry ntRegistry;
-
-    /**
-     * The namespace registry of the repository.
-     */
-    private final NamespaceRegistryImpl nsRegistry;
-
-    /**
-     * @param ntRegistry       the node type registry.
-     * @param nsRegistry       the namespace registry.
-    public QueryHandlerContext(SharedItemStateManager stateMgr,
-                               PersistenceManager pm,
-                               NodeId rootId,
-                               NodeTypeRegistry ntRegistry,
-                               NamespaceRegistryImpl nsRegistry,
-                               QueryHandler parentHandler,
-                               NodeId excludedNodeId,
-                               Executor executor) {
+    public QueryHandlerContext(
+            RepositoryContext repositoryContext,
+            SharedItemStateManager stateMgr,
+            PersistenceManager pm,
+            NodeId rootId,
+            QueryHandler parentHandler,
+            NodeId excludedNodeId,
+            Executor executor) {
+        this.repositoryContext = repositoryContext;
-        this.ntRegistry = ntRegistry;
-        this.nsRegistry = nsRegistry;
+        NodeTypeRegistry ntRegistry = repositoryContext.getNodeTypeRegistry();
-        return ntRegistry;
+        return repositoryContext.getNodeTypeRegistry();
-        return nsRegistry;
+        return repositoryContext.getNamespaceRegistry();
-        ntRegistry.removeListener(propRegistry);
+        repositoryContext.getNodeTypeRegistry().removeListener(propRegistry);
+    /**
+     * Returns the repository timer.
+     *
+     * @return repository timer
+     */
+    public Timer getTimer() {
+        return repositoryContext.getTimer();
+    }
+
