JCR-2462: IllegalStateException on session#save()

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@898267 13f79535-47bb-0310-9956-ffa450edef68

-import javax.jcr.InvalidItemStateException;
-import javax.jcr.ItemNotFoundException;
-import javax.jcr.RepositoryException;
-
+import javax.jcr.InvalidItemStateException;
+import javax.jcr.ItemNotFoundException;
+import javax.jcr.RepositoryException;
+
-                /*
-                NOTE: Property can only be the changelog target, if it was
-                      existing and has been modified. removal, add and implicit modification
-                      of protected properties must be persisted by save on parent.
-                */
-                op.getPropertyState().setStatus(Status.EXISTING);
+                // Property can only be the change log target if it was existing and has
+                // been modified. This includes the case where a property was changed and
+                // then removed by removing its parent. See JCR-2462. 
+                // Removal, add and implicit modification of protected
+                // properties must be persisted by save on parent.
+                PropertyState state = op.getPropertyState();
+                if (state.getStatus() != Status.REMOVED) {
+                    state.setStatus(Status.EXISTING);
+                }
