work in progress

- ChangeLog.checkIsSelfContained should throw destinct exception
  instead of general ItemStateException, which results in RepositoryEx.
- NodeState.refresh: 'add' event must only create a new childentry
  if it has not been indirectly created by a previous event.
- add more todos for SNS-handling

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@463327 13f79535-47bb-0310-9956-ffa450edef68

+                        int index = event.getQPath().getNameElement().getNormalizedIndex();
-                        ChildNodeEntry cne = childNodeEntries.add(name, uuid);
+
+                        // add new childNodeEntry if it has not been added by
+                        // some earlier 'add' event
+                        // TODO: TOBEFIXED for SNSs
+                        ChildNodeEntry cne = getChildNodeEntry(name, index);
+                        if (cne == null || ((uuid == null) ? cne.getUUID() != null : !uuid.equals(cne.getUUID()))) {
+                            cne = childNodeEntries.add(name, uuid);
+                        }
-                        ChildPropertyEntry re = PropertyReference.create(this, pName, isf, idFactory);
-                        properties.put(pName, re);
+                        // create a new property reference if it has not been
+                        // added by some earlier 'add' event
+                        ChildPropertyEntry re;
+                        if (hasPropertyName(pName)) {
+                            re = (ChildPropertyEntry) properties.get(pName);
+                        } else {
+                            re = PropertyReference.create(this, pName, isf, idFactory);
+                            properties.put(pName, re);
+                        }
+                            if (added.hasOverlayedState()) {
+                                // already connected
+                                continue;
+                            }
+                            // TODO: TOBEFIXED. may fail (produce wrong results) for SNSs, since currently events upon 'save' are not garantied to be 'local' changes only
