JCR-1588: JSR 283 Access Control (work in progress)

- Groups can only add 'allows'
- add tests
- clean evaluation tests from unused, temporary code


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@659109 13f79535-47bb-0310-9956-ffa450edef68

+import java.security.acl.Group;
-        if (entry instanceof PolicyEntryImpl &&
-            principal.equals(entry.getPrincipal())) {
-            // make sure valid privileges are provided.
-            PrivilegeRegistry.getBits(entry.getPrivileges());
-            return internalAddEntry((PolicyEntryImpl) entry);
-        } else {
-            throw new AccessControlException("Invalid entry.");
-        }
+        checkValidEntry(entry);
+        return internalAddEntry((PolicyEntryImpl) entry);
-        if (entry instanceof PolicyEntryImpl &&
-            principal.equals(entry.getPrincipal())) {
-            // make sure valid privileges are provided.
-            PrivilegeRegistry.getBits(entry.getPrivileges());
-            return entries.remove(entry);
-        } else {
-            throw new AccessControlException("Invalid entry.");
-        }
+        checkValidEntry(entry);
+        return entries.remove(entry);
+     * @throws AccessControlException
+     */
+    private void checkValidEntry(PolicyEntry entry) throws AccessControlException {
+        if (!(entry instanceof PolicyEntryImpl)) {
+            throw new AccessControlException("Invalid PolicyEntry " + entry + ". Expected instanceof ACEImpl.");
+        }
+        if (!principal.equals(entry.getPrincipal())) {
+            throw new AccessControlException("Invalid principal. Expected: " + principal);
+        }
+
+        PolicyEntryImpl ace = (PolicyEntryImpl) entry;
+        // TODO: ev. assert that the principal is known to the repository
+        // make sure valid privileges are provided.
+        PrivilegeRegistry.getBits(ace.getPrivileges());
+
+        if (!entry.isAllow() && entry.getPrincipal() instanceof Group) {
+            throw new AccessControlException("For group principals permissions can only be added but not denied.");
+        }
+    }
+
+    /**
+     *
+     * @param entry
