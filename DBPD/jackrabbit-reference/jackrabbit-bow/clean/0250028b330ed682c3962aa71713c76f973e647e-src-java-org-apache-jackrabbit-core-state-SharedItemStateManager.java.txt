JCR-45 fixes:
- fixing references into version storage
- fixing inter-version storage references

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@156188 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.ArrayList;
+        // set of virtual node references
+        // todo: remember by provider
+        ArrayList virtualRefs = new ArrayList();
+
-
-            if (refs.hasReferences()) {
-                try {
-                    if (local.get(id) == null && !hasItemState(id)) {
-                        throw new NoSuchItemStateException();
-                    }
-                } catch (NoSuchItemStateException e) {
-                    String msg = "Target node " + id + " of REFERENCE property does not exist";
-                    throw new ItemStateException(msg);
+            // if targetid is in virtual provider, transfer to its modified set
+            for (int i=0; i<virtualProviders.length; i++) {
+                VirtualItemStateProvider provider = virtualProviders[i];
+                if (provider.hasItemState(id)) {
+                    virtualRefs.add(refs);
+                    refs = null;
+                    break;
-            shared.modified(refs);
+            if (refs != null) {
+                if (refs.hasReferences()) {
+                    try {
+                        if (local.get(id) == null && !hasItemState(id)) {
+                            throw new NoSuchItemStateException();
+                        }
+                    } catch (NoSuchItemStateException e) {
+                        String msg = "Target node " + id + " of REFERENCE property does not exist";
+                        throw new ItemStateException(msg);
+                    }
+                }
+                shared.modified(refs);
+            }
+        /* notify virtual providers about node references */
+        iter = virtualRefs.iterator();
+        while (iter.hasNext()) {
+            NodeReferences refs = (NodeReferences) iter.next();
+            // if targetid is in virtual provider, transfer to its modified set
+            for (int i=0; i<virtualProviders.length; i++) {
+                if (virtualProviders[i].setNodeReferences(refs)) {
+                    break;
+                }
+            }
+        }
+
