JCR-1590: JSR 283: Locking

Add tracking of timeout information. Work in progress...

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@803604 13f79535-47bb-0310-9956-ffa450edef68

-        }
-        if (!isLockOwningSession()) {
+        } else if (!isLockOwningSession()) {
-        }
-        // make sure the current session has sufficient privileges to refresh
-        // the lock.
-        SessionImpl s = (SessionImpl) node.getSession();
-        s.getAccessManager().checkPermission(node.getPrimaryPath(), Permission.LOCK_MNGMT);
+        } else {
+            // make sure the current session has sufficient privileges to refresh
+            // the lock.
+            SessionImpl session = (SessionImpl) node.getSession();
+            session.getAccessManager().checkPermission(
+                    node.getPrimaryPath(), Permission.LOCK_MNGMT);
-        // TODO: TOBEFIXED for 2.0
-        // TODO  - add refresh if timeout is supported -> see #getSecondsRemaining
-        // since a lock has no expiration date no other action is required
+            // Update the lock timeout
+            info.updateTimeoutTime();
+        }
-    /**
-     * @see javax.jcr.lock.Lock#getSecondsRemaining()
-     */
+    /** {@inheritDoc} */
-        return info.getSecondsRemaining();
+        if (!info.isLive()) {
+            return -1;
+        } else {
+            return Long.MAX_VALUE;
+        }
+
+        // TODO JCR-1590: Disabled until locks get unlocked when they timeout
+//        long timeout = info.getTimeoutTime();
+//        if (timeout == Long.MAX_VALUE) {
+//            return Long.MAX_VALUE;
+//        }
+//
+//        long now = (System.currentTimeMillis() + 999) / 1000; // round up
+//        return Math.max(timeout - now, 1); // must always be positive
