JCR-3156: Group#getMembers may list inherited members multiple times

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1205400 13f79535-47bb-0310-9956-ffa450edef68

-        return new LazyIteratorChain<Authorizable>(indirectMembers);
+        return unique(new LazyIteratorChain<Authorizable>(indirectMembers));
+    }
+
+    /**
+     * Filter the passed {@code authorizables} in order to ensure uniqueness.
+     * @param authorizables
+     * @return  all members of {@code authorizable} with duplicates removed
+     *
+     * @see <a href="https://issues.apache.org/jira/browse/JCR-3156">JCR-3156</a>
+     */
+    private Iterator<Authorizable> unique(Iterator<Authorizable> authorizables) {
+        final HashSet<String> seenAuthorizables = new HashSet<String>();
+        return Iterators.filterIterator(authorizables,
+                new org.apache.jackrabbit.spi.commons.iterator.Predicate<Authorizable>() {
+
+            public boolean evaluate(Authorizable authorizable) {
+                try {
+                    return seenAuthorizables.add(authorizable.getID());
+                }
+                catch (RepositoryException e) {
+                    log.warn("Could not determine id of " + authorizable, e);
+                    return true;
+                }
+            }
+        });
