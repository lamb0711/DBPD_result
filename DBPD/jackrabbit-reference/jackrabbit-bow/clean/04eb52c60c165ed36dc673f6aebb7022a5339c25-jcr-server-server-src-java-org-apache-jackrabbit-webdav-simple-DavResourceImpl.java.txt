JCR-405: PROPPATCH doesn't respect document order
minor improvements within 'jcr' package:
- reorder nodes
- fixing creation/replacement of multivalued JCR properties
- contentlength for single value JCR properties
- improve spooling of resource content

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@397835 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.webdav.property.DavPropertyNameIterator;
-     * @see DavResource#alterProperties(org.apache.jackrabbit.webdav.property.DavPropertySet, org.apache.jackrabbit.webdav.property.DavPropertyNameSet)
+     * @see DavResource#alterProperties(DavPropertySet, DavPropertyNameSet)
+        List changeList = new ArrayList();
+        if (removePropertyNames != null) {
+            DavPropertyNameIterator it = removePropertyNames.iterator();
+            while (it.hasNext()) {
+                changeList.add(it.next());
+            }
+        }
+        if (setProperties != null) {
+            DavPropertyIterator it = setProperties.iterator();
+            while (it.hasNext()) {
+                changeList.add(it.next());
+            }
+        }
+
+        return alterProperties(changeList);
+    }
+
+    public MultiStatusResponse alterProperties(List changeList) throws DavException {
-
-        // loop over set and remove Sets and remember all properties and propertyNames
+        // loop over List and remember all properties and propertyNames
-        DavPropertyIterator setIter = setProperties.iterator();
-        while (setIter.hasNext()) {
-            DavProperty prop = setIter.nextProperty();
-            try {
-                setJcrProperty(prop);
-                successList.add(prop);
-            } catch (RepositoryException e) {
-                msr.add(prop.getName(), new JcrDavException(e).getErrorCode());
-                success = false;
-            }
-        }
-
-        Iterator remNameIter = removePropertyNames.iterator();
-        while (remNameIter.hasNext()) {
-            DavPropertyName propName = (DavPropertyName) remNameIter.next();
-            try {
-                removeJcrProperty(propName);
-                successList.add(propName);
-            } catch (RepositoryException e) {
-                msr.add(propName, new JcrDavException(e).getErrorCode());
-                success = false;
+        Iterator it = changeList.iterator();
+        while (it.hasNext()) {
+            Object propEntry = it.next();
+            if (propEntry instanceof DavPropertyName) {
+                DavPropertyName propName = (DavPropertyName)propEntry;
+                try {
+                    removeJcrProperty(propName);
+                    successList.add(propName);
+                } catch (RepositoryException e) {
+                    msr.add(propName, new JcrDavException(e).getErrorCode());
+                    success = false;
+                }
+            } else if (propEntry instanceof DavProperty) {
+                DavProperty prop = (DavProperty)propEntry;
+                try {
+                    setJcrProperty(prop);
+                    successList.add(prop);
+                } catch (RepositoryException e) {
+                    msr.add(prop.getName(), new JcrDavException(e).getErrorCode());
+                    success = false;
+                }
+            } else {
+                throw new IllegalArgumentException("unknown object in change list: " + propEntry.getClass().getName());
-            Iterator it = successList.iterator();
+            it = successList.iterator();
