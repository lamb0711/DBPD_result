JCR-2887 : Split PrivilegeRegistry in a per-session manager instance and a repository level registry [work in progress]

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1092723 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.security.authorization.PrivilegeBits;
- * <code>CombinedProvider</code>...
+ * <code>ACLProvider</code>...
-    private int readBits;
-        editor = new ACLEditor(session, resolver.getQPath(acRoot.getPath()));
+        editor = new ACLEditor(session, session.getQPath(acRoot.getPath()));
-        PrivilegeManagerImpl pm = getPrivilegeManagerImpl();
-        readBits = pm.getBits(pm.getPrivilege(Privilege.JCR_READ));
-                    if (!ace.isAllow() && ((ace.getPrivilegeBits() & readBits) == readBits)) {
+                    if (!ace.isAllow() && ace.getPrivilegeBits().includesRead()) {
-            int allowBits = PrivilegeRegistry.NO_PRIVILEGE;
-            int denyBits = PrivilegeRegistry.NO_PRIVILEGE;
-            int parentAllowBits = PrivilegeRegistry.NO_PRIVILEGE;
-            int parentDenyBits = PrivilegeRegistry.NO_PRIVILEGE;
-
-            Set<Privilege> customAllow = new HashSet<Privilege>();
-            Set<Privilege> customDeny = new HashSet<Privilege>();
+            PrivilegeBits allowBits = PrivilegeBits.getInstance();
+            PrivilegeBits denyBits = PrivilegeBits.getInstance();
+            PrivilegeBits parentAllowBits = PrivilegeBits.getInstance();
+            PrivilegeBits parentDenyBits = PrivilegeBits.getInstance();
-                int privs = entr.getPrivilegeBits();
+                PrivilegeBits privs = entr.getPrivilegeBits();
-                        parentAllowBits |= Permission.diff(privs, parentDenyBits);
+                        parentAllowBits.addDifference(privs, parentDenyBits);
-                        parentDenyBits |= Permission.diff(privs, parentAllowBits);
+                        parentDenyBits.addDifference(privs, parentAllowBits);
-                        allowBits |= Permission.diff(privs, denyBits);
+                        allowBits.addDifference(privs, denyBits);
-
-                        updatePrivileges(entr.getCustomPrivileges(), customAllow, customDeny);
-                        denyBits |= Permission.diff(privs, allowBits);
+                        denyBits.addDifference(privs, allowBits);
-
-                        updatePrivileges(entr.getCustomPrivileges(), customDeny, customAllow);
-            return new Result(allows, denies, allowBits, denyBits, customAllow, customDeny);
+            return new Result(allows, denies, allowBits, denyBits);
