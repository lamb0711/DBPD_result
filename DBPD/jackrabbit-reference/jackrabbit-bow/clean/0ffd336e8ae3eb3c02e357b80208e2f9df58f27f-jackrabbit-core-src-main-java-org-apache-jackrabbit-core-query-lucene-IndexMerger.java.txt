JCR-778: Error on query initialization - intermittent

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@533080 13f79535-47bb-0310-9956-ffa450edef68

+     * When released, indicates that this index merger is idle.
+     */
+    private final Sync mergerIdle = new Mutex();
+
+    /**
+        try {
+            mergerIdle.acquire();
+        } catch (InterruptedException e) {
+            // will never happen, lock is free upon construction
+            throw new InternalError("Unable to acquire mutex after construction");
+        }
+     * When the calling thread returns this index merger will be idle, that is
+     * there will be no merge tasks pending anymore. The method returns immediately
+     * if there are currently no tasks pending at all.
+     */
+    void waitUntilIdle() throws InterruptedException {
+        mergerIdle.acquire();
+        // and immediately release again
+        mergerIdle.release();
+    }
+
+    /**
+            boolean isIdle = false;
+            if (mergeTasks.size() == 0) {
+                mergerIdle.release();
+                isIdle = true;
+            }
+                mergerIdle.release();
+            if (isIdle) {
+                try {
+                    mergerIdle.acquire();
+                } catch (InterruptedException e) {
+                    Thread.interrupted();
+                    log.warn("Unable to acquire mergerIdle sync");
+                }
+            }
