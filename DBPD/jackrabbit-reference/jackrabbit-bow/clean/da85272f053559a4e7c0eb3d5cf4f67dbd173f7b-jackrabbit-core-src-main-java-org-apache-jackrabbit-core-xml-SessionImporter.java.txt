JCR-2195 Provide possibility to import protected items using Session/Workspace import 


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@810471 13f79535-47bb-0310-9956-ffa450edef68

-     * Current importer for protected nodes.
+     * Importer for protected nodes.
-    private ProtectedNodeImporter currentNodeImporter;
+    private final ProtectedNodeImporter pnImporter;
-     * Handlers for protected items.
+     * Importer for protected properties.
-    private final ProtectedItemHandlers protectedItemHandlers;
+    private final ProtectedPropertyImporter ppImporter;
-        this(importTargetNode, session, uuidBehavior, null);
+        this(importTargetNode, session, uuidBehavior, null, null);
-     * @param protectedItemHandlers protected item handling
+     * @param pnImporter importer for protected nodes
+     * @param ppImporter importer for protected properties
-                           ProtectedItemHandlers protectedItemHandlers) {
+                           ProtectedNodeImporter pnImporter,
+                           ProtectedPropertyImporter ppImporter) {
-        this.protectedItemHandlers = protectedItemHandlers == null
-                ? new ProtectedItemHandlers()
-                : protectedItemHandlers;
+        this.ppImporter = ppImporter == null
+                ? new DefaultProtectedPropertyImporter(session, session, false)
+                : ppImporter;
+        this.pnImporter = pnImporter == null
+                ? new DefaultProtectedNodeImporter(session, session, false, uuidBehavior)
+                : pnImporter;
-            if (currentNodeImporter != null) {
-                currentNodeImporter.startChildInfo(nodeInfo, propInfos);
-            }
+            pnImporter.startChildInfo(nodeInfo, propInfos);
-            currentNodeImporter = protectedItemHandlers.accept(parent);
-            if (currentNodeImporter != null) {
+            if (pnImporter.start(parent)) {
-                currentNodeImporter.startChildInfo(nodeInfo, propInfos);
+                pnImporter.startChildInfo(nodeInfo, propInfos);
-                if (protectedItemHandlers.handlePropInfo(node, pi, def)) {
+                if (ppImporter.handlePropInfo(node, pi, def)) {
-            if (currentNodeImporter != null) {
-                currentNodeImporter.endChildInfo();
-            }
+            pnImporter.endChildInfo();
-            if (currentNodeImporter != null) {
-                currentNodeImporter.end(parent);
-                currentNodeImporter = null;
-            }
+            pnImporter.end(parent);
