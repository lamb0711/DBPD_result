JCR-3729 - S3 Datastore optimizations


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1577127 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.ArrayList;
-import java.util.List;
+import com.amazonaws.services.s3.AmazonS3;
-import com.amazonaws.services.s3.model.DeleteObjectsRequest;
-import com.amazonaws.services.s3.model.DeleteObjectsResult;
-    public static final String DEFAULT_CONFIG_FILE = "aws.properties";
-    
+    public static final String DEFAULT_CONFIG_FILE = "aws.properties";
+
-     * @param prop properties to configure @link {@link AmazonS3Client} and
-     * delete bucket.
+     * @param bucketName the bucket name.
-    public static void deleteBucket(final Properties prop) throws IOException {
-        AmazonS3Client s3service = openService(prop);
-        String bucketName = prop.getProperty(S3Constants.S3_BUCKET);
-        if (!s3service.doesBucketExist(bucketName)) {
-            return;
-        }
+    public static void deleteBucket(final String bucketName) throws IOException {
+        Properties prop = readConfig(DEFAULT_CONFIG_FILE);
+        AmazonS3 s3service = openService(prop);
-            List<DeleteObjectsRequest.KeyVersion> deleteList = new ArrayList<DeleteObjectsRequest.KeyVersion>();
-                deleteList.add(new DeleteObjectsRequest.KeyVersion(
-                    s3ObjSumm.getKey()));
-            }
-            if (deleteList.size() > 0) {
-                DeleteObjectsRequest delObjsReq = new DeleteObjectsRequest(
-                    bucketName);
-                delObjsReq.setKeys(deleteList);
-                DeleteObjectsResult dobjs = s3service.deleteObjects(delObjsReq);
-                if (dobjs.getDeletedObjects().size() != deleteList.size()) {
-                    throw new IOException(
-                        "Incomplete delete object request. only  "
-                            + dobjs.getDeletedObjects().size() + " out of "
-                            + deleteList.size() + " are deleted");
-                }
-                LOG.info(deleteList.size()
-                        + " records deleted from datastore");
+                s3service.deleteObject(bucketName, s3ObjSumm.getKey());
-        s3service.shutdown();
