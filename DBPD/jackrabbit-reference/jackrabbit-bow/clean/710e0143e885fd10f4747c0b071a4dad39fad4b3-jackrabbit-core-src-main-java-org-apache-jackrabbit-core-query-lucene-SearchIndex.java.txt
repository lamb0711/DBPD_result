JCR-800: Child Axis support in order by clause

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@744889 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.spi.commons.conversion.NamePathResolver;
+import org.apache.lucene.search.SortComparatorSource;
-import javax.jcr.NamespaceException;
-     * The name and path resolver used internally.
-     */
-    private NamePathResolver npResolver;
-
-    /**
+     * The sort comparator source for indexed properties.
+     */
+    private SortComparatorSource scs;
+
+    /**
-        npResolver = NamePathResolverImpl.create(nsMappings);
+        scs = new SharedFieldSortComparator(
+                FieldNames.PROPERTIES, context.getItemStateManager(),
+                context.getHierarchyManager(), nsMappings);
-                                  Name[] orderProps,
+                                  Path[] orderProps,
-    protected SortField[] createSortFields(Name[] orderProps,
+    protected SortField[] createSortFields(Path[] orderProps,
-            String prop = null;
-            if (NameConstants.JCR_SCORE.equals(orderProps[i])) {
+            if (orderProps[i].getLength() == 1
+                    && NameConstants.JCR_SCORE.equals(orderProps[i].getNameElement().getName())) {
-                try {
-                    prop = npResolver.getJCRName(orderProps[i]);
-                } catch (NamespaceException e) {
-                    // will never happen
-                }
-                sortFields.add(new SortField(prop, SharedFieldSortComparator.PROPERTIES, !orderSpecs[i]));
+                sortFields.add(new SortField(orderProps[i].getString(), scs, !orderSpecs[i]));
