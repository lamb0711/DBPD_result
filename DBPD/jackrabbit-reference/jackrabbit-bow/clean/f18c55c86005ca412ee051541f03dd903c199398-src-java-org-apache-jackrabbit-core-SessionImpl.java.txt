fixed JCR-42: Workspace.move() and Session.move() allow moves to an invalid path
minor other changes

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@153279 13f79535-47bb-0310-9956-ffa450edef68

-    protected SessionItemStateManager createSessionItemStateManager(
-            UpdatableItemStateManager manager) {
+    protected SessionItemStateManager createSessionItemStateManager(UpdatableItemStateManager manager) {
-            VersionException, RepositoryException {
+            VersionException, LockException, RepositoryException {
+            if (srcPath.isAncestorOf(destPath)) {
+                String msg = destAbsPath + ": invalid destination path (cannot be descendant of source path)";
+                log.debug(msg);
+                throw new RepositoryException(msg);
+            }
+        // verify that both source and destination parent nodes are checked-out
+        if (!srcParentNode.internalIsCheckedOut()) {
+            String msg = srcAbsPath + ": cannot move a child of a checked-in node";
+            log.debug(msg);
+            throw new VersionException(msg);
+        }
+        if (!destParentNode.internalIsCheckedOut()) {
+            String msg = destAbsPath + ": cannot move a target to a checked-in node";
+            log.debug(msg);
+            throw new VersionException(msg);
+        }
+
-            String msg = parentAbsPath + ": node expected";
-            log.debug(msg);
-            throw new RepositoryException(msg);
+            throw new PathNotFoundException(parentAbsPath);
