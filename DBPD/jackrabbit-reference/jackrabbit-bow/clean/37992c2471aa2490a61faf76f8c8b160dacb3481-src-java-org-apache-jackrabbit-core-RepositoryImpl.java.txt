first implementation of jta support

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@55234 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.state.ItemStateException;
-import org.apache.jackrabbit.core.state.ItemStateProvider;
-import org.apache.jackrabbit.core.state.PersistentItemStateManager;
-import org.apache.jackrabbit.core.state.ReferenceManager;
+import org.apache.jackrabbit.core.state.*;
+import org.apache.jackrabbit.core.state.tx.TransactionManager;
+import org.apache.jackrabbit.core.state.tx.XASessionImpl;
+    private final TransactionManager txMgr;
-                UUID rootUUID = UUID.randomUUID();	// version 4 uuid
+                UUID rootUUID = UUID.randomUUID();     // version 4 uuid
+        // setup internal transaction manager
+        // @todo rewrite to use file system abstraction (FileSystem interface)
+        try {
+            File txRootDir = new File(repConfig.getHomeDir(), "tx");
+            txMgr = new TransactionManager(new File("tx"));
+        } catch (IOException ioe) {
+            String msg = "failed to initialize internal transaction manager";
+            log.error(msg, ioe);
+            throw new RepositoryException(msg, ioe);
+        }
+
-        } catch (NoPrefixDeclaredException e) {
-            throw new RepositoryException("Error: " + e.toString());
+        } catch (NoPrefixDeclaredException npde) {
+            String msg = "failed to initialize version manager";
+            log.error(msg, npde);
+            throw new RepositoryException(msg, npde);
-    synchronized PersistentItemStateManager getWorkspaceStateManager(String workspaceName)
+    synchronized PersistentItemStateProvider getWorkspaceStateManager(String workspaceName)
-        PersistentItemStateManager stateMgr =
-                (PersistentItemStateManager) wspStateMgrs.get(workspaceName);
+        PersistentItemStateProvider stateMgr =
+                (PersistentItemStateProvider) wspStateMgrs.get(workspaceName);
-                searchMgr = new SearchManager(stateProvider, s.hierMgr, s,
+                searchMgr = new SearchManager(stateProvider, s.getHierarchyManager(), s,
-
-            return new SessionImpl(this, credentials, wspConfig);
+            return new XASessionImpl(this, credentials, wspConfig, txMgr);
