JCR-4079: incorrect PROPPATCH response error handling

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1773579 13f79535-47bb-0310-9956-ffa450edef68

-            log.warn("Expected a single multi-status response in PROPPATCH.");
+            log.warn("Expected a single multi-status response in PROPPATCH, but got " + resp.length + " elements.");
+
-        for (int i = 0; i < 1; i++) {
-            DavPropertyNameSet okSet = resp[i].getPropertyNames(DavServletResponse.SC_OK);
-            if (okSet.isEmpty()) {
-                log.debug("PROPPATCH failed: No 'OK' response found for resource " + resp[i].getHref());
-                success = false;
-            } else {
-                DavPropertyNameIterator it = propertyNames.iterator();
-                while (it.hasNext()) {
-                    DavPropertyName pn = it.nextPropertyName();
-                    success = okSet.remove(pn);
+        if (resp.length == 1) {
+            MultiStatusResponse r = resp[0];
+
+            if (r.isPropStat()) {
+                DavPropertyNameSet okSet = r.getPropertyNames(DavServletResponse.SC_OK);
+                if (okSet.isEmpty()) {
+                    log.debug("PROPPATCH failed: No 'OK' response found for resource " + r.getHref());
+                    success = false;
+                } else {
+                    DavPropertyNameIterator it = propertyNames.iterator();
+                    while (it.hasNext()) {
+                        DavPropertyName pn = it.nextPropertyName();
+                        success = okSet.remove(pn);
+                    }
+                }
+                if (!okSet.isEmpty()) {
+                    StringBuffer b = new StringBuffer("The following properties outside of the original request where set or removed: ");
+                    DavPropertyNameIterator it = okSet.iterator();
+                    while (it.hasNext()) {
+                        b.append(it.nextPropertyName().toString()).append("; ");
+                    }
+                    log.warn(b.toString());
-            if (!okSet.isEmpty()) {
-                StringBuffer b = new StringBuffer("The following properties outside of the original request where set or removed: ");
-                DavPropertyNameIterator it = okSet.iterator();
-                while (it.hasNext()) {
-                    b.append(it.nextPropertyName().toString()).append("; ");
+            else {
+                int status = r.getStatus()[0].getStatusCode();
+                success = status == DavServletResponse.SC_OK;
+                if (!success) {
+                    log.warn("PROPPATCH failed: overall status of " + status);
-                log.warn(b.toString());
+            // TODO: array might be empty, no?
