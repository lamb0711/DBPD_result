[JCR-374] Missing 'node removed' event when removing a version

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@393000 13f79535-47bb-0310-9956-ffa450edef68

-
-
-                ItemState state = stateMgr.getItemState(entry.getId());
-                stateMgr.destroy(state);
+                removeNode(entry.getId());
+     * removes recursively the node with the given id
+     *
+     * @param id
+     * @throws ItemStateException
+     */
+    private void removeNode(NodeId id) throws ItemStateException {
+        NodeState state = (NodeState) stateMgr.getItemState(id);
+
+        // remove properties
+        Iterator iter = state.getPropertyNames().iterator();
+        while (iter.hasNext()) {
+            QName name = (QName) iter.next();
+            PropertyId propId = new PropertyId(id, name);
+            PropertyState propState = (PropertyState) stateMgr.getItemState(propId);
+            stateMgr.destroy(propState);
+        }
+        state.removeAllPropertyNames();
+
+        // remove child nodes
+        iter = state.getChildNodeEntries().iterator();
+        while (iter.hasNext()) {
+            NodeState.ChildNodeEntry entry = (NodeState.ChildNodeEntry) iter.next();
+            removeNode(entry.getId());
+        }
+        state.removeAllChildNodeEntries();
+
+        // destroy the state itself
+        stateMgr.destroy(state);
+    }
+
+    /**
