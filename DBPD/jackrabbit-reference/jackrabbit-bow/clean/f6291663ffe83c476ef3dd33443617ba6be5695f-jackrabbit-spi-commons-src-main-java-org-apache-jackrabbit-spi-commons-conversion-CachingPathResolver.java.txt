JCR-2028: JSR 283 JCR Path

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@772659 13f79535-47bb-0310-9956-ffa450edef68

-        Path qpath = (Path) cache.get(path);
-        if (qpath == null) {
-            qpath = resolver.getQPath(path);
-            cache.put(path, qpath);
+        return getQPath(path, true);
+    }
+
+    /**
+     * @see PathResolver#getQPath(String, boolean) 
+     */
+    public Path getQPath(String path, boolean normalizeIdentifier) throws MalformedPathException, IllegalNameException, NamespaceException {
+        Path qpath;
+        /*
+         * Jcr paths consisting of an identifier segment have 2 different
+         * path object representations depending on the given resolution flag:
+         * 1) a normalized absolute path if resolveIdentifier is true
+         * 2) a path denoting an identifier if resolveIdentifier is false.
+         * The latter are not cached in order not to return a wrong resolution
+         * when calling getQPath with the same identifier-jcr-path.
+         */
+        if (path.startsWith("[") && !normalizeIdentifier) {
+            qpath = resolver.getQPath(path, normalizeIdentifier);
+        } else {
+            qpath = (Path) cache.get(path);
+            if (qpath == null) {
+                qpath = resolver.getQPath(path, normalizeIdentifier);
+                cache.put(path, qpath);
+            }
+
