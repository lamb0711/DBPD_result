JCR-442: Committed patch-060808-backup.txt from Nicolas.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@429606 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.ByteArrayInputStream;
+import java.io.ObjectInputStream;
+import javax.jcr.NamespaceException;
+import org.apache.jackrabbit.core.NamespaceRegistryImpl;
-
+    
-
+    
-        
+
-        
-        HashMap h;
+        private HashMap h;
-
-        public Namespaces() {
-            h = new HashMap();            
-        }
-        
-        public void addNamespace(String prefix, String uri) {
-            h.put(prefix, uri);          
+        protected Namespaces() {
+            h = new HashMap();
+        protected void addNamespace(String uri, String prefix) {
+            h.put(uri, prefix);
+        }
+
+        protected String[] getAllUri() {
+            String[] s = new String[1];
+            return  (String[]) h.keySet().toArray(s);
+        }
+
+        public String getPrefix(String uri) {
+            return (String) h.get(uri);
+        }
-   /**
+    /**
- * @throws RepositoryException 
- * @throws LoginException 
+     * @throws RepositoryException 
+     * @throws LoginException 
-    public NamespaceBackup(RepositoryImpl repo, BackupConfig conf) throws LoginException, RepositoryException {
-        super(repo, conf);
-       
-        
-       
+    public NamespaceBackup(RepositoryImpl repo, BackupConfig conf, String login, String password) throws LoginException, RepositoryException {
+        super(repo, conf, login, password);
-    
+
-
-       Session s = this.getSession();
-       Workspace wsp = s.getWorkspace();
-       NamespaceRegistry ns = wsp.getNamespaceRegistry();
-       
-       Namespaces myNs = new Namespaces();
+        Session s = this.getSession();
+        Workspace wsp = s.getWorkspace();
+        NamespaceRegistry ns = wsp.getNamespaceRegistry();
-       String[] allPrefixes = ns.getPrefixes();
-              
-       for (int i = 0; i < allPrefixes.length; i++) {
-           String prefix = allPrefixes[i];
-           myNs.addNamespace(prefix, ns.getURI(prefix));          
-       }
-       
-       String name = this.getClass().toString();
-       
-       ByteArrayOutputStream fos = new ByteArrayOutputStream();
-       ObjectOutputStream oos = new ObjectOutputStream(fos);
-       oos.writeObject(myNs);       
-       h.write(name, fos);     
+        Namespaces myNs = new Namespaces();
+        
+        String[] allPrefixes = ns.getPrefixes();
+        
+        for (int i = 0; i < allPrefixes.length; i++) {
+            String prefix = allPrefixes[i];
+            myNs.addNamespace(ns.getURI(prefix),prefix);
+        }
+        
+        String name = this.getClass().toString();
+        
+        ByteArrayOutputStream fos = new ByteArrayOutputStream();
+        ObjectOutputStream oos = new ObjectOutputStream(fos);
+        oos.writeObject(myNs);
+        h.write(name, fos);
-
+    
-    public void restore(BackupIOHandler h) {
-        // TODO Auto-generated method stub
-
+    public void restore(BackupIOHandler h) throws RepositoryException, IOException {
+        String name = this.getClass().toString();
+        byte[] ns = h.read(name);
+        ByteArrayInputStream bis = new ByteArrayInputStream(ns);
+        ObjectInputStream ois = new ObjectInputStream(bis);
+        
+        try {
+            Namespaces allNs = (Namespaces) ois.readObject();
+            String[] allUri = allNs.getAllUri();
+            
+            Session s = this.getSession();
+            Workspace wsp = s.getWorkspace();
+            NamespaceRegistryImpl nsr = (NamespaceRegistryImpl) wsp.getNamespaceRegistry();
+            
+            for (int i = 0; i < allUri.length; i++) {
+                nsr.safeRegisterNamespace(allNs.getPrefix(allUri[i]), allUri[i]);
+            }
+        } catch (ClassNotFoundException e) {
+            throw new RepositoryException();
+        }
-    
-    
-
