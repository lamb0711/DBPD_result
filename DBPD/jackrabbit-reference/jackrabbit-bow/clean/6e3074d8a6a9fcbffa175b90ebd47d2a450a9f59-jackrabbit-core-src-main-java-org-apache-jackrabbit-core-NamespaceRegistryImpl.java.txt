JCR-888: javax.jcr.NamespaceException: : is not a registered namespace uri

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@950680 13f79535-47bb-0310-9956-ffa450edef68

+    /**
+     * Special property key string to be used instead of an empty key to
+     * avoid problems with Java implementations that have problems with
+     * empty keys in property files. The selected value ({@value}) would be
+     * invalid as either a namespace prefix or a URI, so there's little fear
+     * of accidental collisions.
+     *
+     * @see <a href="https://issues.apache.org/jira/browse/JCR-888">JCR-888</a>
+     */
+    private static final String EMPTY_KEY = ".empty.key";
+
-                    String idx = indexes.getProperty(uri);
+                    String idx = indexes.getProperty(escapePropertyKey(uri));
+                    // JCR-888: Backwards compatibility check
+                    if (idx == null && uri.equals("")) {
+                        idx = indexes.getProperty(uri);
+                    }
-                        map(prefix, uri, Integer.decode(idx));
+                        map(unescapePropertyKey(prefix), uri, Integer.decode(idx));
-                        map(prefix, uri);
+                        map(unescapePropertyKey(prefix), uri);
-                props.setProperty(prefix, uri);
+                props.setProperty(escapePropertyKey(prefix), uri);
-                props.setProperty(uri, index);
+                props.setProperty(escapePropertyKey(uri), index);
+     * Replaces an empty string with the special {@link #EMPTY_KEY} value.
+     *
+     * @see #unescapePropertyKey(String)
+     * @param key property key
+     * @return escaped property key
+     */
+    private String escapePropertyKey(String key) {
+        if (key.equals("")) {
+            return EMPTY_KEY;
+        } else {
+            return key;
+        }
+    }
+
+    /**
+     * Converts the special {@link #EMPTY_KEY} value back to an empty string.
+     *
+     * @see #escapePropertyKey(String)
+     * @param key property key
+     * @return escaped property key
+     */
+    private String unescapePropertyKey(String key) {
+        if (key.equals(EMPTY_KEY)) {
+            return "";
+        } else {
+            return key;
+        }
+    }
+
+    /**
