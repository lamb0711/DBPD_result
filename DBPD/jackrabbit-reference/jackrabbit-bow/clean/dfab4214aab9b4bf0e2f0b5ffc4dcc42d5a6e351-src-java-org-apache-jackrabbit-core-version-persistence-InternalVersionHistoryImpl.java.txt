- rearranging structure of versioning (will corrupt versioned data)
- adding observation of version storage (work in progress)


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@159366 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.PropertyImpl;
-import javax.jcr.PropertyIterator;
-        historyId = (String) node.getPropertyValue(NativePVM.PROPNAME_HISTORY_ID).internalValue();
+        historyId = node.getUUID();
-            InternalVersionImpl v = new InternalVersionImpl(this, child);
+            InternalVersionImpl v = new InternalVersionImpl(this, child, child.getName());
-    protected String getPersistentId() {
-        return node.getUUID();
-    }
-
-            PersistentNode lNode = labelNode.addNode(label, NT_UNSTRUCTURED);
+            PersistentNode lNode = labelNode.addNode(label, NT_UNSTRUCTURED, null);
-        QName nodeName = new QName(NS_DEFAULT_URI, versionId);
-        PersistentNode vNode = node.addNode(nodeName, NativePVM.NT_REP_VERSION);
-        vNode.setPropertyValue(NativePVM.PROPNAME_VERSION_ID, InternalValue.create(versionId));
-        vNode.setPropertyValue(NativePVM.PROPNAME_VERSION_NAME, InternalValue.create(name));
+        PersistentNode vNode = node.addNode(name, NativePVM.NT_REP_VERSION, versionId);
-        InternalVersionImpl version = new InternalVersionImpl(this, vNode);
+        InternalVersionImpl version = new InternalVersionImpl(this, vNode, name);
-    protected String getUUID() {
-        return node.getUUID();
+    /**
+     * {@inheritDoc}
+     */
+    public String getVersionLabelsUUID() {
+        return labelNode.getUUID();
+    /**
+     * Returns the persistent node of this version history
+     * @return
+     */
-        PersistentNode pNode = parent.addNode(name, NativePVM.NT_REP_VERSION_HISTORY);
-        pNode.setPropertyValue(NativePVM.PROPNAME_HISTORY_ID, InternalValue.create(historyId));
+        PersistentNode pNode = parent.addNode(name, NativePVM.NT_REP_VERSION_HISTORY, historyId);
-        pNode.addNode(NativePVM.NODENAME_VERSION_LABELS, NT_UNSTRUCTURED);
+        pNode.addNode(NativePVM.NODENAME_VERSION_LABELS, NT_UNSTRUCTURED, null);
-        QName nodeName = new QName(NS_DEFAULT_URI, versionId);
-        PersistentNode vNode = pNode.addNode(nodeName, NativePVM.NT_REP_VERSION);
-        vNode.setPropertyValue(NativePVM.PROPNAME_VERSION_ID, InternalValue.create(versionId));
-        vNode.setPropertyValue(NativePVM.PROPNAME_VERSION_NAME, InternalValue.create(JCR_ROOTVERSION));
+        PersistentNode vNode = pNode.addNode(JCR_ROOTVERSION, NativePVM.NT_REP_VERSION, versionId);
