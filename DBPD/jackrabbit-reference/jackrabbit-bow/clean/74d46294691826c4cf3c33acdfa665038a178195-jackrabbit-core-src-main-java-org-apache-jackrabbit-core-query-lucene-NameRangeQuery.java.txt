JCR-2836: Unclosed threads in Jackrabbit

Remove the use of ThreadLocal variables in PerQueryCache to avoid leaking memory in container environments.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1055117 13f79535-47bb-0310-9956-ffa450edef68

+    private final PerQueryCache cache;
+
-                          NamespaceMappings nsMappings) {
+                          NamespaceMappings nsMappings,
+                          PerQueryCache cache) {
+        this.cache = cache;
+        Query q;
-            RangeQuery localNames = new RangeQuery(getLowerLocalNameTerm(),
-                    getUpperLocalNameTerm(), inclusive);
+            RangeQuery localNames = new RangeQuery(
+                    getLowerLocalNameTerm(), getUpperLocalNameTerm(),
+                    inclusive, cache);
-            return query.rewrite(reader);
+            q = query;
-            return new RangeQuery(getLowerTerm(), getUpperTerm(), inclusive).rewrite(reader);
+            q = new RangeQuery(
+                    getLowerTerm(), getUpperTerm(), inclusive, cache);
+        return q.rewrite(reader);
