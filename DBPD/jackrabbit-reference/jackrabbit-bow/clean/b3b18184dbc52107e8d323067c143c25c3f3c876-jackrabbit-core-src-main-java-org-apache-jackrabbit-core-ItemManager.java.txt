JCR-2408: Mixin removal exception

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@896940 13f79535-47bb-0310-9956-ffa450edef68

+        // this is a bit ugly
+        // there might be cases where otherwise protected items turn into
+        // non-protected items because a mixin has been removed from the parent
+        // node state.
+        // see also: JCR-2408
+        if (state.getStatus() == ItemState.STATUS_EXISTING_REMOVED
+                && state.getName().equals(NameConstants.JCR_UUID)) {
+            NodeTypeRegistry ntReg = session.getNodeTypeManager().getNodeTypeRegistry();
+            QPropertyDefinition def = ntReg.getEffectiveNodeType(
+                    NameConstants.MIX_REFERENCEABLE).getApplicablePropertyDef(
+                    state.getName(), state.getType());
+            return session.getNodeTypeManager().getPropertyDefinition(def);
+        }
