JCR-3149 : AccessControlProvider#getEffectivePolicies for a set of principals does not include repo-level ac

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1203751 13f79535-47bb-0310-9956-ffa450edef68

+            Name aclName = aclNode.getQName();
-            
-            if (isAccessControlled(accessControlledNode)) {
+
+            if (N_POLICY.equals(aclName) && isAccessControlled(accessControlledNode)) {
-            }
+            } else if (N_REPO_POLICY.equals(aclName) && isRepoAccessControlled(accessControlledNode)) {
+                if (permissions.canRead(aclNode.getPrimaryPath(), aclNode.getNodeId())) {
+                    List<AccessControlEntry> aces = entryCollector.collectEntries(null, new EntryFilterImpl(null, (NodeId) null, session));
+                    acls.add(new UnmodifiableAccessControlList(aces));
+                } else {
+                    throw new AccessDeniedException("Access denied at " + Text.getRelativeParent(aclNode.getPath(), 1));
+                }
+            } // else: not a regular policy node -> ignore.
