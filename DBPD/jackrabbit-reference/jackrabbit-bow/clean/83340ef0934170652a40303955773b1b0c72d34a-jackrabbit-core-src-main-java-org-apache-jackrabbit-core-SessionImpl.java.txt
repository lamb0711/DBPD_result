JCR-798: Explicitly remove all registered event listeners at the beginning of logout() to avoid concurrent access either from the internal event delivery process or from external event listeners.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@529913 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.commons.collections.IteratorUtils;
+import javax.jcr.observation.EventListener;
+import javax.jcr.observation.EventListenerIterator;
+import javax.jcr.observation.ObservationManager;
+import java.util.Collection;
+     * Utility method that removes all registered event listeners.
+     */
+    private void removeRegisteredEventListeners() {
+        try {
+            ObservationManager manager = getWorkspace().getObservationManager();
+            // Use a copy to avoid modifying the set of registered listeners
+            // while iterating over it
+            Collection listeners =
+                IteratorUtils.toList(manager.getRegisteredEventListeners());
+            Iterator iterator = listeners.iterator();
+            while (iterator.hasNext()) {
+                EventListener listener = (EventListener) iterator.next();
+                try {
+                    manager.removeEventListener(listener);
+                } catch (RepositoryException e) {
+                    log.warn("Error removing event listener: " + listener, e);
+                }
+            }
+        } catch (RepositoryException e) {
+            log.warn("Error removing event listeners", e);
+        }
+    }
+
+    /**
+        // JCR-798: Remove all registered event listeners to avoid concurrent
+        // access to session internals by the event delivery or even listeners
+        removeRegisteredEventListeners();
+
