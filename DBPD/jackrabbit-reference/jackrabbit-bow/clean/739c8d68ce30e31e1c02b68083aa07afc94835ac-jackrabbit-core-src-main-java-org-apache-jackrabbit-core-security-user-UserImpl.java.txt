JCR-3405 : Improvements to user management implementation 

- password utility
- configurable password hashing: algorithm, number of iterations
- improve handling of plaintxt passwords starting with {algorithm}

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1370420 13f79535-47bb-0310-9956-ffa450edef68

-import javax.jcr.SimpleCredentials;
-    //--------------------------------------------------------------------------
-    /**
-     * Creates a hash of the specified password if it is found to be plain text.
-     * 
-     * @param password The password string.
-     * @return Hash for the given password string.
-     * @throws RepositoryException If an error occurs.
-     * @see CryptedSimpleCredentials#buildPasswordHash(String)
-     */
-    static String buildPasswordValue(String password) throws RepositoryException {
-        return CryptedSimpleCredentials.buildPasswordHash(password);
-    }
-
-        Value v = getSession().getValueFactory().createValue(buildPasswordValue(password));
-        userManager.setProtectedProperty(getNode(), P_PASSWORD, v);
+        userManager.setPassword(getNode(), password, true);
+        if (userManager.isAutoSave()) {
+            getNode().save();
+        }
-        try {
-            CryptedSimpleCredentials csc = (CryptedSimpleCredentials) getCredentials();
-            SimpleCredentials creds = new SimpleCredentials(getID(), oldPassword.toCharArray());
-            if (!csc.matches(creds)) {
-                throw new RepositoryException("Failed to change password: Old password does not match.");
-            }
-        } catch (NoSuchAlgorithmException e) {
-            throw new RepositoryException("Cannot change password: failed to validate old password.");
-        } catch (UnsupportedEncodingException e) {
-            throw new RepositoryException("Cannot change password: failed to validate old password.");
+        String pwHash = getNode().getProperty(P_PASSWORD).getString();
+        if (!PasswordUtility.isSame(pwHash, oldPassword)) {
+            throw new RepositoryException("Failed to change password: Old password does not match.");
-
