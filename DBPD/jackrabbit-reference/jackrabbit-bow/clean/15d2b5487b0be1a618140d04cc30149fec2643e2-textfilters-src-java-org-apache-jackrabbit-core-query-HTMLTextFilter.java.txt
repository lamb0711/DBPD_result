JCR-264: TextFilters get called three times within checkin()

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@392211 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.IOException;
+import java.io.InputStream;
-            try {
-                try {
-                    BLOBFileValue blob =
-                            (BLOBFileValue) values[0].internalValue();
+            final BLOBFileValue blob = (BLOBFileValue) values[0].internalValue();
+            LazyReader reader = new LazyReader() {
+                protected void initializeReader() throws IOException {
+                    InputStream in;
+                    try {
+                        in = blob.getStream();
+                    } catch (RepositoryException e) {
+                        throw new IOException(e.getMessage());
+                    }
+                    try {
+                        SAXSource source =
+                                new SAXSource(parser,
+                                        new InputSource(in));
+                        transformer.transform(source, result);
-                    SAXSource source =
-                            new SAXSource(parser,
-                                    new InputSource(blob.getStream()));
-                    transformer.transform(source, result);
+                        String text = parser.getContents();
-                    String text = parser.getContents();
-
-                    Map result = new HashMap();
-                    result.put(FieldNames.FULLTEXT, new StringReader(text));
-                    return result;
-                } catch (TransformerException te) {
-                    throw new RepositoryException(te);
+                        delegate = new StringReader(text);
+                    } catch (TransformerException e) {
+                        throw new IOException(e.getMessage());
+                    } finally {
+                        in.close();
+                    }
+            };
-            } catch (IllegalStateException e) {
-                throw new RepositoryException(e);
-            }
+            Map result = new HashMap();
+            result.put(FieldNames.FULLTEXT, reader);
+            return result;
