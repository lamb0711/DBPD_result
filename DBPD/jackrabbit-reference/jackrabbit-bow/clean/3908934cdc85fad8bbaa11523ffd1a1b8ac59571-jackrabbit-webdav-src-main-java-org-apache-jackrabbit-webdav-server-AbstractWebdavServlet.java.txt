JCR-4581: use GZIP encoding in XML responses when client signals support

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1878754 13f79535-47bb-0310-9956-ffa450edef68

-        response.sendMultiStatus(mstatus);
+        response.sendMultiStatus(mstatus,
+                acceptsGzipEncoding(request) ? Collections.singletonList("gzip") : Collections.emptyList());
-        response.sendXmlResponse(report, statusCode);
+        response.sendXmlResponse(report, statusCode, acceptsGzipEncoding(request) ? Collections.singletonList("gzip") : Collections.emptyList());
+        return getListElementsFromHeaderField(request, "Content-Encoding");
+    }
+
+    /**
+     * Check whether recipient accepts GZIP content coding
+     */
+    private static boolean acceptsGzipEncoding(HttpServletRequest request) {
+        List<String> result = getListElementsFromHeaderField(request, "Accept-Encoding");
+        for (String s : result) {
+            s = s.replace(" ", "");
+            int semi = s.indexOf(';');
+            if ("gzip".equals(s)) {
+                return true;
+            } else if (semi > 0) {
+                String enc = s.substring(0, semi);
+                String parm = s.substring(semi + 1);
+                if ("gzip".equals(enc) && parm.startsWith("q=")) {
+                    float q = Float.valueOf(parm.substring(2));
+                    return q > 0;
+                }
+            }
+        }
+        return false;
+    }
+
+    private static List<String> getListElementsFromHeaderField(HttpServletRequest request, String fieldName) {
-        Enumeration<String> ceh = request.getHeaders("Content-Encoding"); ceh.hasMoreElements();) {
+        Enumeration<String> ceh = request.getHeaders(fieldName); ceh.hasMoreElements();) {
