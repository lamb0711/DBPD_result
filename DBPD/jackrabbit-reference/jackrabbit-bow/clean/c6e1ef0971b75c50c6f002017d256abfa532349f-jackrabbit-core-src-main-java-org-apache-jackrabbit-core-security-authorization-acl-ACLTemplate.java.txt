JCR-2887 : Split PrivilegeRegistry in a per-session manager instance and a repository level registry [work in progress]

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1092723 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.security.authorization.Permission;
+import org.apache.jackrabbit.core.security.authorization.PrivilegeBits;
-import org.apache.jackrabbit.core.security.authorization.PrivilegeRegistry;
-            Set<Privilege> otherCustom = entry.getCustomPrivileges();
-                        int existingPrivs = e.getPrivilegeBits();
-                        Set<Privilege> existingCustom = e.getCustomPrivileges();
-                        if ((existingPrivs | ~entry.getPrivilegeBits()) == -1 &&
-                                existingCustom.containsAll(otherCustom)) {
+                        if (e.getPrivilegeBits().includes(entry.getPrivilegeBits())) {
-                        int mergedBits = e.getPrivilegeBits() | entry.getPrivilegeBits();
+                        PrivilegeBits mergedBits = PrivilegeBits.getInstance(e.getPrivilegeBits());
+                        mergedBits.add(entry.getPrivilegeBits());
+                        
-                        mergedPrivs.addAll(existingCustom);
-                        mergedPrivs.addAll(otherCustom);
-                int complPrivs = complementEntry.getPrivilegeBits();
-                int diff = Permission.diff(complPrivs, entry.getPrivilegeBits());
-
-                Set<Privilege> result = complementEntry.getCustomPrivileges();
-                boolean customMod = result.removeAll(otherCustom);
+                PrivilegeBits complPrivs = complementEntry.getPrivilegeBits();
+                PrivilegeBits diff = PrivilegeBits.getInstance(complPrivs);
+                diff.diff(entry.getPrivilegeBits());
-                if (diff == PrivilegeRegistry.NO_PRIVILEGE && result.isEmpty()) {
+                if (diff.isEmpty()) {
-                } else if (diff != complPrivs || customMod) {
+                } else if (!diff.equals(complPrivs)) {
-                    result.addAll(privilegeMgr.getPrivileges(diff));
+                    Set<Privilege> result = privilegeMgr.getPrivileges(diff);
