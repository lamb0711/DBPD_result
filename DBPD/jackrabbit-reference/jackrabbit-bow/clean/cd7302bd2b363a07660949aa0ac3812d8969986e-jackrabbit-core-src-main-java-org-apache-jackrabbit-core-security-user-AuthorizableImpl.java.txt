JCR-2713 -  UserManagement: Don't read cached memberships if session has pending (group) changes

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@984830 13f79535-47bb-0310-9956-ffa450edef68

-                    return new Value[] {prop.getValue()};
+                    return new Value[]{prop.getValue()};
+
-        if (includeIndirect) {
-            groupNodeIds = userManager.getMembershipCache().getMemberOf(node.getIdentifier());
+        MembershipCache cache = userManager.getMembershipCache();
+        String nid = node.getIdentifier();
+
+        if (node.getSession().hasPendingChanges()) {
+            // avoid retrieving outdated cache entries or filling the cache with
+            // invalid data due to group-membership changes pending on the
+            // current session.
+            // this is mainly for backwards compatibility reasons (no cache present)
+            // where transient changes (in non-autosave mode) were reflected to the
+            // editing session (see JCR-2713)
+            Session session = node.getSession();
+            groupNodeIds = (includeIndirect) ? cache.collectMembership(nid, session) : cache.collectDeclaredMembership(nid, session);
-            groupNodeIds = userManager.getMembershipCache().getDeclaredMemberOf(node.getIdentifier());
+            //  retrieve cached membership. there are no pending changes.
+            groupNodeIds = (includeIndirect) ? cache.getMemberOf(nid) : cache.getDeclaredMemberOf(nid);
-        } else  {
+        } else {
