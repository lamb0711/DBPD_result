JJCR-584: Improve handling of concurrent node modifications


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@470869 13f79535-47bb-0310-9956-ffa450edef68

-                        String msg = state.getId() + " has been modified externally";
-                        log.debug(msg);
-                        throw new StaleItemStateException(msg);
+                        boolean merged = false;
+                        if (state.isNode()) {
+                            NodeStateMerger.MergeContext context =
+                                    new NodeStateMerger.MergeContext() {
+                                        public boolean isAdded(ItemId id) {
+                                            try {
+                                                ItemState is = local.get(id);
+                                                return is != null
+                                                        && is.getStatus() == ItemState.STATUS_NEW;
+                                            } catch (NoSuchItemStateException e) {
+                                                return false;
+                                            }
+                                        }
+
+                                        public boolean isDeleted(ItemId id) {
+                                            return local.deleted(id);
+                                        }
+                                    };
+
+                            merged = NodeStateMerger.merge((NodeState) state, context);
+                        }
+                        if (!merged) {
+                            String msg = state.getId() + " has been modified externally";
+                            log.debug(msg);
+                            throw new StaleItemStateException(msg);
+                        }
+                        // merge succeeded, fall through
