JCR-128: Deleting binary property does not remove 'blob file' in filesystem
- Query handler did not close Reader in some cases (though introduction of LazyFileInputStream already solved jira issue).

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@210092 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.lucene.document.Field;
+import org.apache.log4j.Logger;
+import java.util.Enumeration;
+     * Logger instance for this class.
+     */
+    private static final Logger log = Logger.getLogger(VolatileIndex.class);
+
+    /**
-        pending.put(doc.get(FieldNames.UUID), doc);
+        Document old = (Document) pending.put(doc.get(FieldNames.UUID), doc);
+        if (old != null) {
+            disposeDocument(old);
+        }
-        if (pending.remove(idTerm.text()) != null) {
+        Document doc = (Document) pending.remove(idTerm.text());
+        if (doc != null) {
+            disposeDocument(doc);
+
+    /**
+     * Disposes the document <code>old</code>. Closes any potentially open
+     * readers held by the document.
+     *
+     * @param old the document to dispose.
+     */
+    private void disposeDocument(Document old) {
+        for (Enumeration e = old.fields(); e.hasMoreElements(); ) {
+            Field f = (Field) e.nextElement();
+            if (f.readerValue() != null) {
+                try {
+                    f.readerValue().close();
+                } catch (IOException ex) {
+                    log.warn("Exception while disposing index document: " + ex);
+                }
+            }
+        }
+    }
