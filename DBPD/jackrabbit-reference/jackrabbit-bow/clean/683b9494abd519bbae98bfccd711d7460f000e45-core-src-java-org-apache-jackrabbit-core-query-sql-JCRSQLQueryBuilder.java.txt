- Optimize query execution. document frequency for UUID and PARENT field can be served from cache.
- Reuse query parsers. Results in much lower memory consumption

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@220022 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Map;
+import java.util.WeakHashMap;
+import java.io.StringReader;
+     * Map of reusable JCRSQL parser instances indexed by NamespaceResolver.
+     */
+    private static Map parsers = new WeakHashMap();
+
+
+    /**
-            JCRSQLQueryBuilder builder = new JCRSQLQueryBuilder(JCRSQLParser.parse(statement, resolver), resolver);
+            // get parser
+            JCRSQLParser parser;
+            synchronized (parsers) {
+                parser = (JCRSQLParser) parsers.get(resolver);
+                if (parser == null) {
+                    parser = new JCRSQLParser(new StringReader(statement));
+                    parser.setNamespaceResolver(resolver);
+                    parsers.put(resolver, parser);
+                }
+            }
+
+            JCRSQLQueryBuilder builder;
+            // guard against concurrent use within same session
+            synchronized (parser) {
+                parser.ReInit(new StringReader(statement));
+                builder = new JCRSQLQueryBuilder(parser.Query(), resolver);
+            }
