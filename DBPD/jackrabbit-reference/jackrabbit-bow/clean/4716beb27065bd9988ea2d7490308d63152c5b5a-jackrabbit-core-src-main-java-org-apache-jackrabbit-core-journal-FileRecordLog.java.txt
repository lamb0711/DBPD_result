JCR-773 - Under heavy load, database journal may contain empty update records.


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@513340 13f79535-47bb-0310-9956-ffa450edef68

-     * Append a record backed by a file to this log. Returns the revision
-     * following this record.
+     * Append a record to this log. Returns the revision following this record.
-     * @param file record to add
+     * @param in record to add
+     * @param length record length
-    public long append(String journalId, String producerId, File file)
+    public long append(String journalId, String producerId, InputStream in, int length)
-            int recordLength = (int) file.length();
-            out.writeInt(recordLength);
-            append(file, out);
+            out.writeInt(length);
+
+            byte[] buffer = new byte[8192];
+            int len;
+
+            while ((len = in.read(buffer)) > 0) {
+                out.write(buffer, 0, len);
+            }
+            out.flush();
+
-                4 + file.length();
+                4 + length;
-     * Append a file to this log's output stream.
-     *
-     * @param file file to append
-     * @param out where to append to
-     */
-    private static void append(File file, DataOutputStream out) throws IOException {
-        byte[] buffer = new byte[8192];
-        int len;
-
-        InputStream in = new BufferedInputStream(new FileInputStream(file));
-        try {
-            while ((len = in.read(buffer)) > 0) {
-                out.write(buffer, 0, len);
-            }
-            out.flush();
-        } finally {
-            close(in);
-        }
-    }
-
-    /**
