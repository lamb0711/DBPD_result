JCR-2635 : Disable Users

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@984395 13f79535-47bb-0310-9956-ffa450edef68

-     * @param credentials Credentions to retrieve the principal for.
+     * @param credentials Credentials to retrieve the principal for.
-                principal = user.getPrincipal();
+                if (user.isDisabled()) {
+                    // log message and return null -> login module returns false.
+                    log.debug("User " + userId + " has been disabled.");
+                } else {
+                    principal = user.getPrincipal();
+                }
-
-        Authorizable authrz = userManager.getAuthorizable(principal);
-        if (authrz == null || authrz.isGroup()) {
+        if (user != null) {
+            Subject impersSubject = getImpersonatorSubject(credentials);
+            if (user.getImpersonation().allows(impersSubject)) {
+                return true;
+            } else {
+                throw new FailedLoginException("attempt to impersonate denied for " + principal.getName());
+            }
+        } else {
+            log.debug("Failed to retrieve user to impersonate for principal name " + principal.getName());
-        Subject impersSubject = getImpersonatorSubject(credentials);
-        User user = (User) authrz;
-        if (user.getImpersonation().allows(impersSubject)) {
-            return true;
-        } else {
-            throw new FailedLoginException("attempt to impersonate denied for " + principal.getName());
-        }
-}
+}
