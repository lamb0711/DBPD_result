JCR-2106 SystemSessions created for GarbageCollector are not logged out

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@779084 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.concurrent.atomic.AtomicBoolean;
+    private final SessionListener sessionListener;
+    
+    private final AtomicBoolean closed = new AtomicBoolean();
+     * @param session the session that created this object
+     * @param sessionList the sessions to access the workspaces
-    public GarbageCollector(final SessionImpl session, IterablePersistenceManager[] list, final Session[] sessionList) {
+    public GarbageCollector(SessionImpl session, IterablePersistenceManager[] list, Session[] sessionList) {
-        // log out each session as soon as the main session logs out
-        session.addListener(new SessionListener() {
+        // Auto-close if the main session logs out
+        this.sessionListener = new SessionListener() {
-                for (Session s: sessionList) {
-                    s.logout();
-                }
+                close();
-        });
+        };
+        session.addListener(sessionListener);
+    /**
+     * The repository was scanned. This method will stop the observation
+     * listener.
+     */
+    /**
+     * Delete all unused items in the data store.
+     * 
+     * @return the number of deleted items
+     */
+    /**
+     * Get the data store if one is used.
+     * 
+     * @return the data store, or null
+     */
+         * 
+         * This mechanism requires that all data stores update the last modified 
+         * date when calling addRecord and that record already exists.
+    
+    /**
+     * Cleanup resources used internally by this instance.
+     */
+    public void close() {
+        if (!closed.getAndSet(true)) {
+            for (Session s : sessionList) {
+                s.logout();
+            }
+        }
+    }
+
+    /**
+     * Auto-close in case the application didn't call it explicitly.
+     */
+    protected void finalize() throws Throwable {
+        close();
+        super.finalize();
+    }
