redesigned transaction support & PersistenceManager

orginal code contributed by dominique pfister, required a lot of tweaking to make it run & work; not thoroughly tested

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@126221 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.state.PersistentItemStateProvider;
+import org.apache.jackrabbit.core.state.ItemStateManager;
-                rep.getWorkspaceReferenceManager(wspName), rep, this);
-        itemStateMgr = createSessionItemStateManager(wsp.getPersistentStateManager());
+                rep, this);
+        itemStateMgr = createSessionItemStateManager(wsp.getItemStateManager());
-                rep.getWorkspaceReferenceManager(wspName), rep, this);
-        itemStateMgr = new SessionItemStateManager(rep.getRootNodeUUID(), wsp.getPersistentStateManager(), getNamespaceResolver());
+                rep, this);
+        itemStateMgr = createSessionItemStateManager(wsp.getItemStateManager());
-    protected SessionItemStateManager createSessionItemStateManager(PersistentItemStateProvider provider) {
-        return new SessionItemStateManager(rep.getRootNodeUUID(), provider, getNamespaceResolver());
+    protected SessionItemStateManager createSessionItemStateManager(ItemStateManager manager) {
+        return new SessionItemStateManager(rep.getRootNodeUUID(),
+                manager, getNamespaceResolver());
-    void dump(PrintStream ps) throws RepositoryException {
+    public void dump(PrintStream ps) throws RepositoryException {
-        getItemManager().dump(ps);
+        itemMgr.dump(ps);
+        ps.println();
+        itemStateMgr.dump(ps);
