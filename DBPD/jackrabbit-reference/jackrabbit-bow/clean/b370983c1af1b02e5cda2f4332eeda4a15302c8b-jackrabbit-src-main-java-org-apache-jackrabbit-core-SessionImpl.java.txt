JCR-458: session.move() throws ItemExistsException despite same name siblings

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@414263 13f79535-47bb-0310-9956-ffa450edef68

+        ItemImpl existing = null;
-            ItemImpl item = getItemManager().getItem(destPath);
-            if (!item.isNode()) {
+            existing = getItemManager().getItem(destPath);
+            if (!existing.isNode()) {
-                throw new ItemExistsException(item.safeGetJCRPath());
+                throw new ItemExistsException(existing.safeGetJCRPath());
-                // there's already a node with that name
-                // check same-name sibling setting of both new and existing node
-                if (!destParentNode.getDefinition().allowsSameNameSiblings()
-                        || !((NodeImpl) item).getDefinition().allowsSameNameSiblings()) {
-                    throw new ItemExistsException(item.safeGetJCRPath());
+                // there's already a node with that name:
+                // check same-name sibling setting of existing node
+                if (!((NodeImpl) existing).getDefinition().allowsSameNameSiblings()) {
+                    throw new ItemExistsException(existing.safeGetJCRPath());
-            // no name collision
+            // no name collision since same-name siblings are allowed
+        // if there's already a node with that name also check same-name sibling
+        // setting of new node; just checking same-name sibling setting on
+        // existing node is not sufficient since same-name sibling nodes don't
+        // necessarily have identical definitions
+        if (existing != null && !newTargetDef.allowsSameNameSiblings()) {
+            throw new ItemExistsException(existing.safeGetJCRPath());
+        }
+
