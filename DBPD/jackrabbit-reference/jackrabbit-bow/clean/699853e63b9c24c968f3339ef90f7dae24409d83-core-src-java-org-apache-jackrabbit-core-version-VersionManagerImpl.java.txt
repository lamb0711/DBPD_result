[#JCR-168] Observation events are not triggered for intermediate nodes in version storage

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@219511 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.LinkedList;
-        InternalVersionHistory history = createVersionHistory(node);
+        List created = new LinkedList();
+        InternalVersionHistory history = createVersionHistory(created, node);
-        NodeImpl parent = (NodeImpl) vh.getParent();
-        generateAddedEvents(events, parent, vh, true);
-        // in case the history was created 'deep' also add events for its ancestors
-        while (!parent.internalGetUUID().equals(historyRoot.getUUID())) {
-            NodeImpl child = parent;
-            parent = (NodeImpl) parent.getParent();
-            generateAddedEvents(events, parent, child, false);
+        Iterator iter = created.iterator();
+        while (iter.hasNext()) {
+            String uuid = (String) iter.next();
+            NodeImpl child = (NodeImpl) ((SessionImpl) session).getItemManager().getItem(new NodeId(uuid));
+            generateAddedEvents(events, (NodeImpl) child.getParent(), child, false);
-
+     * @param created a list for adding the uuids of the newly created nodes
-    private InternalVersionHistory createVersionHistory(NodeState node)
+    private InternalVersionHistory createVersionHistory(List created, NodeState node)
-                    root.addNode(name, REP_VERSIONSTORAGE, null, false);
+                    NodeStateEx n = root.addNode(name, REP_VERSIONSTORAGE, null, false);
+                    created.add(n.getUUID());
-            InternalVersionHistoryImpl hist = InternalVersionHistoryImpl.create(this, root, UUID.randomUUID().toString(), historyNodeName, node);
+            InternalVersionHistoryImpl hist = InternalVersionHistoryImpl.create(this, root, UUID.randomUUID().toString(), historyNodeName, node, created);
