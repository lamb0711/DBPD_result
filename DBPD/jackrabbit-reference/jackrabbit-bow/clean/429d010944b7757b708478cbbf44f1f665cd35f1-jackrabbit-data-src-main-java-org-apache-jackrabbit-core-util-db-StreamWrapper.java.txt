JCR-3811 detect marking of input stream to determine if stream can be reset to the beginning

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1625981 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.FilterInputStream;
-    private InputStream stream;
+    private MarkDetectingInputStream stream;
-        this.stream = in;
+        this.stream = new MarkDetectingInputStream(in);
-     * during reading so that resetting it moves the cursor to the beginning of the stream.
+     * during reading.
-            stream.reset();
-            return true;
+            if (!stream.isMarked()) {
+                stream.reset();
+                return true;
+            } else {
+                log.warn("Cannot reset stream to the beginning because it was marked.");
+                return false;
+            }
+
+    private static class MarkDetectingInputStream extends FilterInputStream {
+
+        private boolean marked;
+
+        protected MarkDetectingInputStream(final InputStream in) {
+            super(in);
+        }
+
+        @Override
+        public synchronized void mark(final int readlimit) {
+            super.mark(readlimit);
+            marked = true;
+        }
+
+        private boolean isMarked() {
+            return marked;
+        }
+    }
