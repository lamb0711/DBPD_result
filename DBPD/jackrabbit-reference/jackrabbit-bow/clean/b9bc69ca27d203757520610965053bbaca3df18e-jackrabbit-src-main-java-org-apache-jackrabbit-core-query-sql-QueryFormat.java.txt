JCR-638: Support lower-/upper-case functions

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@475677 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.query.PropertyFunctionQueryNode;
+            StringBuffer propName = new StringBuffer();
+            appendName(node.getProperty(), resolver, propName);
+            // surround name with property function
+            node.acceptOperands(this, propName);
+
+            sb.append(propName);
-                appendName(node.getProperty(), resolver, sb);
-                appendName(node.getProperty(), resolver, sb);
-                appendName(node.getProperty(), resolver, sb);
-                appendName(node.getProperty(), resolver, sb);
-                appendName(node.getProperty(), resolver, sb);
-                appendName(node.getProperty(), resolver, sb);
-                appendName(node.getProperty(), resolver, sb);
-                appendName(node.getProperty(), resolver, sb);
-                appendName(node.getProperty(), resolver, sb);
+    public Object visit(PropertyFunctionQueryNode node, Object data) {
+        StringBuffer sb = (StringBuffer) data;
+        String functionName = node.getFunctionName();
+        if (functionName.equals(PropertyFunctionQueryNode.LOWER_CASE)) {
+            sb.insert(0, "LOWER(").append(")");
+        } else if (functionName.equals(PropertyFunctionQueryNode.UPPER_CASE)) {
+            sb.insert(0, "UPPER(").append(")");
+        } else {
+            exceptions.add(new InvalidQueryException("Unsupported function: " + functionName));
+        }
+        return sb;
+    }
+
