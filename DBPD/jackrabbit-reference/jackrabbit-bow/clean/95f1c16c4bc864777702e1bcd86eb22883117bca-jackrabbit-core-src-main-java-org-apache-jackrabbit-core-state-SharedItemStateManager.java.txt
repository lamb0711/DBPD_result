JCR-2546: SISM blocks the item state cache when loading a new item

Synchronize the loading and caching of a new item state on the SISM instance instead of the cache instance. This allows cache reads to continue while a new item state is being loaded.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@919458 13f79535-47bb-0310-9956-ffa450edef68

-     * item state providers.
+     * item state providers. This method is synchronized to ensure that
+     * a cache entry is not created twice.
-    private ItemState getNonVirtualItemState(ItemId id)
+    private synchronized ItemState getNonVirtualItemState(ItemId id)
-
-        // check cache; synchronized to ensure an entry is not created twice.
-        synchronized (cache) {
-            ItemState state = cache.retrieve(id);
-            if (state == null) {
-                // not found in cache, load from persistent storage
-                state = loadItemState(id);
-                state.setStatus(ItemState.STATUS_EXISTING);
-                // put it in cache
-                cache.cache(state);
-                // set parent container
-                state.setContainer(this);
-            }
-            return state;
+        ItemState state = cache.retrieve(id);
+        if (state == null) {
+            // not found in cache, load from persistent storage
+            state = loadItemState(id);
+            state.setStatus(ItemState.STATUS_EXISTING);
+            // put it in cache
+            cache.cache(state);
+            // set parent container
+            state.setContainer(this);
+        return state;
