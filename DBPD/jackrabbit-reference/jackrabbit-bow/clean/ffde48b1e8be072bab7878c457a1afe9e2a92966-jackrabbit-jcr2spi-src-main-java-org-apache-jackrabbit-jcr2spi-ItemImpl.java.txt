JCR-1821: Item.isSame may return wrong result if any ancestor is invalidated

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@706273 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.jcr2spi.hierarchy.HierarchyEntry;
+        if (isNode() != otherItem.isNode()) {
+            return false;
+        }
+            // check status of the other item.
+            other.checkStatus();
+
+                    // if any ancestor is _invalidated_ force it's reload in
+                    // order to detect id changes.
+                    updateId(state);
+                    updateId(other.state);
-                  */
+                */
+
+    /**
+     *
+     * @param state
+     * @throws RepositoryException
+     */
+    private static void updateId(ItemState state) throws RepositoryException {
+        HierarchyEntry he = state.getHierarchyEntry();
+        while (he.getStatus() != Status.INVALIDATED) {
+            he = he.getParent();
+            if (he == null) {
+                // root reached without intermediate invalidated entry
+                return;
+            }
+        }
+        // he is INVALIDATED -> force reloading in order to be aware of id changes
+        he.getItemState();
+    }
