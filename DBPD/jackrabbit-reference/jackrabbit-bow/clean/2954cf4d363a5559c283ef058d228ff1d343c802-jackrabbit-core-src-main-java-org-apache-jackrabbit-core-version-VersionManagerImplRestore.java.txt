JCR-2930: same named child nodes disappear on restore

fix restore logic to take SNS into account

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1213707 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.ArrayList;
-import java.util.HashSet;
-import java.util.LinkedList;
-import java.util.List;
-import java.util.Set;
+import java.util.*;
+        // create a map that contains a int->NodeStateEx mapping for each child name
+        Map<Name, Map<Integer, NodeStateEx>> entryToNodeStateExMapping = new HashMap<Name, Map<Integer, NodeStateEx>>();
+        for (ChildNodeEntry entry : state.getState().getChildNodeEntries()) {
+            Map<Integer, NodeStateEx> id2stateMap = entryToNodeStateExMapping
+                    .get(entry.getName());
+            if (id2stateMap == null) {
+                id2stateMap = new HashMap<Integer, NodeStateEx>();
+            }
+            id2stateMap.put(entry.getIndex(),
+                    state.getNode(entry.getName(), entry.getIndex()));
+            entryToNodeStateExMapping.put(entry.getName(), id2stateMap);
+        }
+
-                state.removeNode(entry.getName(), entry.getIndex());
+                Map<Integer, NodeStateEx> id2stateMap = entryToNodeStateExMapping
+                        .get(entry.getName());
+                if (id2stateMap != null
+                        && id2stateMap.containsKey(entry.getIndex())) {
+                    state.removeNode(id2stateMap.get(entry.getIndex()));
+                }
