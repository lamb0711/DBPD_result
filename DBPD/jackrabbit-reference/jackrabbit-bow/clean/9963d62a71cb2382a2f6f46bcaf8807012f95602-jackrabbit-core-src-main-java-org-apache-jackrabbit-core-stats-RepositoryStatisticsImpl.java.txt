JCR-3117: Stats for the PersistenceManager

Add also average duration statistics for session and bundle read and write operations.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1188678 13f79535-47bb-0310-9956-ffa450edef68

+    private final Map<Type, TimeSeriesAverage> avg =
+            new HashMap<Type, TimeSeriesAverage>();
+
-        getOrCreateRecorder(Type.SESSION_READ_COUNTER);
-        getOrCreateRecorder(Type.SESSION_READ_DURATION);
-        getOrCreateRecorder(Type.SESSION_WRITE_COUNTER);
-        getOrCreateRecorder(Type.SESSION_WRITE_DURATION);
-        getOrCreateRecorder(Type.BUNDLE_READ_COUNTER);
-        getOrCreateRecorder(Type.BUNDLE_READ_DURATION);
-        getOrCreateRecorder(Type.BUNDLE_WRITE_COUNTER);
-        getOrCreateRecorder(Type.BUNDLE_WRITE_DURATION);
+
+        TimeSeries src = getOrCreateRecorder(Type.SESSION_READ_COUNTER);
+        TimeSeries srd = getOrCreateRecorder(Type.SESSION_READ_DURATION);
+        avg.put(Type.SESSION_READ_AVERAGE, new TimeSeriesAverage(srd, src));
+
+        TimeSeries swc = getOrCreateRecorder(Type.SESSION_WRITE_COUNTER);
+        TimeSeries swd = getOrCreateRecorder(Type.SESSION_WRITE_DURATION);
+        avg.put(Type.SESSION_WRITE_AVERAGE, new TimeSeriesAverage(swd, swc));
+
+        TimeSeries brc = getOrCreateRecorder(Type.BUNDLE_READ_COUNTER);
+        TimeSeries brd = getOrCreateRecorder(Type.BUNDLE_READ_DURATION);
+        avg.put(Type.BUNDLE_READ_AVERAGE, new TimeSeriesAverage(brd, brc));
+
+        TimeSeries bwc = getOrCreateRecorder(Type.BUNDLE_WRITE_COUNTER);
+        TimeSeries bwd = getOrCreateRecorder(Type.BUNDLE_WRITE_DURATION);
+        avg.put(Type.BUNDLE_WRITE_AVERAGE, new TimeSeriesAverage(bwd, bwc));
+        map.putAll(avg);
-        return getOrCreateRecorder(type);
+        if (avg.containsKey(type)) {
+            return avg.get(type);
+        } else {
+            return getOrCreateRecorder(type);
+        }
