JCR-314: Fine grained locking in SharedItemStateManager

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@605173 13f79535-47bb-0310-9956-ffa450edef68

+    /** Name of the ism locking configuration element. */
+    public static final String ISM_LOCKING_ELEMENT = "ISMLocking";
+
+     *     &lt;ISMLocking ...&gt;
+     * The ism locking configuration element is optional. If it is not given,
+     * then a default implementation is used.
+     * <p>
-        return new WorkspaceConfig(home, name, clustered, fsc, pmc, sc);
+        // Item state manager locking configuration (optional)
+        ISMLockingConfig ismLockingConfig = tmpParser.parseISMLockingConfig(root);
+
+        return new WorkspaceConfig(home, name, clustered, fsc, pmc, sc, ismLockingConfig);
+     * Parses ism locking configuration. ism locking configuration  uses the
+     * following format:
+     * <pre>
+     *   &lt;ISMLocking class="..."&gt;
+     *     &lt;param name="..." value="..."&gt;
+     *     ...
+     *   &lt;/ISMLocking&gt;
+     * </pre>
+     * <p/>
+     * The <code>ISMLocking</code> is a
+     * {@link #parseBeanConfig(Element,String) bean configuration} element.
+     * <p/>
+     * The ism locking is an optional part of the  workspace configuration. If
+     * the ism locking element is not found, then this method returns
+     * <code>null</code>.
+     *
+     * @param parent parent of the <code>ISMLocking</code> element
+     * @return search configuration, or <code>null</code>
+     * @throws ConfigurationException if the configuration is broken
+     */
+    protected ISMLockingConfig parseISMLockingConfig(Element parent)
+            throws ConfigurationException {
+        NodeList children = parent.getChildNodes();
+        for (int i = 0; i < children.getLength(); i++) {
+            Node child = children.item(i);
+            if (child.getNodeType() == Node.ELEMENT_NODE
+                    && ISM_LOCKING_ELEMENT.equals(child.getNodeName())) {
+                Element element = (Element) child;
+
+                // ism locking implementation class
+                String className = getAttribute(element, CLASS_ATTRIBUTE);
+
+                // ism locking parameters
+                Properties parameters = parseParameters(element);
+
+                return new ISMLockingConfig(className, parameters);
+            }
+        }
+        return null;
+    }
+
+    /**
-        return new VersioningConfig(home, fsc, pmc);
+        // Item state manager locking configuration (optional)
+        ISMLockingConfig ismLockingConfig = parseISMLockingConfig(element);
+
+        return new VersioningConfig(home, fsc, pmc, ismLockingConfig);
