JCR-1109 - Resource association not compliant to JTA spec


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@572595 13f79535-47bb-0310-9956-ffa450edef68

-        TransactionContext tx;
+        TransactionContext tx = (TransactionContext) txGlobal.get(xid);
-            tx = (TransactionContext) txGlobal.get(xid);
-            tx = (TransactionContext) txGlobal.get(xid);
-            tx = (TransactionContext) txGlobal.get(xid);
+            if (!tx.isSuspended()) {
+                log.error("Unable to resume: transaction not suspended.");
+                throw new XAException(XAException.XAER_PROTO);
+            }
+            tx.setSuspended(false);
+     * <p/>
+     * It is legal for a transaction association to be suspended and then
+     * ended (either with <code>TMSUCCESS</code> or <code>TMFAIL</code>)
+     * without having been resumed again.
-        if (!isAssociated()) {
-            log.error("Resource not associated with a transaction.");
-            throw new XAException(XAException.XAER_PROTO);
-        }
-        if (flags == TMSUCCESS || flags == TMFAIL || flags == TMSUSPEND) {
+        if (flags == TMSUSPEND) {
+            if (!isAssociated()) {
+                log.error("Resource not associated with a transaction.");
+                throw new XAException(XAException.XAER_PROTO);
+            }
+            tx.setSuspended(true);
+        } else if (flags == TMFAIL || flags == TMSUCCESS) {
+            if (!tx.isSuspended()) {
+                if (!isAssociated()) {
+                    log.error("Resource not associated with a transaction.");
+                    throw new XAException(XAException.XAER_PROTO);
+                }
+                associate(null);
+            } else {
+                tx.setSuspended(false);
+            }
