JCR-3152 : AccessControlImporter does not import repo level ac content

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1205038 13f79535-47bb-0310-9956-ffa450edef68

-            acl = getACL(protectedParent.getParent().getPath());
+            String parentPath = protectedParent.getParent().getPath();
+            acl = getACL(parentPath);
-                log.warn("AccessControlImporter cannot be started: no ACL for {}.", protectedParent.getParent().getPath());
+                log.warn("AccessControlImporter cannot be started: no ACL for {}.", parentPath);
+                return false;
+            }
+            status = STATUS_ACL;
+        } else if (isRepoPolicyNode(protectedParent)) {
+            acl = getACL(null);
+            if (acl == null) {
+                log.warn("AccessControlImporter cannot be started: no Repo ACL.");
-                // don't know if this check is needed
-                if (path.equals(acl.getPath())) {
-                    break;
-                }
-                acl = null;
+                break;
-        return (AccessControlConstants.N_POLICY.equals(nodeName) || AccessControlConstants.N_REPO_POLICY.equals(nodeName))
-                && node.isNodeType(AccessControlConstants.NT_REP_ACL);
+        return AccessControlConstants.N_POLICY.equals(nodeName) && node.isNodeType(AccessControlConstants.NT_REP_ACL);
+    }
+
+    /**
+     * @param node The node to be tested.
+     * @return <code>true</code> if the specified node is the 'rep:repoPolicy'
+     * acl node underneath the root node; <code>false</code> otherwise.
+     * @throws RepositoryException If an error occurs.
+     */
+    private static boolean isRepoPolicyNode(NodeImpl node) throws RepositoryException {
+        Name nodeName = node.getQName();
+        return AccessControlConstants.N_REPO_POLICY.equals(nodeName) &&
+                node.isNodeType(AccessControlConstants.NT_REP_ACL) &&
+                node.getDepth() == 1;
