JCR-2919 : Security of token base authentication (fix updating/removing token node)

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1159558 13f79535-47bb-0310-9956-ffa450edef68

-import javax.jcr.AccessDeniedException;
-                tokenNode = getTokenNode();
-                s = tokenNode.getSession();
+                s = ((SessionImpl) session).createSession(session.getWorkspace().getName());
+                tokenNode = getTokenNode(token, s);
-            }
-
-            if (s != null) {
-            Node tokenNode = getTokenNode();
-            s = tokenNode.getSession();
+            s = ((SessionImpl) session).createSession(session.getWorkspace().getName());
+            Node tokenNode = getTokenNode(token, s);
-    /**
-     * Retrieve the token node using another session to avoid concurrent write
-     * operations with the shared system session.
-     *
-     * @return the token node
-     * @throws RepositoryException
-     * @throws AccessDeniedException
-     */
-    private Node getTokenNode() throws RepositoryException, AccessDeniedException {
-        Session s = ((SessionImpl) session).createSession(session.getWorkspace().getName());
-        return s.getNodeByIdentifier(token);
-    }
-
-                                                long tokenExpiration, Session session) throws RepositoryException {
+                                                       long tokenExpiration, Session session) throws RepositoryException {
