JCR-264: TextFilters get called three times within checkin()

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@392211 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.InputStream;
-			BLOBFileValue blob = (BLOBFileValue) values[0].internalValue();
+			final BLOBFileValue blob = (BLOBFileValue) values[0].internalValue();
-			try {
-				ByteArrayOutputStream baos = new ByteArrayOutputStream();
-				MsPowerPointListener listener = new MsPowerPointListener(baos);
-				POIFSReader reader = new POIFSReader();
-				reader.registerListener(listener);
-				reader.read(blob.getStream());
-				Map result = new HashMap();
-				result.put(FieldNames.FULLTEXT, new InputStreamReader(
-						new ByteArrayInputStream(baos.toByteArray())));
-				
-				return result;
-			} catch (IOException ex) {
-				throw new RepositoryException(ex);
-			}
+            LazyReader reader = new LazyReader() {
+                protected void initializeReader() throws IOException {
+                    InputStream in;
+                    try {
+                        in = blob.getStream();
+                    } catch (RepositoryException e) {
+                        throw new IOException(e.getMessage());
+                    }
+                    try {
+                        ByteArrayOutputStream baos = new ByteArrayOutputStream();
+                        MsPowerPointListener listener = new MsPowerPointListener(baos);
+                        POIFSReader reader = new POIFSReader();
+                        reader.registerListener(listener);
+                        reader.read(in);
+
+                        delegate = new InputStreamReader(
+                            new ByteArrayInputStream(baos.toByteArray()));
+                    } finally {
+                        in.close();
+                    }
+                }
+            };
+
+            Map result = new HashMap();
+            result.put(FieldNames.FULLTEXT, reader);
+
+            return result;
