JCR-894: rep:excerpt() not working for attribute searches

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@535223 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Set;
+import java.util.HashSet;
+import java.util.Iterator;
-        return DefaultHighlighter.highlight(tpv, query, FieldNames.FULLTEXT,
-                text, "<highlight>", "</highlight>", maxFragments, maxFragmentSize / 2);
+
+        Set extractedTerms = new HashSet();
+        Set relevantTerms = new HashSet();
+        query.extractTerms(extractedTerms);
+        // only keep terms for fulltext fields
+        for (Iterator it = extractedTerms.iterator(); it.hasNext(); ) {
+            Term t = (Term) it.next();
+            if (t.field().equals(FieldNames.FULLTEXT)) {
+                relevantTerms.add(t);
+            } else {
+                int idx = t.field().indexOf(FieldNames.FULLTEXT_PREFIX);
+                if (idx != -1) {
+                    relevantTerms.add(new Term(FieldNames.FULLTEXT, t.text()));
+                }
+            }
+        }
+
+        return DefaultHighlighter.highlight(tpv, relevantTerms, text,
+                "<highlight>", "</highlight>", maxFragments, maxFragmentSize / 2);
