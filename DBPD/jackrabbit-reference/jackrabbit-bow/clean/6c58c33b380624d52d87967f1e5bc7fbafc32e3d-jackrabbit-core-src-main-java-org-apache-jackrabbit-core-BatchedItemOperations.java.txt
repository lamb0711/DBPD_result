JCR-1104 - JSR 283 support
- shareble nodes (work in progress)
- improve share-cycle detection

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@646336 13f79535-47bb-0310-9956-ffa450edef68

-        if (destParentId.equals(srcId) ||
-                hierMgr.isAncestor(srcId, destParentId)) {
-            String msg = "This would create a share cycle.";
+        if (destParentId.equals(srcId) || hierMgr.isAncestor(srcId, destParentId)) {
+            String msg = "Share cycle detected.";
+        HierarchyManagerImpl hierMgr = (HierarchyManagerImpl) this.hierMgr;
+        if (hierMgr.isShareAncestor(target.getNodeId(), destParent.getNodeId())) {
+            String msg = safeGetJCRPath(destPath)
+                    + ": invalid destination path (share cycle detected)";
+            log.debug(msg);
+            throw new RepositoryException(msg);
+        }
+
