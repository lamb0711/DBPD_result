JCR-453: add/remove dispatchers from DelegatingObservationDispatcher is not synchronized


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@412344 13f79535-47bb-0310-9956-ffa450edef68

+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
-import java.util.Iterator;
+     * Logger instance.
+     */
+    private static Logger log = LoggerFactory.getLogger(DelegatingObservationDispatcher.class);
+
+    /**
-        dispatchers.add(disp);
+        synchronized (dispatchers) {
+            dispatchers.add(disp);
+        }
-        dispatchers.remove(disp);
+        synchronized (dispatchers) {
+            dispatchers.remove(disp);
+        }
-        Iterator iter = dispatchers.iterator();
-        while (iter.hasNext()) {
-            ObservationManagerFactory fac = (ObservationManagerFactory) iter.next();
-            EventStateCollection events = new EventStateCollection(fac, session, pathPrefix);
-            events.addAll(eventList);
-            events.prepare();
-            events.dispatch();
+        ObservationManagerFactory[] disp;
+        synchronized (dispatchers) {
+            disp = (ObservationManagerFactory[]) dispatchers.toArray(
+                    new ObservationManagerFactory[dispatchers.size()]);
+        }
+        for (int i=0; i< disp.length; i++) {
+            EventStateCollection events =
+                    new EventStateCollection(disp[i], session, pathPrefix);
+            try {
+                events.addAll(eventList);
+                events.prepare();
+                events.dispatch();
+            } catch (Exception e) {
+                log.error("Error while dispatching events.", e);
+            }
