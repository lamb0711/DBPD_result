JCR-3009: Prefix fulltext queries with Japanese or Chinese characters fail to match

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1141717 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.IOException;
+import java.io.StringReader;
+import javax.xml.stream.events.EndDocument;
+
+import org.apache.lucene.analysis.Token;
+import org.apache.lucene.analysis.TokenStream;
+import org.apache.lucene.analysis.Tokenizer;
+import org.apache.lucene.analysis.standard.StandardTokenizer;
+import org.apache.lucene.analysis.tokenattributes.TypeAttribute;
-        return getWildcardQuery(field, termStr + "*");
+        // only create a prefix query when the term is a single word / token
+        Analyzer a = getAnalyzer();
+        TokenStream ts = a.tokenStream(field, new StringReader(termStr));
+        int count = 0;
+        boolean isCJ = false;
+        try {
+            TypeAttribute t = ts.addAttribute(TypeAttribute.class);
+            ts.reset();
+            while (ts.incrementToken()) {
+                count++;
+                isCJ = StandardTokenizer.TOKEN_TYPES[StandardTokenizer.CJ].equals(t.type());
+            }
+            ts.end();
+        } catch (IOException e) {
+            throw new ParseException(e.getMessage());
+        } finally {
+            try {
+                ts.close();
+            } catch (IOException e) {
+                // ignore
+            }
+        }
+        if (count > 1 && isCJ) {
+            return getFieldQuery(field, termStr);
+        } else {
+            return getWildcardQuery(field, termStr + "*");
+        }
