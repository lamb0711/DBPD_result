JCR-4586: jackrabbit-webdav: must ignore if-modified-since with broken date (multiple field lines)

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1879031 13f79535-47bb-0310-9956-ffa450edef68

-            modSince = request.getDateHeader("If-Modified-Since");
+            // will throw if multiple field lines present
+            String value = getSingletonField(request, "If-Modified-Since");
+            if (value != null) {
+                modSince = request.getDateHeader("If-Modified-Since");
+            }
-            log.trace("illegal value for if-modified-since ignored: " + request.getHeader("If-Modified-Since"));
+            log.debug("illegal value for if-modified-since ignored: " + ex.getMessage());
+
+    /**
+     * Get field value of a singleton field
+     * @param request HTTP request
+     * @param fieldName field name
+     * @return the field value (when there is indeed a single field line) or {@code null} when field not present
+     * @throws IllegalArgumentException when multiple field lines present
+     */
+    private static String getSingletonField(HttpServletRequest request, String fieldName) {
+        @SuppressWarnings("unchecked")
+        Enumeration<String> lines = request.getHeaders(fieldName);
+        if (!lines.hasMoreElements()) {
+            return null;
+        } else {
+            String value = lines.nextElement();
+            if (!lines.hasMoreElements()) {
+                return value;
+            } else {
+                List<String> v = new ArrayList<>();
+                v.add(value);
+                while (lines.hasMoreElements()) {
+                    v.add(lines.nextElement());
+                }
+                throw new IllegalArgumentException("Multiple field lines for '" + fieldName + "' header field: " + v);
+            }
+        }
+    }
+
