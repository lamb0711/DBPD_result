JCR-1104 - JSR 283 support
- shareble nodes (work in progress)
- fix test failure introduced in r646336

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@647072 13f79535-47bb-0310-9956-ffa450edef68

+     * @param useOverlayed whether to use overlayed state for shareable nodes
-    protected Set getParentIds(ItemState state) {
+    protected Set getParentIds(ItemState state, boolean useOverlayed) {
+            if (ns.isShareable() && useOverlayed && ns.hasOverlayedState()) {
+                ns = (NodeState) ns.getOverlayedState();
+            }
-            Set parentIds = getParentIds(state);
+            Set parentIds = getParentIds(state, false);
-                    grandparentIds.addAll(getParentIds(getItemState(parentId)));
+                    grandparentIds.addAll(getParentIds(getItemState(parentId), false));
-            if (state.hasOverlayedState()) {
-                state = state.getOverlayedState();
-            }
-            Set parentIds = getParentIds(state);
+            Set parentIds = getParentIds(state, true);
-                    if (state.hasOverlayedState()) {
-                        state = state.getOverlayedState();
-                    }
-                    grandparentIds.addAll(getParentIds(state));
+                    grandparentIds.addAll(getParentIds(state, true));
