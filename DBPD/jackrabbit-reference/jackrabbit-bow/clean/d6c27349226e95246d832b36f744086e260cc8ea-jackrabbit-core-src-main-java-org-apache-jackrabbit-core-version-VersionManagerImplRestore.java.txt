JCR-2270 Restoring a deleted version does not work (throws Exception)


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@806531 13f79535-47bb-0310-9956-ffa450edef68

-            // create new node below parent
-            NodeStateEx state = parent.addNode(name, fn.getFrozenPrimaryType(), fn.getFrozenId());
-            state.setMixins(fn.getFrozenMixinTypes());
-            restore(state, v, removeExisting);
+            WriteOperation ops = startWriteOperation();
+            try {
+                // create new node below parent
+                NodeStateEx state = parent.addNode(name, fn.getFrozenPrimaryType(), fn.getFrozenId());
+                state.setMixins(fn.getFrozenMixinTypes());
+                internalRestore(state, v, new DateVersionSelector(v.getCreated()), removeExisting);
+                parent.store();
+                ops.save();
+            } catch (ItemStateException e) {
+                throw new RepositoryException(e);
+            } finally {
+                ops.close();
+            }
