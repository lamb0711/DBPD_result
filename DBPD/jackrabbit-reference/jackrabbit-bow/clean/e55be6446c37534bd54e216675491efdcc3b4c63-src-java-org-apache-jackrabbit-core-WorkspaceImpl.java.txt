re-implementing Workspace methods clone, copy, importXML [work in progress...]



git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@158489 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.util.ReferenceChangeTracker;
+     * @param refTracker   tracks uuid mappings and processed reference properties
-                                    int flag)
+                                    int flag,
+                                    ReferenceChangeTracker refTracker)
-                    /**
-                     * todo FIXME check mix:referenceable
-                     * make sure that copied reference properties are
-                     * refering to new uuid
-                     */
+                    // always create new uuid
+                    if (referenceable) {
+                        // remember uuid mapping
+                        refTracker.mappedUUID(srcState.getUUID(), uuid);
+                    }
+                    // use same uuid as source node
+                    // use same uuid as source node
-                        srcStateMgr, srcAccessMgr, flag);
+                        srcStateMgr, srcAccessMgr, flag, refTracker);
+                if (newChildState.getType() == PropertyType.REFERENCE) {
+                    refTracker.processedReference(newChildState);
+                }
+            ReferenceChangeTracker refTracker = new ReferenceChangeTracker();
+
-                    srcWsp.getItemStateManager(), srcAccessMgr, flag);
+                    srcWsp.getItemStateManager(), srcAccessMgr, flag, refTracker);
+            // adjust references that refer to uuid's which have been mapped to
+            // newly generated uuid's on copy/clone
+            Iterator iter = refTracker.getProcessedReferences();
+            while (iter.hasNext()) {
+                PropertyState prop = (PropertyState) iter.next();
+                // being paranoid...
+                if (prop.getType() != PropertyType.REFERENCE) {
+                    continue;
+                }
+                boolean modified = false;
+                InternalValue[] values = prop.getValues();
+                InternalValue[] newVals = new InternalValue[values.length];
+                for (int i = 0; i < values.length; i++) {
+                    InternalValue val = values[i];
+                    String original = ((UUID) val.internalValue()).toString();
+                    String adjusted = refTracker.getMappedUUID(original);
+                    if (adjusted != null) {
+                        newVals[i] = InternalValue.create(UUID.fromString(adjusted));
+                        modified = true;
+                    } else {
+                        // reference doesn't need adjusting, just copy old value
+                        newVals[i] = val;
+                    }
+                }
+                if (modified) {
+                    prop.setValues(newVals);
+                    stateMgr.store(prop);
+                }
+            }
+            refTracker.clear();
+
-        // @todo re-implement Workspace#clone (respect new removeExisting flag, etc)
-
