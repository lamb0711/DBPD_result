Patch for JCR-1467. Now, the mixin ocm:discriminator and ocm namespace are not mandatory for running the OCM framework.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@636881 13f79535-47bb-0310-9956-ffa450edef68

+import javax.jcr.ValueFormatException;
+import javax.jcr.lock.LockException;
+import javax.jcr.nodetype.ConstraintViolationException;
+import javax.jcr.version.VersionException;
-				mixinTypeName = ManagerConstant.DISCRIMINATOR_NODE_TYPE;
-				objectNode.addMixin(mixinTypeName);
-				objectNode.setProperty(ManagerConstant.DISCRIMINATOR_PROPERTY_NAME, ReflectionUtils.getBeanClass(object)
-						.getName());
+				addDiscriminatorProperty(object, objectNode);
+	private void addDiscriminatorProperty(Object object, Node objectNode)
+			throws NoSuchNodeTypeException, VersionException,
+			ConstraintViolationException, LockException, RepositoryException,
+			ValueFormatException {
+		
+		try {
+			objectNode.setProperty(ManagerConstant.DISCRIMINATOR_CLASS_NAME_PROPERTY,
+					ReflectionUtils.getBeanClass(object).getName());
+			
+		} catch (Exception e) {
+			// if it is not possible to add the CLASS_NAME_PROPERTY due to strong constraints in the 
+			// node type definition, try to add the Discriminator node type.
+			String mixinTypeName;
+			mixinTypeName = ManagerConstant.DISCRIMINATOR_NODE_TYPE;
+			objectNode.addMixin(mixinTypeName);
+			objectNode.setProperty(ManagerConstant.DISCRIMINATOR_CLASS_NAME_PROPERTY,
+					ReflectionUtils.getBeanClass(object).getName());
+		}
+		
+	}
+
-			if (node.hasProperty(ManagerConstant.DISCRIMINATOR_PROPERTY_NAME)) {
-				String className = node.getProperty(ManagerConstant.DISCRIMINATOR_PROPERTY_NAME).getValue().getString();
+			if (node.hasProperty(ManagerConstant.DISCRIMINATOR_CLASS_NAME_PROPERTY)) {
+				String className = node.getProperty(ManagerConstant.DISCRIMINATOR_CLASS_NAME_PROPERTY).getValue().getString();
-				if (node.hasProperty(ManagerConstant.DISCRIMINATOR_PROPERTY_NAME)) {
-	                String className = node.getProperty(ManagerConstant.DISCRIMINATOR_PROPERTY_NAME).getValue().getString();
+				if (node.hasProperty(ManagerConstant.DISCRIMINATOR_CLASS_NAME_PROPERTY)) {
+	                String className = node.getProperty(ManagerConstant.DISCRIMINATOR_CLASS_NAME_PROPERTY).getValue().getString();
