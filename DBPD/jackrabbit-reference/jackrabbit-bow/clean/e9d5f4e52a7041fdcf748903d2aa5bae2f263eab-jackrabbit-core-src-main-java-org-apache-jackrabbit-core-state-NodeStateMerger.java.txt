JCR-3290: Mix data inconsistency by correctly merging transient state with persistent overlayed state

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1324713 13f79535-47bb-0310-9956-ffa450edef68

+     * See also http://issues.apache.org/jira/browse/JCR-3290.
-                        // locally added?
-                        if (context.isAdded(cne.getId()) || context.isModified(cne.getId())) {
+                        // locally added or moved?
+                        if (context.isAdded(cne.getId()) || (context.isModified(cne.getId()) && isParent(state, cne, context))) {
+    private static boolean isParent(NodeState state, ChildNodeEntry entry, MergeContext context) {
+        try {
+            return state.getId().equals(context.getNodeState(entry.getId()).getParentId());
+        } catch (ItemStateException e) {
+            return false;
+        }
+    }
+
+        NodeState getNodeState(NodeId id) throws ItemStateException;
