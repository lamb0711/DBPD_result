JCR-2076: JSR 283: QOM and SQL2
- jcr2spi implementation

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@786565 13f79535-47bb-0310-9956-ffa450edef68

-    private final Map<String, QValue> boundValues = new HashMap();
+    private final Map<String, QValue> boundValues = new HashMap<String, QValue>();
-     * @param session          the session that created this query.
+     * @param session     the session that created this query.
-     * @param itemMgr          the item manager of that session.
-     * @param wspManager       the workspace manager that belongs to the
-     *                         session.
-     * @param statement        the query statement.
-     * @param language         the language of the query statement.
+     * @param itemMgr     the item manager of that session.
+     * @param wspManager  the workspace manager that belongs to the session.
+     * @param statement   the query statement.
+     * @param language    the language of the query statement.
+     * @param node        the node from where the query was read or
+     *                    <code>null</code> if this query is not a stored
+     *                    query.
-    public QueryImpl(Session session, ManagerProvider mgrProvider,
-                     ItemManager itemMgr, WorkspaceManager wspManager,
-                     String statement, String language)
+    public QueryImpl(Session session,
+                     ManagerProvider mgrProvider,
+                     ItemManager itemMgr,
+                     WorkspaceManager wspManager,
+                     String statement,
+                     String language,
+                     Node node)
-        this.wspManager.checkQueryStatement(
-                statement, language, getNamespaceMappings());
-    }
-
-    /**
-     * Creates a query from a node.
-     *
-     * @param session    the session that created this query.
-     * @param mgrProvider the manager provider.
-     * @param itemMgr    the item manager of that session.
-     * @param wspManager the workspace manager that belongs to the session.
-     * @param node       the node from where to read the query.
-     * @throws InvalidQueryException if the query is invalid.
-     * @throws RepositoryException   if another error occurs while reading from
-     *                               the node.
-     */
-    public QueryImpl(Session session, ManagerProvider mgrProvider,
-                     ItemManager itemMgr, WorkspaceManager wspManager,
-                     Node node)
-        throws InvalidQueryException, RepositoryException {
-
-        this.session = session;
-        this.mgrProvider = mgrProvider;
-        this.itemManager = itemMgr;
+        this.wspManager.checkQueryStatement(statement, language, getNamespaceMappings());
-        this.wspManager = wspManager;
-
-        NamePathResolver resolver = mgrProvider.getNamePathResolver();
-        if (!node.isNodeType(resolver.getJCRName(NameConstants.NT_QUERY))) {
-            throw new InvalidQueryException("Node is not of type nt:query");
-        }
-        if (node.getSession() != session) {
-            throw new InvalidQueryException("Node belongs to a different session.");
-        }
-        statement = node.getProperty(resolver.getJCRName(NameConstants.JCR_STATEMENT)).getString();
-        language = node.getProperty(resolver.getJCRName(NameConstants.JCR_LANGUAGE)).getString();
-        this.wspManager.checkQueryStatement(
-                statement, language, getNamespaceMappings());
