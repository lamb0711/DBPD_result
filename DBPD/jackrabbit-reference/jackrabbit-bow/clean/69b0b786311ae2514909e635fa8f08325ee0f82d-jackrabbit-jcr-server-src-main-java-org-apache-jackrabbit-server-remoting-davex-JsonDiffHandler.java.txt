- JCR-1958: Enhanced JCR remoting (work in progress)

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@743718 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.LinkedList;
-        if (diffPath.startsWith("/")) {
-            // diff path is already an absolute path
-            return diffPath;
-        } else {
+        StringBuffer itemPath;
+        if (!diffPath.startsWith("/")) {
-            return requestItemPath + diffPath;
+            itemPath = new StringBuffer(requestItemPath);
+            if (!requestItemPath.endsWith("/")) {
+                itemPath.append('/');
+            }
+            itemPath.append(diffPath);
+        } else {
+            itemPath = new StringBuffer(diffPath);
+        return normalize(itemPath.toString());
+    private static String normalize(String path) {
+        if (path.indexOf('.') == -1) {
+            return path;
+        }
+        String[]  elems = Text.explode(path, '/', false);
+        LinkedList queue = new LinkedList();
+        String last = "..";
+        for (int i = 0; i < elems.length; i++) {
+            String segm = elems[i];
+            if ("..".equals(segm) && !"..".equals(last)) {
+                queue.removeLast();
+                if (queue.isEmpty()) {
+                    last = "..";
+                } else {
+                    last = queue.getLast().toString();
+                }
+            } else if (!".".equals(segm)) {
+                last = segm;
+                queue.add(last);
+            }
+        }
+        return "/" + Text.implode((String[]) queue.toArray(new String[queue.size()]), "/");
+    }
+    
