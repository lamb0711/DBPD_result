JCR-4033: Session leak in case of an exception inside the constructor of SessionImpl

ack: Nicolas Filotto 

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1766557 13f79535-47bb-0310-9956-ffa450edef68

-    private Exception openStackTrace = new Exception("Stack Trace");
+    private final Exception openStackTrace;
-        namePathResolver = new DefaultNamePathResolver(this, this, true);
-        context.setItemStateManager(createSessionItemStateManager());
-        context.setItemManager(createItemManager());
-        context.setAccessManager(createAccessManager(subject));
-        context.setObservationManager(
-                createObservationManager(wspConfig.getName()));
+        this.namePathResolver = new DefaultNamePathResolver(this, this, true);
+        this.context.setItemStateManager(createSessionItemStateManager());
+        this.context.setItemManager(createItemManager());
+        this.context.setAccessManager(createAccessManager(subject));
+        this.context.setObservationManager(createObservationManager(wspConfig.getName()));
-        versionMgr = createVersionManager();
+        this.versionMgr = createVersionManager();
+
+        // avoid building the stack trace when it won't be used anyway
+        this.openStackTrace = log.isWarnEnabled() ? new Exception("Stack Trace") : null;
-            log.warn("Unclosed session detected. The session was opened here: ", openStackTrace);
+            if (openStackTrace != null) {
+                // Log a warning if and only if openStackTrace is not null
+                // indicating that the warn level is enabled and the session has
+                // been fully created
+                log.warn("Unclosed session detected. The session was opened here: ", openStackTrace);
+            }
