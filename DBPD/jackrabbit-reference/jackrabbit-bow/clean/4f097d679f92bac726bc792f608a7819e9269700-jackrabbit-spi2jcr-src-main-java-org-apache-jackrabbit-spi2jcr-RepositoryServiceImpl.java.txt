JCR-2104:  JSR 283 Full Versioning (work in progress)

- setActivity
- checkout with activity param -> spi level
- more checks in version manager
- invalidation after sucessful mergeActivity

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@803444 13f79535-47bb-0310-9956-ffa450edef68

-                getNode(nodeId, getSessionInfoImpl(sessionInfo)).checkout();
+                getNode(nodeId, sInfo).checkout();
+                return null;
+            }
+        }, sInfo);
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void checkout(final SessionInfo sessionInfo, final NodeId nodeId, NodeId activityId) throws UnsupportedRepositoryOperationException, LockException, RepositoryException {
+        final SessionInfoImpl sInfo = getSessionInfoImpl(sessionInfo);
+        Node activity = (activityId == null) ? null : getNode(activityId, sInfo);
+        sInfo.getSession().getWorkspace().getVersionManager().setActivity(activity);
+        executeWithLocalEvents(new Callable() {
+            public Object run() throws RepositoryException {
+                getNode(nodeId, sInfo).checkout();
-        Node activity = (Node) executeWithLocalEvents(new Callable() {
+        executeWithLocalEvents(new Callable() {
-                // TODO: uncomment as soon as removeActivity method is fixed in jsr 283
-                // return vMgr.removeActivity(getNode(activityId, sInfo));
-                throw new UnsupportedOperationException("Impl missing... waiting for updated jsr 283 jar.");
+                vMgr.removeActivity(getNode(activityId, sInfo));
+                return null;
