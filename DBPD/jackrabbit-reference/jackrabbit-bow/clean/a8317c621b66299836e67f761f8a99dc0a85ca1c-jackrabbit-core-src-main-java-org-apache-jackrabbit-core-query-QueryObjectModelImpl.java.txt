JCR-3122 QueryObjectModelImpl should execute queries as SessionOperation(s)

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1186248 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.session.SessionOperation;
-        QueryEngine engine = new QueryEngine(sessionContext.getSessionImpl(),
-                lqf, variables);
-        QueryResult qr = engine.execute(getColumns(), getSource(),
-                getConstraint(), getOrderings(), offset, limit);
+        final QueryResult result = sessionContext.getSessionState().perform(
+                new SessionOperation<QueryResult>() {
+                    public QueryResult perform(SessionContext context)
+                            throws RepositoryException {
+                        final QueryEngine engine = new QueryEngine(
+                                sessionContext.getSessionImpl(), lqf, variables);
+                        return engine.execute(getColumns(), getSource(),
+                                getConstraint(), getOrderings(), offset, limit);
+                    }
+                    public String toString() {
+                        return "query.execute(" + statement + ")";
+                    }
+                });
-        return qr;
+        return result;
