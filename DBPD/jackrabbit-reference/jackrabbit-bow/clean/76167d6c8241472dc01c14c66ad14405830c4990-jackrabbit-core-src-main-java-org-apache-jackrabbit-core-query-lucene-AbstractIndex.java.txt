JCR-2980 Nodes that have properties marked for async extraction should be available for querying

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1131652 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.lucene.analysis.tokenattributes.PayloadAttribute;
+import org.apache.lucene.analysis.tokenattributes.TermAttribute;
+import org.apache.lucene.index.Payload;
-                } else if (f.tokenStreamValue() != null) {
-                    TokenStream ts = f.tokenStreamValue();
-                    field = new Field(f.name(), ts);
+                } else if (f.tokenStreamValue() != null && f.tokenStreamValue() instanceof SingletonTokenStream) {
+                    TokenStream tokenStream = f.tokenStreamValue();
+                    TermAttribute termAttribute = tokenStream.addAttribute(TermAttribute.class);
+                    PayloadAttribute payloadAttribute = tokenStream.addAttribute(PayloadAttribute.class);
+                    tokenStream.incrementToken();
+                    String value = new String(termAttribute.termBuffer(), 0, termAttribute.termLength());
+                    tokenStream.reset();
+                    field = new Field(f.name(), new SingletonTokenStream(value, (Payload) payloadAttribute.getPayload().clone()));
