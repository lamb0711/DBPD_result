JCR-3269 fix 'disconnected' nodes by removing them from the node that references them as a child

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1350224 13f79535-47bb-0310-9956-ffa450edef68

+        Collection<NodePropBundle.ChildNodeEntry> disconnectedChildren = new ArrayList<NodePropBundle.ChildNodeEntry>();
-                    if (cp == null || !cp.equals(id)) {
+                    if (!id.equals(cp)) {
-                                if (cp == null) {
-                                    message = "ChildNode has invalid parent id: <null>";
-                                    log.error(message);
-                                } else if (!cp.equals(id)) {
-                                    message = "ChildNode has invalid parent id: '" + cp
-                                            + "' (instead of '" + id + "')";
-                                    log.error(message);
-                                }
+                                // indeed we have a disconnected child
+                                message = "ChildNode has invalid parent id: '" + cp + "' (instead of '" + id + "')";
+                                log.error(message);
+                                disconnectedChildren.add(entry);
-        if (fix && !missingChildren.isEmpty()) {
+        if (fix && (!missingChildren.isEmpty() || !disconnectedChildren.isEmpty())) {
+            for (NodePropBundle.ChildNodeEntry entry : disconnectedChildren) {
+                bundle.getChildNodeEntries().remove(entry);
+            }
