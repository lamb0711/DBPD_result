JCR-2640: Internal repository context

Add the security manager to the repository context before initialising it to avoid problems with implementations that require the manager to be present even before it has been fully initialised. Such situations should ideally not exist, so leaving a FIXME comment in the code.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@949725 13f79535-47bb-0310-9956-ffa450edef68

-            context.setSecurityManager(createSecurityManager());
+            initSecurityManager();
-     * of this <code>Repository</code>
+     * of this <code>Repository</code> and adds it to the repository context.
-     * @return the security manager
-    private synchronized JackrabbitSecurityManager createSecurityManager()
-            throws RepositoryException {
+    private synchronized void initSecurityManager() throws RepositoryException {
+        if (smc == null) {
+            log.debug("No configuration entry for SecurityManager. Using org.apache.jackrabbit.core.security.simple.SimpleSecurityManager");
+            securityMgr = new SimpleSecurityManager();
+        } else {
+            securityMgr = smc.newInstance(JackrabbitSecurityManager.class);
+        }
+
+        log.info("SecurityManager = " + securityMgr.getClass());
+
+        context.setSecurityManager(securityMgr);
+
-        if (smc == null) {
-            log.debug("No configuration entry for SecurityManager. Using org.apache.jackrabbit.core.security.simple.SimpleSecurityManager");
-            securityMgr = new SimpleSecurityManager();
-        } else {
-            securityMgr = smc.newInstance(JackrabbitSecurityManager.class);
-        }
-
+        // FIXME: Note that this call must be done *after* the security
+        // manager has been added to the repository context, since the
+        // initialisation code may invoke code that depends on the presence
+        // of a security manager. It would be better if this was not the case.
-        log.info("SecurityManager = " + securityMgr.getClass());
-
-        return securityMgr;
