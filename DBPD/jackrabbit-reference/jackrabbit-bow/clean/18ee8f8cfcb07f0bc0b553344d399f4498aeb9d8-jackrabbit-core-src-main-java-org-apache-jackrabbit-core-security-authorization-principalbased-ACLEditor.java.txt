 JCR-1588: JSR 283: Access Control

- node hierarchy created with principalbased ac-editing may choose wrong node type for intermediate nodes.
- add test


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@790071 13f79535-47bb-0310-9956-ffa450edef68

+        StringBuilder currentPath = new StringBuilder();
+            if (i > 0) {
+                currentPath.append('/').append(segms[i]);
+            }
-            Name ntName = (i < segms.length - 1) ? NT_REP_ACCESS_CONTROL : NT_REP_PRINCIPAL_ACCESS_CONTROL;
+            Name ntName;
+            if (denotesPrincipalPath(currentPath.toString())) {
+                ntName = NT_REP_PRINCIPAL_ACCESS_CONTROL;
+            } else {
+                ntName = (i < segms.length - 1) ? NT_REP_ACCESS_CONTROL : NT_REP_PRINCIPAL_ACCESS_CONTROL;
+            }
+    private boolean denotesPrincipalPath(final String path) {
+        if (path == null || path.length() == 0) {
+            return false;
+        }
+        ItemBasedPrincipal princ = new ItemBasedPrincipal() {
+            public String getPath() throws RepositoryException {
+                return path;
+            }
+            public String getName() {
+                return Text.getName(path);
+            }
+        };
+        try {
+            return session.getUserManager().getAuthorizable(princ) != null;
+        } catch (RepositoryException e) {
+            return false;
+        }
+    }
+
