JCR-298: Remove blobs when property state is removed. Fix contributed by Alexandru Popescu.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@395386 13f79535-47bb-0310-9956-ffa450edef68

+import javax.jcr.PropertyType;
+
+import org.apache.jackrabbit.core.value.InternalValue;
+import org.apache.jackrabbit.core.value.BLOBFileValue;
+
+            InternalValue[] values = state.getValues();
+            if (values != null) {
+                for (int i = 0; i < values.length; i++) {
+                    InternalValue val = values[i];
+                    if (val != null) {
+                        if (val.getType() == PropertyType.BINARY) {
+                            BLOBFileValue blobVal = (BLOBFileValue) val.internalValue();
+                            // delete internal resource representation of BLOB value
+                            blobVal.delete(true);
+                            // also remove from BLOBStore
+                            String blobId = blobStore.createId((PropertyId) state.getId(), i);
+                            try {
+                                blobStore.remove(blobId);
+                            } catch (Exception e) {
+                                log.warn("failed to remove from BLOBStore: " + blobId, e);
+                            }
+                        }
+                    }
+                }
+            } 
