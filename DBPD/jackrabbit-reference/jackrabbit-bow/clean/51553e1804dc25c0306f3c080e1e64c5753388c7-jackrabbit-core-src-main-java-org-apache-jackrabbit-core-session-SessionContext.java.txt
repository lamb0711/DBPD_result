JCR-2746: Sleep in possibly endless loop in ObservationDispatcher

Move the sleep to the end of SessionState.perform() after all the relevant locks have been released

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1000950 13f79535-47bb-0310-9956-ffa450edef68

-     * The thread in which not to delay operations.
-     * If null, no operations are delayed.
-     * If not null, the next operation is delayed,
-     * except operations that are executed from this thread.
-     */
-    private Thread delayExceptInThread;
-
-    /**
-     * The delay in milliseconds.
-     */
-    private long delayMs;
-
-    /**
-    /**
-     * Delay the next operation, except if it is run using the given thread.
-     *
-     * @param exceptInThread the thread that shouldn't be delayed
-     * @param ms the delay in milliseconds
-     */
-    public void delayNextOperation(Thread exceptInThread, long ms) {
-        this.delayExceptInThread = exceptInThread;
-        this.delayMs = ms;
-    }
-
-    /**
-     * Delay a session operation if it is necessary.
-     */
-    public void delayIfNecessary() {
-        if (delayExceptInThread != null) {
-            Thread currentThread = Thread.currentThread();
-            if (currentThread != delayExceptInThread) {
-                try {
-                    Thread.sleep(delayMs);
-                } catch (InterruptedException e) {
-                    // ignore
-                }
-                // don't delay the next operation
-                delayExceptInThread = null;
-            }
-        }
-    }
-
