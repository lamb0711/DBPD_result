work in progress

- add invalidate(), refresh() to NodeState (missing impl)
- rename ItemState.refresh(ChangeLog) to persisted(ChangeLog)
- Item.refresh(boolean) must not call checkStatus. a stale, invalidated
  item may be refreshed unless its state has a terminal status (removed, stale_destroyed). ItemState.refresh() is therefore called after reverting transient modifications only.
- javadoc and some comments

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@474319 13f79535-47bb-0310-9956-ffa450edef68

-        checkStatus();
+        // check session status
+        session.checkIsAlive();
+        // check if item has been removed
+        if (Status.isTerminal(state.getStatus())) {
+            throw new InvalidItemStateException("Item '" + this + "' doesn't exist anymore");
+        }
-        if (!keepChanges) {
+        if (keepChanges) {
+            state.refresh();
+        } else {
-            switch (state.getStatus()) {
-                case Status.NEW:
-                    String msg = "Cannot refresh a new item (" + safeGetJCRPath() + ").";
-                    log.debug(msg);
-                    throw new RepositoryException(msg);
+            if (state.getStatus() == Status.NEW) {
+                String msg = "Cannot refresh a new item (" + safeGetJCRPath() + ").";
+                log.debug(msg);
+                throw new RepositoryException(msg);
+            // now refresh to persistent state as present on the server
+            state.refresh();
-
-        // now refresh to persistent state on server
-        state.refresh();
-        if (state != null) {
-            if (state.getStatus() == Status.INVALIDATED) {
-                // refresh to get current status from persistent storage
-                state.refresh();
-            }
-            // now check if valid
-            if (state.isValid()) {
-                return;
-            }
+        if (state.getStatus() == Status.INVALIDATED) {
+            // refresh to get current status from persistent storage
+            state.refresh();
-        throw new InvalidItemStateException("Item '" + this + "' doesn't exist anymore");
+        // now check if valid
+        if (!state.isValid()) {
+            throw new InvalidItemStateException("Item '" + this + "' doesn't exist anymore");
+        }
