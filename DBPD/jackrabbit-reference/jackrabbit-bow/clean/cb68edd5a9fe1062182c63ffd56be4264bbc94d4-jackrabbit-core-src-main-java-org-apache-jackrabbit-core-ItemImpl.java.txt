JCR-1359: Adding nodes from concurrently running sessions cause exceptions

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@632376 13f79535-47bb-0310-9956-ffa450edef68

-                            // need to save dependency as well
-                            String msg = itemMgr.safeGetJCRPath(id)
-                                    + " needs to be saved as well.";
-                            log.debug(msg);
-                            throw new ConstraintViolationException(msg);
+                            // JCR-1359 workaround: check whether unresolved
+                            // dependencies originate from 'this' session;
+                            // otherwise ignore them
+                            if (stateMgr.hasTransientItemState(id)
+                                    || stateMgr.hasTransientItemStateInAttic(id)) {
+                                // need to save dependency as well
+                                String msg = itemMgr.safeGetJCRPath(id)
+                                        + " needs to be saved as well.";
+                                log.debug(msg);
+                                throw new ConstraintViolationException(msg);
+                            }
