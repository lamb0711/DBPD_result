JCR-1502 - Journal log file rotation overwrites old files


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@641247 13f79535-47bb-0310-9956-ffa450edef68

-import java.io.FilenameFilter;
-import java.util.Arrays;
-import java.util.Comparator;
-        File[] logFiles = null;
+        File[] files = null;
-            logFiles = rootDirectory.listFiles(new FilenameFilter() {
-                public boolean accept(File dir, String name) {
-                    return name.startsWith(basename + ".");
-                }
-            });
-            Arrays.sort(logFiles, new Comparator() {
-                public int compare(Object o1, Object o2) {
-                    File f1 = (File) o1;
-                    File f2 = (File) o2;
-                    return f1.compareTo(f2);
-                }
-            });
+            RotatingLogFile[] logFiles = RotatingLogFile.listFiles(rootDirectory, basename);
+            files = new File[logFiles.length];
+            for (int i = 0; i < files.length; i++) {
+                files[i] = logFiles[i].getFile();
+            }
-        return new FileRecordIterator(logFiles, startRevision, stopRevision, getResolver(), getNamePathResolver());
+        return new FileRecordIterator(files, startRevision, stopRevision, 
+                getResolver(), getNamePathResolver());
-                switchLogs();
+                rotateLogs();
-    private void switchLogs() {
-        FilenameFilter filter = new FilenameFilter() {
-            public boolean accept(File dir, String name) {
-                return name.startsWith(basename + ".");
-            }
-        };
-        File[] files = rootDirectory.listFiles(filter);
-        Arrays.sort(files, new Comparator() {
-            public int compare(Object o1, Object o2) {
-                File f1 = (File) o1;
-                File f2 = (File) o2;
-                return f2.compareTo(f1);
-            }
-        });
-        for (int i = 0; i < files.length; i++) {
-            File file = files[i];
-            String name = file.getName();
-            int sep = name.lastIndexOf('.');
-            if (sep != -1) {
-                String ext = name.substring(sep + 1);
-                if (ext.equals(LOG_EXTENSION)) {
-                    file.renameTo(new File(rootDirectory, name + ".1"));
-                } else {
-                    try {
-                        int version = Integer.parseInt(ext);
-                        String newName = name.substring(0, sep + 1)
-                            + String.valueOf(version + 1);
-                        file.renameTo(new File(rootDirectory, newName));
-                    } catch (NumberFormatException e) {
-                        log.warn("Bogusly named journal file, skipped: " + file);
-                    }
-                }
-            }
+    private void rotateLogs() {
+        RotatingLogFile[] logFiles = RotatingLogFile.listFiles(rootDirectory, basename);
+        for (int i = 0; i < logFiles.length; i++) {
+            logFiles[i].rotate();
