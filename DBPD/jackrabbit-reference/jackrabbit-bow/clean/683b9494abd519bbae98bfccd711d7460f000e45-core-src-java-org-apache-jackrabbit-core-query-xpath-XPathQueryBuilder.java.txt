- Optimize query execution. document frequency for UUID and PARENT field can be served from cache.
- Reuse query parsers. Results in much lower memory consumption

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@220022 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Map;
+import java.util.WeakHashMap;
+     * Map of reusable XPath parser instances indexed by NamespaceResolver.
+     */
+    private static Map parsers = new WeakHashMap();
+
+    /**
-     * The {@link org.apache.jackrabbit.core.NamespaceResolver} in use
+     * The {@link NamespaceResolver} in use
-            XPath query = new XPath(new StringReader(statement));
-            query.XPath2().jjtAccept(this, root);
+            // get parser
+            XPath parser;
+            synchronized (parsers) {
+                parser = (XPath) parsers.get(resolver);
+                if (parser == null) {
+                    parser = new XPath(new StringReader(statement));
+                    parsers.put(resolver, parser);
+                }
+            }
+
+            SimpleNode query;
+            // guard against concurrent use within same session
+            synchronized (parser) {
+                parser.ReInit(new StringReader(statement));
+                query = parser.XPath2();
+            }
+            query.jjtAccept(this, root);
