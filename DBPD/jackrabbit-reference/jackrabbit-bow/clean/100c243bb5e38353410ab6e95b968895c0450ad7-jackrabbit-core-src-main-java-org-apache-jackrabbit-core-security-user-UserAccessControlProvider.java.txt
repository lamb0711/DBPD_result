JCR-2748 - commit patch provided by Justin Edelson with minor modifications.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1021801 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.security.AnonymousPrincipal;
+        
+    /**
+     * Constant for the name of the configuration option "anonymousId".
+     * The option is a flag indicating the name of the anonymous user id.
+     */
+    public static final String PARAM_ANONYMOUS_ID = "anonymousId";
+    
+    /**
+     * Constant for the name of the configuration option "anonymousAccess".
+     */
+    public static final String PARAM_ANONYMOUS_ACCESS = "anonymousAccess";
+    
+    private String anonymousId;   
+    private boolean anonymousAccess;
+            if (configuration.containsKey(PARAM_ANONYMOUS_ID)) {
+                anonymousId = (String) configuration.get(PARAM_ANONYMOUS_ID);
+            } else {
+                anonymousId = SecurityConstants.ANONYMOUS_ID;
+            }
+            
+            if (configuration.containsKey(PARAM_ANONYMOUS_ACCESS)) {
+                anonymousAccess = Boolean.parseBoolean((String) configuration.get(PARAM_ANONYMOUS_ACCESS));
+            } else {
+                anonymousAccess = true;
+            }
+            
+            if (!anonymousAccess && isAnonymous(principals))  {
+                return CompiledPermissions.NO_PERMISSION;
+            }
+            
+        if (!anonymousAccess && isAnonymous(principals))  {
+            return false;
+        }
+    private boolean isAnonymous(Set<Principal> principals) {
+        for (Principal p : principals) {
+            if (p instanceof AnonymousPrincipal) {
+                return true;
+            } else if (p.getName().equals(anonymousId)) {
+                return true;
+            }
+        }
+        return false;
+    }
+
