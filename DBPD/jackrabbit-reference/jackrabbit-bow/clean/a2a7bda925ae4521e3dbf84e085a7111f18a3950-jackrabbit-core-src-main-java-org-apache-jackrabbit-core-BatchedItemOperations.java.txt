JCR-1104 - JSR 283 support
- shareble nodes (work in progress)

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@642204 13f79535-47bb-0310-9956-ffa450edef68

+            boolean shareable = ent.includesNodeType(NameConstants.MIX_SHAREABLE);
+            if (shareable) {
+                // initialize shared set
+                newState.addShare(destParentId);
+            }
+                /**
+                 * If child is shareble and its UUID has already been remapped,
+                 * then simply add a reference to the state with that remapped
+                 * UUID instead of copying the whole subtree.
+                 */
+                if (srcChildState.isShareable()) {
+                    UUID uuid = refTracker.getMappedUUID(srcChildState.getNodeId().getUUID());
+                    if (uuid != null) {
+                        NodeId mappedId = new NodeId(uuid);
+                        if (stateMgr.hasItemState(mappedId)) {
+                            NodeState destState = (NodeState) stateMgr.getItemState(mappedId);
+                            if (!destState.isShareable()) {
+                                String msg = "Remapped child is not shareable.";
+                                throw new ItemStateException(msg);
+                            }
+                            if (!destState.addShare(id)) {
+                                String msg = "Unable to add share to node: " + id;
+                                throw new ItemStateException(msg);
+                            }
+                            stateMgr.store(destState);
+                            newState.addChildNodeEntry(entry.getName(), mappedId);
+                            continue;
+                        }
+                    }
+                }
+
