JCR_423 Node.restore() fails for existing non-versioned OPV=Version child nodes

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@405417 13f79535-47bb-0310-9956-ffa450edef68

+     * the frozen child nodes
+     */
+    private InternalFreeze[] frozenNodes = null;
+
+    /**
-    public InternalFreeze[] getFrozenChildNodes() throws VersionException {
-        try {
-            // maybe add iterator?
-            List entries = node.getState().getChildNodeEntries();
-            InternalFreeze[] freezes = new InternalFreeze[entries.size()];
-            Iterator iter = entries.iterator();
-            int i = 0;
-            while (iter.hasNext()) {
-                NodeState.ChildNodeEntry entry = (NodeState.ChildNodeEntry) iter.next();
-                freezes[i++] = (InternalFreeze) vMgr.getItem(entry.getId());
+    public synchronized InternalFreeze[] getFrozenChildNodes()
+            throws VersionException {
+        if (frozenNodes == null) {
+            try {
+                // maybe add iterator?
+                List entries = node.getState().getChildNodeEntries();
+                frozenNodes = new InternalFreeze[entries.size()];
+                Iterator iter = entries.iterator();
+                int i = 0;
+                while (iter.hasNext()) {
+                    NodeState.ChildNodeEntry entry =
+                            (NodeState.ChildNodeEntry) iter.next();
+                    frozenNodes[i++] = (InternalFreeze) vMgr.getItem(entry.getId());
+                }
+            } catch (RepositoryException e) {
+                throw new VersionException("Unable to retrieve frozen child nodes", e);
-            return freezes;
-        } catch (RepositoryException e) {
-            throw new VersionException("Unable to retrieve frozen child nodes", e);
+        return frozenNodes;
-            NodeState.ChildNodeEntry entry  = node.getState().getChildNodeEntry(id);
-            if (entry != null) {
-                return vMgr.getItem(id) instanceof InternalFrozenVersionHistory;
+            InternalFreeze[] frozen = getFrozenChildNodes();
+            for (int i=0; i<frozen.length; i++) {
+                if (frozen[i] instanceof InternalFrozenVersionHistory &&
+                    ((InternalFrozenVersionHistory) frozen[i])
+                            .getVersionHistoryId().equals(id)) {
+                    return true;
+                }
