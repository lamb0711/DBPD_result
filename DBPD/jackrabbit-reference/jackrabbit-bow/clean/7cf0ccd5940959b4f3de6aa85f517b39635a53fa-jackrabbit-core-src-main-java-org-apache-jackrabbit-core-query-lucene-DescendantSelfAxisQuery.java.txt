JCR-3001 DescendantSelfAxisQuery may fail with IOException when session has limited access

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1139224 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.id.NodeId;
+import org.apache.lucene.index.Term;
+import javax.jcr.ItemNotFoundException;
-    public void extractTerms(Set terms) {
+    public void extractTerms(Set<Term> terms) {
-                try {
-                    while ((sn = result.nextScoreNode()) != null) {
-                        Node node = session.getNodeById(sn.getNodeId());
+                while ((sn = result.nextScoreNode()) != null) {
+                    NodeId id = sn.getNodeId();
+                    try {
+                        Node node = session.getNodeById(id);
+                    } catch (ItemNotFoundException e) {
+                        // JCR-3001 access denied to score node, will just skip it
+                        log.warn("Access denied to node id {}.", id);
+                    } catch (RepositoryException e) {
+                        throw Util.createIOException(e);
-                } catch (RepositoryException e) {
-                    throw Util.createIOException(e);
-                    if (scoreNodes.hasNext()) {
+                    currentTraversal = null;
+                    // We only need one node, but because of the acls, we'll
+                    // iterate until we find a good one
+                    while (scoreNodes.hasNext()) {
+                        NodeId id = sn.getNodeId();
-                            Node node = session.getNodeById(sn.getNodeId());
-                            currentTraversal = new NodeTraversingQueryHits(node,
-                                    getMinLevels() == 0);
+                            Node node = session.getNodeById(id);
+                            currentTraversal = new NodeTraversingQueryHits(
+                                    node, getMinLevels() == 0);
+                            break;
+                        } catch (ItemNotFoundException e) {
+                            // JCR-3001 node access denied, will just skip it
+                            log.warn("Access denied to node id {}.", id);
-                    } else {
-                        currentTraversal = null;
