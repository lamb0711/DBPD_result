JCR-2703 : UserManagement: Add Membership Cache

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@984356 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.security.user.MembershipCache;
+     * @param session
+     * @return
+     * @throws RepositoryException
+     */
+    protected MembershipCache getMembershipCache(SessionImpl session) throws RepositoryException {
+        if (session == systemSession || session instanceof SystemSession) {
+            // force creation of the membership cache within the corresponding uMgr
+            return null;
+        } else {
+            return ((UserManagerImpl) getSystemUserManager(session.getWorkspace().getName())).getMembershipCache();
+        }
+    }
+
+    /**
-        // system user manager (special implementation that asserts the existance
+        // system user manager (special implementation that asserts the existence
-            Class<?>[] paramTypes = new Class[] { SessionImpl.class, String.class, Properties.class };
-            um = (UserManagerImpl) umc.getUserManager(UserManagerImpl.class, paramTypes, (SessionImpl) session, adminId, params);
+            Class<?>[] paramTypes = new Class[] {
+                    SessionImpl.class,
+                    String.class,
+                    Properties.class,
+                    MembershipCache.class};
+            um = (UserManagerImpl) umc.getUserManager(UserManagerImpl.class,
+                    paramTypes, (SessionImpl) session, adminId, params,
+                    getMembershipCache(session));
-            um = new UserManagerImpl(session, adminId, params);
+            um = new UserManagerImpl(session, adminId, params, getMembershipCache(session));
