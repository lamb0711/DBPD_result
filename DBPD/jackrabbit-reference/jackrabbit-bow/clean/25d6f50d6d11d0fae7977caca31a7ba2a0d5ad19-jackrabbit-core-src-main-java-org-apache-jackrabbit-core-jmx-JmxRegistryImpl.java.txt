JCR-3040 JMX Stats for the Session

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1153868 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.jmx.core.CoreStat;
+import org.apache.jackrabbit.core.jmx.core.CoreStatImpl;
+import org.apache.jackrabbit.core.jmx.core.CoreStatManager;
+import org.apache.jackrabbit.core.jmx.core.CoreStatManagerMBean;
+import org.apache.jackrabbit.core.jmx.query.QueryStat;
+import org.apache.jackrabbit.core.jmx.query.QueryStatImpl;
-import org.apache.jackrabbit.core.jmx.query.QueryStatManagerImpl;
-import org.apache.jackrabbit.core.jmx.query.QueryStatManagerImplMBean;
+import org.apache.jackrabbit.core.jmx.query.QueryStatManagerMBean;
-    private QueryStatManagerImpl queryStatManager;
+    private QueryStat queryStat;
+
+    private CoreStat coreStat;
+        log.debug("Started JMX Registry.");
-            queryStatManager = new QueryStatManagerImpl();
-            register(queryStatManager, new ObjectName(
-                    QueryStatManagerImplMBean.NAME));
-            log.info("Started JMX Registry");
+            coreStat = new CoreStatImpl();
+            register(new CoreStatManager(coreStat), new ObjectName(
+                    CoreStatManagerMBean.NAME));
+            log.debug("JMX Registry - registered CoreStats.");
-            queryStatManager = null;
-            log.error("Unable to start JMX Registry", e);
+            log.error("JMX Registry - Unable to register CoreStats.", e);
+            coreStat.setEnabled(false);
+        }
+
+        try {
+            queryStat = new QueryStatImpl();
+            register(new QueryStatManager(queryStat), new ObjectName(
+                    QueryStatManagerMBean.NAME));
+            log.debug("JMX Registry - registered QueryStats.");
+
+        } catch (Exception e) {
+            log.error("JMX Registry - Unable to register QueryStats.", e);
+            queryStat.setEnabled(false);
-        for (ObjectName o : registry) {
+        List<ObjectName> registryCopy = new ArrayList<ObjectName>(registry);
+        for (ObjectName o : registryCopy) {
-                server.unregisterMBean(o);
+                unregister(o);
+        if (server == null || server.isRegistered(name)) {
+            return;
+        }
-    public QueryStatManager getQueryStatManager() {
-        return queryStatManager;
+    /*
+     * (non-Javadoc)
+     * 
+     * @see org.apache.jackrabbit.core.jmx.JmxRegistry#getCoreStat()
+     */
+    public CoreStat getCoreStat() {
+        return coreStat;
+
+    /*
+     * (non-Javadoc)
+     * 
+     * @see org.apache.jackrabbit.core.jmx.JmxRegistry#getQueryStatManager()
+     */
+    public QueryStat getQueryStat() {
+        return queryStat;
+    }
+
