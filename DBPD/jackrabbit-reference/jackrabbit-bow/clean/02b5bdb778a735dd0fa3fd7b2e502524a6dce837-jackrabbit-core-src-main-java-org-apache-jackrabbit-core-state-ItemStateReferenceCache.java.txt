JCR-1271: NullPointerException when iterating over properties

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@605510 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.Set;
-import java.util.Collections;
-import java.util.Collection;
+ * This implementation of ItemStateCache is thread-safe.
-    public boolean isCached(ItemId id) {
+    public synchronized boolean isCached(ItemId id) {
-    public ItemState retrieve(ItemId id) {
+    public synchronized ItemState retrieve(ItemId id) {
-    public void cache(ItemState state) {
+    public synchronized ItemState[] retrieveAll() {
+        // values of primary cache
+        return (ItemState[]) refs.values().toArray(new ItemState[refs.size()]);
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public synchronized void cache(ItemState state) {
-    public void evict(ItemId id) {
+    public synchronized void evict(ItemId id) {
-    public void dispose() {
+    public synchronized void dispose() {
-    public void evictAll() {
+    public synchronized void evictAll() {
-    public void update(ItemId id) {
+    public synchronized void update(ItemId id) {
-    public boolean isEmpty() {
+    public synchronized boolean isEmpty() {
-    /**
-     * {@inheritDoc}
-     */
-    public int size() {
-        // size of primary cache
-        return refs.size();
-    }
-
-    /**
-     * {@inheritDoc}
-     */
-    public Set keySet() {
-        // keys of primary cache
-        return Collections.unmodifiableSet(refs.keySet());
-    }
-
-    /**
-     * {@inheritDoc}
-     */
-    public Collection values() {
-        // values of primary cache
-        return Collections.unmodifiableCollection(refs.values());
-    }
-
-    public void dump(PrintStream ps) {
+    public synchronized void dump(PrintStream ps) {
