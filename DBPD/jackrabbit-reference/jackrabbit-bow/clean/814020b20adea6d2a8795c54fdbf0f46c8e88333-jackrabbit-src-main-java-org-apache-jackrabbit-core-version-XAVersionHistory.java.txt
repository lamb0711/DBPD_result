JCR-455: InternalXAResource.rollback() can be called twice and without prepare
JCR-414: jcr:successors property not persisted correctly within a transaction


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@412995 13f79535-47bb-0310-9956-ffa450edef68

-import javax.jcr.RepositoryException;
-import javax.jcr.InvalidItemStateException;
-     * Internal version history. Gets fetched again from the version manager if
-     * needed.
-     */
-    private InternalVersionHistory history;
-
-    /**
-     * XA Version manager.
-     */
-    private final XAVersionManager vMgr;
-
-    /**
-
-        this.history = history;
-        this.vMgr = (XAVersionManager) session.getVersionManager();
-    /**
-     * {@inheritDoc}
-     */
-    protected InternalVersionHistory getInternalVersionHistory()
-            throws RepositoryException {
-
-        ensureUpToDate();
-        sanityCheck();
-        return history;
-    }
-
-    /**
-     * {@inheritDoc}
-     */
-    protected void sanityCheck() throws RepositoryException {
-        super.sanityCheck();
-
-        if (history == null) {
-            throw new InvalidItemStateException(id + ": the item does not exist anymore");
-        }
-    }
-
-    /**
-     * Ensure the internal version is up-to-date.
-     */
-    private synchronized void ensureUpToDate() throws RepositoryException {
-        if (history != null) {
-            if (vMgr.differentXAEnv(((InternalVersionHistoryImpl) history))) {
-                history = vMgr.getVersionHistory(history.getId());
-            }
-        }
-    }
