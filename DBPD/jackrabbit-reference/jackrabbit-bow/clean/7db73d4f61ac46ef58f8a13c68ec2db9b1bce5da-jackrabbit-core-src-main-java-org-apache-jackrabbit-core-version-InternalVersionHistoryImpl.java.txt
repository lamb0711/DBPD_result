JCR-2140 Configurations and Baselines


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@796586 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Arrays;
+import java.util.HashSet;
-            v = new InternalVersionImpl(this, child, child.getName());
+            // check if baseline
+            if (child.getState().getMixinTypeNames().contains(NameConstants.REP_BASELINE)) {
+                v = new InternalBaselineImpl(this, child, child.getName());
+            } else {
+                v = new InternalVersionImpl(this, child, child.getName());
+            }
+     * @param configuration the set of versions in case a configuration is checked in
-    InternalVersionImpl checkin(Name name, NodeStateEx src)
+    InternalVersionImpl checkin(Name name, NodeStateEx src, Set<NodeId> configuration)
+        // check configuration
+        if (configuration != null) {
+            vNode.setMixins(new HashSet<Name>(Arrays.asList(NameConstants.REP_BASELINE)));
+            InternalValue[] values = new InternalValue[configuration.size()];
+            int i=0;
+            for (NodeId id: configuration) {
+                values[i++] = InternalValue.create(id);
+            }
+            vNode.setPropertyValues(NameConstants.REP_BASEVERSIONS, PropertyType.REFERENCE, values, true);
+        }
-        InternalVersionImpl version = new InternalVersionImpl(this, vNode, name);
+        InternalVersionImpl version = configuration == null
+                ? new InternalVersionImpl(this, vNode, name)
+                : new InternalBaselineImpl(this, vNode, name);
-        
+
+        if (nodeState.getNodeTypeName().equals(NameConstants.NT_CONFIGURATION)) {
+            // add baseline mixin for configurations
+            vNode.setMixins(new HashSet<Name>(Arrays.asList(NameConstants.REP_BASELINE)));
+        }
