JCR-3578: use absolute paths in DeltaV request bodies, and resolve hrefs in responses properly

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1470573 13f79535-47bb-0310-9956-ffa450edef68

+            String tmpUpdateSource[] = obtainAbsolutePathsFromUris(updateSource);
-                Element uElem = UpdateInfo.createUpdateElement(updateSource, updateType, DomUtil.createDocument());
+                Element uElem = UpdateInfo.createUpdateElement(tmpUpdateSource, updateType, DomUtil.createDocument());
-                String tmpUpdateSource[] = new String[updateSource.length];
-                for (int i = 0; i < updateSource.length; i++) {
-                    tmpUpdateSource[i] = obtainAbsolutePathFromUri(updateSource[i]);
-                }
-            String wspHref = uriResolver.getWorkspaceUri(srcWorkspaceName);
-            Element mElem = MergeInfo.createMergeElement(new String[] {wspHref}, !bestEffort, false, doc);
+            String wspHref = obtainAbsolutePathFromUri(uriResolver.getWorkspaceUri(srcWorkspaceName));
+            Element mElem = MergeInfo.createMergeElement(new String[] { wspHref }, !bestEffort, false, doc);
-            MergeMethod method = new MergeMethod(getItemUri(nodeId, sessionInfo), mInfo);
+            String uri = getItemUri(nodeId, sessionInfo);
+            MergeMethod method = new MergeMethod(uri, mInfo);
-                String href = resp.getHref();
+                String href = resolve(uri, resp.getHref());
-    
+
+    private static String[] obtainAbsolutePathsFromUris(String[] uris) {
+        if (uris == null) {
+            return null;
+        } else {
+            String result[] = new String[uris.length];
+
+            for (int i = 0; i < result.length; i++) {
+                result[i] = obtainAbsolutePathFromUri(uris[i]);
+            }
+            return result;
+        }
+    }
+
