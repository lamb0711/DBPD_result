JCR-1034: Unable to save session after saving a renamed node (fixed an incorrect svn log message)

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@562512 13f79535-47bb-0310-9956-ffa450edef68

-                                    // edge case: check whether definition id
-                                    // has changed (indicating that the node
-                                    // had been renamed, subsequently acquiring
-                                    // a new definition) (JCR-1034)
-                                    if (!nodeState.getDefinitionId().equals(
-                                            overlayedState.getDefinitionId())) {
-                                        // node has been renamed and as result
-                                        // got redefined, add parent to dependencies
-                                        dependentIDs.add(newParentId);
+                                    // parent id hasn't changed, check whether
+                                    // the node has been renamed (JCR-1034)
+                                    if (!affectedIds.contains(newParentId)
+                                            && stateMgr.hasTransientItemState(newParentId)) {
+                                        try {
+                                            NodeState parent = (NodeState) stateMgr.getTransientItemState(newParentId);
+                                            // check parent's renamed child node entries
+                                            for (Iterator cneIt =
+                                                    parent.getRenamedChildNodeEntries().iterator();
+                                                 cneIt.hasNext();) {
+                                                NodeState.ChildNodeEntry cne =
+                                                        (NodeState.ChildNodeEntry) cneIt.next();
+                                                if (cne.getId().equals(nodeState.getId())) {
+                                                    // node has been renamed,
+                                                    // add parent to dependencies
+                                                    dependentIDs.add(newParentId);
+                                                }
+                                            }
+                                        } catch (ItemStateException ise) {
+                                            // should never get here
+                                            log.warn("failed to retrieve transient state: " + newParentId, ise);
+                                        }
-                    // note that there's no need to check removed/added
-                    // child node entries since those, being descendants, 
-                    // will automatically be included in the hierarchical
-                    // scope of this save operation.
-/*
-  */
+
-                            // need to save the parent as well
+                            // need to save dependency as well
