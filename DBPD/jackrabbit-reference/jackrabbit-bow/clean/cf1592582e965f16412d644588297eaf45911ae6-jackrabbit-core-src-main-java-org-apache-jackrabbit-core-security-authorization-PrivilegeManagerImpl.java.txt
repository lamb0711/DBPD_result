JCR-2887 : Split PrivilegeRegistry in a per-session manager instance and a repository level registry [work in progress]

- clustering support
- move definition & def-reader/writer to spi-commons

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1095338 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.spi.commons.privilege.PrivilegeDefinition;
-        PrivilegeRegistry.Definition[] allDefs = registry.getAll();
+        PrivilegeDefinition[] allDefs = registry.getAll();
-                for (PrivilegeRegistry.Definition def : allDefs) {
+                for (PrivilegeDefinition def : allDefs) {
-        PrivilegeBits bits = PrivilegeBits.getInstance();
-        for (Privilege priv : privileges) {
-            if (priv instanceof PrivilegeImpl) {
-                bits.add(((PrivilegeImpl) priv).definition.getBits());
+
+        PrivilegeDefinition[] defs = new PrivilegeDefinition[privileges.length];
+        for (int i = 0; i < privileges.length; i++) {
+            Privilege p = privileges[i];
+            if (p instanceof PrivilegeImpl) {
+                defs[i] = ((PrivilegeImpl) p).definition;
-                String name = (priv == null) ? "null" : priv.getName();
+                String name = (p == null) ? "null" : p.getName();
-        return bits;
+        return registry.getBits(defs);
-                PrivilegeRegistry.Definition def = registry.get(name);
+                PrivilegeDefinition def = registry.get(name);
-     * @see PrivilegeRegistry.Listener#privilegeRegistered(org.apache.jackrabbit.spi.Name)
+     * @see PrivilegeRegistry.Listener#privilegesRegistered(java.util.Set
+     * @param privilegeNames
-    public void privilegeRegistered(Name privilegeName) {
+    public void privilegesRegistered(Set<Name> privilegeNames) {
-        private final PrivilegeRegistry.Definition definition;
+        private final PrivilegeDefinition definition;
-        private PrivilegeImpl(PrivilegeRegistry.Definition definition) throws RepositoryException {
+        private PrivilegeImpl(PrivilegeDefinition definition) throws RepositoryException {
-            Name[] declAggrNames = definition.getDeclaredAggregateNames();
+            Set<Name> set = definition.getDeclaredAggregateNames();
+            Name[] declAggrNames = set.toArray(new Name[set.size()]);
