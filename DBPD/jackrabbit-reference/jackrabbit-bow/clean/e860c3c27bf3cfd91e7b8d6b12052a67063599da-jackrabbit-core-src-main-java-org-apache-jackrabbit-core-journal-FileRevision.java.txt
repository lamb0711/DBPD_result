JCR-1358 - Cluster revision file not closed on repository shutdown


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@617541 13f79535-47bb-0310-9956-ffa450edef68

+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
+     * Logger.
+     */
+    private static final Logger log = LoggerFactory.getLogger(FileRevision.class);
+
+    /**
+    
+    /**
+     * Flag indicating whether this revision file is closed.
+     */
+    private boolean closed;
-            throw new JournalException(
-                    "I/O error while attempting to create new file '" + file + "'.", e);
+            String msg = "I/O error while attempting to create new file '" + file + "'.";
+            throw new JournalException(msg, e);
+            if (closed) {
+                throw new JournalException("Revision file closed.");
+            }
+            if (closed) {
+                throw new JournalException("Revision file closed.");
+            }
-
+    
+    /**
+     * Close file revision. Closes underlying random access file.
+     */
+    public synchronized void close() {
+        try {
+            raf.close();
+            closed = true;
+        } catch (IOException e) {
+            log.warn("I/O error closing revision file.", e);
+        }
+    }
