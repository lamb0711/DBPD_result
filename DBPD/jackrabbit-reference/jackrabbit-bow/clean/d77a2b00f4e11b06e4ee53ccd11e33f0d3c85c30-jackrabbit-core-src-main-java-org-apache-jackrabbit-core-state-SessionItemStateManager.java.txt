JCR-1359: Adding nodes from concurrently running sessions cause exceptions

- added synchronization to NodeStateMerger.merge method
- fixed @todo issue in NodeStateMerger.merge method (checking node type sameNameSibling setting)
- enabling execution of ConcurrentNodeModificationTest

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@634681 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.nodetype.NodeTypeRegistry;
+import org.apache.jackrabbit.core.nodetype.NodeDef;
+     * Node Type Registry
+     */
+    private final NodeTypeRegistry ntReg;
+
+    /**
+     * @param ntReg node type registry
-                                   PathResolver resolver) {
+                                   PathResolver resolver,
+                                   NodeTypeRegistry ntReg) {
+
+        this.ntReg = ntReg;
+
+                                public boolean allowsSameNameSiblings(NodeId id) {
+                                    NodeState ns;
+                                    try {
+                                        ns = (NodeState) getItemState(id);
+                                    } catch (ItemStateException e) {
+                                        return false;
+                                    }
+                                    NodeDef def = ntReg.getNodeDef(ns.getDefinitionId());
+                                    return def != null ? def.allowsSameNameSiblings() : false;
+                                }
