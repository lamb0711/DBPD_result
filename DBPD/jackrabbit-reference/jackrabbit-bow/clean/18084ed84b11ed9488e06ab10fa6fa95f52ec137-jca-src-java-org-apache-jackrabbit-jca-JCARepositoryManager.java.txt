JCR-366 Allow o.a.j.jca.JCARepositoryManager to load repository configuration from the classpath.
JCR-462 Improve lifecycle management of JCA connector
JCR-460 Add RAR META-INF/ra.xml descriptor to be used with JCA1.5
- add respository.xml to maven resources
- change jboss deployment descriptor to load config file from the classpath.
- move jca 1.0 descriptor. jca 1.5 descriptor as default.


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@414709 13f79535-47bb-0310-9956-ffa450edef68

+
+import java.io.InputStream;
+import java.util.Collection;
+import java.util.Iterator;
+	
+    /** The config file prefix that signifies the file is to be loaded from the classpath. */
+    public static final String CLASSPATH_CONFIG_PREFIX = "classpath:";
+    
+    /**
+     * Flag indicating that the life cycle 
+     * of the resource is not managed by the
+     * application server 
+     */
+    private boolean autoShutdown = true ;
-     * Shutdown the repository.
+     * Shutdown all the repositories.
-    public void shutdownRepository(String homeDir, String configFile) {
-        Reference ref = getReference(homeDir, configFile);
-        ref.shutdown();
+    public void shutdown() {
+    	Collection references = this.references.values() ;
+    	Iterator iter = references.iterator() ;
+    	while (iter.hasNext()) {
+			Reference ref = (Reference) iter.next();
+			ref.shutdown();	
+		}
+        this.references.clear();
+    
-        private final String configFile;
+        private String configFile;
-         * Reference count.
-         */
-        private int count;
-
-        /**
-            this.count = 0;
-                RepositoryConfig config = RepositoryConfig.create(configFile, homeDir);
+                RepositoryConfig config = null;
+
+                if (configFile.startsWith(CLASSPATH_CONFIG_PREFIX)) {
+                    ClassLoader cl = Thread.currentThread().getContextClassLoader();
+                    if (cl == null) {
+                        cl = this.getClass().getClassLoader();
+                    }
+                    
+                    InputStream configInputStream = cl.getResourceAsStream(
+                        configFile.substring(CLASSPATH_CONFIG_PREFIX.length()));
+                    config = RepositoryConfig.create(configInputStream, homeDir);
+                } else {
+                    config = RepositoryConfig.create(configFile, homeDir);
+                }
-            count++;
-            if (count > 0) {
-                count--;
-
-                if (count == 0) {
-                    repository.shutdown();
-                    repository = null;
-                }
-            }
+	        repository.shutdown();
+
+	public boolean isAutoShutdown() {
+		return autoShutdown;
+	}
+
+	public void setAutoShutdown(boolean autoShutdown) {
+		this.autoShutdown = autoShutdown;
+	}
+
+	/**
+	 * Try to shutdown the repository only if
+	 * {@link JCARepositoryManager#autoShutdown} is true.
+	 */
+	public void autoShutdownRepository(String homeDir, String configFile) {
+		if (this.isAutoShutdown()) {
+		    Reference ref = getReference(homeDir, configFile);
+		    ref.shutdown();
+		}
+	}
