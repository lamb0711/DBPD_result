JCR-3842: [jackrabbit-aws-ext] Support encryption in S3Datastore
Patch from Shashank Gupta

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1665149 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.aws.ext.S3RequestDecorator;
+    private S3RequestDecorator s3ReqDecorator;
+
+            s3ReqDecorator = new S3RequestDecorator(prop);
+
-                    Copy copy = tmx.copy(copReq);
+                    Copy copy = tmx.copy(s3ReqDecorator.decorate(copReq));
-                Copy copy = tmx.copy(copReq);
+                Copy copy = tmx.copy(s3ReqDecorator.decorate(copReq));
-        tmx.abortMultipartUploads(bucket, startTime);
+        if(s3service.doesBucketExist(bucket)) {
+            tmx.abortMultipartUploads(bucket, startTime);
+        }
-                Copy copy = tmx.copy(copReq);
+                Copy copy = tmx.copy(s3ReqDecorator.decorate(copReq));
-                    Upload up = tmx.upload(new PutObjectRequest(bucket, key,
-                        file));
+                    Upload up = tmx.upload(s3ReqDecorator.decorate(new PutObjectRequest(
+                        bucket, key, file)));
-            ObjectListing prevObjectListing = s3service.listObjects(bucket,
-                KEY_PREFIX);
+            ObjectListing prevObjectListing = s3service.listObjects(bucket);
-                    deleteList.add(new DeleteObjectsRequest.KeyVersion(
-                        s3ObjSumm.getKey()));
+                    // delete the object if it follows old key name format
+                    if( s3ObjSumm.getKey().startsWith(KEY_PREFIX)) {
+                        deleteList.add(new DeleteObjectsRequest.KeyVersion(
+                            s3ObjSumm.getKey()));
+                    }
-            throw new IllegalArgumentException("[" + oldKey
-                + "] doesn't start with prefix [" + KEY_PREFIX + "]");
+            return oldKey;
-                Copy copy = tmx.copy(copReq);
+                Copy copy = tmx.copy(s3ReqDecorator.decorate(copReq));
-               
-
-    
