JCR-898: Improve excerpt fragments

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@535792 13f79535-47bb-0310-9956-ffa450edef68

+        int firstWhitespace;
+            fi.trim();
-            skippedChars = 0;
+            skippedChars = Math.max(cbuf.length - 1, 0);
+            firstWhitespace = skippedChars;
-            // find first whitespace
-            for (; skippedChars < cbuf.length; skippedChars++) {
-                if (Character.isWhitespace(cbuf[skippedChars])) {
-                    skippedChars += 1;
-                    break;
+            // find last period followed by whitespace
+            if (cbuf.length > 0) {
+                for (; skippedChars >= 0; skippedChars--) {
+                    if (Character.isWhitespace(cbuf[skippedChars])) {
+                        firstWhitespace = skippedChars;
+                        if (skippedChars - 1 >= 0 &&
+                                cbuf[skippedChars - 1] == '.') {
+                            skippedChars++;
+                            break;
+                        }
+                    }
+                }
+            }
+            boolean sentenceStart = true;
+            if (skippedChars == -1) {
+                if (pos == cbuf.length) {
+                    // this fragment is the start of the text -> skip none
+                    skippedChars = 0;
+                } else {
+                    sentenceStart = false;
+                    skippedChars = firstWhitespace + 1;
+            if (!sentenceStart) {
+                sb.append("... ");
+            }
+                char lastChar = sb.charAt(sb.length() - 1);
+                if (lastChar != '.' && lastChar != '!' && lastChar != '?') {
+                    sb.append(" ...");
+                }
+
+        public void trim() {
+            int end = startOffset + (mergeGap / 2);
+            for (Iterator it = offsetInfosList.iterator(); it.hasNext(); ) {
+                TermVectorOffsetInfo tvoi = (TermVectorOffsetInfo) it.next();
+                if (tvoi.getStartOffset() > end) {
+                    it.remove();
+                }
+            }
+        }
