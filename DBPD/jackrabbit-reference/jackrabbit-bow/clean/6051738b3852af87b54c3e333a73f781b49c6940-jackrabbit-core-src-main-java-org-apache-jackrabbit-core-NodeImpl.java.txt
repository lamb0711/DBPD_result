JCR-2740 On missing child node, automatically remove the entry

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1040601 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.state.ItemStateManager;
-     * @deprecated use #renameChildNode(NodeId, Name, boolean) 
+     * @deprecated use #renameChildNode(NodeId, Name, boolean)
-        NodeImpl childNode = itemMgr.getNode(childId, getNodeId());
-        childNode.onRemove(getNodeId());
+        try {
+            NodeImpl childNode = itemMgr.getNode(childId, getNodeId());
+            childNode.onRemove(getNodeId());
+        } catch (ItemNotFoundException e) {
+            boolean ignoreError = false;
+            if (sessionContext.getSessionImpl().autoFixCorruptions()) {
+                // it might be an access right problem
+                // we need to check if the item doesn't exist in the ism
+                ItemStateManager ism = sessionContext.getItemStateManager();
+                if (!ism.hasItemState(childId)) {
+                    log.warn("Node " + childId + " not found, ignore", e);
+                    ignoreError = true;
+                }
+            }
+            if (!ignoreError) {
+                throw e;
+            }
+        }
-                NodeImpl childNode = itemMgr.getNode(childId, getNodeId());
-                childNode.onRemove(thisState.getNodeId());
-                // remove the child node entry
+                try {
+                    NodeImpl childNode = itemMgr.getNode(childId, getNodeId());
+                    childNode.onRemove(thisState.getNodeId());
+                    // remove the child node entry
+                } catch (ItemNotFoundException e) {
+                    boolean ignoreError = false;
+                    if (parentId != null && sessionContext.getSessionImpl().autoFixCorruptions()) {
+                        // it might be an access right problem
+                        // we need to check if the item doesn't exist in the ism
+                        ItemStateManager ism = sessionContext.getItemStateManager();
+                        if (!ism.hasItemState(childId)) {
+                            log.warn("Child named " + entry.getName() + " (index " + entry.getIndex() + ", " +
+                                    "node id " + childId + ") " +
+                                    "not found when trying to remove " + getPath() + " " +
+                                    "(node id " + getNodeId() + ") - ignored", e);
+                            ignoreError = true;
+                        }
+                    }
+                    if (!ignoreError) {
+                        throw e;
+                    }
+                }
-        
+
-                return new LazyItemIterator(itemMgr, idList);
+                return new LazyItemIterator(sessionContext, idList);
