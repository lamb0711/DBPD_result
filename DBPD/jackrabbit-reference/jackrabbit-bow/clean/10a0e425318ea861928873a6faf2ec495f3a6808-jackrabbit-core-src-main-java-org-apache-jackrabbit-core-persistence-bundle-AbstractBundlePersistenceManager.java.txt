JCR-1117 Bundle cache is not rolled back when the storage of a ChangeLog fails

- Applied third version of the patch.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@749237 13f79535-47bb-0310-9956-ffa450edef68

+        boolean success = false;
+        try {
+            storeInternal(changeLog);
+            success = true;
+        } finally {
+            if (!success) {
+                bundles.clear();
+                missing.clear();
+            }
+        }
+    }
+
+    /**
+     * Stores the given changelog and updates the bundle cache.
+     * 
+     * @param changeLog the changelog to store
+     * @throws ItemStateException on failure
+     */
+    private void storeInternal(ChangeLog changeLog)
+            throws ItemStateException {
