JCR-3537: Large number of SQL queries when adding nodes with version history
(patch provided by Todd Pagni)

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1464605 13f79535-47bb-0310-9956-ffa450edef68

+        store(true);
+    }
+
+    /**
+     * Stores the persistent state and depending on the <code>recursively</code>
+     * flag also stores the modified child nodes recursively.
+     *
+     *
+     * @param recursively whether to store the nodes recursively or just this
+     *                    single node.
+     * @throws RepositoryException if an error occurs
+     */
+    public void store(boolean recursively) throws RepositoryException {
-            store(nodeState);
+            store(nodeState, recursively);
-    private void store(NodeState state)
+    private void store(NodeState state, boolean recursively)
-            // now store all child node entries
-            for (ChildNodeEntry entry : state.getChildNodeEntries()) {
-                NodeState nstate = (NodeState) stateMgr.getItemState(entry.getId());
-                store(nstate);
+            if (recursively) {
+                // now store all child node entries
+                for (ChildNodeEntry entry : state.getChildNodeEntries()) {
+                    NodeState nstate = (NodeState) stateMgr.getItemState(entry.getId());
+                    store(nstate, true);
+                }
