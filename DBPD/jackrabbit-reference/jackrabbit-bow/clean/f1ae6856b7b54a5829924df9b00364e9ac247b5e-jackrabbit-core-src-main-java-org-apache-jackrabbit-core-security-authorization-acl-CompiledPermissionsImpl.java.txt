JCR-2841 - Avoid path resolution in case of non-wildcard ACEs (follow-up to JCR-2573)

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1049520 13f79535-47bb-0310-9956-ffa450edef68

-        boolean canRead;
+        boolean canRead = false;
-                // TODO: check again if retrieving the path can be avoided
-                Path absPath = (path == null) ? session.getHierarchyManager().getPath(id) : path;
-                Result result = buildResult(node, isExistingNode, util.isAcItem(node), new EntryFilterImpl(principalNames, absPath, session));
-                canRead = result.grants(Permission.READ);
+                boolean isAcItem = util.isAcItem(node);
+                EntryFilterImpl filter;
+                if (path == null) {
+                    filter = new EntryFilterImpl(principalNames, id, session);
+                } else {
+                    filter = new EntryFilterImpl(principalNames, path, session);
+                }
+
+                if (isAcItem) {
+                    /* item defines ac content -> regular evaluation */
+                    Result result = buildResult(node, isExistingNode, util.isAcItem(node), filter);
+                    canRead = result.grants(Permission.READ);
+                } else {
+                    /*
+                     simplified evaluation focusing on READ permission. this allows
+                     to omit evaluation of parent node permissions that are
+                     required when calculating the complete set of permissions
+                     (see special treatment of remove, create or ac-specific
+                      permissions).
+                     */
+                    for (AccessControlEntry accessControlEntry : entryCollector.collectEntries(node, filter)) {
+                        ACLTemplate.Entry ace = (ACLTemplate.Entry) accessControlEntry;
+                        int entryBits = ace.getPrivilegeBits();
+                        if ((entryBits & Permission.READ) == Permission.READ) {
+                            canRead = ace.isAllow();
+                            break;
+                        }
+                    }
+                }
