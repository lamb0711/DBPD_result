JCR-160: Query index not in sync with workspace
- Log warning if index detects duplicate entries for a node
- Not all multiple entries in index are removed on repair

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@219683 13f79535-47bb-0310-9956-ffa450edef68

-     * Deletes documents that match the <code>idTerm</code>.
+     * Deletes the first document that matches the <code>idTerm</code>.
-     * @param idTerm documents that match this term will be deleted.
+     * @param idTerm document that match this term will be deleted.
-     * @throws IOException if an error occurs while deleting documents.
+     * @throws IOException if an error occurs while deleting the document.
+     * Deletes all documents that match the <code>idTerm</code> and immediately
+     * commits the changes to the persistent indexes.
+     *
+     * @param idTerm documents that match this term will be deleted.
+     * @return the number of deleted documents.
+     * @throws IOException if an error occurs while deleting documents.
+     */
+    synchronized int removeAllDocuments(Term idTerm) throws IOException {
+        // flush multi reader if it does not have deletions yet
+        if (multiReader != null && !multiReader.hasDeletions()) {
+            multiReader = null;
+        }
+        int num = volatileIndex.removeDocument(idTerm);
+        for (int i = 0; i < indexes.size(); i++) {
+            PersistentIndex index = (PersistentIndex) indexes.get(i);
+            num += index.removeDocument(idTerm);
+            index.commit();
+        }
+        return num;
+    }
+
+    /**
