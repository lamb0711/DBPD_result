JCR-3066: Use only one scheduler for repository tasks

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1169801 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.concurrent.ScheduledExecutorService;
+import java.util.concurrent.ScheduledFuture;
+import java.util.concurrent.TimeUnit;
-import org.apache.jackrabbit.util.Timer;
-    private long lastFlushTime;
+    private long lastFlushTime = 0;
-    private final Timer.Task flushTask;
+    private ScheduledFuture<?> flushTask = null;
-        flushTask = new Timer.Task() {
-            public void run() {
-                // check if there are any indexing jobs finished
-                checkIndexingQueue(false);
-                // check if volatile index should be flushed
-                checkFlush();
-            }
-        };
-
-            flushTask.cancel();
+            unscheduleFlushTask();
+    /**
+     * Schedules a background task for flushing the index once per second.
+     */
-        lastFlushTime = System.currentTimeMillis();
-        handler.getContext().getTimer().schedule(flushTask, 0, 1000);
+        ScheduledExecutorService executor = handler.getContext().getExecutor();
+        flushTask = executor.scheduleWithFixedDelay(new Runnable() {
+            public void run() {
+                // check if there are any indexing jobs finished
+                checkIndexingQueue(false);
+                // check if volatile index should be flushed
+                checkFlush();
+            }
+        }, 1, 1, TimeUnit.SECONDS);
+    }
+
+    /**
+     * Cancels the scheduled background index flush task.
+     */
+    private void unscheduleFlushTask() {
+        if (flushTask != null) {
+            flushTask.cancel(false);
+            flushTask = null;
+        }
