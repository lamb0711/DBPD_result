JCR-2168 Avoid premature publication of XAItemStateManager

* Replaced public constructors by a factory methods and moved the registration to the fcatory method.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@789257 13f79535-47bb-0310-9956-ffa450edef68

-     * Creates a new instance of this class.
-     *
-     * @param sharedStateMgr shared state manager
-     * @param factory        event state collection factory
-     */
-    public XAItemStateManager(SharedItemStateManager sharedStateMgr,
-                              EventStateCollectionFactory factory, ItemStateCacheFactory cacheFactory) {
-        this(sharedStateMgr, factory, DEFAULT_ATTRIBUTE_NAME, cacheFactory);
-    }
-
-    /**
-     * @param attributeName  attribute name
+     * @param attributeName  the attribute name, if {@code null} then a default name is used
-    public XAItemStateManager(SharedItemStateManager sharedStateMgr,
+    private XAItemStateManager(SharedItemStateManager sharedStateMgr,
+        if (attributeName != null) {
+            this.attributeName = attributeName;
+        } else {
+            this.attributeName = DEFAULT_ATTRIBUTE_NAME;
+        }
+    }
-        this.attributeName = attributeName;
+    /**
+     * Creates a new {@code XAItemStateManager} instance and registers it as an {@link ItemStateListener}
+     * with the given {@link SharedItemStateManager}. 
+     * 
+     * @param sharedStateMgr the {@link SharedItemStateManager}
+     * @param factory the {@link EventStateCollectionFactory}
+     * @param attributeName the attribute name, if {@code null} then a default name is used
+     * @param cacheFactory the {@link ItemStateCacheFactory}
+     * @return a new {@code XAItemStateManager} instance
+     */
+    public static XAItemStateManager createInstance(SharedItemStateManager sharedStateMgr,
+            EventStateCollectionFactory factory, String attributeName, ItemStateCacheFactory cacheFactory) {
+        XAItemStateManager mgr = new XAItemStateManager(sharedStateMgr, factory, attributeName, cacheFactory);
+        sharedStateMgr.addListener(mgr);
+        return mgr;
