JCR-708: SearchManager might throw when handling cluster event


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@496271 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Map;
+import java.util.HashMap;
-        final Set addedNodes = new HashSet();
+        final Map addedNodes = new HashMap();
-                addedNodes.add(e.getChildId());
+                addedNodes.put(e.getChildId(), e);
-            EventImpl event = (EventImpl) propEvents.get(i);
-            NodeId nodeId = event.getParentId();
-            if (event.getType() == Event.PROPERTY_ADDED) {
-                if (addedNodes.add(nodeId)) {
+            EventImpl e = (EventImpl) propEvents.get(i);
+            NodeId nodeId = e.getParentId();
+            if (e.getType() == Event.PROPERTY_ADDED) {
+                if (addedNodes.put(nodeId, e) == null) {
-            } else if (event.getType() == Event.PROPERTY_CHANGED) {
+            } else if (e.getType() == Event.PROPERTY_CHANGED) {
-                addedNodes.add(nodeId);
+                addedNodes.put(nodeId, e);
-                addedNodes.add(nodeId);
+                addedNodes.put(nodeId, e);
-            private final Iterator iter = addedNodes.iterator();
+            private final Iterator iter = addedNodes.keySet().iterator();
-                } catch (ItemStateException e) {
-                    log.error("Unable to index node " + id + ": does not exist");
+                } catch (ItemStateException ise) {
+                    // check whether this item state change originated from
+                    // an external event
+                    EventImpl e = (EventImpl) addedNodes.get(id);
+                    if (e == null || !e.isExternal()) {
+                        log.error("Unable to index node " + id + ": does not exist");
+                    } else {
+                        log.info("Node no longer available " + id + ", skipped.");
+                    }
