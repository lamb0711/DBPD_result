JCR-1588 - JSR 283: Access Control (work in progress)
JCR-1590 - JSR 283: Locking
JCR-1915 - Node.setPrimaryNodeType should only redefine child-definitions that are not covered by the new effective nt
JCR-1875 - Failing Node.unlock() might leave inconsistent transient state
JCR-538 - Failing Node.checkin() or Node.checkout() might leave inconsistent transient state

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@732693 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.ItemManager;
+import org.apache.jackrabbit.core.ItemManager;
-import org.apache.jackrabbit.core.SessionImpl;
-import org.apache.jackrabbit.spi.commons.conversion.NameException;
+import org.apache.jackrabbit.core.SessionImpl;
+import org.apache.jackrabbit.core.security.authorization.Permission;
+import org.apache.jackrabbit.spi.commons.conversion.NameException;
+import javax.jcr.InvalidItemStateException;
+import javax.jcr.NodeIterator;
-import javax.jcr.NodeIterator;
-import javax.jcr.InvalidItemStateException;
+import javax.jcr.ItemNotFoundException;
-     * @param id node id
-     * @param state node state
-     * @param definition node definition
-     * @param listeners life cycle listeners
+     * @param data
+            // check permissions
+            checkVersionManagementPermission();
-            Version existing = session.getVersionManager().setVersionLabel(
-                    this, null, session.getQName(label), true);
+            // check permissions
+            checkVersionManagementPermission();
+            Version existing = session.getVersionManager().setVersionLabel(this, null, session.getQName(label), true);
-            session.getVersionManager().removeVersion(
-                    this, session.getQName(versionName));
+            // check permissions
+            checkVersionManagementPermission();
+            session.getVersionManager().removeVersion(this, session.getQName(versionName));
+     * 
+     * @return
+     * @throws RepositoryException
+     */
+    private void checkVersionManagementPermission() throws RepositoryException {
+        try {
+            session.getAccessManager().checkPermission(getPrimaryPath(), Permission.VERSION_MNGMT);
+        } catch (ItemNotFoundException e) {
+            // ignore.
+        }
+    }
+    
+    /**
