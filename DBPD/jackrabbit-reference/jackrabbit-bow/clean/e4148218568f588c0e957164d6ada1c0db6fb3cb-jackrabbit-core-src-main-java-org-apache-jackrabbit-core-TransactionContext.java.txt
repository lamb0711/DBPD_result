JCR-3425 XAAwareRWLock implementation fails with IllegalStateException on JBoss AS7

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1389741 13f79535-47bb-0310-9956-ffa450edef68

-    public static Xid getCurrentXid() {
+    private static Xid getCurrentXid() {
-     * current thread instance or the global transaction identifier when
-     * running under a transaction.
+     * current thread instance or the global transaction identifier wrapped 
+     * in a {@link XidWrapper}, when running under a transaction.
-            return xid.getGlobalTransactionId();
+            return new XidWrapper(xid.getGlobalTransactionId());
-        } else if (a instanceof byte[] && b instanceof byte[]) {
-            return Arrays.equals((byte[]) a, (byte[]) b);
+        } else if (a != null) {
+        	return a.equals(b);
+    
+    /**
+     * Wrapper around a global transaction id (byte[]) 
+     * that handles hashCode and equals in a proper way.
+     */
+    private static class XidWrapper {
+    	private byte[] gtid;
+    	
+    	public XidWrapper(byte[] gtid) {
+    		this.gtid = gtid;
+    	}
+
+        @Override
+        public boolean equals(Object other) {
+            if (!(other instanceof XidWrapper)) {
+                return false;
+            }
+            return Arrays.equals((byte[]) gtid, ((XidWrapper)other).gtid);
+        }
+
+        @Override
+        public int hashCode() {
+            return Arrays.hashCode(gtid);
+        }
+    }
