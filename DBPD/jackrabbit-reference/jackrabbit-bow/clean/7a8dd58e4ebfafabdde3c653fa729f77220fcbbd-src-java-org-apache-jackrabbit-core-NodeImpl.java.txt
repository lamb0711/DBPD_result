- fixing tests

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@158101 13f79535-47bb-0310-9956-ffa450edef68

-        // check state of this instance
+        // checks
-
-        // check for pending changes
-        if (session.hasPendingChanges()) {
-            String msg = "Unable to restore version. Session has pending changes.";
-            log.debug(msg);
-            throw new InvalidItemStateException(msg);
-        }
-
-        // check lock status
+        checkSessionHasPending();
-        // check state of this instance
+
+        // do checks
-
-        // check for pending changes
-        if (session.hasPendingChanges()) {
-            String msg = "Unable to restore version. Session has pending changes.";
-            log.debug(msg);
-            throw new InvalidItemStateException(msg);
-        }
-
-        // check lock status
+        checkSessionHasPending();
+        checkVersionable();
-        // check state of this instance
+
+        // do checks
-
-        // check for pending changes
-        if (session.hasPendingChanges()) {
-            String msg = "Unable to restore version. Session has pending changes.";
-            log.debug(msg);
-            throw new InvalidItemStateException(msg);
-        }
-
-        // check lock status
+        checkSessionHasPending();
-        // check state of this instance
+
+        // do checks
-
-        // check for pending changes
-        if (session.hasPendingChanges()) {
-            String msg = "Unable to restore version. Session has pending changes.";
-            log.debug(msg);
-            throw new InvalidItemStateException(msg);
-        }
-
-        // check lock status
+        checkSessionHasPending();
+     * Checks if this nodes session has pending changes.
+     *
+     * @throws InvalidItemStateException if this nodes session has pending changes
+     * @throws RepositoryException
+     */
+    private void checkSessionHasPending() throws RepositoryException {
+        // check for pending changes
+        if (session.hasPendingChanges()) {
+            String msg = "Unable to perform operation. Session has pending changes.";
+            log.debug(msg);
+            throw new InvalidItemStateException(msg);
+        }
+
+
+    }
+
+    /**
-        while (m1.getDepth() != 0 && !m1.isNodeType(MIX_REFERENCEABLE)) {
+        while (!m1.isNodeType(MIX_REFERENCEABLE)) {
+            if (m1.getDepth() == 0) {
+                // root node
+                try {
+                    return (NodeImpl) srcSession.getItem(getPath());
+                } catch (PathNotFoundException e) {
+                    return null;
+                }
+            }
-        // check state of this instance
+        // do checks
-
-        // check for pending changes
-        if (session.hasPendingChanges()) {
-            String msg = "Unable to " + (update ? "update" : "merge") + " node. Session has pending changes.";
-            log.debug(msg);
-            throw new InvalidItemStateException(msg);
-        }
+        checkSessionHasPending();
