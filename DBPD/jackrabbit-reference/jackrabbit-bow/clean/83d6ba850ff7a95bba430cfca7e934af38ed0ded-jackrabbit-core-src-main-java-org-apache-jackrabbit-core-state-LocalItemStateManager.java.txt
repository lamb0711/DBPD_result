JCR-2168 Avoid premature publication of XAItemStateManager

* Replaced public constructors by a factory methods and moved the registration to the fcatory method.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@789257 13f79535-47bb-0310-9956-ffa450edef68

-    public LocalItemStateManager(SharedItemStateManager sharedStateMgr,
+    protected LocalItemStateManager(SharedItemStateManager sharedStateMgr,
+    }
-        sharedStateMgr.addListener(this);
+    /**
+     * Creates a new {@code LocalItemStateManager} instance and registers it as an {@link ItemStateListener}
+     * with the given {@link SharedItemStateManager}. 
+     * 
+     * @param sharedStateMgr the {@link SharedItemStateManager}
+     * @param factory the {@link EventStateCollectionFactory}
+     * @param cacheFactory the {@link ItemStateCacheFactory}
+     * @return a new {@code LocalItemStateManager} instance
+     */
+    public static LocalItemStateManager createInstance(SharedItemStateManager sharedStateMgr,
+            EventStateCollectionFactory factory, ItemStateCacheFactory cacheFactory) {
+        LocalItemStateManager mgr = new LocalItemStateManager(sharedStateMgr, factory, cacheFactory);
+        sharedStateMgr.addListener(mgr);
+        return mgr;
