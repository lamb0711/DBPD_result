JCR-2946 - Improve implementation of DavResource#getProperty(DavPropertyName)
JCR-2948 - Add possibility to PROPFIND the JCR_NODETYPES_CND_LN property

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1155296 13f79535-47bb-0310-9956-ffa450edef68

-        // only property names requested
-            PropContainer status200 =
-                getPropContainer(DavServletResponse.SC_OK, true);
+            // only property names requested
+            PropContainer status200 = getPropContainer(DavServletResponse.SC_OK, true);
-        // all or a specified set of property and their values requested.
-            PropContainer status200 =
-                getPropContainer(DavServletResponse.SC_OK, false);
+            // all or a specified set of property and their values requested.
+            PropContainer status200 = getPropContainer(DavServletResponse.SC_OK, false);
-            Set<DavPropertyName> missing =
-                new HashSet<DavPropertyName>(propNameSet.getContent());
+            Set<DavPropertyName> missing = new HashSet<DavPropertyName>(propNameSet.getContent());
-            // or non-protected properties plus requested properties
-            // (allprop/include) 
+            // or non-protected properties plus requested properties (allprop/include) 
+                // add explicitly requested properties (proptected or non-protected)
+                // add all non-protected properties
+
+                // try if missing properties specified in the include section
+                // can be obtained using resource.getProperty
+                if (propFindType == PROPFIND_ALL_PROP_INCLUDE && !missing.isEmpty()) {
+                    for (DavPropertyName propName : new HashSet<DavPropertyName>(missing)) {
+                        DavProperty<?> prop = resource.getProperty(propName);
+                        if (prop != null) {
+                            status200.addContent(prop);
+                            missing.remove(propName);
+                        }
+                    }
+                }
-                PropContainer status404 =
-                    getPropContainer(DavServletResponse.SC_NOT_FOUND, true);
+                PropContainer status404 = getPropContainer(DavServletResponse.SC_NOT_FOUND, true);
