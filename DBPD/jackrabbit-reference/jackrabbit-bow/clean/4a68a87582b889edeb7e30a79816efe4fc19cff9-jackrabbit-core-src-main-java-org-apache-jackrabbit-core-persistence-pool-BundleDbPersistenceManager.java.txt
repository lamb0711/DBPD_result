JCR-3185: refactor consistency checks in BundleDBPersistenceManager into a standalone class that could be re-used for other PMs

in consistency check, only use BundlePm APIs (work-in-progress)

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1220845 13f79535-47bb-0310-9956-ffa450edef68

-                    ResultSet rs = null;
-                        rs = conHelper.exec(bundleSelectSQL, getKey(id), false, 0);
-                        if (!rs.next()) {
-                            throw new SQLException("bundle cannot be retrieved?");
-                        }
-                        NodePropBundle bundle = readBundle(id, rs, 1);
-                        checkBundleConsistency(id, bundle, fix, modifications, reports);
-                    } catch (SQLException e) {
-                        log.error("Unable to parse bundle " + id, e);
-                    } finally {
-                        DbUtility.close(rs);
+                        NodePropBundle bundle = loadBundle(id);
+                        if (bundle == null) {
+                            log.error("No bundle found for id '" + id + "'");
+                        } else {
+                            checkBundleConsistency(id, bundle, fix, modifications, reports);
+
+                            count++;
+                            if (count % 1000 == 0) {
+                                log.info(name + ": checked " + count + "/" + total + " bundles...");
+                            }
+                        }
+                    } catch (ItemStateException e) {
+                        // problem already logged (loadBundle called with
+                        // logDetailedErrors=true)
-                    count++;
-                    if (count % 1000 == 0) {
-                        log.info(name + ": checked " + count + "/" + total + " bundles...");
-                    }
-                        continue;
+                    else {
+                        checkBundleConsistency(id, bundle, fix, modifications, reports);
-                    checkBundleConsistency(id, bundle, fix, modifications, reports);
-
-                    if (recursive) {
-                        for (NodePropBundle.ChildNodeEntry entry : bundle.getChildNodeEntries()) {
-                            idList.add(entry.getId());
+                        if (recursive) {
+                            for (NodePropBundle.ChildNodeEntry entry : bundle.getChildNodeEntries()) {
+                                idList.add(entry.getId());
+                            }
-                    }
-                    count++;
-                    if (count % 1000 == 0) {
-                        log.info(name + ": checked " + count + "/" + idList.size() + " bundles...");
+                        count++;
+                        if (count % 1000 == 0) {
+                            log.info(name + ": checked " + count + "/" + idList.size() + " bundles...");
+                        }
