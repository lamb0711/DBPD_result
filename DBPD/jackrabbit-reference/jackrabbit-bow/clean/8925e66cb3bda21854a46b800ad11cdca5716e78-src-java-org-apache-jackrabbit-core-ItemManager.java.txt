- added 'multiValued' flag to ProperyState
- misc. minor fixes and java doc corrections

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@106895 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.nodetype.PropDefId;
+import org.apache.jackrabbit.core.nodetype.NodeDefId;
+    private NodeDef getDefinition(NodeState state)
+            throws RepositoryException {
+        NodeDefId defId = state.getDefinitionId();
+        NodeDef def = session.getNodeTypeManager().getNodeDef(defId);
+        if (def == null) {
+            log.warn("node at " + safeGetJCRPath(state.getId()) + " has invalid definitionId (" + defId + ")");
+
+            // fallback: try finding applicable definition
+            NodeId parentId = new NodeId(state.getParentUUID());
+            NodeImpl parent = (NodeImpl) getItem(parentId);
+            NodeState parentState = (NodeState) parent.getItemState();
+            NodeState.ChildNodeEntry cne = (NodeState.ChildNodeEntry) parentState.getChildNodeEntries(state.getUUID()).get(0);
+            def = parent.getApplicableChildNodeDef(cne.getName(), state.getNodeTypeName());
+        }
+        return def;
+    }
+
+    private PropertyDef getDefinition(PropertyState state)
+            throws RepositoryException {
+        PropDefId defId = state.getDefinitionId();
+        PropertyDef def = session.getNodeTypeManager().getPropDef(defId);
+        if (def == null) {
+            log.warn("property at " + safeGetJCRPath(state.getId()) + " has invalid definitionId (" + defId + ")");
+
+            // fallback: try finding applicable definition
+            NodeId parentId = new NodeId(state.getParentUUID());
+            NodeImpl parent = (NodeImpl) getItem(parentId);
+            def = parent.getApplicablePropertyDef(state.getName(), state.getType(), state.isMultiValued());
+        }
+        return def;
+    }
+
-
-        // check spezial nodes
+        // check special nodes
-        NodeDef def = session.getNodeTypeManager().getNodeDef(state.getDefinitionId());
-        if (def == null) {
-            String msg = "internal error: no definition found for node " + safeGetJCRPath(state.getId());
-            log.error(msg);
-            throw new RepositoryException(msg);
-        }
+        NodeDef def = getDefinition(state);
-        PropertyDef def = session.getNodeTypeManager().getPropDef(state.getDefinitionId());
-        if (def == null) {
-            String msg = "internal error: no definition found for property " + safeGetJCRPath(state.getId());
-            log.error(msg);
-            throw new RepositoryException(msg);
-        }
+        PropertyDef def = getDefinition(state);
