work in progress

- reorder: wrong usage of OrderPatch
- reorder: missing check for 'before' being null
- reorder: affected-items in op. not consistent with modified items
- move: session.move must remember srcId 
- spi: add possibility to obtain sessionInfo for another workspace based on an existing sessionInfo.
- uriresolver: defensive check for type of ItemId

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@464431 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.webdav.ordering.OrderingConstants;
-    public SessionInfo obtain(Credentials credentials, String workspaceName) throws LoginException, NoSuchWorkspaceException, RepositoryException {
+    public SessionInfo obtain(Credentials credentials, String workspaceName)
+        throws LoginException, NoSuchWorkspaceException, RepositoryException {
+        CredentialsWrapper dc = new CredentialsWrapper(credentials);
+        return obtain(dc, workspaceName);
+    }
+
+    public SessionInfo obtain(SessionInfo sessionInfo, String workspaceName)
+        throws LoginException, NoSuchWorkspaceException, RepositoryException {
+        checkSessionInfo(sessionInfo);
+        return obtain(((SessionInfoImpl)sessionInfo).getCredentials(), workspaceName);
+    }
+
+    private SessionInfo obtain(CredentialsWrapper credentials, String workspaceName)
+        throws LoginException, NoSuchWorkspaceException, RepositoryException {
-            CredentialsWrapper dc = new CredentialsWrapper(credentials);
-            getClient(dc.getCredentials()).executeMethod(method);
+            getClient(credentials.getCredentials()).executeMethod(method);
-                return new SessionInfoImpl(dc, workspaceName, new SubscriptionMgrImpl());
+                return new SessionInfoImpl(credentials, workspaceName, new SubscriptionMgrImpl());
+                String uri = getItemUri(parentId, sessionInfo);
-                String targetSegment = Text.getName(getItemUri(beforeNodeId, sessionInfo), true);
-                String uri = getItemUri(parentId, sessionInfo);
-                OrderPatchMethod method = new OrderPatchMethod(uri, srcSegment, targetSegment, true);
-
+                OrderPatchMethod method;
+                if (beforeNodeId == null) {
+                    // move src to the end
+                    method = new OrderPatchMethod(uri, OrderingConstants.ORDERING_TYPE_CUSTOM, srcSegment, false);
+                } else {
+                    // insert src before the targetSegment
+                    String beforeUri = getItemUri(beforeNodeId, sessionInfo);
+                    String targetSegment = Text.getName(beforeUri, true);
+                    method = new OrderPatchMethod(uri, OrderingConstants.ORDERING_TYPE_CUSTOM, srcSegment, targetSegment, true);
+                }
