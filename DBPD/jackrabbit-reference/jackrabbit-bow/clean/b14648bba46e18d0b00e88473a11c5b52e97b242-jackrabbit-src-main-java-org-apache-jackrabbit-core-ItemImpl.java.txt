Restore of transient items after a unsuccessful save() failed when same item
was already in attic space.


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@368735 13f79535-47bb-0310-9956-ffa450edef68

-            ItemImpl item = itemMgr.getItem(itemState.getId());
+            ItemId id = itemState.getId();
+            ItemImpl item;
+
+            if (stateMgr.isItemStateInAttic(id)) {
+                // If an item has been removed and then again created, the
+                // item is lost after persistTransientItems() and the
+                // TransientItemStateManager will bark because of a deleted
+                // state in its attic. We therefore have to forge a new item
+                // instance ourself.
+                if (itemState.isNode()) {
+                    item = itemMgr.createNodeInstance((NodeState) itemState);
+                } else {
+                    item = itemMgr.createPropertyInstance((PropertyState) itemState);
+                }
+                itemState.setStatus(ItemState.STATUS_NEW);
+            } else {
+                item = itemMgr.getItem(id);
+            }
