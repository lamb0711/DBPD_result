JCR-2746: Sleep in possibly endless loop in ObservationDispatcher

Move the sleep to the end of SessionState.perform() after all the relevant locks have been released

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1000950 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.WorkspaceManager;
+import org.apache.jackrabbit.core.observation.ObservationDispatcher;
+        boolean isOutermostWriteOperation = false;
+                isOutermostWriteOperation = true;
+
-                    context.delayIfNecessary();
+
+            // Delay return from a write operation if the observation queue
+            // is being overloaded. This needs to be done after releasing
+            // the (outermost) write locks to prevent potential deadlocks.
+            // See https://issues.apache.org/jira/browse/JCR-2746
+            if (isOutermostWriteOperation) {
+                WorkspaceManager manager =
+                    context.getRepositoryContext().getWorkspaceManager();
+                ObservationDispatcher dispatcher =
+                    manager.getObservationDispatcher(context.getWorkspace().getName());
+                dispatcher.delayIfEventQueueOverloaded();
+            }
