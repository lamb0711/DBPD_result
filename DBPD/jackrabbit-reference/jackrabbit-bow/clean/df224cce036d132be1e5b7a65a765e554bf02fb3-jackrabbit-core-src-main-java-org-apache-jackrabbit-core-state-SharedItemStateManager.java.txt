JCR-3345: ACL evaluation may return non-fresh results

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1357265 13f79535-47bb-0310-9956-ffa450edef68

+                // make sure new item states are present/referenced in cache
+                // we do this before the lock is downgraded to a read lock
+                // because then other threads will be able to read from
+                // this SISM again and potentially read an added item state
+                // before the ones here are put into the cache (via
+                // shared.persisted()). See JCR-3345
+                for (ItemState state : shared.addedStates()) {
+                    state.setStatus(ItemState.STATUS_EXISTING);
+                    cache.cache(state);
+                }
+
