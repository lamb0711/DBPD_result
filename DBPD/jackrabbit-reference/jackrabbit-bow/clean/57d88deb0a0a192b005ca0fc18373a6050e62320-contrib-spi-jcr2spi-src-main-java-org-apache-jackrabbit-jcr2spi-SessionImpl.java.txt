- SPI: add RepositoryService.impersonate
- add implementations
- adjust SessionImpl.impersonate

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@518970 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.jcr2spi.security.SecurityConstants;
-import javax.jcr.SimpleCredentials;
-        // TODO: check whether restriction to SimpleCredentials is correct
-        if (!(credentials instanceof SimpleCredentials)) {
-            String msg = "impersonate failed: incompatible credentials, SimpleCredentials expected";
-            log.debug(msg);
-            throw new RepositoryException(msg);
-        }
-
-        // set IMPERSONATOR_ATTRIBUTE attribute of given credentials
-        // with current session
-        SimpleCredentials creds = (SimpleCredentials) credentials;
-        creds.setAttribute(SecurityConstants.IMPERSONATOR_ATTRIBUTE, this);
-
+        SessionInfo info = config.getRepositoryService().impersonate(sessionInfo, credentials);
-            return repository.login(credentials, getWorkspace().getName());
-        } catch (NoSuchWorkspaceException nswe) {
-            // should never get here...
-            String msg = "impersonate failed";
-            log.error(msg, nswe);
-            throw new RepositoryException(msg, nswe);
-        } finally {
-            // make sure IMPERSONATOR_ATTRIBUTE is removed
-            creds.removeAttribute(SecurityConstants.IMPERSONATOR_ATTRIBUTE);
+            if (info instanceof XASessionInfo) {
+                return new XASessionImpl((XASessionInfo) info, repository, config);
+            } else {
+                return new SessionImpl(info, repository, config);
+            }
+        } catch (RepositoryException ex) {
+            config.getRepositoryService().dispose(info);
+            throw ex;
