JCR-2272: Update branch to match latest trunk.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/branches/JCR-2272@1176340 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.security.SystemPrincipal;
+        boolean allows;
-        if (impersonators.removeAll(principalNames)) {
-            return true;
-        } else {
-            // check if subject belongs to an administrator or the system
+        allows = impersonators.removeAll(principalNames);
+
+        if (!allows) {
+            // check if subject belongs to administrator user
-                if (p instanceof SystemPrincipal) { 
-                    return true;
-                } else if (!(p instanceof Group)) {
-                    Authorizable a = userManager.getAuthorizable(p);
-                    if (a != null && userManager.isAdminId(a.getID())) {
-                        return true;
-                    }
+                if (p instanceof Group) {
+                    continue;
+                }
+                Authorizable a = userManager.getAuthorizable(p);
+                if (a != null && userManager.isAdminId(a.getID())) {
+                    allows = true;
+                    break;
-        return false;
+        return allows;
