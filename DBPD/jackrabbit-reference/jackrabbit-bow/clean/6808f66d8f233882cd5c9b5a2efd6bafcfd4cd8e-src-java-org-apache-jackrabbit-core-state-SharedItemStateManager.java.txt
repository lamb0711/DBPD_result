JCR-234 - VersionTest.testGetUUID() fails
JCR-232 - jcr:baseVersion is not updated when the base version is removed from the version history


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@293286 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.LinkedList;
+        // set of virtual node references
+        // todo: remember by provider
+        LinkedList virtualRefs = new LinkedList();
+
-                if (refs.hasReferences()) {
-                    if (!local.has(id) && !hasItemState(id)) {
-                        String msg = "Target node " + id
-                                + " of REFERENCE property does not exist";
-                        throw new ItemStateException(msg);
+                // if targetid is in virtual provider, transfer to its modified set
+                for (int i = 0; i < virtualProviders.length; i++) {
+                    VirtualItemStateProvider provider = virtualProviders[i];
+                    if (provider.hasItemState(id)) {
+                        virtualRefs.add(refs);
+                        refs = null;
+                        break;
-                shared.modified(refs);
+                if (refs != null) {
+                    if (refs.hasReferences()) {
+                        if (!local.has(id) && !hasItemState(id)) {
+                            String msg = "Target node " + id
+                                    + " of REFERENCE property does not exist";
+                            throw new ItemStateException(msg);
+                        }
+                    }
+                    shared.modified(refs);
+                }
+            /* notify virtual providers about node references */
+            iter = virtualRefs.iterator();
+            while (iter.hasNext()) {
+                NodeReferences refs = (NodeReferences) iter.next();
+                for (int i = 0; i < virtualProviders.length; i++) {
+                    if (virtualProviders[i].setNodeReferences(refs)) {
+                    break;
+                    }
+                }
+            }
+
