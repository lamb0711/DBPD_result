JCR-2759: Collapse nested OR expressions

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1002596 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.lucene.search.BooleanClause;
-            orQuery.add(operand, Occur.SHOULD);
+            if (operand instanceof BooleanQuery) {
+                // check if the clauses are all optional, then
+                // we can collapse into the the enclosing orQuery
+                boolean hasNonOptional = false;
+                for (BooleanClause clause : ((BooleanQuery) operand).getClauses()) {
+                    if (clause.isProhibited() || clause.isRequired()) {
+                        hasNonOptional = true;
+                        break;
+                    }
+                }
+                if (hasNonOptional) {
+                    // cannot collapse
+                    orQuery.add(operand, Occur.SHOULD);
+                } else {
+                    // collapse
+                    for (BooleanClause clause : ((BooleanQuery) operand).getClauses()) {
+                        orQuery.add(clause);
+                    }
+                }
+            } else {
+                orQuery.add(operand, Occur.SHOULD);
+            }
