JCR-920: rep:excerpt() should also work on properties
- make sure query is rewritten

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@538484 13f79535-47bb-0310-9956-ffa450edef68

-            if (!rewritten) {
-                query = query.rewrite(reader);
-                rewritten = true;
-            }
+            checkRewritten(reader);
+                if (fields[i].stringValue().length() == 0) {
+                    continue;
+                }
+        checkRewritten(null);
+     * Makes sure the {@link #query} is rewritten. If the query is already
+     * rewritten, this method returns immediately.
+     *
+     * @param reader an optional index reader, if none is passed this method
+     *               will retrieve one from the {@link #index} and close it
+     *               again after the rewrite operation.
+     * @throws IOException if an error occurs while the query is rewritten.
+     */
+    private void checkRewritten(IndexReader reader) throws IOException {
+        if (!rewritten) {
+            IndexReader r = reader;
+            if (r == null) {
+                r = index.getIndexReader();
+            }
+            try {
+                query = query.rewrite(r);
+            } finally {
+                // only close reader if this method opened one
+                if (reader == null) {
+                    r.close();
+                }
+            }
+            rewritten = true;
+        }
+    }
+
+    /**
