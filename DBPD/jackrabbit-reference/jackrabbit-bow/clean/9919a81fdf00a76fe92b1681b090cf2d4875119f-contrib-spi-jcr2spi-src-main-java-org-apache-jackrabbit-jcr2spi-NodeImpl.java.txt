work in progress

- remove commented code
- adjust usages of LazyItemIterator

TODO redefined handling of references

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@430059 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Iterator;
-                // refs.getReferences() returns a list of PropertyId's
-                List idList = refs.getReferences();
-                return new LazyItemIterator(itemMgr, idList);
+                // refs.getReferences() returns a list of Property states
+                Collection refStates = refs.getReferences();
+                return new LazyItemIterator(itemMgr, refStates);
+        // TODO: improve... (and review return value of VM.merge)
-            return new LazyItemIterator(itemMgr, failedIds);
+            List failedStates = new ArrayList();
+            Iterator it = failedIds.iterator();
+            while (it.hasNext()) {
+                try {
+                    ItemState state = session.getItemStateManager().getItemState((NodeId) it.next());
+                    if (state.isNode()) {
+                        failedStates.add(state);
+                    } else {
+                        throw new RepositoryException("Unexpected error: NodeState expected.");
+                    }
+                } catch (ItemStateException e) {
+                    throw new RepositoryException("Unexpected error", e);
+                }
+            }
+            return new LazyItemIterator(itemMgr, failedStates);
