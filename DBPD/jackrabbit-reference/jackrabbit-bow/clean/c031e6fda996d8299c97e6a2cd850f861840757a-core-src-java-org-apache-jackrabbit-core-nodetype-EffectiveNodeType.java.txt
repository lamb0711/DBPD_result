fixed bug in node type validation: some ambiguous definitions were not detected

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@267220 13f79535-47bb-0310-9956-ffa450edef68

+        // map of all item definitions (maps id to definition)
+        // used to effectively detect ambiguous child definitions where
+        // ambiguity is defined in terms of definition identity
+        HashMap itemDefIds = new HashMap();
+
+            // check if child node definition would be ambiguous within
+            // this node type definition
+            if (itemDefIds.containsKey(cnda[i].getId())) {
+                // conflict
+                String msg;
+                if (cnda[i].definesResidual()) {
+                    msg = ntName + " contains ambiguous residual child node definitions";
+                } else {
+                    msg = ntName + " contains ambiguous definitions for child node named "
+                            + cnda[i].getName();
+                }
+                log.debug(msg);
+                throw new NodeTypeConflictException(msg);
+            } else {
+                itemDefIds.put(cnda[i].getId(), cnda[i]);
+            }
+            // check if property definition would be ambiguous within
+            // this node type definition
+            if (itemDefIds.containsKey(pda[i].getId())) {
+                // conflict
+                String msg;
+                if (pda[i].definesResidual()) {
+                    msg = ntName + " contains ambiguous residual property definitions";
+                } else {
+                    msg = ntName + " contains ambiguous definitions for property named "
+                            + pda[i].getName();
+                }
+                log.debug(msg);
+                throw new NodeTypeConflictException(msg);
+            } else {
+                itemDefIds.put(pda[i].getId(), pda[i]);
+            }
-            // @todo do further checks for ambiguous definitions & other conflicts
-        // @todo implement further validations
-
