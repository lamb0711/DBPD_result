JCR-533: failing Node.lock() might leave inconsistent transient state

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@430067 13f79535-47bb-0310-9956-ffa450edef68

-            // add properties to content
-            internalSetProperty(QName.JCR_LOCKOWNER,
-                    InternalValue.create(getSession().getUserID()));
-            internalSetProperty(QName.JCR_LOCKISDEEP,
-                    InternalValue.create(isDeep));
-            save();
+            boolean succeeded = false;
+
+            try {
+                // add properties to content
+                internalSetProperty(QName.JCR_LOCKOWNER,
+                        InternalValue.create(getSession().getUserID()));
+                internalSetProperty(QName.JCR_LOCKISDEEP,
+                        InternalValue.create(isDeep));
+                save();
+                succeeded = true;
+            } finally {
+                if (!succeeded) {
+                    // failed to set lock meta-data content, cleanup
+                    try {
+                        lockMgr.unlock(this);
+                        refresh(false);
+                    } catch (RepositoryException re) {
+                        // cleanup failed
+                        log.error("error while cleaning up after failed lock attempt", re);
+                    }
+                }
+            }
+
