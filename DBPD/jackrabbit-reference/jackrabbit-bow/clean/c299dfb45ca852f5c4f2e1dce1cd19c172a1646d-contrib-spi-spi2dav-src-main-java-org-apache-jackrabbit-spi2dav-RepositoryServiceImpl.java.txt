work in progress

- event processing upon saving transient modifications
- extend ItemState.refresh: add Event and ev. ChangeLog as param
- EventImpl: parentId missing
- remove ItemStateListener
- all state changes are covered by ItemStateLifeCycleListener.statusChanged(ItemState, int)


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@453514 13f79535-47bb-0310-9956-ffa450edef68

-            try {
-                // first unsubscribe in order to retrieve the events
-                String subscrUri = (targetId.denotesNode() ? uri : getItemUri(((PropertyId) targetId).getParentId(), sessionInfo));
-                EventIterator events = poll(subscrUri, subscriptionId, sessionInfo);
-                unsubscribe(subscrUri, subscriptionId, sessionInfo);
-                return events;
+            String subscrUri = (targetId.denotesNode() ? uri : getItemUri(((PropertyId) targetId).getParentId(), sessionInfo));
-            } finally {
+            UnLockMethod method = null;
+            try {
-                // server.
-                UnLockMethod method = new UnLockMethod(uri, batchId);
+                // server, asking the server to persist the modifications
+                method = new UnLockMethod(uri, batchId);
-                try {
-                    method.setRequestBody(new TransactionInfo(commit));
-                    client.executeMethod(method);
-                    method.checkSuccess();
-                } catch (IOException e) {
-                    throw new RepositoryException(e);
-                } catch (DavException e) {
-                    throw ExceptionConverter.generate(e);
-                } finally {
+                method.setRequestBody(new TransactionInfo(commit));
+                client.executeMethod(method);
+                method.checkSuccess();
+
+                // retrieve events
+                EventIterator events = poll(subscrUri, subscriptionId, sessionInfo);
+                return events;
+            } catch (IOException e) {
+                throw new RepositoryException(e);
+            } catch (DavException e) {
+                throw ExceptionConverter.generate(e);
+            } finally {
+                if (method != null) {
+                // unsubscribe
+                unsubscribe(subscrUri, subscriptionId, sessionInfo);
