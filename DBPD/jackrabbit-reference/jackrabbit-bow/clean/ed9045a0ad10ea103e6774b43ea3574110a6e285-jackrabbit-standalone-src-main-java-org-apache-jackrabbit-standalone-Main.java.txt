JCR-1357: Create "quick start" developer bundles for model 1,2,3 deployment

Automatically start a Jackrabbit repository based on the command line options.

Better handling of server log files.

Plus minor cleanups.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@721186 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.log4j.DailyRollingFileAppender;
+import org.apache.jackrabbit.servlet.jackrabbit.JackrabbitRepositoryServlet;
+import org.apache.log4j.FileAppender;
+import org.apache.log4j.Layout;
+import org.mortbay.jetty.servlet.ServletHolder;
-    private final Logger serverLog = Logger.getRootLogger();
-
-            prepareAccessLog(log);
-
-            message("Preparing the server...");
-            server.setStopAtShutdown(true);
-
-            prepareWebapp(file, tmp);
-            accessLog.setHandler(webapp);
-            server.setHandler(accessLog);
-
-            prepareConnector();
-            server.addConnector(connector);
+            prepareWebapp(file, repository, tmp);
+            accessLog.setHandler(webapp);
+            prepareAccessLog(log);
+            server.setHandler(accessLog);
+            prepareConnector();
+            server.addConnector(connector);
-        serverLog.addAppender(new DailyRollingFileAppender(
-                new PatternLayout("%d{dd.MM.yyyy HH:mm:ss} *%-5p* %c{1}: %m%n"),
-                new File(log, "server.log.yyyy-MM-dd").getPath(),
-                "yyyy-mm-dd"));
+        Layout layout =
+            new PatternLayout("%d{dd.MM.yyyy HH:mm:ss} *%-5p* %c{1}: %m%n");
+
+        Logger jackrabbitLog = Logger.getRootLogger();
+        jackrabbitLog.addAppender(new FileAppender(
+                layout, new File(log, "jackrabbit.log").getPath()));
+
+        Logger jettyLog = Logger.getLogger("org.mortbay.log");
+        jettyLog.addAppender(new FileAppender(
+                layout, new File(log, "jetty.log").getPath()));
+        jettyLog.setAdditivity(false);
-            serverLog.setLevel(Level.DEBUG);
+            jackrabbitLog.setLevel(Level.DEBUG);
+            jettyLog.setLevel(Level.DEBUG);
-            serverLog.setLevel(Level.WARN);
+            jackrabbitLog.setLevel(Level.INFO);
+            jettyLog.setLevel(Level.INFO);
+
+        System.setProperty(
+                "derby.stream.error.file",
+                new File(log, "derby.log").getPath());
-        String path = new File(log, "access.log.yyyy-MM-dd").getPath();
-        NCSARequestLog ncsa = new NCSARequestLog(path);
+        NCSARequestLog ncsa = new NCSARequestLog(
+                new File(log, "access.log.yyyy_mm_dd").getPath());
-    private void prepareWebapp(File file, File tmp) {
+    private void prepareWebapp(File file, File repository, File tmp) {
+
+        ServletHolder servlet =
+            new ServletHolder(JackrabbitRepositoryServlet.class);
+        servlet.setInitOrder(1);
+        servlet.setInitParameter("repository.home", repository.getPath());
+        String conf = command.getOptionValue("conf");
+        if (conf != null) {
+            servlet.setInitParameter("repository.config", conf);
+        }
+        webapp.addServlet(servlet, "/repository.properties");
