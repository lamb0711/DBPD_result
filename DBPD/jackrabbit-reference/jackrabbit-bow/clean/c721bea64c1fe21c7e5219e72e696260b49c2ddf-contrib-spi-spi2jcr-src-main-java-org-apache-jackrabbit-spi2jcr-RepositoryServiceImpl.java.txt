clone, copy: 
- srcPath cannot be determined by using the destination-SessionInfo.
- add private method to build destinationPath

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@515081 13f79535-47bb-0310-9956-ffa450edef68

-                String srcPath = pathForId(srcNodeId, sInfo);
-                StringBuffer destPath = new StringBuffer(pathForId(destParentNodeId, sInfo));
-                try {
-                    if (destPath.length() > 1) {
-                        destPath.append("/");
-                    }
-                    destPath.append(NameFormat.format(destName, sInfo.getNamespaceResolver()));
-                } catch (NoPrefixDeclaredException e) {
-                    throw new RepositoryException(e.getMessage(), e);
-                }
-                if (sInfo.getWorkspaceName().equals(srcWorkspaceName)) {
+                String destPath = getDestinationPath(destParentNodeId, destName, sInfo);
+                if (ws.getName().equals(srcWorkspaceName)) {
-                    ws.copy(srcPath, destPath.toString());
+                    String srcPath = pathForId(srcNodeId, sInfo);
+                    ws.copy(srcPath, destPath);
-                    ws.copy(srcWorkspaceName, srcPath, destPath.toString());
+                    SessionInfoImpl srcInfo = getSessionInfoImpl(obtain(sInfo, srcWorkspaceName));
+                    try {
+                        String srcPath = pathForId(srcNodeId, srcInfo);
+                        ws.copy(srcWorkspaceName, srcPath, destPath);
+                    } finally {
+                        dispose(srcInfo);
+                    }
-                String srcPath = pathForId(srcNodeId, sInfo);
-                StringBuffer destPath = new StringBuffer(pathForId(destParentNodeId, sInfo));
+                SessionInfoImpl srcInfo = getSessionInfoImpl(obtain(sessionInfo, srcWorkspaceName));
-                    if (destPath.length() > 1) {
-                        destPath.append("/");
-                    }
-                    destPath.append(NameFormat.format(destName, sInfo.getNamespaceResolver()));
-                } catch (NoPrefixDeclaredException e) {
-                    throw new RepositoryException(e.getMessage(), e);
+                String srcPath = pathForId(srcNodeId, srcInfo);
+                String destPath = getDestinationPath(destParentNodeId, destName, sInfo);
+
+                Workspace wsp = sInfo.getSession().getWorkspace();
+                wsp.clone(srcWorkspaceName, srcPath, destPath, removeExisting);
+                } finally {
+                    dispose(srcInfo);
-                sInfo.getSession().getWorkspace().clone(srcWorkspaceName, srcPath,
-                        destPath.toString(), removeExisting);
+    private String getDestinationPath(NodeId destParentNodeId, QName destName, SessionInfoImpl sessionInfo) throws RepositoryException {
+        StringBuffer destPath = new StringBuffer(pathForId(destParentNodeId, sessionInfo));
+        try {
+            if (destPath.length() > 1) {
+                destPath.append("/");
+            }
+            destPath.append(NameFormat.format(destName, sessionInfo.getNamespaceResolver()));
+        } catch (NoPrefixDeclaredException e) {
+            throw new RepositoryException(e.getMessage(), e);
+        }
+        return destPath.toString();
+    }
+
