fixing namespace registry/mapping bugs

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@151183 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.xerces.util.XMLChar;
-        // verify that parent node is checked-out 
+        // verify that parent node is checked-out
-    public void exportDocView(String absPath, ContentHandler contentHandler, boolean skipBinary, boolean noRecurse) throws InvalidSerializedDataException, PathNotFoundException, SAXException, RepositoryException {
+    public void exportDocView(String absPath, ContentHandler contentHandler,
+                              boolean skipBinary, boolean noRecurse)
+            throws InvalidSerializedDataException, PathNotFoundException,
+            SAXException, RepositoryException {
+        // check sanity of this session
+        sanityCheck();
+
-    }
+        // check sanity of this session
+        sanityCheck();
+
+            // special case: prefixes xml*
+            if (prefix.toLowerCase().startsWith(NamespaceRegistryImpl.NS_XML_PREFIX)) {
+                throw new NamespaceException("reserved prefix: " + prefix);
+            }
+            // check if the prefix is a valid XML prefix
+            if (!XMLChar.isValidNCName(prefix)) {
+                throw new NamespaceException("invalid prefix: " + prefix);
+            }
+
-                // check if it refers to a namespace that has been locally
-                // remapped, thus hiding it
+                // check if it is redundant or if it refers to a namespace
+                // that has been locally remapped, thus hiding it
+                    if (uri.equals(globalURI) && prefix.equals(globalPrefix)) {
+                        // redundant mapping, silently ignore
+                        return;
+                    }
+                if (oldPrefix.equals(prefix)) {
+                    // redundant mapping, silently ignore
+                    return;
+                }
