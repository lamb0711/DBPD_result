JCR-967: Only search the index for the "jcr:system" tree if needed

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@550419 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.name.QName;
+
+    
+    
+    /**
+     * {@inheritDoc}
+     */
+    public boolean needsSystemTree() {
+        
+        LocationStepQueryNode[] pathSteps = getPathSteps();
+        if (pathSteps == null || pathSteps.length == 0) {
+            return true;
+        }
+
+        QName firstPathStepName = pathSteps[0].getNameTest();
+        // If the first location step has a null name test we need to include
+        // the system tree ("*")
+        if (firstPathStepName == null)
+            return true;
+        
+        // Calculate the first workspace relative location step
+        LocationStepQueryNode firstWorkspaceRelativeStep = pathSteps[0];
+        if (firstPathStepName.equals(QName.ROOT)) {
+            // path starts with "/jcr:root"
+            if (pathSteps.length > 1) {
+                firstWorkspaceRelativeStep = pathSteps[1];
+            }
+        }
+        
+        // First path step starts with "//"
+        if (firstWorkspaceRelativeStep.getIncludeDescendants())
+            return true;
+
+        // If the first workspace relative location step is jcr:system we need 
+        // to include the system tree
+        QName firstWorkspaceRelativeName = firstWorkspaceRelativeStep.getNameTest();
+        if (firstWorkspaceRelativeName == null
+                || firstWorkspaceRelativeName.equals(QName.JCR_SYSTEM)) {
+            return true;
+        }
+        
+        return super.needsSystemTree();
+    }
