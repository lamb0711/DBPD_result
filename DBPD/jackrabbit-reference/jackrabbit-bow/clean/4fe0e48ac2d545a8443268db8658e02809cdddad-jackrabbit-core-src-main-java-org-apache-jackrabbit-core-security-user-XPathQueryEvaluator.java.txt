JCR-3782 : Backport OAK-1612, OAK-1615, OAK-1616

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1597799 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Iterator;
+import javax.jcr.Node;
+import javax.jcr.PropertyType;
+import javax.jcr.RepositoryException;
+import javax.jcr.Value;
+import javax.jcr.query.Query;
+import javax.jcr.query.QueryManager;
+
-import javax.jcr.Node;
-import javax.jcr.PropertyType;
-import javax.jcr.RepositoryException;
-import javax.jcr.Value;
-import javax.jcr.query.Query;
-import javax.jcr.query.QueryManager;
-import java.util.Iterator;
-
-                .append(repPrincipal)
+                .append(escapeForQuery(repPrincipal))
-                .append(condition.getPattern())
+                .append(escapeForQuery(condition.getPattern()))
-            xPath.append(condition.getRelPath());
+            xPath.append(escapeForQuery(condition.getRelPath()));
-                    .append(condition.getRelPath())
+                    .append(escapeForQuery(condition.getRelPath()))
-                    .append(condition.getPattern())
+                    .append(escapeForQuery(condition.getPattern()))
-            xPath.append(condition.getRelPath())
+            xPath.append(escapeForQuery(condition.getRelPath()))
-                .append(condition.getRelPath())
+                .append(escapeForQuery(condition.getRelPath()))
-                .append(condition.getSearchExpr())
+                .append(escapeForQuery(condition.getSearchExpr()))
-                .append(condition.getName())
+                .append(escapeForQuery(condition.getName()))
+    public static String escapeForQuery(String value) {
+        StringBuilder ret = new StringBuilder();
+        for (int i = 0; i < value.length(); i++) {
+            char c = value.charAt(i);
+            if (c == '\\') {
+                ret.append("\\\\");
+            } else if (c == '\'') {
+                ret.append("''");
+            } else {
+                ret.append(c);
+            }
+        }
+        return ret.toString();
+    }
+
