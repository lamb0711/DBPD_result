JCR-890: concurrent read-only access to a session

Add SessionState.perform(SessionOperation) for centralizing the control of any kinds of session operations.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@956896 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.session.SanityCheck;
+import org.apache.jackrabbit.core.session.SessionOperation;
-        state.checkAlive();
+        state.perform(SanityCheck.INSTANCE);
-        // check sanity of this session
-        sanityCheck();
-
-        // /JCR-2425: check whether session is allowed to read root node
-        if (hasPermission("/", ACTION_READ)) {
-            getItemManager().getRootNode().save();
-        } else {
-            NodeId id = getItemStateManager().getIdOfRootTransientNodeState();
-            getItemManager().getItem(id).save();
-        }
+        state.perform(new SessionOperation() {
+            public void perform() throws RepositoryException {
+                // JCR-2425: check whether session is allowed to read root node
+                if (hasPermission("/", ACTION_READ)) {
+                    getItemManager().getRootNode().save();
+                } else {
+                    NodeId id = getItemStateManager().getIdOfRootTransientNodeState();
+                    getItemManager().getItem(id).save();
+                }
+            }
+        });
