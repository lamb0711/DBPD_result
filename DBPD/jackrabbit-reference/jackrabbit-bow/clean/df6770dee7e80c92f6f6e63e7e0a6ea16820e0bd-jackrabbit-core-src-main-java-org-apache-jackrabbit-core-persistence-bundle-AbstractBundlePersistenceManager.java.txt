JCR-3525 inform cluster of changes made during consistency repairs
- added a lot more unit test coverage, including verification of cluster update events
- refactored the code to be more modular
- report items now also report whether inconsistency error was fixed

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1448252 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.cluster.UpdateEventChannel;
-    
+    /** The update event channel to use by the consistency checker when fixing inconsistencies */
+    private UpdateEventChannel eventChannel;
+
-            ConsistencyCheckerImpl cs = new ConsistencyCheckerImpl(this, null);
-            cs.check(uuids, recursive, fix, null);
+            ConsistencyCheckerImpl checker = new ConsistencyCheckerImpl(this, null, null, eventChannel);
+            checker.check(uuids, recursive);
+            checker.doubleCheckErrors();
+            if (fix) {
+                checker.repair();
+            }
+    public void setEventChannel(UpdateEventChannel eventChannel) {
+        this.eventChannel = eventChannel;
+    }
+
-        ConsistencyCheckerImpl cs = new ConsistencyCheckerImpl(this, listener);
-        return cs.check(uuids, recursive, fix, lostNFoundId);
+        ConsistencyCheckerImpl checker = new ConsistencyCheckerImpl(this, listener, lostNFoundId, eventChannel);
+        checker.check(uuids, recursive);
+        checker.doubleCheckErrors();
+        if (fix) {
+            checker.repair();
+        }
+        return checker.getReport();
