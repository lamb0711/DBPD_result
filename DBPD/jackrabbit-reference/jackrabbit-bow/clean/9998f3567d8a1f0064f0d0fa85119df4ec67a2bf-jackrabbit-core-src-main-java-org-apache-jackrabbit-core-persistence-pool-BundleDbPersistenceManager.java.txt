JCR-2877 Extend the consistency check in BundleDbPersistenceManager's to fix child-parent relations

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1073280 13f79535-47bb-0310-9956-ffa450edef68

-import java.sql.Blob;
+import java.util.Iterator;
+import java.util.Random;
+import org.apache.jackrabbit.spi.commons.name.NameFactoryImpl;
+            	NodePropBundle parentBundle = loadBundle(parentId);
+            	Iterator<NodePropBundle.ChildNodeEntry> childNodeIter = parentBundle.getChildNodeEntries().iterator();
+            	boolean found = false;
+            	while (childNodeIter.hasNext()) {
+                    NodePropBundle.ChildNodeEntry entry = childNodeIter.next();
+                    if (entry.getId().equals(id)){
+                    	found = true;
+                    	break;
+                    }
+            	}
+            	if (!found) {
+            		log.error("NodeState '" + id + "' is not referenced by its parent node '" + parentId + "'");
+            		int l = (int) System.currentTimeMillis();
+            		int r = new Random().nextInt();
+            		int n = l + r; 
+            		String nodeName = Integer.toHexString(n);
+            		parentBundle.addChildNodeEntry(NameFactoryImpl.getInstance().create("{}" + nodeName), id);
+            		log.info("NodeState '" + id + "' adds itself to its parent node '" + parentId + "' with a new name '" + nodeName+ "'");
+            		modifications.add(parentBundle);
+            	}
