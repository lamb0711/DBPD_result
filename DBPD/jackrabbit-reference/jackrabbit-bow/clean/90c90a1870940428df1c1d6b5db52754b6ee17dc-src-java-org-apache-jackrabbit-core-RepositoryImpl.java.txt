- adding shutdown hook that shuts down the repository gracefully
- adding inline dtd to repository.xml

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@55067 13f79535-47bb-0310-9956-ffa450edef68

+    // @todo update as necessary
+    // flag indicating if respository has been shut down
+    private boolean disposed = false;
+
+
+        // finally register shutdown hook
+        Runtime.getRuntime().addShutdownHook(new Thread() {
+            public void run() {
+                shutdown();
+            }
+        });
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
-     * Shuts down this repository
+     * Shuts down this repository. Note that this method is called automatically
+     * through a shutdown hook.
+     *
+     * @see Runtime#addShutdownHook(Thread)
-    protected void shutdown() {
+    protected synchronized void shutdown() {
+        // check state
+        if (disposed) {
+            // there's nothing to do here because the repository has already been shut down
+            return;
+        }
+
+
+        // make sure this instance is not used anymore
+        disposed = true;
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
+        // check state
+        if (disposed) {
+            throw new IllegalStateException("repository instance has been shut down");
+        }
+
-    //-----------------------------------------------------------< Repository >
+    //--------------------------------------------------------< EventListener >
+        // check state
+        if (disposed) {
+            // ignore, repository instance has been shut down
+            return;
+        }
+
