fixing http://issues.apache.org/jira/browse/JCR-10
(Item#save() did under special circumstances trigger
transient modifications that were not persisted in 
the same call)

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@55004 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.version.*;
-import org.apache.jackrabbit.core.util.uuid.UUID;
+import org.apache.jackrabbit.core.util.uuid.UUID;
+import org.apache.jackrabbit.core.version.*;
-	todo centralize version history creation code (currently in NodeImpl.addMixin & ItemImpl.initVersionHistories
+	todo consolidate version history creation code (currently in NodeImpl.addMixin & ItemImpl.initVersionHistories
-        EffectiveNodeType entExisting;
+        EffectiveNodeType entExisting, entNew;
-            ntReg.buildEffectiveNodeType((QName[]) set.toArray(new QName[set.size()]));
+            entNew = ntReg.buildEffectiveNodeType((QName[]) set.toArray(new QName[set.size()]));
-            // todo centralize version history creation code (currently in NodeImpl.addMixin & ItemImpl.initVersionHistories
-            if (ntName.equals(NodeTypeRegistry.MIX_VERSIONABLE)) {
+            // todo consolidate version history creation code (currently in NodeImpl.addMixin & ItemImpl.initVersionHistories
+            if (!entExisting.includesNodeType(NodeTypeRegistry.MIX_VERSIONABLE) &&
+                    entNew.includesNodeType(NodeTypeRegistry.MIX_VERSIONABLE)) {
+                // node has become 'versionable', initialize version history
-            if (uuid!=null && !uuid.equals(getUUID())) {
+            if (uuid != null && !uuid.equals(getUUID())) {

MOV26 MOV26 INS59 INS42 INS7 INS27 INS42 MOV32 INS38 INS32 INS32 UPD42 MOV42 UPD42 MOV42 MOV40 INS42 INS42 INS40 DEL32