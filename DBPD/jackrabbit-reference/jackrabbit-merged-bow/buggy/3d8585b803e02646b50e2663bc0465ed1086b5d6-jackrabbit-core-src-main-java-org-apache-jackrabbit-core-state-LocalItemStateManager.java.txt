JCR-2272: Errors during concurrent session import of nodes with same UUIDs

Move node id generation into the createNew() method, and add a check for existing nodes when an existing node id is being used

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/branches/JCR-2272@1174016 13f79535-47bb-0310-9956-ffa450edef68

+import javax.jcr.InvalidItemStateException;
+import javax.jcr.RepositoryException;
-    public NodeState createNew(NodeId id, Name nodeTypeName,
-                               NodeId parentId)
-            throws IllegalStateException {
+    public NodeState createNew(
+            NodeId id, Name nodeTypeName, NodeId parentId)
+            throws RepositoryException {
-            throw new IllegalStateException("Not in edit mode");
+            throw new RepositoryException("Not in edit mode");
-        NodeState state = new NodeState(id, nodeTypeName, parentId,
-                ItemState.STATUS_NEW, false);
+        boolean nonRandomId = true;
+        if (id == null) {
+            id = getNodeIdFactory().newNodeId();
+            nonRandomId = false;
+        }
+
+        NodeState state = new NodeState(
+                id, nodeTypeName, parentId, ItemState.STATUS_NEW, false);
+
+        if (nonRandomId && sharedStateMgr.hasItemState(id)) {
+            throw new InvalidItemStateException(
+                    "Node " + id + " already exists");
+        }
+

INS26 INS26 INS40 INS40 UPD43 UPD42 INS60 INS25 INS25 INS39 INS59 INS27 INS8 INS27 INS8 INS42 INS9 INS42 INS33 INS21 INS21 INS42 INS32 INS53 INS7 INS7 INS42 INS42 INS42 INS14 UPD43 INS42 INS32 INS42 INS9 INS43 INS27 UPD42 INS32 INS42 INS42 INS45 INS42 INS45 INS42