reworked transaction support, contributed by dominique

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@151380 13f79535-47bb-0310-9956-ffa450edef68

-    public synchronized NodeState load(String uuid)
+    public synchronized NodeState load(NodeId id)
-        String nodeFilePath = buildNodeFilePath(uuid);
+        String nodeFilePath = buildNodeFilePath(id.getUUID());
-                NodeState state = createNew(uuid, null, null);
+                NodeState state = createNew(id);
-                String msg = "failed to read node state: " + uuid;
+                String msg = "failed to read node state: " + id.getUUID();
-    public synchronized PropertyState load(QName name, String parentUUID)
+    public synchronized PropertyState load(PropertyId id)
-        String propFilePath = buildPropFilePath(parentUUID, name);
+        String propFilePath = buildPropFilePath(
+                id.getParentUUID(), id.getName());
-                PropertyState state = createNew(name, parentUUID);
+                PropertyState state = createNew(id);
-    public synchronized NodeReferences load(NodeId targetId)
+    public synchronized NodeReferences load(NodeReferencesId id)
+
-        String refsFilePath = buildNodeReferencesFilePath(targetId.getUUID());
+        String refsFilePath = buildNodeReferencesFilePath(id.getUUID());
-                throw new NoSuchItemStateException(targetId.toString());
+                throw new NoSuchItemStateException(id.toString());
-            String msg = "failed to load references: " + targetId;
+            String msg = "failed to load references: " + id;
-                NodeReferences refs = new NodeReferences(targetId);
+                NodeReferences refs = new NodeReferences(id);
-            String msg = "failed to load references: " + targetId;
+            String msg = "failed to load references: " + id;
-     * @see PersistenceManager#exists(ItemId id)
+     * @see PersistenceManager#exists(PropertyId id)
-    public synchronized boolean exists(ItemId id) throws ItemStateException {
+    public synchronized boolean exists(PropertyId id) throws ItemStateException {
-            if (id.denotesNode()) {
-                NodeId nodeId = (NodeId) id;
-                String nodeFilePath = buildNodeFilePath(nodeId.getUUID());
-                FileSystemResource nodeFile = new FileSystemResource(itemStateFS, nodeFilePath);
-                return nodeFile.exists();
-            } else {
-                PropertyId propId = (PropertyId) id;
-                String propFilePath = buildPropFilePath(propId.getParentUUID(), propId.getName());
-                FileSystemResource propFile = new FileSystemResource(itemStateFS, propFilePath);
-                return propFile.exists();
-            }
+            String propFilePath = buildPropFilePath(id.getParentUUID(), id.getName());
+            FileSystemResource propFile = new FileSystemResource(itemStateFS, propFilePath);
+            return propFile.exists();
-     * @see PersistenceManager#referencesExist(NodeId targetId)
+     * @see PersistenceManager#exists(NodeId)
-    public synchronized boolean referencesExist(NodeId targetId) throws ItemStateException {
+    public synchronized boolean exists(NodeId id) throws ItemStateException {
-            String uuid = targetId.getUUID();
+            String nodeFilePath = buildNodeFilePath(id.getUUID());
+            FileSystemResource nodeFile = new FileSystemResource(itemStateFS, nodeFilePath);
+            return nodeFile.exists();
+        } catch (FileSystemException fse) {
+            String msg = "failed to check existence of item state: " + id;
+            log.error(msg, fse);
+            throw new ItemStateException(msg, fse);
+        }
+    }
+
+    /**
+     * @see PersistenceManager#exists(NodeReferencesId)
+     */
+    public synchronized boolean exists(NodeReferencesId id)
+            throws ItemStateException {
+
+        if (!initialized) {
+            throw new IllegalStateException("not initialized");
+        }
+
+        try {
+            String uuid = id.getUUID();
-            String msg = "failed to check existence of references: " + targetId;
+            String msg = "failed to check existence of references: " + id;

INS31 INS29 INS83 INS83 INS39 INS42 INS44 INS43 INS8 UPD42 UPD43 UPD42 UPD43 UPD42 UPD43 UPD42 MOV43 INS65 MOV43 INS42 INS42 INS25 INS54 UPD43 UPD42 UPD42 UPD42 UPD42 INS8 INS68 INS38 INS8 MOV8 INS12 UPD42 MOV60 MOV60 MOV41 INS42 INS42 INS69 INS42 INS53 INS60 INS44 INS8 UPD42 INS32 INS32 INS32 MOV43 MOV43 MOV43 INS14 UPD43 MOV43 MOV59 INS43 INS42 INS60 INS21 INS53 INS43 MOV43 UPD42 MOV42 INS42 INS42 UPD42 MOV42 INS42 UPD42 MOV42 UPD42 INS43 INS45 UPD42 INS42 MOV43 INS59 INS32 INS14 INS42 MOV43 INS42 INS42 INS27 INS42 INS42 INS42 INS42 INS43 INS42 INS42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 INS45 INS42 INS42 UPD42 UPD42 UPD42 UPD42 UPD42 INS32 INS42 INS42 DEL33 DEL33 DEL42 DEL42 DEL44 DEL42 DEL42 DEL43 DEL42 DEL43 DEL42 DEL42 DEL32 DEL42 DEL42 DEL11 DEL59 DEL60 DEL8 DEL25 DEL8 DEL42 DEL42 DEL11 DEL59 DEL60 DEL60 DEL42