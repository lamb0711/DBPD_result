JCR-1104: JSR 283 support (work in progress)
- NodeLocalName

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@647798 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.lucene.index.Term;
-import org.apache.lucene.index.TermDocs;
+import org.apache.jackrabbit.spi.Name;
+import org.apache.jackrabbit.core.query.lucene.hits.ScorerHits;
+import org.apache.jackrabbit.core.query.lucene.hits.Hits;
-    private final String nameTest;
+    private final Name nameTest;
+
+    /**
+     * The index format version.
+     */
+    private final IndexFormatVersion version;
+
+    /**
+     * The internal namespace mappings.
+     */
+    private final NamespaceMappings nsMappings;
+     * @param version the index format version.
+     * @param nsMappings the internal namespace mappings.
-    ParentAxisQuery(Query context, String nameTest) {
+    ParentAxisQuery(Query context, Name nameTest,
+                   IndexFormatVersion version, NamespaceMappings nsMappings) {
+        this.version = version;
+        this.nsMappings = nsMappings;
-            return new ParentAxisQuery(cQuery, nameTest);
+            return new ParentAxisQuery(cQuery, nameTest, version, nsMappings);
-            return new ParentAxisScorer(searcher.getSimilarity(), reader, resolver);
+            return new ParentAxisScorer(searcher.getSimilarity(),
+                    reader, searcher, resolver);
+         * The searcher instance.
+         */
+        private final Searcher searcher;
+
+        /**
+         * @param searcher   the index searcher.
+         * @param resolver   the hierarchy resolver.
-        protected ParentAxisScorer(Similarity similarity, IndexReader reader, HierarchyResolver resolver) {
+        protected ParentAxisScorer(Similarity similarity,
+                                   IndexReader reader,
+                                   Searcher searcher,
+                                   HierarchyResolver resolver) {
+            this.searcher = searcher;
-                    TermDocs tDocs = reader.termDocs(new Term(FieldNames.LABEL, nameTest));
-                    try {
-                        for (int i = hits.nextSetBit(0); i >= 0; i = hits.nextSetBit(i + 1)) {
-                            if (!tDocs.skipTo(i)) {
-                                // no more name tests, clear remaining
-                                hits.clear(i, hits.length());
-                            } else {
-                                // assert doc >= i
-                                int doc = tDocs.doc();
-                                if (doc > i) {
-                                    // clear hits
-                                    hits.clear(i, doc);
-                                    i = doc;
-                                }
+                    Query nameQuery = new NameQuery(nameTest, version, nsMappings);
+                    Hits nameHits = new ScorerHits(nameQuery.weight(searcher).scorer(reader));
+                    for (int i = hits.nextSetBit(0); i >= 0; i = hits.nextSetBit(i + 1)) {
+                        int doc = nameHits.skipTo(i);
+                        if (doc == -1) {
+                            // no more name tests, clear remaining
+                            hits.clear(i, hits.length());
+                        } else {
+                            // assert doc >= i
+                            if (doc > i) {
+                                // clear hits
+                                hits.clear(i, doc);
+                                i = doc;
-                    } finally {
-                        tDocs.close();

INS26 INS40 UPD40 UPD40 INS23 INS23 UPD43 INS29 INS83 INS83 INS43 INS59 INS29 INS83 INS83 INS43 INS59 INS44 INS44 INS23 UPD42 INS65 INS42 INS42 INS65 INS42 INS42 INS65 INS65 UPD43 INS43 INS42 INS43 INS42 INS21 INS21 INS29 INS83 INS83 INS43 INS59 INS44 INS66 INS66 INS42 INS66 INS42 INS66 UPD42 INS42 INS42 INS7 INS7 INS65 INS42 INS42 INS65 INS65 INS43 INS42 INS21 INS22 INS42 INS22 INS42 INS66 INS42 INS66 INS42 INS66 INS42 INS7 INS52 INS42 INS52 INS42 INS42 INS22 INS42 INS42 INS42 INS52 INS42 MOV8 INS60 INS60 INS43 INS59 INS43 INS59 INS42 INS42 INS14 INS42 INS42 INS14 INS60 INS43 INS42 INS42 INS42 INS43 INS32 INS39 INS59 INS27 INS42 INS42 INS32 INS42 INS42 INS42 INS32 INS42 INS38 INS42 INS42 INS42 INS42 INS42 INS42 INS34 DEL42 DEL42 DEL42 DEL32 DEL38 DEL39 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL43 DEL40 DEL42 DEL14 DEL32 DEL59 DEL60 DEL42 DEL42 DEL32 DEL21 DEL8 DEL54 DEL8