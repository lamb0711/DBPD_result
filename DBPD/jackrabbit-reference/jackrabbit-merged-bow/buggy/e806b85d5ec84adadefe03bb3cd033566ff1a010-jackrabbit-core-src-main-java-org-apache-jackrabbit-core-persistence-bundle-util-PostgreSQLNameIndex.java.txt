JCR-940: BundleDbPersistenceManager auto re-connect

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@575734 13f79535-47bb-0310-9956-ffa450edef68

-import java.sql.Connection;
-import java.sql.PreparedStatement;
-    protected PreparedStatement generatedKeySelect;
+    protected String generatedKeySelectSQL;
-    public PostgreSQLNameIndex(Connection con, String schemaObjectPrefix)
+    public PostgreSQLNameIndex(ConnectionRecoveryManager conMgr, String schemaObjectPrefix)
-        super(con, schemaObjectPrefix);
+        super(conMgr, schemaObjectPrefix);
-    protected void init(Connection con, String schemaObjectPrefix)
+    protected void init(String schemaObjectPrefix)
-        nameSelect = con.prepareStatement(
-                "select NAME from " + schemaObjectPrefix + "NAMES where ID = ?");
-        indexSelect = con.prepareStatement(
-                "select ID from " + schemaObjectPrefix + "NAMES where NAME = ?");
-        nameInsert = con.prepareStatement(
-                "insert into " + schemaObjectPrefix + "NAMES (NAME) values (?)");
-        generatedKeySelect = con.prepareStatement(
-                "select currval('" + schemaObjectPrefix + "NAMES_ID_SEQ')");
+        nameSelectSQL = "select NAME from " + schemaObjectPrefix + "NAMES where ID = ?";
+        indexSelectSQL = "select ID from " + schemaObjectPrefix + "NAMES where NAME = ?";
+        nameInsertSQL = "insert into " + schemaObjectPrefix + "NAMES (NAME) values (?)";
+        generatedKeySelectSQL = "select currval('" + schemaObjectPrefix + "NAMES_ID_SEQ')";
-        PreparedStatement stmt = nameInsert;
-            stmt.setString(1, string);
-            stmt.executeUpdate();
+            connectionManager.executeStmt(nameInsertSQL, new Object[]{string});
-        } finally {
-            resetStatement(stmt);
-        PreparedStatement stmt = generatedKeySelect;
-            ResultSet rs = stmt.executeQuery();
+            ResultSet rs = connectionManager.executeQuery(generatedKeySelectSQL);
-        } finally {
-            resetStatement(stmt);

UPD43 UPD42 UPD42 UPD43 UPD42 UPD42 UPD42 UPD42 MOV27 UPD42 MOV27 UPD42 MOV27 UPD42 MOV27 INS42 UPD42 UPD42 INS3 INS5 INS4 UPD42 INS42 INS43 INS85 INS42 INS42 DEL40 DEL26 DEL40 DEL26 DEL42 DEL43 DEL42 DEL44 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL43 DEL42 DEL42 DEL59 DEL60 DEL34 DEL42 DEL42 DEL42 DEL32 DEL21 DEL42 DEL42 DEL32 DEL21 DEL8 DEL42 DEL43 DEL42 DEL42 DEL59 DEL60 DEL42 DEL42 DEL32 DEL21 DEL8