JCR-2547: Setting a property which has been transiently removed fails with a PathNotFoundException


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@921779 13f79535-47bb-0310-9956-ffa450edef68

-            setProperty(p, value);
+            setProperty(p, value, false);
-            setProperty(p, values);
+            setProperty(p, values, false);
-            setProperty(getPath(propertyId, sessionInfo), value);
+            Path p = getPath(propertyId, sessionInfo);
+            setProperty(p, value, false);
-            setProperty(p, values);
+            setProperty(p, values, false);
+            // clear the uri-lookup in case the itemID contains a uniqueID part.
-            addProperty(nodeId, NameConstants.JCR_MIXINTYPES, vs);
+            Path p = getPathFactory().create(getPath(nodeId, sessionInfo), NameConstants.JCR_MIXINTYPES, true);
+            // register the diff entry including clearing previous calls to
+            // setMixins for the same node.
+            setProperty(p, vs, true);
-            addProperty(nodeId, NameConstants.JCR_PRIMARYTYPE, v);
+            Path p = getPathFactory().create(getPath(nodeId, sessionInfo), NameConstants.JCR_PRIMARYTYPE, true);
+            // register the diff entry including clearing previous calls to
+            // setPrimaryType for the same node.
+            setProperty(p, v, true);
-        private void setProperty(Path propPath, QValue value) throws RepositoryException {
+        private void setProperty(Path propPath, QValue value, boolean clearPrevious) throws RepositoryException {
-            clearPreviousSetProperty(jcrPropPath);
+            if (clearPrevious) {
+                clearPreviousSetProperty(jcrPropPath);
+            }
-        private void setProperty(Path propPath, QValue[] values) throws RepositoryException {
+        private void setProperty(Path propPath, QValue[] values, boolean clearPrevious) throws RepositoryException {
-            clearPreviousSetProperty(jcrPropPath);
+            if (clearPrevious) {
+                clearPreviousSetProperty(jcrPropPath);
+            }

INS44 INS44 INS60 INS21 INS60 INS21 INS60 INS21 INS39 INS42 INS25 INS39 INS42 INS25 INS43 INS59 INS32 INS43 INS59 INS32 INS43 INS59 INS32 INS42 INS8 INS42 INS8 INS9 INS9 INS42 INS42 INS32 INS42 INS42 MOV42 INS9 INS9 INS42 INS42 INS32 INS42 INS42 MOV42 INS9 INS42 INS42 INS32 INS42 INS42 MOV42 INS9 MOV21 MOV21 MOV42 MOV42 MOV42 INS32 INS42 INS32 MOV40 INS9 INS32 INS42 INS32 MOV40 INS9 UPD42 MOV42 INS42 MOV42 INS42 UPD42 MOV42 INS42 MOV42 INS42 DEL42 DEL32 DEL32 DEL21 DEL32 DEL21 DEL32 DEL21