JCR-3040: JMX Stats for the Session

Measure read and write duration of SessionOperations

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1182408 13f79535-47bb-0310-9956-ffa450edef68

-     * Number of nanoseconds in a microsecond.
-     */
-    private static final int NS_PER_US = 1000;
-
-    /**
-     * Number of nanoseconds in a millisecond.
-     */
-    private static final int NS_PER_MS = 1000000;
-
-    /**
+     * Duration of read operations.
+     */
+    private final AtomicLong readDuration;
+
+    /**
+     * Duration of write operations.
+     */
+    private final AtomicLong writeDuration;
+
+    /**
+        this.readDuration = statistics.getCounter("read.duration");
+        this.writeDuration = statistics.getCounter("write.duration");
-                // JCR-3040: Increment the operation counters
-                if (isWriteOperation) {
-                    writeCounter.incrementAndGet();
-                } else {
-                    readCounter.incrementAndGet();
-                }
-
-                // Perform the actual operation, optionally with debug logs
-                if (log.isDebugEnabled()) {
-                    log.debug("Performing {}", operation);
-                    long start = System.nanoTime();
-                    try {
-                        return operation.perform(context);
-                    } finally {
-                        long time = System.nanoTime() - start;
-                        if (time > NS_PER_MS) {
-                            log.debug("Performed {} in {}ms",
-                                    operation, time / NS_PER_MS);
-                        } else {
-                            log.debug("Performed {} in {}us",
-                                    operation, time / NS_PER_US);
-                        }
-                    }
-                } else {
+                // Perform the actual operation
+                log.debug("Performing {}", operation);
+                long start = System.nanoTime();
+                try {
+                } finally {
+                    long time = System.nanoTime() - start;
+
+                    // JCR-3040: Increment the operation counters
+                    if (isWriteOperation) {
+                        writeCounter.incrementAndGet();
+                        writeDuration.addAndGet(time);
+                    } else {
+                        readCounter.incrementAndGet();
+                        readDuration.addAndGet(time);
+                    }
+
+                    log.debug("Performed {} in {}us", operation, time);

MOV23 MOV23 INS43 INS43 MOV8 INS42 UPD42 INS42 UPD42 INS21 INS21 MOV60 MOV25 MOV60 UPD66 UPD66 INS7 INS7 MOV8 INS22 INS32 INS22 INS32 MOV21 MOV60 MOV25 INS54 INS52 INS42 INS42 INS42 INS45 INS52 INS42 INS42 INS42 INS45 MOV8 MOV8 INS21 INS8 MOV7 MOV60 MOV25 MOV21 INS21 INS21 INS42 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 DEL83 DEL39 DEL34 DEL83 DEL39 DEL34 DEL42 DEL42 DEL27 DEL42 DEL42 DEL27 DEL42 DEL42 DEL45 DEL42 DEL42 DEL42 DEL27 DEL32 DEL21 DEL8 DEL8 DEL25 DEL8 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32 DEL41 DEL8 DEL25 DEL54 DEL8