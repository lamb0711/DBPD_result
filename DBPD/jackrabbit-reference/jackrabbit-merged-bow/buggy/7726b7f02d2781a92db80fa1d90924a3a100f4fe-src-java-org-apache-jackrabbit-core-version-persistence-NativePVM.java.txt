- adjusting VersionHistory.getVersionByLabel() to spec 0.16.2
- avoiding creation of duplicate VHs
- add correct nodedef to version labels node

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@153068 13f79535-47bb-0310-9956-ffa450edef68

-import javax.jcr.version.VersionException;
-import java.util.LinkedList;
-     * list of histories for fast retrieval
+     * map of versioned uuids. key=versionedUUID, value=externalId
-    private LinkedList histories = new LinkedList();
+    private HashMap versionedUUIDs = new HashMap();
-                histories.add(id.externalId);
+                // need to retrieve the versioned uuid in order to avoid collisions
+                PropertyState ps = stateMgr.getPropertyState(new PropertyId(state.getUUID(), PROPNAME_VERSIONABLE_ID));
+                String vid = (String) ps.getValues()[0].internalValue();
+                versionedUUIDs.put(vid, id.externalId);
-    private InternalVersionHistoryImpl getHistoryByVersionableUUID(String uuid) {
-        // @TODO: implement
-        return null;
+    private InternalVersionHistoryImpl getHistoryByVersionableUUID(String uuid)
+            throws RepositoryException {
+        String externalId = (String) versionedUUIDs.get(uuid);
+        return externalId == null ? null : (InternalVersionHistoryImpl) getVersionHistory(externalId);
-        log.info("Created new version history " + hist.getId()+ " for " + node.safeGetJCRPath() + ". NumHistories=" + histories.size());
+        log.info("Created new version history " + hist.getId()+ " for " + node.safeGetJCRPath() + ". NumHistories=" + versionedUUIDs.size());
-        return histories.iterator();
+        return versionedUUIDs.values().iterator();
-        return histories.size();
+        return versionedUUIDs.size();

UPD43 INS43 UPD42 UPD42 INS42 INS60 UPD66 UPD43 INS43 INS59 INS16 UPD42 INS42 INS42 INS11 INS27 INS33 INS11 INS32 UPD42 INS43 INS32 INS42 INS33 INS43 INS32 INS42 UPD42 MOV42 INS60 INS60 INS42 INS42 INS42 INS42 INS42 INS42 INS42 UPD42 INS43 INS59 INS43 INS59 INS42 INS42 INS32 INS42 INS42 INS11 UPD42 INS42 UPD42 INS42 INS42 INS14 INS43 INS32 INS43 INS32 INS42 INS42 INS2 INS42 INS42 INS42 INS42 INS32 INS34 INS42 INS42 DEL40 DEL26 DEL40 DEL26 DEL33