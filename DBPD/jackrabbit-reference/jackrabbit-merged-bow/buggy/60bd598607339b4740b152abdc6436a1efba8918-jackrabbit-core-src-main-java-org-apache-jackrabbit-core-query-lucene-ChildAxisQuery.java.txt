JCR-1365: Query path constraints like foo//*/bar do not scale
- more performance improvements

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@629453 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.SessionImpl;
-import org.apache.lucene.search.MatchAllDocsQuery;
+import org.apache.lucene.search.Sort;
-class ChildAxisQuery extends Query {
+class ChildAxisQuery extends Query implements JackrabbitQuery {
+     * @return the context query of this child axis query.
+     */
+    Query getContextQuery() {
+        return contextQuery;
+    }
+
+    /**
+     * @return <code>true</code> if this child axis query matches any child
+     *         node; <code>false</code> otherwise.
+     */
+    boolean matchesAnyChildNode() {
+        return nameTest == null && position == LocationStepQueryNode.NONE;
+    }
+
+    /**
+    //-------------------< JackrabbitQuery >------------------------------------
+
+    /**
+     * {@inheritDoc}
+     */
+    public QueryHits execute(JackrabbitIndexSearcher searcher,
+                             SessionImpl session,
+                             Sort sort)
+            throws IOException {
+        if (sort.getSort().length == 0 && matchesAnyChildNode()) {
+            Query context = getContextQuery();
+            return new ChildNodesQueryHits(searcher.execute(context, sort), session);
+        } else {
+            return null;
+        }
+    }
+

INS26 INS40 UPD40 INS43 INS31 INS31 INS31 INS42 INS29 INS43 INS42 INS8 INS29 INS39 INS42 INS8 INS29 INS83 INS43 INS42 INS44 INS44 INS44 INS43 INS8 INS65 INS42 INS41 INS65 INS41 INS65 INS42 INS43 INS42 INS43 INS42 INS43 INS42 INS42 INS25 INS66 INS42 INS66 INS66 INS27 INS65 INS42 INS42 INS42 INS27 INS8 INS8 INS27 INS27 INS27 INS32 INS60 INS41 INS41 INS42 INS33 INS42 INS40 INS22 INS34 INS42 INS43 INS59 INS14 INS33 INS32 INS42 INS42 INS42 INS32 INS43 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42