JCR-455: InternalXAResource.rollback() can be called twice and without prepare
JCR-414: jcr:successors property not persisted correctly within a transaction


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@412995 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.SessionImpl;
+import org.apache.jackrabbit.core.SessionImpl;
+import javax.jcr.InvalidItemStateException;
-import javax.jcr.RepositoryException;
-import javax.jcr.UnsupportedRepositoryOperationException;
-import javax.jcr.nodetype.NodeDefinition;
+import javax.jcr.RepositoryException;
+import javax.jcr.nodetype.NodeDefinition;
-    protected abstract InternalVersion getInternalVersion()
-            throws RepositoryException;
+    protected InternalVersion getInternalVersion() throws RepositoryException {
+        InternalVersion version =
+                session.getVersionManager().getVersion((NodeId) id);
+        if (version == null) {
+            throw new InvalidItemStateException(id + ": the item does not exist anymore");
+        }
+        return version;
+    }
-    public String getUUID() throws UnsupportedRepositoryOperationException, RepositoryException {
-        return getInternalVersion().getId().getUUID().toString();
-    }
-
-    /**
-     * {@inheritDoc}
-     */

MOV26 MOV26 MOV26 MOV26 UPD40 INS31 MOV29 MOV83 MOV43 MOV42 MOV43 INS8 INS60 INS25 INS41 INS43 INS59 INS27 INS8 INS42 UPD42 MOV42 INS42 INS32 INS42 INS33 INS53 INS32 INS42 INS11 INS14 INS42 INS42 INS43 INS42 INS43 INS27 UPD42 MOV42 INS42 INS42 INS45 DEL83 DEL31 DEL65 DEL65 DEL29 DEL83 DEL43 DEL42 DEL42 DEL43 DEL43 DEL42 DEL32 DEL42 DEL32 DEL42 DEL32 DEL42 DEL32 DEL41 DEL8 DEL31