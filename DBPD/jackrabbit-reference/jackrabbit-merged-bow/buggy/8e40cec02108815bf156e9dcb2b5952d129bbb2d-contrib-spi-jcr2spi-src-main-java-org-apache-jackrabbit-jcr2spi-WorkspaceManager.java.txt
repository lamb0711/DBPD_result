div

- get rid of rootId stored with ISM, HierarchyManagers etc.
- remove corresponding method with WorkspaceManager and WorkspaceImpl

jcr2spi/state/ItemState

- move parent field from Node/PropertyState to ItemState
- move idFactory field from NodeState to ItemState
- let PropertyState build its id instead of calling parentstate method.
- minor reordering of status related methods
- remove modCount and its usage

jcr2spi/state/ItemStateManager

- add method getRootNode()

jcr2spi/security/AccessManager

- replace ItemId by ItemState

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@431352 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.jcr2spi.state.NodeState;
+import org.apache.jackrabbit.jcr2spi.state.ItemStateManager;
+import org.apache.jackrabbit.name.Path;
-import org.apache.jackrabbit.name.Path;
-    // TODO: TO-BE-FIXED. With SPI_ItemId rootId must not be stored separately
-    private final NodeId rootNodeId;
-
-            rootNodeId = createRootNodeId();
-    public NodeId getRootNodeId() {
-        return rootNodeId;
-    }
-
-    private NodeId createRootNodeId() throws RepositoryException {
-        return service.getRootId(sessionInfo);
-    }
-
+     * @see ItemStateManager#getRootState()
+     */
+    public NodeState getRootState() throws ItemStateException {
+        // retrieve through cache
+        synchronized (cache) {
+            return cache.getRootState();
+        }
+    }
+
+    /**
+     * @inheritDoc
+     * @see ItemStateManager#getItemState(ItemId)
+     * @see ItemStateManager#hasItemState(ItemId)
+     * @see ItemStateManager#getNodeReferences(NodeId)
+     * @see ItemStateManager#hasNodeReferences(NodeId)
-                service.removeEventListener(sessionInfo, rootNodeId, externalChangeListener);
+                service.removeEventListener(sessionInfo, service.getRootId(sessionInfo), externalChangeListener);
-    // TODO: method can be removed, if jcr2spi uses spi-ids as well
-    public boolean isGranted(NodeId parentId, Path relPath, String[] actions) throws ItemNotFoundException, RepositoryException {
+    /**
+     * @see AccessManager#isGranted(NodeState, Path, String[])
+     */
+    public boolean isGranted(NodeState parentState, Path relPath, String[] actions) throws ItemNotFoundException, RepositoryException {
-        ItemId id = getIdFactory().createNodeId(parentId, relPath);
-        return isGranted(id, actions);
-    }
-
-    public boolean isGranted(ItemId id, String[] actions) throws ItemNotFoundException, RepositoryException {
+        ItemId id = getIdFactory().createNodeId(parentState.getNodeId(), relPath);
-    public boolean canRead(ItemId id) throws ItemNotFoundException, RepositoryException {
-        return service.isGranted(sessionInfo, id, AccessManager.READ);
+    /**
+     * @see AccessManager#isGranted(ItemState, String[])
+     */
+    public boolean isGranted(ItemState itemState, String[] actions) throws ItemNotFoundException, RepositoryException {
+        return service.isGranted(sessionInfo, itemState.getId(), actions);
-    public boolean canRemove(ItemId id) throws ItemNotFoundException, RepositoryException {
-        return service.isGranted(sessionInfo, id, AccessManager.REMOVE);
+    /**
+     * @see AccessManager#canRead(ItemState)
+     */
+    public boolean canRead(ItemState itemState) throws ItemNotFoundException, RepositoryException {
+        return service.isGranted(sessionInfo, itemState.getId(), AccessManager.READ);
+    /**
+     * @see AccessManager#canRemove(ItemState)
+     */
+    public boolean canRemove(ItemState itemState) throws ItemNotFoundException, RepositoryException {
+        return service.isGranted(sessionInfo, itemState.getId(), AccessManager.REMOVE);
+    }
+
+    /**
+     * @see AccessManager#canAccess(String)
+     */

MOV26 INS26 INS26 INS40 INS40 INS31 INS31 INS31 INS29 MOV83 UPD43 MOV43 UPD42 MOV42 INS43 INS8 INS29 MOV83 MOV39 MOV42 MOV44 MOV44 MOV44 MOV43 MOV43 MOV8 INS29 MOV83 MOV39 MOV42 MOV44 MOV44 MOV43 MOV43 INS8 INS29 MOV43 MOV43 INS29 MOV43 MOV43 INS29 INS65 INS65 UPD42 INS42 INS51 INS65 INS65 INS65 INS65 INS65 UPD43 UPD42 INS60 INS65 UPD43 UPD42 INS41 INS65 UPD43 UPD42 INS65 UPD43 UPD42 INS65 INS68 INS42 INS8 INS68 INS68 INS68 INS68 INS68 UPD42 MOV43 INS59 INS68 UPD42 INS32 INS68 UPD42 INS68 UPD42 INS68 INS42 INS42 MOV41 INS42 INS42 INS69 INS42 INS42 INS69 INS42 INS42 INS69 INS42 INS42 INS69 INS42 INS42 INS69 INS69 INS69 INS42 INS32 INS42 INS42 INS69 INS69 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS69 INS32 INS42 INS42 INS69 INS32 INS42 INS42 INS69 INS32 INS43 INS43 MOV43 INS43 MOV8 INS43 INS43 INS5 MOV32 INS42 INS32 INS42 INS43 INS5 INS42 INS42 INS43 INS42 UPD42 MOV42 INS43 INS42 UPD42 MOV42 INS43 INS42 INS42 INS42 INS42 INS42 INS21 INS42 UPD42 MOV42 INS43 INS85 INS42 INS42 INS42 INS43 INS85 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 MOV32 INS42 DEL83 DEL83 DEL42 DEL43 DEL42 DEL59 DEL23 DEL42 DEL42 DEL32 DEL7 DEL21 DEL8 DEL31 DEL42 DEL83 DEL42 DEL43 DEL31 DEL41 DEL42 DEL42 DEL42 DEL42 DEL42 DEL32 DEL21 DEL8 DEL42 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL42 DEL32 DEL41 DEL8 DEL31 DEL31