JCR-1588 JSR 283: Access Control

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@748247 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.security.authorization.JackrabbitAccessControlPolicy;
-        AccessControlPolicy acl;
-        NodeImpl aclNode = getAclNode(nodePath);
+        AccessControlPolicy acl = null;
+        NodeImpl controlledNode = getNode(nodePath);
+        NodeImpl aclNode = getAclNode(controlledNode);
-            // create an empty acl
-            acl = new ACLTemplate(nodePath, session.getPrincipalManager(), privilegeRegistry);
+            // create an empty acl unless the node is protected or cannot have
+            // rep:AccessControllable mixin set (e.g. due to a lock)
+            String mixin = session.getJCRName(NT_REP_ACCESS_CONTROLLABLE);
+            if (controlledNode.isNodeType(mixin) || controlledNode.canAddMixin(mixin)) {
+                acl = new ACLTemplate(nodePath, session.getPrincipalManager(), privilegeRegistry);
+            }
-        return new AccessControlPolicy[] {acl};
+        return (acl != null) ? new AccessControlPolicy[] {acl} : new AccessControlPolicy[0];
-    public AccessControlPolicy[] editAccessControlPolicies(Principal principal) throws AccessDeniedException, AccessControlException, RepositoryException {
+    public JackrabbitAccessControlPolicy[] editAccessControlPolicies(Principal principal) throws AccessDeniedException, AccessControlException, RepositoryException {
-        return new AccessControlPolicy[0];
+        return new JackrabbitAccessControlPolicy[0];
-     * Returns the rep:Policy node below the Node identified by the given
-     * id or <code>null</code> if the node is not mix:AccessControllable
+     * Returns the rep:Policy node below the Node identified at the given
+     * path or <code>null</code> if the node is not mix:AccessControllable
+        NodeImpl controlledNode = getNode(nodePath);
+        return getAclNode(controlledNode);
+    }
+
+    /**
+     * Returns the rep:Policy node below the given Node or <code>null</code>
+     * if the node is not mix:AccessControllable or if no policy node exists.
+     *
+     * @param controlledNode
+     * @return node or <code>null</code>
+     * @throws RepositoryException
+     */
+    private NodeImpl getAclNode(NodeImpl controlledNode) throws RepositoryException {
-        NodeImpl protectedNode = getNode(nodePath);
-        if (ACLProvider.isAccessControlled(protectedNode)) {
-            aclNode = protectedNode.getNode(N_POLICY);
+        if (ACLProvider.isAccessControlled(controlledNode)) {
+            aclNode = controlledNode.getNode(N_POLICY);

INS26 INS40 INS31 UPD5 INS43 INS42 INS43 INS8 INS29 INS83 MOV43 INS42 INS44 MOV43 INS8 INS60 UPD43 INS42 INS42 MOV60 INS41 INS65 INS65 INS65 INS65 INS43 INS42 MOV60 INS25 MOV41 MOV43 INS59 INS43 INS8 INS16 UPD42 UPD66 UPD66 INS32 INS66 INS66 INS42 INS66 INS42 INS42 INS32 INS8 INS33 INS42 INS32 INS42 INS60 INS25 INS36 MOV3 INS3 UPD5 UPD42 UPD42 MOV42 UPD42 MOV42 INS42 INS42 INS42 INS21 INS42 INS42 UPD42 INS43 INS59 INS27 MOV8 INS27 INS5 INS34 UPD43 INS7 INS42 INS42 INS32 INS32 INS32 INS42 INS33 INS43 INS85 UPD42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL7 DEL21 DEL8 DEL25 DEL8