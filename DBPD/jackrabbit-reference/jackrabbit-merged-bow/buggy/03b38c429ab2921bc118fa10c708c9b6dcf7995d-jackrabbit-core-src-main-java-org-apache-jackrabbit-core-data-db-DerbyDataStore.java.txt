JCR-1456: Database connection pooling

Merge back all changes from the JCR-1456 sandbox branch.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@886191 13f79535-47bb-0310-9956-ffa450edef68

-import java.sql.DriverManager;
+import javax.sql.DataSource;
+
-import org.apache.jackrabbit.core.persistence.bundle.DerbyPersistenceManager;
-import org.apache.jackrabbit.core.persistence.bundle.util.ConnectionRecoveryManager;
-import org.slf4j.Logger;
-import org.slf4j.LoggerFactory;
+import org.apache.jackrabbit.core.util.db.ConnectionHelper;
+import org.apache.jackrabbit.core.util.db.DerbyConnectionHelper;
-     * Logger instance
+     * {@inheritDoc}
-    private static Logger log = LoggerFactory.getLogger(DerbyDataStore.class);
+    @Override
+    protected ConnectionHelper createConnectionHelper(DataSource dataSrc) throws Exception {
+        return new DerbyConnectionHelper(dataSrc, false);
+    }
+    /**
+     * {@inheritDoc}
+     */
+    @Override
-
-        // check for embedded driver
-        if (!DerbyPersistenceManager.DERBY_EMBEDDED_DRIVER.equals(getDriver())) {
-            return;
-        }
-
-
-            // prepare connection url for issuing shutdown command
-            ConnectionRecoveryManager connectionManager = getConnection();
-
-            String url = connectionManager.getConnection().getMetaData().getURL();
-            int pos = url.lastIndexOf(';');
-            if (pos != -1) {
-                // strip any attributes from connection url
-                url = url.substring(0, pos);
-            }
-            url += ";shutdown=true";
-
-            // we have to reset the connection to 'autoCommit=true' before closing it;
-            // otherwise Derby would mysteriously complain about some pending uncommitted
-            // changes which can't possibly be true.
-            // @todo further investigate
-            connectionManager.getConnection().setAutoCommit(true);
-
-            // need to call it again because we just opened a connection,
-            // and super.close() closes it.
-            super.close();
-
-            // now it's safe to shutdown the embedded Derby database
-            try {
-                DriverManager.getConnection(url);
-            } catch (SQLException e) {
-                // a shutdown command always raises a SQLException
-                log.info(e.getMessage());
-            }
-        } catch (Exception e) {
+            ((DerbyConnectionHelper) conHelper).shutDown(getDriver());
+        } catch (SQLException e) {

MOV26 UPD40 UPD40 UPD40 INS31 INS29 INS78 INS83 INS43 INS42 INS44 MOV43 INS8 INS29 INS78 INS65 INS42 UPD42 MOV42 INS43 INS42 INS41 INS65 INS42 INS65 INS42 INS14 INS65 INS43 INS42 INS9 MOV44 UPD42 MOV42 INS36 UPD42 MOV32 INS11 INS43 INS42 INS42 DEL40 DEL26 DEL40 DEL26 DEL66 DEL65 DEL29 DEL83 DEL83 DEL43 DEL42 DEL42 DEL42 DEL43 DEL57 DEL32 DEL59 DEL23 DEL40 DEL42 DEL32 DEL38 DEL41 DEL8 DEL25 DEL42 DEL43 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL42 DEL32 DEL59 DEL60 DEL39 DEL42 DEL42 DEL42 DEL13 DEL32 DEL59 DEL60 DEL42 DEL34 DEL38 DEL27 DEL42 DEL42 DEL42 DEL34 DEL42 DEL32 DEL7 DEL21 DEL8 DEL25 DEL42 DEL45 DEL7 DEL21 DEL42 DEL42 DEL32 DEL9 DEL42 DEL48 DEL21 DEL42 DEL42 DEL42 DEL32 DEL21 DEL8 DEL42 DEL42 DEL42 DEL42 DEL32 DEL32 DEL21 DEL8 DEL12 DEL54 DEL42 DEL44