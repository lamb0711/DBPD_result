JCR-2061: JSR 283: References and Dereferencing of Property Values

- Dereferencing of Property Values both in jackrabbit-core and jackrabbit-jcr2spi
   > Property.getNode()
   > Property.getProperty()

- Adjusting testcases in jackrabbit-jcr-tests


TODO:

- similar testcases for the new Property types (still missing)
- new reference methods as listed in the issue
- support for weak-refs


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@772352 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.spi.Path;
-        QValue value = getQValue();
-        if (value.getType() == PropertyType.REFERENCE) {
-            return session.getNodeByUUID(value.getString());
-        } else {
-            throw new ValueFormatException("Property must be of type REFERENCE (" + safeGetJCRPath() + ")");
+        Value value = getValue();
+        int type = value.getType();
+        switch (type) {
+            case PropertyType.REFERENCE:
+            case PropertyType.WEAKREFERENCE:
+                return session.getNodeByUUID(value.getString());
+
+            case PropertyType.PATH:
+            case PropertyType.NAME:
+                String path = value.getString();
+                Path p = session.getPathResolver().getQPath(path);
+                boolean absolute = p.isAbsolute();
+                return (absolute) ? session.getNode(path) : getParent().getNode(path);
+
+            case PropertyType.STRING:
+                try {
+                    Value refValue = ValueHelper.convert(value, PropertyType.REFERENCE, session.getValueFactory());
+                    return session.getNodeByUUID(refValue.getString());
+                } catch (RepositoryException e) {
+                    // try if STRING value can be interpreted as PATH value
+                    Value pathValue = ValueHelper.convert(value, PropertyType.PATH, session.getValueFactory());
+                    p = session.getPathResolver().getQPath(pathValue.getString());
+                    absolute = p.isAbsolute();
+                    return (absolute) ? session.getNode(pathValue.getString()) : getParent().getNode(pathValue.getString());
+                }
+
+            default:
+                throw new ValueFormatException("Property value cannot be converted to a PATH, REFERENCE or WEAKREFERENCE");
-        // TODO JCR-1609 - this should probably be handled a bit better...
-        return getParent().getProperty(getString());
+        Value value = getValue();
+        Value pathValue = ValueHelper.convert(value, PropertyType.PATH, session.getValueFactory());
+        String path = pathValue.getString();
+        boolean absolute;
+        try {
+            Path p = session.getPathResolver().getQPath(path);
+            absolute = p.isAbsolute();
+        } catch (RepositoryException e) {
+            throw new ValueFormatException("Property value cannot be converted to a PATH");
+        }
+        return (absolute) ? session.getProperty(path) : getParent().getProperty(path);
-

INS26 INS40 INS60 INS50 INS60 INS60 INS60 INS60 INS54 UPD43 INS39 INS59 INS42 INS49 INS49 MOV41 INS49 INS49 INS60 INS60 INS60 INS41 INS49 INS54 INS49 INS53 INS43 INS59 INS43 INS59 INS43 INS59 INS39 INS59 INS8 INS12 INS16 UPD42 INS42 MOV32 INS40 INS40 INS40 INS40 INS43 INS59 INS43 INS59 INS39 INS59 INS16 INS40 INS8 INS12 MOV14 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS60 INS21 INS44 INS8 INS36 INS32 INS32 UPD42 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS32 INS36 INS32 INS32 INS60 INS41 INS44 INS8 INS45 INS42 INS42 INS42 INS42 INS40 INS32 INS42 INS42 INS43 INS59 INS7 INS43 INS42 INS53 INS42 INS42 MOV42 INS42 MOV32 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 MOV32 INS42 INS42 INS43 INS59 INS32 INS43 INS42 INS60 INS21 INS21 INS41 INS42 INS42 INS42 INS42 INS32 INS42 INS32 INS42 INS14 UPD42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS43 INS59 INS7 INS7 INS16 INS32 INS42 INS42 INS42 INS42 INS43 INS45 INS42 INS42 INS42 INS40 INS32 INS42 INS42 INS42 INS42 INS32 INS42 INS32 INS42 INS32 INS36 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS40 INS32 INS32 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS32 INS32 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL45 DEL42 DEL32 DEL45 DEL27 DEL40 DEL27 DEL8 DEL53 DEL8 DEL25 DEL32