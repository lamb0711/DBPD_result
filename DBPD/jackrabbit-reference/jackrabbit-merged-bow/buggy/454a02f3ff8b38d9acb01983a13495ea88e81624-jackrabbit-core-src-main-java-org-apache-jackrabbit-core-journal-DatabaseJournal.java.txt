JCR-2882 DatabaseJournal: java.lang.IllegalStateException: already in batch mode

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1067983 13f79535-47bb-0310-9956-ffa450edef68

-    private static Logger log = LoggerFactory.getLogger(DatabaseJournal.class);
+    static Logger log = LoggerFactory.getLogger(DatabaseJournal.class);
-    private ConnectionHelper conHelper;
+    ConnectionHelper conHelper;
-    private int janitorSleep = 60 * 60 * 24;
+    int janitorSleep = 60 * 60 * 24;
-    private Calendar janitorNextRun = Calendar.getInstance();
+    Calendar janitorNextRun = Calendar.getInstance();
+
-    
+
-    
+
-     * SQL statement for inserting the local revision of this cluster node. 
+     * SQL statement for inserting the local revision of this cluster node.
-     * SQL statement for updating the local revision of this cluster node. 
+     * SQL statement for updating the local revision of this cluster node.
-     * 
+     *
-     * 
+     *
-            conHelper.startBatch();
+            startBatch();
-                conHelper.endBatch(true);
+                endBatch(true);
-            if (lockLevel++ == 0) {
-                conHelper.startBatch();
-            }
+            startBatch();
-
+        endBatch(successful);
+    }
+
+    private void startBatch() throws SQLException {
+        if (lockLevel++ == 0) {
+            conHelper.startBatch();
+        }
+    }
+
+    private void endBatch(boolean successful) {
-     * 
+     *
-     * 
+     *
-     * 
+     *
-     * 
+     *
-         * Indicates whether the init method has been called. 
+         * Indicates whether the init method has been called.
-        /**
-         * {@inheritDoc}
-         */
-        /**
-         * {@inheritDoc}
-         */
-        
-        /**
-         * {@inheritDoc}
-         */
+
+            // nothing to do
-        
+

INS31 INS31 MOV29 INS83 INS39 INS42 INS44 INS8 INS83 INS39 INS42 INS43 MOV8 UPD83 UPD42 INS39 INS42 INS21 INS42 UPD66 UPD66 INS8 INS32 INS21 INS42 INS42 UPD66 INS32 INS42 DEL83 DEL83 DEL83 DEL83 DEL42 DEL42 DEL65 DEL65 DEL29 DEL65 DEL65 DEL29 DEL65 DEL65 DEL29