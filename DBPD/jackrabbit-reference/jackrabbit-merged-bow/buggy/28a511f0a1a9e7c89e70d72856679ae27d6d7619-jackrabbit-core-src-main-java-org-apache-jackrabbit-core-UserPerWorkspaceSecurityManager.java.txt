JCR-2573 - Performance of AC Evaluation [work in progress]

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@950440 13f79535-47bb-0310-9956-ffa450edef68

+    private final Object monitor = new Object();
-        PrincipalProviderRegistry p = ppRegistries.get(wspName);
-        if (p == null) {
-            SystemSession systemSession;
-            if (s instanceof SystemSession) {
-                systemSession = (SystemSession) s;
-            } else {
-                RepositoryImpl repo = (RepositoryImpl) getRepository();
-                systemSession = repo.getSystemSession(wspName);
-                // TODO: review again... this workaround is used in several places.
-                repo.onSessionCreated(systemSession);
-            }
+        synchronized (monitor) {
+            PrincipalProviderRegistry p = ppRegistries.get(wspName);
+            if (p == null) {
+                SystemSession systemSession;
+                if (s instanceof SystemSession) {
+                    systemSession = (SystemSession) s;
+                } else {
+                    RepositoryImpl repo = (RepositoryImpl) getRepository();
+                    systemSession = repo.getSystemSession(wspName);
+                    // TODO: review again... this workaround is used in several places.
+                    repo.onSessionCreated(systemSession);
+                }
-            PrincipalProvider defaultPP = new DefaultPrincipalProvider(systemSession, (UserManagerImpl) getUserManager(systemSession));
-            defaultPP.init(new Properties());
-            
-            p = new WorkspaceBasedPrincipalProviderRegistry(defaultPP);
-            ppRegistries.put(wspName, p);
+                PrincipalProvider defaultPP = new DefaultPrincipalProvider(systemSession, (UserManagerImpl) getUserManager(systemSession));
+                defaultPP.init(new Properties());
+
+                p = new WorkspaceBasedPrincipalProviderRegistry(defaultPP);
+                ppRegistries.put(wspName, p);
+            }
+            return p;
-        return p;
-        synchronized (ppRegistries) {
+        synchronized (monitor) {
-        synchronized (ppRegistries) {
+        synchronized (monitor) {

INS23 INS83 INS83 INS43 INS59 INS42 INS42 INS14 INS51 INS43 INS42 INS8 UPD42 UPD42 INS42 MOV60 MOV25 MOV41