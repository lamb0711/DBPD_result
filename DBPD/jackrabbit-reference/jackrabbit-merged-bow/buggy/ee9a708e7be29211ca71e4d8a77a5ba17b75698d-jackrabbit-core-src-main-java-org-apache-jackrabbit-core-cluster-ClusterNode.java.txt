JCR-623 - Clustering
+ Synchronize journal before updating
+ Leave journal in valid state, when error occurs


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@486054 13f79535-47bb-0310-9956-ffa450edef68

+        boolean succeeded = false;
+
+            succeeded = true;
+        } finally {
+            if (!succeeded) {
+                journal.cancel();
+            }
+        boolean succeeded = false;
+
+            succeeded = true;
+        } finally {
+            if (!succeeded) {
+                journal.cancel();
+            }
-     * <p/>
-     * Invoked when an update has been created inside versioning. Delegate
-     * to common method with <code>null</code> workspace.
-    public void updateCreated(ChangeLog changes, EventStateCollection esc) {
-        updateCreated(null, changes, esc);
-    }
-
-    /**
-     * Called when an a update operation has been created.
-     *
-     * @param workspace workspace to use when writing journal entry
-     * @param changes changes
-     * @param esc events as they will be delivered on success
-     */
-    private void updateCreated(String workspace, ChangeLog changes, EventStateCollection esc) {
+    public void updateCreated() {
-            journal.begin(workspace);
-            journal.log(changes, esc);
-        } catch (JournalException e) {
-            String msg = "Unable to create log entry: " + e.getMessage();
+            sync();
+        } catch (ClusterException e) {
+            String msg = "Unable to sync with journal: " + e.getMessage();
+     * <p/>
+     * Invoked when an update has been prepared inside versioning. Delegate
+     * to common method with <code>null</code> workspace.
-    public void updatePrepared() {
+    public void updatePrepared(ChangeLog changes, EventStateCollection esc) {
+        updatePrepared(null, changes, esc);
+    }
+
+    /**
+     * Called when an a update operation has been prepared.
+     *
+     * @param workspace workspace to use when writing journal entry
+     * @param changes changes
+     * @param esc events as they will be delivered on success
+     */
+    private void updatePrepared(String workspace, ChangeLog changes, EventStateCollection esc) {
+        boolean succeeded = false;
+
+            journal.begin(workspace);
+            journal.log(changes, esc);
+            succeeded = true;
+        } finally {
+            if (!succeeded) {
+                journal.cancel();
+            }
-        try {
-            journal.cancel();
-        } catch (JournalException e) {
-            String msg = "Unable to create log entry: " + e.getMessage();
-            log.error(msg);
-        } catch (Throwable e) {
-            String msg = "Unexpected error while cancelling log entry.";
-            log.error(msg, e);
-        }
+        journal.cancel();
+        boolean succeeded = false;
+
+            succeeded = true;
+        } finally {
+            if (!succeeded) {
+                journal.cancel();
+            }
+        boolean succeeded = false;
+
+            succeeded = true;
+        } finally {
+            if (!succeeded) {
+                journal.cancel();
+            }
-        public void updateCreated(ChangeLog changes, EventStateCollection esc) {
-            ClusterNode.this.updateCreated(workspace, changes, esc);
+        public void updateCreated() {
+            ClusterNode.this.updateCreated();
-        public void updatePrepared() {
-            ClusterNode.this.updatePrepared();
+        public void updatePrepared(ChangeLog changes, EventStateCollection esc) {
+            ClusterNode.this.updatePrepared(workspace, changes, esc);

INS31 INS31 INS31 MOV31 MOV29 MOV83 MOV39 MOV42 INS8 INS29 MOV83 MOV39 UPD42 MOV42 MOV44 MOV44 INS8 MOV29 UPD83 MOV44 MOV44 MOV44 MOV29 INS83 INS39 INS42 INS8 INS60 INS60 INS54 INS65 MOV21 INS60 MOV21 INS60 INS60 UPD42 UPD42 INS39 INS59 INS8 INS39 INS59 INS8 INS8 MOV12 MOV12 INS65 INS66 INS66 INS66 UPD66 INS39 INS59 MOV8 INS8 INS39 INS59 INS8 INS39 INS59 INS8 INS42 INS9 INS21 INS25 INS42 INS9 INS21 INS25 MOV21 UPD42 INS33 UPD42 UPD42 INS42 INS9 INS21 INS21 INS25 UPD42 UPD42 INS42 INS9 INS21 INS25 INS42 INS9 INS21 INS25 INS7 INS38 INS8 INS7 INS38 INS8 UPD43 INS32 INS7 INS38 MOV8 INS7 INS38 INS8 INS7 INS38 INS8 UPD42 UPD42 INS42 INS9 INS42 INS21 INS42 INS9 INS42 INS21 UPD42 UPD42 MOV43 INS42 INS42 INS42 INS9 INS42 INS42 INS9 INS42 INS21 INS42 INS9 INS42 INS21 INS32 INS32 INS32 INS32 INS42 INS42 INS42 INS42 UPD45 UPD42 MOV42 INS42 INS42 INS42 INS42 DEL42 DEL33 DEL42 DEL42 DEL43 DEL65 DEL66 DEL66 DEL66 DEL65 DEL29 DEL8 DEL31 DEL83 DEL39 DEL42 DEL54 DEL8 DEL31 DEL8 DEL42 DEL42 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL45 DEL42 DEL42 DEL32 DEL27 DEL59 DEL60 DEL8 DEL12 DEL42 DEL43 DEL42 DEL44 DEL42 DEL45 DEL59 DEL60 DEL8 DEL12 DEL54 DEL8 DEL31