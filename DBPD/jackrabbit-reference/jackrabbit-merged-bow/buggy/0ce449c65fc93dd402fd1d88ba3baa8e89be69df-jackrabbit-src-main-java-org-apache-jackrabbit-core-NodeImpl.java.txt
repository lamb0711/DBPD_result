JCR_423 Node.restore() fails for existing non-versioned OPV=Version child nodes

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@405417 13f79535-47bb-0310-9956-ffa450edef68

-        // first delete all non frozen version histories (i.e. all OPV=Copy)
+        // first delete some of the version histories
-            if (!freeze.hasFrozenHistory(n.internalGetUUID())) {
-                if (n.getDefinition().getOnParentVersion() == OnParentVersionAction.COPY) {
-                    // only remove OPV=Copy nodes
+            if (n.getDefinition().getOnParentVersion() == OnParentVersionAction.COPY) {
+                // only remove OPV=Copy nodes
+                n.internalRemove(true);
+            } else if (n.getDefinition().getOnParentVersion() == OnParentVersionAction.VERSION) {
+                // only remove, if node to be restored does not contain child
+                UUID vhUUID = new UUID(n.getProperty(QName.JCR_VERSIONHISTORY).getString());
+                if (!freeze.hasFrozenHistory(vhUUID)) {

INS25 MOV27 MOV8 INS25 INS27 INS8 INS32 INS40 INS60 MOV25 INS32 INS42 INS43 INS59 INS42 INS42 INS42 INS42 INS14 INS21 INS43 INS32 UPD42 MOV42 INS32 INS42 INS32 INS42 INS42 INS42 INS9 INS42 INS42 INS40 DEL42 DEL32 DEL25