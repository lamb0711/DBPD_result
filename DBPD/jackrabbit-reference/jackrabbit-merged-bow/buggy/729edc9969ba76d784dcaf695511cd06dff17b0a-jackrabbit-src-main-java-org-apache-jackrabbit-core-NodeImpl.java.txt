JCR-428 BLOBFileValues might be discarded to early

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@407709 13f79535-47bb-0310-9956-ffa450edef68

-            // todo: does not work properly for samename siblings
-            if (!srcNode.hasNode(n.getQName())) {
+            Path.PathElement name = n.getPrimaryPath().getNameElement();
+            int idx = name.getIndex();
+            if (idx == 0) {
+                idx = 1;
+            }
+            if (!srcNode.hasNode(name.getName(), idx)) {
-            if (hasNode(child.getQName())) {
-                // todo: does not work properly for samename siblings
-                dstNode = getNode(child.getQName());
-            } else if (child.isNodeType(QName.MIX_REFERENCEABLE)) {
-                // if child is referenceable, check if correspondance exist in this workspace
+            Path.PathElement name = child.getPrimaryPath().getNameElement();
+            int idx = name.getIndex();
+            if (idx == 0) {
+                idx = 1;
+            }
+
+            if (child.isNodeType(QName.MIX_REFERENCEABLE)) {
+                // check if correspondance exist in
+                // this workspace
-                    if (removeExisting) {
-                        dstNode.internalRemove(false);
-                        dstNode = null;
-                    } else if (replaceExisting) {
-                        // node exists outside of this update tree, so continue there
-                    } else {
-                        throw new ItemExistsException("Unable to update node: " + dstNode.safeGetJCRPath());
+                    // check if same parent
+                    if (!dstNode.getParent().isSame(srcNode)) {
+                        if (removeExisting) {
+                            dstNode.internalRemove(false);
+                            dstNode = null;
+                        } else if (replaceExisting) {
+                            // node exists outside of this update tree, so continue there
+                        } else {
+                            throw new ItemExistsException("Unable to update node: " + dstNode.safeGetJCRPath());
+                        }
+
+            if (dstNode == null && hasNode(name.getName(), idx)) {
+                // the exact behaviour for SNS is not specified by the spec
+                // so we just try to find the corresponding one.
+                dstNode = getNode(name.getName(), idx);
+            }
-                dstNode = internalAddChildNode(child.getQName(), (NodeTypeImpl) child.getPrimaryNodeType(), childId);
+                dstNode = internalAddChildNode(name.getName(), (NodeTypeImpl) child.getPrimaryNodeType(), childId);

INS60 INS60 INS25 INS60 INS60 INS25 MOV25 INS43 INS59 INS39 INS59 INS27 INS8 INS43 INS59 INS39 INS59 INS27 INS8 INS27 INS40 INS42 INS32 INS42 INS32 INS42 INS34 INS21 INS40 INS42 INS32 INS42 INS32 INS42 INS34 INS21 INS27 INS32 INS32 INS42 INS42 INS42 INS7 INS42 INS32 INS42 INS42 INS42 INS7 INS8 INS42 INS33 MOV42 MOV32 INS42 INS42 INS42 INS42 INS34 UPD42 UPD42 INS42 INS42 INS42 INS34 MOV21 INS25 UPD42 UPD42 INS38 MOV8 INS42 INS32 UPD42 UPD42 UPD42 UPD42 INS32 INS42 INS42 INS42 INS42 DEL32