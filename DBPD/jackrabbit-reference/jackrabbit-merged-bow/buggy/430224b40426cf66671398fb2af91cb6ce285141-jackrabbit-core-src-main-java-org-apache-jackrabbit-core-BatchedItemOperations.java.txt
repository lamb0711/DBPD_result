JCR-2058 JSR 283: VersionManager and new versioning methods
- added jcr:copiedFrom property to version history


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@778802 13f79535-47bb-0310-9956-ffa450edef68

+            // init version history if needed
+            VersionHistoryInfo history = null;
+            if (versionable && flag == COPY) {
+                NodeId copiedFrom = null;
+                if (fullVersionable) {
+                    // base version of copied versionable node is reference value of
+                    // the histories jcr:copiedFrom property
+                    PropertyId propId = new PropertyId(srcState.getNodeId(), NameConstants.JCR_BASEVERSION);
+                    PropertyState prop = (PropertyState) srcStateMgr.getItemState(propId);
+                    copiedFrom = new NodeId(prop.getValues()[0].getUUID());
+                }
+                VersionManager manager = session.getVersionManager();
+                history = manager.getVersionHistory(session, newState, copiedFrom);
+            }
-                if (versionable && flag == COPY) {
-                    /**
-                     * a versionable node is being copied:
-                     * copied properties declared by mix:versionable need to be
-                     * adjusted accordingly.
-                     */
-                    VersionManager manager = session.getVersionManager();
+                if (history != null) {
-                            VersionHistoryInfo history =
-                                manager.getVersionHistory(session, newState);
-                            VersionHistoryInfo history =
-                                manager.getVersionHistory(session, newState);
-                            manager.getVersionHistory(session, newState);

INS60 INS25 MOV43 INS59 MOV27 INS8 INS42 INS33 INS60 INS25 MOV60 INS21 INS43 INS59 INS42 INS8 INS7 INS27 INS42 INS42 INS33 INS60 INS60 INS21 INS42 INS32 INS42 INS33 INS43 INS59 INS43 INS59 INS7 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS14 INS42 INS42 INS11 INS42 INS14 INS43 INS32 INS40 INS43 INS32 INS43 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS2 INS42 INS32 INS34 INS42 INS42 DEL42 DEL42 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL42 DEL42 DEL32 DEL21