JCR-2542: spi2dav: EventFilters not respected

- spi.commons extension interface for Session extension
- noLocal flag support
- client sends session identifier (in Link header field) on write operations so that POLL can compute the flag
- SUBSCRIBE returns flags indicating extension features 

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1203173 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.Enumeration;
+import org.apache.jackrabbit.spi.commons.SessionExtensions;
+    public static final String ATTRIBUTE_SESSION_ID = SessionProviderImpl.class + "#sessionid()";
+    
-        String userData = getJcrUserData(request);
+
+        // extract information from Link header fields
+        LinkHeaderFieldParser lhfp = new LinkHeaderFieldParser(
+                request.getHeaders("Link"));
+        String userData = getJcrUserData(lhfp);
+
+        String sessionId = getSessionIdentifier(lhfp);
+        if (s instanceof SessionExtensions) {
+            SessionExtensions xs = (SessionExtensions) s;
+            xs.setAttribute(ATTRIBUTE_SESSION_ID, sessionId);
+        }
-    private String getJcrUserData(HttpServletRequest request) {
+    private String getJcrUserData(LinkHeaderFieldParser lhfp) {
-        Enumeration<?> fieldValues = request.getHeaders("link");
-        if (fieldValues.hasMoreElements()) {
-            LinkHeaderFieldParser lhfp = new LinkHeaderFieldParser(fieldValues);
-            String target = lhfp
-                    .getFirstTargetForRelation(JcrRemotingConstants.RELATION_USER_DATA);
-            if (target != null) {
-                jcrUserData = getJcrUserData(target);
-            }
+        String target = lhfp
+                .getFirstTargetForRelation(JcrRemotingConstants.RELATION_USER_DATA);
+        if (target != null) {
+            jcrUserData = getJcrUserData(target);
+
+    // find first link relation for remote session identifier
+    private String getSessionIdentifier(LinkHeaderFieldParser lhfp) {
+        return lhfp
+                .getFirstTargetForRelation(JcrRemotingConstants.RELATION_REMOTE_SESSION_ID);
+    }
+

MOV26 UPD40 INS23 INS31 INS83 INS83 INS83 INS43 INS59 MOV8 INS83 INS43 INS42 INS44 INS8 INS42 INS42 INS27 INS60 INS60 INS25 MOV43 INS42 MOV60 MOV41 INS42 INS43 INS42 INS41 INS57 INS45 INS43 INS59 INS43 INS59 INS62 INS8 INS42 INS32 INS43 INS42 INS42 INS14 INS42 INS42 INS32 INS42 INS43 INS60 INS21 INS42 INS42 INS40 INS42 MOV43 INS32 UPD42 INS42 INS42 INS42 INS43 INS59 INS32 INS42 INS42 INS45 INS42 INS42 INS11 INS42 INS42 INS42 INS42 INS43 INS42 INS42 DEL42 DEL43 DEL42 DEL42 DEL42 DEL14 DEL59 DEL60 DEL42 DEL43 DEL76 DEL74 DEL42 DEL42 DEL42 DEL45 DEL32 DEL59 DEL60 DEL42 DEL42 DEL32 DEL25 DEL8