JCR-1589: JSR 283 Retention & Hold Management (work in progress)
JCR-1957: Move common validation checks to a single place

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@738422 13f79535-47bb-0310-9956-ffa450edef68

-import javax.jcr.Property;
-
-            // check if protected
-            ItemDefinition definition;
-            if (isNode()) {
-                definition = ((Node) this).getDefinition();
-            } else {
-                definition = ((Property) this).getDefinition();
-            }
-            if (definition.isProtected()) {
-                throw new ConstraintViolationException(
-                        "Cannot remove a protected item: " + this);
-            }
+            // check if protected and not under retention/hold
+            int options = ItemValidator.CHECK_CONSTRAINTS | ItemValidator.CHECK_HOLD |
+                    ItemValidator.CHECK_RETENTION;
+            session.getValidator().checkRemove(this, options, Permission.NONE);
-            // verify that parent node is checked-out and not protected
-            if (!parentNode.internalIsCheckedOut()) {
-                throw new VersionException(
-                        "Cannot remove a child of a checked-in node: " + this);
-            }
-            if (parentNode.getDefinition().isProtected()) {
-                throw new ConstraintViolationException(
-                        "Cannot remove a child of a protected node: " + this);
-            }
-
-            // check lock status
-            parentNode.checkLock();
+            // parent node: make sure it is checked-out and not protected nor locked.
+            options = ItemValidator.CHECK_LOCK | ItemValidator.CHECK_VERSIONING |
+                    ItemValidator.CHECK_CONSTRAINTS;
+            session.getValidator().checkModify(parentNode, options, Permission.NONE);

MOV21 MOV21 INS21 INS39 INS32 INS32 UPD42 INS27 INS32 INS42 INS52 UPD42 MOV42 INS40 UPD42 INS27 INS32 UPD42 MOV42 MOV42 INS42 INS40 INS40 INS40 INS40 INS42 INS42 INS40 INS40 INS40 UPD42 MOV42 UPD42 MOV42 DEL40 DEL26 DEL42 DEL43 DEL42 DEL42 DEL43 DEL52 DEL11 DEL36 DEL32 DEL7 DEL42 DEL43 DEL52 DEL11 DEL36 DEL42 DEL32 DEL42 DEL32 DEL8 DEL8 DEL25 DEL32 DEL42 DEL43 DEL45 DEL52 DEL27 DEL14 DEL53 DEL8 DEL25 DEL42 DEL32 DEL38 DEL42 DEL43 DEL45 DEL52 DEL27 DEL14 DEL53 DEL8 DEL25 DEL42 DEL32 DEL42 DEL32 DEL42 DEL43 DEL45 DEL52 DEL27 DEL14 DEL53 DEL8 DEL25 DEL42 DEL42 DEL32 DEL21