Added ItemStateManager#hasNodeReferences()
Added check for targets of modified node references in XAResource#prepare
Removed duplicated checkLock() in NodeImpl#addMixin


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@164071 13f79535-47bb-0310-9956-ffa450edef68

-        // create new one
-        return new NodeReferences(id);
+
+        // throw
+        throw new NoSuchItemStateException(id.toString());
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public boolean hasNodeReferences(NodeReferencesId id) {
+
+        // check persistence manager
+        try {
+            if (persistMgr.exists(id)) {
+                return true;
+            }
+        } catch (ItemStateException e) {
+            // ignore
+        }
+        // check virtual providers
+        for (int i = 0; i < virtualProviders.length; i++) {
+            if (virtualProviders[i].hasNodeReferences(id)) {
+                return true;
+            }
+        }
+        return false;
+     * Check targets of modified node references exist.
+     * @param log change log
+     * @throws ItemStateException if some target was not found
+     */
+    protected void checkTargetsExist(ChangeLog log) throws ItemStateException {
+        Iterator iter = log.modifiedRefs();
+        while (iter.hasNext()) {
+            NodeReferences refs = (NodeReferences) iter.next();
+            NodeId id = new NodeId(refs.getUUID());
+
+            for (int i = 0; i < virtualProviders.length; i++) {
+                VirtualItemStateProvider provider = virtualProviders[i];
+                if (provider.hasItemState(id)) {
+                    refs = null;
+                    break;
+                }
+            }
+            if (refs != null && refs.hasReferences()) {
+                if (!log.has(id) && !hasItemState(id)) {
+                    String msg = "Target node " + id
+                            + " of REFERENCE property does not exist";
+                    throw new ItemStateException(msg);
+                }
+            }
+        }
+    }
+
+    /**
-                    try {
-                        if (local.get(id) == null && !hasItemState(id)) {
-                            throw new NoSuchItemStateException();
-                        }
-                    } catch (NoSuchItemStateException e) {
+                    if (!local.has(id) && !hasItemState(id)) {

INS31 INS31 INS29 INS83 INS39 INS42 INS44 INS8 INS29 INS83 INS39 INS42 INS44 INS43 INS8 INS53 INS65 INS43 INS42 INS54 INS24 INS41 INS65 INS65 INS65 INS43 INS42 INS42 INS60 INS61 INS14 INS65 INS42 INS8 INS12 INS58 INS27 INS37 INS8 INS9 INS66 INS42 INS66 INS42 INS66 INS42 INS43 INS59 INS32 INS8 UPD43 MOV43 INS32 INS25 INS44 INS8 INS39 INS59 INS42 INS40 INS42 INS25 INS42 INS42 INS32 INS42 INS42 INS60 INS60 INS24 MOV25 INS25 UPD42 INS42 INS42 INS32 INS8 INS43 INS42 INS42 INS34 INS32 INS8 INS42 INS42 INS43 INS59 INS43 INS59 INS58 INS27 INS37 INS8 INS27 MOV27 INS8 INS42 INS42 INS42 INS41 INS42 INS2 INS42 INS42 INS41 INS42 INS42 INS11 INS42 INS42 INS14 INS39 INS59 INS42 INS40 INS42 INS60 INS25 INS27 INS32 MOV25 INS25 MOV21 INS9 INS42 INS42 INS9 INS43 INS32 INS43 INS32 INS42 INS34 INS43 INS59 INS32 INS8 INS42 INS33 INS42 INS42 MOV8 MOV32 INS8 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS2 INS42 INS42 INS42 INS21 INS10 INS38 MOV25 INS42 INS42 INS7 INS32 INS27 INS42 INS33 UPD42 MOV42 UPD42 MOV42 MOV42 INS38 INS38 INS60 INS53 INS32 INS32 INS43 INS59 INS14 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS27 INS43 INS42 INS45 INS42 INS45 INS42 DEL42 DEL14 DEL41 DEL32 DEL33 DEL27 DEL14 DEL53 DEL8 DEL8 DEL42 DEL43 DEL42 DEL44 DEL12 DEL54