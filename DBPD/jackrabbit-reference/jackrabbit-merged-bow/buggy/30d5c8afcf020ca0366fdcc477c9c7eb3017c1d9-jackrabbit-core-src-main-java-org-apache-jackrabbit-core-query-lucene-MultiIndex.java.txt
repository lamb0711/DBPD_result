JCR-2219: Improved background text extraction
- fix occasional test failures

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@801135 13f79535-47bb-0310-9956-ffa450edef68

-                flush();
+                internalFlush();
-                flush();
+                internalFlush();
-     * resets the redo log.
+     * resets the redo log. When this method returned the {@link #multiReader}
+     * is released and and set to <code>null</code>.
+        synchronized (updateMonitor) {
+            updateInProgress = true;
+        }
+        try {
+            internalFlush();
+        } finally {
+            synchronized (updateMonitor) {
+                updateInProgress = false;
+                updateMonitor.notifyAll();
+                releaseMultiReader();
+            }
+        }
+    }
+
+    /**
+     * Flushes this <code>MultiIndex</code>. Persists all pending changes and
+     * resets the redo log.
+     *
+     * @throws IOException if the flush fails.
+     */
+    private void internalFlush() throws IOException {
-                    synchronized (updateMonitor) {
-                        updateInProgress = true;
-                    }
-                    try {
-                        flush();
-                    } finally {
-                        synchronized (updateMonitor) {
-                            updateInProgress = false;
-                            updateMonitor.notifyAll();
-                            releaseMultiReader();
-                        }
-                    }
+                    flush();

INS31 INS29 INS39 INS42 INS43 MOV8 INS83 UPD42 INS65 INS65 INS42 INS66 INS66 INS65 INS66 INS42 INS66 INS67 INS21 INS42 INS32 INS42 INS8 UPD42 UPD42 MOV21 MOV21