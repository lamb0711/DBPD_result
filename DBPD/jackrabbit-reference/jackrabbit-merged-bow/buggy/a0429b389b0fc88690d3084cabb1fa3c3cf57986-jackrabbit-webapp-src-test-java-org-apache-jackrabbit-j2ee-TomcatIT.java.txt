JCR-3598: Oak in Jackrabbit deployment packages

Add Oak dependencies to jackrabbit-webapp.
Move backwards compatibility tests to -webapp.
Update the Tomcat dependency and streamline test setup.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1489772 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.File;
-import org.apache.catalina.Engine;
-import org.apache.catalina.Host;
-import org.apache.catalina.connector.Connector;
-import org.apache.catalina.core.StandardContext;
-import org.apache.catalina.startup.Embedded;
+import org.apache.catalina.startup.Tomcat;
+import org.apache.commons.io.FileUtils;
+    static {
+        SLF4JBridgeHandler.install();
+    }
+
-    private Embedded tomcat;
+    private Tomcat tomcat;
-        SLF4JBridgeHandler.install();
+        File war = null;
+        for (File f : new File("target").listFiles()) {
+            if (f.isDirectory() && new File(f, "WEB-INF/web.xml").isFile()) {
+                war = f;
+                break;
+            }
+        }
+        assertNotNull(war);
+
+        File bootstrap = new File("target", "bootstrap.properties");
+        bootstrap.delete();
+        RepositoryAccessServlet.bootstrapOverride = bootstrap.getPath();
+        RepositoryStartupServlet.bootstrapOverride = bootstrap.getPath();
+
+        File baseDir = new File("target", "tomcat");
+        FileUtils.deleteQuietly(baseDir);
+
+        File repoDir = new File("target", "repository");
+        FileUtils.deleteQuietly(repoDir);
-        tomcat = new Embedded();
-        tomcat.setCatalinaBase("tomcat");
-        tomcat.setCatalinaHome("tomcat");
+        tomcat = new Tomcat();
+        tomcat.setSilent(true);
+        tomcat.setBaseDir(baseDir.getPath());
+        tomcat.setHostname(url.getHost());
+        tomcat.setPort(url.getPort());
-        Engine engine = tomcat.createEngine();
-        engine.setName("localengine");
-        engine.setDefaultHost(url.getHost());
+        tomcat.addWebapp("", war.getAbsolutePath());
-        Host host = tomcat.createHost(url.getHost(), "webapps");
-        host.setAutoDeploy(false);
-        engine.addChild(host);
-
-        String webapp = System.getProperty("webapp.directory");
-        StandardContext context =
-            (StandardContext) tomcat.createContext("", webapp);
-        context.setDefaultWebXml(System.getProperty("default.webxml"));
-        host.addChild(context);
-
-        tomcat.addEngine(engine);
-
-        Connector connector =
-            tomcat.createConnector(url.getHost(), url.getPort(), false);
-        tomcat.addConnector(connector);
-
-        tomcat.setAwait(true);
-                        home.setValueAttribute("repository");
+                        home.setValueAttribute("target/repository");

MOV26 UPD40 UPD40 UPD40 INS28 INS83 INS8 UPD43 MOV21 MOV21 UPD42 INS60 INS70 INS21 INS21 INS21 INS21 INS43 INS59 INS44 INS32 INS8 INS32 UPD43 INS7 INS7 UPD43 INS32 UPD43 INS7 INS32 INS32 INS42 INS42 INS33 INS43 INS42 INS14 INS42 INS25 UPD42 MOV42 UPD42 MOV42 UPD42 UPD42 INS14 UPD42 UPD42 INS40 INS32 INS40 INS32 UPD42 UPD42 INS14 INS42 INS42 INS42 UPD42 UPD42 INS14 UPD42 UPD42 UPD42 MOV42 INS42 INS14 UPD42 INS9 INS42 INS42 INS32 MOV42 UPD42 MOV42 MOV32 UPD42 MOV32 INS42 INS45 INS32 UPD42 MOV42 INS43 INS45 INS27 INS8 INS43 INS45 INS45 UPD42 MOV42 UPD42 MOV42 INS42 INS42 INS43 INS45 INS45 INS43 INS45 INS45 INS43 INS42 INS42 INS42 UPD42 MOV42 INS42 INS32 INS32 MOV21 INS10 INS42 INS42 UPD42 MOV42 INS42 UPD42 MOV42 UPD42 MOV42 INS14 UPD42 MOV42 INS7 INS43 INS42 INS45 INS42 INS42 UPD42 MOV42 UPD45 DEL40 DEL26 DEL40 DEL26 DEL42 DEL42 DEL45 DEL32 DEL42 DEL43 DEL14 DEL7 DEL21 DEL42 DEL42 DEL45 DEL32 DEL21 DEL45 DEL32 DEL21 DEL43 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL32 DEL32 DEL42 DEL42 DEL42 DEL42 DEL32 DEL45 DEL32 DEL9 DEL42 DEL32 DEL42 DEL42 DEL45 DEL32 DEL43 DEL42 DEL42 DEL45 DEL42 DEL32 DEL11 DEL42 DEL45 DEL32 DEL42 DEL42 DEL42 DEL32 DEL42 DEL42 DEL43 DEL42 DEL9 DEL32 DEL59 DEL60 DEL42 DEL9