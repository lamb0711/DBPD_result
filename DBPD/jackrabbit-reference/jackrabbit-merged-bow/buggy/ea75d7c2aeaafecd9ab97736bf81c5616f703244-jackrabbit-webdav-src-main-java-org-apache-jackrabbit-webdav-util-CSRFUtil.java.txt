JCR-4009: back out changes for JCR-4002

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1758597 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.webdav.DavMethods;
+import java.util.Arrays;
+     * Request content types for CSRF checking, see JCR-3909
+     */
+    public static final Set<String> CONTENT_TYPES = Collections.unmodifiableSet(new HashSet<String>(
+            Arrays.asList(
+                    new String[] {
+                            "application/x-www-form-urlencoded",
+                            "multipart/form-data",
+                            "text/plain"
+                    }
+            )
+    ));
+
+    /**
-        if (disabled) {
+        int methodCode = DavMethods.getMethodCode(request.getMethod());
+        if (disabled || DavMethods.DAV_POST != methodCode || !CONTENT_TYPES.contains(request.getContentType())) {
+
+            // empty referrer headers are not allowed for POST + relevant content types (see JCR-3909)
-                // empty referrer is always allowed
-                return true;
-            } else {
-                String host = new URL(refHeader).getHost();
-                // test referrer-host equelst server or
-                // if it is contained in the set of explicitly allowed host names
-                return host.equals(request.getServerName()) || allowedReferrerHosts.contains(host);
+                return false;
+
+            String host = new URL(refHeader).getHost();
+            // test referrer-host equals server or
+            // if it is contained in the set of explicitly allowed host names
+            return host.equals(request.getServerName()) || allowedReferrerHosts.contains(host);

INS26 INS26 INS40 INS40 INS23 INS29 INS83 INS83 INS83 INS74 INS59 MOV8 INS65 INS43 INS43 INS42 INS32 INS60 INS66 INS42 INS42 INS42 INS42 INS14 INS39 INS59 INS27 MOV8 INS74 INS32 INS42 INS32 INS27 INS38 MOV60 INS25 INS43 INS43 INS42 INS42 INS3 INS42 INS42 INS32 INS42 INS27 INS32 MOV27 INS8 INS42 INS42 INS5 INS4 INS42 INS42 INS40 INS42 INS42 INS42 INS32 INS41 INS43 INS85 INS45 INS45 INS45 INS42 INS42 INS9 INS42 DEL9 DEL41 DEL8 DEL42 DEL25 DEL8