JCR-1440: NPE Thrown when two Cluster Nodes are hitting the same underlying database

Patch by Ryan Brush

This needs more work (the solution reminds me of the double checked-locking antipattern), but at least it solves the most pressing issue and does not seem to cause any notable risk to other use cases.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@911856 13f79535-47bb-0310-9956-ffa450edef68

+        InternalVersion v = getCachedVersion(id);
+
+        // If the version was not found, our cache may not have been
+        // synchronized with updates from another cluster node.  Reload the history
+        // to be sure we have the latest updates and try again.
+        if (v == null) {
+            try {
+                reload();
+            } catch (RepositoryException e) {
+
+                // We should add the checked exception to this method definition
+                // so we don't need to wrap it.
+                // Avoiding it for now to limit impact of this fix.
+                throw new RuntimeException(e);
+            }
+            v = getCachedVersion(id);
+        }
+
+        return v;
+    }
+
+    /**
+     * Returns the version from cache, or <code>null</code> if it is not
+     * present.
+     */
+    private InternalVersion getCachedVersion(NodeId id) {

INS31 MOV29 INS83 INS43 INS42 INS44 INS8 INS29 UPD83 UPD42 INS42 INS43 INS42 INS60 INS25 INS41 INS65 INS42 INS43 INS59 INS27 INS8 INS42 INS66 INS66 INS42 INS42 INS32 INS42 INS33 INS54 INS21 INS42 INS42 INS8 INS12 INS7 INS21 INS44 INS8 INS42 INS32 INS32 INS43 INS42 INS53 INS42 INS42 INS42 INS42 INS14 INS43 INS42 INS42