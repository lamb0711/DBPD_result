fixing concurrency issue that could cause incorrect InvalidItemStateExceptions being thrown under heavy load

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@265703 13f79535-47bb-0310-9956-ffa450edef68

+        overlayedState = null;
-            throw new IllegalStateException("Item state already connected: " + this);
+            if (this.overlayedState != overlayedState) {
+                throw new IllegalStateException("Item state already connected to another underlying state: " + this);
+            }
+     * Reconnect this state to the overlayed state that it has been
+     * disconnected from earlier.
+     */
+    protected void reconnect() {
+        if (this.overlayedState == null) {
+            throw new IllegalStateException("Item state cannot be reconnected because there's no underlying state to reconnect to: " + this);
+        }
+        this.overlayedState.addListener(this);
+    }
+
+    /**
+            // de-register listener on overlayed state...
-            overlayedState = null;
+            // ...but still keep reference to overlayed state to allow
+            // reconnecting at a later stage and to make sure
+            // it is not accidentally collected by the gc
+            //overlayedState = null;

INS31 INS29 INS83 INS39 INS42 INS8 MOV21 INS25 INS65 INS25 INS21 MOV27 INS8 INS66 INS66 INS27 INS8 INS32 MOV25 INS22 INS33 INS53 INS22 INS42 INS52 INS27 INS52 INS42 INS14 INS52 INS42 INS22 INS42 INS43 INS27 INS52 INS42 INS42 INS45 INS52 UPD45