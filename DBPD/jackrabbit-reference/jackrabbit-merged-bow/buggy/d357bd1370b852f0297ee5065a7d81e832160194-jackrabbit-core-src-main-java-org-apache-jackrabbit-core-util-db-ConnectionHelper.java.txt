JCR-2767: Database connection leak with DBCP, MySQL, and Observers

Patch by Christian Trimble

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1004576 13f79535-47bb-0310-9956-ffa450edef68

-    private boolean inBatchMode = false;
-
-    private Connection batchConnection = null;
+    private ThreadLocal<Connection> batchConnectionTl = new ThreadLocal<Connection>();
+     * Returns true if we are currently in a batch mode, false otherwise.
+     * @return true if the current thread is running in batch mode, false otherwise.
+     */
+    protected boolean inBatchMode()
+    {
+      return batchConnectionTl.get() != null;
+    }
+
+    /**
-        if (inBatchMode) {
+        if (inBatchMode()) {
+        Connection batchConnection = null;
-            inBatchMode = true;
+            batchConnectionTl.set(batchConnection);
-            batchConnection = null;
+            batchConnectionTl.remove();
-        if (!inBatchMode) {
+        if (!inBatchMode()) {
-                batchConnection.commit();
+                batchConnectionTl.get().commit();
-                batchConnection.rollback();
+                batchConnectionTl.get().rollback();
-            DbUtility.close(batchConnection, null, null);
-            batchConnection = null;
-            inBatchMode = false;
+            DbUtility.close(batchConnectionTl.get(), null, null);
+            batchConnectionTl.set(null);
-            if (inBatchMode) {
+            if (inBatchMode()) {
-        if (inBatchMode) {
-            return batchConnection;
+        if (inBatchMode()) {
+            return batchConnectionTl.get();
-        if (inBatchMode) {
+        if (inBatchMode()) {
-            if (inBatchMode) {
+            if (inBatchMode()) {

INS31 INS74 INS29 INS83 INS39 INS42 INS8 INS43 INS43 UPD42 INS14 INS65 INS65 INS41 INS60 INS42 INS42 INS74 INS66 INS66 INS27 INS32 MOV43 MOV59 INS32 INS32 INS43 INS43 INS32 INS33 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS32 INS42 INS32 INS32 INS32 INS42 INS42 INS42 INS42 INS32 INS32 INS42 INS42 INS33 INS42 INS42 INS42 INS42 INS42 UPD42 MOV42 INS42 INS32 INS32 UPD42 MOV42 INS42 UPD42 MOV42 INS42 DEL39 DEL9 DEL83 DEL23 DEL42 DEL42 DEL9 DEL7 DEL42 DEL33 DEL7 DEL42 DEL42 DEL33 DEL7 DEL42 DEL9 DEL7 DEL21 DEL42 DEL42 DEL42 DEL42 DEL42