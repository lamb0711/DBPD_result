JCR-351: Better handling of null Credentials when JAAS is not configured.

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@386415 13f79535-47bb-0310-9956-ffa450edef68

+     * Name of the default user id option in the LoginModule configuration
+     */
+    private static final String OPT_DEFAULT = "defaultUserId";
+
+    /**
+     * The default user id. Only used when not <code>null</code>.
+     */
+    private String defaultUserId = null;
+
+    /**
+    /**
+     * Returns the anonymous user id.
+     *
+     * @return anonymous user id
+     */
+    public String getAnonymousId() {
+        return anonymousUserId;
+    }
+
+    /**
+     * Sets the default user id to be used when no login credentials
+     * are presented.
+     * 
+     * @param defaultUserId default user id
+     */
+    public void setAnonymousId(String anonymousId) {
+        this.anonymousUserId = anonymousId;
+    }
+
+    /**
+     * Returns the default user id.
+     *
+     * @return default user id
+     */
+    public String getDefaultUserId() {
+        return defaultUserId;
+    }
+
+    /**
+     * Sets the default user id to be used when no login credentials
+     * are presented.
+     * 
+     * @param defaultUserId default user id
+     */
+    public void setDefaultUserId(String defaultUserId) {
+        this.defaultUserId = defaultUserId;
+    }
+
+        if (options.containsKey(OPT_DEFAULT)) {
+            defaultUserId = (String) options.get(OPT_DEFAULT);
+        }
-        Callback[] callbacks = new Callback[]{
-            new CredentialsCallback()
-        };
-
-            callbackHandler.handle(callbacks);
-            // credentials
-            CredentialsCallback ccb = (CredentialsCallback) callbacks[0];
+            // Get credentials using a JAAS callback
+            CredentialsCallback ccb = new CredentialsCallback();
+            callbackHandler.handle(new Callback[] { ccb });
+            // Use the credentials to set up principals
+            } else if (defaultUserId != null) {
+                principals.add(new UserPrincipal(defaultUserId));
+                authenticated = true;
+            } else {
+                principals.add(new AnonymousPrincipal());
+                authenticated = true;

INS23 INS23 INS31 INS31 INS31 INS31 INS29 INS83 INS83 INS83 INS43 INS59 INS29 INS83 INS43 INS59 INS29 INS83 INS43 INS42 INS8 INS29 INS83 INS39 INS42 INS44 INS8 INS29 INS83 INS43 INS42 INS8 INS29 INS83 INS39 INS42 INS44 INS8 INS65 INS42 INS42 INS45 INS65 INS42 INS42 INS33 INS65 INS65 INS42 INS41 INS65 INS65 INS43 INS42 INS21 INS65 INS65 INS42 INS41 INS65 INS65 INS43 INS42 INS21 INS25 INS66 INS66 INS66 INS66 INS42 INS66 INS66 INS42 INS66 INS42 INS7 INS66 INS66 INS42 INS66 INS66 INS42 INS66 INS42 INS7 INS32 INS8 INS22 INS42 INS22 INS42 INS42 INS42 INS42 INS21 INS60 INS52 INS42 INS52 INS42 INS7 MOV43 INS59 INS25 INS42 INS11 INS42 MOV14 MOV3 INS27 INS8 INS8 INS43 INS32 INS42 INS33 INS21 INS21 INS21 INS21 INS42 INS42 INS42 INS42 INS42 INS32 INS7 INS32 INS7 INS42 INS42 INS14 INS42 INS9 INS42 INS42 INS14 INS42 INS9 INS43 INS42 INS43 INS42 INS42 DEL42 DEL43 DEL85 DEL5 DEL42 DEL59 DEL60 DEL42 DEL42 DEL43 DEL42 DEL42 DEL34 DEL2 DEL11 DEL59 DEL60