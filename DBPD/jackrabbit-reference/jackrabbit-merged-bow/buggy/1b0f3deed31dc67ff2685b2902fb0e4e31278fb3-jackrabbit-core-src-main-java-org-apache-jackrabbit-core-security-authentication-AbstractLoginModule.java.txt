JCR-2087 Upgrade to Java 5 as the base platform
minor improvement



git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@786147 13f79535-47bb-0310-9956-ffa450edef68

-                           Map sharedState, Map options) {
+                           Map<String,?> sharedState, Map<String,?> options) {
-            // retrieve the principal-provider configured for this module.
-            // if not configured -> retrieve the provider from the callback.
+            // check if the class name of a PrincipalProvider implementation
+            // is present with the module configuration.
-                principalProviderClassName = (String) options.get(LoginModuleConfig.PARAM_PRINCIPAL_PROVIDER_CLASS);
-                principalProvider = registry.getProvider(principalProviderClassName);
-            } else if (principalProviderClassName != null) {
+                Object pcOption = options.get(LoginModuleConfig.PARAM_PRINCIPAL_PROVIDER_CLASS);
+                if (pcOption != null) {
+                    principalProviderClassName = pcOption.toString();
+                }
+            }
+            if (principalProviderClassName != null) {
-                    sharedState.put(KEY_CREDENTIALS, credentials);
+                    if (credentials != null) {
+                        sharedState.put(KEY_CREDENTIALS, credentials);
+                    }
-        // ask subject if still no credentials
+        // if still no credentials -> try to retrieve them from the subject.
+        if (null == credentials) {
+            // try if subject contains GuestCredentials
+            Set<GuestCredentials> preAuthCreds = subject.getPublicCredentials(GuestCredentials.class);
+            if (!preAuthCreds.isEmpty()) {
+                credentials = preAuthCreds.iterator().next();
+            }
+        }

INS74 INS74 INS25 MOV43 INS43 INS76 MOV43 MOV43 INS76 INS27 INS8 INS42 MOV25 INS33 INS42 INS60 INS25 INS74 INS59 INS38 INS8 INS60 INS25 INS43 INS43 INS42 INS32 INS32 INS21 INS43 INS59 INS27 INS8 INS42 INS42 INS42 INS42 INS57 INS42 INS42 INS7 INS42 INS42 MOV32 INS42 INS33 MOV21 INS25 INS43 INS42 INS32 INS27 INS8 INS42 INS32 INS42 UPD42 INS42 INS33 MOV21 INS42 INS42 UPD42 UPD42 DEL42 DEL42 DEL11 DEL7 DEL21