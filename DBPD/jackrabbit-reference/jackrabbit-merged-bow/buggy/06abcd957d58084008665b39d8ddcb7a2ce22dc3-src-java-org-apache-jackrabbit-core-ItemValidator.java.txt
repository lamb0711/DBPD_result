JCR-255 Workspace operations (copy/clone) do not handle references correctly

consolidated code that maintains/enforces referential integrity (RI):
SharedItemStateManager.store(ChangeLog) is now the only place where
RI is maintained and enforced

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@326916 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.HashSet;
+import java.util.Set;
+     *
+     *
-     * @param state
+     * @param nodeState
-     * @throws javax.jcr.RepositoryException
+     * @throws RepositoryException
-    public EffectiveNodeType getEffectiveNodeType(NodeState state)
+    public EffectiveNodeType getEffectiveNodeType(NodeState nodeState)
-        // build effective node type of mixins & primary type:
-        // existing mixin's
-        HashSet set = new HashSet(state.getMixinTypeNames());
+        // mixin types
+        Set set = nodeState.getMixinTypeNames();
+        QName[] types = new QName[set.size() + 1];
+        set.toArray(types);
-        set.add(state.getNodeTypeName());
+        types[types.length - 1] = nodeState.getNodeTypeName();
-            QName[] ntNames = (QName[]) set.toArray(new QName[set.size()]);
-            return ntReg.getEffectiveNodeType(ntNames);
+            return ntReg.getEffectiveNodeType(types);
-            String msg =
-                    "internal error: failed to build effective node type for node "
-                    + state.getUUID();
+            String msg = "internal error: failed to build effective node type for node "
+                    + safeGetJCRPath(nodeState.getId());

UPD40 UPD42 MOV60 INS21 INS21 UPD42 INS42 UPD43 MOV5 INS32 INS7 UPD42 INS32 UPD42 MOV3 MOV42 UPD42 MOV42 INS42 INS2 INS32 UPD42 MOV42 MOV42 INS27 INS42 INS27 UPD42 MOV42 MOV42 MOV32 INS34 INS40 INS34 UPD42 INS32 INS42 INS32 UPD42 MOV42 UPD42 MOV42 DEL40 DEL42 DEL43 DEL32 DEL14 DEL42 DEL43 DEL85 DEL5 DEL42 DEL42 DEL32 DEL11 DEL32 DEL32 DEL21 DEL32