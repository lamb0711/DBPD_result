JCR-1565: JSR 283 lifecycle management

Added a simple NodeImpl.assignLifecyclePolicy method for assigning a lifecycle policy and an initial lifecycle state to a node.

Added simple TCK tests for lifecycle management.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@795136 13f79535-47bb-0310-9956-ffa450edef68

+import static org.apache.jackrabbit.spi.commons.name.NameConstants.MIX_LIFECYCLE;
+import static org.apache.jackrabbit.spi.commons.name.NameConstants.MIX_REFERENCEABLE;
-     * @throws RepositoryException if another error occurs
+     * @throws RepositoryException if a repository error occurs
-     * @throws RepositoryException if another error occurs
+     * @throws RepositoryException if a repository error occurs
+    /**
+     * Assigns the given lifecycle policy to this node and sets the
+     * current state to the one given.
+     * <p>
+     * Note that currently no special checks are made against the given
+     * arguments, and that you will need to explicitly persist these changes
+     * by calling save().
+     * <p>
+     * Note that future versions of Apache Jackrabbit may well use different
+     * lifecycle policy implementations.
+     *
+     * @param policy lifecycle policy node
+     * @param state current lifecycle state
+     * @throws RepositoryException if a repository error occurs
+     */
+    public void assignLifecyclePolicy(Node policy, String state)
+            throws RepositoryException {
+        if (!(policy instanceof NodeImpl)
+                || !((NodeImpl) policy).isNodeType(MIX_REFERENCEABLE)) {
+            throw new RepositoryException(
+                    policy + " is not referenceable, so it can not be"
+                    + " used as a lifecycle policy");
+        }
+
+        addMixin(MIX_LIFECYCLE);
+        internalSetProperty(
+                JCR_LIFECYCLE_POLICY,
+                InternalValue.create(((NodeImpl) policy).getNodeId()));
+        internalSetProperty(
+                JCR_CURRENT_LIFECYCLE_STATE,
+                InternalValue.create(state));
+    }
+

INS26 INS26 INS40 INS40 INS31 INS29 INS83 INS39 INS42 INS44 INS44 INS43 INS8 INS65 INS65 INS65 INS65 INS43 INS42 INS43 INS42 INS42 INS25 INS21 INS21 INS21 UPD66 UPD66 INS66 INS66 INS66 INS66 INS66 INS66 INS66 INS66 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS42 INS42 INS27 INS8 INS32 INS32 INS32 INS38 INS38 INS53 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS32 INS36 INS32 INS14 INS42 INS42 INS32 INS42 INS42 INS42 INS62 INS36 INS42 INS42 INS43 INS27 INS36 INS42 INS42 INS43 INS11 INS42 INS42 INS45 INS45 INS11 INS42 INS43 INS42 INS43 INS42 INS42 INS42