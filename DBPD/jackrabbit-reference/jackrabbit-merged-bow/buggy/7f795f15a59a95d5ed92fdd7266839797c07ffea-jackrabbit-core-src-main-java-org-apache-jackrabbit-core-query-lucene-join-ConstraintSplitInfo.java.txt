JCR-2933: SQL2 Left Outer Join

Patch by Alex Parvulescu

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1092683 13f79535-47bb-0310-9956-ffa450edef68

-import javax.jcr.query.qom.Or;
+import javax.jcr.query.qom.Join;
-    private final List<Constraint> leftConstraints = new ArrayList<Constraint>();
+    private final Join source;
-    private final List<Constraint> rightConstraints = new ArrayList<Constraint>();
+    private final List<Constraint> leftConstraints;
+
+    private final List<Constraint> rightConstraints;
-    private final List<ConstraintSplitInfo> innerConstraints = new ArrayList<ConstraintSplitInfo>();
+    private ConstraintSplitInfo leftInnerConstraints = null;
-    public ConstraintSplitInfo(QueryObjectModelFactory factory) {
-        this.factory = factory;
-        this.isMultiple = false;
+    private ConstraintSplitInfo rightInnerConstraints = null;
+
+    public ConstraintSplitInfo(QueryObjectModelFactory factory, Join source) {
+        this(factory, source, new ArrayList<Constraint>(),
+                new ArrayList<Constraint>());
-    private ConstraintSplitInfo(QueryObjectModelFactory factory,
+    private ConstraintSplitInfo(QueryObjectModelFactory factory, Join source,
+        this.source = source;
-        this.leftConstraints.addAll(leftConstraints);
-        this.rightConstraints.addAll(rightConstraints);
+        this.leftConstraints = leftConstraints;
+        this.rightConstraints = rightConstraints;
-            for (ConstraintSplitInfo csi : innerConstraints) {
-                csi.addLeftConstraint(c);
-            }
+            leftInnerConstraints.addLeftConstraint(c);
+            leftInnerConstraints.addRightConstraint(c);
-            for (ConstraintSplitInfo csi : innerConstraints) {
-                csi.addRightConstraint(c);
-            }
+            rightInnerConstraints.addLeftConstraint(c);
+            rightInnerConstraints.addRightConstraint(c);
-    public void split(Or or) {
+    public void splitOr() {
+
-            for (ConstraintSplitInfo csi : innerConstraints) {
-                csi.split(or);
-            }
+            // this should never happen
+        ConstraintSplitInfo csi1 = new ConstraintSplitInfo(factory, source,
+                new ArrayList<Constraint>(leftConstraints),
+                new ArrayList<Constraint>(rightConstraints));
+        this.leftInnerConstraints = csi1;
-        ConstraintSplitInfo csi1 = new ConstraintSplitInfo(factory,
-                leftConstraints, rightConstraints);
-        csi1.addLeftConstraint(or.getConstraint1());
-        this.innerConstraints.add(csi1);
+        ConstraintSplitInfo csi2 = new ConstraintSplitInfo(factory, source,
+                new ArrayList<Constraint>(leftConstraints),
+                new ArrayList<Constraint>(rightConstraints));
+        this.rightInnerConstraints = csi2;
-        ConstraintSplitInfo csi2 = new ConstraintSplitInfo(factory,
-                leftConstraints, rightConstraints);
-        csi2.addLeftConstraint(or.getConstraint2());
-        this.innerConstraints.add(csi2);
-
-        // would null be better?
-    public List<ConstraintSplitInfo> getInnerConstraints() {
-        return innerConstraints;
+    public ConstraintSplitInfo getLeftInnerConstraints() {
+        return leftInnerConstraints;
+    }
+
+    public ConstraintSplitInfo getRightInnerConstraints() {
+        return rightInnerConstraints;
+    }
+
+    public Join getSource() {
+        return source;
+
+    @Override
+    public String toString() {
+        if (isMultiple) {
+            return "ConstraintSplitInfo [multiple=" + ", leftInnerConstraints="
+                    + leftInnerConstraints + ", rightInnerConstraints="
+                    + rightInnerConstraints + "]";
+        }
+        return "ConstraintSplitInfo [single" + ", leftConstraints="
+                + leftConstraints + ", rightConstraints=" + rightConstraints
+                + "]";
+    }
+

MOV31 UPD40 INS23 INS23 INS23 INS31 INS31 INS31 INS31 INS43 MOV74 MOV83 MOV83 MOV74 INS59 INS83 MOV43 MOV59 INS83 MOV43 INS59 INS44 INS8 INS44 MOV83 MOV39 UPD42 MOV42 INS8 INS83 MOV43 INS42 INS8 INS83 MOV43 INS42 INS8 INS83 INS43 INS42 INS8 INS78 INS43 UPD42 INS8 INS42 UPD42 UPD42 INS42 UPD42 INS33 INS42 INS33 INS43 INS42 INS17 INS43 INS42 INS21 MOV25 MOV21 MOV60 MOV21 MOV60 INS21 MOV21 MOV21 INS41 INS41 INS42 INS41 INS42 UPD42 MOV42 INS25 INS41 INS42 INS42 INS42 MOV14 MOV14 INS42 INS7 INS7 INS7 MOV43 INS7 MOV43 INS7 INS42 INS42 INS42 INS42 INS8 INS27 INS22 INS42 MOV22 INS42 MOV22 INS42 INS21 MOV21 INS21 MOV21 INS22 INS42 INS22 INS42 MOV41 INS27 INS42 INS45 INS42 INS45 INS52 INS42 INS32 INS32 MOV43 INS42 MOV14 INS14 MOV52 UPD42 MOV42 MOV43 INS42 INS14 INS14 INS52 INS42 INS27 INS45 INS45 INS42 INS42 INS42 UPD42 UPD42 INS42 INS42 INS42 UPD42 UPD74 INS42 INS74 MOV42 INS74 MOV42 INS74 MOV42 INS27 INS42 INS45 INS42 INS45 INS43 INS43 INS43 INS43 INS43 INS43 INS43 INS45 INS45 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL42 DEL43 DEL74 DEL23 DEL52 DEL42 DEL22 DEL42 DEL7 DEL21 DEL52 DEL42 DEL22 DEL9 DEL7 DEL21 DEL8 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL43 DEL42 DEL44 DEL42 DEL8 DEL70 DEL42 DEL43 DEL42 DEL44 DEL42 DEL8 DEL70 DEL42 DEL44 DEL42 DEL42 DEL42 DEL42 DEL32 DEL21 DEL8 DEL70 DEL42 DEL22 DEL42 DEL42 DEL32 DEL42 DEL43 DEL42 DEL44 DEL42 DEL42 DEL42 DEL42 DEL32 DEL32 DEL21 DEL42 DEL42 DEL42 DEL42 DEL32 DEL32 DEL21 DEL52 DEL42 DEL22 DEL42 DEL42 DEL32 DEL21 DEL8 DEL31 DEL43 DEL74 DEL42 DEL8