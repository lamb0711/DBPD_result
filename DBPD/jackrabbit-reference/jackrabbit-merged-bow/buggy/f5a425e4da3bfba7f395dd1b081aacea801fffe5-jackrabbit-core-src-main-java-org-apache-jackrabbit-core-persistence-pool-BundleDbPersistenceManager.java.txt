JCR-2272: Errors during concurrent session import of nodes with same UUIDs

Patch by Julian Reschke

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/branches/JCR-2272@1173166 13f79535-47bb-0310-9956-ffa450edef68

+import java.sql.SQLIntegrityConstraintViolationException;
+
+                // if we got here due to a constraint violation and we are running in
+                // test mode, we really want to stop
+                assert !(e.getCause() instanceof SQLIntegrityConstraintViolationException);
-            String msg = "failed to write bundle: " + bundle.getId();
+            String msg;
+
+            if (e instanceof SQLIntegrityConstraintViolationException) {
+                // we should never get an integrity constraint violation here
+                // other PMs may not be able to detect this and end up with
+                // corrupted data
+                msg = "FATAL error while writing the bundle: " + bundle.getId();
+            } else {
+                msg = "failed to write bundle: " + bundle.getId();
+            }
+
-    }
+   }

INS26 INS40 INS25 INS62 INS8 INS8 INS6 INS42 INS43 INS21 INS21 INS38 INS42 INS7 INS7 INS36 INS42 INS27 INS42 MOV27 INS62 INS45 INS32 INS32 INS43 INS42 INS42 INS42 INS42 INS42