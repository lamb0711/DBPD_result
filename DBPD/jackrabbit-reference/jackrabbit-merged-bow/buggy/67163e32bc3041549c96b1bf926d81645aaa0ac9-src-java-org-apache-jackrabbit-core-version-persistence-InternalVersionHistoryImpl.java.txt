- fixing VersionHistory.removeVersion()

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@157348 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.PropertyImpl;
+import javax.jcr.PropertyIterator;
+import java.util.List;
-        try {
-            InternalVersionImpl v = (InternalVersionImpl) getVersion(versionName);
-            if (v.equals(rootVersion)) {
-                String msg = "Removal of " + versionName + " not allowed.";
-                log.debug(msg);
-                throw new VersionException(msg);
-            }
+        InternalVersionImpl v = (InternalVersionImpl) getVersion(versionName);
+        if (v.equals(rootVersion)) {
+            String msg = "Removal of " + versionName + " not allowed.";
+            log.debug(msg);
+            throw new VersionException(msg);
+        }
+        // check if any references (from outside the version storage) exist on this version
+        List refs = getVersionManager().getItemReferences(v);
+        if (!refs.isEmpty()) {
+            throw new VersionException("Unable to remove version. At least once referenced.");
+        }
+        try {

INS26 INS26 INS26 INS40 INS40 INS40 MOV8 INS60 INS25 INS54 INS43 INS59 INS38 INS8 INS8 MOV12 MOV12 INS42 INS42 INS32 INS32 INS53 MOV60 MOV60 MOV54 INS32 INS42 INS42 INS42 INS42 INS14 INS42 INS43 INS45 INS42 DEL54 DEL8