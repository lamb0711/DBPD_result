JCR-2503: inconsistent session and persistent state after ReferentialIntegrityException

Patch by Stephan Huttenhuis

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@944258 13f79535-47bb-0310-9956-ffa450edef68

-                if (!item.isTransient()) {
-                    // re-apply transient changes (i.e. undo effect of item.makePersistent())
-                    if (item.isNode()) {
-                        NodeImpl node = (NodeImpl) item;
-                        node.restoreTransient((NodeState) itemState);
-                    } else {
-                        PropertyImpl prop = (PropertyImpl) item;
-                        prop.restoreTransient((PropertyState) itemState);
-                    }
+                // re-apply transient changes
+                // for persistent nodes undo effect of item.makePersistent()
+                if (item.isNode()) {
+                    NodeImpl node = (NodeImpl) item;
+                    node.restoreTransient((NodeState) itemState);
+                } else {
+                    PropertyImpl prop = (PropertyImpl) item;
+                    prop.restoreTransient((PropertyState) itemState);

MOV8 INS70 MOV44 INS42 MOV8 MOV60 MOV60 INS54 MOV8 MOV12 MOV25 UPD42 MOV42 UPD42 MOV42 DEL32 DEL38 DEL25 DEL54 DEL42 DEL70 DEL8