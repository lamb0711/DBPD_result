JCR-2753: Deadlock in DefaultISMLocking

Restore the earlier revisions 995411 and 995412, and added the proposed patch that makes the lock re-entrant for related readers even after a write lock has been downgraded.

Documented this reentrancy requirement in ISMLocking javadocs and modified the DefaultISMLockingDeadlockTest case to check for this case.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1000947 13f79535-47bb-0310-9956-ffa450edef68

+ * <li>While a write lock is held for a change log <code>C</code>, the holder
+ * of the write lock (and any related threads) needs to be able to acquire
+ * a read lock even if other writers are waiting for the lock. This behaviour
+ * must continue also when the write lock has been downgraded.</li>
-         * @throws InterruptedException if the current thread is interrupted
-         *                              while downgrading the write lock.
-        ReadLock downgrade() throws InterruptedException;
+        ReadLock downgrade();

INS66 INS66 INS66 INS66 DEL42 DEL66 DEL66 DEL65 DEL42 DEL43