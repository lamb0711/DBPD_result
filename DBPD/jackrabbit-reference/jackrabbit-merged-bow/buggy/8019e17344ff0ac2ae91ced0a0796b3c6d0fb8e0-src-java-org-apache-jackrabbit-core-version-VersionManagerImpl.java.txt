reviewed references stuff in respect to VirtualItemStateProviders and added some clarifying comments

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@328088 13f79535-47bb-0310-9956-ffa450edef68

-     * todo FIXME quick&dirty workaround for failing referential integrity-related junit tests
+     * Spezialized SharedItemStateManager that filters out NodeReferences to
+     * non-versioning states.
-        protected void updateReferences(ChangeLog changes)
-                throws ItemStateException {
-            //super.updateReferences(changes);
-        }
-
-            //super.checkReferentialIntegrity(changes);
+            // only store VV-type references and NV-type references
+
+            // check whether targets of modified node references exist
+            for (Iterator iter = changes.modifiedRefs(); iter.hasNext();) {
+                NodeReferences refs = (NodeReferences) iter.next();
+                NodeId id = new NodeId(refs.getUUID());
+                // no need to check existence of target if there are no references
+                if (refs.hasReferences()) {
+                    if (!changes.has(id) && !hasItemState(id)) {
+                        // remove references
+                        iter.remove();
+                    }
+                }
+            }

INS31 MOV83 MOV39 UPD42 MOV42 MOV44 MOV43 MOV43 INS8 UPD66 INS66 INS24 INS58 INS32 INS8 INS43 INS59 INS42 INS42 INS60 INS60 INS25 UPD42 MOV42 INS42 INS32 INS43 INS59 INS43 INS59 INS32 INS8 INS42 INS42 UPD42 MOV42 INS42 INS11 INS42 INS42 INS14 INS42 INS42 INS25 INS43 INS32 INS43 INS32 INS27 INS8 INS42 INS42 INS42 INS42 INS42 INS42 INS38 INS38 INS21 INS32 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL43 DEL42 DEL44 DEL43 DEL8 DEL31 DEL83 DEL39 DEL42 DEL8 DEL31