- fixing latest locking issues
- fixing version items refresh

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@157083 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.NodeId;
+import org.apache.jackrabbit.core.NodeImpl;
+import org.apache.log4j.Logger;
+import javax.jcr.RepositoryException;
+import javax.jcr.lock.LockException;
+     * Logger
+     */
+    private static final Logger log = Logger.getLogger(LockInfo.class);
+
+    /**
+     * Lock manager
+     */
+    private final LockManagerImpl lockMgr;
+
+    /**
+     * @param lockMgr lock manager
-    public LockInfo(LockToken lockToken, boolean sessionScoped,
-                    boolean deep, String lockOwner) {
+    public LockInfo(LockManagerImpl lockMgr, LockToken lockToken,
+                    boolean sessionScoped, boolean deep, String lockOwner) {
+        this.lockMgr = lockMgr;
-        this.live = true;
-        if (live && session.equals(lockHolder)) {
+        if (session.equals(lockHolder)) {
+    /**
+     * Refresh a lock. Will try to re-insert this lock info into the lock
+     * manager's path map, provided the node is not already locked.
+     * @param node node to lock again
+     * @throws LockException if the node is already locked
+     * @throws RepositoryException if some other error occurs
+     * @see javax.jcr.Node#refresh
+     */
+    public void refresh(NodeImpl node) throws LockException, RepositoryException {
+        lockMgr.lock(node, this);
+    }
+
+     *
+     * When the owning session is logging out, we should unlock the node on
+     * behalf of the user currently holding it.
-    public void loggedOut(SessionImpl session) {
-        live = false;
+    public void loggingOut(SessionImpl session) {
+        if (live) {
+            lockMgr.unlock(this);
+        }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void loggedOut(SessionImpl session) {}

INS26 INS26 INS26 INS26 INS26 INS40 INS40 INS40 INS40 INS40 INS23 INS23 INS31 INS31 INS29 INS83 INS83 INS83 INS43 INS59 INS29 INS83 INS83 INS43 INS59 INS44 MOV21 INS29 INS83 INS39 INS42 INS44 INS43 INS43 INS8 INS29 INS83 INS39 INS42 INS44 INS8 INS65 INS42 INS42 INS32 INS65 INS42 INS42 INS65 INS43 INS42 INS65 INS65 INS65 INS65 INS65 INS43 INS42 INS42 INS42 INS21 INS65 INS43 INS42 INS25 INS66 INS42 INS42 INS57 INS66 INS42 INS66 INS42 MOV32 INS66 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS67 INS42 INS32 INS65 INS66 INS66 INS42 INS42 INS8 INS43 INS42 INS40 INS42 INS42 INS42 INS42 INS52 INS21 INS42 UPD42 INS32 INS42 INS42 INS52 DEL9 DEL42 DEL27 DEL42 DEL9 DEL7 DEL21