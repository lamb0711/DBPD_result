JCR-982: Each TransactionContext creates new thread

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@550752 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.util.Timer;
- * starts a thread that rolls back the transaction if some time passes without
+ * schedules a task that rolls back the transaction if some time passes without
-public class TransactionContext implements Runnable {
+public class TransactionContext extends Timer.Task {
+     * Create a global timer for all transaction contexts.
+     */
+    private static final Timer TIMER = new Timer(true);
+
+    /**
-        // start rollback thread in case the commit is never issued
-        new Thread(this, "RollbackThread").start();
+        // start rollback task in case the commit is never issued
+        TIMER.schedule(this, timeout * 1000, Integer.MAX_VALUE);
+        // cancel the rollback task
+        cancel();
+
+        // cancel the rollback task
+        cancel();
+
-     * {@inheritDoc}
-     * <p/>
-     * Waits for the amount of time specified as transaction timeout. After
-     * this time has elapsed, rolls back the transaction if still prepared
-     * and marks the transaction rolled back.
+     * Rolls back the transaction if still prepared and marks the transaction
+     * rolled back.
-        try {
-            Thread.sleep(timeout * 1000);
-        } catch (InterruptedException e) {
-            /* ignore */
-        }
-
+            // cancel the rollback task
+            cancel();

INS26 INS40 INS43 INS23 INS40 INS29 INS83 INS83 INS83 INS43 INS59 UPD66 INS65 UPD42 MOV42 INS42 INS14 INS21 INS21 INS66 INS43 INS9 INS32 INS32 UPD66 UPD66 INS42 INS42 INS42 INS52 MOV27 INS40 INS42 INS42 INS21 INS32 INS42 DEL43 DEL42 DEL43 DEL52 DEL45 DEL14 DEL42 DEL65 DEL66 DEL66 DEL42 DEL42 DEL32 DEL21 DEL8 DEL42 DEL43 DEL42 DEL44 DEL8 DEL12 DEL54