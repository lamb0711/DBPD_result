JCR-129: applied patch supplied by serge as-is
(http://issues.apache.org/jira/browse/JCR-129)misc. NodeState optimizations:
- removed PropertyEntry class; the relevant
  NodeState methods (e.g. getPropertyEntries())
  now return QName's instead of PropertyEntry
  to avoid unneccessary object creation
- reimplemented internal ChildNodeEntries class
  for improved speed and efficiency


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@201999 13f79535-47bb-0310-9956-ffa450edef68

-                    if (thisState.hasPropertyEntry(pe.getName())) {
+                    if (thisState.hasPropertyName(pe.getName())) {
-        if (thisState.hasPropertyEntry(name)) {
+        if (thisState.hasPropertyName(name)) {
-        thisState.addPropertyEntry(name);
+        thisState.addPropertyName(name);
-        if (!thisState.removePropertyEntry(propName)) {
+        if (!thisState.removePropertyName(propName)) {
-        // remove child nodes
-        // use temp array to avoid ConcurrentModificationException
-        ArrayList tmp = new ArrayList(thisState.getChildNodeEntries());
-        // remove from tail to avoid problems with same-name siblings
-        for (int i = tmp.size() - 1; i >= 0; i--) {
-            NodeState.ChildNodeEntry entry =
-                    (NodeState.ChildNodeEntry) tmp.get(i);
-            // recursively remove child node
-            NodeId childId = new NodeId(entry.getUUID());
-            NodeImpl childNode = (NodeImpl) itemMgr.getItem(childId);
-            childNode.onRemove();
-
-            // remove the child node entry
-            thisState.removeChildNodeEntry(entry.getName(), entry.getIndex());
+        if (thisState.hasChildNodeEntries()) {
+            // remove child nodes
+            // use temp array to avoid ConcurrentModificationException
+            ArrayList tmp = new ArrayList(thisState.getChildNodeEntries());
+            // remove from tail to avoid problems with same-name siblings
+            for (int i = tmp.size() - 1; i >= 0; i--) {
+                NodeState.ChildNodeEntry entry =
+                        (NodeState.ChildNodeEntry) tmp.get(i);
+                // recursively remove child node
+                NodeId childId = new NodeId(entry.getUUID());
+                NodeImpl childNode = (NodeImpl) itemMgr.getItem(childId);
+                childNode.onRemove();
+                // remove the child node entry
+                thisState.removeChildNodeEntry(entry.getName(), entry.getIndex());
+            }
-        tmp = new ArrayList(thisState.getPropertyEntries());
+        ArrayList tmp = new ArrayList(thisState.getPropertyNames());
-            NodeState.PropertyEntry entry =
-                    (NodeState.PropertyEntry) tmp.get(i);
+            QName propName = (QName) tmp.get(i);
-            thisState.removePropertyEntry(entry.getName());
+            thisState.removePropertyName(propName);
-            PropertyId propId = new PropertyId(thisState.getUUID(), entry.getName());
+            PropertyId propId = new PropertyId(thisState.getUUID(), propName);
-        if (thisState.hasPropertyEntry(nodeName)) {
+        if (thisState.hasPropertyName(nodeName)) {
-        if (thisState.hasPropertyEntry(JCR_MIXINTYPES)) {
+        if (thisState.hasPropertyName(JCR_MIXINTYPES)) {
-        persistentState.setPropertyEntries(transientState.getPropertyEntries());
+        persistentState.setPropertyNames(transientState.getPropertyNames());
-        ArrayList tmp = new ArrayList(thisState.getPropertyEntries());
+        ArrayList tmp = new ArrayList(thisState.getPropertyNames());
-            NodeState.PropertyEntry entry = (NodeState.PropertyEntry) iter.next();
-            PropertyImpl prop = (PropertyImpl) itemMgr.getItem(new PropertyId(thisState.getUUID(), entry.getName()));
+            QName propName = (QName) iter.next();
+            PropertyImpl prop = (PropertyImpl) itemMgr.getItem(new PropertyId(thisState.getUUID(), propName));
-                removeChildProperty(entry.getName());
+                removeChildProperty(propName);
-        if (!thisState.hasPropertyEntry(name)) {
+        if (!thisState.hasPropertyName(name)) {

INS25 INS60 INS32 INS8 MOV43 INS59 MOV43 UPD42 UPD42 INS42 INS42 MOV60 MOV24 INS42 INS14 UPD42 UPD42 UPD42 UPD42 INS43 MOV32 UPD43 UPD42 MOV43 UPD43 MOV43 UPD42 INS42 UPD42 INS42 UPD42 UPD42 UPD42 MOV42 UPD42 INS42 UPD42 UPD43 INS42 UPD43 MOV43 INS42 INS42 UPD42 MOV42 INS42 UPD42 DEL42 DEL14 DEL7 DEL21 DEL40 DEL40 DEL42 DEL32 DEL42 DEL42 DEL32 DEL40 DEL40 DEL42 DEL42 DEL32 DEL42 DEL32