fixed concurrency issue reported by walter raboch:
http://www.mail-archive.com/jackrabbit-dev@incubator.apache.org/msg02127.html

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@233511 13f79535-47bb-0310-9956-ffa450edef68

-    private VirtualItemStateProvider[] virtualProviders = new
-            VirtualItemStateProvider[0];
+    private VirtualItemStateProvider[] virtualProviders =
+            new VirtualItemStateProvider[0];
-     * @throws ItemStateException if an error occurs
+     * @throws StaleItemStateException if at least one of the affected item
+     *                                 states has become stale
+     * @throws ItemStateException if another error occurs
-            throws ItemStateException {
+            throws StaleItemStateException, ItemStateException {
+                    if (state.isStale()) {
+                        String msg = state.getId() + " has been modified externally";
+                        log.debug(msg);
+                        throw new StaleItemStateException(msg);
+                    }
+                    if (state.isStale()) {
+                        String msg = state.getId() + " has been modified externally";
+                        log.debug(msg);
+                        throw new StaleItemStateException(msg);
+                    }
+        ItemState state;
-            return persistMgr.load((NodeId) id);
+            state = persistMgr.load((NodeId) id);
-            return persistMgr.load((PropertyId) id);
+            state = persistMgr.load((PropertyId) id);
+        // init modification counter
+        state.touch();
+        return state;

INS43 INS65 INS42 INS60 INS21 INS41 INS42 INS66 INS66 UPD66 INS43 INS59 INS32 INS42 INS42 INS42 INS21 INS21 INS42 INS42 INS7 INS7 INS42 MOV32 INS42 MOV32 INS25 INS25 INS32 INS8 INS32 INS8 INS42 INS42 INS60 INS21 INS53 INS42 INS42 INS60 INS21 INS53 INS43 INS59 INS32 INS14 INS43 INS59 INS32 INS14 INS42 INS42 INS27 INS42 INS42 INS42 INS43 INS42 INS42 INS42 INS27 INS42 INS42 INS42 INS43 INS42 INS32 INS45 INS42 INS32 INS45 INS42 INS42 INS42 INS42 INS42 DEL41 DEL41