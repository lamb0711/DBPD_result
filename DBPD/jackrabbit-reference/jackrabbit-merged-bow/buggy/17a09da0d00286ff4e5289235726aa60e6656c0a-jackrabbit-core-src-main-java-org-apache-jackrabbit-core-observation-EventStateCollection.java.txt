JCR-2074: JSR 283: New Event Types

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@765328 13f79535-47bb-0310-9956-ffa450edef68

-                // 5) node moved
+                // 5) node moved/reordered
-                                getParent(oldPath),
-                                n.getNodeId(),
+                                getParent(oldPath), n.getNodeId(),
-                                mixins,
-                                session));
+                                mixins, session));
-                                getParent(newPath),
-                                n.getNodeId(),
+                                getParent(newPath), n.getNodeId(),
-                                mixins,
-                                session));
+                                mixins, session));
+
+                        events.add(EventState.nodeMoved(newParentId,
+                                newPath, n.getNodeId(), oldPath,
+                                newParentNodeType.getQName(), mixins,
+                                session, false));
-                                events.add(EventState.childNodeRemoved(parent.getNodeId(),
-                                        parentPath,
-                                        n.getNodeId(),
-                                        oldPath.getNameElement(),
-                                        nodeType.getQName(),
-                                        mixins,
-                                        session));
-                                events.add(EventState.childNodeAdded(parent.getNodeId(),
-                                        parentPath,
-                                        n.getNodeId(),
-                                        newPath.getNameElement(),
-                                        nodeType.getQName(),
-                                        mixins,
-                                        session));
+                                events.add(EventState.childNodeRemoved(
+                                        parent.getNodeId(), parentPath,
+                                        n.getNodeId(), oldPath.getNameElement(),
+                                        nodeType.getQName(), mixins, session));
+
+                                events.add(EventState.childNodeAdded(
+                                        parent.getNodeId(), parentPath,
+                                        n.getNodeId(), newPath.getNameElement(),
+                                        nodeType.getQName(), mixins, session));
+
+                                events.add(EventState.nodeMoved(
+                                        parent.getNodeId(), newPath, n.getNodeId(),
+                                        oldPath, nodeType.getQName(), mixins,
+                                        session, false));
-                        Name name = child.getName();
-                        int index = (child.getIndex() != 1) ? child.getIndex() : 0;
+                        Path.Element addedElem = getPathElement(child);
-                        Path.Element addedElem = PathFactoryImpl.getInstance().createElement(name, index);
-                        int oldIndex = (entry.getIndex() != 1) ? entry.getIndex() : 0;
-                        Path.Element removedElem = PathFactoryImpl.getInstance().createElement(name, oldIndex);
+                        Path.Element removedElem = getPathElement(entry);
-                                parentPath,
-                                child.getId(),
-                                removedElem,
-                                nodeType.getQName(),
-                                mixins,
-                                session));
+                                parentPath, child.getId(), removedElem,
+                                nodeType.getQName(), mixins, session));
-                                parentPath,
-                                child.getId(),
-                                addedElem,
-                                nodeType.getQName(),
-                                mixins,
-                                session));
+                                parentPath, child.getId(), addedElem,
+                                nodeType.getQName(), mixins, session));
+
+                        List cne = n.getChildNodeEntries();
+                        // index of the child node entry before which this
+                        // child node entry was reordered
+                        int idx = cne.indexOf(child) + 1;
+                        Path.Element beforeElem = null;
+                        if (idx < cne.size()) {
+                            beforeElem = getPathElement((ChildNodeEntry) cne.get(idx));
+                        }
+
+                        events.add(EventState.nodeReordered(n.getNodeId(),
+                                parentPath, child.getId(), addedElem,
+                                removedElem, beforeElem, nodeType.getQName(), mixins,
+                                session, false));
-                        getParent(path),
-                        path.getNameElement(),
-                        nodeType.getQName(),
-                        mixins,
-                        session));
+                        getParent(path), path.getNameElement(),
+                        nodeType.getQName(), mixins, session));
+     * Returns the path element for the given child node <code>entry</code>.
+     *
+     * @param entry a child node entry.
+     * @return the path element for the given entry.
+     */
+    private Path.Element getPathElement(ChildNodeEntry entry) {
+        Name name = entry.getName();
+        int index = (entry.getIndex() != 1) ? entry.getIndex() : 0;
+        return PathFactoryImpl.getInstance().createElement(name, index);
+    }
+
+    /**

INS31 INS29 INS83 MOV43 INS42 INS44 INS8 INS65 INS65 INS65 INS43 INS42 INS60 MOV60 INS41 INS66 INS42 INS66 INS66 INS42 MOV43 INS59 MOV32 INS42 INS32 UPD42 INS42 INS42 MOV60 MOV60 MOV60 INS21 INS60 INS60 INS25 INS21 INS32 INS43 INS59 MOV43 INS59 INS43 INS43 INS27 INS8 INS32 INS42 INS42 INS32 INS40 INS42 INS32 INS42 INS32 INS42 UPD42 UPD42 INS27 INS40 UPD42 INS33 INS42 INS32 INS21 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS32 INS42 INS32 INS42 INS42 INS9 INS42 INS42 INS42 INS42 UPD42 UPD42 MOV32 MOV34 INS42 INS42 INS7 INS42 INS42 INS32 INS42 MOV32 INS42 INS42 UPD42 MOV42 INS32 UPD42 MOV42 INS42 INS9 INS42 INS42 INS42 INS42 INS21 UPD42 UPD42 INS42 INS42 INS32 INS42 INS42 UPD42 UPD42 INS42 UPD42 MOV42 INS32 INS42 INS11 INS42 INS42 INS32 INS43 INS32 INS42 INS42 INS32 INS42 INS32 INS42 INS32 INS42 INS42 INS9 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL42 DEL32 DEL59 DEL60 DEL27 DEL36 DEL42 DEL42 DEL32 DEL34 DEL16