JCR-2617: ItemStateMap warnings during node type changes

Need to discard the entire /jcr:system/jcr:nodeTypes subtree instead of just the root when the node types change. Otherwise we'll see cache collisions when new items are being created to override the previous ones.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@950579 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.id.PropertyId;
+import org.apache.jackrabbit.core.state.ChildNodeEntry;
+import org.apache.jackrabbit.core.state.NodeState;
-            getRootState().discard();
+            discardTree(getRootState());
-            getRootState().discard();
+            discardTree(getRootState());
+     * Recursively discards all the properties and nodes in the subtree
+     * rooted at the given node state.
+     *
+     * @see <a href="https://issues.apache.org/jira/browse/JCR-2617">JCR-2617</a>
+     * @param state root of the subtree to be discarded
+     * @throws ItemStateException if items in the subtree can not be accessed
+     */
+    private void discardTree(NodeState state) throws ItemStateException {
+        for (Name name : state.getPropertyNames()) {
+            getItemState(new PropertyId(state.getNodeId(), name)).discard();
+        }
+        for (ChildNodeEntry entry : state.getChildNodeEntries()) {
+            discardTree((NodeState) getItemState(entry.getId()));
+        }
+        state.discard();
+    }
+
+    /**

INS26 INS26 INS26 INS40 INS40 INS40 INS31 INS29 INS83 INS39 INS42 INS44 INS43 INS8 INS65 INS65 INS65 INS65 INS43 INS42 INS42 INS70 INS70 INS21 INS66 INS66 INS66 INS42 INS66 INS42 INS66 INS42 INS44 INS32 INS8 INS44 INS32 INS8 INS32 INS43 INS42 INS42 INS42 INS21 INS43 INS42 INS42 INS42 INS21 INS42 INS42 MOV32 MOV32 INS42 INS32 INS42 INS32 UPD42 UPD42 INS32 INS42 INS42 INS11 INS42 INS14 INS43 INS32 INS43 INS32 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42