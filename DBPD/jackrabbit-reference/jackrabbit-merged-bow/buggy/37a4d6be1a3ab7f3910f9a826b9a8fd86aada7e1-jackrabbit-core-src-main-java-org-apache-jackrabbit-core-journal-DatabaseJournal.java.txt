JCR-2832: Crash when adding node to cluster with big journal on PSQL DB

Patch by Omid Milani

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1060431 13f79535-47bb-0310-9956-ffa450edef68

+     * Synchronize contents from journal. May be overridden by subclasses.
+     * Override to do it in batchMode, since some databases (PSQL) when 
+     * not in transactional mode, load all results in memory which causes
+     * out of memory.
+     *
+     * @param startRevision start point (exclusive)
+     * @throws JournalException if an error occurs
+     */
+    @Override
+    protected void doSync(long startRevision) throws JournalException {
+        try {
+            conHelper.startBatch();
+            super.doSync(startRevision);
+        } catch (SQLException e) {
+            // Should throw journal exception instead of just logging it?
+            log.error("couldn't sync the cluster node", e);
+        } finally {
+            try {
+                conHelper.endBatch(true);
+            } catch (SQLException e) {
+                log.warn("couldn't close connection", e);
+            }
+        }
+    }
+
+    /**

INS31 INS29 INS78 INS83 INS39 INS42 INS44 INS43 INS8 INS65 INS65 INS65 INS42 INS39 INS42 INS42 INS54 INS66 INS66 INS66 INS66 INS42 INS66 INS42 INS66 INS8 INS12 INS8 INS21 INS21 INS44 INS8 INS54 INS32 INS48 INS43 INS42 INS21 INS8 INS12 INS42 INS42 INS42 INS42 INS42 INS32 INS21 INS44 INS8 INS42 INS42 INS45 INS42 INS32 INS43 INS42 INS21 INS42 INS42 INS9 INS42 INS32 INS42 INS42 INS45 INS42