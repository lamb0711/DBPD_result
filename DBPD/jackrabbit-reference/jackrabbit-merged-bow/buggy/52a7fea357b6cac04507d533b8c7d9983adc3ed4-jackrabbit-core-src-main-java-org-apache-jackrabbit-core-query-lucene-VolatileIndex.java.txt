JCR-390: Move text extraction into a background thread

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@497067 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.lucene.document.Field;
-import org.slf4j.Logger;
-import org.slf4j.LoggerFactory;
-import javax.jcr.RepositoryException;
-import java.util.Enumeration;
-     * Logger instance for this class.
-     */
-    private static final Logger log = LoggerFactory.getLogger(VolatileIndex.class);
-
-    /**
+     * @param indexingQueue the indexing queue.
-    VolatileIndex(Analyzer analyzer) throws IOException {
-        super(analyzer, new RAMDirectory(), null);
+    VolatileIndex(Analyzer analyzer, IndexingQueue indexingQueue) throws IOException {
+        super(analyzer, new RAMDirectory(), null, indexingQueue);
-     * Overwrites the default implementation by adding the node indexer to a
+     * Overwrites the default implementation by adding the document to a
-     * @param nodeIndexer the node indexer of the node to add.
+     * @param doc the document to add to the index.
-    void addNode(NodeIndexer nodeIndexer) throws IOException {
-        pending.put(nodeIndexer.getNodeId().getUUID().toString(), nodeIndexer);
+    void addDocument(Document doc) throws IOException {
+        Document old = (Document) pending.put(doc.get(FieldNames.UUID), doc);
+        if (old != null) {
+            Util.disposeDocument(old);
+        }
-        NodeIndexer indexer = (NodeIndexer) pending.remove(idTerm.text());
+        Document doc = (Document) pending.remove(idTerm.text());
-        if (indexer != null) {
+        if (doc != null) {
+            Util.disposeDocument(doc);
-            NodeIndexer indexer = (NodeIndexer) it.next();
-            super.addNode(indexer);
+            Document doc = (Document) it.next();
+            super.addDocument(doc);

INS44 UPD42 INS65 INS43 INS42 UPD43 UPD42 INS60 INS25 INS42 INS66 INS42 INS42 UPD66 UPD42 UPD66 UPD42 INS43 INS59 INS27 INS8 UPD43 INS42 INS42 INS11 INS42 INS33 INS21 UPD42 UPD42 UPD42 INS21 INS43 INS32 INS32 UPD43 INS32 UPD43 INS42 MOV42 MOV42 MOV32 UPD42 MOV42 UPD42 MOV42 INS42 INS42 UPD42 INS42 INS42 INS42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 INS40 UPD43 UPD42 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL66 DEL65 DEL29 DEL83 DEL83 DEL83 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL43 DEL57 DEL32 DEL59 DEL23 DEL32 DEL42 DEL32 DEL32 DEL21