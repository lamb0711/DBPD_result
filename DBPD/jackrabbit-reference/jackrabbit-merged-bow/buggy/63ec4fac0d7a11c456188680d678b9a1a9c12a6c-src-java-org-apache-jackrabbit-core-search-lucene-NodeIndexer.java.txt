redesigned transaction support & PersistenceManager

orginal code contributed by dominique pfister, required a lot of tweaking to make it run & work; not thoroughly tested

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@126221 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.util.uuid.UUID;
-import org.apache.jackrabbit.core.state.NodeState;
-import org.apache.jackrabbit.core.state.ItemStateProvider;
-import org.apache.jackrabbit.core.state.NoSuchItemStateException;
-import org.apache.jackrabbit.core.state.ItemStateException;
-import org.apache.jackrabbit.core.state.PropertyState;
-import org.apache.jackrabbit.core.NodeId;
-import org.apache.jackrabbit.core.NoPrefixDeclaredException;
-import org.apache.jackrabbit.core.PropertyId;
-import org.apache.jackrabbit.core.InternalValue;
-import org.apache.jackrabbit.core.Path;
-import org.apache.jackrabbit.core.QName;
+import org.apache.jackrabbit.core.*;
+import org.apache.jackrabbit.core.state.*;
-    /** The <code>NodeState</code> of the node to index */
+    /**
+     * The <code>NodeState</code> of the node to index
+     */
-
-    /** The persistent item state provider */
-    private final ItemStateProvider stateProvider;
+    /**
+     * The persistent item state provider
+     */
+    private final ItemStateManager stateProvider;
-     * @param node the node state to index.
+     *
+     * @param node          the node state to index.
-     * @param mappings internal namespace mappings.
+     * @param mappings      internal namespace mappings.
-                        ItemStateProvider stateProvider,
+                        ItemStateManager stateProvider,
-     * @param node the node state to index.
+     *
+     * @param node          the node state to index.
-     * @param mappings internal namespace mappings.
+     * @param mappings      internal namespace mappings.
-     *   values from the <code>ItemStateProvider</code>.
+     *                             values from the <code>ItemStateProvider</code>.
-                                          ItemStateProvider stateProvider,
+                                          ItemStateManager stateProvider,
+     *
-     *   values from the <code>ItemStateProvider</code>.
+     *                             values from the <code>ItemStateProvider</code>.
-                NodeState parent = (NodeState) stateProvider.getItemState(
-                        new NodeId(node.getParentUUID()));
+                NodeState parent = (NodeState) stateProvider.getItemState(new NodeId(node.getParentUUID()));
-     * @param doc the document.
+     *
+     * @param doc   the document.
-     * @param name the name of the property.
+     * @param name  the name of the property.
-                String uuid = ((UUID) internalValue).toString();
+                String uuid = internalValue.toString();
-                String path = ((Path) internalValue).toString();
+                String path = internalValue.toString();

UPD40 UPD40 UPD43 UPD42 UPD43 UPD43 UPD66 UPD66 UPD66 UPD66 UPD42 UPD66 UPD66 UPD42 UPD66 UPD66 MOV43 MOV43 INS42 INS42 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL42 DEL43 DEL42 DEL11 DEL36 DEL42 DEL43 DEL42 DEL11 DEL36