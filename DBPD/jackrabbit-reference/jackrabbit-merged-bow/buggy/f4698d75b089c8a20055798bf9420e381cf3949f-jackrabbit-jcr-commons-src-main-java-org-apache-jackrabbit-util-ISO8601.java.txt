JCR-1996: Handle date values in the far future or prevent these from being persisted

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@758003 13f79535-47bb-0310-9956-ffa450edef68

+     * or the calendar cannot be represented as defined by ISO 8601 (i.e. year
+     * with more than four digits).
-    public static String format(Calendar cal) {
+    public static String format(Calendar cal) throws IllegalArgumentException {
-        // determine era and adjust year if necessary
-        int year = cal.get(Calendar.YEAR);
-        if (cal.isSet(Calendar.ERA)
-                && cal.get(Calendar.ERA) == GregorianCalendar.BC) {
-            /**
-             * calculate year using astronomical system:
-             * year n BCE => astronomical year -n + 1
-             */
-            year = 0 - year + 1;
-        }
-
-        buf.append(XXXX_FORMAT.format(year));
+        buf.append(XXXX_FORMAT.format(getYear(cal)));
+
+    /**
+     * Returns the astonomical year of the given calendar.
+     *
+     * @param cal a calendar instance.
+     * @return the astronomical year.
+     * @throws IllegalArgumentException if calendar cannot be represented as
+     *                                  defined by ISO 8601 (i.e. year with more
+     *                                  than four digits).
+     */
+    public static int getYear(Calendar cal) throws IllegalArgumentException {
+        // determine era and adjust year if necessary
+        int year = cal.get(Calendar.YEAR);
+        if (cal.isSet(Calendar.ERA)
+                && cal.get(Calendar.ERA) == GregorianCalendar.BC) {
+            /**
+             * calculate year using astronomical system:
+             * year n BCE => astronomical year -n + 1
+             */
+            year = 0 - year + 1;
+        }
+
+        if (year > 9999 || year < -9999) {
+            throw new IllegalArgumentException("Calendar has more than four " +
+                    "year digits, cannot be formatted as ISO8601: " + year);
+        }
+        return year;
+    }

INS31 INS43 MOV21 MOV21 MOV21 MOV21 INS29 INS83 INS83 INS39 INS42 INS44 INS43 INS8 INS42 INS65 INS65 INS65 INS65 INS43 INS42 INS42 MOV60 MOV25 INS25 INS41 INS66 INS66 INS66 INS42 INS66 INS66 INS42 INS66 INS66 INS66 INS42 INS27 INS8 INS42 INS27 INS27 INS53 INS32 INS42 INS34 INS42 INS38 INS14 UPD42 MOV42 INS42 INS34 INS43 INS27 INS42 INS45 INS45 INS42