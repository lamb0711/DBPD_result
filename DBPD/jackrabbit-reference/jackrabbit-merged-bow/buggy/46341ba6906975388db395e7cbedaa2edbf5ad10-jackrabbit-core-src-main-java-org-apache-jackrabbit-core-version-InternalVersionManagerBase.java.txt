JCR-3115: Versioning fixup leaves persistence in a state where the node can't be made versionable again

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1185691 13f79535-47bb-0310-9956-ffa450edef68

+import static org.apache.jackrabbit.spi.commons.name.NameConstants.JCR_ROOTVERSION;
+import org.apache.jackrabbit.core.state.ChildNodeEntry;
-                    throw new InconsistentVersioningState("Unexpected failure to get child node " + name + " on parent node" + parent.getNodeId());
+                    throw new InconsistentVersioningState("Unexpected failure to get child node " + name + " on parent node " + parent.getNodeId());
-                Name root = NameConstants.JCR_ROOTVERSION;
-                info = new VersionHistoryInfo(
-                        history.getNodeId(),
-                        history.getState().getChildNodeEntry(root, 1).getId());
+                ChildNodeEntry rootv = history.getState().getChildNodeEntry(JCR_ROOTVERSION, 1);
+                if (rootv == null) {
+                    throw new InconsistentVersioningState("missing child node entry for " + JCR_ROOTVERSION + " on version history node " + history.getNodeId());
+                }
+                info = new VersionHistoryInfo(history.getNodeId(),
+                        rootv.getId());

INS26 INS26 INS40 INS40 INS25 UPD43 INS27 INS8 UPD42 UPD42 MOV32 INS42 INS33 INS53 UPD42 INS14 INS43 INS27 INS42 UPD45 INS42 INS45 INS42 INS45 INS32 INS42 INS42 DEL40