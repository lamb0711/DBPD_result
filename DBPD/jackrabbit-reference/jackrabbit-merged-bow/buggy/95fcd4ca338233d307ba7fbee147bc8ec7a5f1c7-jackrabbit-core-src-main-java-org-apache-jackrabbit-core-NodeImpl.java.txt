JCR-2503: inconsistent session and persistent state after ReferentialIntegrityException

Patch by Stephan Huttenhuis

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@944258 13f79535-47bb-0310-9956-ffa450edef68

-        NodeState thisState = (NodeState) getOrCreateTransientItemState();
-        if (transientState.getStatus() == ItemState.STATUS_NEW
-                && thisState.getStatus() != ItemState.STATUS_NEW) {
-            thisState.setStatus(ItemState.STATUS_NEW);
-            stateMgr.disconnectTransientItemState(thisState);
+        NodeState thisState = null;
+
+        if (!isTransient()) {
+            thisState = (NodeState) getOrCreateTransientItemState();
+            if (transientState.getStatus() == ItemState.STATUS_NEW
+                    && thisState.getStatus() != ItemState.STATUS_NEW) {
+                thisState.setStatus(ItemState.STATUS_NEW);
+                stateMgr.disconnectTransientItemState(thisState);
+            }
+            thisState.setParentId(transientState.getParentId());
+            thisState.setNodeTypeName(transientState.getNodeTypeName());
+        } else {
+            // JCR-2503: Re-create transient state in the state manager,
+            // because it was removed
+            synchronized (data) {
+                try {
+                    thisState = stateMgr.createTransientNodeState(
+                            (NodeId) transientState.getId(),
+                            transientState.getNodeTypeName(),
+                            transientState.getParentId(),
+                            NodeState.STATUS_NEW);
+                    data.setState(thisState);
+                } catch (ItemStateException e) {
+                    throw new RepositoryException(e);
+                }
+            }
+
-        thisState.setParentId(transientState.getParentId());
-        thisState.setNodeTypeName(transientState.getNodeTypeName());

INS25 INS38 INS8 INS8 INS33 INS32 INS21 MOV25 MOV21 MOV21 INS51 INS42 INS7 INS42 INS8 INS42 MOV11 INS54 INS8 INS12 INS21 INS21 INS44 INS8 INS7 INS32 INS43 INS42 INS53 INS42 INS32 INS42 INS42 INS42 INS42 INS14 INS42 INS42 INS11 INS32 INS32 INS40 INS43 INS42 INS43 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42