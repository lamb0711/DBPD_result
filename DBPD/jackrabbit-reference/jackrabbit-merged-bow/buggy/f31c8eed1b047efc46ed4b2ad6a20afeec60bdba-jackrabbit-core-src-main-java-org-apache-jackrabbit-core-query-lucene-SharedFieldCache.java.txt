JCR-974: Manage Lucene FieldCaches per index segment

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@550429 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.lucene.search.FieldCache;
+     * Expert: Stores term text values and document ordering data.
+     */
+    public static class StringIndex {
+
+        /**
+         * All the term values, in natural order.
+         */
+        public final String[] lookup;
+
+        /**
+         * Terms indexed by document id.
+         */
+        public final String[] terms;
+
+        /**
+         * Creates one of these objects
+         */
+        public StringIndex(String[] terms, String[] lookup) {
+            this.terms = terms;
+            this.lookup = lookup;
+        }
+    }
+
+    /**
-    public FieldCache.StringIndex getStringIndex(IndexReader reader,
+    public SharedFieldCache.StringIndex getStringIndex(IndexReader reader,
+        
+        if (reader instanceof ReadOnlyIndexReader) {
+            reader = ((ReadOnlyIndexReader) reader).getBase();
+        }
+        
-        FieldCache.StringIndex ret = lookup(reader, field, prefix, comparator);
+        SharedFieldCache.StringIndex ret = lookup(reader, field, prefix, comparator);
-            final int[] retArray = new int[reader.maxDoc()];
+            final String[] retArray = new String[reader.maxDoc()];
-                int t = 1;  // current term number
-                            retArray[termDocs.doc()] = t;
+                            retArray[termDocs.doc()] = term.text().substring(prefix.length());
-
-                        t++;
-            FieldCache.StringIndex value = new FieldCache.StringIndex(retArray, lookup);
+            SharedFieldCache.StringIndex value = new SharedFieldCache.StringIndex(retArray, lookup);
-    FieldCache.StringIndex lookup(IndexReader reader, String field,
+    SharedFieldCache.StringIndex lookup(IndexReader reader, String field,
-            return (FieldCache.StringIndex) readerCache.get(key);
+            return (SharedFieldCache.StringIndex) readerCache.get(key);
-                 SortComparator comparer, FieldCache.StringIndex value) {
+                 SortComparator comparer, SharedFieldCache.StringIndex value) {

INS55 INS29 INS83 INS83 INS42 INS23 INS23 INS31 UPD43 UPD43 INS65 INS29 INS83 INS83 INS5 INS59 INS29 INS83 INS83 INS5 INS59 INS29 INS83 INS42 INS44 INS44 INS8 UPD40 INS25 UPD40 UPD43 INS66 INS65 INS43 INS85 INS42 INS65 INS43 INS85 INS42 INS65 INS5 INS42 INS5 INS42 INS21 INS21 INS62 INS8 UPD43 UPD40 INS66 INS42 INS66 INS42 INS66 INS43 INS85 INS43 INS85 INS7 INS7 INS42 INS43 INS21 UPD40 INS42 INS42 INS22 INS42 INS22 INS42 INS42 INS7 UPD5 UPD43 INS52 INS42 INS52 INS42 INS42 INS32 INS43 UPD40 UPD43 INS36 INS42 INS42 UPD5 UPD43 UPD40 INS11 INS43 UPD40 INS43 INS42 INS42 INS42 INS32 INS32 INS42 INS32 INS42 INS42 INS42 INS42 DEL40 DEL26 DEL39 DEL39 DEL39 DEL42 DEL34 DEL59 DEL60 DEL42 DEL42 DEL37 DEL21