JCR-2360: JcrUtils.getRepository(...) for simple repository access

Added a o.a.j.commons.GenericRepositoryFactory class that implements the repository URI and JNDI lookup mechanisms. Dropped the o.a.j.core.jndi.RepositoryFactoryImpl class whose functionality is now merged to GenericRepositoryFactory.

Adapted the JcrUtils.getRepository(String uri) method to use GenericRepositoryFactory through the standard RepositoryFactory mechanism instead of directly implementing the URI deconstruction mechanism. This way other RepositoryFactory implementations can also take a shot at processing the org.apache.jackrabbit.repository.uri parameter.

Added a JcrUtils.getRepository() method that returns the default repository. Adapted jackrabbit-core tests to use JcrUtils.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@828993 13f79535-47bb-0310-9956-ffa450edef68

-import java.io.File;
-import java.net.URI;
-import java.net.URISyntaxException;
+     * Returns the default repository of the current environment.
+     * Implemented by calling {@link #getRepository(Map)} with a
+     * <code>null</code> parameter map.
+     *
+     * @see RepositoryFactory#getRepository(Map)
+     * @return default repository
+     * @throws RepositoryException if a default repository is not available
+     *                             or can not be accessed
+     */
+    public static Repository getRepository() throws RepositoryException {
+        return getRepository((Map<String, String>) null);
+    }
+
+    /**
+     * <p>
+     * Note that unlike {@link RepositoryFactory#getRepository(Map)} this
+     * method will throw an exception instead of returning <code>null</code>
+     * if the given parameters can not be interpreted.
-     * @see RepositoryFactory#getRepository(Map)
-     * Returns the repository identified by the given URI.
-     * <p>
-     * The currently supported URI types are:
+     * Returns the repository identified by the given URI. The following
+     * URI types are currently supported:
-     *     JNDI lookup for a repository stored under the given name in the
-     *     default JNDI context.
-     *   </dd>
+     *     JNDI lookup for the named repository. See the JNDI support
+     *     described above.
+     *  </dd>
-     * <p>
-        try {
-            URI parsed = new URI(uri.trim());
-            String scheme = parsed.getScheme();
-            if ("jndi".equalsIgnoreCase(scheme)) {
-                Map<String, String> parameters = new HashMap<String, String>();
-                parameters.put(
-                        "org.apache.jackrabbit.repository.jndi.name",
-                        parsed.getSchemeSpecificPart());
-                return getRepository(parameters);
-            } else if ("file".equalsIgnoreCase(scheme)) {
-                return getRepository(new File(parsed));
-            } else if ("http".equalsIgnoreCase(scheme)
-                    || "https".equalsIgnoreCase(scheme)){
-                return getRepository(parsed);
-            } else {
-                throw new RepositoryException(
-                        "Unsupported repository URI: " + uri);
-            }
-        } catch (URISyntaxException e) {
-            throw new RepositoryException("Invalid repository URI: " + uri, e);
-        }
-    }
-
-    /**
-     * Returns an SPI2DAVex client that accesses a repository at the given URI.
-     *
-     * @param uri repository URI
-     * @return SPI2DAVex repository client
-     * @throws RepositoryException if the repository can not be accessed,
-     *                             or if the required SPI2DAVex libraries
-     *                             are not available
-     */
-    private static Repository getRepository(URI uri)
-            throws RepositoryException {
-        parameters.put(
-                "org.apache.jackrabbit.spi.RepositoryServiceFactory",
-                "org.apache.jackrabbit.spi2davex.Spi2davexRepositoryServiceFactory");
-        parameters.put(
-                "org.apache.jackrabbit.spi2davex.uri", uri.toASCIIString());
-        return getRepository(parameters);
-    }
-
-    /**
-     * Returns an embedded Jackrabbit repository located at the given
-     * file system path. The path can point either to the repository
-     * directory (in which case a "repository.xml" configuration file
-     * is expected to be found inside the directory) or to the repository
-     * configuration file (in which case the repository directory is assumed
-     * to be the directory that contains the configuration file).
-     *
-     * @param file repository path
-     * @return Jackrabbit repository
-     * @throws RepositoryException if the repository can not be accessed,
-     *                             or if the required Jackrabbit libraries
-     *                             are not available
-     */
-    private static Repository getRepository(File file)
-            throws RepositoryException {
-        Map<String, String> parameters = new HashMap<String, String>();
-
-        String home, conf;
-        if (file.isFile()) {
-            home = file.getParentFile().getPath();
-            conf = file.getPath();
-        } else {
-            home = file.getPath();
-            conf = new File(file, "repository.xml").getPath();
-        }
-        parameters.put("org.apache.jackrabbit.repository.home", home);
-        parameters.put("org.apache.jackrabbit.repository.conf", conf);
-
-        return getRepository(parameters);
+        parameters.put(GenericRepositoryFactory.URI, uri);
+        return new GenericRepositoryFactory().getRepository(parameters);

INS31 INS29 UPD83 MOV83 MOV83 MOV43 MOV42 MOV43 INS8 UPD83 MOV43 MOV44 MOV43 MOV8 INS65 MOV65 MOV65 MOV65 INS41 INS65 MOV65 MOV65 MOV65 UPD66 MOV66 UPD66 MOV66 INS65 UPD66 MOV66 UPD66 MOV66 UPD66 UPD66 UPD66 INS32 INS66 INS66 INS65 INS66 INS66 INS66 UPD66 MOV66 UPD66 MOV66 UPD66 MOV66 UPD66 MOV66 INS66 UPD66 MOV66 INS66 UPD66 MOV66 UPD66 MOV66 UPD66 MOV66 INS66 INS66 INS66 UPD66 MOV66 UPD66 MOV66 UPD66 MOV66 INS66 INS68 INS42 INS11 INS68 INS40 UPD42 MOV42 INS14 INS42 INS69 INS74 INS33 INS42 INS42 INS69 INS43 INS43 MOV43 MOV43 MOV43 INS43 INS42 UPD42 MOV42 INS42 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL66 DEL66 DEL66 DEL66 DEL66 DEL66 DEL66 DEL66 DEL66 DEL66 DEL66 DEL66 DEL66 DEL66 DEL66 DEL66 DEL66 DEL66 DEL65 DEL29 DEL83 DEL83 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL42 DEL32 DEL14 DEL59 DEL60 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL45 DEL42 DEL42 DEL32 DEL45 DEL42 DEL42 DEL32 DEL42 DEL42 DEL43 DEL42 DEL14 DEL32 DEL41 DEL8 DEL45 DEL42 DEL42 DEL32 DEL45 DEL42 DEL42 DEL32 DEL27 DEL42 DEL42 DEL32 DEL41 DEL8 DEL42 DEL43 DEL45 DEL42 DEL27 DEL14 DEL53 DEL8 DEL25 DEL25 DEL25 DEL8 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL45 DEL42 DEL27 DEL42 DEL14 DEL53 DEL8 DEL12 DEL54 DEL8 DEL31 DEL65 DEL42 DEL65 DEL29 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL42 DEL43 DEL42 DEL43 DEL42 DEL43 DEL74 DEL14 DEL59 DEL60 DEL42 DEL42 DEL45 DEL45 DEL32 DEL21 DEL42 DEL42 DEL45 DEL42 DEL42 DEL32 DEL32 DEL21 DEL42 DEL42 DEL32 DEL41 DEL8 DEL31 DEL65 DEL42 DEL65 DEL65 DEL42 DEL65 DEL42 DEL43 DEL45 DEL42 DEL32 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL43 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL42 DEL43 DEL42 DEL43 DEL42 DEL43 DEL74 DEL14 DEL59 DEL60 DEL42 DEL59 DEL42 DEL59 DEL60 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL7 DEL21 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL8 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL42 DEL42 DEL43 DEL42 DEL45 DEL14 DEL42 DEL32 DEL7 DEL21 DEL8 DEL25 DEL42 DEL42 DEL45 DEL42 DEL32 DEL21 DEL42 DEL42 DEL45 DEL42 DEL32 DEL21 DEL42 DEL42 DEL32 DEL41 DEL8