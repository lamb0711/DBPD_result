JCR-1800 lockmgr isn't aware about external unlock (CacheBehavior.OBSERVATION)

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@704358 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.jcr2spi.hierarchy.NodeEntry;
-import org.apache.jackrabbit.jcr2spi.operation.Operation;
+import org.apache.jackrabbit.jcr2spi.hierarchy.NodeEntry;
-import org.apache.jackrabbit.jcr2spi.operation.LockRelease;
-import org.apache.jackrabbit.jcr2spi.state.NodeState;
-import org.apache.jackrabbit.jcr2spi.state.Status;
-import org.apache.jackrabbit.jcr2spi.state.ItemStateLifeCycleListener;
+import org.apache.jackrabbit.jcr2spi.operation.LockRelease;
+import org.apache.jackrabbit.jcr2spi.operation.Operation;
+import org.apache.jackrabbit.jcr2spi.state.ItemStateLifeCycleListener;
+import org.apache.jackrabbit.jcr2spi.state.NodeState;
+import org.apache.jackrabbit.jcr2spi.state.Status;
-import org.slf4j.LoggerFactory;
+import org.slf4j.LoggerFactory;
+import javax.jcr.Item;
+import javax.jcr.ItemNotFoundException;
+import javax.jcr.Node;
+import javax.jcr.RepositoryException;
+import javax.jcr.Session;
-import javax.jcr.RepositoryException;
-import javax.jcr.Node;
-import javax.jcr.Item;
-import javax.jcr.Session;
-import javax.jcr.ItemNotFoundException;
-
+import java.util.HashMap;
-import java.util.HashMap;
-            log.warn("Error while accessing lock holding NodeState", e);
+            log.warn("Error while accessing lock holding NodeState", e.getMessage());
+                    if (!lockHoldingState.hasPropertyName(NameConstants.JCR_LOCKISDEEP)) {
+                        // force reloading of the lock holding node.
+                        itemManager.getItem(lockHoldingState.getNodeEntry().getPath());
+                    }
-                    log.warn("Internal error", e);
+                    log.warn("Unable to retrieve jcr:isDeep property after lock creation.", e.getMessage());
-                    log.debug("jcr:isDeep doesn't exist any more.");
+                    log.debug("jcr:lockIsDeep doesn't exist any more.");

MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 INS32 INS25 MOV42 INS42 INS38 INS8 INS32 INS21 INS42 INS42 INS40 INS32 UPD45 INS32 UPD45 INS42 INS42 INS32 MOV42 INS42 INS32 INS42 INS42 INS42