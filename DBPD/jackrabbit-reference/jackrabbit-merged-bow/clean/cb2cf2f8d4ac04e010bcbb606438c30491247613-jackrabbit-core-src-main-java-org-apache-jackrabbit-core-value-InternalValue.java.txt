JCR-2781 FileDataStore performance improvements

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1022094 13f79535-47bb-0310-9956-ffa450edef68

-                        // access the record to ensure it is not garbage collected
-                        if (store.getRecordIfStored(identifier) != null) {
-                            // it exists - so we don't need to stream it again
-                            // but we need to create a new object because the original
-                            // one might be in a different data store (repository)
+                        if (bin.usesDataStore(store)) {
+                            // access the record to ensure it is not garbage collected
+                            store.getRecord(identifier);
+                        } else {
+                            if (store.getRecordIfStored(identifier) != null) {
+                                // it exists - so we don't need to stream it again
+                                // but we need to create a new object because the original
+                                // one might be in a different data store (repository)
+                                blob = BLOBInDataStore.getInstance(store, identifier);
+                            }
-    static InternalValue getInternalValue(DataIdentifier identifier, DataStore store) throws DataStoreException {
-        // access the record to ensure it is not garbage collected
-        if (store.getRecordIfStored(identifier) != null) {
-            // it exists - so we don't need to stream it again
-            // but we need to create a new object because the original
-            // one might be in a different data store (repository)
-            BLOBFileValue blob = BLOBInDataStore.getInstance(store, identifier);
-            return new InternalValue(blob);
+    /**
+     * Get the internal value for this blob.
+     *
+     * @param identifier the identifier
+     * @param store the data store
+     * @param verify verify if the record exists, and return null if not
+     * @return the internal value or null
+     */
+    static InternalValue getInternalValue(DataIdentifier identifier, DataStore store, boolean verify) throws DataStoreException {
+        if (verify) {
+            if (store.getRecordIfStored(identifier) == null) {
+                return null;
+            }
+        } else {
+            // access the record to ensure it is not garbage collected
+            store.getRecord(identifier);
-        return null;
+        // it exists - so we don't need to stream it again
+        // but we need to create a new object because the original
+        // one might be in a different data store (repository)
+        BLOBFileValue blob = BLOBInDataStore.getInstance(store, identifier);
+        return new InternalValue(blob);

INS29 INS44 MOV8 INS65 INS65 INS65 INS65 INS65 INS39 INS42 INS25 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS66 INS42 INS8 INS8 INS25 INS21 UPD27 MOV27 INS8 INS32 INS8 MOV41 INS42 INS42 INS42 INS25 INS32 INS8 MOV8 INS42 INS42 INS42 INS21 INS21 INS32 INS7 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 DEL25 DEL8