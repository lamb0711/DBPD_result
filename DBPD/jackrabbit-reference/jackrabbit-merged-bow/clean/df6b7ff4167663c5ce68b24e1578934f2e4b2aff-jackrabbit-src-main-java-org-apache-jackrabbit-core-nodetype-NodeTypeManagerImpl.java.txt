JCR-409: Use the new NamespaceRegistryImpl.safeRegisterNamespace() method to simplify and safeguard namespace registration.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@396303 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.NamespaceRegistryImpl;
-import javax.jcr.NamespaceException;
-import javax.jcr.NamespaceRegistry;
-    private final NamespaceRegistry nsReg;
+    private final NamespaceRegistryImpl nsReg;
-            NodeTypeRegistry ntReg, NamespaceRegistry nsReg,
+            NodeTypeRegistry ntReg, NamespaceRegistryImpl nsReg,
-     * Registers a single namespace bypassing registration if the namespace
-     * is already registered. A unique prefix is automatically genenerated
-     * if the given prefix is already mapped to another namespace.
-     *
-     * @param prefix The namespace prefix
-     * @param uri The namespace URI
-     * @throws RepositoryException if a repository error occurs
-     */
-    protected void registerNamespace(String prefix, String uri)
-            throws RepositoryException {
-        try {
-            // Check if the uri is already registered
-            nsReg.getPrefix(uri);
-        } catch (NamespaceException e1) {
-            // The uri is not in the registry. The prefix may be with another
-            // uri or it may not be (the ideal scenario).  In either case,
-            // attempt to register it and add a incrementing sequence number
-            // to the prefix until it no longer conflicts with any existing
-            // prefix.
-            String original = prefix;
-            for (int i = 2; true; i++) {
-                try {
-                    // Attempt to register the prefix and uri... if the prefix
-                    // is already registered an exception will be thrown due
-                    // to an attempt to remap.
-                    nsReg.registerNamespace(prefix, uri);
-                    return;
-                } catch (NamespaceException e2) {
-                    prefix = original + i;
-                }
-            }
-        }
-    }
-
-    /**
-                    registerNamespace(prefix, namespaces.getProperty(prefix));
+                    nsReg.safeRegisterNamespace(
+                            prefix, namespaces.getProperty(prefix));
-                  registerNamespace(
+                  nsReg.safeRegisterNamespace(

MOV26 UPD40 UPD43 UPD42 UPD43 UPD42 INS42 UPD42 INS42 UPD42 DEL40 DEL26 DEL66 DEL66 DEL66 DEL65 DEL42 DEL66 DEL65 DEL42 DEL66 DEL65 DEL42 DEL66 DEL65 DEL29 DEL83 DEL39 DEL42 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL21 DEL8 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL42 DEL59 DEL60 DEL39 DEL42 DEL34 DEL59 DEL58 DEL9 DEL42 DEL37 DEL42 DEL42 DEL42 DEL42 DEL32 DEL21 DEL41 DEL8 DEL42 DEL43 DEL42 DEL44 DEL42 DEL42 DEL42 DEL27 DEL7 DEL21 DEL8 DEL12 DEL54 DEL8 DEL24 DEL8 DEL12 DEL54 DEL8 DEL31