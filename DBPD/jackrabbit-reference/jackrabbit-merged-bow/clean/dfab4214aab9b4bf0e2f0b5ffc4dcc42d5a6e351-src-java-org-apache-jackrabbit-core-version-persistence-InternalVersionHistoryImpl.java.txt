- rearranging structure of versioning (will corrupt versioned data)
- adding observation of version storage (work in progress)


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@159366 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.PropertyImpl;
-import javax.jcr.PropertyIterator;
-        historyId = (String) node.getPropertyValue(NativePVM.PROPNAME_HISTORY_ID).internalValue();
+        historyId = node.getUUID();
-            InternalVersionImpl v = new InternalVersionImpl(this, child);
+            InternalVersionImpl v = new InternalVersionImpl(this, child, child.getName());
-    protected String getPersistentId() {
-        return node.getUUID();
-    }
-
-            PersistentNode lNode = labelNode.addNode(label, NT_UNSTRUCTURED);
+            PersistentNode lNode = labelNode.addNode(label, NT_UNSTRUCTURED, null);
-        QName nodeName = new QName(NS_DEFAULT_URI, versionId);
-        PersistentNode vNode = node.addNode(nodeName, NativePVM.NT_REP_VERSION);
-        vNode.setPropertyValue(NativePVM.PROPNAME_VERSION_ID, InternalValue.create(versionId));
-        vNode.setPropertyValue(NativePVM.PROPNAME_VERSION_NAME, InternalValue.create(name));
+        PersistentNode vNode = node.addNode(name, NativePVM.NT_REP_VERSION, versionId);
-        InternalVersionImpl version = new InternalVersionImpl(this, vNode);
+        InternalVersionImpl version = new InternalVersionImpl(this, vNode, name);
-    protected String getUUID() {
-        return node.getUUID();
+    /**
+     * {@inheritDoc}
+     */
+    public String getVersionLabelsUUID() {
+        return labelNode.getUUID();
+    /**
+     * Returns the persistent node of this version history
+     * @return
+     */
-        PersistentNode pNode = parent.addNode(name, NativePVM.NT_REP_VERSION_HISTORY);
-        pNode.setPropertyValue(NativePVM.PROPNAME_HISTORY_ID, InternalValue.create(historyId));
+        PersistentNode pNode = parent.addNode(name, NativePVM.NT_REP_VERSION_HISTORY, historyId);
-        pNode.addNode(NativePVM.NODENAME_VERSION_LABELS, NT_UNSTRUCTURED);
+        pNode.addNode(NativePVM.NODENAME_VERSION_LABELS, NT_UNSTRUCTURED, null);
-        QName nodeName = new QName(NS_DEFAULT_URI, versionId);
-        PersistentNode vNode = pNode.addNode(nodeName, NativePVM.NT_REP_VERSION);
-        vNode.setPropertyValue(NativePVM.PROPNAME_VERSION_ID, InternalValue.create(versionId));
-        vNode.setPropertyValue(NativePVM.PROPNAME_VERSION_NAME, InternalValue.create(JCR_ROOTVERSION));
+        PersistentNode vNode = pNode.addNode(JCR_ROOTVERSION, NativePVM.NT_REP_VERSION, versionId);

INS29 UPD83 UPD42 INS29 INS65 INS65 INS65 MOV43 INS65 INS66 MOV43 MOV43 MOV32 UPD42 INS33 MOV43 UPD42 INS42 MOV43 INS42 INS42 UPD42 INS42 MOV43 INS32 INS33 INS42 INS42 DEL40 DEL26 DEL40 DEL26 DEL42 DEL43 DEL40 DEL32 DEL42 DEL32 DEL11 DEL83 DEL42 DEL43 DEL42 DEL41 DEL8 DEL31 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL42 DEL14 DEL59 DEL60 DEL42 DEL42 DEL40 DEL42 DEL42 DEL42 DEL32 DEL32 DEL21 DEL42 DEL42 DEL40 DEL42 DEL42 DEL42 DEL32 DEL32 DEL21 DEL42 DEL42 DEL40 DEL42 DEL42 DEL42 DEL32 DEL32 DEL21 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL42 DEL14 DEL59 DEL60 DEL42 DEL42 DEL40 DEL42 DEL42 DEL42 DEL32 DEL32 DEL21 DEL42 DEL42 DEL40 DEL42 DEL42 DEL42 DEL32 DEL32 DEL21