JCR-1668 After RepositoryImpl instance has been created and shut down, some classes cannot be unloaded

* Stops the TransientFileFactory reaper thread and the DatabaseJournal janitor thread on shutdown.


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@796955 13f79535-47bb-0310-9956-ffa450edef68

-    private ReferenceQueue phantomRefQueue = new ReferenceQueue();
+    private final ReferenceQueue<File> phantomRefQueue = new ReferenceQueue<File>();
-    private Collection trackedRefs = Collections.synchronizedList(new ArrayList());
+    private final Collection<MoribundFileReference> trackedRefs =
+        Collections.synchronizedList(new ArrayList<MoribundFileReference>());
-    private final Thread reaper;
+    private final ReaperThread reaper;
-            for (Iterator it = trackedRefs.iterator(); it.hasNext();) {
-                MoribundFileReference fileRef = (MoribundFileReference) it.next();
-                fileRef.delete();
+            for (Iterator<MoribundFileReference> it = trackedRefs.iterator(); it.hasNext();) {
+                it.next().delete();
+            shutdownHook = null;
+        reaper.stopWorking();
+        private volatile boolean stopping = false;
+
-            while (true) {
+            while (!stopping) {
+                } catch (InterruptedException e) {
+                    if (stopping) {
+                        break;
+                    }
+
+        /**
+         * Stops the reaper thread.
+         */
+        public void stopWorking() {
+            stopping = true;
+            interrupt();
+        }
-    private class MoribundFileReference extends PhantomReference {
+    private class MoribundFileReference extends PhantomReference<File> {
-        private String path;
+        private final String path;
-        MoribundFileReference(File file, ReferenceQueue queue) {
+        MoribundFileReference(File file, ReferenceQueue<File> queue) {

INS83 INS74 INS83 INS74 UPD43 INS23 INS31 INS74 MOV43 INS43 MOV43 INS43 UPD42 INS21 INS83 INS83 INS39 INS59 INS29 INS83 INS39 INS42 INS8 MOV43 INS43 INS83 INS42 INS74 INS42 INS32 INS42 INS9 INS65 INS21 INS21 INS42 INS74 MOV43 INS43 INS74 INS21 INS42 INS42 INS38 INS66 INS7 INS32 MOV43 INS43 INS42 MOV43 MOV43 INS7 INS42 INS42 INS9 INS42 INS42 INS74 INS42 INS33 INS12 MOV43 MOV43 INS44 INS8 MOV32 INS43 INS42 INS25 INS42 INS42 INS8 INS10 DEL42 DEL11 DEL59 DEL60 DEL42 DEL9