JCR-2672 - Cache also failed principal lookups

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@964362 13f79535-47bb-0310-9956-ffa450edef68

+    /** Option name to enable negative cache entries (see JCR-2672) */
+    public static final String NEGATIVE_ENTRY_KEY = "cacheIncludesNegative";
+    /**
+     * flag indicating if the cache should include 'negative' entries.
+     * @see #NEGATIVE_ENTRY_KEY
+     */
+    private boolean includeNegative;
+
-     * {@link #providePrincipal(String)} is called, if no principal with the
-     * given name is present in the cache.
+     * {@link #providePrincipal(String)} is called, if no matching entry
+     * is present in the cache.<br>
+     * NOTE: If the cache is enabled to contain negative entries (see
+     * {@link #NEGATIVE_ENTRY_KEY} configuration option), the cache will also
+     * store negative matches (as <code>null</code> values) in the principal cache.
-        Principal principal = (Principal) cache.get(principalName);
-        if (principal == null) {
-            principal = providePrincipal(principalName);
-            if (principal != null) {
-                addToCache(principal);
+        if (cache.containsKey(principalName)) {
+            return (Principal) cache.get(principalName);
+        } else {
+            Principal principal = providePrincipal(principalName);
+            if (principal != null || includeNegative) {
+                cache.put(principalName, principal);
+            return principal;
-        return principal;
-
+        includeNegative = Boolean.parseBoolean(options.getProperty(NEGATIVE_ENTRY_KEY, "false"));
+        

INS23 INS23 INS29 INS83 INS83 INS83 INS43 INS59 INS29 INS83 INS39 INS59 INS65 INS42 INS42 INS45 INS65 INS65 INS42 INS25 INS21 INS66 INS66 INS67 UPD66 UPD66 INS66 INS65 INS66 INS66 INS32 INS8 INS8 INS7 INS42 INS67 INS42 INS42 INS42 INS41 MOV60 MOV25 MOV41 INS42 INS32 INS42 MOV11 UPD27 MOV8 INS42 INS42 INS32 MOV32 MOV27 UPD42 INS42 INS42 INS42 INS45 UPD42 INS42 INS42 DEL33 DEL42 DEL7 DEL21 DEL25 DEL8