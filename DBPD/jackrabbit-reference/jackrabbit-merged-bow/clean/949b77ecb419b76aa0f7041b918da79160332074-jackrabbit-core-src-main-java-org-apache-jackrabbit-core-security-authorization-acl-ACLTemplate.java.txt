JCR-2420: Node removal fails with AccessDeniedException


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@921394 13f79535-47bb-0310-9956-ffa450edef68

-                Entry ace = new Entry(
+                Entry ace = createEntry(
-                        aceNode.isNodeType(AccessControlConstants.NT_REP_GRANT_ACE),
-                        valueFactory);
+                        aceNode.isNodeType(AccessControlConstants.NT_REP_GRANT_ACE));
+    /**
+     * Create a new entry omitting any validation checks.
+     * 
+     * @param principal
+     * @param privileges
+     * @param isAllow
+     * @return
+     */
+    Entry createEntry(Principal principal, Privilege[] privileges, boolean isAllow) throws AccessControlException {
+        return new Entry(principal, privileges, isAllow);
+    }
+
-                    entry = new Entry(entry.getPrincipal(), mergedPrivs, entry.isAllow(), valueFactory);
+                    entry = createEntry(entry.getPrincipal(), mergedPrivs, entry.isAllow());
-                    Entry tmpl = new Entry(entry.getPrincipal(),
+                    Entry tmpl = createEntry(entry.getPrincipal(),
-                            !entry.isAllow(), valueFactory);
+                            !entry.isAllow());
+    @Override
+    @Override
-        Entry ace = new Entry(principal, privileges, isAllow, valueFactory);
+        Entry ace = createEntry(principal, privileges, isAllow);
-    static class Entry extends AccessControlEntryImpl {
+    class Entry extends AccessControlEntryImpl {
-        Entry(Principal principal, Privilege[] privileges, boolean allow, ValueFactory valueFactory)
+        private Entry(Principal principal, Privilege[] privileges, boolean allow)
+
+        /**
+         * @param nodePath
+         * @return <code>true</code> if this entry is defined on the node
+         * at <code>nodePath</code>
+         */
+        boolean isLocal(String nodePath) {
+            return path != null && path.equals(nodePath);
+        }

INS31 INS29 MOV43 INS42 INS44 INS44 INS44 INS43 INS8 INS78 INS78 INS31 INS65 INS65 INS65 INS65 INS65 INS43 INS42 INS5 INS42 INS39 INS42 INS42 INS41 INS42 INS42 INS83 INS29 INS39 INS42 INS44 INS8 INS66 INS42 INS42 INS42 INS42 INS43 INS85 INS14 MOV43 INS65 INS65 INS43 INS42 INS41 INS42 MOV43 INS42 INS42 INS42 INS32 INS42 INS66 INS66 INS42 INS27 INS42 INS42 INS42 INS42 INS27 INS32 INS42 INS33 INS42 INS42 INS42 MOV43 INS32 INS42 INS42 INS42 MOV32 INS32 MOV43 INS42 MOV32 INS42 MOV32 INS32 INS42 MOV32 MOV32 MOV38 DEL42 DEL42 DEL42 DEL14 DEL42 DEL42 DEL14 DEL42 DEL43 DEL42 DEL14 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL14 DEL83 DEL42 DEL43 DEL42 DEL44