JCR-3269 fix 'disconnected' nodes by removing them from the node that references them as a child

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1350224 13f79535-47bb-0310-9956-ffa450edef68

+        Collection<NodePropBundle.ChildNodeEntry> disconnectedChildren = new ArrayList<NodePropBundle.ChildNodeEntry>();
-                    if (cp == null || !cp.equals(id)) {
+                    if (!id.equals(cp)) {
-                                if (cp == null) {
-                                    message = "ChildNode has invalid parent id: <null>";
-                                    log.error(message);
-                                } else if (!cp.equals(id)) {
-                                    message = "ChildNode has invalid parent id: '" + cp
-                                            + "' (instead of '" + id + "')";
-                                    log.error(message);
-                                }
+                                // indeed we have a disconnected child
+                                message = "ChildNode has invalid parent id: '" + cp + "' (instead of '" + id + "')";
+                                log.error(message);
+                                disconnectedChildren.add(entry);
-        if (fix && !missingChildren.isEmpty()) {
+        if (fix && (!missingChildren.isEmpty() || !disconnectedChildren.isEmpty())) {
+            for (NodePropBundle.ChildNodeEntry entry : disconnectedChildren) {
+                bundle.getChildNodeEntries().remove(entry);
+            }

INS60 INS74 INS59 INS27 INS43 INS43 INS42 INS14 INS42 INS36 INS70 INS42 INS40 INS74 UPD27 MOV27 INS44 INS42 INS8 INS43 INS43 INS38 INS43 INS42 INS21 INS42 INS40 INS32 INS40 INS32 INS42 INS42 INS32 INS42 INS42 INS38 INS42 INS42 MOV32 UPD42 UPD42 MOV25 INS42 INS21 INS32 INS42 INS42 INS42 DEL42 DEL33 DEL27 DEL38 DEL27 DEL42 DEL42 DEL42 DEL32 DEL38 DEL42 DEL42 DEL33 DEL27 DEL42 DEL45 DEL7 DEL21 DEL42 DEL42 DEL42 DEL32 DEL21 DEL8 DEL25 DEL8 DEL25 DEL42