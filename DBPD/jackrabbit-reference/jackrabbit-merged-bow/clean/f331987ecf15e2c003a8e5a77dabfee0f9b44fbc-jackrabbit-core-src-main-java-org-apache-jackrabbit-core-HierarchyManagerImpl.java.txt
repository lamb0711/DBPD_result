JCR-1104 - JSR 283 support
- shareble nodes (work in progress)
- fix test failure introduced in r646336

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@647072 13f79535-47bb-0310-9956-ffa450edef68

+     * @param useOverlayed whether to use overlayed state for shareable nodes
-    protected Set getParentIds(ItemState state) {
+    protected Set getParentIds(ItemState state, boolean useOverlayed) {
+            if (ns.isShareable() && useOverlayed && ns.hasOverlayedState()) {
+                ns = (NodeState) ns.getOverlayedState();
+            }
-            Set parentIds = getParentIds(state);
+            Set parentIds = getParentIds(state, false);
-                    grandparentIds.addAll(getParentIds(getItemState(parentId)));
+                    grandparentIds.addAll(getParentIds(getItemState(parentId), false));
-            if (state.hasOverlayedState()) {
-                state = state.getOverlayedState();
-            }
-            Set parentIds = getParentIds(state);
+            Set parentIds = getParentIds(state, true);
-                    if (state.hasOverlayedState()) {
-                        state = state.getOverlayedState();
-                    }
-                    grandparentIds.addAll(getParentIds(state));
+                    grandparentIds.addAll(getParentIds(state, true));

INS44 INS65 INS39 INS42 INS42 INS66 INS25 INS27 INS8 INS32 INS42 INS32 INS21 INS42 INS42 INS42 INS42 INS7 INS9 INS9 INS42 INS11 INS43 INS32 INS42 INS42 INS42 INS9 INS9 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL8 DEL25 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL8 DEL25