JCR-1658: Executing query throws UnsupportedRepositoryOperationException(LEVEL_2_SUPPORTED) for a level 1 only implementation

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@674491 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.jcr2spi.hierarchy.HierarchyManager;
+import org.apache.jackrabbit.jcr2spi.ManagerProvider;
-     * Name and Path resolver
+     * Provides various managers.
-    private final NamePathResolver resolver;
+    private final ManagerProvider mgrProvider;
-     * The hierarchy manager of the session that executes this query.
-     */
-    private final HierarchyManager hierarchyManager;
-
-    /**
-     * @param resolver
+     * @param mgrProvider the manager provider.
-     * @param hierarchyManager the HierarchyManager of that session.
-    public QueryImpl(Session session, NamePathResolver resolver,
-                     ItemManager itemMgr, HierarchyManager hierarchyManager,
-                     WorkspaceManager wspManager,
+    public QueryImpl(Session session, ManagerProvider mgrProvider,
+                     ItemManager itemMgr, WorkspaceManager wspManager,
-        this.resolver = resolver;
+        this.mgrProvider = mgrProvider;
-        this.hierarchyManager = hierarchyManager;
-     * @param resolver
+     * @param mgrProvider the manager provider.
-     * @param hierarchyManager
-    public QueryImpl(Session session, NamePathResolver resolver,
-                     ItemManager itemMgr, HierarchyManager hierarchyManager,
-                     WorkspaceManager wspManager, Node node)
+    public QueryImpl(Session session, ManagerProvider mgrProvider,
+                     ItemManager itemMgr, WorkspaceManager wspManager,
+                     Node node)
-        this.resolver = resolver;
+        this.mgrProvider = mgrProvider;
-        this.hierarchyManager = hierarchyManager;
+        NamePathResolver resolver = mgrProvider.getNamePathResolver();
-        return new QueryResultImpl(itemManager, hierarchyManager,
-                qI, resolver, session.getValueFactory());
+        return new QueryResultImpl(itemManager, mgrProvider, qI);
+        NamePathResolver resolver = mgrProvider.getNamePathResolver();

MOV23 UPD40 MOV44 MOV44 UPD43 MOV65 UPD42 UPD42 UPD43 UPD42 UPD43 UPD42 INS60 INS60 UPD66 UPD42 UPD66 UPD42 UPD42 INS66 UPD42 MOV43 INS59 MOV43 INS59 UPD42 UPD42 INS42 INS32 UPD42 INS42 INS32 UPD42 UPD42 INS42 INS42 INS42 INS42 DEL66 DEL65 DEL29 DEL83 DEL83 DEL42 DEL43 DEL42 DEL59 DEL23 DEL42 DEL65 DEL42 DEL44 DEL52 DEL42 DEL22 DEL42 DEL7 DEL21 DEL42 DEL65 DEL42 DEL44 DEL52 DEL42 DEL22 DEL42 DEL7 DEL21 DEL42 DEL42 DEL42 DEL32