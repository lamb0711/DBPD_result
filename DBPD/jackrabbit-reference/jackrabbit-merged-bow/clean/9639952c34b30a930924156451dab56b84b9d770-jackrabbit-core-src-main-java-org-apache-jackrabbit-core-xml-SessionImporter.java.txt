JCR-2863: Session#importXML can't handle properly uuid collision if user has insufficient permission 						


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1064213 13f79535-47bb-0310-9956-ffa450edef68

-                                           NodeImpl conflicting,
+                                           NodeId conflictingId,
+
+        NodeImpl conflicting;
+        try {
+            conflicting = session.getNodeById(conflictingId);
+        } catch (ItemNotFoundException infe) {
+            // conflicting node can't be read,
+            // most likely due to lack of read permission
+            conflicting = null;
+        }
+
-            if (conflicting.isNodeType(NameConstants.MIX_SHAREABLE)) {
+            if (conflicting != null
+                    && conflicting.isNodeType(NameConstants.MIX_SHAREABLE)) {
+            if (conflicting == null) {
+                // since the conflicting node can't be read,
+                // we can't remove it
+                String msg = "node with uuid " + conflictingId + " cannot be removed";
+                log.debug(msg);
+                throw new RepositoryException(msg);
+            }
+
+            if (conflicting == null) {
+                // since the conflicting node can't be read,
+                // we can't replace it
+                String msg = "node with uuid " + conflictingId + " cannot be replaced";
+                log.debug(msg);
+                throw new RepositoryException(msg);
+            }
+
-                NodeImpl conflicting;
+                boolean isConflicting;
-                    conflicting = session.getNodeById(id);
+                    // the following is a fail-fast test whether
+                    // an item exists (regardless of access control)
+                    session.getHierarchyManager().getName(id);
+                    isConflicting = true;
-                    conflicting = null;
+                    isConflicting = false;
-                if (conflicting != null) {
+
+                if (isConflicting) {
-                    node = resolveUUIDConflict(parent, conflicting, nodeInfo);
+                    node = resolveUUIDConflict(parent, id, nodeInfo);

UPD43 UPD42 INS60 INS54 UPD42 MOV43 INS59 INS8 INS12 INS42 INS21 INS44 INS8 INS7 INS43 INS42 INS21 INS42 INS32 INS42 INS7 INS27 INS25 INS42 INS42 INS42 INS42 MOV33 MOV27 MOV32 INS27 INS8 INS25 INS39 INS42 INS42 INS33 INS60 INS21 INS53 INS27 INS8 UPD42 INS21 INS43 INS59 INS32 INS14 INS42 INS33 INS60 INS21 INS53 INS32 INS7 INS42 INS42 INS27 INS42 INS42 INS42 INS43 INS42 INS43 INS59 INS32 INS14 INS32 UPD42 MOV42 MOV42 INS42 INS9 INS45 INS42 INS45 INS42 INS42 INS42 INS27 INS42 INS42 INS42 INS43 INS42 MOV42 INS42 UPD42 INS9 UPD42 INS45 INS42 INS45 INS42 DEL42 DEL32 DEL7