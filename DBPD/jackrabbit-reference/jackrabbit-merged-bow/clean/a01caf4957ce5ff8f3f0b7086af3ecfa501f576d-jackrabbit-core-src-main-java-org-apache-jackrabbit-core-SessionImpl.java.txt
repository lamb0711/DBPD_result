JCR-1753: Allow means force a Repository to synchronize with the cluster

Synchronize with the cluster whenever Session.refresh(boolean) is called, unless the "org.apache.jackrabbit.disableClusterSyncOnRefresh" attribute is set.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@792211 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.cluster.ClusterException;
+import org.apache.jackrabbit.core.cluster.ClusterNode;
+    /**
+     * Name of the session attribute that controls whether the
+     * {@link #refresh(boolean)} method will cause the repository to
+     * synchronize itself to changes in other cluster nodes. This cluster
+     * synchronization is enabled by default, unless an attribute with this
+     * name is set (any non-null value) for this session.
+     *
+     * @since Apache Jackrabbit 1.6
+     * @see <a href="https://issues.apache.org/jira/browse/JCR-1753">JCR-1753</a>
+     */
+    public static final String DISABLE_CLUSTER_SYNC_ON_REFRESH =
+        "org.apache.jackrabbit.disableClusterSyncOnRefresh";
+
+        // JCR-1753: Ensure that we are up to date with cluster changes
+        ClusterNode cluster = rep.getClusterNode();
+        if (cluster != null && clusterSyncOnRefresh()) {
+            try {
+                cluster.sync();
+            } catch (ClusterException e) {
+                throw new RepositoryException(
+                        "Unable to synchronize with the cluster", e);
+            }
+        }
+
+     * Checks whether the {@link #refresh(boolean)} method should cause
+     * cluster synchronization.
+     * <p>
+     * Subclasses can override this method to implement alternative
+     * rules on when cluster synchronization should be done.
+     *
+     * @return <code>true</code> if the {@link #DISABLE_CLUSTER_SYNC_ON_REFRESH}
+     *         attribute is <em>not</em> set, <code>false</code> otherwise
+     * @since Apache Jackrabbit 1.6
+     * @see <a href="https://issues.apache.org/jira/browse/JCR-1753">JCR-1753</a>
+     */
+    protected boolean clusterSyncOnRefresh() {
+        return getAttribute(DISABLE_CLUSTER_SYNC_ON_REFRESH) == null;
+    }
+
+    /**

INS26 INS26 INS40 INS40 INS23 INS31 INS29 INS83 INS83 INS83 INS43 INS59 INS29 INS83 INS39 INS42 INS8 INS65 INS65 INS65 INS42 INS42 INS45 INS60 INS25 INS65 INS65 INS65 INS65 INS41 INS66 INS65 INS66 INS66 INS66 INS66 INS66 INS66 INS43 INS59 INS27 INS8 INS66 INS65 INS66 INS66 INS66 INS66 INS66 INS66 INS65 INS66 INS66 INS66 INS27 INS68 INS42 INS42 INS32 INS27 INS32 INS54 INS68 INS67 INS32 INS33 INS42 INS69 INS42 INS42 INS42 INS33 INS42 INS8 INS12 INS42 INS69 INS42 INS42 INS42 INS39 INS21 INS44 INS8 INS39 INS32 INS43 INS42 INS53 INS42 INS42 INS42 INS14 INS43 INS45 INS42 INS42