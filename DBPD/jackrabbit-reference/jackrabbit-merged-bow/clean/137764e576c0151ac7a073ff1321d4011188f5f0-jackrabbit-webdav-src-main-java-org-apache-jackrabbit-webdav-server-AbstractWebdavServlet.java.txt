JCR-4586: jackrabbit-webdav: must ignore if-modified-since with broken date (multiple field lines)

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1879031 13f79535-47bb-0310-9956-ffa450edef68

-            modSince = request.getDateHeader("If-Modified-Since");
+            // will throw if multiple field lines present
+            String value = getSingletonField(request, "If-Modified-Since");
+            if (value != null) {
+                modSince = request.getDateHeader("If-Modified-Since");
+            }
-            log.trace("illegal value for if-modified-since ignored: " + request.getHeader("If-Modified-Since"));
+            log.debug("illegal value for if-modified-since ignored: " + ex.getMessage());
+
+    /**
+     * Get field value of a singleton field
+     * @param request HTTP request
+     * @param fieldName field name
+     * @return the field value (when there is indeed a single field line) or {@code null} when field not present
+     * @throws IllegalArgumentException when multiple field lines present
+     */
+    private static String getSingletonField(HttpServletRequest request, String fieldName) {
+        @SuppressWarnings("unchecked")
+        Enumeration<String> lines = request.getHeaders(fieldName);
+        if (!lines.hasMoreElements()) {
+            return null;
+        } else {
+            String value = lines.nextElement();
+            if (!lines.hasMoreElements()) {
+                return value;
+            } else {
+                List<String> v = new ArrayList<>();
+                v.add(value);
+                while (lines.hasMoreElements()) {
+                    v.add(lines.nextElement());
+                }
+                throw new IllegalArgumentException("Multiple field lines for '" + fieldName + "' header field: " + v);
+            }
+        }
+    }
+

INS31 INS29 INS83 INS83 INS43 INS42 INS44 INS44 INS8 INS65 INS65 INS65 INS65 INS65 INS42 INS43 INS42 INS43 INS42 INS60 INS25 INS8 INS66 INS42 INS66 INS42 INS66 INS66 INS65 INS66 INS42 INS66 INS42 INS42 INS79 INS74 INS59 INS38 INS8 INS8 INS60 INS25 INS66 INS42 INS45 INS43 INS43 INS42 INS32 INS32 INS41 INS60 INS25 INS43 INS59 INS27 MOV8 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS33 INS43 INS59 INS38 INS8 INS8 INS42 INS42 INS32 INS42 INS33 INS42 INS42 INS32 INS32 INS41 INS60 INS21 INS61 INS53 INS42 INS42 INS45 UPD42 INS42 INS42 INS42 INS42 INS42 INS74 INS59 INS32 INS32 INS8 INS14 INS43 INS43 INS42 INS14 INS42 INS42 INS42 INS42 INS42 INS21 INS43 INS27 UPD42 UPD42 INS42 INS42 INS74 INS32 INS42 INS45 INS42 INS45 INS42 INS43 INS42 INS42 INS32 INS42 INS42 INS42 DEL45