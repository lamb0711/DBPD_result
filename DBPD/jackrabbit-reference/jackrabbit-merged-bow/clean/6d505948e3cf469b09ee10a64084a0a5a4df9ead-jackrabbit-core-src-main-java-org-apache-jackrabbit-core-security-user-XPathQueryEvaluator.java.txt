JCR-2844: MaxCount not working correctly in user/group query when restricting to group members

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1049473 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.spi.commons.iterator.BoundedIterator;
-        if (maxCount > 0) {
-            query.setLimit(maxCount);
-        }
-
-        // If we are scoped to a group and have an offset, we need to skip to that offset
-        // here (inefficient!) otherwise we can apply the offset in the query
+        // If we are scoped to a group and have a limit, we have to apply the limit
+        // here (inefficient!) otherwise we can apply the limit in the query
+            if (maxCount > 0) {
+                query.setLimit(maxCount);
+            }
-            Iterator<Authorizable> result = filter(toAuthorizables(execute(query)), builder.getGroupName(), builder.isDeclaredMembersOnly());
-            for (int c = 0; c < offset && result.hasNext(); c++) {
-                result.next();
-            }
-            return result;
+            Iterator<Authorizable> result = toAuthorizables(execute(query));
+            Iterator<Authorizable> filtered = filter(result, builder.getGroupName(), builder.isDeclaredMembersOnly());
+            return BoundedIterator.create(offset, maxCount, filtered);

INS26 INS40 MOV25 INS60 INS41 INS74 INS59 INS32 INS43 INS43 INS42 MOV32 UPD42 UPD42 MOV42 INS42 UPD42 MOV42 UPD42 MOV42 INS42 INS42 INS42 INS42 DEL39 DEL42 DEL34 DEL59 DEL58 DEL42 DEL42 DEL27 DEL42 DEL32 DEL27 DEL42 DEL37 DEL32 DEL21 DEL8 DEL24 DEL42 DEL41