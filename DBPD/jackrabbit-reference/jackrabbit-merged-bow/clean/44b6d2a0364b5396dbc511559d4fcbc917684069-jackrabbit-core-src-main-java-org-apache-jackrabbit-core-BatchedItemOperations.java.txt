JCR-1775: Transaction-safe versioning

Avoid instantiating full VersionHistoryImpl objects when all we need are the identifiers of the version history and root version nodes.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@702453 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.version.VersionHistoryInfo;
-import javax.jcr.version.VersionHistory;
-                        VersionHistory vh =
+                        VersionHistoryInfo history =
-                        newChildState.setValues(new InternalValue[]{InternalValue.create(new UUID(vh.getUUID()))});
-                    } else if (propName.equals(NameConstants.JCR_BASEVERSION)) {
-                        // jcr:baseVersion
-                        VersionHistory vh =
+                        InternalValue value = InternalValue.create(
+                                history.getVersionHistoryId().getUUID());
+                        newChildState.setValues(new InternalValue[] { value });
+                    } else if (propName.equals(NameConstants.JCR_BASEVERSION)
+                            || propName.equals(NameConstants.JCR_PREDECESSORS)) {
+                        // jcr:baseVersion or jcr:predecessors
+                        VersionHistoryInfo history =
-                        newChildState.setValues(new InternalValue[]{InternalValue.create(new UUID(vh.getRootVersion().getUUID()))});
-                    } else if (propName.equals(NameConstants.JCR_PREDECESSORS)) {
-                        // jcr:predecessors
-                        VersionHistory vh =
-                            manager.getVersionHistory(session, newState);
-                        newChildState.setValues(new InternalValue[]{InternalValue.create(new UUID(vh.getRootVersion().getUUID()))});
+                        InternalValue value = InternalValue.create(
+                                history.getRootVersionId().getUUID());
+                        newChildState.setValues(new InternalValue[] { value });

MOV26 UPD40 MOV8 MOV60 MOV60 MOV25 MOV60 MOV60 MOV60 MOV60 MOV25 MOV60 MOV25 MOV21 MOV21 MOV27 MOV60 MOV25 MOV32 MOV60 INS60 INS21 INS27 UPD43 INS43 INS59 INS32 MOV32 MOV32 MOV60 UPD42 UPD42 MOV42 INS42 INS32 INS42 INS42 INS3 UPD43 UPD43 MOV42 MOV42 INS32 MOV5 INS4 UPD42 UPD42 UPD42 UPD42 MOV32 MOV42 INS42 UPD42 INS42 INS32 UPD42 UPD42 INS32 UPD42 MOV42 INS42 UPD42 MOV42 UPD42 MOV42 DEL42 DEL42 DEL43 DEL85 DEL5 DEL42 DEL43 DEL32 DEL14 DEL32 DEL4 DEL3 DEL32 DEL21 DEL42 DEL42 DEL42 DEL43 DEL42 DEL42 DEL32 DEL42 DEL32 DEL14 DEL32 DEL42 DEL42 DEL42 DEL42 DEL42 DEL43 DEL42 DEL42 DEL32 DEL14 DEL32 DEL4 DEL3 DEL32 DEL21 DEL25 DEL8