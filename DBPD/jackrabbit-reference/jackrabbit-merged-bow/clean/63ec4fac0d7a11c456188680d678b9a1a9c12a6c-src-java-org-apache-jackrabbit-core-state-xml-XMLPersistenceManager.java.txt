redesigned transaction support & PersistenceManager

orginal code contributed by dominique pfister, required a lot of tweaking to make it run & work; not thoroughly tested

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@126221 13f79535-47bb-0310-9956-ffa450edef68

-public class XMLPersistenceManager implements PersistenceManager {
+public class XMLPersistenceManager extends AbstractPersistenceManager {
-    private void readState(Element nodeElement, PersistentNodeState state)
+    private void readState(Element nodeElement, NodeState state)
-    private void readState(Element propElement, PersistentPropertyState state)
+    private void readState(Element propElement, PropertyState state)
+
+
-     * @see PersistenceManager#load(PersistentNodeState)
+     * @see PersistenceManager#load
-    public synchronized void load(PersistentNodeState state)
+    public synchronized NodeState load(String uuid)
-        String uuid = state.getUUID();
-                state.setNodeTypeName(QName.valueOf(ntName));
+                NodeState state = createNew(uuid, null, null);
+                state.setNodeTypeName(QName.valueOf(ntName));
-                return;
+                return state;
-     * @see PersistenceManager#load(PersistentPropertyState)
+     * @see PersistenceManager#load
-    public synchronized void load(PersistentPropertyState state)
+    public synchronized PropertyState load(QName name, String parentUUID)
-        String parentUUID = state.getParentUUID();
-        QName propName = state.getName();
-        String propFilePath = buildPropFilePath(parentUUID, propName);
+        String propFilePath = buildPropFilePath(parentUUID, name);
-                throw new NoSuchItemStateException(parentUUID + "/" + propName);
+                throw new NoSuchItemStateException(parentUUID + "/" + name);
+                PropertyState state = createNew(name, parentUUID);
-                return;
+                return state;
-        String msg = "failed to read property state: " + parentUUID + "/" + propName;
+        String msg = "failed to read property state: " + parentUUID + "/" + name;
-     * @see PersistenceManager#store
+     * @see AbstractPersistenceManager#store
-    public synchronized void store(PersistentNodeState state) throws ItemStateException {
+    protected void store(NodeState state) throws ItemStateException {
-     * @see PersistenceManager#store
+     * @see AbstractPersistenceManager#store
-    public synchronized void store(PersistentPropertyState state) throws ItemStateException {
+    protected void store(PropertyState state) throws ItemStateException {
-     * @see PersistenceManager#destroy
+     * @see AbstractPersistenceManager#destroy
-    public synchronized void destroy(PersistentNodeState state) throws ItemStateException {
+    protected void destroy(NodeState state) throws ItemStateException {
-     * @see PersistenceManager#destroy
+     * @see AbstractPersistenceManager#destroy
-    public synchronized void destroy(PersistentPropertyState state) throws ItemStateException {
+    protected void destroy(PropertyState state) throws ItemStateException {
-     * @see PersistenceManager#load(NodeReferences)
+     * @see PersistenceManager#load
-    public synchronized void load(NodeReferences refs)
+    public synchronized NodeReferences load(NodeId targetId)
-        String uuid = refs.getTargetId().getUUID();
+        String uuid = targetId.getUUID();
-            refs.clearAllReferences();
+                NodeReferences refs = new NodeReferences(targetId);
-                return;
+                return refs;
-     * @see PersistenceManager#store(NodeReferences)
+     * @see AbstractPersistenceManager#store
-    public synchronized void store(NodeReferences refs) throws ItemStateException {
+    protected void store(NodeReferences refs) throws ItemStateException {
-     * @see PersistenceManager#destroy(NodeReferences)
+     * @see AbstractPersistenceManager#destroy
-    public synchronized void destroy(NodeReferences refs) throws ItemStateException {
+    protected void destroy(NodeReferences refs) throws ItemStateException {

UPD43 UPD42 INS43 INS42 INS44 INS43 INS42 INS44 INS44 UPD83 UPD83 UPD83 UPD83 MOV43 UPD83 UPD83 UPD43 UPD43 UPD42 MOV42 MOV43 INS42 UPD42 MOV42 MOV43 UPD42 MOV42 MOV43 INS42 UPD43 UPD43 UPD43 UPD43 UPD43 UPD42 UPD42 UPD42 INS67 INS67 MOV43 UPD42 UPD42 UPD42 UPD42 INS67 UPD42 INS67 INS67 INS42 INS42 INS42 INS42 UPD42 UPD42 UPD42 UPD42 INS42 INS42 INS42 INS42 INS42 INS42 UPD42 UPD42 UPD42 MOV42 INS60 INS60 INS60 INS43 INS59 INS42 INS43 INS59 INS42 MOV43 INS59 INS42 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS14 INS42 INS42 INS33 INS33 UPD42 INS42 INS42 INS42 MOV43 INS42 DEL42 DEL42 DEL42 DEL43 DEL69 DEL68 DEL39 DEL42 DEL43 DEL42 DEL44 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL42 DEL43 DEL69 DEL68 DEL39 DEL42 DEL43 DEL44 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL83 DEL83 DEL83 DEL83 DEL42 DEL42 DEL69 DEL68 DEL39 DEL42 DEL32 DEL42 DEL42 DEL32 DEL21 DEL42 DEL42 DEL69 DEL68 DEL83 DEL42 DEL42 DEL69 DEL68 DEL83