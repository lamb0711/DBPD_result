JCR-1775: Transaction-safe versioning

Avoid instantiating full VersionHistoryImpl objects when all we need are the identifiers of the version history and root version nodes.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@702453 13f79535-47bb-0310-9956-ffa450edef68

-    protected NodeId createVersionHistory(Session session, final NodeState node)
-            throws RepositoryException {
-        InternalVersionHistory history = (InternalVersionHistory)
+    protected VersionHistoryInfo createVersionHistory(
+            Session session, final NodeState node) throws RepositoryException {
+        NodeStateEx state = (NodeStateEx)
-        if (history == null) {
+        if (state == null) {
-        return history.getId();
+        Name root = NameConstants.JCR_ROOTVERSION;
+        return new VersionHistoryInfo(
+                state.getNodeId(),
+                state.getState().getChildNodeEntry(root, 1).getId());

UPD43 UPD42 INS60 UPD43 INS43 INS59 INS14 UPD42 UPD42 UPD42 INS42 INS42 INS40 INS43 INS32 INS32 UPD43 INS42 INS42 INS42 INS32 MOV42 UPD42 INS32 UPD42 MOV42 INS42 INS34 INS42 INS42 DEL32