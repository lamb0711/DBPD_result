JCR-1658: Executing query throws UnsupportedRepositoryOperationException(LEVEL_2_SUPPORTED) for a level 1 only implementation

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@674491 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.jcr2spi.hierarchy.HierarchyManager;
+import org.apache.jackrabbit.jcr2spi.ManagerProvider;
-import org.slf4j.LoggerFactory;
-import org.slf4j.Logger;
-import javax.jcr.ValueFactory;
-     * The logger instance for this class
-     */
-    private static final Logger log = LoggerFactory.getLogger(QueryResultImpl.class);
-
-    /**
-     * The HierarchyManager of the session executing the query
+     * Provides various managers.
-    private final HierarchyManager hierarchyMgr;
+    private final ManagerProvider mgrProvider;
-     * The namespace nameResolver of the session executing the query
-     */
-    private final NamePathResolver resolver;
-
-    /**
-     * The JCR value factory.
-     */
-    private final ValueFactory valueFactory;
-
-    /**
-     * @param itemMgr      the item manager of the session executing the query.
-     * @param hierarchyMgr the HierarchyManager of the session executing the
-     *                     query.
-     * @param queryInfo    the spi query result.
-     * @param resolver
-     * @param valueFactory the JCR value factory.
+     * @param itemMgr     the item manager of the session executing the query.
+     * @param mgrProvider the manager provider.
+     * @param queryInfo   the spi query result.
-    QueryResultImpl(ItemManager itemMgr, HierarchyManager hierarchyMgr,
-                    QueryInfo queryInfo, NamePathResolver resolver,
-                    ValueFactory valueFactory) {
+    QueryResultImpl(ItemManager itemMgr,
+                    ManagerProvider mgrProvider,
+                    QueryInfo queryInfo) {
-        this.hierarchyMgr = hierarchyMgr;
+        this.mgrProvider = mgrProvider;
-        this.resolver = resolver;
-        this.valueFactory = valueFactory;
+        NamePathResolver resolver = mgrProvider.getNamePathResolver();
-        return new RowIteratorImpl(queryInfo, resolver, valueFactory);
+        return new RowIteratorImpl(queryInfo, mgrProvider.getNamePathResolver(),
+                mgrProvider.getJcrValueFactory());
-        return new NodeIteratorImpl(itemMgr, hierarchyMgr, queryInfo);
+        return new NodeIteratorImpl(itemMgr,
+                mgrProvider.getHierarchyManager(), queryInfo);

UPD40 UPD43 MOV21 UPD42 UPD42 UPD43 UPD42 INS60 UPD66 UPD66 UPD42 UPD66 UPD66 UPD42 MOV43 INS59 UPD42 INS42 INS32 INS32 INS32 INS32 UPD42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL66 DEL65 DEL29 DEL83 DEL83 DEL83 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL43 DEL57 DEL32 DEL59 DEL23 DEL66 DEL65 DEL29 DEL83 DEL83 DEL42 DEL43 DEL42 DEL59 DEL23 DEL66 DEL65 DEL29 DEL83 DEL83 DEL42 DEL43 DEL42 DEL59 DEL23 DEL66 DEL42 DEL65 DEL42 DEL66 DEL65 DEL42 DEL44 DEL42 DEL43 DEL42 DEL44 DEL52 DEL42 DEL22 DEL42 DEL7 DEL21 DEL52 DEL42 DEL22 DEL42 DEL7 DEL21 DEL42 DEL42 DEL42