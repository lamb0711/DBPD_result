JCR-1715: Prevent excessive Path.Element instances

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@691606 13f79535-47bb-0310-9956-ffa450edef68

+    private final HashCache ELEMENT_CACHE = new HashCache();
+
-            return new Element(name, Path.INDEX_UNDEFINED);
+            return getCachedElement(new Element(name, Path.INDEX_UNDEFINED));
-            return new Element(name, Path.INDEX_UNDEFINED);
+            return getCachedElement(new Element(name, Path.INDEX_UNDEFINED));
+
+    /**
+     * If a cached copy of the given element already exists, then returns
+     * that copy. Otherwise the given element is cached and returned. This
+     * method only works correctly with elements that have an undefined index!
+     *
+     * @param element the element to return from the cache
+     * @return the given element or a previously cached copy
+     */
+    private Element getCachedElement(Element element) {
+        assert element.getIndex() == Path.INDEX_UNDEFINED;
+        return (Element) ELEMENT_CACHE.get(element);
+    }
+

INS23 INS31 INS83 INS83 INS43 INS59 INS29 INS83 INS43 INS42 INS44 INS8 INS42 INS42 INS14 INS65 INS65 INS65 INS42 INS43 INS42 INS6 INS41 INS43 INS66 INS66 INS66 INS42 INS66 INS66 INS42 INS27 INS11 INS42 INS32 INS40 INS43 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 MOV14 INS32 INS42 MOV14