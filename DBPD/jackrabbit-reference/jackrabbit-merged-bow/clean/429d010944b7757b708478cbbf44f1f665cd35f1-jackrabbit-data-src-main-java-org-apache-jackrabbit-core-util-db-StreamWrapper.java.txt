JCR-3811 detect marking of input stream to determine if stream can be reset to the beginning

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1625981 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.FilterInputStream;
-    private InputStream stream;
+    private MarkDetectingInputStream stream;
-        this.stream = in;
+        this.stream = new MarkDetectingInputStream(in);
-     * during reading so that resetting it moves the cursor to the beginning of the stream.
+     * during reading.
-            stream.reset();
-            return true;
+            if (!stream.isMarked()) {
+                stream.reset();
+                return true;
+            } else {
+                log.warn("Cannot reset stream to the beginning because it was marked.");
+                return false;
+            }
+
+    private static class MarkDetectingInputStream extends FilterInputStream {
+
+        private boolean marked;
+
+        protected MarkDetectingInputStream(final InputStream in) {
+            super(in);
+        }
+
+        @Override
+        public synchronized void mark(final int readlimit) {
+            super.mark(readlimit);
+            marked = true;
+        }
+
+        private boolean isMarked() {
+            return marked;
+        }
+    }

INS26 INS40 INS55 INS43 INS83 INS83 INS42 INS43 INS23 INS31 INS31 INS31 INS42 INS42 INS83 INS39 INS59 INS83 INS42 INS44 INS8 INS78 INS83 INS83 INS39 INS42 INS44 INS8 INS83 INS39 INS42 INS8 UPD66 INS8 INS42 INS83 MOV43 INS42 INS46 INS42 INS83 INS39 INS42 INS21 INS21 INS41 INS14 INS25 INS42 INS48 INS7 INS42 INS43 INS42 INS38 MOV8 INS8 INS42 INS42 INS42 INS9 INS42 INS32 INS21 INS41 INS42 INS42 INS32 INS9 INS42 INS42 INS45 DEL42