JCR-2951 - Item.remove fails if a child-item is not visible to the editing session

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1097363 13f79535-47bb-0310-9956-ffa450edef68

+     * @param permissionCheck
-    private ItemImpl getItem(ItemId itemId, Path path) throws ItemNotFoundException, AccessDeniedException, RepositoryException {
+    private ItemImpl getItem(ItemId itemId, Path path, boolean permissionCheck) throws ItemNotFoundException, AccessDeniedException, RepositoryException {
-        boolean permissionCheck = true;
-            ItemImpl item = getItem(id, path);
+            ItemImpl item = getItem(id, path, true);
-                return (NodeImpl) getItem(id, path);
+                return (NodeImpl) getItem(id, path, true);
-            return (PropertyImpl) getItem(id, path);
+            return (PropertyImpl) getItem(id, path, true);
-
+    
-        return getItem(id, null);
+        return getItem(id, null, true);
+    }
+
+    /**
+     * @param id
+     * @return
+     * @throws RepositoryException
+     */
+    synchronized ItemImpl getItem(ItemId id, boolean permissionCheck)
+            throws ItemNotFoundException, AccessDeniedException, RepositoryException {
+        return getItem(id, null, permissionCheck);
+        return getNode(id, parentId, true);
+    }
+
+    /**
+     * Returns a node with a given id and parent id. If the indicated node is
+     * shareable, there might be multiple nodes associated with the same id,
+     * but there'is only one node with the given parent id.
+     *
+     * @param id node id
+     * @param parentId parent node id
+     * @param permissionCheck Flag indicating if read permission must be check
+     * upon retrieving the node.
+     * @return node
+     * @throws RepositoryException if an error occurs
+     */
+    synchronized NodeImpl getNode(NodeId id, NodeId parentId, boolean permissionCheck)
+            throws ItemNotFoundException, AccessDeniedException, RepositoryException {
-            data = (AbstractNodeData) getItemData(id);
+            data = (AbstractNodeData) getItemData(id, null, permissionCheck);

INS31 INS31 INS44 INS29 INS83 INS43 INS42 INS44 INS44 INS43 INS43 INS43 INS8 MOV29 INS83 INS83 INS43 INS42 INS44 INS44 INS43 INS43 INS43 INS8 INS29 INS44 INS65 INS39 INS42 INS65 INS65 INS65 INS42 INS43 INS42 INS39 INS42 INS42 INS42 INS42 INS41 INS42 INS43 INS42 INS43 INS42 INS42 INS42 INS42 INS41 INS65 INS65 INS65 INS65 INS65 INS65 INS39 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS32 INS66 INS66 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS66 INS66 INS42 INS66 INS9 INS42 INS42 INS33 INS42 INS42 INS42 INS42 INS9 INS9 INS9 INS33 INS42 INS9 DEL39 DEL42 DEL9 DEL59 DEL60 DEL83