- JCR-17 Creating and saving a mix:versionable node creates two VersionHistory nodes
- JCR-18 Multithreading issue with versioning


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@76106 13f79535-47bb-0310-9956-ffa450edef68

-            if (itemState.isNode() && itemState.getStatus() == ItemState.STATUS_NEW) {
+            if (itemState.isNode()) {
-                    VersionHistory hist = session.versionMgr.createVersionHistory(node);
-                    node.internalSetProperty(VersionManager.PROPNAME_VERSION_HISTORY, InternalValue.create(new UUID(hist.getUUID())));
-                    node.internalSetProperty(VersionManager.PROPNAME_BASE_VERSION, InternalValue.create(new UUID(hist.getRootVersion().getUUID())));
-                    node.internalSetProperty(VersionManager.PROPNAME_IS_CHECKED_OUT, InternalValue.create(true));
-                    node.internalSetProperty(VersionManager.PROPNAME_PREDECESSORS, new InternalValue[]{InternalValue.create(new UUID(hist.getRootVersion().getUUID()))});
-                    createdTransientState = true;
+                    if (!node.hasProperty(VersionManager.PROPNAME_VERSION_HISTORY)) {
+                        VersionHistory hist = session.versionMgr.createVersionHistory(node);
+                        node.internalSetProperty(VersionManager.PROPNAME_VERSION_HISTORY, InternalValue.create(new UUID(hist.getUUID())));
+                        node.internalSetProperty(VersionManager.PROPNAME_BASE_VERSION, InternalValue.create(new UUID(hist.getRootVersion().getUUID())));
+                        node.internalSetProperty(VersionManager.PROPNAME_IS_CHECKED_OUT, InternalValue.create(true));
+                        node.internalSetProperty(VersionManager.PROPNAME_PREDECESSORS, new InternalValue[]{InternalValue.create(new UUID(hist.getRootVersion().getUUID()))});
+                        createdTransientState = true;
+                    }

MOV32 INS8 INS25 INS38 MOV8 INS32 INS42 INS42 INS40 DEL42 DEL42 DEL32 DEL40 DEL27 DEL27