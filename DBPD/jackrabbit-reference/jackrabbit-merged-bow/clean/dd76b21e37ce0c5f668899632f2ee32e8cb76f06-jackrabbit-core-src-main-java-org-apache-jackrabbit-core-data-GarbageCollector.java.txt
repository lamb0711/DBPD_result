JCR-1469 Data store garbage collection: ScanEventListener not working

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@636774 13f79535-47bb-0310-9956-ffa450edef68

+    private boolean persistenceManagerScan;
+
+        this.persistenceManagerScan = list != null;
-        if (pmList == null) {
+        if (pmList == null || !persistenceManagerScan) {
+    /**
+     * Enable or disable using the IterablePersistenceManager interface
+     * to scan the items. This is important for clients that need
+     * the complete Node implementation in the ScanEventListener
+     * callback.
+     *
+     * @param allow true if using the IterablePersistenceManager interface is allowed
+     */
+    public void setPersistenceManagerScan(boolean allow) {
+        persistenceManagerScan = allow;
+    }
+
+    /**
+     * Check if using the IterablePersistenceManager interface is allowed.
+     *
+     * @return true if using IterablePersistenceManager is possible.
+     */
+    public boolean getPersistenceManagerScan() {
+        return persistenceManagerScan;
+    }
+
+                if (callback != null) {
+                    callback.beforeScanning(null);
+                }
+                if (callback != null) {
+                    callback.afterScanning(null);
+                }

INS23 INS31 INS31 INS83 INS39 INS59 INS29 INS83 INS39 INS42 INS44 INS8 INS29 INS83 INS39 INS42 INS8 INS42 INS21 INS65 INS65 INS39 INS42 INS21 INS65 INS65 INS41 INS7 INS27 INS66 INS66 INS66 INS66 INS42 INS66 INS7 INS66 INS66 INS42 INS22 INS27 MOV27 INS38 INS42 INS42 INS52 INS42 INS42 INS33 INS42 INS25 INS25 INS27 INS8 INS27 INS8 INS42 INS33 INS21 INS42 INS33 INS21 INS32 INS32 INS42 INS42 INS33 INS42 INS42 INS33