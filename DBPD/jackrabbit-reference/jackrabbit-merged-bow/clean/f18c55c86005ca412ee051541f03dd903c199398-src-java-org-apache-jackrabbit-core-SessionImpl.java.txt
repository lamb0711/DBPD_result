fixed JCR-42: Workspace.move() and Session.move() allow moves to an invalid path
minor other changes

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@153279 13f79535-47bb-0310-9956-ffa450edef68

-    protected SessionItemStateManager createSessionItemStateManager(
-            UpdatableItemStateManager manager) {
+    protected SessionItemStateManager createSessionItemStateManager(UpdatableItemStateManager manager) {
-            VersionException, RepositoryException {
+            VersionException, LockException, RepositoryException {
+            if (srcPath.isAncestorOf(destPath)) {
+                String msg = destAbsPath + ": invalid destination path (cannot be descendant of source path)";
+                log.debug(msg);
+                throw new RepositoryException(msg);
+            }
+        // verify that both source and destination parent nodes are checked-out
+        if (!srcParentNode.internalIsCheckedOut()) {
+            String msg = srcAbsPath + ": cannot move a child of a checked-in node";
+            log.debug(msg);
+            throw new VersionException(msg);
+        }
+        if (!destParentNode.internalIsCheckedOut()) {
+            String msg = destAbsPath + ": cannot move a target to a checked-in node";
+            log.debug(msg);
+            throw new VersionException(msg);
+        }
+
-            String msg = parentAbsPath + ": node expected";
-            log.debug(msg);
-            throw new RepositoryException(msg);
+            throw new PathNotFoundException(parentAbsPath);

INS43 INS42 INS25 INS25 INS38 INS8 INS38 INS8 INS25 INS32 INS60 INS21 INS53 INS32 INS60 INS21 INS53 INS32 INS8 INS42 INS42 INS43 INS59 INS32 INS14 INS42 INS42 MOV43 INS59 INS32 INS14 INS42 INS42 INS42 INS60 MOV21 INS53 INS42 INS42 INS27 INS42 INS42 INS42 INS43 INS42 INS42 INS27 INS42 INS42 INS42 INS43 INS42 UPD43 UPD42 INS43 INS59 INS14 INS42 INS45 INS42 INS42 INS45 INS42 UPD42 INS42 INS42 INS27 INS43 INS42 INS42 INS45 INS42 DEL42 DEL42 DEL45 DEL27 DEL59 DEL60