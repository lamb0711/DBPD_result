JCR-2546: SISM blocks the item state cache when loading a new item

Synchronize only when a cache miss occurs.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@929506 13f79535-47bb-0310-9956-ffa450edef68

-     * item state providers. This method is synchronized to ensure that
-     * a cache entry is not created twice.
+     * item state providers.
-    private synchronized ItemState getNonVirtualItemState(ItemId id)
+    private ItemState getNonVirtualItemState(ItemId id)
-            // not found in cache, load from persistent storage
-            state = loadItemState(id);
-            state.setStatus(ItemState.STATUS_EXISTING);
-            // put it in cache
-            cache.cache(state);
-            // set parent container
-            state.setContainer(this);
+            synchronized (this) {
+                // Use a double check to ensure that the cache entry is
+                // not created twice. We don't synchronize the entire
+                // method to allow the first cache retrieval to proceed
+                // even when another thread is loading a new item state.
+                state = cache.retrieve(id);
+                if (state == null) {
+                    // not found in cache, load from persistent storage
+                    state = loadItemState(id);
+                    state.setStatus(ItemState.STATUS_EXISTING);
+                    // put it in cache
+                    cache.cache(state);
+                    // set parent container
+                    state.setContainer(this);
+                }
+            }

INS25 UPD66 INS27 INS8 INS42 INS33 INS51 INS52 INS8 INS21 MOV25 INS7 INS42 INS32 INS42 INS42 INS42 DEL66 DEL83