HCR-389: WebDAV server should treat non-wellformed XML in request bodies as error.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@392905 13f79535-47bb-0310-9956-ffa450edef68

+
+import java.io.BufferedInputStream;
-     * @return Xml document
-    public Document getRequestDocument() {
+    public Document getRequestDocument() throws DavException {
-        Don't attempt to parse the body if the contentlength header is 0
-        NOTE: a value of -1 indicates that the length is unknown, thus we have to parse the body.
-        NOTE that http1.1 request using chunked transfer coding will therefore not be detected here
+        Don't attempt to parse the body if the contentlength header is 0.
+        NOTE: a value of -1 indicates that the length is unknown, thus we have
+        to parse the body. Note that http1.1 request using chunked transfer
+        coding will therefore not be detected here.
-                DocumentBuilder docBuilder = BUILDER_FACTORY.newDocumentBuilder();
-                requestDocument = docBuilder.parse(in);
+                // use a buffered input stream to find out whether there actually
+                // is a request body
+                InputStream bin = new BufferedInputStream(in);
+                bin.mark(1);
+                boolean isEmpty = -1 == bin.read();
+                bin.reset();
+                if (!isEmpty) {
+                    DocumentBuilder docBuilder = BUILDER_FACTORY.newDocumentBuilder();
+                    requestDocument = docBuilder.parse(bin);
+                }
+            throw new DavException(DavServletResponse.SC_BAD_REQUEST);
+            throw new DavException(DavServletResponse.SC_INTERNAL_SERVER_ERROR);
-            log.debug("Unable to build an XML Document from the request body: " + e.getMessage());
+            if (log.isDebugEnabled()) {
+                log.debug("Unable to build an XML Document from the request body: " + e.getMessage());
+            }
+            throw new DavException(DavServletResponse.SC_BAD_REQUEST);
-        // propfind httpRequest with empty body or invalid Xml >> retrieve all property
-        // TODO: invalid XML -> spec requires a 'BAD REQUEST' error code
+        // propfind httpRequest with empty body >> retrieve all property
-}
+}

INS26 INS40 INS43 INS42 MOV12 INS25 MOV44 MOV44 INS8 MOV27 INS8 INS53 INS53 INS25 INS53 INS60 INS21 INS60 INS21 MOV25 INS14 INS14 INS32 INS8 INS14 INS43 INS59 INS32 INS39 INS59 INS32 INS38 INS43 INS40 INS43 INS40 INS42 INS42 MOV21 INS43 INS40 INS42 INS42 INS14 INS42 INS42 INS34 INS42 INS27 INS42 INS42 INS42 INS42 INS42 INS42 INS43 INS42 INS38 INS32 INS42 INS34 INS42 INS42 UPD42 DEL66 DEL65 DEL8