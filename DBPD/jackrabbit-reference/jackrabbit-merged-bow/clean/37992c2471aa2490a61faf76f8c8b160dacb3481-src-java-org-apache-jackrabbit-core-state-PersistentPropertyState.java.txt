first implementation of jta support

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@55234 13f79535-47bb-0310-9956-ffa450edef68

-public abstract class PersistentPropertyState extends PropertyState implements PersistableItemState {
+public class PersistentPropertyState extends PropertyState implements PersistableItemState {
-     * Package private constructor
+     * Public constructor
-    protected PersistentPropertyState(QName name, String parentUUID, PersistenceManager persistMgr) {
+    public PersistentPropertyState(QName name, String parentUUID, PersistenceManager persistMgr) {
+    /**
+     * Constructor used for overlay mechanism.
+     *
+     * @param overlayedState other node state to overlay
+     * @param initialStatus  initial status
+     * @param persistMgr     persistence manager
+     */
+    protected PersistentPropertyState(PersistentPropertyState overlayedState,
+                                      int initialStatus,
+                                      PersistenceManager persistMgr) {
+
+        super(overlayedState, initialStatus);
+
+        this.persistMgr = persistMgr;
+    }
+
+
-    public abstract void reload() throws ItemStateException;
+    public synchronized void reload() throws ItemStateException {
+        status = STATUS_UNDEFINED;
+        getPersistenceManager().load(this);
+        // reset status
+        status = STATUS_EXISTING;
+    }
-    public abstract void store() throws ItemStateException;
+    public synchronized void store() throws ItemStateException {
+        getPersistenceManager().store(this);
+        // notify listeners
+        if (status == STATUS_NEW) {
+            notifyStateCreated();
+        } else {
+            notifyStateUpdated();
+        }
+        // reset status
+        status = STATUS_EXISTING;
+    }
-    public abstract void destroy() throws ItemStateException;
+    public synchronized void destroy() throws ItemStateException {
+        getPersistenceManager().destroy(this);
+        // notify listeners
+        notifyStateDestroyed();
+        // reset status
+        status = STATUS_UNDEFINED;
+    }
+
+    /**
+     * Return the persistence manager to use for loading and storing data. May
+     * be overridden by subclasses.
+     *
+     * @return persistence manager
+     */
+    protected PersistenceManager getPersistenceManager() {
+        return persistMgr;
+    }

INS42 INS31 INS31 UPD83 INS29 INS83 INS42 INS44 INS44 INS44 INS8 UPD83 INS8 UPD83 INS8 UPD83 INS8 INS29 INS83 INS43 INS42 INS8 INS65 INS65 INS65 INS65 INS43 INS42 INS39 INS42 INS43 INS42 INS46 INS21 INS21 INS21 INS21 INS21 INS25 INS21 INS21 INS21 INS21 INS65 INS65 INS42 INS41 UPD66 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS42 INS42 INS42 INS42 INS7 INS7 INS32 INS7 INS32 INS27 INS8 INS8 INS7 INS32 INS32 INS7 INS66 INS66 INS66 INS42 INS22 INS42 INS42 INS42 INS32 INS42 INS52 INS42 INS42 INS32 INS42 INS52 INS42 INS42 INS21 INS21 INS42 INS42 INS32 INS42 INS52 INS42 INS42 INS42 INS52 INS42 INS42 INS42 INS32 INS32 INS42 INS42 INS42 DEL83 DEL42