JCR-1271: NullPointerException when iterating over properties

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@605510 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.Set;
-import java.util.Collections;
-import java.util.Collection;
+ * This implementation of ItemStateCache is thread-safe.
-    public boolean isCached(ItemId id) {
+    public synchronized boolean isCached(ItemId id) {
-    public ItemState retrieve(ItemId id) {
+    public synchronized ItemState retrieve(ItemId id) {
-    public void cache(ItemState state) {
+    public synchronized ItemState[] retrieveAll() {
+        // values of primary cache
+        return (ItemState[]) refs.values().toArray(new ItemState[refs.size()]);
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public synchronized void cache(ItemState state) {
-    public void evict(ItemId id) {
+    public synchronized void evict(ItemId id) {
-    public void dispose() {
+    public synchronized void dispose() {
-    public void evictAll() {
+    public synchronized void evictAll() {
-    public void update(ItemId id) {
+    public synchronized void update(ItemId id) {
-    public boolean isEmpty() {
+    public synchronized boolean isEmpty() {
-    /**
-     * {@inheritDoc}
-     */
-    public int size() {
-        // size of primary cache
-        return refs.size();
-    }
-
-    /**
-     * {@inheritDoc}
-     */
-    public Set keySet() {
-        // keys of primary cache
-        return Collections.unmodifiableSet(refs.keySet());
-    }
-
-    /**
-     * {@inheritDoc}
-     */
-    public Collection values() {
-        // values of primary cache
-        return Collections.unmodifiableCollection(refs.values());
-    }
-
-    public void dump(PrintStream ps) {
+    public synchronized void dump(PrintStream ps) {

INS31 INS83 INS83 MOV29 MOV83 UPD83 MOV83 INS5 UPD42 MOV42 MOV8 INS83 INS83 INS83 INS83 INS83 INS83 INS83 INS66 INS43 INS85 UPD42 MOV42 INS11 INS5 INS32 INS43 INS85 MOV32 UPD42 MOV42 INS3 INS42 INS5 MOV32 INS43 INS85 INS42 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL42 DEL42 DEL42 DEL32 DEL32 DEL39 DEL42 DEL41 DEL8 DEL31 DEL65 DEL65 DEL29 DEL43 DEL31 DEL65 DEL65 DEL29 DEL83 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL41 DEL8 DEL31