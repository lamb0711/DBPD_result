JCR-884 - DatabaseJournal assigns same revision id to different revisions


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@533019 13f79535-47bb-0310-9956-ffa450edef68

+     * <p/>
+     * This journal is locked by incrementing the current value in the table
+     * named <code>GLOBAL_REVISION</code>, which effectively write-locks this
+     * table. The updated value is then saved away and remembered in the
+     * appended record, because a save may entail multiple appends (JCR-884).
+     * <p/>
+     * Save away the locked revision inside the newly appended record.
-    protected long append(String producerId, InputStream in, int length)
+    protected void appending(AppendRecord record) {
+        record.setRevision(lockedRevision);
+    }
+
+    /**
+     * {@inheritDoc}
+     * <p/>
+     * We have already saved away the revision for this record.
+     */
+    protected void append(AppendRecord record, InputStream in, int length)
-                insertRevisionStmt.setLong(1, lockedRevision);
+                insertRevisionStmt.setLong(1, record.getRevision());
-                insertRevisionStmt.setString(3, producerId);
+                insertRevisionStmt.setString(3, record.getProducerId());
-                return lockedRevision;

INS31 INS29 INS83 INS39 INS42 INS44 INS8 UPD39 INS65 INS43 INS42 INS21 UPD43 UPD42 INS66 INS66 INS66 INS66 INS66 INS65 INS66 INS66 INS42 INS32 INS66 INS66 UPD42 INS42 INS42 INS42 INS32 INS32 INS42 UPD42 MOV42 INS42 UPD42 MOV42 DEL42 DEL41