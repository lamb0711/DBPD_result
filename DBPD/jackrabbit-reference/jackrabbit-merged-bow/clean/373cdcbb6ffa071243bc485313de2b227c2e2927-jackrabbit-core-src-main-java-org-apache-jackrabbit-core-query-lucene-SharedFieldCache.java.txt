JCR-3450 Reduce memory usage of SharedFieldCache.ValueIndex

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1400843 13f79535-47bb-0310-9956-ffa450edef68

-            ComparableArray[] retArray = new ComparableArray[maxDocs];
+            Comparable<?>[] retArray = new Comparable<?>[maxDocs];
+            Map<Integer, Integer> positions = new HashMap<Integer, Integer>();
+            boolean usingSimpleComparable = true;
-                            ComparableArray ca = retArray[doc];
+                            Comparable<?> ca = retArray[doc];
-                                retArray[doc] = new ComparableArray(v, termPosition);
+                                if (usingSimpleComparable) {
+                                    // put simple value on the queue
+                                    positions.put(doc, termPosition);
+                                    retArray[doc] = v;
+                                } else {
+                                    retArray[doc] = new ComparableArray(v,
+                                            termPosition);
+                                }
-                                retArray[doc] = ca.insert(v, termPosition);
+                                if (ca instanceof ComparableArray) {
+                                    ((ComparableArray) ca).insert(v,
+                                            termPosition);
+                                } else {
+                                    // transform all of the existing values from
+                                    // Comparable to ComparableArray
+                                    for (int pos : positions.keySet()) {
+                                        retArray[pos] = new ComparableArray(
+                                                retArray[pos],
+                                                positions.get(pos));
+                                    }
+                                    positions = null;
+                                    usingSimpleComparable = false;
+                                    ComparableArray caNew = (ComparableArray) retArray[doc];
+                                    retArray[doc] = caNew.insert(v,
+                                            termPosition);
+                                }

INS60 INS60 UPD5 INS74 INS59 INS39 INS59 INS74 INS43 INS43 INS43 INS42 INS14 INS42 INS9 INS43 INS76 UPD5 INS42 INS42 INS42 INS74 INS42 INS74 INS43 INS43 INS43 INS43 INS76 INS42 INS42 INS42 INS42 INS25 INS74 MOV27 INS8 INS8 INS43 INS76 MOV25 MOV8 INS25 INS42 INS42 INS62 INS8 INS8 INS21 INS42 INS43 INS21 INS70 INS21 INS21 INS60 INS21 INS32 INS42 INS32 INS44 INS32 INS8 INS7 INS7 MOV43 INS59 INS7 INS42 INS42 INS42 INS42 INS42 INS36 INS42 INS42 INS42 INS39 INS42 INS42 INS42 INS21 INS42 INS33 INS42 INS9 INS42 INS11 INS2 INS32 INS11 INS7 INS43 INS2 INS42 INS42 INS42 INS42 INS42 INS42 MOV43 INS42 INS2 INS14 INS42 INS42 INS42 INS42 INS42 MOV43 INS2 INS32 INS42 INS42 INS42 INS42 INS42 DEL42 DEL42 DEL42 DEL42 DEL32