JCR-134: Unreferenced VersionHistory should be deleted automatically

Applied patch contributed by SÃ©bastien Launay

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@778645 13f79535-47bb-0310-9956-ffa450edef68

-        if (vMgr.hasItemReferences(v)) {
+        if (vMgr.hasItemReferences(v.getId())) {
-        // store changes
-        node.store();
+        // Check if this was the last version in addition to the root version
+        if (!vMgr.hasItemReferences(node.getNodeId())) {
+            log.debug("Current version history has no references");
+            NodeStateEx[] childNodes = node.getChildNodes();
+
+            // Check if there is only root version and version labels nodes
+            if (childNodes.length == 2) {
+                log.debug("Removing orphan version history as it contains only two children");
+                NodeStateEx parentNode = vMgr.getNodeStateEx(node.getParentId());
+                // Remove version history node
+                parentNode.removeNode(node.getName());
+                // store changes for this node and his children
+                parentNode.store();
+            }
+        } else {
+            log.debug("Current version history has at least one reference");
+            // store changes
+            node.store();
+        }

INS25 INS38 INS8 INS8 INS32 INS32 INS21 INS60 INS25 INS21 MOV21 MOV42 INS42 INS42 INS42 INS32 INS32 INS5 INS59 INS27 INS8 INS32 INS42 INS42 INS42 INS42 INS45 INS43 INS85 INS42 INS32 INS40 INS34 INS21 INS60 INS21 INS21 INS42 INS42 INS45 INS42 INS42 INS42 INS32 INS43 INS59 INS32 INS32 INS42 INS42 INS45 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42