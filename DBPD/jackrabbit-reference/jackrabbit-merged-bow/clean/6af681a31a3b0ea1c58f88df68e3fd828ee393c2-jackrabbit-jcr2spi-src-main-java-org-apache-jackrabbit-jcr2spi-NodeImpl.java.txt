JCR-1868: Inconsistent state when removing mix:lockable from a locked Node

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@719577 13f79535-47bb-0310-9956-ffa450edef68

-            // build effective node type of remaining mixin's & primary type
-            Name[] allRemaining = (Name[]) mixinValue.toArray(new Name[mixinValue.size() + 1]);
-            allRemaining[mixinValue.size()] = primaryTypeName;
-            EffectiveNodeType entRemaining = session.getEffectiveNodeTypeProvider().getEffectiveNodeType(allRemaining);
-
+            EffectiveNodeType entRemaining = getRemainingENT(mixinValue);
+        /*
+         * mix:lockable: the mixin cannot be removed if the node is currently
+         * locked even if the editing session is the lock holder.
+         */
+        if (mixin.isNodeType((NameConstants.MIX_LOCKABLE))) {
+            EffectiveNodeType entRemaining = getRemainingENT(mixinValue);
+            if (!entRemaining.includesNodeType(NameConstants.MIX_LOCKABLE) && isLocked()) {
+                throw new ConstraintViolationException(mixinName + " can not be removed: the node is locked.");
+            }
+        }
+
+     * Build the effective node type of remaining mixin's & primary type
+     *
+     * @param remainingMixins
+     * @return effective node type
+     * @throws ConstraintViolationException
+     * @throws NoSuchNodeTypeException
+     */
+    private EffectiveNodeType getRemainingENT(List remainingMixins)
+            throws ConstraintViolationException, NoSuchNodeTypeException {
+        Name[] allRemaining = (Name[]) remainingMixins.toArray(new Name[remainingMixins.size() + 1]);
+        allRemaining[remainingMixins.size()] = primaryTypeName;
+        return session.getEffectiveNodeTypeProvider().getEffectiveNodeType(allRemaining);
+    }
+
+    /**

INS31 INS29 INS83 MOV43 INS42 INS44 INS43 INS43 MOV8 INS25 INS65 INS65 INS65 INS65 INS65 INS43 INS42 INS42 INS42 INS41 INS8 INS32 INS8 INS66 INS42 INS66 INS42 INS42 INS42 MOV5 MOV32 INS60 MOV25 INS42 INS42 INS36 INS60 INS25 INS43 INS59 INS40 INS43 INS59 INS27 INS8 INS42 INS42 INS32 INS42 INS42 INS32 INS38 INS32 INS53 UPD42 UPD42 INS42 INS42 INS42 INS42 INS32 INS42 INS14 MOV5 INS42 INS42 INS40 INS43 INS27 INS42 INS42 INS45 UPD42 DEL42 DEL59 DEL60