JCR-2334: Tika-based type detection in jcr-server

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@830670 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.server.io.IOManager;
-import org.apache.jackrabbit.server.io.DefaultIOManager;
-import org.apache.jackrabbit.server.io.IOHandler;
-import org.apache.jackrabbit.server.io.PropertyManager;
-import org.apache.jackrabbit.server.io.PropertyHandler;
-import org.apache.jackrabbit.server.io.PropertyManagerImpl;
-import org.apache.jackrabbit.server.io.MimeResolver;
-import org.apache.jackrabbit.webdav.xml.ElementIterator;
-import org.apache.jackrabbit.webdav.xml.DomUtil;
-import org.slf4j.Logger;
-import org.slf4j.LoggerFactory;
-import org.w3c.dom.Element;
-import org.w3c.dom.Document;
-import org.xml.sax.SAXException;
+import java.io.IOException;
+import java.io.InputStream;
+import java.net.URL;
+import java.util.ArrayList;
+import java.util.List;
-import java.net.URL;
-import java.util.List;
-import java.util.ArrayList;
-import java.util.Properties;
-import java.io.IOException;
-import java.io.InputStream;
+
+import org.apache.jackrabbit.server.io.DefaultIOManager;
+import org.apache.jackrabbit.server.io.IOHandler;
+import org.apache.jackrabbit.server.io.IOManager;
+import org.apache.jackrabbit.server.io.PropertyHandler;
+import org.apache.jackrabbit.server.io.PropertyManager;
+import org.apache.jackrabbit.server.io.PropertyManagerImpl;
+import org.apache.jackrabbit.webdav.xml.DomUtil;
+import org.apache.jackrabbit.webdav.xml.ElementIterator;
+import org.apache.tika.detect.Detector;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+import org.w3c.dom.Document;
+import org.w3c.dom.Element;
+import org.xml.sax.SAXException;
+    /**
+     * Content type detector.
+     */
+    private final Detector detector;
+
-    private MimeResolver mimeResolver;
+
+    public ResourceConfig(Detector detector) {
+        this.detector = detector;
+    }
+     * <p>
+     * The &lt;mimetypeproperties/&gt; settings have been deprecated and will
+     * be ignored with a warning. Instead you can use the
+     * {@link SimpleWebdavServlet#INIT_PARAM_MIME_INFO mime-info}
+     * servlet initialization parameter to customize the media type settings.
+                    ioManager.setDetector(detector);
-            // optional mimetype properties
-            Properties properties = new Properties();
-            String defaultMimetype = null;
-                defaultMimetype = DomUtil.getChildText(el, "defaultmimetype", null);
-                ElementIterator it = DomUtil.getChildren(el, "mimemapping", null);
-                while (it.hasNext()) {
-                    Element mimeMapping = it.nextElement();
-                    String extension = DomUtil.getAttribute(mimeMapping, "extension", null);
-                    String mimetype = DomUtil.getAttribute(mimeMapping, "mimetype", null);
-                    properties.put(extension, mimetype);
-                }
+                log.warn("Ignoring deprecated mimetypeproperties settings: {}",
+                        configURL);
-            mimeResolver = new MimeResolver(properties, defaultMimetype);
+            ioManager.setDetector(detector);
+     * Returns the configured content type detector.
-     * @return
+     * @return content type detector
-    public MimeResolver getMimeResolver() {
-        return mimeResolver;
+    public Detector getDetector() {
+        return detector;
-}
+
+}

MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV26 MOV23 UPD40 INS31 INS29 INS83 UPD43 INS83 INS42 INS44 INS8 UPD43 UPD42 INS65 UPD42 UPD42 INS43 INS42 INS21 INS65 UPD42 INS66 INS42 INS7 INS66 INS66 INS66 INS65 INS66 INS66 INS66 UPD42 INS22 INS42 INS67 INS66 INS21 INS52 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS32 INS21 UPD42 MOV42 UPD42 MOV42 UPD45 MOV45 INS42 INS32 INS42 INS42 INS42 DEL40 DEL26 DEL42 DEL43 DEL42 DEL42 DEL43 DEL14 DEL59 DEL60 DEL42 DEL43 DEL42 DEL33 DEL59 DEL60 DEL42 DEL42 DEL33 DEL32 DEL7 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL45 DEL33 DEL32 DEL59 DEL60 DEL42 DEL42 DEL32 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL45 DEL33 DEL32 DEL59 DEL60 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL45 DEL33 DEL32 DEL59 DEL60 DEL42 DEL42 DEL42 DEL42 DEL32 DEL21 DEL8 DEL61 DEL42 DEL42 DEL43 DEL42 DEL42 DEL14 DEL7 DEL21