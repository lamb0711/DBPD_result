work in progress

- add invalidate(), refresh() to NodeState (missing impl)
- rename ItemState.refresh(ChangeLog) to persisted(ChangeLog)
- Item.refresh(boolean) must not call checkStatus. a stale, invalidated
  item may be refreshed unless its state has a terminal status (removed, stale_destroyed). ItemState.refresh() is therefore called after reverting transient modifications only.
- javadoc and some comments

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@474319 13f79535-47bb-0310-9956-ffa450edef68

-        checkStatus();
+        // check session status
+        session.checkIsAlive();
+        // check if item has been removed
+        if (Status.isTerminal(state.getStatus())) {
+            throw new InvalidItemStateException("Item '" + this + "' doesn't exist anymore");
+        }
-        if (!keepChanges) {
+        if (keepChanges) {
+            state.refresh();
+        } else {
-            switch (state.getStatus()) {
-                case Status.NEW:
-                    String msg = "Cannot refresh a new item (" + safeGetJCRPath() + ").";
-                    log.debug(msg);
-                    throw new RepositoryException(msg);
+            if (state.getStatus() == Status.NEW) {
+                String msg = "Cannot refresh a new item (" + safeGetJCRPath() + ").";
+                log.debug(msg);
+                throw new RepositoryException(msg);
+            // now refresh to persistent state as present on the server
+            state.refresh();
-
-        // now refresh to persistent state on server
-        state.refresh();
-        if (state != null) {
-            if (state.getStatus() == Status.INVALIDATED) {
-                // refresh to get current status from persistent storage
-                state.refresh();
-            }
-            // now check if valid
-            if (state.isValid()) {
-                return;
-            }
+        if (state.getStatus() == Status.INVALIDATED) {
+            // refresh to get current status from persistent storage
+            state.refresh();
-        throw new InvalidItemStateException("Item '" + this + "' doesn't exist anymore");
+        // now check if valid
+        if (!state.isValid()) {
+            throw new InvalidItemStateException("Item '" + this + "' doesn't exist anymore");
+        }

MOV8 INS25 MOV21 INS32 INS8 INS42 INS8 INS38 INS42 UPD42 INS42 INS42 INS32 INS53 INS21 INS25 MOV21 MOV32 MOV53 MOV42 UPD42 MOV42 INS14 INS32 INS27 INS8 INS43 INS27 INS42 INS42 MOV32 INS40 MOV60 MOV21 MOV53 INS42 INS42 INS42 INS45 INS52 INS45 DEL42 DEL38 DEL40 DEL49 DEL50 DEL41 DEL42 DEL33 DEL27 DEL25 DEL8