Refactoring step 3 (JCR-53)
 - Moved workspace.xml parsing to ConfigurationParser
 - Replaced createFileSystem with BeanConfig code
 - Added a TestAll suite for the config package

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@156058 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.log4j.Logger;
-import org.jdom.Document;
-import org.jdom.Element;
-import org.xml.sax.InputSource;
-import org.xml.sax.SAXException;
-
-import javax.jcr.RepositoryException;
-import java.io.File;
-import java.io.FileReader;
-import java.io.IOException;
-import java.util.HashMap;
-import java.util.Properties;
-public class WorkspaceConfig extends AbstractConfig {
-    private static Logger log = Logger.getLogger(WorkspaceConfig.class);
-
-    /**
-     * name of workspace configuration file
-     */
-    public static final String CONFIG_FILE_NAME = "workspace.xml";
-
-    /**
-     * public id
-     */
-    public static final String PUBLIC_ID = "-//The Apache Software Foundation//DTD Workspace//EN";
-
-    static final String PERSISTENCE_MANAGER_ELEMENT = "PersistenceManager";
-    private static final String SEARCH_INDEX_ELEMENT = "SearchIndex";
-
-    /**
-     * wellknown variables (will be replaced with their respective values
-     * whereever they occur within the configuration)
-     */
-    public static final String WORKSPACE_HOME_VARIABLE = "${wsp.home}";
-    public static final String WORKSPACE_NAME_VARIABLE = "${wsp.name}";
-
-    private final Properties vars;
+public class WorkspaceConfig {
-    private PersistenceManagerConfig pmConfig;
+    private BeanConfig pmc;
-    /**
-     * private constructor.
-     *
-     * @param is
-     * @param wspHomeDir
-     * @throws RepositoryException
-     */
-    private WorkspaceConfig(InputSource is, String wspHomeDir)
-            throws RepositoryException {
-        super(is);
-        this.wspHomeDir = wspHomeDir;
-        // initialize variables
-        vars = new Properties();
-        vars.put(WORKSPACE_HOME_VARIABLE, wspHomeDir);
-        // read config
-        init(config);
-    }
-
-    /**
-     * Initializes this <code>WorkspaceConfig</code> object.
-     *
-     * @param config
-     * @throws RepositoryException
-     */
-    protected void init(Document config) throws RepositoryException {
-        Element wspElem = config.getRootElement();
-        // name
-        wspName = wspElem.getAttributeValue(NAME_ATTRIB);
-        if (wspName == null) {
-            // init with wsp home dirname
-            wspName = new File(wspHomeDir).getName();
-        } else {
-            ConfigurationParser parser = new ConfigurationParser(vars);
-            wspName = parser.replaceVariables(wspName);
-        }
-
-        // set name variable
-        vars.put(WORKSPACE_NAME_VARIABLE, wspName);
-        ConfigurationParser parser = new ConfigurationParser(vars);
-
-        // file system
-        Element fsElem = wspElem.getChild(FILE_SYSTEM_ELEMENT);
-        wspFS = parser.createFileSystem(fsElem);
-
-        // persistence manager config
-        Element pmElem = wspElem.getChild(PERSISTENCE_MANAGER_ELEMENT);
-        pmConfig = parser.parsePersistenceManagerConfig(pmElem);
-
-        // search config (optional)
-        Element searchElem = wspElem.getChild(SEARCH_INDEX_ELEMENT);
-        if (searchElem != null) {
-            searchConfig = parser.parseSearchConfig(searchElem);
-        }
-    }
-
-    /**
-     * Creates a new <code>WorkspaceConfig</code> instance. The configuration
-     * is read from the specified configuration file.
-     *
-     * @param configFilePath path to the configuration file
-     * @param wspHomeDir     workspace home directory
-     * @return a new <code>WorkspaceConfig</code> instance
-     * @throws RepositoryException If an error occurs
-     */
-    public static WorkspaceConfig create(String configFilePath, String wspHomeDir)
-            throws RepositoryException {
-        try {
-            File config = new File(configFilePath);
-            InputSource is = new InputSource(new FileReader(config));
-            is.setSystemId(config.toURI().toString());
-            return new WorkspaceConfig(is, wspHomeDir);
-        } catch (IOException ioe) {
-            String msg = "error while reading config file " + configFilePath;
-            log.debug(msg);
-            throw new RepositoryException(msg, ioe);
-        }
-    }
-
-    /**
-     * Creates a new <code>WorkspaceConfig</code> instance. The configuration
-     * is read from the specified input source.
-     *
-     * @param is         <code>InputSource</code> where the configuration is read from
-     * @param wspHomeDir workspace home directory
-     * @return a new <code>WorkspaceConfig</code> instance
-     * @throws RepositoryException If an error occurs
-     */
-    public static WorkspaceConfig create(InputSource is, String wspHomeDir)
-            throws RepositoryException {
-        return new WorkspaceConfig(is, wspHomeDir);
+    public WorkspaceConfig(String home, String name, FileSystem fs, BeanConfig pmc, SearchConfig sc) {
+        this.wspHomeDir = home;
+        this.wspName = name;
+        this.wspFS = fs;
+        this.pmc = pmc;
+        this.searchConfig = sc;
-        return pmConfig;
+        return new PersistenceManagerConfig(pmc);
-    //------------------------------------------------------< EntityResolver >
-    /**
-     * @see org.xml.sax.EntityResolver#resolveEntity(String, String)
-     */
-    public InputSource resolveEntity(String publicId, String systemId)
-            throws SAXException, IOException {
-        if (publicId.equals(PUBLIC_ID)) {
-            // load dtd resource
-            return new InputSource(getClass().getClassLoader().getResourceAsStream(CONFIG_DTD_RESOURCE_PATH));
-        } else {
-            // use the default behaviour
-            return null;
-        }
-    }

MOV23 INS31 MOV29 UPD43 INS83 MOV42 MOV44 MOV44 MOV44 INS44 MOV44 MOV8 UPD42 UPD42 UPD42 UPD42 UPD43 UPD42 INS43 INS42 UPD43 UPD42 MOV21 MOV21 MOV21 UPD42 UPD42 MOV42 UPD42 INS14 UPD42 INS22 INS42 INS22 INS42 INS22 INS42 INS22 INS42 MOV43 INS42 INS52 INS42 INS52 INS42 INS52 INS42 INS52 INS42 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL42 DEL43 DEL83 DEL83 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL43 DEL57 DEL32 DEL59 DEL23 DEL66 DEL65 DEL29 DEL83 DEL83 DEL83 DEL42 DEL43 DEL42 DEL45 DEL59 DEL23 DEL66 DEL65 DEL29 DEL83 DEL83 DEL83 DEL42 DEL43 DEL42 DEL45 DEL59 DEL23 DEL83 DEL83 DEL42 DEL43 DEL42 DEL45 DEL59 DEL23 DEL66 DEL66 DEL65 DEL29 DEL83 DEL83 DEL83 DEL42 DEL43 DEL42 DEL45 DEL59 DEL23 DEL83 DEL83 DEL83 DEL42 DEL43 DEL42 DEL45 DEL59 DEL23 DEL83 DEL83 DEL42 DEL43 DEL42 DEL59 DEL23 DEL83 DEL83 DEL45 DEL83 DEL42 DEL59 DEL23 DEL42 DEL42 DEL43 DEL42 DEL14 DEL42 DEL32 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL42 DEL33 DEL27 DEL8 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL14 DEL59 DEL60 DEL42 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL8 DEL25 DEL42 DEL42 DEL42 DEL42 DEL32 DEL21 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL14 DEL59 DEL60 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL33 DEL27 DEL8 DEL25 DEL66 DEL65 DEL42 DEL65 DEL42 DEL65 DEL42 DEL65 DEL29 DEL83 DEL43 DEL42 DEL46 DEL42 DEL42 DEL43 DEL14 DEL7 DEL21 DEL42 DEL42 DEL42 DEL42 DEL32 DEL21 DEL42 DEL42 DEL32 DEL21 DEL8 DEL31 DEL66 DEL65 DEL42 DEL65 DEL42 DEL65 DEL29 DEL83 DEL39 DEL42 DEL42 DEL43 DEL31 DEL66 DEL66 DEL65 DEL42 DEL66 DEL65 DEL42 DEL66 DEL65 DEL66 DEL65 DEL42 DEL66 DEL65 DEL29 DEL83 DEL83 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL14 DEL59 DEL60 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL43 DEL42 DEL14 DEL14 DEL59 DEL60 DEL42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL32 DEL21 DEL42 DEL43 DEL42 DEL42 DEL14 DEL41 DEL8 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL45 DEL42 DEL27 DEL59 DEL60 DEL42 DEL42 DEL42 DEL32 DEL21 DEL42 DEL43 DEL42 DEL42 DEL14 DEL53 DEL8 DEL12 DEL54 DEL8 DEL31 DEL66 DEL66 DEL65 DEL42 DEL66 DEL65 DEL42 DEL66 DEL65 DEL66 DEL65 DEL42 DEL66 DEL65 DEL29 DEL83 DEL83 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL43 DEL42 DEL42 DEL14 DEL41 DEL8 DEL31 DEL42 DEL40 DEL42 DEL42 DEL43 DEL69 DEL42 DEL43 DEL69 DEL68 DEL65 DEL29 DEL83 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL42 DEL43 DEL42 DEL32 DEL42 DEL32 DEL42 DEL42 DEL32 DEL14 DEL41 DEL8 DEL33 DEL41 DEL8 DEL25 DEL8 DEL31