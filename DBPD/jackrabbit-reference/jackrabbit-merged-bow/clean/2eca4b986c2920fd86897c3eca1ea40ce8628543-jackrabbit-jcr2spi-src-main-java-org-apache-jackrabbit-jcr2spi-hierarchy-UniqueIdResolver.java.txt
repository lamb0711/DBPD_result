JCR-1799 updating events swallowed (CacheBehavior.OBSERVATION)   	
JCR-1783 incomplete changelog when combining move with removal of new destination parent

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@704361 13f79535-47bb-0310-9956-ffa450edef68

-        String uniqueID = entry.getUniqueID();
-        if (uniqueID != null) {
-            Object previous = lookUp.put(uniqueID, entry);
-            if (previous != null) {
-                ((NodeEntry) previous).remove();
+        synchronized (lookUp) {
+            String uniqueID = entry.getUniqueID();
+            if (uniqueID != null) {
+                // get an previous entry first and remove it before adding the
+                // new one. otherwise the newly added entry will be removed
+                // again upon removal of the original entry.
+                Object previous = lookUp.get(uniqueID);
+                if (previous != null) {
+                    lookUp.remove(uniqueID);
+                    ((NodeEntry) previous).remove();
+                }
+                lookUp.put(uniqueID, entry);
-                lookUp.remove(previousUniqueID);
+                Object previous = lookUp.get(previousUniqueID);
+                if (previous != entry) {
+                    // changed entry was not in this cache -> return.
+                    return;
+                } else {
+                    lookUp.remove(previousUniqueID);
+                }

INS8 INS51 INS42 MOV8 INS25 MOV27 INS8 INS21 INS60 MOV25 MOV32 INS43 INS59 INS27 INS8 INS32 INS21 INS42 INS42 INS32 INS42 INS42 INS41 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42