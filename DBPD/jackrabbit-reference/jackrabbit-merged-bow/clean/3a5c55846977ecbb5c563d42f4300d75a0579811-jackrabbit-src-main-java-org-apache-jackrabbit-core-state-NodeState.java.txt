- Use custom collection implementation for item state listeners.
reduces memory consumption caused by those collections to about 1/3.
Performance of common operations on the WeakIdentityCollection scale linearly and outperforms the previously used ReferenceMap until it contains aprox. 100 listeners. Most item states only contain few listeners.

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@378539 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.commons.collections.map.ReferenceMap;
+import org.apache.jackrabbit.util.WeakIdentityCollection;
+import org.apache.log4j.Logger;
+    private static Logger log = Logger.getLogger(NodeState.class);
+
-    private final transient ReferenceMap listeners =
-            new ReferenceMap(ReferenceMap.WEAK, ReferenceMap.WEAK);
+    private final transient Collection listeners = new WeakIdentityCollection(3);
-                if (!listeners.containsKey(listener)) {
-                    listeners.put(listener, listener);
+                if (listeners.contains(listener)) {
+                    log.debug("listener already registered: " + listener);
+                    // no need to add to call ItemState.addListener()
+                    return;
+                } else {
+                    listeners.add(listener);
-            MapIterator iter = listeners.mapIterator();
+            Iterator iter = listeners.iterator();
-            MapIterator iter = listeners.mapIterator();
+            Iterator iter = listeners.iterator();
-            MapIterator iter = listeners.mapIterator();
+            Iterator iter = listeners.iterator();

MOV26 INS26 UPD40 INS40 INS23 INS83 INS83 INS43 INS59 UPD43 INS42 INS42 INS32 UPD42 INS42 INS42 INS57 UPD43 INS34 INS43 UPD42 INS42 UPD43 UPD43 UPD43 UPD42 UPD42 UPD42 INS32 INS8 UPD42 UPD42 UPD42 MOV42 UPD42 MOV42 MOV42 INS21 INS41 INS32 INS42 INS42 INS27 UPD42 INS45 INS42 DEL40 DEL40 DEL32 DEL38 DEL42