JCR-2443: AbstractSession should not synchronize on the session instance

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@892253 13f79535-47bb-0310-9956-ffa450edef68

-    public synchronized void logout() {
-        namespaces.clear();
+    public void logout() {
+        synchronized (namespaces) {
+            namespaces.clear();
+        }
-    public synchronized String getNamespacePrefix(String uri)
+    public String getNamespacePrefix(String uri)
-        for (Map.Entry<String, String> entry : namespaces.entrySet()) {
-            if (entry.getValue().equals(uri)) {
-                return entry.getKey();
+        synchronized (namespaces) {
+            for (Map.Entry<String, String> entry : namespaces.entrySet()) {
+                if (entry.getValue().equals(uri)) {
+                    return entry.getKey();
+                }
+
+            // The following throws an exception if the URI is not found, that's OK
+            String prefix = getWorkspace().getNamespaceRegistry().getPrefix(uri);
+
+            // Generate a new prefix if the global mapping is already taken
+            String base = prefix;
+            for (int i = 2; namespaces.containsKey(prefix); i++) {
+                prefix = base + i;
+            }
+
+            namespaces.put(prefix, uri);
+            return prefix;
-
-        // The following throws an exception if the URI is not found, that's OK
-        String prefix = getWorkspace().getNamespaceRegistry().getPrefix(uri);
-
-        // Generate a new prefix if the global mapping is already taken
-        String base = prefix;
-        for (int i = 2; namespaces.containsKey(prefix); i++) {
-            prefix = base + i;
-        }
-
-        namespaces.put(prefix, uri);
-        return prefix;
-    public synchronized String getNamespaceURI(String prefix)
+    public String getNamespaceURI(String prefix)
-        String uri = namespaces.get(prefix);
+        synchronized (namespaces) {
+            String uri = namespaces.get(prefix);
-        if (uri == null) {
-            // Not in local mappings, try the global ones
-            uri = getWorkspace().getNamespaceRegistry().getURI(prefix);
-            if (namespaces.containsValue(uri)) {
-                // The global URI is locally mapped to some other prefix,
-                // so there are no mappings for this prefix
-                throw new NamespaceException("Namespace not found: " + prefix);
+            if (uri == null) {
+                // Not in local mappings, try the global ones
+                uri = getWorkspace().getNamespaceRegistry().getURI(prefix);
+                if (namespaces.containsValue(uri)) {
+                    // The global URI is locally mapped to some other prefix,
+                    // so there are no mappings for this prefix
+                    throw new NamespaceException("Namespace not found: " + prefix);
+                }
+                // Add the mapping to the local set, we already know that
+                // the prefix is not taken
+                namespaces.put(prefix, uri);
-            // Add the mapping to the local set, we already know that
-            // the prefix is not taken
-            namespaces.put(prefix, uri);
-        }
-        return uri;
+            return uri;
+        }
-    public synchronized String[] getNamespacePrefixes()
+    public String[] getNamespacePrefixes()
-        return namespaces.keySet().toArray(new String[namespaces.size()]);
+        synchronized (namespaces) {
+            return namespaces.keySet().toArray(new String[namespaces.size()]);
+        }
-    public synchronized void setNamespacePrefix(String prefix, String uri)
+    public void setNamespacePrefix(String prefix, String uri)
-        // Remove existing mapping for the given prefix
-        namespaces.remove(prefix);
+        synchronized (namespaces) {
+            // Remove existing mapping for the given prefix
+            namespaces.remove(prefix);
-        // Remove existing mapping(s) for the given URI
-        Set<String> prefixes = new HashSet<String>();
-        for (Map.Entry<String, String> entry : namespaces.entrySet()) {
-            if (entry.getValue().equals(uri)) {
-                prefixes.add(entry.getKey());
+            // Remove existing mapping(s) for the given URI
+            Set<String> prefixes = new HashSet<String>();
+            for (Map.Entry<String, String> entry : namespaces.entrySet()) {
+                if (entry.getValue().equals(uri)) {
+                    prefixes.add(entry.getKey());
+                }
-        }
-        namespaces.keySet().removeAll(prefixes);
+            namespaces.keySet().removeAll(prefixes);
-        // Add the new mapping
-        namespaces.put(prefix, uri);
+            // Add the new mapping
+            namespaces.put(prefix, uri);
+        }

INS8 INS8 INS8 INS51 INS51 INS51 INS51 INS51 INS42 MOV8 INS42 MOV8 INS42 MOV8 INS42 INS8 INS42 INS8 MOV41 MOV21 MOV60 MOV70 MOV21 MOV21 DEL83 DEL83 DEL83 DEL83 DEL83