JCR-458: session.move() throws ItemExistsException despite same name siblings

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@414263 13f79535-47bb-0310-9956-ffa450edef68

+        ItemImpl existing = null;
-            ItemImpl item = getItemManager().getItem(destPath);
-            if (!item.isNode()) {
+            existing = getItemManager().getItem(destPath);
+            if (!existing.isNode()) {
-                throw new ItemExistsException(item.safeGetJCRPath());
+                throw new ItemExistsException(existing.safeGetJCRPath());
-                // there's already a node with that name
-                // check same-name sibling setting of both new and existing node
-                if (!destParentNode.getDefinition().allowsSameNameSiblings()
-                        || !((NodeImpl) item).getDefinition().allowsSameNameSiblings()) {
-                    throw new ItemExistsException(item.safeGetJCRPath());
+                // there's already a node with that name:
+                // check same-name sibling setting of existing node
+                if (!((NodeImpl) existing).getDefinition().allowsSameNameSiblings()) {
+                    throw new ItemExistsException(existing.safeGetJCRPath());
-            // no name collision
+            // no name collision since same-name siblings are allowed
+        // if there's already a node with that name also check same-name sibling
+        // setting of new node; just checking same-name sibling setting on
+        // existing node is not sufficient since same-name sibling nodes don't
+        // necessarily have identical definitions
+        if (existing != null && !newTargetDef.allowsSameNameSiblings()) {
+            throw new ItemExistsException(existing.safeGetJCRPath());
+        }
+

INS60 INS25 MOV43 INS59 INS27 INS8 INS42 INS33 INS21 INS27 INS38 INS53 INS7 INS42 INS33 INS32 INS14 INS42 MOV32 INS42 INS42 INS43 INS32 UPD42 MOV38 INS42 INS42 INS42 UPD42 UPD42 UPD42 DEL42 DEL59 DEL60 DEL42 DEL42 DEL32 DEL42 DEL32 DEL38 DEL27