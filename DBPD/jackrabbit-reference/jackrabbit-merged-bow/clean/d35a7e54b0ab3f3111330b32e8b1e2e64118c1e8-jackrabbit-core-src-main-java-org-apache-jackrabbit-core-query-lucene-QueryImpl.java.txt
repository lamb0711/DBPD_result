JCR-890: concurrent read-only access to a session

Use the SessionContext and SessionOperations in search

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@983708 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.Map;
+import java.util.Map;
-import org.apache.jackrabbit.core.ItemManager;
+import org.apache.jackrabbit.core.session.SessionContext;
+import org.apache.jackrabbit.spi.commons.nodetype.PropertyDefinitionImpl;
-import org.apache.jackrabbit.spi.commons.nodetype.PropertyDefinitionImpl;
-     * @param session   the session of the user executing this query.
-     * @param itemMgr   the item manager of the session executing this query.
+     * @param sessionContext component context of the current session
-    public QueryImpl(SessionImpl session,
-                     ItemManager itemMgr,
-                     SearchIndex index,
-                     PropertyTypeRegistry propReg,
-                     String statement,
-                     String language,
-                     QueryNodeFactory factory) throws InvalidQueryException {
-        super(session, itemMgr, index, propReg);
+    public QueryImpl(
+            SessionContext sessionContext, SearchIndex index,
+            PropertyTypeRegistry propReg, String statement, String language,
+            QueryNodeFactory factory) throws InvalidQueryException {
+        super(sessionContext, index, propReg);
-        this.root = QueryParser.parse(statement, language, session, factory);
+        this.root = QueryParser.parse(
+                statement, language, sessionContext.getSessionImpl(), factory);
-        Query query = LuceneQueryBuilder.createQuery(root, session,
+        Query query = LuceneQueryBuilder.createQuery(
+                root, sessionContext.getSessionImpl(),
-        return new SingleColumnQueryResult(index, itemMgr,
-                session, session.getAccessManager(),
-                this, query, new SpellSuggestion(index.getSpellChecker(), root),
+        return new SingleColumnQueryResult(
+                index, sessionContext, this, query,
+                new SpellSuggestion(index.getSpellChecker(), root),
+        SessionImpl session = sessionContext.getSessionImpl();
-        QueryObjectModelFactory qomFactory = session.getWorkspace().getQueryManager().getQOMFactory();
+        SessionImpl session = sessionContext.getSessionImpl();
+        QueryObjectModelFactory qomFactory =
+            session.getWorkspace().getQueryManager().getQOMFactory();

MOV26 MOV26 MOV26 UPD40 UPD43 UPD42 INS60 INS60 UPD42 UPD66 UPD42 UPD42 MOV43 INS59 INS43 INS59 UPD42 INS42 INS32 INS42 INS42 INS32 INS32 INS32 INS42 INS42 INS42 INS42 UPD42 MOV42 INS42 UPD42 MOV42 INS42 DEL42 DEL66 DEL65 DEL42 DEL44 DEL42 DEL42 DEL42 DEL42 DEL32