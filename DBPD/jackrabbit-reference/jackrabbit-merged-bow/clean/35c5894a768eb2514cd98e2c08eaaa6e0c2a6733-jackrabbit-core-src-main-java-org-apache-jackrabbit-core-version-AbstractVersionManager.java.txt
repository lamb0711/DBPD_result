JCR-1775: Transaction-safe versioning

All calls to VersionManager's getVersionHistory and createVersionHistory followed this pattern:

    VersionHistory vh = manager.getVersionHistory(...);
    if (vh == null) {
        vh = manager.createVersionHistory(...);
    }

Simplified things by making getVersionHistory() automatically create the version history if it doesn't already exist. This simplifies the client code to:

    VersionHistory vh = manager.getVersionHistory(...);


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@702425 13f79535-47bb-0310-9956-ffa450edef68

-     * Returns the version history associated with the given node.
-     *
-     * @param session 
-     * @param node the node whose version history's id is to be returned.
-     * @return the version history associated with the given node
-     *         or <code>null</code> if that node doesn't have a version history.
-     * @throws RepositoryException if an error occurs
+     * {@inheritDoc}
+        NodeId id = null;
+
-                NodeId id =
-                    parent.getState().getChildNodeEntry(name, 1).getId();
-                return (VersionHistory) ((SessionImpl) session).getNodeById(id);
-            } else {
-                return null;
+                id = parent.getState().getChildNodeEntry(name, 1).getId();
+
+        if (id == null) {
+            id = createVersionHistory(session, node);
+        }
+
+        return (VersionHistory) ((SessionImpl) session).getNodeById(id);
+
+    /**
+     * Creates a new version history. This action is needed either when creating
+     * a new 'mix:versionable' node or when adding the 'mix:versionable' mixin
+     * to a node.
+     *
+     * @param node
+     * @return identifier of the new version history node
+     * @throws RepositoryException
+     * @see #getVersionHistory(Session, NodeState)
+     */
+    protected abstract NodeId createVersionHistory(
+            Session session, NodeState node) throws RepositoryException;
+

INS31 INS29 INS83 INS83 INS43 INS42 INS44 INS44 INS43 INS65 INS60 INS25 MOV41 INS65 INS65 INS65 INS65 INS65 INS42 INS43 INS42 INS43 INS42 INS42 INS65 MOV43 INS59 INS27 INS8 INS66 INS66 INS66 INS42 INS66 INS42 INS68 INS42 INS42 INS42 INS33 INS42 INS33 INS21 INS42 INS69 INS69 INS7 INS43 INS43 INS21 INS42 INS32 INS42 INS42 INS7 INS42 INS42 INS42 INS42 MOV32 DEL66 DEL65 DEL42 DEL66 DEL65 DEL42 DEL66 DEL65 DEL66 DEL66 DEL65 DEL42 DEL66 DEL65 DEL42 DEL59 DEL60 DEL33 DEL41 DEL8