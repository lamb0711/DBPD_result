Applying patch for JCR-1624 provided by Stephane Landelle

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@661049 13f79535-47bb-0310-9956-ffa450edef68

-import net.sf.cglib.proxy.LazyLoader;
-
-import org.apache.commons.logging.Log;
-import org.apache.commons.logging.LogFactory;
-public class CollectionLazyLoader implements LazyLoader {
-
-	private final static Log log = LogFactory.getLog(CollectionLazyLoader.class);
+public class CollectionLazyLoader extends AbstractLazyLoader {
-	private Class collectionFieldClass;
+	private Class<?> collectionFieldClass;
-			                                               CollectionDescriptor collectionDescriptor, Class collectionFieldClass ) {
+			CollectionDescriptor collectionDescriptor, Class<?> collectionFieldClass) {
-	public Object loadObject() {
+	@Override
+	protected Object fetchTarget() {
+		if (isInitialized()) {
+			throw new IllegalStateException("Proxy already initialized");
+		}
+		ManageableObjects objects = collectionConverter.getCollection(session, collectionParentNode, collectionDescriptor,
+				collectionFieldClass);
+		Object target = objects.getObjects();
+		clean();
+		return target;
+	}
-
-		ManageableObjects objects = collectionConverter.getCollection(session, collectionParentNode, collectionDescriptor, collectionFieldClass);
-		return objects.getObjects();
+	private void clean() {
+		collectionConverter = null;
+		session = null;
+		collectionParentNode = null;
+		collectionDescriptor = null;

UPD43 INS31 UPD42 INS74 INS78 UPD83 UPD42 INS83 INS39 INS42 INS8 MOV43 INS76 INS74 INS42 INS25 INS60 INS21 INS21 INS21 INS21 INS21 MOV43 INS76 INS32 INS8 INS43 INS59 INS32 INS42 INS7 INS7 INS7 INS7 INS42 INS53 INS42 INS42 MOV32 INS42 INS42 INS33 INS42 INS33 INS42 INS33 INS42 INS33 INS14 INS43 INS45 INS42 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL83 DEL83 DEL83 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL43 DEL57 DEL32 DEL59 DEL23