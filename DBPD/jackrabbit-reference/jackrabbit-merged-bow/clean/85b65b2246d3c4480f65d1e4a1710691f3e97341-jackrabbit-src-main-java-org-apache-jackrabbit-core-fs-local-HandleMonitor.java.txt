JCR-628: OutOfMemory problem: HandleMonitor does not release closed input streams


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@474234 13f79535-47bb-0310-9956-ffa450edef68

-import java.io.FileDescriptor;
+import java.io.IOException;
-        public Handle(File file) {
+        private Handle(File file) {
-        public InputStream open() throws FileNotFoundException {
+        private InputStream open() throws FileNotFoundException {
-        public void close(MonitoredInputStream in) {
+        private void close(MonitoredInputStream in) {
-        public void dump() {
+        private void dump() {
-        public void dump(boolean detailed) {
+        private void dump(boolean detailed) {
-            private final Throwable throwable;
+            private final Throwable throwable = new Exception();
-            public MonitoredInputStream(File file) throws FileNotFoundException {
+            private MonitoredInputStream(File file) throws FileNotFoundException {
-                // register the throwable
-                try {
-                    throw new Exception();
-                } catch (Exception e) {
-                    throwable = e;
-                }
-            }
-
-            /**
-             * {@inheritDoc}
-             */
-            public MonitoredInputStream(FileDescriptor fdObj) {
-                super(fdObj);
-                // register the throwable
-                try {
-                    throw new Exception();
-                } catch (Exception e) {
-                    throwable = e;
-                }
-            }
-
-            /**
-             * {@inheritDoc}
-             */
-            public MonitoredInputStream(String name) throws FileNotFoundException {
-                super(name);
-                // register the throwable
-                try {
-                    throw new Exception();
-                } catch (Exception e) {
-                    throwable = e;
-                }
-            public void dump() {
+            private void dump() {
+            /**
+             * {@inheritDoc}
+             */
+            public void close() throws IOException {
+                // remove myself from the set
+                Handle.this.close(this);
+                super.close();
+            }
+

MOV26 UPD40 MOV31 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 INS8 UPD83 MOV29 INS39 INS42 UPD43 MOV14 MOV46 UPD42 INS21 MOV21 INS32 INS48 INS52 INS42 INS52 INS42 INS42 DEL53 DEL8 DEL42 DEL43 DEL42 DEL44 DEL42 DEL42 DEL7 DEL21 DEL8 DEL12 DEL54 DEL8 DEL83 DEL42 DEL42 DEL43 DEL42 DEL44 DEL42 DEL46 DEL42 DEL43 DEL14 DEL53 DEL8 DEL42 DEL43 DEL42 DEL44 DEL42 DEL42 DEL7 DEL21 DEL8 DEL12 DEL54 DEL8 DEL31 DEL65 DEL65 DEL29 DEL42 DEL42 DEL43 DEL42 DEL44 DEL42 DEL42 DEL7 DEL42 DEL46 DEL42 DEL43 DEL14 DEL53 DEL8 DEL42 DEL43 DEL42 DEL44 DEL8 DEL12 DEL54