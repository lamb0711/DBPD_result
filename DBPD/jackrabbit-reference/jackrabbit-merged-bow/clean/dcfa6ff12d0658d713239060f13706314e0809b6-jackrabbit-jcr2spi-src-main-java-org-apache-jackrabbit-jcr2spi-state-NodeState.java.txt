JCR-1547: JCR2SPI: remove dependency to state-package within nodetype package

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@650514 13f79535-47bb-0310-9956-ffa450edef68

-                QNodeDefinition def = definitionProvider.getQNodeDefinition(this);
+                QNodeDefinition def = retrieveDefinition();
-            definition = definitionProvider.getQNodeDefinition(this);
+            definition = retrieveDefinition();
+    private QNodeDefinition retrieveDefinition() throws RepositoryException {
+        QNodeDefinition def;
+        if (isRoot()) {
+            def = definitionProvider.getRootNodeDefinition();
+        } else {
+            /*
+             Don't use getAllNodeTypeNames() to retrieve the definition:
+             for NEW-states the definition is always set upon creation.
+             for all other states the definion must be retrieved only taking
+             the effective nodetypes present on the parent into account
+             any kind of transiently added mixins must not have an effect
+             on the definition retrieved for an state that has been persisted
+             before. The effective NT must be evaluated as if it had been
+             evaluated upon creating the workspace state.
+             */
+            def = definitionProvider.getQNodeDefinition(getParent().getNodeTypeNames(), getName(), getNodeTypeName(), getNodeEntry().getWorkspaceId());
+        }
+        return def;
+    }

INS31 INS83 INS43 INS42 INS43 INS8 INS42 INS42 INS60 INS25 INS41 INS43 INS59 INS32 INS8 INS8 INS42 INS42 INS42 INS42 INS21 INS21 INS7 INS7 INS42 INS32 INS42 INS32 UPD42 INS42 INS42 INS42 INS42 INS32 INS32 INS32 INS32 INS32 INS42 INS42 INS42 INS32 INS42 UPD42 INS42 INS42 DEL42 DEL52 DEL42 DEL52