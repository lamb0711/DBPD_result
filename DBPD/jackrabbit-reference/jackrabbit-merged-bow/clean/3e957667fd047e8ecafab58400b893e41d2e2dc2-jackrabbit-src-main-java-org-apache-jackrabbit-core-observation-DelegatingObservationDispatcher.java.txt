Make versioning transactional
- Added specialized XAVersion and XAVersionHistory objects that refresh their internal state when needed
- Defined new observation interface in order to have VersionManagerImpl use standard event dispatching
  instead of writing its own
- Added test cases verifying isolation of versioning operations in transactions


git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@368026 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.state.ChangeLog;
-import javax.jcr.RepositoryException;
-public class DelegatingObservationDispatcher {
+public class DelegatingObservationDispatcher extends EventDispatcher {
+     * Creates an <code>EventStateCollection</code> tied to the session
+     * given as argument.
+     *
+     * @param session event source
+     * @return new <code>EventStateCollection</code> instance
+     */
+    public EventStateCollection createEventStateCollection(SessionImpl session) {
+        return new EventStateCollection(this, session);
+    }
+
+    //------------------------------------------------------< EventDispatcher >
+
+    /**
+     * {@inheritDoc}
+     */
+    void prepareEvents(EventStateCollection events) {
+        // events will get prepared on dispatch
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    void prepareDeleted(EventStateCollection events, ChangeLog changes) {
+        // events will get prepared on dispatch
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    void dispatchEvents(EventStateCollection events) {
+        dispatch(events.getEvents(), events.getSession());
+    }
+
+    /**
-     * @throws RepositoryException
-    public void dispatch(List eventList, SessionImpl session) throws RepositoryException {
+    public void dispatch(List eventList, SessionImpl session) {

UPD40 INS43 INS31 INS31 INS31 INS31 INS42 INS29 INS83 INS43 INS42 INS44 INS8 INS29 INS39 INS42 INS44 INS8 INS29 INS39 INS42 INS44 INS44 INS8 INS29 INS39 INS42 INS44 INS8 INS65 INS65 INS65 INS42 INS43 INS42 INS41 INS65 INS43 INS42 INS65 INS43 INS42 INS43 INS42 INS65 INS43 INS42 INS21 INS66 INS66 INS42 INS66 INS66 INS42 INS14 INS65 INS42 INS65 INS42 INS42 INS65 INS42 INS32 INS43 INS52 INS42 INS42 INS32 INS32 INS42 INS42 INS42 INS42 INS42 DEL42 DEL65 DEL42 DEL43