JCR-2836: Unclosed threads in Jackrabbit

Remove the use of ThreadLocal variables in PerQueryCache to avoid leaking memory in container environments.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1055117 13f79535-47bb-0310-9956-ffa450edef68

+    private final PerQueryCache cache;
+
-    public RangeQuery(Term lowerTerm, Term upperTerm, boolean inclusive) {
-        this(lowerTerm, upperTerm, inclusive, TRANSFORM_NONE);
+    public RangeQuery(
+            Term lowerTerm, Term upperTerm, boolean inclusive,
+            PerQueryCache cache) {
+        this(lowerTerm, upperTerm, inclusive, TRANSFORM_NONE, cache);
-    public RangeQuery(Term lowerTerm, Term upperTerm, boolean inclusive, int transform) {
+    public RangeQuery(
+            Term lowerTerm, Term upperTerm, boolean inclusive, int transform,
+            PerQueryCache cache) {
+        this.cache = cache;
-        return new RangeQueryWeight(searcher);
+        return new RangeQueryWeight(searcher, cache);
+        private final PerQueryCache cache;
+
-        RangeQueryWeight(Searcher searcher) {
+        RangeQueryWeight(Searcher searcher, PerQueryCache cache) {
+            this.cache = cache;
-            return new RangeQueryScorer(searcher.getSimilarity(), reader);
+            return new RangeQueryScorer(searcher.getSimilarity(), reader, cache);
-        RangeQueryScorer(Similarity similarity, IndexReader reader) {
+        RangeQueryScorer(
+                Similarity similarity, IndexReader reader,
+                PerQueryCache cache) {
-            PerQueryCache cache = PerQueryCache.getInstance();

INS23 INS83 INS83 INS43 INS59 INS44 INS44 INS23 INS42 INS42 INS43 INS42 INS43 INS42 INS21 INS83 INS83 INS43 INS59 INS44 INS44 INS42 INS42 INS42 INS7 INS42 INS42 INS43 INS42 INS21 MOV43 INS42 INS22 INS42 INS42 INS42 INS7 INS52 INS42 INS22 INS42 INS42 INS52 INS42 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60