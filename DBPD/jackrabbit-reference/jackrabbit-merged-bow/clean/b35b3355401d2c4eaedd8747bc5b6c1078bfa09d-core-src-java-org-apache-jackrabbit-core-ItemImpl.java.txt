JCR-166: Versioned node importXML fails

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@209776 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.version.VersionManager;
-                        VersionHistory hist = session.getVersionManager().createVersionHistory(session, (NodeState) itemState);
-                        node.internalSetProperty(JCR_VERSIONHISTORY, InternalValue.create(new UUID(hist.getUUID())));
-                        node.internalSetProperty(JCR_BASEVERSION, InternalValue.create(new UUID(hist.getRootVersion().getUUID())));
+                        VersionManager vMgr = session.getVersionManager();
+                        NodeState nodeState = (NodeState) itemState;
+                        /**
+                         * check if there's already a version history for that
+                         * node; this would e.g. be the case if a versionable
+                         * node had been exported, removed and re-imported with
+                         * either IMPORT_UUID_COLLISION_REMOVE_EXISTING or
+                         * IMPORT_UUID_COLLISION_REPLACE_EXISTING;
+                         * otherwise create a new version history
+                         */
+                        VersionHistory vh = vMgr.getVersionHistory(session, nodeState);
+                        if (vh == null) {
+                            vh = vMgr.createVersionHistory(session, nodeState);
+                        }
+                        node.internalSetProperty(JCR_VERSIONHISTORY, InternalValue.create(new UUID(vh.getUUID())));
+                        node.internalSetProperty(JCR_BASEVERSION, InternalValue.create(new UUID(vh.getRootVersion().getUUID())));
-                                new InternalValue[]{InternalValue.create(new UUID(hist.getRootVersion().getUUID()))});
+                                new InternalValue[]{InternalValue.create(new UUID(vh.getRootVersion().getUUID()))});

INS26 INS40 INS60 INS60 INS25 INS43 INS59 INS43 MOV59 MOV43 INS59 INS27 INS8 INS42 INS42 MOV32 INS42 INS42 MOV11 INS42 INS32 INS42 INS33 INS21 INS42 INS42 INS42 INS42 INS7 INS42 INS32 MOV43 MOV43 INS42 INS42 INS42 INS42 UPD42 UPD42 MOV43 UPD42 DEL42 DEL42 DEL42 DEL32