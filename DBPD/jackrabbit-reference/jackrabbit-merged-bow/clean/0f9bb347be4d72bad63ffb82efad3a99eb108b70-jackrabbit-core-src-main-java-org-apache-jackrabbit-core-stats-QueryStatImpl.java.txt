JCR-3124 Stats for Queries

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1186660 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.api.stats.QueryStat;
- * Default {@link QueryStat} implementation
+ * Default {@link QueryStatCore} implementation
-public class QueryStatImpl implements QueryStat {
+public class QueryStatImpl implements QueryStatCore {
-    public synchronized void setSlowQueriesQueueSize(int size) {
-        this.queueSize = size;
-        this.queries = new PriorityQueue<QueryStatDto>(this.queueSize + 1,
-                comparator);
+    public void setSlowQueriesQueueSize(int size) {
+        synchronized (queries) {
+            this.queueSize = size;
+            this.queries = new PriorityQueue<QueryStatDto>(this.queueSize + 1,
+                    comparator);
+        }
-        this.enabled = enabled;
-        this.queries = new PriorityQueue<QueryStatDto>(this.queueSize + 1,
-                comparator);
+        synchronized (queries) {
+            this.enabled = enabled;
+            this.queries = new PriorityQueue<QueryStatDto>(this.queueSize + 1,
+                    comparator);
+        }
-    public synchronized void logQuery(final String language,
-            final String statement, long duration) {
+    public void logQuery(final String language, final String statement,
+            long durationMs) {
-        queries.add(new QueryStatDtoImpl(language, statement, duration));
-        if (queries.size() > queueSize) {
-            queries.remove();
+        synchronized (queries) {
+            queries.add(new QueryStatDtoImpl(language, statement, durationMs));
+            if (queries.size() > queueSize) {
+                queries.remove();
+            }
+            qps.onOp(durationMs);
-        qps.onOp(duration * 1000);
-        this.queries.clear();
+        synchronized (queries) {
+            queries.clear();
+        }

UPD43 UPD42 INS8 INS8 INS8 INS51 INS51 UPD42 INS51 INS51 UPD42 INS42 MOV8 INS42 MOV8 INS42 INS8 INS42 INS8 MOV21 MOV25 MOV21 MOV21 INS42 INS42 UPD42 DEL40 DEL26 DEL83 DEL83 DEL42 DEL34 DEL27 DEL52 DEL42 DEL22 DEL8