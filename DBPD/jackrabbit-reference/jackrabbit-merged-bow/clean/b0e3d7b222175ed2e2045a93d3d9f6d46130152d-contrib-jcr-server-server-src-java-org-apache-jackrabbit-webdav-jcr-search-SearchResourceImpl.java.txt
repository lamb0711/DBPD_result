JCR-193, JCR-216, JCR-203, JCR 184 + various minor fixes

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@293331 13f79535-47bb-0310-9956-ffa450edef68

-        String resourcePath = locator.getResourcePath();
-        if (!rootNode.getPath().equals(resourcePath)) {
-            String qNodeRelPath = resourcePath.substring(1);
+        String itemPath = locator.getJcrPath();
+        if (!rootNode.getPath().equals(itemPath)) {
+            String qNodeRelPath = itemPath.substring(1);
-            throw new DavException(DavServletResponse.SC_BAD_REQUEST, resourcePath + " is not a nt:query node -> searchRequest body required.");
+            throw new DavException(DavServletResponse.SC_BAD_REQUEST, locator.getResourcePath() + " is not a nt:query node -> searchRequest body required.");
-        if (!session.getRepositorySession().itemExists(resourcePath)) {
+        if (!session.getRepositorySession().itemExists(itemPath)) {
-                q.storeAsNode(resourcePath);
+                q.storeAsNode(itemPath);
-            // get the jcr:path column indicating the node path
-            String nodePath = row.getValue(JcrConstants.JCR_PATH).getString();
+            // get the jcr:path column indicating the node path and build
+            // a webdav compliant resource path of it.
+            String itemPath = row.getValue(JcrConstants.JCR_PATH).getString();
-            DavResourceLocator loc = locator.getFactory().createResourceLocator(locator.getPrefix(), locator.getWorkspacePath(), nodePath);
-            String nodeHref = loc.getHref(true);
-            MultiStatusResponse resp = new MultiStatusResponse(nodeHref);
+            DavResourceLocator loc = locator.getFactory().createResourceLocator(locator.getPrefix(), locator.getWorkspacePath(), itemPath, false);
+            String href = loc.getHref(true);
+            MultiStatusResponse resp = new MultiStatusResponse(href);

UPD42 INS32 INS42 INS42 UPD42 UPD42 MOV43 UPD42 UPD42 UPD42 MOV32 UPD42 INS9 MOV43 UPD42 UPD42 DEL42