JCR-1167: Paths not correct after reordering children


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@583151 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.HashMap;
-                PathMap.Element element = entry.getElement();
-                Iterator iter = element.getChildren();
+                PathMap.Element parent = entry.getElement();
+                HashMap newChildrenOrder = new HashMap();
+                boolean orderChanged = false;
+
+                Iterator iter = parent.getChildren();
-                    if (!cne.getName().equals(child.getName()) ||
-                            cne.getIndex() != child.getNormalizedIndex()) {
-                        /* Child still exists but at a different position */
-                        element.move(child.getPathElement(),
-                                Path.PathElement.create(cne.getName(), cne.getIndex()));
-                        continue;
+
+                    /**
+                     * Put all children into map of new children order - regardless
+                     * whether their position changed or not - as we might need
+                     * to reorder them later on.
+                     */
+                    Path.PathElement newNameIndex = Path.PathElement.create(
+                            cne.getName(), cne.getIndex());
+                    newChildrenOrder.put(newNameIndex, child);
+
+                    if (!newNameIndex.equals(child.getPathElement())) {
+                        orderChanged = true;
-                    /* At this point the child's position is still valid */
+                }
+
+                if (orderChanged) {
+                    /* If at least one child changed its position, reorder */
+                    parent.setChildren(newChildrenOrder);

INS26 INS40 INS60 INS60 INS25 INS43 INS59 INS39 INS59 INS42 INS8 UPD42 INS42 INS42 INS14 INS42 INS9 INS60 INS21 INS25 INS21 INS43 UPD42 INS43 INS59 INS32 INS38 MOV8 INS32 INS42 INS40 INS42 MOV32 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 MOV42 INS32 INS42 INS42 INS42 UPD42 MOV42 UPD42 MOV42 MOV32 INS7 INS42 INS9 DEL42 DEL42 DEL32 DEL18 DEL32 DEL42 DEL32 DEL32 DEL38 DEL32 DEL42 DEL42 DEL32 DEL27 DEL27 DEL25