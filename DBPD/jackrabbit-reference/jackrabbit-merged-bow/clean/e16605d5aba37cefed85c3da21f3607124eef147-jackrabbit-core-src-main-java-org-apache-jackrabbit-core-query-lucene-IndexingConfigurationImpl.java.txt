JCR-4455 condition index-rule handling more broken after JCR-4339

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1862783 13f79535-47bb-0310-9956-ffa450edef68

-
+        IndexingRule matchingNodeTypeRule = null;
-                if (rule.appliesTo(state)) {
-                    return rule;
+                if (rule.appliesToNodeType(state)) {
+                    if (!rule.containsCondition()) {
+                        matchingNodeTypeRule = rule;
+                    } else if (rule.appliesToCondition(state)) {
+                        return rule; 
+                    }
-        // no applicable rule
-        return null;
+        return matchingNodeTypeRule;
-         * Returns <code>true</code> if this rule applies to the given node
-         * <code>state</code>.
+         * Returns <code>true</code> if the nodetype of this rule 
+         * applies to the given node <code>state</code>.
-        public boolean appliesTo(NodeState state) {
+        public boolean appliesToNodeType(NodeState state) {
-            return condition == null || condition.evaluate(state);
+            return true;
+        }
+        
+        /**
+         * Returns <code>true</code> if the condition of this rule 
+         * applies to the given node <code>state</code>.
+         *
+         * @param state the state to check.
+         * @return <code>true</code> the rule applies to the given node;
+         *         <code>false</code> otherwise.
+         */
+        public boolean appliesToCondition(NodeState state) {
+            return condition != null && condition.evaluate(state);
+        }
+
+        /**
+         * Returns <code>true</code> this rule contains a condition. 
+         *
+         * @return <code>true</code> the rule contains a condition;
+         *         <code>false</code> otherwise.
+         */
+        public boolean containsCondition() {
+            return condition != null;

INS31 INS31 INS60 UPD42 INS29 INS83 INS39 INS42 INS44 INS8 INS29 INS83 INS39 INS42 INS8 INS43 INS59 INS42 INS41 INS65 INS65 INS65 INS43 INS42 MOV41 INS65 INS65 INS41 INS42 INS42 INS33 UPD66 UPD66 INS9 INS66 INS66 INS42 INS66 INS66 INS66 INS42 UPD27 INS66 INS66 INS66 INS27 UPD27 INS42 INS33 INS8 UPD42 INS25 INS38 INS8 INS25 INS32 INS21 INS32 MOV8 INS42 INS42 INS7 INS42 INS42 INS42 INS42 INS42 DEL33