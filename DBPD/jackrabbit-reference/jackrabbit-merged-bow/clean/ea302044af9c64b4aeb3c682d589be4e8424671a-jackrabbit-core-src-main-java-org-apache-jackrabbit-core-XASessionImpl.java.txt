JCR-1109 - Resource association not compliant to JTA spec


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@572595 13f79535-47bb-0310-9956-ffa450edef68

-        TransactionContext tx;
+        TransactionContext tx = (TransactionContext) txGlobal.get(xid);
-            tx = (TransactionContext) txGlobal.get(xid);
-            tx = (TransactionContext) txGlobal.get(xid);
-            tx = (TransactionContext) txGlobal.get(xid);
+            if (!tx.isSuspended()) {
+                log.error("Unable to resume: transaction not suspended.");
+                throw new XAException(XAException.XAER_PROTO);
+            }
+            tx.setSuspended(false);
+     * <p/>
+     * It is legal for a transaction association to be suspended and then
+     * ended (either with <code>TMSUCCESS</code> or <code>TMFAIL</code>)
+     * without having been resumed again.
-        if (!isAssociated()) {
-            log.error("Resource not associated with a transaction.");
-            throw new XAException(XAException.XAER_PROTO);
-        }
-        if (flags == TMSUCCESS || flags == TMFAIL || flags == TMSUSPEND) {
+        if (flags == TMSUSPEND) {
+            if (!isAssociated()) {
+                log.error("Resource not associated with a transaction.");
+                throw new XAException(XAException.XAER_PROTO);
+            }
+            tx.setSuspended(true);
+        } else if (flags == TMFAIL || flags == TMSUCCESS) {
+            if (!tx.isSuspended()) {
+                if (!isAssociated()) {
+                    log.error("Resource not associated with a transaction.");
+                    throw new XAException(XAException.XAER_PROTO);
+                }
+                associate(null);
+            } else {
+                tx.setSuspended(false);
+            }

MOV25 INS25 MOV27 MOV8 INS66 INS66 INS66 INS66 MOV27 INS8 INS25 INS11 MOV27 INS25 MOV25 MOV21 INS21 MOV27 MOV27 INS8 MOV8 INS43 INS32 MOV27 INS8 MOV8 INS32 INS25 INS42 INS42 INS42 INS42 MOV25 INS25 INS21 INS42 INS42 INS9 INS38 INS8 INS8 INS38 INS8 INS32 INS32 MOV25 INS21 INS21 INS32 INS21 INS53 INS42 INS42 INS9 INS42 INS42 INS38 INS32 INS32 INS42 INS42 INS32 INS14 INS32 INS21 INS53 INS42 INS33 INS42 INS42 INS9 INS42 INS42 INS45 INS43 INS40 INS42 INS32 INS14 INS42 INS42 INS42 INS45 INS43 INS40 INS42 DEL42 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL11 DEL7 DEL21 DEL42 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL11 DEL7 DEL21 DEL8 DEL42 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL11 DEL7 DEL21 DEL25 DEL27