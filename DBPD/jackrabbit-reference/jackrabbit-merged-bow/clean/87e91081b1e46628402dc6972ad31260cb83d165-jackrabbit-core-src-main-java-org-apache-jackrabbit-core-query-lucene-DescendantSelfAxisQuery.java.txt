JCR-1365: Query path constraints like foo//*/bar do not scale

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@620859 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.lucene.search.MatchAllDocsQuery;
-     * If <code>true</code> this query acts on the descendant-or-self axis.
-     * If <code>false</code> this query acts on the descendant axis.
+     * The minimal levels required between context and sub nodes for a sub node
+     * to match.
-    private final boolean includeSelf;
+    private final int minLevels;
+     * <code>context</code> and matches all descendants of the context nodes.
+     * Whether the context nodes match as well is controlled by
+     * <code>includeSelf</code>.
+     *
+     * @param context     the context for this query.
+     * @param includeSelf if <code>true</code> this query acts like a
+     *                    descendant-or-self axis. If <code>false</code> this
+     *                    query acts like a descendant axis.
+     */
+    public DescendantSelfAxisQuery(Query context, boolean includeSelf) {
+        this(context, new MatchAllDocsQuery(), includeSelf);
+    }
+
+    /**
+     * Creates a new <code>DescendantSelfAxisQuery</code> based on a
+        this(context, sub, includeSelf ? 0 : 1);
+    }
+
+    /**
+     * Creates a new <code>DescendantSelfAxisQuery</code> based on a
+     * <code>context</code> query and filtering the <code>sub</code> query.
+     *
+     * @param context   the context for this query.
+     * @param sub       the sub query.
+     * @param minLevels the minimal levels required between context and sub
+     *                  nodes for a sub node to match.
+     */
+    public DescendantSelfAxisQuery(Query context, Query sub, int minLevels) {
-        this.includeSelf = includeSelf;
+        this.minLevels = minLevels;
+    }
+
+    /**
+     * @return the context query of this <code>DescendantSelfAxisQuery</code>.
+     */
+    Query getContextQuery() {
+        return contextQuery;
+    }
+
+    /**
+     * @return <code>true</code> if the sub query of this <code>DescendantSelfAxisQuery</code>
+     *         matches all nodes.
+     */
+    boolean subQueryMatchesAll() {
+        return subQuery instanceof MatchAllDocsQuery;
+    }
+
+    /**
+     * @return the minimal levels required between context and sub nodes for a
+     *         sub node to match.
+     */
+    int getMinLevels() {
+        return minLevels;
+        if (contextQuery instanceof DescendantSelfAxisQuery) {
+            DescendantSelfAxisQuery dsaq = (DescendantSelfAxisQuery) contextQuery;
+            if (dsaq.subQueryMatchesAll()) {
+                return new DescendantSelfAxisQuery(dsaq.getContextQuery(),
+                        sQuery, dsaq.getMinLevels() + getMinLevels()).rewrite(reader);
+            }
+        }
-            return new DescendantSelfAxisQuery(cQuery, sQuery, includeSelf);
+            return new DescendantSelfAxisQuery(cQuery, sQuery, minLevels);
+        //-----------------------------< Weight >-------------------------------
+
-            if (includeSelf) {
-                if (contextHits.get(doc)) {
-                    return true;
-                }
+            if (minLevels == 0 && contextHits.get(doc)) {
+                return true;
-            while (parentDoc != -1 && !contextHits.get(parentDoc)) {
+            while (parentDoc != -1 && (!contextHits.get(parentDoc) || ancestorCount < minLevels)) {

INS26 INS40 INS23 INS31 INS31 INS31 INS31 INS31 MOV29 MOV83 MOV83 INS39 INS59 INS29 INS83 INS42 INS44 INS44 INS8 INS8 INS29 INS83 INS42 INS44 INS44 INS44 MOV8 INS29 INS43 INS42 INS8 INS29 INS39 INS42 INS8 INS29 INS39 INS42 INS8 INS42 INS65 INS65 INS65 INS43 INS42 INS39 INS42 INS17 INS17 INS65 INS65 INS65 INS65 INS43 INS42 INS43 INS42 INS39 INS42 INS65 INS42 INS41 INS65 INS41 INS65 INS41 INS25 UPD66 UPD66 INS66 INS66 INS66 INS66 INS42 INS66 INS42 INS66 INS66 INS66 INS42 INS42 INS14 INS42 INS42 INS42 INS16 INS66 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS66 INS42 INS42 INS66 INS42 INS66 INS66 INS62 INS66 INS66 INS42 INS62 INS8 MOV25 INS43 INS42 INS34 INS34 UPD42 INS42 INS43 INS42 INS43 INS60 INS25 INS27 INS42 UPD42 INS42 INS42 MOV43 INS59 INS32 INS8 INS27 MOV32 INS36 INS42 INS11 INS42 INS42 INS41 INS43 UPD42 INS42 INS34 INS27 INS43 INS42 INS32 INS42 MOV38 INS27 INS42 INS14 INS42 INS42 INS42 INS42 INS43 INS32 INS42 INS27 INS42 INS42 INS42 INS32 INS32 INS42 INS42 INS42 DEL39 DEL42 DEL59 DEL23 DEL42 DEL8 DEL25