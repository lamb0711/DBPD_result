work in progress

- Node.getIndex() always returns 1.
  It's the definition of the node that determines if SNS are allowed and not
  the definition of the parent -> moving check from NodeState.getChildIndex to NodeImpl

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@449672 13f79535-47bb-0310-9956-ffa450edef68

-        NodeState parentState = getItemState().getParent();
-        if (parentState == null) {
-            // the root node cannot have same-name siblings; always return the
-            // default index
+        if (getNodeState().getDefinition().allowsSameNameSiblings()) {
+            NodeState parentState = getItemState().getParent();
+            if (parentState == null) {
+                // the root node cannot have same-name siblings; always return the
+                // default index
+                return Path.INDEX_DEFAULT;
+            }
+            ChildNodeEntry entry = parentState.getChildNodeEntry(getNodeState());
+            if (entry == null) {
+                String msg = "Unable to retrieve index for: " + safeGetJCRPath();
+                throw new RepositoryException(msg);
+            }
+            return entry.getIndex();
+        } else {
-
-        ChildNodeEntry parentEntry = parentState.getChildNodeEntry(getNodeState());
-        if (parentEntry == null) {
-            String msg = "Unable to retrieve index for: " + safeGetJCRPath();
-            throw new RepositoryException(msg);
-        }
-        return parentEntry.getIndex();

INS8 MOV21 INS25 INS32 MOV8 INS8 INS32 INS42 INS41 INS32 INS42 INS40 INS42 UPD42 UPD42 UPD42