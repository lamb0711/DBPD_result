maven 2 descriptor
remove commons logging dependency
remove spring dependency
and some minor changes

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@472354 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.ByteArrayInputStream;
+import java.io.InputStream;
+import java.util.HashMap;
+import java.util.Map;
+import java.util.Properties;
+import javax.naming.InitialContext;
-import org.apache.commons.logging.Log;
-import org.apache.commons.logging.LogFactory;
+import org.apache.log4j.Logger;
-    private static Log log = LogFactory.getLog(SessionTag.class);
+	private static Logger log = Logger.getLogger(SessionTag.class);
+	
+	/**
+	 * jcr repository
+	 */
+	private static Map repositories = new HashMap() ;
+	
+	/**
+	 * JNDI address where a Repository is registered
+	 */
+	private String jndiAddress = JCRTagConstants.REPOSITORY_JNDI_ADDRESS ;
+	/**
+	 * JNDI properties to create the initial context
+	 */
+	private String jndiProperties = JCRTagConstants.REPOSITORY_JNDI_PROPERTIES ;
+	
-     * Name of the jndi address of a repository other than the default.
-     */
-    private String repositoryJNDI = JCRTagConstants.JNDI_DEFAULT_REPOSITORY;;
-
-    /**
-        this.repositoryJNDI = JCRTagConstants.JNDI_DEFAULT_REPOSITORY;
-     * Sets the repository JNDI address
-     * 
-     * @param repository
-     */
-    public void setRepositoryJNDI(String repository)
-    {
-        this.repositoryJNDI = repository;
-    }
-
-    /**
-        Repository repo = (Repository) JCRTagUtils.lookup(this.repositoryJNDI);
+        Repository repo = (Repository) this.getRepository();
+    
+    /**
+     * get a repository either from a cache or via JNDI
+     * 
+     * @return
+     */
+    private Repository getRepository() {
+    	String address = (String) JCRTagUtils.lookup(this.jndiAddress) ;
+    	String props = (String) JCRTagUtils.lookup(this.jndiProperties) ;
+    	String key = props + address; 
+    	
+    	// lookup cached repository
+    	if (repositories.get(key)== null) {
+    		try {
+            	InitialContext ctx = null ;
+            	if (props!=null) {
+            		Properties properties = new Properties() ;
+                	InputStream is = new ByteArrayInputStream(props.getBytes("UTF-8")) ;
+                	properties.load(is) ;
+                	ctx = new InitialContext(properties) ; 
+            	} else {
+            		ctx = new InitialContext();
+            	}
+            	Repository repo = (Repository) ctx.lookup(address) ;
+            	 if (repo!=null) {
+            		 synchronized (this) {
+            			 repositories.put(key, repo) ;	
+        			}
+            	 }
+    		} catch (Exception e) {
+				log.error("unable to get repository", e);
+			}
+    	}
+ 		return (Repository) repositories.get(key) ;
+    }
+
+	public void setJndiAddress(String jndiAddress) {
+		this.jndiAddress = jndiAddress;
+	}
+
+	public void setJndiProperties(String jndiProperties) {
+		this.jndiProperties = jndiProperties;
+	}

MOV26 MOV26 INS26 INS26 INS26 INS26 INS26 MOV23 INS40 INS40 INS40 INS40 INS40 UPD40 UPD40 INS23 INS23 INS31 INS31 INS31 UPD43 INS29 INS83 INS83 INS43 INS59 INS29 INS83 INS43 INS59 MOV29 INS83 INS43 INS42 INS8 MOV83 MOV39 UPD42 MOV42 MOV44 MOV8 INS83 INS39 INS42 INS44 INS8 UPD42 INS65 INS42 INS42 INS14 UPD42 UPD40 INS65 INS42 INS42 INS40 UPD65 INS42 INS60 INS60 INS60 INS25 INS41 INS43 INS42 INS43 INS42 INS21 UPD42 UPD42 INS66 INS43 UPD66 INS66 MOV43 UPD66 MOV43 INS59 INS43 INS59 INS43 INS59 INS27 INS8 INS11 INS42 INS42 INS7 INS42 INS42 INS11 INS42 INS42 INS11 INS42 INS42 INS27 INS32 INS33 INS54 INS43 INS32 UPD42 INS22 INS42 MOV43 INS43 INS32 INS43 INS32 INS42 INS42 INS42 INS42 INS42 INS8 INS12 INS42 INS42 INS42 INS42 UPD42 INS52 INS42 INS52 INS42 INS42 INS42 INS42 INS22 INS42 INS42 INS42 INS22 INS60 INS25 INS60 INS25 INS44 INS8 INS52 INS42 INS52 INS42 INS43 INS59 INS27 INS8 INS8 INS43 INS59 INS27 INS8 INS43 INS42 INS21 INS42 INS42 INS33 INS42 INS33 INS60 INS60 INS21 INS21 INS21 INS42 INS42 INS11 INS42 INS33 INS51 INS42 INS32 INS43 INS59 INS43 INS59 INS32 INS7 INS7 INS43 INS32 INS52 INS8 INS42 INS42 INS45 INS42 INS42 INS42 INS14 INS42 INS42 INS14 INS42 INS42 INS42 INS42 INS14 INS42 INS14 INS42 INS42 INS42 INS42 INS21 INS43 INS43 INS32 INS43 INS42 INS43 INS32 INS42 INS42 INS42 INS42 INS45 INS42 INS42 INS42 INS42 INS42 INS42 DEL52 DEL42 DEL22 DEL40 DEL7 DEL21 DEL31 DEL42 DEL42 DEL52 DEL42 DEL22 DEL42 DEL42