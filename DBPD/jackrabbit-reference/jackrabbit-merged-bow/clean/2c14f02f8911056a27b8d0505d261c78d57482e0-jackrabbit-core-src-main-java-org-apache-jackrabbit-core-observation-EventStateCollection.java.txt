JCR-2298: NPE in EventStateCollection

Log an error and skip the REMOVE event when the old parent of a moved node is no longer available. This is not ideal, but definitely better than the current behaviour of throwing a NullPointerException.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@890401 13f79535-47bb-0310-9956-ffa450edef68

+                        Path oldPath = getZombiePath(n.getNodeId(), hmgr);
-
-                        NodeTypeImpl oldParentNodeType = getNodeType(oldParent, session);
-                        Set<Name> mixins = oldParent.getMixinTypeNames();
-                        Path newPath = getPath(n.getNodeId(), hmgr);
-                        Path oldPath = getZombiePath(n.getNodeId(), hmgr);
-                        events.add(EventState.childNodeRemoved(oldParentId,
-                                getParent(oldPath), n.getNodeId(),
-                                oldPath.getNameElement(),
-                                oldParentNodeType.getQName(),
-                                mixins, session));
+                        if (oldParent != null) {
+                            NodeTypeImpl oldParentNodeType = getNodeType(oldParent, session);
+                            events.add(EventState.childNodeRemoved(oldParentId,
+                                    getParent(oldPath), n.getNodeId(),
+                                    oldPath.getNameElement(),
+                                    oldParentNodeType.getQName(),
+                                    oldParent.getMixinTypeNames(), session));
+                        } else {
+                            // JCR-2298: In some cases the old parent node
+                            // state is no longer available anywhere. Log an
+                            // error since in this case we can't generate the
+                            // correct REMOVE event.
+                            log.error(
+                                    "The old parent (node id " + oldParentId
+                                    + ") of a moved node (old path "
+                                    + oldPath + ") is no longer available."
+                                    + " No REMOVE event generated!");
+                        }
-                        mixins = newParent.getMixinTypeNames();
+                        Set<Name> mixins = newParent.getMixinTypeNames();
+                        Path newPath = getPath(n.getNodeId(), hmgr);

MOV60 MOV60 MOV60 INS25 INS27 INS8 INS8 INS42 INS33 MOV60 MOV21 MOV21 MOV32 INS32 INS42 INS42 INS27 MOV32 INS45 INS42 INS45 INS42 INS45 INS45 DEL42 DEL42 DEL7