JCR-2887 : Split PrivilegeRegistry in a per-session manager instance and a repository level registry [work in progress]

- clustering support
- move definition & def-reader/writer to spi-commons

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1095338 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.spi.commons.privilege.PrivilegeDefinition;
-        PrivilegeRegistry.Definition[] allDefs = registry.getAll();
+        PrivilegeDefinition[] allDefs = registry.getAll();
-                for (PrivilegeRegistry.Definition def : allDefs) {
+                for (PrivilegeDefinition def : allDefs) {
-        PrivilegeBits bits = PrivilegeBits.getInstance();
-        for (Privilege priv : privileges) {
-            if (priv instanceof PrivilegeImpl) {
-                bits.add(((PrivilegeImpl) priv).definition.getBits());
+
+        PrivilegeDefinition[] defs = new PrivilegeDefinition[privileges.length];
+        for (int i = 0; i < privileges.length; i++) {
+            Privilege p = privileges[i];
+            if (p instanceof PrivilegeImpl) {
+                defs[i] = ((PrivilegeImpl) p).definition;
-                String name = (priv == null) ? "null" : priv.getName();
+                String name = (p == null) ? "null" : p.getName();
-        return bits;
+        return registry.getBits(defs);
-                PrivilegeRegistry.Definition def = registry.get(name);
+                PrivilegeDefinition def = registry.get(name);
-     * @see PrivilegeRegistry.Listener#privilegeRegistered(org.apache.jackrabbit.spi.Name)
+     * @see PrivilegeRegistry.Listener#privilegesRegistered(java.util.Set
+     * @param privilegeNames
-    public void privilegeRegistered(Name privilegeName) {
+    public void privilegesRegistered(Set<Name> privilegeNames) {
-        private final PrivilegeRegistry.Definition definition;
+        private final PrivilegeDefinition definition;
-        private PrivilegeImpl(PrivilegeRegistry.Definition definition) throws RepositoryException {
+        private PrivilegeImpl(PrivilegeDefinition definition) throws RepositoryException {
-            Name[] declAggrNames = definition.getDeclaredAggregateNames();
+            Set<Name> set = definition.getDeclaredAggregateNames();
+            Name[] declAggrNames = set.toArray(new Name[set.size()]);

INS26 INS40 UPD42 INS24 INS74 UPD42 UPD43 UPD5 INS5 INS58 INS27 INS37 MOV8 INS32 INS66 INS43 MOV43 INS42 UPD43 INS60 UPD43 INS43 INS85 UPD42 INS3 INS39 INS59 INS42 INS40 INS42 INS60 INS42 INS42 INS42 INS42 INS42 INS74 MOV5 INS59 INS42 UPD42 MOV42 INS5 INS40 INS42 INS34 MOV43 INS59 INS43 INS43 UPD42 INS42 INS32 INS43 INS85 INS42 INS2 UPD42 INS42 INS42 INS42 INS42 INS3 INS42 INS42 INS42 INS7 UPD43 INS5 INS32 UPD43 INS2 MOV22 INS42 INS43 INS85 INS42 INS42 INS42 INS42 INS42 INS42 UPD42 UPD42 UPD42 DEL40 DEL40 DEL43 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32 DEL32 DEL42 DEL44 DEL42 DEL70 DEL42 DEL40 DEL40 DEL42 DEL40 DEL43 DEL69 DEL68 DEL40 DEL40