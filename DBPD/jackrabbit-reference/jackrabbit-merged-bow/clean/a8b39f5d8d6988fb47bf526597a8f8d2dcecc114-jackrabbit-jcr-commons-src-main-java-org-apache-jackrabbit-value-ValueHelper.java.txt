JCR-674: add base64 encoding for non-binary properties that do non-XML characters (checking for now: control characters other than TAB, NL, CR); note this only affects export, import still needs to be done.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@533070 13f79535-47bb-0310-9956-ffa450edef68

-            serialize(value, encodeBlanks, writer);
+            serialize(value, encodeBlanks, false, writer);
+     * @deprecated use {@link #serialize(Value, boolean, boolean, Writer)} instead
+     */
+    public static void serialize(Value value, boolean encodeBlanks,
+        Writer writer)
+        throws IllegalStateException, IOException, RepositoryException {
+        serialize(value, encodeBlanks, false, writer);
+    }
+    
+      /**
+     * @param enforceBase64 if <code>true</code>, base64 encoding will always be used
-    public static void serialize(Value value, boolean encodeBlanks,
+    public static void serialize(Value value, boolean encodeBlanks, boolean enforceBase64,
-            if (encodeBlanks) {
-                // enocde blanks in string
-                textVal = Text.replace(textVal, " ", "_x0020_");
+            if (enforceBase64) {
+                byte bytes[] = textVal.getBytes("UTF-8");
+                Base64.encode(bytes, 0, bytes.length, writer);
-            writer.write(textVal);
+            else {
+                if (encodeBlanks) {
+                    // enocde blanks in string
+                    textVal = Text.replace(textVal, " ", "_x0020_");
+                }
+                writer.write(textVal);
+            }

INS31 INS29 INS83 INS83 INS39 INS42 INS44 INS44 INS44 INS43 INS43 INS43 INS8 INS44 INS65 INS43 INS42 INS39 INS42 INS43 INS42 INS42 INS42 INS42 INS21 INS65 INS39 INS42 INS66 INS65 INS66 INS42 INS42 INS32 INS42 INS66 INS8 INS68 INS42 INS42 INS42 INS9 INS42 MOV60 INS25 INS42 INS69 INS69 INS69 INS69 INS42 INS8 MOV8 INS9 INS43 INS39 INS39 INS43 INS60 INS21 INS42 INS42 INS39 INS59 INS32 INS42 INS85 INS32 INS42 INS42 INS42 INS34 INS40 INS42 INS42 INS42 INS45