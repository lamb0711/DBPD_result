JCR-2014 Jcr2Spi: Warning upon reloading property values

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@752414 13f79535-47bb-0310-9956-ffa450edef68

-            // transient changes, simply return diff to indicate if this state
-            // was internally changed.
+            // transient changes, return the differ and postpone the effort of
+            // calculating the diff (the test if this state got internally changed)).
+                result.dispose();
-            discarded = true;
-            if (values != null) {
+            if (!discarded && values != null) {
+                discarded = true;
-        private final PropertyData thisData;
-        private final PropertyData thatData;
-        PropertyDiffer(PropertyData thisData, PropertyData thatData) {
+        private final PropertyData oldData;
+        private final PropertyData newData;
+
+        PropertyDiffer(PropertyData oldData, PropertyData newData) {
-            this.thisData = thisData;
-            this.thatData = thatData;
+            this.oldData = oldData;
+            this.newData = newData;
-            if (thisData.discarded || thatData.discarded) {
-                log.warn("Property data has been discarded");
+            if (oldData.discarded || newData.discarded) {
+                // cannot calculate the diff any more -> return true.
+                String msg = " Diff cannot be calculated: " + ((oldData.discarded) ? "Old property data" : "New property data") + " have already been discarded.";
+                log.debug(msg);
-            return diff(thisData, thatData);
+            return diff(oldData, newData);
+        }
+
+        public void dispose() {
+            oldData.discardValues();

MOV44 INS31 MOV43 MOV43 INS83 INS39 INS42 INS8 UPD42 UPD42 UPD42 UPD42 INS21 INS27 INS32 INS38 MOV27 MOV21 UPD42 UPD42 UPD40 UPD40 INS60 UPD42 UPD42 INS42 INS42 INS21 INS42 UPD42 UPD42 INS43 INS59 INS32 INS42 INS42 INS27 UPD42 INS42 INS42 INS42 INS45 INS36 INS45 INS16 INS36 INS45 INS45 INS40 DEL45