JCR-190: Caching in QueryHandler does not scale well

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@234492 13f79535-47bb-0310-9956-ffa450edef68

+     * Shared document number cache across all persistent indexes.
+     */
+    private final DocNumberCache cache;
+
+    /**
+        this.cache = new DocNumberCache(handler.getCacheSize());
+
-                PersistentIndex index = new PersistentIndex(indexNames.getName(i), sub, false, handler.getAnalyzer());
+                PersistentIndex index = new PersistentIndex(indexNames.getName(i),
+                        sub, false, handler.getAnalyzer(), cache);
-                IndexReader[] readers = new IndexReader[indexes.size() + 1];
+                ReadOnlyIndexReader[] readers = new ReadOnlyIndexReader[indexes.size() + 1];
-                multiReader = new CachingMultiReader(readers);
+                multiReader = new CachingMultiReader(readers, cache);
-            log.info("Committing in-memory index");
+            long time = System.currentTimeMillis();
+            time = System.currentTimeMillis() - time;
+            log.info("Committed in-memory index in " + time + "ms.");
-            PersistentIndex index = new PersistentIndex(name, sub, true, handler.getAnalyzer());
+            PersistentIndex index = new PersistentIndex(name, sub, true,
+                    handler.getAnalyzer(), cache);
-            PersistentIndex index = new PersistentIndex(name, sub, true, handler.getAnalyzer());
+            PersistentIndex index = new PersistentIndex(name, sub, true,
+                    handler.getAnalyzer(), cache);
-        PersistentIndex index = new PersistentIndex(name, sub, true, handler.getAnalyzer());
+        PersistentIndex index = new PersistentIndex(name, sub, true,
+                handler.getAnalyzer(), cache);

INS23 INS29 INS83 INS83 INS43 INS59 INS65 INS42 INS42 INS21 INS66 INS7 MOV21 MOV43 INS22 INS14 INS60 INS21 INS52 INS42 INS43 INS32 INS39 INS59 INS7 MOV43 MOV43 MOV43 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS27 INS27 UPD5 INS42 INS42 INS32 INS42 INS45 INS42 INS45 MOV43 INS42 MOV43 INS42 UPD43 INS42 INS42 INS42 UPD42 UPD5 INS42 UPD43 UPD42 DEL45