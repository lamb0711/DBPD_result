- add commons-codec dependency to client project.xml
- add concurrent dependency to jcr2spi project.xml
- remove events again from operation methods on RepositoryService.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@472888 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.jcr2spi.WorkspaceManager;
-import org.apache.jackrabbit.spi.ItemId;
+import org.apache.jackrabbit.spi.EventFilter;
+import org.apache.jackrabbit.name.Path;
+import javax.jcr.UnsupportedRepositoryOperationException;
+import java.util.Collections;
-    public WorkspaceItemStateManager(ItemStateFactory isf, IdFactory idFactory) {
+    private final Collection eventFilter;
+
+    public WorkspaceItemStateManager(WorkspaceManager wspManager, ItemStateFactory isf, IdFactory idFactory) {
+        EventFilter filter = null;
+        try {
+            // todo for now listen to everything
+            filter = wspManager.createEventFilter(Event.ALL_TYPES, Path.ROOT, true, null, null, false);
+        } catch (UnsupportedRepositoryOperationException e) {
+            // repository does not support observation
+        }
+        this.eventFilter = filter == null ? Collections.EMPTY_LIST : Collections.singletonList(filter);
+    public Collection getEventFilters() {
+        return eventFilter;
+    }
+
-    /**
-     *
-     * @param eventBundle
-     * @param changeLog
-     */
-    public void onEvent(EventBundle eventBundle, ChangeLog changeLog) {
-        if (changeLog == null) {
-            throw new IllegalArgumentException("ChangeLog must not be null.");
-        }
-        Collection evs = getEventCollection(eventBundle);
-        // TODO: make sure, that events only contain events related to the modifications submitted with the changelog.
-
-        // inform the changelog target state about the transient modifications
-        // that have been persisted now: NEW-states will be connected to their
-        // overlayed state, EXISTING_REMOVED states will be definitely removed,
-        // EXISTING_MODIFIED states are merged with their workspace-state.
-        Set processedIds = changeLog.getTarget().refresh(changeLog);
-        for (Iterator it = evs.iterator(); it.hasNext();) {
-            ItemId evId = ((Event)it.next()).getItemId();
-            if (processedIds.contains(evId)) {
-                it.remove();
-            }
-        }
-
-        // all events not covered by the changelog must not be handled on the
-        // session-states -> treat the same way as events returned by
-        // workspace operations.
-        pushEvents(evs);
-    }
-

INS26 INS26 INS26 INS26 INS40 UPD40 INS40 INS40 INS40 INS23 INS31 INS31 INS83 INS83 INS43 INS59 MOV83 UPD42 MOV42 MOV44 MOV44 MOV44 INS8 INS83 MOV43 INS42 INS8 INS42 INS42 UPD43 UPD42 MOV46 MOV60 INS54 INS21 INS41 UPD42 UPD43 INS8 INS12 INS7 INS42 UPD42 UPD42 INS33 INS21 INS44 INS8 INS22 INS16 INS7 INS43 INS42 INS52 INS42 INS27 INS40 INS32 INS42 INS32 UPD42 MOV42 INS42 INS33 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 INS40 INS40 INS9 INS33 INS33 INS9 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL83 DEL42 DEL8 DEL31 DEL42 DEL65 DEL42 DEL65 DEL29 DEL39 DEL42 DEL43 DEL42 DEL44 DEL42 DEL33 DEL27 DEL42 DEL43 DEL45 DEL14 DEL53 DEL8 DEL25 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL43 DEL42 DEL32 DEL59 DEL58 DEL42 DEL42 DEL32 DEL43 DEL42 DEL42 DEL43 DEL42 DEL42 DEL32 DEL11 DEL36 DEL42 DEL32 DEL59 DEL60 DEL32 DEL42 DEL42 DEL32 DEL21 DEL8 DEL25 DEL8 DEL24 DEL42 DEL42 DEL32 DEL21 DEL8 DEL31