JCR-193, JCR-216, JCR-203, JCR 184 + various minor fixes

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@293331 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.util.Text;
+import javax.jcr.Item;
-     * @param setProperties
-     * @param removePropertyNames
-     * @throws DavException
-    public void alterProperties(DavPropertySet setProperties,
+    public MultiStatusResponse alterProperties(DavPropertySet setProperties,
-                String[] hrefs = new String[] { getLocatorFromResourcePath(ItemResourceConstants.VERSIONSTORAGE_PATH).getHref(true)};
+                String[] hrefs = new String[] {
+                    getLocatorFromItemPath(ItemResourceConstants.VERSIONSTORAGE_PATH).getHref(true)
+                };
-        if (href.startsWith(prefix)) {
-            href = href.substring(prefix.length());
-        }
-            if (getRepositorySession().itemExists(loc.getResourcePath())) {
+            if (getRepositorySession().itemExists(loc.getJcrPath())) {
-     * Build a <code>DavResourceLocator</code> from the given resource path.
+     * Build a <code>DavResourceLocator</code> from the given itemPath path.
-     * @param resourcePath
+     * @param itemPath
-    protected DavResourceLocator getLocatorFromResourcePath(String resourcePath) {
-        DavResourceLocator loc = locator.getFactory().createResourceLocator(locator.getPrefix(), locator.getWorkspacePath(), resourcePath);
+    protected DavResourceLocator getLocatorFromItemPath(String itemPath) {
+        DavResourceLocator loc = locator.getFactory().createResourceLocator(locator.getPrefix(), locator.getWorkspacePath(), itemPath, false);
-     * Retrieve the name/label of a repository item from the given href by
-     * splitting of the part after the last slash. If the removeIndex
-     * flag is set to true, any trailing index (e.g. '[1]') will be removed.
+     * Build a new {@link DavResourceLocator} from the given repository item.
-     * @param resourceHref
-     * @param removeIndex
-     * @return the name of the item
+     * @param repositoryItem
+     * @return a new locator for the specified item.
+     * @see #getLocatorFromItemPath(String)
-    protected static String getResourceName(String resourceHref, boolean removeIndex) {
-        if (resourceHref == null) {
-            return resourceHref;
-        }
-
-        // cut the extension
-        int pos = resourceHref.lastIndexOf('.');
-        if (pos > 0) {
-            resourceHref = resourceHref.substring(pos+1);
-        } else if (resourceHref.endsWith("/")) {
-            resourceHref = resourceHref.substring(0, resourceHref.length()-1);
-        }
-
-        // retrieve the last part of the path
-        String name = Text.getName(resourceHref);
-        // remove index
-        if (removeIndex) {
-            if (name.endsWith("]")) {
-                name = name.substring(0, name.lastIndexOf('['));
+    protected DavResourceLocator getLocatorFromItem(Item repositoryItem) {
+        String itemPath = null;
+        try {
+            if (repositoryItem != null) {
+                itemPath = repositoryItem.getPath();
+        } catch (RepositoryException e) {
+            // ignore: should not occur
+            log.warn(e.getMessage());
-        return name;
+        return getLocatorFromItemPath(itemPath);

MOV26 UPD40 INS43 UPD42 UPD43 UPD42 INS44 INS42 MOV43 UPD42 INS65 INS65 UPD42 INS43 UPD42 MOV42 INS54 UPD66 UPD42 INS42 UPD66 MOV66 INS65 INS66 UPD42 UPD66 INS68 INS42 MOV43 INS8 INS12 INS32 UPD42 MOV42 INS42 INS69 UPD42 INS33 MOV25 INS44 INS8 INS42 INS42 UPD42 INS9 MOV43 UPD27 MOV8 INS43 INS42 MOV21 UPD42 INS33 UPD42 MOV42 INS32 MOV5 UPD42 UPD42 MOV42 UPD42 MOV42 MOV32 UPD42 INS32 UPD42 UPD42 MOV5 UPD42 MOV42 UPD42 MOV42 UPD42 DEL42 DEL65 DEL42 DEL65 DEL42 DEL65 DEL39 DEL42 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL42 DEL42 DEL32 DEL32 DEL7 DEL21 DEL8 DEL25 DEL66 DEL66 DEL65 DEL65 DEL83 DEL42 DEL44 DEL39 DEL44 DEL42 DEL33 DEL27 DEL42 DEL41 DEL8 DEL25 DEL39 DEL42 DEL42 DEL13 DEL32 DEL34 DEL42 DEL42 DEL34 DEL32 DEL34 DEL27 DEL32 DEL42 DEL42 DEL42 DEL42 DEL34 DEL27 DEL32 DEL7 DEL21 DEL8 DEL42 DEL42 DEL45 DEL32 DEL25 DEL13 DEL42 DEL34 DEL32 DEL7 DEL42 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL42 DEL45 DEL32 DEL8 DEL25 DEL8 DEL25 DEL42