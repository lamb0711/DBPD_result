JCR-1775: Transaction-safe versioning

Aggregate virtual node reference updates by using full ChangeLogs instead of individual references.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@708909 13f79535-47bb-0310-9956-ffa450edef68

+
+import java.util.ArrayList;
+import java.util.Collection;
+        ChangeLog references = new ChangeLog();
+
-                        addVirtualReference(prop.getPropertyId(), refsId);
+                        addVirtualReference(
+                                references, prop.getPropertyId(), refsId);
-                        removeVirtualReference(oldProp.getPropertyId(), refsId);
+                        removeVirtualReference(
+                                references, oldProp.getPropertyId(), refsId);
-                        addVirtualReference(newProp.getPropertyId(), refsId);
+                        addVirtualReference(
+                                references, newProp.getPropertyId(), refsId);
-                        removeVirtualReference(prop.getPropertyId(), refsId);
+                        removeVirtualReference(
+                                references, prop.getPropertyId(), refsId);
+
+        virtualProvider.setNodeReferences(references);
-    private void addVirtualReference(PropertyId sourceId,
-                                     NodeReferencesId refsId)
+    private void addVirtualReference(
+            ChangeLog references, PropertyId sourceId, NodeReferencesId refsId)
-        NodeReferences refs = virtualProvider.getNodeReferences(refsId);
+        NodeReferences refs = references.get(refsId);
+        if (refs == null) {
+            refs = virtualProvider.getNodeReferences(refsId);
+        }
-            virtualProvider.setNodeReferences(refs);
+            references.modified(refs);
-    private void removeVirtualReference(PropertyId sourceId,
-                                        NodeReferencesId refsId)
+    private void removeVirtualReference(
+            ChangeLog references, PropertyId sourceId, NodeReferencesId refsId)
-        NodeReferences refs = virtualProvider.getNodeReferences(refsId);
+        NodeReferences refs = references.get(refsId);
+        if (refs == null) {
+            refs = virtualProvider.getNodeReferences(refsId);
+        }
-            virtualProvider.setNodeReferences(refs);
+            references.modified(refs);

INS26 INS26 INS40 INS40 INS44 INS44 INS60 INS21 INS43 INS42 INS25 INS43 INS42 INS25 INS43 INS59 INS32 INS42 INS27 INS8 INS42 INS27 INS8 INS42 INS42 INS14 INS42 INS42 INS42 INS32 INS42 INS33 INS21 INS32 INS42 INS33 INS21 INS43 INS42 INS42 INS42 INS7 INS42 INS42 INS42 INS7 INS42 INS42 MOV32 UPD42 UPD42 INS42 MOV32 UPD42 UPD42 INS42 INS42 INS42 INS42