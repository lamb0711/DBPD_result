JCR-2836: Unclosed threads in Jackrabbit

Remove the use of ThreadLocal variables in PerQueryCache to avoid leaking memory in container environments.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1055117 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Map;
+import java.util.WeakHashMap;
+
-    /**
-     * The key in the per-query-cache that identifies the read count.
-     */
-    private static final Object READ_COUNT = new Object();
+    private static final Map<Thread, Long> counts =
+        new WeakHashMap<Thread, Long>();
-    public static long getReads() {
-        Long value = (Long) PerQueryCache.getInstance().get(IOCounters.class,  READ_COUNT);
-        if (value == null) {
-            value = 0L;
-        }
-        return value;
+    public static synchronized long getReads() {
+        Long count = counts.get(Thread.currentThread());
+        return count != null ? count : 0;
-    public static void incrRead() {
-        PerQueryCache cache = PerQueryCache.getInstance();
-        Long value = (Long) cache.get(IOCounters.class,  READ_COUNT);
-        if (value == null) {
-            value = 0L;
-        }
-        cache.put(IOCounters.class, READ_COUNT, value + 1);
+    public static synchronized void incrRead() {
+        counts.put(Thread.currentThread(), getReads() + 1);

INS26 INS26 INS40 INS40 INS74 INS83 INS83 INS43 INS43 MOV43 UPD42 INS41 UPD42 MOV42 INS42 INS74 MOV43 INS16 INS43 INS43 MOV43 UPD42 INS32 INS27 INS42 INS34 UPD42 INS32 UPD42 MOV42 INS42 UPD42 MOV42 MOV42 INS32 UPD42 MOV42 MOV33 INS42 UPD42 MOV42 INS32 INS42 UPD42 MOV42 INS42 DEL66 DEL65 DEL29 DEL43 DEL43 DEL42 DEL32 DEL42 DEL43 DEL57 DEL32 DEL11 DEL27 DEL42 DEL34 DEL7 DEL21 DEL8 DEL25 DEL42 DEL41 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL43 DEL42 DEL42 DEL42 DEL43 DEL57 DEL42 DEL32 DEL11 DEL59 DEL60 DEL42 DEL33 DEL27 DEL42 DEL34 DEL7 DEL21 DEL8 DEL25 DEL42 DEL43 DEL57 DEL42