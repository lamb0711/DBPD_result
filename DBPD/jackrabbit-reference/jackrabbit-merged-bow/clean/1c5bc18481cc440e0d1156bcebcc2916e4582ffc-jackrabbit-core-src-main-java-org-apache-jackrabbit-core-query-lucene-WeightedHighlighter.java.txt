JCR-2272: Update branch to match latest trunk.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/branches/JCR-2272@1176340 13f79535-47bb-0310-9956-ffa450edef68

-                                   Set<Term> queryTerms,
+                                   Set<Term[]> queryTerms,
-                                   Set<Term> queryTerms,
+                                   Set<Term[]> queryTerms,
-        PriorityQueue bestFragments = new FragmentInfoPriorityQueue(maxFragments);
+        PriorityQueue<FragmentInfo> bestFragments = new FragmentInfoPriorityQueue(maxFragments);
-                    sb.append(text.substring(lastOffsetInfo.getEndOffset(), oi.getStartOffset()));
+                    sb.append(escape(text.substring(
+                            lastOffsetInfo.getEndOffset(), oi.getStartOffset())));
-                sb.append(text.substring(oi.getStartOffset(), oi.getEndOffset()));
+                sb.append(escape(text.substring(oi.getStartOffset(),
+                        oi.getEndOffset())));
-            limit = Math.min(text.length(), fi.getStartOffset() - len + (surround * 2));
+            limit = Math.min(text.length(), fi.getStartOffset() - len
+                    + (surround * 2));
-    private static int startFragment(StringBuffer sb, String text, int offset, int limit) {
+    private int startFragment(StringBuffer sb, String text, int offset, int limit) {
-            sb.append(text.substring(0, offset));
+            sb.append(escape(text.substring(0, offset)));
-        sb.append(intro).append(text.substring(start, offset));
+        sb.append(intro).append(escape(text.substring(start, offset)));
-    private static void endFragment(StringBuffer sb, String text, int offset, int limit) {
+    private void endFragment(StringBuffer sb, String text, int offset, int limit) {
-            sb.append(text.substring(offset));
+            sb.append(escape(text.substring(offset)));
-        sb.append(text.substring(offset, end)).append(" ...");
+        sb.append(escape(text.substring(offset, end))).append(" ...");
-    private static class FragmentInfoPriorityQueue extends PriorityQueue {
+    private static class FragmentInfoPriorityQueue extends PriorityQueue<FragmentInfo> {
-        protected boolean lessThan(Object a, Object b) {
-            FragmentInfo infoA = (FragmentInfo) a;
-            FragmentInfo infoB = (FragmentInfo) b;
+        protected boolean lessThan(FragmentInfo infoA, FragmentInfo infoB) {

INS74 UPD74 UPD74 MOV43 MOV43 INS5 INS5 INS74 INS32 MOV43 INS42 MOV43 INS42 MOV43 INS85 MOV43 INS85 MOV43 MOV43 INS32 MOV32 MOV32 INS42 INS45 INS32 INS42 MOV32 INS32 INS42 INS42 INS42 MOV32 INS42 INS42 MOV32 UPD42 INS32 UPD42 UPD42 INS42 INS42 MOV32 INS32 UPD42 INS42 INS42 MOV32 UPD42 DEL42 DEL42 DEL83 DEL42 DEL83 DEL42 DEL42 DEL45 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL42 DEL42 DEL11 DEL59 DEL60 DEL42 DEL42 DEL11 DEL59 DEL60