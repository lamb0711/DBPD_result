JCR-2977 : AccessControlManager#getApplicablePolicy should check for colliding rep:policy node

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1128175 13f79535-47bb-0310-9956-ffa450edef68

-            // rep:AccessControllable mixin set (e.g. due to a lock)
-            String mixin = session.getJCRName(NT_REP_ACCESS_CONTROLLABLE);
-            PrivilegeManager privMgr = ((JackrabbitWorkspace) session.getWorkspace()).getPrivilegeManager();
-            if (controlledNode.isNodeType(mixin) || controlledNode.canAddMixin(mixin)) {
-                acl = new ACLTemplate(nodePath, session.getPrincipalManager(),
-                        privMgr, session.getValueFactory(), session);
+            // rep:AccessControllable mixin set (e.g. due to a lock) or
+            // has colliding rep:policy child node set.
+            if (controlledNode.hasNode(N_POLICY)) {
+                // policy child node without node being access controlled
+                log.warn("Colliding rep:policy child without node being access controllable ({}).", nodePath);
+            } else {
+                String mixin = session.getJCRName(NT_REP_ACCESS_CONTROLLABLE);
+                PrivilegeManager privMgr = ((JackrabbitWorkspace) session.getWorkspace()).getPrivilegeManager();
+                if (controlledNode.isNodeType(mixin) || controlledNode.canAddMixin(mixin)) {
+                    acl = new ACLTemplate(nodePath, session.getPrincipalManager(),
+                            privMgr, session.getValueFactory(), session);
+                } else {
+                    log.warn("Node {} cannot be made access controllable.", nodePath);
+                }
-}
+}

INS8 INS25 INS32 INS8 MOV8 INS42 INS42 INS42 INS21 INS32 INS8 INS42 INS42 INS45 INS42 INS21 INS32 INS42 INS42 INS45 INS42