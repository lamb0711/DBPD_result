JCR-1747: org.apache.jackrabbit.core.query.lucene.SearchIndex with in-memory lucene index

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@718218 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.lucene.store.Directory;
+import org.apache.jackrabbit.core.query.lucene.directory.IndexOutputStream;
+import org.apache.jackrabbit.core.query.lucene.directory.IndexInputStream;
-import java.io.File;
-import java.io.FileInputStream;
-import java.io.FileOutputStream;
+     * Default name of the redo log file
+     */
+    private static final String REDO_LOG = "redo.log";
+
+    /**
-     * The log file
+     * The directory where the log file is stored.
-    private final File logFile;
+    private final Directory dir;
-     * Creates a new <code>RedoLog</code> instance based on the file
-     * <code>logFile</code>
-     * @param log the redo log file.
+     * Creates a new <code>RedoLog</code> instance, which stores its log in the
+     * given directory.
+     *
+     * @param dir the directory where the redo log file is located.
+     * @throws IOException if an error occurs while reading the redo log.
-    RedoLog(File log) throws IOException {
-        this.logFile = log;
-        // create the log file if not there
-        if (!log.exists()) {
-            log.getParentFile().mkdirs();
-            log.createNewFile();
-        }
+    RedoLog(Directory dir) throws IOException {
+        this.dir = dir;
-        // truncate file
-        new FileOutputStream(logFile).close();
+        dir.deleteFile(REDO_LOG);
-            OutputStream os = new FileOutputStream(logFile, true);
+            OutputStream os = new IndexOutputStream(dir.createOutput(REDO_LOG));
-        InputStream in = new FileInputStream(logFile);
+        if (!dir.fileExists(REDO_LOG)) {
+            return;
+        }
+        InputStream in = new IndexInputStream(dir.openInput(REDO_LOG));

MOV26 MOV26 MOV26 MOV23 UPD40 UPD40 UPD40 INS23 INS83 UPD43 INS29 INS83 INS83 INS43 INS59 UPD42 UPD42 INS45 INS65 INS42 INS42 INS65 UPD43 UPD42 INS25 UPD66 INS66 UPD66 UPD66 UPD42 UPD66 INS42 INS66 UPD42 INS38 INS8 UPD42 INS42 INS42 UPD42 INS32 INS41 UPD42 INS42 INS42 INS42 UPD43 INS32 UPD42 INS42 INS42 INS42 UPD43 INS32 UPD42 INS42 INS42 INS42 DEL42 DEL42 DEL32 DEL38 DEL42 DEL42 DEL32 DEL42 DEL32 DEL21 DEL42 DEL42 DEL32 DEL21 DEL8 DEL25 DEL42 DEL43 DEL42 DEL14 DEL42 DEL9 DEL42