JCR-2321: ZombieHierarchyManager can return wrong child node entries for replaced nodes


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@820337 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Iterator;
+
-        // check removed child node entries first
-        for (ChildNodeEntry entry : parent.getRemovedChildNodeEntries()) {
-            if (entry.getName().equals(name)
-                    && entry.getIndex() == index) {
-                return entry;
+        // first look for the entry in the current child node entry list
+        ChildNodeEntry entry = super.getChildNodeEntry(parent, name, index);
+        if (entry == null) {
+            // if not found, we need to look for a removed child node entry
+            for (ChildNodeEntry candidate : parent.getRemovedChildNodeEntries()) {
+                if (candidate.getName().equals(name)
+                        && candidate.getIndex() == index) {
+                    entry = candidate;
+                    break;
+                }
-        // no matching removed child node entry found in parent,
-        // delegate to base class
-        return super.getChildNodeEntry(parent, name, index);
+        return entry;
-        // check removed child node entries first
-        for (ChildNodeEntry entry : parent.getRemovedChildNodeEntries()) {
-            if (entry.getId().equals(id)) {
-                return entry;
+        // first look for the entry in the current child node entry list
+        ChildNodeEntry entry = super.getChildNodeEntry(parent, id);
+        if (entry == null) {
+            // if not found, we need to look for a removed child node entry
+            for (ChildNodeEntry candidate : parent.getRemovedChildNodeEntries()) {
+                if (candidate.getId().equals(id)) {
+                    entry = candidate;
+                    break;
+                }
-        // no matching removed child node entry found in parent,
-        // delegate to base class
-        return super.getChildNodeEntry(parent, id);
+        return entry;

INS26 INS40 INS8 INS60 INS25 INS60 INS25 MOV41 MOV43 INS59 INS27 INS8 MOV42 MOV43 INS59 INS27 INS8 INS42 MOV48 INS42 INS33 MOV70 INS42 MOV48 INS42 INS33 MOV70 INS43 INS42 INS43 INS42 INS42 INS42 INS21 INS10 INS21 INS10 INS7 UPD42 INS7 UPD42 UPD42 INS42 INS42 INS42 INS42 DEL42 DEL42 DEL41 DEL8