JCR-1066: Exclude system index for queries that restrict the result set to nodetypes not availble in the "jcr:system" subtree

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@570095 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.core.query.AndQueryNode;
-import org.apache.jackrabbit.core.query.OrQueryNode;
+import org.apache.jackrabbit.core.query.QueryNodeFactory;
-    private final QueryRootNode root = new QueryRootNode();
+    private final QueryRootNode root;
+     * The query node factory.
+     */
+    private final QueryNodeFactory factory;
+
+    /**
+     * @param factory   the query node factory.
-    private XPathQueryBuilder(String statement, NamespaceResolver resolver)
+    private XPathQueryBuilder(String statement,
+                              NamespaceResolver resolver,
+                              QueryNodeFactory factory)
+        this.factory = factory;
+        this.root = factory.createQueryRootNode();
-     * Creates a <code>QueryNode</code> tree from a XPath statement.
+     * Creates a <code>QueryNode</code> tree from a XPath statement using the
+     * passed query node <code>factory</code>.
+     * @param factory   the query node factory.
-                                            NamespaceResolver resolver)
+                                            NamespaceResolver resolver,
+                                            QueryNodeFactory factory)
-        return new XPathQueryBuilder(statement, resolver).getRootNode();
+        return new XPathQueryBuilder(statement, resolver, factory).getRootNode();
-                                = new RelationQueryNode(queryNode,
+                                = factory.createRelationQueryNode(queryNode,
-                                new RelationQueryNode(queryNode,
+                                factory.createRelationQueryNode(queryNode,
-                        RelationQueryNode tmp = new RelationQueryNode(
+                        RelationQueryNode tmp = factory.createRelationQueryNode(
-                        NodeTypeQueryNode nodeType = new NodeTypeQueryNode(loc, nt);
+                        NodeTypeQueryNode nodeType = factory.createNodeTypeQueryNode(loc, nt);
-                QueryNode orQueryNode = new OrQueryNode(parent);
+                QueryNode orQueryNode = factory.createOrQueryNode(parent);
-                QueryNode andQueryNode = new AndQueryNode(parent);
+                QueryNode andQueryNode = factory.createAndQueryNode(parent);
-                root.setOrderNode(new OrderQueryNode(root));
+                root.setOrderNode(factory.createOrderQueryNode(root));
-                queryNode = new LocationStepQueryNode(parent, null, descendant);
+                queryNode = factory.createLocationStepQueryNode(parent);
+                queryNode.setNameTest(null);
+                queryNode.setIncludeDescendants(descendant);
-        final RelationQueryNode rqn = new RelationQueryNode(queryNode, type);
+        final RelationQueryNode rqn = factory.createRelationQueryNode(queryNode, type);
-        root.setLocationNode(new PathQueryNode(root));
+        root.setLocationNode(factory.createPathQueryNode(root));
-                    QueryNode not = new NotQueryNode(queryNode);
+                    QueryNode not = factory.createNotQueryNode(queryNode);
-                            TextsearchQueryNode contains = new TextsearchQueryNode(
+                            TextsearchQueryNode contains = factory.createTextsearchQueryNode(
-                        RelationQueryNode like = new RelationQueryNode(queryNode, RelationQueryNode.OPERATION_LIKE);
+                        RelationQueryNode like = factory.createRelationQueryNode(
+                                queryNode, RelationQueryNode.OPERATION_LIKE);
-                        DerefQueryNode derefNode = new DerefQueryNode(pathNode, null, false);
+                        DerefQueryNode derefNode = factory.createDerefQueryNode(pathNode, null, false);
-                        relNode.addOperand(new PropertyFunctionQueryNode(relNode, PropertyFunctionQueryNode.LOWER_CASE));
+                        relNode.addOperand(factory.createPropertyFunctionQueryNode(
+                                relNode, PropertyFunctionQueryNode.LOWER_CASE));
-                        relNode.addOperand(new PropertyFunctionQueryNode(relNode, PropertyFunctionQueryNode.UPPER_CASE));
+                        relNode.addOperand(factory.createPropertyFunctionQueryNode(
+                                relNode, PropertyFunctionQueryNode.UPPER_CASE));
-                        RelationQueryNode rel = new RelationQueryNode(
+                        RelationQueryNode rel = factory.createRelationQueryNode(

MOV26 UPD40 INS23 INS29 INS83 INS83 INS43 INS59 INS44 INS44 INS65 INS42 INS42 INS65 INS43 INS42 INS21 INS21 INS65 INS43 INS42 INS66 INS42 INS66 INS42 INS7 INS7 UPD66 INS66 INS42 INS66 INS42 INS22 INS42 INS22 INS32 MOV43 MOV43 INS32 INS32 INS52 INS42 INS52 INS42 INS42 INS42 INS42 INS32 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS21 INS21 INS21 INS7 INS32 INS32 MOV43 MOV42 INS32 INS42 INS42 INS33 INS42 INS42 INS42 MOV43 INS32 INS42 INS42 INS42 INS32 INS32 INS32 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS40 INS42 INS42 INS42 INS40 INS42 INS42 INS33 INS40 INS42 INS42 INS42 MOV43 MOV43 INS32 INS32 INS42 INS42 INS42 INS40 INS42 INS42 INS42 MOV32 INS8 INS25 MOV8 MOV8 MOV43 MOV27 INS8 MOV8 INS32 MOV60 INS21 MOV21 MOV27 MOV8 INS42 INS42 INS42 INS33 INS9 INS32 INS42 INS42 INS32 INS42 INS42 INS42 INS40 INS32 MOV43 INS42 INS42 INS42 INS40 INS32 INS42 INS42 INS42 INS40 DEL40 DEL26 DEL42 DEL43 DEL14 DEL42 DEL43 DEL42 DEL40 DEL14 DEL42 DEL43 DEL42 DEL40 DEL14 DEL33 DEL40 DEL14 DEL42 DEL43 DEL42 DEL42 DEL14 DEL42 DEL43 DEL42 DEL14 DEL42 DEL43 DEL42 DEL14 DEL42 DEL43 DEL42 DEL14 DEL42 DEL43 DEL42 DEL33 DEL42 DEL14 DEL7 DEL21 DEL42 DEL43 DEL42 DEL42 DEL14 DEL42 DEL43 DEL42 DEL14 DEL42 DEL43 DEL42 DEL14 DEL42 DEL43 DEL42 DEL14 DEL42 DEL43 DEL42 DEL40 DEL14 DEL42 DEL43 DEL42 DEL33 DEL9 DEL14 DEL42 DEL43 DEL42 DEL40 DEL14 DEL42 DEL42 DEL42 DEL43 DEL42 DEL40 DEL14 DEL32 DEL21 DEL8 DEL25 DEL8 DEL42 DEL43 DEL42 DEL40 DEL14