JCR-1084: Maintain a stable ordering of properties in XML export
    - Fix based on a patch from Fabrizio Giustina

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@591404 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Iterator;
+import java.util.SortedMap;
+import java.util.TreeMap;
+        // Collect all properties (and sort them, see JCR-1084)
+        SortedMap properties = new TreeMap();
+        PropertyIterator propIter = node.getProperties();
+        while (propIter.hasNext()) {
+            Property property = propIter.nextProperty();
+            properties.put(property.getName(), property);
+        }
+
-        // jcr:primaryType
-        if (node.hasProperty(jcrPrimaryType)) {
-            process(node.getProperty(jcrPrimaryType), level + 1);
+        if (properties.containsKey(jcrPrimaryType)) {
+            process((Property) properties.remove(jcrPrimaryType), level + 1);
-            String msg = "internal error: missing jcr:primaryType property on node "
-                    + node.getPath();
-            log.debug(msg);
-            throw new RepositoryException(msg);
+            throw new RepositoryException(
+                    "Missing jcr:primaryType property: " + node.getPath());
-        // jcr:mixinTypes
-        if (node.hasProperty(jcrMixinTypes)) {
-            process(node.getProperty(jcrMixinTypes), level + 1);
+        if (properties.containsKey(jcrMixinTypes)) {
+            process((Property) properties.remove(jcrMixinTypes), level + 1);
-        // jcr:uuid
-        if (node.hasProperty(jcrUUID)) {
-            process(node.getProperty(jcrUUID), level + 1);
+        if (properties.containsKey(jcrUUID)) {
+            process((Property) properties.remove(jcrUUID), level + 1);
-        PropertyIterator propIter = node.getProperties();
-        while (propIter.hasNext()) {
-            Property prop = propIter.nextProperty();
-            String name = prop.getName();
-            if (jcrPrimaryType.equals(name)
-                    || jcrMixinTypes.equals(name)
-                    || jcrUUID.equals(name)) {
-                continue;
-            }
-            // serialize property
-            process(prop, level + 1);
+        Iterator iterator = properties.values().iterator();
+        while (iterator.hasNext()) {
+            process((Property) iterator.next(), level + 1);

INS26 INS26 INS26 INS40 INS40 INS40 MOV60 INS60 INS61 MOV60 INS61 INS43 INS59 MOV32 INS8 UPD43 INS32 INS8 INS42 INS42 INS14 MOV60 INS21 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 INS32 UPD42 MOV42 UPD42 MOV42 INS21 INS43 INS32 INS32 INS42 INS32 INS42 UPD42 INS42 INS42 INS32 INS42 INS11 MOV27 MOV27 INS11 INS11 MOV27 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 INS11 MOV27 INS42 INS42 INS43 INS32 UPD45 INS43 INS32 INS43 INS32 INS43 INS32 INS42 UPD42 MOV42 UPD42 MOV42 MOV42 INS42 UPD42 MOV42 UPD42 MOV42 MOV42 INS42 UPD42 MOV42 UPD42 MOV42 MOV42 INS42 UPD42 MOV42 UPD42 MOV42 DEL32 DEL42 DEL43 DEL42 DEL59 DEL60 DEL42 DEL42 DEL42 DEL32 DEL21 DEL42 DEL32 DEL32 DEL32 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL32 DEL27 DEL18 DEL8 DEL25 DEL42 DEL42 DEL32 DEL21 DEL8 DEL61