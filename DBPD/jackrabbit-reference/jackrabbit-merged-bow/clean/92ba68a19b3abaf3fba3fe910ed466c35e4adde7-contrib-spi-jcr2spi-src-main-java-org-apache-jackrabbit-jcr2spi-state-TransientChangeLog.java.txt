- Remove TransientItemStateListener
- Create property states and child node states on NodeState

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@430020 13f79535-47bb-0310-9956-ffa450edef68

+
+import javax.jcr.ItemExistsException;
-     * TODO: remove this method
+     * TODO: throw ItemExistsException? how to check?
+     * @see TransientItemStateManager#createNodeState(QName, String, QName, NodeState)
-    public NodeState createNodeState(NodeId id,
+    public NodeState createNodeState(QName nodeName,
+                                     String uuid,
-        // DIFF JACKRABBIT: not needed anymore
-        // check map; synchronized to ensure an entry is not created twice.
-//        synchronized (addedStates) {
-//            if (addedStates.containsKey(id) || modifiedStates.containsKey(id)) {
-//                String msg = "there's already a node state instance with id " + id;
-//                log.debug(msg);
-//                throw new ItemStateException(msg);
-//            }
-//
-//            NodeState state = new NodeState(id, nodeTypeName, parentId,
-//                    initialStatus, true);
-//            // put transient state in the map
-//            addedStates.put(id, state);
-//            return state;
-//        }
-
-        // TODO: replace with call to createNewNodeState() and finally remove method
-        return new NodeState(id, parent, nodeTypeName, ItemState.STATUS_NEW, true, this);
+        NodeState nodeState = createNewNodeState(nodeName, uuid, parent);
+        nodeState.setNodeTypeName(nodeTypeName);
+        parent.addChildNodeState(nodeState, uuid);
+        addedStates.add(nodeState);
+        nodeState.addListener(this);
+        return nodeState;
-     * TODO: remove this method
+     * @see TransientItemStateManager#createPropertyState(NodeState, QName)
-    public PropertyState createPropertyState(NodeState parentState, QName propName) {
-        PropertyId id = idFactory.createPropertyId(parentState.getNodeId(), propName);
-        return new PropertyState(id, parentState, ItemState.STATUS_NEW, true);
+    public PropertyState createPropertyState(NodeState parentState, QName propName)
+            throws ItemExistsException {
+        PropertyState propState = createNewPropertyState(propName, parentState);
+        parentState.addPropertyState(propState);
+        addedStates.add(propState);
+        propState.addListener(this);
+        return propState;

INS26 INS40 INS44 INS43 INS65 INS43 INS42 UPD43 UPD42 INS60 INS21 INS21 INS21 INS21 INS41 UPD65 UPD65 INS42 INS60 INS21 INS21 INS21 INS41 UPD66 INS68 INS42 UPD42 INS43 INS59 INS32 INS32 INS32 INS32 INS42 INS68 MOV43 INS59 INS32 INS32 INS32 INS42 INS42 INS42 INS69 INS69 INS69 INS69 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS52 INS42 INS42 INS69 INS69 INS42 INS32 MOV42 UPD42 MOV42 INS42 INS42 INS42 UPD42 MOV42 INS42 INS42 INS52 INS43 INS43 INS43 MOV43 INS42 INS42 INS42 INS42 INS43 INS43 INS42 UPD42 MOV42 UPD42 MOV42 INS42 INS42 INS42 INS42 INS42 DEL42 DEL42 DEL42 DEL40 DEL9 DEL52 DEL14 DEL41 DEL66 DEL42 DEL43 DEL42 DEL32 DEL32 DEL59 DEL60 DEL42 DEL42 DEL40 DEL9 DEL14 DEL41