JCR-3573: Improve token based login concurrency 

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1468965 13f79535-47bb-0310-9956-ffa450edef68

-    public synchronized static Credentials createToken(User user, SimpleCredentials credentials,
+    public static Credentials createToken(User user, SimpleCredentials credentials,
-            if (userNode.hasNode(TOKENS_NODE_NAME)) {
-                tokenParent = userNode.getNode(TOKENS_NODE_NAME);
-            } else {
-                tokenParent = userNode.addNode(TOKENS_NODE_NAME, TOKENS_NT_NAME);
+            if (!userNode.hasNode(TOKENS_NODE_NAME)) {
+                userNode.addNode(TOKENS_NODE_NAME, TOKENS_NT_NAME);
+                try {
+                    session.save();
+                } catch (RepositoryException e) {
+                    // may happen when .tokens node is created concurrently
+                    session.refresh(false);
+                }
+            tokenParent = userNode.getNode(TOKENS_NODE_NAME);

MOV21 INS38 INS8 MOV32 MOV21 INS54 MOV32 INS8 INS12 INS21 INS44 INS8 INS32 INS43 INS42 INS21 INS42 INS42 INS42 INS32 INS42 INS42 INS9 DEL83 DEL42 DEL7 DEL8 DEL8