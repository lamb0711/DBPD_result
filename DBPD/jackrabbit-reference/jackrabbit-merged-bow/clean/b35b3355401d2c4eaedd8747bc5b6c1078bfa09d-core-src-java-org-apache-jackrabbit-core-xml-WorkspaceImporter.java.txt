JCR-166: Versioned node importXML fails

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@209776 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.version.VersionManager;
-            VersionHistory hist = session.getVersionManager().createVersionHistory(session, node);
+            VersionManager vMgr = session.getVersionManager();
+            /**
+             * check if there's already a version history for that
+             * node; this would e.g. be the case if a versionable node
+             * had been exported, removed and re-imported with either
+             * IMPORT_UUID_COLLISION_REMOVE_EXISTING or
+             * IMPORT_UUID_COLLISION_REPLACE_EXISTING;
+             * otherwise create a new version history
+             */
+            VersionHistory vh = vMgr.getVersionHistory(session, node);
+            if (vh == null) {
+                vh = vMgr.createVersionHistory(session, node);
+            }
-                prop.setValues(new InternalValue[]{InternalValue.create(new UUID(hist.getUUID()))});
+                prop.setValues(new InternalValue[]{InternalValue.create(new UUID(vh.getUUID()))});
-                prop.setValues(new InternalValue[]{InternalValue.create(new UUID(hist.getRootVersion().getUUID()))});
+                prop.setValues(new InternalValue[]{InternalValue.create(new UUID(vh.getRootVersion().getUUID()))});
-                prop.setValues(new InternalValue[]{InternalValue.create(new UUID(hist.getRootVersion().getUUID()))});
+                prop.setValues(new InternalValue[]{InternalValue.create(new UUID(vh.getRootVersion().getUUID()))});
-

INS26 INS40 INS60 INS25 INS43 MOV43 INS59 INS27 INS8 INS42 UPD42 MOV32 INS42 INS32 INS42 INS33 INS21 INS42 INS42 INS42 INS42 INS7 INS42 INS32 INS42 INS42 INS42 INS42 UPD42 UPD42 UPD42 DEL42 DEL42 DEL42 DEL32