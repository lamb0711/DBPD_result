JCR-2575: Incorrect excerpt for index aggregates

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@924238 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Comparator;
+                        // make sure that fulltext fields are aligned properly
+                        // first all stored fields, then remaining
+                        List<Fieldable> fulltextFields = new ArrayList<Fieldable>();
+                        fulltextFields.addAll(removeFields(doc, FieldNames.FULLTEXT));
+                        Collections.sort(fulltextFields, new Comparator<Fieldable>() {
+                            public int compare(Fieldable o1, Fieldable o2) {
+                                return Boolean.valueOf(o2.isStored()).compareTo(o1.isStored());
+                            }
+                        });
+                        for (Fieldable f : fulltextFields) {
+                            doc.add(f);
+                        }
+     * Removes the fields with the given <code>name</code> from the
+     * <code>document</code> and returns them in a collection.
+     *
+     * @param document the document.
+     * @param name     the name of the fields to remove.
+     * @return the removed fields.
+     */
+    protected final Collection<Fieldable> removeFields(Document document,
+                                                 String name) {
+        List<Fieldable> fields = new ArrayList<Fieldable>();
+        fields.addAll(Arrays.asList(document.getFieldables(name)));
+        document.removeFields(FieldNames.FULLTEXT);
+        return fields;
+    }
+
+    /**

INS26 INS40 INS31 INS29 INS83 INS83 INS74 INS42 INS44 INS44 INS8 INS65 INS65 INS65 INS65 INS43 INS43 INS43 INS42 INS43 INS42 INS60 INS21 INS21 INS41 INS66 INS66 INS42 INS66 INS42 INS66 INS66 INS42 INS42 INS42 INS42 INS74 INS59 INS32 INS32 INS42 INS43 INS43 INS42 INS14 INS42 INS42 INS32 INS42 INS42 INS40 INS42 INS42 INS74 INS42 INS42 INS32 INS43 INS43 INS42 INS42 INS42 INS42 INS42 INS60 INS21 INS21 INS70 INS74 INS59 INS32 INS32 INS44 INS42 INS8 INS43 INS43 INS42 INS14 INS42 INS42 INS32 INS42 INS42 INS42 INS14 INS43 INS42 INS21 INS42 INS42 INS74 INS42 INS42 INS40 INS74 INS1 INS42 INS32 INS43 INS43 INS43 INS43 INS31 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS83 INS39 INS42 INS44 INS44 INS8 INS43 INS42 INS43 INS42 INS41 INS42 INS42 INS32 INS32 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS42 INS42