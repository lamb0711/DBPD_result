JCR-929: Under Heavy load in a Cluster HTTP Threads Block and stall requests


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@546038 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.core.cluster.ClusterOperation;
+        ClusterOperation operation = null;
+        boolean successful = false;
+
+        // Cluster is only informed about open-scoped locks
+        if (eventChannel != null && !isSessionScoped) {
+            operation = eventChannel.create(node.getNodeId(), isDeep, session.getUserID());
+        }
+
-                if (eventChannel != null) {
-                    eventChannel.locked(node.getNodeId(), isDeep, session.getUserID());
-                }
+                successful = true;
+            if (operation != null) {
+                operation.ended(successful);
+            }
+        ClusterOperation operation = null;
+        boolean successful = false;
+
+        if (eventChannel != null) {
+            operation = eventChannel.create(node.getNodeId());
+        }
+        
-                if (eventChannel != null) {
-                    eventChannel.unlocked(node.getNodeId());
-                }
+                successful = true;
-
+
+            if (operation != null) {
+                operation.ended(successful);
+            }

INS26 INS40 INS60 INS60 MOV25 INS60 INS60 MOV25 INS43 INS59 INS39 INS59 INS27 INS8 INS43 INS59 INS39 INS59 INS8 INS42 INS42 INS33 INS42 INS9 MOV27 INS38 MOV21 INS25 INS42 INS42 INS33 INS42 INS9 MOV21 INS25 INS42 INS7 INS27 INS8 INS7 INS27 INS8 INS42 MOV32 INS21 INS42 INS33 INS21 INS42 MOV32 INS21 INS42 INS33 INS21 UPD42 INS7 INS32 UPD42 INS7 INS32 INS42 INS9 INS42 INS42 INS42 INS42 INS9 INS42 INS42 INS42 DEL8 DEL8