JCR-2473 Cloning a tree containing shareable nodes into another workspace throws ItemExistsException

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@902110 13f79535-47bb-0310-9956-ffa450edef68

-        // precautionary measure in order to isolate it from concurrent 
+        // precautionary measure in order to isolate it from concurrent
+                    /* if this node is shareable and another node in the same shared set
+                     * has been already been copied and given a new uuid, use this one
+                     * (see section 14.5 of the specification)
+                     */
+                    if (shareable && refTracker.getMappedId(srcState.getNodeId()) != null) {
+                        NodeId newId = refTracker.getMappedId(srcState.getNodeId());
+                        NodeState sharedState = (NodeState) stateMgr.getItemState(newId);
+                        sharedState.addShare(destParentId);
+                        return sharedState;
+                    }
+
+                        if (shareable) {
+                            NodeState sharedState = (NodeState) stateMgr.getItemState(id);
+                            sharedState.addShare(destParentId);
+                            return sharedState;
+                        }

INS25 INS27 INS8 INS8 INS42 INS27 INS60 INS60 INS21 INS41 INS25 MOV53 INS32 INS33 INS43 INS59 INS43 INS59 INS32 INS42 INS42 MOV8 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS11 INS42 INS42 INS42 INS60 INS21 INS41 INS42 INS42 INS42 INS42 INS32 INS43 INS32 INS43 INS59 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS11 INS42 INS42 INS42 INS43 INS32 INS42 INS42 INS42 INS42