JCR-255 Workspace operations (copy/clone) do not handle references correctly

consolidated code that maintains/enforces referential integrity (RI):
SharedItemStateManager.store(ChangeLog) is now the only place where
RI is maintained and enforced

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@326916 13f79535-47bb-0310-9956-ffa450edef68

+import javax.jcr.ReferentialIntegrityException;
+
-     * Store a node references object
-     *
-     * @param refs node references object that should be stored
-     * @throws IllegalStateException if the manager is not in edit mode.
-     */
-    void store(NodeReferences refs) throws IllegalStateException;
-
-    /**
-     * @throws StaleItemStateException if at least one of the affected items
-     *                                 has become stale in the meantime 
-     * @throws ItemStateException      if the operation failed for another reason
-     * @throws IllegalStateException   if the manager is not in edit mode.
+     * @throws ReferentialIntegrityException if a new or modified REFERENCE
+     *                                       property refers to a non-existent
+     *                                       target or if a removed node is still
+     *                                       being referenced
+     * @throws StaleItemStateException       if at least one of the affected items
+     *                                       has become stale in the meantime
+     * @throws ItemStateException            if the operation failed for another reason
+     * @throws IllegalStateException         if the manager is not in edit mode.
-    void update() throws StaleItemStateException, ItemStateException,
-            IllegalStateException;
+    void update()
+            throws ReferentialIntegrityException, StaleItemStateException,
+            ItemStateException, IllegalStateException;

INS26 INS40 INS31 INS29 MOV39 MOV42 INS43 MOV43 MOV43 MOV43 MOV65 MOV65 MOV65 MOV65 MOV65 INS42 UPD42 INS66 INS66 UPD66 INS66 UPD66 UPD66 UPD66 UPD66 DEL66 DEL65 DEL42 DEL66 DEL65 DEL29 DEL39 DEL42 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL31 DEL29 DEL31