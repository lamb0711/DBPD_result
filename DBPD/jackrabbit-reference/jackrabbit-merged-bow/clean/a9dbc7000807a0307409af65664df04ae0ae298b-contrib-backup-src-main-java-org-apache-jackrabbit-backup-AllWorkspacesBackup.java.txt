JCR-442: Committed patch-060808-backup.txt from Nicolas.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@429606 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Enumeration;
+import java.util.zip.ZipEntry;
+import java.util.zip.ZipException;
- * @author ntoper
+ * This class allows the backup and restore of all the worskspaces.
-     * @param repo
-     * @param conf
-     * @throws RepositoryException 
-     * @throws LoginException 
+     * @param repo the repository
+     * @param conf the BackupConfig object holding all informations about the backup/restore operations
+     * @param login
+     * @param password
+     * @throws RepositoryException
+     * @throws LoginException
-    public AllWorkspacesBackup(RepositoryImpl repo, BackupConfig conf) throws LoginException, RepositoryException {
-        super(repo, conf);
+    public AllWorkspacesBackup(RepositoryImpl repo, BackupConfig conf, String login, String password) 
+                                                            throws LoginException, RepositoryException {
+        super(repo, conf, login, password);
-    
-    public AllWorkspacesBackup() {
+
+    /**
+     * Constructor used by BackupManager.
+     *
+     */
+    protected AllWorkspacesBackup() {
-    
+
-       
+       String login = this.getCredentials().getUserID();
+       String password = this.getCredentials().getPassword().toString();
+
-           WorkspaceBackup wspb = new WorkspaceBackup(this.repo, this.conf, allWsp[i]);
-           wspb.backup(h);           
-           
-           WorkspaceConfigBackup wspConfb = new WorkspaceConfigBackup(this.repo, this.conf, allWsp[i]);
+           WorkspaceBackup wspb = new WorkspaceBackup(this.getRepo(), this.getConf(), allWsp[i], login, password);
+           wspb.backup(h);
+           WorkspaceConfigBackup wspConfb = new WorkspaceConfigBackup(this.getRepo(), this.getConf(), allWsp[i], login, password);
-    public void restore(BackupIOHandler h) {
-        // TODO Auto-generated method stub
+    public void restore(BackupIOHandler h) throws ZipException, IOException, LoginException, RepositoryException {
+        //Get All workspaces name in the zip
+        Enumeration entries = h.getEntries();
+        while (entries.hasMoreElements()) {
+            String s = ((ZipEntry) entries.nextElement()).getName();
+            if (s.indexOf("export_") != -1 && s.endsWith(".xml")) {
+                int begin = "export_".length();
+                //Allow to manage is we backup 110 workspaces for instance
+                int end = s.length() - ".xml".length();
+                String name = s.substring(begin, end);
+                String login = this.getCredentials().getUserID();
+                String password = this.getCredentials().getPassword().toString();
+                //No need to check if the config file is there: if not, we will throw an exception later.
+                //Restore the config
+                WorkspaceConfigBackup wspConfb = new WorkspaceConfigBackup(this.getRepo(), this.getConf(), name, login, password);
+                wspConfb.restore(h);
+
+                //Restore the content
+                WorkspaceBackup wsb = new WorkspaceBackup(this.getRepo(), this.getConf(), name, login, password);
+                wsb.restore(h);
+            }
+        }

INS26 INS26 INS26 INS40 INS40 INS40 UPD65 INS44 INS44 INS29 UPD83 INS43 INS43 INS43 INS43 INS8 UPD66 INS65 INS65 INS43 INS42 INS43 INS42 INS65 INS60 INS60 INS42 INS42 INS42 INS42 INS60 INS61 INS66 INS66 INS42 INS42 INS42 INS42 INS42 INS42 INS66 INS43 INS59 INS43 INS59 INS43 INS59 INS32 INS8 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS60 INS25 INS32 INS42 INS32 INS42 MOV43 MOV43 INS42 INS42 INS43 INS59 INS27 INS8 INS52 INS42 INS32 INS42 INS42 INS42 INS32 INS27 INS32 INS60 INS60 INS60 INS60 INS60 INS60 INS21 INS60 INS21 INS52 INS42 MOV43 INS32 INS32 MOV2 INS42 INS42 MOV43 INS32 INS32 MOV2 INS42 INS42 INS36 INS42 INS32 INS38 INS42 INS42 INS45 INS39 INS59 INS39 INS59 INS43 INS59 INS43 INS59 INS43 INS59 INS43 INS59 INS32 INS43 INS59 INS32 INS52 INS42 INS52 INS42 INS52 INS42 INS52 INS42 INS11 INS42 INS42 INS45 INS34 INS42 INS32 INS42 INS27 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS14 INS42 INS42 INS42 INS42 INS42 INS14 INS42 INS42 INS42 INS43 INS32 INS45 INS42 INS32 INS32 INS42 INS42 INS42 INS42 INS32 INS42 INS32 INS42 INS43 INS32 INS32 INS42 INS42 INS42 INS43 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS45 INS42 INS52 INS42 INS32 INS42 INS42 INS52 INS42 INS52 INS42 INS42 INS52 INS42 INS52 INS42 INS52 INS42 DEL66 DEL66 DEL52 DEL42 DEL22 DEL52 DEL42 DEL22 DEL52 DEL42 DEL22 DEL52 DEL42 DEL22 DEL8