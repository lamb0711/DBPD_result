JCR-1029: modify ItemDefinitionProviderImpl.java so that the SPI is consulted when there are multiple matching property definitions (this is relevant, when, for instance, a residual property can either have OnParentVersionAction == IGNORE or == COPY).


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@555992 13f79535-47bb-0310-9956-ffa450edef68

-            definition = getQPropertyDefinition(ent, propertyState.getQName(), propertyState.getType(), propertyState.isMultiValued());
+            definition = getQPropertyDefinition(ent, propertyState.getQName(), propertyState.getType(), propertyState.isMultiValued(), true);
-        return getQPropertyDefinition(ent, propName, type, multiValued);
+        return getQPropertyDefinition(ent, propName, type, multiValued, false);
-        return getQPropertyDefinition(ent, name, type, multiValued);
+        return getQPropertyDefinition(ent, name, type, multiValued, false);
-                                                              boolean multiValued)
+                                                              boolean multiValued, boolean throwWhenAmbiguous)
-        QPropertyDefinition match = getMatchingPropDef(defs, type, multiValued);
+        QPropertyDefinition match = getMatchingPropDef(defs, type, multiValued, throwWhenAmbiguous);
-        match = getMatchingPropDef(defs, type, multiValued);
+        match = getMatchingPropDef(defs, type, multiValued, throwWhenAmbiguous);
-                                                   boolean multiValued) {
+                                                   boolean multiValued, boolean throwWhenAmbiguous)
+        throws ConstraintViolationException {
-                            // found best possible match, get outta here
-                            return pd;
+                            if (match != null && throwWhenAmbiguous) {
+                                throw new ConstraintViolationException("ambiguous property definitions found: " + match + " vs " + pd);
+                            }
+                          
+                            // found best possible match
+                            match = pd;
+

INS44 INS44 INS43 INS39 INS42 INS39 INS42 INS42 INS9 INS9 INS42 INS42 INS9 INS8 INS25 INS21 INS27 MOV8 INS7 INS27 INS42 INS53 INS42 INS42 INS42 INS33 INS14 INS43 INS27 INS42 INS45 INS42 INS45 INS42 DEL42 DEL41