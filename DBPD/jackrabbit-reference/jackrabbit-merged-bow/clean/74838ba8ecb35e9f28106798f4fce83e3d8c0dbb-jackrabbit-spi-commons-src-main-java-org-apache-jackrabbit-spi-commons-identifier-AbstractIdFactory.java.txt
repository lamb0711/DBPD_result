JCR-1653: NodeIdImpl is not really serializable

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@674024 13f79535-47bb-0310-9956-ffa450edef68

-            return new NodeIdImpl(parentId, path);
+            return new NodeIdImpl(parentId, path, getPathFactory());
-            return new PropertyIdImpl(parentId, propertyName);
+            return new PropertyIdImpl(parentId, propertyName, getPathFactory());
-    private abstract class ItemIdImpl implements ItemId, Serializable {
+
+    private static abstract class ItemIdImpl implements ItemId, Serializable {
-        private ItemIdImpl(NodeId parentId, Name name) throws RepositoryException {
+        private ItemIdImpl(NodeId parentId, Name name, PathFactory factory)
+                throws RepositoryException {
-                this.path = getPathFactory().create(parentPath, name, true);
+                this.path = factory.create(parentPath, name, true);
-                this.path = getPathFactory().create(name);
+                this.path = factory.create(name);
-                hashCode = toString().hashCode();
+                int result = 17;
+                result = 37 * result + (uniqueID != null ? uniqueID.hashCode() : 0);
+                result = 37 * result + (path != null ? path.hashCode() : 0);
+                hashCode = result;
-    private class NodeIdImpl extends ItemIdImpl implements NodeId {
+    private static class NodeIdImpl extends ItemIdImpl implements NodeId {
+
+        private static final long serialVersionUID = -360276648861146631L;
-        public NodeIdImpl(NodeId parentId, Path path) throws RepositoryException {
-            super(parentId.getUniqueID(), (parentId.getPath() != null) ? getPathFactory().create(parentId.getPath(), path, true) : path);
+        public NodeIdImpl(NodeId parentId, Path path, PathFactory factory)
+                throws RepositoryException {
+            super(parentId.getUniqueID(), (parentId.getPath() != null) ? factory.create(parentId.getPath(), path, true) : path);
-    private class PropertyIdImpl extends ItemIdImpl implements PropertyId {
+    private static class PropertyIdImpl extends ItemIdImpl implements PropertyId, Serializable {
+
+        private static final long serialVersionUID = -1953124047770776444L;
-        private PropertyIdImpl(NodeId parentId, Name name) throws RepositoryException {
-            super(parentId, name);
+        private PropertyIdImpl(NodeId parentId, Name name, PathFactory factory)
+                throws RepositoryException {
+            super(parentId, name, factory);

INS83 INS83 INS23 INS83 INS43 INS23 INS44 INS83 INS83 INS83 INS39 INS59 INS44 INS42 INS83 INS83 INS83 INS39 INS59 INS44 INS43 INS42 INS42 INS38 INS43 INS42 INS42 INS38 INS43 INS42 INS42 INS34 INS42 INS34 INS42 INS42 INS60 INS21 INS21 MOV32 MOV32 INS39 INS59 INS7 INS7 UPD42 MOV42 INS42 INS42 MOV22 MOV22 INS42 INS34 UPD42 INS27 INS42 INS27 INS42 INS42 UPD42 MOV42 UPD42 MOV42 INS27 INS36 INS27 INS36 INS34 INS42 INS16 INS34 INS42 INS16 INS27 INS32 INS34 INS27 INS32 INS34 INS42 INS33 UPD42 MOV42 MOV42 INS42 INS33 INS42 INS42 DEL32 DEL32 DEL32