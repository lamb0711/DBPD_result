- SPI: add RepositoryService.impersonate
- add implementations
- adjust SessionImpl.impersonate

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@518970 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.jackrabbit.jcr2spi.security.SecurityConstants;
-import javax.jcr.SimpleCredentials;
-        // TODO: check whether restriction to SimpleCredentials is correct
-        if (!(credentials instanceof SimpleCredentials)) {
-            String msg = "impersonate failed: incompatible credentials, SimpleCredentials expected";
-            log.debug(msg);
-            throw new RepositoryException(msg);
-        }
-
-        // set IMPERSONATOR_ATTRIBUTE attribute of given credentials
-        // with current session
-        SimpleCredentials creds = (SimpleCredentials) credentials;
-        creds.setAttribute(SecurityConstants.IMPERSONATOR_ATTRIBUTE, this);
-
+        SessionInfo info = config.getRepositoryService().impersonate(sessionInfo, credentials);
-            return repository.login(credentials, getWorkspace().getName());
-        } catch (NoSuchWorkspaceException nswe) {
-            // should never get here...
-            String msg = "impersonate failed";
-            log.error(msg, nswe);
-            throw new RepositoryException(msg, nswe);
-        } finally {
-            // make sure IMPERSONATOR_ATTRIBUTE is removed
-            creds.removeAttribute(SecurityConstants.IMPERSONATOR_ATTRIBUTE);
+            if (info instanceof XASessionInfo) {
+                return new XASessionImpl((XASessionInfo) info, repository, config);
+            } else {
+                return new SessionImpl(info, repository, config);
+            }
+        } catch (RepositoryException ex) {
+            config.getRepositoryService().dispose(info);
+            throw ex;

INS60 INS54 UPD43 MOV43 INS59 INS8 MOV12 UPD42 UPD42 MOV42 INS32 INS25 INS32 UPD42 MOV42 INS42 INS42 INS62 INS8 INS8 MOV43 INS42 UPD42 MOV42 UPD42 MOV42 INS42 INS43 INS41 MOV41 INS42 UPD42 MOV42 INS14 INS14 INS32 UPD42 UPD42 INS43 INS11 INS42 INS42 INS43 INS42 INS42 INS42 UPD42 MOV42 UPD42 MOV42 INS42 UPD43 MOV43 UPD42 MOV42 INS42 UPD42 DEL40 DEL26 DEL40 DEL26 DEL42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL32 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL45 DEL59 DEL60 DEL42 DEL43 DEL42 DEL42 DEL14 DEL42 DEL42 DEL43 DEL62 DEL36 DEL38 DEL45 DEL59 DEL60 DEL32 DEL21 DEL42 DEL14 DEL53 DEL8 DEL25 DEL43 DEL42 DEL11 DEL59 DEL60 DEL42 DEL42 DEL40 DEL52 DEL32 DEL21 DEL8 DEL42 DEL42 DEL40 DEL32 DEL21 DEL8 DEL54