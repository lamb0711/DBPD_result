JCR-2887 : Split PrivilegeRegistry in a per-session manager instance and a repository level registry [work in progress]

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1173164 13f79535-47bb-0310-9956-ffa450edef68

-     * for isn't the administrator.
+     * lacks rep:privilegeManagement privilege.
-        boolean isAdmin = (resolver instanceof SessionImpl) ? ((SessionImpl) resolver).isAdmin() : false;
-        if (!isAdmin) {
-            throw new AccessDeniedException("Registering privileges is only allowed to administrator.");
+        boolean allowed = false;
+        if (resolver instanceof SessionImpl) {
+            // TODO: FIXME should be 'null' path as privilegeManagement is a
+            // TODO: repo-level privilege such as namespace or node type mgt.
+            SessionImpl sImpl = (SessionImpl) resolver;
+            allowed = sImpl.getAccessManager().isGranted(sImpl.getQPath("/"), Permission.PRIVILEGE_MNGMT);
+        }
+        if (!allowed) {
+            throw new AccessDeniedException("Registering privileges is not allowed for the editing session.");

INS25 UPD66 MOV62 INS8 UPD42 INS9 INS60 INS21 UPD42 INS43 INS59 INS7 INS42 INS42 MOV11 INS42 INS32 UPD45 INS32 INS42 INS32 INS40 INS42 INS42 INS42 INS42 INS45 DEL36 DEL36 DEL42 DEL32 DEL9 DEL16