work in progress

- replace usage of UUID by uniqueID unless refering to 'jcr:uuid'
- PropertyImpl.checkValidReference: don't rely on Node-value to be NodeImpl
- spi.Event: getUUID() not used -> remove


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@483477 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.jackrabbit.name.NamespaceResolver;
-            checkValidReference(value, reqType, this);
-            QValue qValue = QValue.create(((NodeImpl)value).getUUID(), PropertyType.REFERENCE);
+            checkValidReference(value, reqType, session.getNamespaceResolver());
+            QValue qValue = QValue.create(value.getUUID(), PropertyType.REFERENCE);
-     * @param itemImpl
-    static void checkValidReference(Node value, int propertyType, ItemImpl itemImpl) throws ValueFormatException, RepositoryException {
+    static void checkValidReference(Node value, int propertyType, NamespaceResolver nsResolver) throws ValueFormatException, RepositoryException {
-            if (value instanceof NodeImpl) {
-                NodeImpl targetNode = (NodeImpl)value;
-                if (!targetNode.isNodeType(QName.MIX_REFERENCEABLE)) {
+            try {
+                String jcrName = NameFormat.format(QName.MIX_REFERENCEABLE, nsResolver);
+                if (!value.isNodeType(jcrName)) {
-            } else {
-                String msg = "Incompatible Node object: " + value + "(" + itemImpl.safeGetJCRPath() + ")";
-                log.debug(msg);
-                throw new RepositoryException(msg);
+            } catch (NoPrefixDeclaredException e) {
+                throw new RepositoryException(e);
-            throw new ValueFormatException("Property must be of type REFERENCE (" + itemImpl.safeGetJCRPath() + ")");
+            throw new ValueFormatException("Property must be of type REFERENCE.");

INS26 INS40 MOV8 UPD43 UPD42 UPD42 MOV27 INS8 INS54 INS53 MOV8 INS12 INS14 INS32 INS44 INS8 MOV43 INS45 INS42 INS42 MOV43 INS43 INS42 MOV53 UPD42 MOV42 INS42 UPD42 MOV42 UPD42 INS32 UPD42 MOV42 INS42 INS42 INS40 INS42 UPD42 INS42 UPD42 DEL52 DEL42 DEL43 DEL42 DEL11 DEL36 DEL42 DEL65 DEL42 DEL43 DEL42 DEL11 DEL40 DEL42 DEL43 DEL62 DEL42 DEL45 DEL42 DEL45 DEL42 DEL42 DEL32 DEL45 DEL27 DEL59 DEL60 DEL42 DEL42 DEL42 DEL32 DEL21 DEL45 DEL42 DEL42 DEL32 DEL45 DEL27 DEL14 DEL53 DEL8 DEL25 DEL8