JCR-2836: Unclosed threads in Jackrabbit

Remove the use of ThreadLocal variables in PerQueryCache to avoid leaking memory in container environments.

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1055117 13f79535-47bb-0310-9956-ffa450edef68

+    private final PerQueryCache cache;
+
-    public WildcardQuery(String field, final String propName, String pattern, int transform) {
+    public WildcardQuery(
+            String field, final String propName, String pattern, int transform,
+            PerQueryCache cache) {
+        this.cache = cache;
-    public WildcardQuery(String field, String propName, String pattern) {
-        this(field, propName, pattern, TRANSFORM_NONE);
+    public WildcardQuery(
+            String field, String propName, String pattern, PerQueryCache cache) {
+        this(field, propName, pattern, TRANSFORM_NONE, cache);
-        return new WildcardQueryWeight(searcher);
+        return new WildcardQueryWeight(searcher, cache);
+        private final PerQueryCache cache;
+
-        public WildcardQueryWeight(Searcher searcher) {
+        public WildcardQueryWeight(Searcher searcher, PerQueryCache cache) {
+            this.cache = cache;
-            return new WildcardQueryScorer(searcher.getSimilarity(), reader);
+            return new WildcardQueryScorer(searcher.getSimilarity(), reader, cache);
-        WildcardQueryScorer(Similarity similarity, IndexReader reader) {
+        WildcardQueryScorer(
+                Similarity similarity, IndexReader reader,
+                PerQueryCache cache) {
-            PerQueryCache cache = PerQueryCache.getInstance();

INS23 INS83 INS83 INS43 INS59 INS44 INS44 INS23 INS42 INS42 INS43 INS42 INS21 INS43 INS42 INS83 INS83 INS43 INS59 INS44 INS44 INS42 INS7 INS42 INS42 INS42 INS42 INS43 INS42 INS21 MOV43 INS42 INS22 INS42 INS42 INS42 INS7 INS52 INS42 INS22 INS42 INS42 INS52 INS42 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60