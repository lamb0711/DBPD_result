JCR-2061: JSR 283: References and Dereferencing of Property Values

- Dereferencing of Property Values both in jackrabbit-core and jackrabbit-jcr2spi
   > Property.getNode()
   > Property.getProperty()

- Adjusting testcases in jackrabbit-jcr-tests


TODO:

- similar testcases for the new Property types (still missing)
- new reference methods as listed in the issue
- support for weak-refs


git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@772352 13f79535-47bb-0310-9956-ffa450edef68

-        if (value.getType() == PropertyType.REFERENCE) {
-            return session.getNodeByUUID(value.getString());
-        } else {
-            // TODO: The specification suggests using value conversion
-            throw new ValueFormatException("property must be of type REFERENCE");
+        int type = value.getType();
+        switch (type) {
+            case PropertyType.REFERENCE:
+            case PropertyType.WEAKREFERENCE:
+                return session.getNodeByUUID(value.getString());
+
+            case PropertyType.PATH:
+            case PropertyType.NAME:
+                String path = value.getString();
+                Path p = session.getQPath(path);
+                boolean absolute = p.isAbsolute();
+                return (absolute) ? session.getNode(path) : getParent().getNode(path);
+
+            case PropertyType.STRING:
+                try {
+                    Value refValue = ValueHelper.convert(value, PropertyType.REFERENCE, session.getValueFactory());
+                    return session.getNodeByUUID(refValue.getString());
+                } catch (RepositoryException e) {
+                    // try if STRING value can be interpreted as PATH value
+                    Value pathValue = ValueHelper.convert(value, PropertyType.PATH, session.getValueFactory());
+                    p = session.getQPath(pathValue.getString());
+                    absolute = p.isAbsolute();
+                    return (absolute) ? session.getNode(pathValue.getString()) : getParent().getNode(pathValue.getString());
+                }
+
+            default:
+                throw new ValueFormatException("Property value cannot be converted to a PATH, REFERENCE or WEAKREFERENCE");
-        throw new UnsupportedRepositoryOperationException("JCR-1609");
+        Value value = getValue();
+        Value pathValue = ValueHelper.convert(value, PropertyType.PATH, session.getValueFactory());
+        String path = pathValue.getString();
+        boolean absolute;
+        try {
+            Path p = session.getQPath(path);
+            absolute = p.isAbsolute();
+        } catch (RepositoryException e) {
+            throw new ValueFormatException("Property value cannot be converted to a PATH");
+        }
+        return (absolute) ? session.getProperty(path) : getParent().getProperty(path);

INS8 INS60 INS50 INS60 INS60 INS60 INS60 INS54 INS41 INS39 INS59 INS42 INS49 INS49 MOV41 INS49 INS49 INS60 INS60 INS60 INS41 INS49 INS54 INS49 MOV53 INS43 INS59 INS43 INS59 INS43 INS59 INS39 INS59 INS8 INS12 INS16 INS42 MOV32 INS40 INS40 INS40 INS40 INS43 INS59 INS43 INS59 INS39 INS59 INS16 INS40 INS8 INS12 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS60 INS21 INS44 INS8 INS36 INS32 INS32 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS32 INS36 INS32 INS32 INS60 INS41 INS44 INS8 UPD45 INS42 INS42 INS42 INS42 INS40 INS32 INS42 INS42 INS43 INS59 INS7 INS43 INS42 MOV53 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS43 INS59 INS32 INS43 INS42 INS60 INS21 INS21 INS41 INS42 INS42 INS42 INS42 INS32 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS43 INS59 INS7 INS7 INS16 INS42 INS42 INS42 INS42 INS42 UPD43 UPD45 INS42 INS42 INS42 INS40 INS32 INS42 INS42 INS42 INS42 INS32 INS42 INS32 INS42 INS32 INS36 INS32 INS32 UPD42 INS42 INS42 INS42 INS42 INS42 INS40 INS32 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS32 INS32 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL40 DEL27 DEL8 DEL8 DEL25 DEL8