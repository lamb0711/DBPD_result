[#JCR-168] Observation events are not triggered for intermediate nodes in version storage

git-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@219511 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.LinkedList;
-        InternalVersionHistory history = createVersionHistory(node);
+        List created = new LinkedList();
+        InternalVersionHistory history = createVersionHistory(created, node);
-        NodeImpl parent = (NodeImpl) vh.getParent();
-        generateAddedEvents(events, parent, vh, true);
-        // in case the history was created 'deep' also add events for its ancestors
-        while (!parent.internalGetUUID().equals(historyRoot.getUUID())) {
-            NodeImpl child = parent;
-            parent = (NodeImpl) parent.getParent();
-            generateAddedEvents(events, parent, child, false);
+        Iterator iter = created.iterator();
+        while (iter.hasNext()) {
+            String uuid = (String) iter.next();
+            NodeImpl child = (NodeImpl) ((SessionImpl) session).getItemManager().getItem(new NodeId(uuid));
+            generateAddedEvents(events, (NodeImpl) child.getParent(), child, false);
-
+     * @param created a list for adding the uuids of the newly created nodes
-    private InternalVersionHistory createVersionHistory(NodeState node)
+    private InternalVersionHistory createVersionHistory(List created, NodeState node)
-                    root.addNode(name, REP_VERSIONSTORAGE, null, false);
+                    NodeStateEx n = root.addNode(name, REP_VERSIONSTORAGE, null, false);
+                    created.add(n.getUUID());
-            InternalVersionHistoryImpl hist = InternalVersionHistoryImpl.create(this, root, UUID.randomUUID().toString(), historyNodeName, node);
+            InternalVersionHistoryImpl hist = InternalVersionHistoryImpl.create(this, root, UUID.randomUUID().toString(), historyNodeName, node, created);

INS26 INS40 INS44 INS60 INS61 INS65 INS43 INS42 INS43 INS59 UPD43 INS32 INS8 INS42 INS66 INS42 INS42 INS42 INS14 UPD42 UPD42 INS32 UPD42 MOV42 UPD42 MOV42 INS60 INS60 MOV21 INS43 INS42 UPD42 MOV42 UPD42 MOV42 INS43 INS59 MOV43 INS59 INS42 INS42 INS42 INS11 MOV42 INS11 INS11 INS43 INS32 MOV43 INS32 MOV43 INS32 INS42 INS42 UPD42 MOV42 UPD42 MOV42 INS32 UPD42 MOV42 INS14 INS42 UPD42 MOV42 INS60 INS36 UPD42 MOV42 INS43 INS42 INS43 INS59 INS32 INS11 INS42 INS42 INS42 MOV32 INS42 INS42 INS32 INS43 INS42 INS42 INS42 INS42 DEL32 DEL11 DEL42 DEL42 DEL9 DEL32 DEL21 DEL42 DEL42 DEL32 DEL42 DEL32 DEL32 DEL38 DEL42 DEL59 DEL60 DEL42 DEL32 DEL11 DEL7 DEL21 DEL8 DEL61