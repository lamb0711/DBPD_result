Merge trunk into HA branch.

Resolved some semantic conflicts in TestFileAppendRestart - we now log more OP_ADDs in the HA branch than we did in trunk.
Resolved some conflicts around removal of VersionedProtocol, etc.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1295342 13f79535-47bb-0310-9956-ffa450edef68

+    long txId = expectedStartingTxId - 1;
-      long txId = expectedStartingTxId - 1;
-
-            String errorMessage = formatEditLogReplayError(in, recentOpcodeOffsets);
+            long badTxId = txId + 1; // because txId hasn't been incremented yet
+            String errorMessage = formatEditLogReplayError(in, recentOpcodeOffsets, badTxId);
-            long thisTxId = op.txid;
-            if (thisTxId != txId + 1) {
+            long expectedTxId = txId + 1;
+            txId = op.txid;
+            if (txId != expectedTxId) {
-                  (txId + 1) + " but got " + thisTxId);
+                  expectedTxId + " but got " + txId);
-            txId = thisTxId;
-            String errorMessage = formatEditLogReplayError(in, recentOpcodeOffsets);
+            String errorMessage = formatEditLogReplayError(in, recentOpcodeOffsets, txId);
-      INodeFileUnderConstruction ucFile = (INodeFileUnderConstruction) oldFile;
+      if (!oldFile.isUnderConstruction() &&
+          logVersion <= LayoutVersion.BUGFIX_HDFS_2991_VERSION) {
+        // There was a bug (HDFS-2991) in hadoop < 0.23.1 where OP_CLOSE
+        // could show up twice in a row. But after that version, this
+        // should be fixed, so we should treat it as an error.
+        throw new IOException(
+            "File is not under construction: " + addCloseOp.path);
+      }
-      fsNamesys.leaseManager.removeLeaseWithPrefixPath(addCloseOp.path);
-      INodeFile newFile = ucFile.convertToInodeFile();
-      fsDir.replaceNode(addCloseOp.path, ucFile, newFile);
+      if (oldFile.isUnderConstruction()) {
+        INodeFileUnderConstruction ucFile = (INodeFileUnderConstruction) oldFile;
+        fsNamesys.leaseManager.removeLeaseWithPrefixPath(addCloseOp.path);
+        INodeFile newFile = ucFile.convertToInodeFile();
+        fsDir.replaceNode(addCloseOp.path, ucFile, newFile);
+      }
-      long recentOpcodeOffsets[]) {
+      long recentOpcodeOffsets[], long txid) {
+    sb.append(" on transaction ID ").append(txid);
