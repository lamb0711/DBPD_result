Merge trunk into HA branch.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1233105 13f79535-47bb-0310-9956-ffa450edef68

-import java.net.InetSocketAddress;
-import org.apache.hadoop.net.NetUtils;
+  private static final CSAssignment NULL_ASSIGNMENT =
+      new CSAssignment(Resources.createResource(0), NodeType.NODE_LOCAL);
+  
-  public synchronized Resource 
+  public synchronized CSAssignment 
-      return assignReservedContainer(application, node, reservedContainer, 
-          clusterResource);
+      return new CSAssignment(
+          assignReservedContainer(application, node, reservedContainer, 
+              clusterResource),
+          NodeType.NODE_LOCAL); // Don't care about locality constraints 
+                                // for reserved containers
-            return Resources.none();
+            return NULL_ASSIGNMENT;
-          Resource assigned = 
+          CSAssignment assignment =  
-  
+          
+          Resource assigned = assignment.getResource();
+            
-            Resource assignedResource = 
-              application.getResourceRequest(priority, RMNode.ANY).getCapability();
-            allocateResource(clusterResource, 
-                application, assignedResource);
+            allocateResource(clusterResource, application, assigned);
-            return assignedResource; 
+            return assignment;
-    return Resources.none();
+    return NULL_ASSIGNMENT;
-      return container.getResource();
+      return container.getResource(); // Ugh, return resource to force re-sort
-    assignContainersOnNode(clusterResource, node, application, priority, rmContainer);
+    assignContainersOnNode(clusterResource, node, application, priority, 
+        rmContainer);
-  private Resource assignContainersOnNode(Resource clusterResource, 
+  private CSAssignment assignContainersOnNode(Resource clusterResource, 
-      return assigned;
+      return new CSAssignment(assigned, NodeType.NODE_LOCAL);
-      return assigned;
+      return new CSAssignment(assigned, NodeType.RACK_LOCAL);
-    return assignOffSwitchContainers(clusterResource, node, application, 
-        priority, reservedContainer);
+    return new CSAssignment(
+        assignOffSwitchContainers(clusterResource, node, application, 
+            priority, reservedContainer), 
+        NodeType.OFF_SWITCH);
-        " user=" + userName + " resources=" + user.getConsumedResources());
+        " user=" + userName + " user-resources=" + user.getConsumedResources());
-        " user=" + userName + " resources=" + user.getConsumedResources());
+        " user=" + userName + " user-resources=" + user.getConsumedResources());
