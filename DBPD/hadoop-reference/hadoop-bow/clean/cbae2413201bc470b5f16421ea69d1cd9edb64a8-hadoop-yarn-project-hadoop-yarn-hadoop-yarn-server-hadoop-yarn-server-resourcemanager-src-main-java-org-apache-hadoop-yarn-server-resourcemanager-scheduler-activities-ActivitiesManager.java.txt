YARN-9623. Auto adjust max queue length of app activities to make sure activities on all nodes can be covered. Contributed by Tao Yang.

+import org.apache.hadoop.yarn.server.resourcemanager.scheduler.capacity.CapacityScheduler;
-  private int appActivitiesMaxQueueLength;
+  private volatile int appActivitiesMaxQueueLength;
+  private int configuredAppActivitiesMaxQueueLength;
-    appActivitiesMaxQueueLength = conf.getInt(YarnConfiguration.
+    configuredAppActivitiesMaxQueueLength = conf.getInt(YarnConfiguration.
+    appActivitiesMaxQueueLength = configuredAppActivitiesMaxQueueLength;
+  private void dynamicallyUpdateAppActivitiesMaxQueueLengthIfNeeded() {
+    if (rmContext.getRMNodes() == null) {
+      return;
+    }
+    if (rmContext.getScheduler() instanceof CapacityScheduler) {
+      CapacityScheduler cs = (CapacityScheduler) rmContext.getScheduler();
+      if (!cs.isMultiNodePlacementEnabled()) {
+        int numNodes = rmContext.getRMNodes().size();
+        int newAppActivitiesMaxQueueLength;
+        int numAsyncSchedulerThreads = cs.getNumAsyncSchedulerThreads();
+        if (numAsyncSchedulerThreads > 0) {
+          newAppActivitiesMaxQueueLength =
+              Math.max(configuredAppActivitiesMaxQueueLength,
+                  numNodes * numAsyncSchedulerThreads);
+        } else {
+          newAppActivitiesMaxQueueLength =
+              Math.max(configuredAppActivitiesMaxQueueLength,
+                  (int) (numNodes * 1.2));
+        }
+        if (appActivitiesMaxQueueLength != newAppActivitiesMaxQueueLength) {
+          LOG.info("Update max queue length of app activities from {} to {},"
+                  + " configured={}, numNodes={}, numAsyncSchedulerThreads={}"
+                  + " when multi-node placement disabled.",
+              appActivitiesMaxQueueLength, newAppActivitiesMaxQueueLength,
+              configuredAppActivitiesMaxQueueLength, numNodes,
+              numAsyncSchedulerThreads);
+          appActivitiesMaxQueueLength = newAppActivitiesMaxQueueLength;
+        }
+      } else if (appActivitiesMaxQueueLength
+          != configuredAppActivitiesMaxQueueLength) {
+        LOG.info("Update max queue length of app activities from {} to {}"
+                + " when multi-node placement enabled.",
+            appActivitiesMaxQueueLength, configuredAppActivitiesMaxQueueLength);
+        appActivitiesMaxQueueLength = configuredAppActivitiesMaxQueueLength;
+      }
+    }
+  }
+
+          // dynamically update max queue length of app activities if needed
+          dynamicallyUpdateAppActivitiesMaxQueueLengthIfNeeded();
+
+  @VisibleForTesting
+  public int getAppActivitiesMaxQueueLength() {
+    return appActivitiesMaxQueueLength;
+  }
