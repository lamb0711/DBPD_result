HDFS-12337. Ozone: Concurrent RocksDB open calls fail because of "No locks available". Contributed by Mukul Kumar Singh.

+import org.apache.hadoop.ozone.container.ozoneimpl.OzoneContainer;
+import static org.apache.hadoop.ozone.OzoneConfigKeys
+    .DFS_CONTAINER_RATIS_IPC_PORT;
+import static org.apache.hadoop.ozone.OzoneConfigKeys
+    .DFS_CONTAINER_RATIS_IPC_RANDOM_PORT;
+
-      int currentPort = dnProp.getDatanode().getOzoneContainerManager()
-          .getContainerServerPort();
+      OzoneContainer container =
+          dnProp.getDatanode().getOzoneContainerManager();
+      int currentPort = container.getContainerServerPort();
+      int ratisPort = container.getRatisContainerServerPort();
+      config.setInt(DFS_CONTAINER_RATIS_IPC_PORT, ratisPort);
+      config.setBoolean(DFS_CONTAINER_RATIS_IPC_RANDOM_PORT, false);
-    boolean status =  super.restartDataNode(i, true);
-    this.waitActive();
+    boolean status =  super.restartDataNode(i, keepPort);
+
+    try {
+      this.waitActive();
+      this.waitForHeartbeatProcessed();
+      this.waitOzoneReady();
+    } catch (TimeoutException | InterruptedException e) {
+      Thread.interrupted();
+    }
