Merge trunk into HDFS-347 branch.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-347@1446832 13f79535-47bb-0310-9956-ffa450edef68

-  private final byte[] buffer;
+  private byte[] buffer;
+  private int startOffset;
-  private int count;
+  private int currentPointer;
+    this(new byte[capacity], 0, limit);
+  }
+
+  protected BoundedByteArrayOutputStream(byte[] buf, int offset, int limit) {
+    resetBuffer(buf, offset, limit);
+  }
+  
+  protected void resetBuffer(byte[] buf, int offset, int limit) {
+    int capacity = buf.length - offset;
-    this.buffer = new byte[capacity];
-    this.limit = limit;
-    this.count = 0;
+    this.buffer = buf;
+    this.startOffset = offset;
+    this.currentPointer = offset;
+    this.limit = offset + limit;
-
+  
-    if (count >= limit) {
+    if (currentPointer >= limit) {
-    buffer[count++] = (byte) b;
+    buffer[currentPointer++] = (byte) b;
-    if (count + len > limit) {
+    if (currentPointer + len > limit) {
-    System.arraycopy(b, off, buffer, count, len);
-    count += len;
+    System.arraycopy(b, off, buffer, currentPointer, len);
+    currentPointer += len;
-    if (newlim > buffer.length) {
+    if (newlim > (buffer.length - startOffset)) {
-    this.count = 0;
+    this.currentPointer = startOffset;
-    this.limit = buffer.length;
-    this.count = 0;
+    this.limit = buffer.length - startOffset;
+    this.currentPointer = startOffset;
-    return count;
+    return currentPointer - startOffset;
+  }
+  
+  public int available() {
+    return limit - currentPointer;
