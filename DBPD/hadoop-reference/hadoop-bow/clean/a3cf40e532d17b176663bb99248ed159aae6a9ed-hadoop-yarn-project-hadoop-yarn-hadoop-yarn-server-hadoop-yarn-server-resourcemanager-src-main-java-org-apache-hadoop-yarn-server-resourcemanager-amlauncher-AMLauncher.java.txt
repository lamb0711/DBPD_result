YARN-3461. Consolidate flow name/version/run defaults. (Sangjin Lee via Varun Saxena)

+import org.apache.hadoop.yarn.server.resourcemanager.rmapp.RMApp;
+    // set the flow context optionally for timeline service v.2
+    setFlowContext(container);
-    if (YarnConfiguration.timelineServiceV2Enabled(conf)) {
-      // Set flow context info
-      for (String tag :
-          rmContext.getRMApps().get(applicationId).getApplicationTags()) {
-        setFlowTags(environment, TimelineUtils.FLOW_NAME_TAG_PREFIX, tag);
-        setFlowTags(environment, TimelineUtils.FLOW_VERSION_TAG_PREFIX, tag);
-        setFlowTags(environment, TimelineUtils.FLOW_RUN_ID_TAG_PREFIX, tag);
-      }
-    }
-  private static void setFlowTags(
-      Map<String, String> environment, String tagPrefix, String tag) {
-    if (tag.startsWith(tagPrefix + ":") ||
-        tag.startsWith(tagPrefix.toLowerCase() + ":")) {
-      String value = tag.substring(tagPrefix.length() + 1);
-      if (!value.isEmpty()) {
-        environment.put(tagPrefix, value);
+  private void setFlowContext(ContainerLaunchContext container) {
+    if (YarnConfiguration.timelineServiceV2Enabled(conf)) {
+      Map<String, String> environment = container.getEnvironment();
+      ApplicationId applicationId =
+          application.getAppAttemptId().getApplicationId();
+      RMApp app = rmContext.getRMApps().get(applicationId);
+
+      // initialize the flow in the environment with default values for those
+      // that do not specify the flow tags
+      // flow name: app name (or app id if app name is missing),
+      // flow version: "1", flow run id: start time
+      setFlowTags(environment, TimelineUtils.FLOW_NAME_TAG_PREFIX,
+          TimelineUtils.generateDefaultFlowName(app.getName(), applicationId));
+      setFlowTags(environment, TimelineUtils.FLOW_VERSION_TAG_PREFIX,
+          TimelineUtils.DEFAULT_FLOW_VERSION);
+      setFlowTags(environment, TimelineUtils.FLOW_RUN_ID_TAG_PREFIX,
+          String.valueOf(app.getStartTime()));
+
+      // Set flow context info: the flow context is received via the application
+      // tags
+      for (String tag : app.getApplicationTags()) {
+        String[] parts = tag.split(":", 2);
+        if (parts.length != 2 || parts[1].isEmpty()) {
+          continue;
+        }
+        switch (parts[0].toUpperCase()) {
+        case TimelineUtils.FLOW_NAME_TAG_PREFIX:
+          setFlowTags(environment, TimelineUtils.FLOW_NAME_TAG_PREFIX,
+              parts[1]);
+          break;
+        case TimelineUtils.FLOW_VERSION_TAG_PREFIX:
+          setFlowTags(environment, TimelineUtils.FLOW_VERSION_TAG_PREFIX,
+              parts[1]);
+          break;
+        case TimelineUtils.FLOW_RUN_ID_TAG_PREFIX:
+          setFlowTags(environment, TimelineUtils.FLOW_RUN_ID_TAG_PREFIX,
+              parts[1]);
+          break;
+        default:
+          break;
+        }
+  private static void setFlowTags(
+      Map<String, String> environment, String tagPrefix, String value) {
+    if (!value.isEmpty()) {
+      environment.put(tagPrefix, value);
+    }
+  }
+
