HDFS-5448. Datanode should generate its ID on first registration

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2832@1538496 13f79535-47bb-0310-9956-ffa450edef68

+   * Verify that the DatanodeUuid has been initialized. If this is a new
+   * datanode then we generate a new Datanode Uuid and persist it to disk.
+   *
+   * @throws IOException
+   */
+  private synchronized void checkDatanodeUuid() throws IOException {
+    if (storage.getDatanodeUuid() == null) {
+      storage.setDatanodeUuid(UUID.randomUUID().toString());
+      storage.writeAll();
+      LOG.info("Generated and persisted new Datanode UUID " +
+               storage.getDatanodeUuid());
+    }
+  }
+
+  /**
-  DatanodeRegistration createBPRegistration(NamespaceInfo nsInfo) {
+  DatanodeRegistration createBPRegistration(NamespaceInfo nsInfo)
+      throws IOException {
+
+    checkDatanodeUuid();
+
-    if (storage.getDatanodeUuid() == null) {
-      // This is a fresh datanode, persist the NN-provided Datanode ID
-      storage.setDatanodeUuid(bpRegistration.getDatanodeUuid());
-      storage.writeAll();
-      LOG.info("Datanode ID " + bpRegistration.getDatanodeUuid()
-          + " is assigned to new storage " + bpRegistration);
-    } else if(!storage.getDatanodeUuid().equals(bpRegistration.getDatanodeUuid())) {
+    if(!storage.getDatanodeUuid().equals(bpRegistration.getDatanodeUuid())) {
