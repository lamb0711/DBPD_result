HDDS-1339. Implement ratis snapshots on OM (#651)



-import org.apache.hadoop.ozone.om.OzoneManager;
-import org.apache.ratis.statemachine.impl.BaseStateMachine;
+  private final OzoneManagerStateMachine omStateMachine;
+    this.omStateMachine = getStateMachine();
+
-        .setStateMachine(getStateMachine(this.raftGroupId))
+        .setStateMachine(omStateMachine)
-      Configuration ozoneConf, OzoneManager om,
+      Configuration ozoneConf, OzoneManagerServerProtocol omProtocol,
-    return new OzoneManagerRatisServer(ozoneConf, om, omServiceId,
+    return new OzoneManagerRatisServer(ozoneConf, omProtocol, omServiceId,
-  private BaseStateMachine getStateMachine(RaftGroupId gid) {
+  private OzoneManagerStateMachine getStateMachine() {
-    /**
-     * TODO: when ratis snapshots are implemented, set snapshot threshold and
-     * queue size.
-     */
+    long snapshotAutoTriggerThreshold = conf.getLong(
+        OMConfigKeys.OZONE_OM_RATIS_SNAPSHOT_AUTO_TRIGGER_THRESHOLD_KEY,
+        OMConfigKeys.OZONE_OM_RATIS_SNAPSHOT_AUTO_TRIGGER_THRESHOLD_DEFAULT);
+    RaftServerConfigKeys.Snapshot.setAutoTriggerEnabled(
+        properties, true);
+    RaftServerConfigKeys.Snapshot.setAutoTriggerThreshold(
+        properties, snapshotAutoTriggerThreshold);
+
+  public long getStateMachineLastAppliedIndex() {
+    return omStateMachine.getLastAppliedIndex();
+  }
