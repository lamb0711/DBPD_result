Reverting the previous trunk merge since it added other unintended changes in addition


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1177127 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.yarn.api.records.ApplicationId;
-import org.apache.hadoop.yarn.server.resourcemanager.rmapp.RMAppFailedAttemptEvent;
-  private String host = "N/A";
+  private String host;
-  private String trackingUrl = "N/A";
-  private String finalState = "N/A";
+  private String trackingUrl;
+  private String finalState;
-          RMAppAttemptEventType.KILL,
-          new BaseFinalTransition(RMAppAttemptState.KILLED))
+          RMAppAttemptEventType.KILL)
-  public String getDiagnostics() {
+  public StringBuilder getDiagnostics() {
-      return this.diagnostics.toString();
+      return this.diagnostics;
-  public void setDiagnostics(String message) {
-    this.writeLock.lock();
-
-    try {
-      this.diagnostics.append(message);
-    } finally {
-      this.writeLock.unlock();
-    }
-  }
-
-      
-      // Save the diagnostic message
-      String message = rejectedEvent.getMessage();
-      appAttempt.setDiagnostics(message);
-      
-      appAttempt.eventHandler.handle(
-          new RMAppRejectedEvent(
-              rejectedEvent.getApplicationAttemptId().getApplicationId(), 
-              message)
-          );
+      appAttempt.eventHandler.handle(new RMAppRejectedEvent(rejectedEvent
+          .getApplicationAttemptId().getApplicationId(), rejectedEvent
+          .getMessage()));
+      LOG.debug("About to request resources for AM of "
+          + appAttempt.applicationAttemptId + " required " + request);
-      ApplicationId applicationId = appAttempt.getAppAttemptId().getApplicationId();
-      RMAppEvent appEvent = null;
+      RMAppEventType eventToApp = null;
-        case FINISHED:
-        {
-          appEvent = 
-              new RMAppEvent(applicationId, RMAppEventType.ATTEMPT_FINISHED);
-        }
+      case FINISHED:
+        eventToApp = RMAppEventType.ATTEMPT_FINISHED;
-        case KILLED:
-        {
-          appEvent = 
-              new RMAppFailedAttemptEvent(applicationId, 
-                  RMAppEventType.ATTEMPT_KILLED, 
-                  "Application killed by user.");
-        }
+      case KILLED:
+        eventToApp = RMAppEventType.ATTEMPT_KILLED;
-        case FAILED:
-        {
-          appEvent = 
-              new RMAppFailedAttemptEvent(applicationId, 
-                  RMAppEventType.ATTEMPT_FAILED, 
-                  appAttempt.getDiagnostics());
-        }
+      case FAILED:
+        eventToApp = RMAppEventType.ATTEMPT_FAILED;
-        default:
-        {
-          LOG.error("Cannot get this state!! Error!!");
-        }
+      default:
+        LOG.info("Cannot get this state!! Error!!");
-      
-      appAttempt.eventHandler.handle(appEvent);
+      appAttempt.eventHandler.handle(new RMAppEvent(
+          appAttempt.applicationAttemptId.getApplicationId(), eventToApp));
-      RMAppAttemptContainerFinishedEvent finishEvent =
-          ((RMAppAttemptContainerFinishedEvent)event);
-      
-      // Setup diagnostic message
-      ContainerStatus status = finishEvent.getContainerStatus();
-      appAttempt.diagnostics.append("AM Container for " +
-          appAttempt.getAppAttemptId() + " exited with " +
-          " exitCode: " + status.getExitStatus() + 
-          " due to: " +  status.getDiagnostics() + "." +
-          "Failing this attempt.");
-
-      super.transition(appAttempt, finishEvent);
+      super.transition(appAttempt, event);
+
+      // Use diagnostic saying crashed.
+      appAttempt.diagnostics.append("AM Container for "
+          + appAttempt.getAppAttemptId() + " exited. Failing this attempt.");
-      appAttempt.progress = 1.0f;
-
-        // Setup diagnostic message
-        appAttempt.diagnostics.append("AM Container for " +
-            appAttempt.getAppAttemptId() + " exited with " +
-            " exitCode: " + containerStatus.getExitStatus() + 
-            " due to: " +  containerStatus.getDiagnostics() + "." +
-            "Failing this attempt.");
-
