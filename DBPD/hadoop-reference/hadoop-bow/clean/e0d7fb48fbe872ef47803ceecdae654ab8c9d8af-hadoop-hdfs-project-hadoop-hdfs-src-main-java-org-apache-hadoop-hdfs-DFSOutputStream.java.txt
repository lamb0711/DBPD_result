Merge branch 'trunk' into HDFS-6581

Conflicts:
	hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/DFSOutputStream.java
	hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/datatransfer/Receiver.java

+import org.htrace.Span;
+import org.htrace.Trace;
+import org.htrace.TraceScope;
+
+    private final Span traceSpan;
+
+      this(stat, null);
+    }
+
+    /**
+     * construction with tracing info
+     */
+    private DataStreamer(HdfsFileStatus stat, Span span) {
+      traceSpan = span;
-        int bytesPerChecksum) throws IOException {
+        int bytesPerChecksum, Span span) throws IOException {
+      traceSpan = span;
+      TraceScope traceScope = null;
+      if (traceSpan != null) {
+        traceScope = Trace.continueSpan(traceSpan);
+      }
+      if (traceScope != null) {
+        traceScope.close();
+      }
-    streamer = new DataStreamer(stat);
+    Span traceSpan = null;
+    if (Trace.isTracing()) {
+      traceSpan = Trace.startSpan(this.getClass().getSimpleName()).detach();
+    }
+    streamer = new DataStreamer(stat, traceSpan);
+    Span traceSpan = null;
+    if (Trace.isTracing()) {
+      traceSpan = Trace.startSpan(this.getClass().getSimpleName()).detach();
+    }
+
-      streamer = new DataStreamer(lastBlock, stat, checksum.getBytesPerChecksum());
+      streamer = new DataStreamer(lastBlock, stat,
+          checksum.getBytesPerChecksum(), traceSpan);
-      streamer = new DataStreamer(stat);
+      streamer = new DataStreamer(stat, traceSpan);
