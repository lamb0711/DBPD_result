Merge trunk into auto-failover branch


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-3042@1308260 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.commons.logging.Log;
+import org.apache.commons.logging.LogFactory;
+import org.apache.hadoop.ipc.ProtobufRpcEngine;
+import org.apache.hadoop.ipc.RpcPayloadHeader.RpcKind;
-import org.apache.hadoop.yarn.ipc.ProtoOverHadoopRpcEngine;
+  private static final Log LOG = LogFactory.getLog(RpcServerFactoryPBImpl.class);
+    Class<?> pbProtocol = service.getClass().getInterfaces()[0];
-        method = protoClazz.getMethod("newReflectiveBlockingService", service.getClass().getInterfaces()[0]);
+        method = protoClazz.getMethod("newReflectiveBlockingService",
+            pbProtocol.getInterfaces()[0]);
-      return createServer(addr, conf, secretManager, numHandlers,
+      return createServer(pbProtocol, addr, conf, secretManager, numHandlers,
-  private Server createServer(InetSocketAddress addr, Configuration conf, 
+  private Server createServer(Class<?> pbProtocol, InetSocketAddress addr, Configuration conf, 
-    RPC.setProtocolEngine(conf, BlockingService.class, ProtoOverHadoopRpcEngine.class);
-    Server server = RPC.getServer(BlockingService.class, blockingService, 
+    RPC.setProtocolEngine(conf, pbProtocol, ProtobufRpcEngine.class);
+    RPC.Server server = RPC.getServer(pbProtocol, blockingService, 
+    LOG.info("Adding protocol "+pbProtocol.getCanonicalName()+" to the server");
+    server.addProtocol(RpcKind.RPC_PROTOCOL_BUFFER, pbProtocol, blockingService);
