HADOOP-16357. TeraSort Job failing on S3 DirectoryStagingCommitter: destination path exists.

Contributed by Steve Loughran.

This patch

* changes the default for the staging committer to append, as we get for the classic FileOutputFormat committer
* adds a check for the dest path being a file not a dir
* adds tests for this
* Changes AbstractCommitTerasortIT. to not use the simple parser, so fails if the file is present.

Change-Id: Id53742958ed1cf321ff96c9063505d64f3254f53

+import java.io.File;
+import java.nio.charset.Charset;
+import org.apache.commons.io.FileUtils;
-import org.apache.hadoop.fs.contract.ContractTestUtils;
+    yarnConfig.setBoolean(
+        TeraSortConfigKeys.USE_SIMPLE_PARTITIONER.key(),
+        false);
-    validateSuccessFile(getFileSystem(), dest, committerName());
+    validateSuccessFile(dest, committerName(), getFileSystem(), stage);
+    getFileSystem().delete(sortInput, true);
-    loadSuccessFile(getFileSystem(), sortInput);
+    getFileSystem().delete(sortOutput, true);
+
+    loadSuccessFile(getFileSystem(), sortInput, "previous teragen stage");
-    loadSuccessFile(getFileSystem(), sortOutput);
+    getFileSystem().delete(sortValidate, true);
+    loadSuccessFile(getFileSystem(), sortOutput, "previous terasort stage");
-    Path path = new Path(terasortPath, "results.csv");
-    LOG.info("Results are in {}\n{}", path, text);
-    ContractTestUtils.writeTextFile(getFileSystem(), path, text, true);
+    File resultsFile = File.createTempFile("results", ".csv");
+    FileUtils.write(resultsFile, text, Charset.forName("UTF-8"));
+    LOG.info("Results are in {}\n{}", resultsFile, text);
