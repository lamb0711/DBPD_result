HDDS-1909. Use new HA code for Non-HA in OM. (#1225)


-    OMRequest.Builder omRequest = OMRequest.newBuilder()
-        .setUserInfo(getUserInfo())
-        .setUpdateGetDelegationTokenRequest(
-            UpdateGetDelegationTokenRequest.newBuilder()
-                .setGetDelegationTokenResponse(
-                    GetDelegationTokenResponseProto.newBuilder()
-                    .setResponse(SecurityProtos.GetDelegationTokenResponseProto
-                        .newBuilder().setToken(OMPBHelper
-                        .convertToTokenProto(token)).build()).build()))
-        .setCmdType(getOmRequest().getCmdType())
-        .setClientId(getOmRequest().getClientId());
+    OMRequest.Builder omRequest;
+    if (token != null) {
+      omRequest = OMRequest.newBuilder().setUserInfo(getUserInfo())
+          .setUpdateGetDelegationTokenRequest(
+              UpdateGetDelegationTokenRequest.newBuilder()
+                  .setGetDelegationTokenResponse(
+                      GetDelegationTokenResponseProto.newBuilder()
+                          .setResponse(
+                              SecurityProtos.GetDelegationTokenResponseProto
+                              .newBuilder().setToken(OMPBHelper
+                                  .convertToTokenProto(token)).build())
+                          .build()))
+          .setCmdType(getOmRequest().getCmdType())
+          .setClientId(getOmRequest().getClientId());
+
+
+    } else {
+      // If token is null, do not set GetDelegationTokenResponse with response.
+      omRequest = OMRequest.newBuilder().setUserInfo(getUserInfo())
+          .setUpdateGetDelegationTokenRequest(
+              UpdateGetDelegationTokenRequest.newBuilder()
+                  .setGetDelegationTokenResponse(
+                      GetDelegationTokenResponseProto.newBuilder()))
+          .setCmdType(getOmRequest().getCmdType())
+          .setClientId(getOmRequest().getClientId());
+    }
-
+    OMResponse.Builder omResponse =
+        OMResponse.newBuilder()
+            .setCmdType(OzoneManagerProtocolProtos.Type.GetDelegationToken)
+            .setStatus(OzoneManagerProtocolProtos.Status.OK)
+            .setSuccess(true);
+
+    OMClientResponse omClientResponse = null;
+
+
+    // If security is not enabled and token request is received, leader
+    // returns token null. So, check here if updatedGetDelegationTokenResponse
+    // has response set or not. If it is not set, then token is null.
+    if (!updateGetDelegationTokenRequest.getGetDelegationTokenResponse()
+        .hasResponse()) {
+      omClientResponse = new OMGetDelegationTokenResponse(null, -1L,
+          omResponse.setGetDelegationTokenResponse(
+              GetDelegationTokenResponseProto.newBuilder()).build());
+      omClientResponse.setFlushFuture(
+          ozoneManagerDoubleBufferHelper.add(omClientResponse,
+              transactionLogIndex));
+      return omClientResponse;
+    }
+
-    OMClientResponse omClientResponse = null;
-    OMResponse.Builder omResponse =
-        OMResponse.newBuilder()
-            .setCmdType(OzoneManagerProtocolProtos.Type.GetDelegationToken)
-            .setStatus(OzoneManagerProtocolProtos.Status.OK)
-            .setSuccess(true);
