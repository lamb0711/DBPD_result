HDFS-2693. Fix synchronization issues around state transition. Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1221582 13f79535-47bb-0310-9956-ffa450edef68

-      nn.checkOperation(OperationCategory.JOURNAL);
+      namesystem.checkOperation(OperationCategory.JOURNAL);
-        verifyRequest(registration);
-        getBNImage().namenodeStartedLogSegment(txid);
+      getBNImage().namenodeStartedLogSegment(txid);
-      nn.checkOperation(OperationCategory.JOURNAL);
+      namesystem.checkOperation(OperationCategory.JOURNAL);
-  @Override // NameNode
-  protected void checkOperation(OperationCategory op)
-      throws StandbyException {
-    if (OperationCategory.JOURNAL != op) {
-      String msg = "Operation category " + op
-          + " is not supported at the BackupNode";
-      throw new StandbyException(msg);
+  @Override
+  protected NameNodeHAContext createHAContext() {
+    return new BNHAContext();
+  }
+  
+  private class BNHAContext extends NameNodeHAContext {
+    @Override // NameNode
+    public void checkOperation(OperationCategory op)
+        throws StandbyException {
+      if (OperationCategory.JOURNAL != op &&
+          !(OperationCategory.READ == op && allowStaleStandbyReads)) {
+        String msg = "Operation category " + op
+            + " is not supported at the BackupNode";
+        throw new StandbyException(msg);
+      }
