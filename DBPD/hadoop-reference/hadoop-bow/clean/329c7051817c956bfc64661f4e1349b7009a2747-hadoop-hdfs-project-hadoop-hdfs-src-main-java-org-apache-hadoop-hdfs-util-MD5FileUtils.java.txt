HDFS-5987. Fix findbugs warnings in Rolling Upgrade branch. (Contributed by szetszwo)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535@1570389 13f79535-47bb-0310-9956-ffa450edef68

-   * Read the md5 checksum stored alongside the given file, or null
-   * if no md5 is stored.
+   * Read the md5 file stored alongside the given data file
+   * and match the md5 file content.
-   * @return the checksum stored in dataFile.md5
+   * @return a matcher with two matched groups
+   *   where group(1) is the md5 string and group(2) is the data file path.
-  public static MD5Hash readStoredMd5ForFile(File dataFile) throws IOException {
-    File md5File = getDigestFileForFile(dataFile);
-
-    String md5Line;
-    
+  private static Matcher readStoredMd5(File md5File) throws IOException {
+    String md5Line;
-      throw new IOException("Invalid MD5 file at " + md5File
-          + " (does not match expected pattern)");
+      throw new IOException("Invalid MD5 file " + md5File + ": the content \""
+          + md5Line + "\" does not match the expected pattern.");
+    return matcher;
+  }
+
+  /**
+   * Read the md5 checksum stored alongside the given data file.
+   * @param dataFile the file containing data
+   * @return the checksum stored in dataFile.md5
+   */
+  public static MD5Hash readStoredMd5ForFile(File dataFile) throws IOException {
+    final File md5File = getDigestFileForFile(dataFile);
+    final Matcher matcher = readStoredMd5(md5File);
-    File fromFile = getDigestFileForFile(oldDataFile);
-    BufferedReader in = null;
-    final String digestString;
-    try {
-      in = new BufferedReader(new InputStreamReader(new FileInputStream(
-          fromFile), Charsets.UTF_8));
-      String line = in.readLine();
-      String[] split = line.split(" \\*");
-      digestString = split[0];
-    } finally {
-      IOUtils.cleanup(LOG, in);
-    }
-
+    final File fromFile = getDigestFileForFile(oldDataFile);
+    final String digestString = readStoredMd5(fromFile).group(1);
