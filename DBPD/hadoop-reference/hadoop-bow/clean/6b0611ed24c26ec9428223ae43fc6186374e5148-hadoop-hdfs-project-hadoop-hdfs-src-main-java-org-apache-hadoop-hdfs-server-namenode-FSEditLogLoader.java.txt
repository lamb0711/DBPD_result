Merging r1539737 through r1539896 from trunk to branch HDFS-2832

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2832@1539898 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.hdfs.protocol.PathBasedCacheDescriptor;
+import org.apache.hadoop.hdfs.server.namenode.FSEditLogOp.ModifyPathBasedCacheDirectiveOp;
-import org.apache.hadoop.hdfs.server.namenode.FSEditLogOp.RemovePathBasedCacheDescriptorOp;
+import org.apache.hadoop.hdfs.server.namenode.FSEditLogOp.RemovePathBasedCacheDirectiveOp;
-      PathBasedCacheDirective d = new PathBasedCacheDirective.Builder().
-          setPath(new Path(addOp.path)).
-          setReplication(addOp.replication).
-          setPool(addOp.pool).
-          build();
-      PathBasedCacheDescriptor descriptor =
-          fsNamesys.getCacheManager().addDirective(d, null);
+      PathBasedCacheDirective result = fsNamesys.
+          getCacheManager().addDirective(addOp.directive, null);
-        fsNamesys.addCacheEntryWithPayload(op.rpcClientId, op.rpcCallId,
-            descriptor);
+        Long id = result.getId();
+        fsNamesys.addCacheEntryWithPayload(op.rpcClientId, op.rpcCallId, id);
-    case OP_REMOVE_PATH_BASED_CACHE_DESCRIPTOR: {
-      RemovePathBasedCacheDescriptorOp removeOp =
-          (RemovePathBasedCacheDescriptorOp) op;
-      fsNamesys.getCacheManager().removeDescriptor(removeOp.id, null);
+    case OP_MODIFY_PATH_BASED_CACHE_DIRECTIVE: {
+      ModifyPathBasedCacheDirectiveOp modifyOp =
+          (ModifyPathBasedCacheDirectiveOp) op;
+      fsNamesys.getCacheManager().modifyDirective(
+          modifyOp.directive, null);
+      if (toAddRetryCache) {
+        fsNamesys.addCacheEntry(op.rpcClientId, op.rpcCallId);
+      }
+      break;
+    }
+    case OP_REMOVE_PATH_BASED_CACHE_DIRECTIVE: {
+      RemovePathBasedCacheDirectiveOp removeOp =
+          (RemovePathBasedCacheDirectiveOp) op;
+      fsNamesys.getCacheManager().removeDirective(removeOp.id, null);
