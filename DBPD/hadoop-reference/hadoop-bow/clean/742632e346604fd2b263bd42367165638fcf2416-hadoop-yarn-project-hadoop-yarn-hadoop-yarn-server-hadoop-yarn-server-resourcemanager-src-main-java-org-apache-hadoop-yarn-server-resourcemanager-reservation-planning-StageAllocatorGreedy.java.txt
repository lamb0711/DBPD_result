YARN-4358. Reservation System: Improve relationship between SharingPolicy and ReservationAgent. (Carlo Curino via asuresh)

+import org.apache.hadoop.yarn.api.records.ReservationId;
+import org.apache.hadoop.yarn.server.resourcemanager.reservation.RLESparseResourceAllocation.RLEOperator;
+import org.apache.hadoop.yarn.server.resourcemanager.reservation.exceptions.PlanningException;
-      long stageEarliestStart, long stageDeadline) {
+      long stageEarliestStart, long stageDeadline, String user,
+      ReservationId oldId) throws PlanningException {
+    RLESparseResourceAllocation netAvailable =
+        plan.getAvailableResourceOverTime(user, oldId, stageEarliestStart,
+            stageDeadline);
+
+    netAvailable =
+        RLESparseResourceAllocation.merge(plan.getResourceCalculator(),
+            plan.getTotalCapacity(), netAvailable, planModifications,
+            RLEOperator.subtract, stageEarliestStart, stageDeadline);
+
-        // compute net available resources
-        Resource netAvailableRes = Resources.clone(totalCapacity);
-        // Resources.addTo(netAvailableRes, oldResCap);
-        Resources.subtractFrom(netAvailableRes,
-            plan.getTotalCommittedResources(t));
-        Resources.subtractFrom(netAvailableRes,
-            planModifications.getCapacityAtTime(t));
+        Resource netAvailableRes = netAvailable.getCapacityAtTime(t);
