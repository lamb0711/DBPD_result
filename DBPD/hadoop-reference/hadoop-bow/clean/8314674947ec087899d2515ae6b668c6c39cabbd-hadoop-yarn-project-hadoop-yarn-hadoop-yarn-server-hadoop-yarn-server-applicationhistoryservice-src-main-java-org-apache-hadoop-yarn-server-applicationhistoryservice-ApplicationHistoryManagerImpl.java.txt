YARN-1685. Fixed few bugs related to handling of containers' log-URLs on ResourceManager and history-service. Contributed by Zhijie Shen.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1578602 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.yarn.webapp.util.WebAppUtils;
+  private String serverHttpAddress;
+    serverHttpAddress = WebAppUtils.getHttpSchemePrefix(conf) +
+        WebAppUtils.getAHSWebAppURLWithoutScheme(conf);
-    return convertToContainerReport(historyStore.getAMContainer(appAttemptId));
+    ApplicationReport app =
+        getApplication(appAttemptId.getApplicationId());
+    return convertToContainerReport(historyStore.getAMContainer(appAttemptId),
+        app == null ? null : app.getUser());
-    return convertToContainerReport(historyStore.getContainer(containerId));
+    ApplicationReport app =
+        getApplication(containerId.getApplicationAttemptId().getApplicationId());
+    return convertToContainerReport(historyStore.getContainer(containerId),
+        app == null ? null: app.getUser());
-      ContainerHistoryData containerHistory) {
+      ContainerHistoryData containerHistory, String user) {
+    // If the container has the aggregated log, add the server root url
+    String logUrl = WebAppUtils.getAggregatedLogURL(
+        serverHttpAddress,
+        containerHistory.getAssignedNode().toString(),
+        containerHistory.getContainerId().toString(),
+        containerHistory.getContainerId().toString(),
+        user);
-      containerHistory.getDiagnosticsInfo(), containerHistory.getLogURL(),
+      containerHistory.getDiagnosticsInfo(), logUrl,
+    ApplicationReport app =
+        getApplication(appAttemptId.getApplicationId());
-        convertToContainerReport(entry.getValue()));
+        convertToContainerReport(entry.getValue(),
+            app == null ? null : app.getUser()));
