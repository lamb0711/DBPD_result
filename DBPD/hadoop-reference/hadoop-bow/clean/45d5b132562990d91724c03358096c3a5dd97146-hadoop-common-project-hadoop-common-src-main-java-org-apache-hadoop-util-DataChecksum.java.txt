Merge changes from trunk

+    if (type.size == 0) return;
+    if (type.size == 0) return;
