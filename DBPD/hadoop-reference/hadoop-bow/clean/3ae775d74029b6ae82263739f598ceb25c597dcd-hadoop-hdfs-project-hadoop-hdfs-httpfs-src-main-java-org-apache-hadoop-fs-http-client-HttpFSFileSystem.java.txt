HDFS-14034. Support getQuotaUsage API in WebHDFS. Contributed by Chao Sun.

Signed-off-by: Wei-Chiu Chuang <weichiu@apache.org>

+import org.apache.hadoop.fs.QuotaUsage;
-  public static final String CONTENT_SUMMARY_QUOTA_JSON = "quota";
-  public static final String CONTENT_SUMMARY_SPACE_CONSUMED_JSON = "spaceConsumed";
-  public static final String CONTENT_SUMMARY_SPACE_QUOTA_JSON = "spaceQuota";
+
+  public static final String QUOTA_USAGE_JSON = "QuotaUsage";
+  public static final String QUOTA_USAGE_FILE_AND_DIRECTORY_COUNT_JSON =
+      "fileAndDirectoryCount";
+  public static final String QUOTA_USAGE_QUOTA_JSON = "quota";
+  public static final String QUOTA_USAGE_SPACE_CONSUMED_JSON = "spaceConsumed";
+  public static final String QUOTA_USAGE_SPACE_QUOTA_JSON = "spaceQuota";
+  public static final String QUOTA_USAGE_CONSUMED_JSON = "consumed";
+  public static final String QUOTA_USAGE_TYPE_QUOTA_JSON = "typeQuota";
+
-    GETFILECHECKSUM(HTTP_GET),  GETFILEBLOCKLOCATIONS(HTTP_GET),
-    INSTRUMENTATION(HTTP_GET), GETACLSTATUS(HTTP_GET), GETTRASHROOT(HTTP_GET),
+    GETQUOTAUSAGE(HTTP_GET), GETFILECHECKSUM(HTTP_GET),
+    GETFILEBLOCKLOCATIONS(HTTP_GET), INSTRUMENTATION(HTTP_GET),
+    GETACLSTATUS(HTTP_GET), GETTRASHROOT(HTTP_GET),
-      HttpFSUtils.jsonParse(conn)).get(CONTENT_SUMMARY_JSON);
-    return new ContentSummary.Builder().
-        length((Long) json.get(CONTENT_SUMMARY_LENGTH_JSON)).
-        fileCount((Long) json.get(CONTENT_SUMMARY_FILE_COUNT_JSON)).
-        directoryCount((Long) json.get(CONTENT_SUMMARY_DIRECTORY_COUNT_JSON)).
-        quota((Long) json.get(CONTENT_SUMMARY_QUOTA_JSON)).
-        spaceConsumed((Long) json.get(CONTENT_SUMMARY_SPACE_CONSUMED_JSON)).
-        spaceQuota((Long) json.get(CONTENT_SUMMARY_SPACE_QUOTA_JSON)).build();
+        HttpFSUtils.jsonParse(conn)).get(CONTENT_SUMMARY_JSON);
+    ContentSummary.Builder builder = new ContentSummary.Builder()
+        .length((Long) json.get(CONTENT_SUMMARY_LENGTH_JSON))
+        .fileCount((Long) json.get(CONTENT_SUMMARY_FILE_COUNT_JSON))
+        .directoryCount((Long) json.get(CONTENT_SUMMARY_DIRECTORY_COUNT_JSON));
+    builder = buildQuotaUsage(builder, json, ContentSummary.Builder.class);
+    return builder.build();
+  }
+
+  @Override
+  public QuotaUsage getQuotaUsage(Path f) throws IOException {
+    Map<String, String> params = new HashMap<>();
+    params.put(OP_PARAM, Operation.GETQUOTAUSAGE.toString());
+    HttpURLConnection conn =
+        getConnection(Operation.GETQUOTAUSAGE.getMethod(), params, f, true);
+    JSONObject json = (JSONObject) ((JSONObject)
+        HttpFSUtils.jsonParse(conn)).get(QUOTA_USAGE_JSON);
+    QuotaUsage.Builder builder = new QuotaUsage.Builder();
+    builder = buildQuotaUsage(builder, json, QuotaUsage.Builder.class);
+    return builder.build();
+  }
+
+  /**
+   * Given a builder for QuotaUsage, parse the provided JSON object and
+   * construct the relevant fields. Return the updated builder.
+   */
+  private static <T extends QuotaUsage.Builder> T buildQuotaUsage(
+      T builder, JSONObject json, Class<T> type) {
+    long quota = (Long) json.get(QUOTA_USAGE_QUOTA_JSON);
+    long spaceConsumed = (Long) json.get(QUOTA_USAGE_SPACE_CONSUMED_JSON);
+    long spaceQuota = (Long) json.get(QUOTA_USAGE_SPACE_QUOTA_JSON);
+    JSONObject typeJson = (JSONObject) json.get(QUOTA_USAGE_TYPE_QUOTA_JSON);
+
+    builder = type.cast(builder
+        .quota(quota)
+        .spaceConsumed(spaceConsumed)
+        .spaceQuota(spaceQuota)
+    );
+
+    // ContentSummary doesn't set this so check before using it
+    if (json.get(QUOTA_USAGE_FILE_AND_DIRECTORY_COUNT_JSON) != null) {
+      long fileAndDirectoryCount = (Long)
+          json.get(QUOTA_USAGE_FILE_AND_DIRECTORY_COUNT_JSON);
+      builder = type.cast(builder.fileAndDirectoryCount(fileAndDirectoryCount));
+    }
+
+    if (typeJson != null) {
+      for (StorageType t : StorageType.getTypesSupportingQuota()) {
+        JSONObject typeQuota = (JSONObject) typeJson.get(t.toString());
+        if (typeQuota != null) {
+          builder = type.cast(builder
+              .typeQuota(t, ((Long) typeQuota.get(QUOTA_USAGE_QUOTA_JSON)))
+              .typeConsumed(t, ((Long) typeQuota.get(QUOTA_USAGE_CONSUMED_JSON))
+          ));
+        }
+      }
+    }
+
+    return builder;
