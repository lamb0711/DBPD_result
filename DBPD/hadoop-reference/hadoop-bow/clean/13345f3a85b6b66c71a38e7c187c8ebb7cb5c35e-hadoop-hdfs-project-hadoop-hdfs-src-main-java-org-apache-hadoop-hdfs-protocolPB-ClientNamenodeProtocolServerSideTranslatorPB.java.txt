HDFS-2663. Handle protobuf optional parameters correctly. Contributed by Suresh Srinivas.



git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1213512 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.protocol.HdfsFileStatus;
+import org.apache.hadoop.hdfs.protocol.LocatedBlock;
+import org.apache.hadoop.hdfs.protocol.LocatedBlocks;
+import org.apache.hadoop.hdfs.protocol.proto.ClientNamenodeProtocolProtos.GetBlockLocationsResponseProto.Builder;
+import org.apache.hadoop.hdfs.server.common.UpgradeStatusReport;
-      return GetBlockLocationsResponseProto
-          .newBuilder()
-          .setLocations(
-              PBHelper.convert(server.getBlockLocations(req.getSrc(),
-                  req.getOffset(), req.getLength()))).build();
+      LocatedBlocks b = server.getBlockLocations(req.getSrc(), req.getOffset(),
+          req.getLength());
+      Builder builder = GetBlockLocationsResponseProto
+          .newBuilder();
+      if (b != null) {
+        builder.setLocations(
+            PBHelper.convert(server.getBlockLocations(req.getSrc(),
+                req.getOffset(), req.getLength()))).build();
+      }
+      return builder.build();
-                PBHelper.convert(req.getPrevious()), 
+                req.hasPrevious() ? PBHelper.convert(req.getPrevious()) : null, 
-      UpgradeStatusReportProto result = PBHelper.convert(server
-          .distributedUpgradeProgress(PBHelper.convert(req.getAction())));
-      return DistributedUpgradeProgressResponseProto.newBuilder()
-          .setReport(result).build();
+      UpgradeStatusReport result = server.distributedUpgradeProgress(PBHelper
+          .convert(req.getAction()));
+      DistributedUpgradeProgressResponseProto.Builder builder = 
+          DistributedUpgradeProgressResponseProto.newBuilder();
+      if (result != null) {
+        builder.setReport(PBHelper.convert(result));
+      }
+      return builder.build();
-      HdfsFileStatusProto result = 
-          PBHelper.convert(server.getFileInfo(req.getSrc()));
-      return GetFileInfoResponseProto.newBuilder().setFs(result).build();
+      HdfsFileStatus res = server.getFileInfo(req.getSrc());
+      GetFileInfoResponseProto.Builder builder = 
+          GetFileInfoResponseProto.newBuilder();
+      if (res != null) {
+        builder.setFs(PBHelper.convert(res));
+      }
+      return builder.build();
