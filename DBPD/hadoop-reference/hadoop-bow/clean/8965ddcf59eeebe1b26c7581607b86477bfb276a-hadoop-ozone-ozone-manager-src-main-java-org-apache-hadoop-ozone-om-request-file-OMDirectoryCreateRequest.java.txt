HDDS-1731. Implement File CreateFile Request to use Cache and DoubleBuffer. (#1044)



-import java.nio.file.Path;
+import static org.apache.hadoop.ozone.om.request.file.OMFileRequest.OMDirectoryResult.DIRECTORY_EXISTS_IN_GIVENPATH;
+import static org.apache.hadoop.ozone.om.request.file.OMFileRequest.OMDirectoryResult.FILE_EXISTS_IN_GIVENPATH;
+import static org.apache.hadoop.ozone.om.request.file.OMFileRequest.OMDirectoryResult.NONE;
+import static org.apache.hadoop.ozone.om.request.file.OMFileRequest.OMDirectoryResult.FILE_EXISTS;
-      OMDirectoryResult omDirectoryResult = verifyFilesInPath(omMetadataManager,
-          volumeName, bucketName, omMetadataManager.getOzoneDirKey(volumeName,
-              bucketName, keyName), Paths.get(keyName));
+      OMFileRequest.OMDirectoryResult omDirectoryResult =
+          OMFileRequest.verifyFilesInPath(omMetadataManager,
+          volumeName, bucketName, keyName, Paths.get(keyName));
-      if (omDirectoryResult == OMDirectoryResult.FILE_ALREADY_EXISTS) {
+      if (omDirectoryResult == FILE_EXISTS ||
+          omDirectoryResult == FILE_EXISTS_IN_GIVENPATH) {
-      } else if (omDirectoryResult == OMDirectoryResult.SUB_DIRECTORY_EXISTS ||
-          omDirectoryResult == OMDirectoryResult.NONE) {
+      } else if (omDirectoryResult == DIRECTORY_EXISTS_IN_GIVENPATH ||
+          omDirectoryResult == NONE) {
-  /**
-   * Verify any files exist in the given path in the specified volume/bucket.
-   * @param omMetadataManager
-   * @param volumeName
-   * @param bucketName
-   * @param keyPath
-   * @return true - if file exist in the given path, else false.
-   * @throws IOException
-   */
-  private OMDirectoryResult verifyFilesInPath(
-      OMMetadataManager omMetadataManager, String volumeName, String bucketName,
-      String directoryName, Path keyPath) throws IOException {
-
-    while (keyPath != null) {
-      String keyName = keyPath.toString();
-
-      String dbKeyName = omMetadataManager.getOzoneKey(volumeName,
-          bucketName, keyName);
-      String dbDirKeyName = omMetadataManager.getOzoneDirKey(volumeName,
-          bucketName, keyName);
-
-      if (omMetadataManager.getKeyTable().get(dbKeyName) != null) {
-        // Found a file in the given path.
-        return OMDirectoryResult.FILE_ALREADY_EXISTS;
-      } else if (omMetadataManager.getKeyTable().get(dbDirKeyName) != null) {
-        if (dbDirKeyName.equals(directoryName)) {
-          return OMDirectoryResult.DIRECTORY_ALREADY_EXISTS;
-        } else {
-          return OMDirectoryResult.SUB_DIRECTORY_EXISTS;
-        }
-      }
-      keyPath = keyPath.getParent();
-    }
-
-    // Found no files/ directories in the given path.
-    return OMDirectoryResult.NONE;
-  }
-
-
-  /**
-   * Return codes used by verifyFilesInPath method.
-   */
-  enum OMDirectoryResult {
-    DIRECTORY_ALREADY_EXISTS,
-    FILE_ALREADY_EXISTS,
-    SUB_DIRECTORY_EXISTS,
-    NONE
-  }
-
