HDDS-1856. Make required changes for Non-HA to use new HA code in OM. (#1174)


+import org.apache.hadoop.ozone.om.ratis.utils.OzoneManagerDoubleBufferHelper;
-      long transactionLogIndex) {
+      long transactionLogIndex,
+      OzoneManagerDoubleBufferHelper ozoneManagerDoubleBufferHelper) {
-    VolumeList volumeList = null;
-    OmVolumeArgs omVolumeArgs = null;
-    OmBucketInfo omBucketInfo = null;
+    OMClientResponse omClientResponse = null;
+      OMVolumeCreateResponse omVolumeCreateResponse = null;
-          omVolumeArgs = createOmVolumeArgs(volumeName, userName,
+          OmVolumeArgs omVolumeArgs = createOmVolumeArgs(volumeName, userName,
-          volumeList = omMetadataManager.getUserTable().get(
+          VolumeList volumeList = omMetadataManager.getUserTable().get(
+          omVolumeCreateResponse = new OMVolumeCreateResponse(omVolumeArgs,
+              volumeList, omResponse.build());
-      omBucketInfo = createBucket(omMetadataManager, volumeName, s3BucketName,
+      OmBucketInfo omBucketInfo = createBucket(omMetadataManager, volumeName,
+          s3BucketName,
+
+      OMBucketCreateResponse omBucketCreateResponse =
+          new OMBucketCreateResponse(omBucketInfo, omResponse.build());
+
+      omClientResponse = new S3BucketCreateResponse(omVolumeCreateResponse,
+          omBucketCreateResponse, s3BucketName,
+          formatS3MappingName(volumeName, s3BucketName),
+          omResponse.setCreateS3BucketResponse(
+              S3CreateBucketResponse.newBuilder()).build());
+      omClientResponse = new S3BucketCreateResponse(null, null, null, null,
+          createErrorOMResponse(omResponse, exception));
+      if (omClientResponse != null) {
+        omClientResponse.setFlushFuture(
+            ozoneManagerDoubleBufferHelper.add(omClientResponse,
+                transactionLogIndex));
+      }
-        omVolumeCreateResponse = new OMVolumeCreateResponse(omVolumeArgs,
-            volumeList, omResponse.build());
-
-      OMBucketCreateResponse omBucketCreateResponse =
-          new OMBucketCreateResponse(omBucketInfo, omResponse.build());
-      return new S3BucketCreateResponse(omVolumeCreateResponse,
-          omBucketCreateResponse, s3BucketName,
-          formatS3MappingName(volumeName, s3BucketName),
-          omResponse.setCreateS3BucketResponse(
-              S3CreateBucketResponse.newBuilder()).build());
+
+      return omClientResponse;
-      return new S3BucketCreateResponse(null, null, null, null,
-          createErrorOMResponse(omResponse, exception));
+      return omClientResponse;
