Merging trunk to HDFS-1623 branch.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1179484 13f79535-47bb-0310-9956-ffa450edef68

-import java.net.InetAddress;
-import org.apache.hadoop.yarn.util.Records;
+  private NodeId nodeId;
-  private String containerManagerBindAddress;
-  private String hostName;
-  private int containerManagerPort;
-  private NodeId nodeId;
-    String cmBindAddressStr =
-        getConfig().get(YarnConfiguration.NM_ADDRESS,
-            YarnConfiguration.DEFAULT_NM_ADDRESS);
-    InetSocketAddress cmBindAddress =
-        NetUtils.createSocketAddr(cmBindAddressStr);
+
+    // NodeManager is the last service to start, so NodeId is available.
+    this.nodeId = this.context.getNodeId();
+
-      this.hostName = InetAddress.getLocalHost().getHostAddress();
-      this.containerManagerPort = cmBindAddress.getPort();
+      //      this.hostName = InetAddress.getLocalHost().getCanonicalHostName();
-      this.containerManagerBindAddress =
-          this.hostName + ":" + this.containerManagerPort;
-      LOG.info("Configured ContainerManager Address is "
-          + this.containerManagerBindAddress);
-    YarnRPC rpc = YarnRPC.create(getConfig());
+    Configuration conf = getConfig();
+    YarnRPC rpc = YarnRPC.create(conf);
-    Configuration rmClientConf = new Configuration(getConfig());
-    rmClientConf.setClass(
-        YarnConfiguration.YARN_SECURITY_INFO,
-        RMNMSecurityInfoClass.class, SecurityInfo.class);
-        rmClientConf);
+        conf);
-    this.nodeId = Records.newRecord(NodeId.class);
-    this.nodeId.setHost(this.hostName);
-    this.nodeId.setPort(this.containerManagerPort);
-          this.getContainerManagerBindAddress(),
+          this.nodeId.toString(),
-    LOG.info("Registered with ResourceManager as " + this.containerManagerBindAddress
+    LOG.info("Registered with ResourceManager as " + this.nodeId
-  public String getContainerManagerBindAddress() {
-    return this.containerManagerBindAddress;
-  }
-
-  @Override
-    LOG.debug(this.containerManagerBindAddress + " sending out status for " + numActiveContainers
-        + " containers");
+    LOG.debug(this.nodeId + " sending out status for "
+        + numActiveContainers + " containers");
