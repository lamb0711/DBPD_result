HDFS-4563. Update namespace/diskspace usage after deleting snapshots.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1455396 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.protocol.QuotaExceededException;
+import org.apache.hadoop.hdfs.server.namenode.Quota;
-  public int clear() {
-    final int n = diffs.size();
+  public void clear() {
-    return n;
-  final int deleteSnapshotDiff(final Snapshot snapshot, Snapshot prior,
-      final N currentINode, final BlocksMapUpdateInfo collectedBlocks) {
+  final Quota.Counts deleteSnapshotDiff(final Snapshot snapshot,
+      Snapshot prior, final N currentINode,
+      final BlocksMapUpdateInfo collectedBlocks) {
-    int removedNum = 0;
+    Quota.Counts counts = Quota.Counts.newInstance();
-        removedNum++; // removed a diff
-        removedNum += removed.destroyAndCollectBlocks(currentINode,
-            collectedBlocks);
+        counts.add(Quota.NAMESPACE, 1);
+        counts.add(removed.destroyDiffAndCollectBlocks(currentINode,
+            collectedBlocks));
-        removedNum++;
+        counts.add(Quota.NAMESPACE, 1);
-        removedNum += previous.combinePosteriorAndCollectBlocks(currentINode,
-            removed, collectedBlocks);
+        counts.add(previous.combinePosteriorAndCollectBlocks(
+            currentINode, removed, collectedBlocks));
-    return removedNum;
+    return counts;
-      throws NSQuotaExceededException {
-    currentINode.addNamespaceConsumed(1);
+      throws QuotaExceededException {
+    currentINode.addSpaceConsumed(1, 0);
-      throws NSQuotaExceededException {
+      throws QuotaExceededException {
-      throws NSQuotaExceededException {
+      throws QuotaExceededException {
