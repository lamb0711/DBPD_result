YARN-6526. Refactoring SQLFederationStateStore by avoiding to recreate a connection at every call. COntributed by Bilwa S T.

+import com.google.common.annotations.VisibleForTesting;
+  @VisibleForTesting
+  Connection conn = null;
+    try {
+      conn = getConnection();
+      LOG.debug("Connection created");
+    } catch (SQLException e) {
+      FederationStateStoreUtils.logAndThrowRetriableException(LOG,
+          "Not able to get Connection", e);
+    }
-    Connection conn = null;
-      conn = getConnection();
-      cstmt = conn.prepareCall(CALL_SP_REGISTER_SUBCLUSTER);
+      cstmt = getCallableStatement(CALL_SP_REGISTER_SUBCLUSTER);
-      // Return to the pool the CallableStatement and the Connection
-      FederationStateStoreUtils.returnToPool(LOG, cstmt, conn);
+      // Return to the pool the CallableStatement
+      FederationStateStoreUtils.returnToPool(LOG, cstmt);
+
-    Connection conn = null;
-      conn = getConnection();
-      cstmt = conn.prepareCall(CALL_SP_DEREGISTER_SUBCLUSTER);
+      cstmt = getCallableStatement(CALL_SP_DEREGISTER_SUBCLUSTER);
-      // Return to the pool the CallableStatement and the Connection
-      FederationStateStoreUtils.returnToPool(LOG, cstmt, conn);
+      // Return to the pool the CallableStatement
+      FederationStateStoreUtils.returnToPool(LOG, cstmt);
-    Connection conn = null;
-      conn = getConnection();
-      cstmt = conn.prepareCall(CALL_SP_SUBCLUSTER_HEARTBEAT);
+      cstmt = getCallableStatement(CALL_SP_SUBCLUSTER_HEARTBEAT);
-      // Return to the pool the CallableStatement and the Connection
-      FederationStateStoreUtils.returnToPool(LOG, cstmt, conn);
+      // Return to the pool the CallableStatement
+      FederationStateStoreUtils.returnToPool(LOG, cstmt);
-    Connection conn = null;
-      conn = getConnection();
-      cstmt = conn.prepareCall(CALL_SP_GET_SUBCLUSTER);
+      cstmt = getCallableStatement(CALL_SP_GET_SUBCLUSTER);
-      // Return to the pool the CallableStatement and the Connection
-      FederationStateStoreUtils.returnToPool(LOG, cstmt, conn);
+      // Return to the pool the CallableStatement
+      FederationStateStoreUtils.returnToPool(LOG, cstmt);
-    Connection conn = null;
-      conn = getConnection();
-      cstmt = conn.prepareCall(CALL_SP_GET_SUBCLUSTERS);
+      cstmt = getCallableStatement(CALL_SP_GET_SUBCLUSTERS);
-      // Return to the pool the CallableStatement and the Connection
-      FederationStateStoreUtils.returnToPool(LOG, cstmt, conn, rs);
+      // Return to the pool the CallableStatement
+      FederationStateStoreUtils.returnToPool(LOG, cstmt, null, rs);
-    Connection conn = null;
-      conn = getConnection();
-      cstmt = conn.prepareCall(CALL_SP_ADD_APPLICATION_HOME_SUBCLUSTER);
+      cstmt = getCallableStatement(CALL_SP_ADD_APPLICATION_HOME_SUBCLUSTER);
-      // Return to the pool the CallableStatement and the Connection
-      FederationStateStoreUtils.returnToPool(LOG, cstmt, conn);
+      // Return to the pool the CallableStatement
+      FederationStateStoreUtils.returnToPool(LOG, cstmt);
-    Connection conn = null;
-      conn = getConnection();
-      cstmt = conn.prepareCall(CALL_SP_UPDATE_APPLICATION_HOME_SUBCLUSTER);
+      cstmt = getCallableStatement(CALL_SP_UPDATE_APPLICATION_HOME_SUBCLUSTER);
-      // Return to the pool the CallableStatement and the Connection
-      FederationStateStoreUtils.returnToPool(LOG, cstmt, conn);
+      // Return to the pool the CallableStatement
+      FederationStateStoreUtils.returnToPool(LOG, cstmt);
-    Connection conn = null;
-      conn = getConnection();
-      cstmt = conn.prepareCall(CALL_SP_GET_APPLICATION_HOME_SUBCLUSTER);
+      cstmt = getCallableStatement(CALL_SP_GET_APPLICATION_HOME_SUBCLUSTER);
-
-      // Return to the pool the CallableStatement and the Connection
-      FederationStateStoreUtils.returnToPool(LOG, cstmt, conn);
+      // Return to the pool the CallableStatement
+      FederationStateStoreUtils.returnToPool(LOG, cstmt);
-    Connection conn = null;
-      conn = getConnection();
-      cstmt = conn.prepareCall(CALL_SP_GET_APPLICATIONS_HOME_SUBCLUSTER);
+      cstmt = getCallableStatement(CALL_SP_GET_APPLICATIONS_HOME_SUBCLUSTER);
-      // Return to the pool the CallableStatement and the Connection
-      FederationStateStoreUtils.returnToPool(LOG, cstmt, conn, rs);
+      // Return to the pool the CallableStatement
+      FederationStateStoreUtils.returnToPool(LOG, cstmt, null, rs);
-    Connection conn = null;
-      conn = getConnection();
-      cstmt = conn.prepareCall(CALL_SP_DELETE_APPLICATION_HOME_SUBCLUSTER);
+      cstmt = getCallableStatement(CALL_SP_DELETE_APPLICATION_HOME_SUBCLUSTER);
-      // Return to the pool the CallableStatement and the Connection
-      FederationStateStoreUtils.returnToPool(LOG, cstmt, conn);
+      // Return to the pool the CallableStatement
+      FederationStateStoreUtils.returnToPool(LOG, cstmt);
-    Connection conn = null;
-      conn = getConnection();
-      cstmt = conn.prepareCall(CALL_SP_GET_POLICY_CONFIGURATION);
+      cstmt = getCallableStatement(CALL_SP_GET_POLICY_CONFIGURATION);
-      // Return to the pool the CallableStatement and the Connection
-      FederationStateStoreUtils.returnToPool(LOG, cstmt, conn);
+      // Return to the pool the CallableStatement
+      FederationStateStoreUtils.returnToPool(LOG, cstmt);
-    Connection conn = null;
-      conn = getConnection();
-      cstmt = conn.prepareCall(CALL_SP_SET_POLICY_CONFIGURATION);
+      cstmt = getCallableStatement(CALL_SP_SET_POLICY_CONFIGURATION);
-      // Return to the pool the CallableStatement and the Connection
-      FederationStateStoreUtils.returnToPool(LOG, cstmt, conn);
+      // Return to the pool the CallableStatement
+      FederationStateStoreUtils.returnToPool(LOG, cstmt);
-    Connection conn = null;
-      conn = getConnection();
-      cstmt = conn.prepareCall(CALL_SP_GET_POLICIES_CONFIGURATIONS);
+      cstmt = getCallableStatement(CALL_SP_GET_POLICIES_CONFIGURATIONS);
-      // Return to the pool the CallableStatement and the Connection
-      FederationStateStoreUtils.returnToPool(LOG, cstmt, conn, rs);
+      // Return to the pool the CallableStatement
+      FederationStateStoreUtils.returnToPool(LOG, cstmt, null, rs);
+      LOG.debug("Connection closed");
+      FederationStateStoreClientMetrics.decrConnections();
+    FederationStateStoreClientMetrics.incrConnections();
+  private CallableStatement getCallableStatement(String procedure)
+      throws SQLException {
+    return conn.prepareCall(procedure);
+  }
+
