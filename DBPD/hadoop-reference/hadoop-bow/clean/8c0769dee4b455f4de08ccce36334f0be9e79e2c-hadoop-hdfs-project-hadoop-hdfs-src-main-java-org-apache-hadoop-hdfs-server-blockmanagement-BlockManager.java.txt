HDFS-11960. Successfully closed files can stay under-replicated. Contributed by Kihwal Lee.

-    if (storedBlock != null) {
+    if (storedBlock != null &&
+        block.getGenerationStamp() == storedBlock.getGenerationStamp()) {
