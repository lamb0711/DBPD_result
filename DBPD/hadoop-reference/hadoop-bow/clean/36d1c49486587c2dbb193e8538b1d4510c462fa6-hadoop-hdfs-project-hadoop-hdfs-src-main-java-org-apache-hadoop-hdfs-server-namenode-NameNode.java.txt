HDFS-2693. Fix synchronization issues around state transition. Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1221582 13f79535-47bb-0310-9956-ffa450edef68

+  protected boolean allowStaleStandbyReads;
-    this.haContext = new NameNodeHAContext();
+    this.allowStaleStandbyReads = HAUtil.shouldAllowStandbyReads(conf);
+    this.haContext = createHAContext();
+  protected HAContext createHAContext() {
+    return new NameNodeHAContext();
+  }
+
-  /** Check if an operation of given category is allowed */
-  protected synchronized void checkOperation(final OperationCategory op)
-      throws StandbyException {
-    state.checkOperation(haContext, op);
-  }
-  private class NameNodeHAContext implements HAContext {
+  protected class NameNodeHAContext implements HAContext {
+    
+    @Override
+    public void writeLock() {
+      namesystem.writeLock();
+    }
+    
+    @Override
+    public void writeUnlock() {
+      namesystem.writeUnlock();
+    }
+    
+    /** Check if an operation of given category is allowed */
+    @Override
+    public void checkOperation(final OperationCategory op)
+        throws StandbyException {
+      state.checkOperation(haContext, op);
+    }
+    
+    @Override
+    public boolean allowStaleReads() {
+      return allowStaleStandbyReads;
+    }
