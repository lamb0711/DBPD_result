YARN-1152. Fixed a bug in ResourceManager that was causing clients to get invalid client token key errors when an appliation is about to finish. Contributed by Jason Lowe.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1521292 13f79535-47bb-0310-9956-ffa450edef68

-          if (UserGroupInformation.isSecurityEnabled()
-              && clientUserName != null) {
+          if (UserGroupInformation.isSecurityEnabled()) {
+            // get a token so the client can communicate with the app attempt
+            // NOTE: token may be unavailable if the attempt is not running
-                new Token<ClientToAMTokenIdentifier>(
-                    new ClientToAMTokenIdentifier(
-                        currentApplicationAttemptId, clientUserName),
-                        rmContext.getClientToAMTokenSecretManager());
-            clientToAMToken = BuilderUtils.newClientToAMToken(
-                attemptClientToAMToken.getIdentifier(),
-                attemptClientToAMToken.getKind().toString(),
-                attemptClientToAMToken.getPassword(),
-                attemptClientToAMToken.getService().toString());
+                this.currentAttempt.createClientToken(clientUserName);
+            if (attemptClientToAMToken != null) {
+              clientToAMToken = BuilderUtils.newClientToAMToken(
+                  attemptClientToAMToken.getIdentifier(),
+                  attemptClientToAMToken.getKind().toString(),
+                  attemptClientToAMToken.getPassword(),
+                  attemptClientToAMToken.getService().toString());
+            }
