HDFS-5963. TestRollingUpgrade#testSecondaryNameNode causes subsequent tests to fail. (Contributed by szetszwo)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535@1569993 13f79535-47bb-0310-9956-ffa450edef68

-      final String action = "start rolling upgrade";
-      checkNameNodeSafeMode("Failed to " + action);
-      checkRollingUpgrade(action);
-      getFSImage().checkUpgrade(this);
-
-      getFSImage().saveNamespace(this, NameNodeFile.IMAGE_ROLLBACK, null);
-      LOG.info("Successfully saved namespace for preparing rolling upgrade.");
-
-      setRollingUpgradeInfo(now());
+      checkNameNodeSafeMode("Failed to start rolling upgrade");
+      startRollingUpgradeInternal(now(), true);
+
+  /**
+   * Update internal state to indicate that a rolling upgrade is in progress.
+   * Ootionally create a checkpoint before starting the RU.
+   * @param startTime
+   * @param saveNamespace If true then a checkpoint is created before initiating
+   *                   the rolling upgrade.
+   */
+  void startRollingUpgradeInternal(long startTime, boolean saveNamespace)
+      throws IOException {
+    checkRollingUpgrade("start rolling upgrade");
+    getFSImage().checkUpgrade(this);
+
+    if (saveNamespace) {
+      getFSImage().saveNamespace(this, NameNodeFile.IMAGE_ROLLBACK, null);
+      LOG.info("Successfully saved namespace for preparing rolling upgrade.");
+    }
+    setRollingUpgradeInfo(startTime);
+  }
+
-  
+
-      final String err = "Failed to finalize rolling upgrade";
-      checkNameNodeSafeMode(err);
+      checkNameNodeSafeMode("Failed to finalize rolling upgrade");
-      if (!isRollingUpgrade()) {
-        throw new RollingUpgradeException(err
-            + " since there is no rolling upgrade in progress.");
-      }
-
-      returnInfo = new RollingUpgradeInfo(blockPoolId,
-          rollingUpgradeInfo.getStartTime(), now());
-      rollingUpgradeInfo = null;
+      returnInfo = finalizeRollingUpgradeInternal(now());
+    // getEditLog().logSync() is not needed since it does saveNamespace 
+
+  RollingUpgradeInfo finalizeRollingUpgradeInternal(long finalizeTime)
+      throws RollingUpgradeException {
+    if (!isRollingUpgrade()) {
+      throw new RollingUpgradeException(
+          "Failed to finalize rolling upgrade since there is no rolling upgrade in progress.");
+    }
+
+    final long startTime = rollingUpgradeInfo.getStartTime();
+    rollingUpgradeInfo = null;
+    return new RollingUpgradeInfo(blockPoolId, startTime, finalizeTime);
+  }
+
