Merging trunk to HDFS-1623 branch.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1179484 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.yarn.api.records.FinalApplicationStatus;
-import org.apache.hadoop.yarn.api.records.ApplicationState;
+import org.apache.hadoop.yarn.api.records.YarnApplicationState;
-                                           RMAppEvent> stateMachineFactory 
+                                           RMAppEvent> stateMachineFactory
-      ApplicationStore appStore, 
+      ApplicationStore appStore,
-  public String getAMFinalState() {
+  public FinalApplicationStatus getFinalApplicationStatus() {
-      if (currentAttempt != null) {
-        return currentAttempt.getAMFinalState();
+      // finish state is obtained based on the state machine's current state 
+      // as a fall-back in case the application has not been unregistered 
+      // ( or if the app never unregistered itself )
+      // when the report is requested
+      if (currentAttempt != null 
+          && currentAttempt.getFinalApplicationStatus() != null) {
+        return currentAttempt.getFinalApplicationStatus();   
-      return "UNKNOWN";
+      return createFinalApplicationStatus(this.stateMachine.getCurrentState());
-  
+
-  private ApplicationState createApplicationState(RMAppState rmAppState) {
+  private YarnApplicationState createApplicationState(RMAppState rmAppState) {
-      return ApplicationState.NEW;
+      return YarnApplicationState.NEW;
-      return ApplicationState.SUBMITTED;
+      return YarnApplicationState.SUBMITTED;
-      return ApplicationState.RUNNING;
+      return YarnApplicationState.RUNNING;
-      return ApplicationState.SUCCEEDED;
+      return YarnApplicationState.FINISHED;
-      return ApplicationState.KILLED;
+      return YarnApplicationState.KILLED;
-      return ApplicationState.FAILED;
+      return YarnApplicationState.FAILED;
+  private FinalApplicationStatus createFinalApplicationStatus(RMAppState state) {
+    switch(state) {
+    case NEW:
+    case SUBMITTED:
+    case ACCEPTED:
+    case RUNNING:
+      return FinalApplicationStatus.UNDEFINED;    
+    // finished without a proper final state is the same as failed  
+    case FINISHED:
+    case FAILED:
+      return FinalApplicationStatus.FAILED;
+    case KILLED:
+      return FinalApplicationStatus.KILLED;
+    }
+    throw new YarnException("Unknown state passed!");
+  }
+
+  
+      FinalApplicationStatus finishState = getFinalApplicationStatus();
-          this.diagnostics.toString(), trackingUrl, 
-          this.startTime, this.finishTime);
+          this.diagnostics.toString(), trackingUrl,
+          this.startTime, this.finishTime, finishState);
-      app.handler.handle(new RMAppAttemptEvent(app.currentAttempt.getAppAttemptId(), 
+      app.handler.handle(new RMAppAttemptEvent(app.currentAttempt.getAppAttemptId(),
-          new RMAppManagerEvent(app.applicationId, 
+          new RMAppManagerEvent(app.applicationId,
-      
+
-      app.createNewAttempt();     
+      app.createNewAttempt();
