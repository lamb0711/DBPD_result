HDFS-4773. Fix bugs in quota usage computation and OfflineImageViewer.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1477367 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.server.namenode.INodeId;
-  private final Map<String, String> nodeMap = new HashMap<String, String>();
+  private final Map<Long, String> subtreeMap = new HashMap<Long, String>();
+  private final Map<Long, String> dirNodeMap = new HashMap<Long, String>();
-      nodeMap.clear();
+      subtreeMap.clear();
+      dirNodeMap.clear();
-    // 1. load dir name
-    String dirName = FSImageSerialization.readString(in);
+    // 1. load dir node id
+    long inodeId = in.readLong();
-    String oldValue = nodeMap.put(dirName, dirName);
+    String dirName = dirNodeMap.get(inodeId);
+    String oldValue = subtreeMap.put(inodeId, dirName);
+    boolean supportInodeId = 
+        LayoutVersion.supports(Feature.ADD_INODE_ID, imageVersion);
+    long inodeId = INodeId.GRANDFATHER_INODE_ID;
-    if (LayoutVersion.supports(Feature.ADD_INODE_ID, imageVersion)) {
-      v.visit(ImageElement.INODE_ID, in.readLong());
+    if (supportInodeId) {
+      inodeId = in.readLong();
+      v.visit(ImageElement.INODE_ID, inodeId);
+      if (supportSnapshot && supportInodeId) {
+        dirNodeMap.put(inodeId, pathName);
+      }
