Merging r1539737 through r1539896 from trunk to branch HDFS-2832

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2832@1539898 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.hdfs.protocol.AddPathBasedCacheDirectiveException;
-import org.apache.hadoop.hdfs.protocol.PathBasedCacheDescriptor;
-import org.apache.hadoop.hdfs.protocol.RemovePathBasedCacheDescriptorException;
-        PathBasedCacheDescriptor descriptor =
-            dfs.addPathBasedCacheDirective(directive);
-        System.out.println("Added PathBasedCache entry "
-            + descriptor.getEntryId());
-      } catch (AddPathBasedCacheDirectiveException e) {
+        long id = dfs.addPathBasedCacheDirective(directive);
+        System.out.println("Added PathBasedCache entry " + id);
+      } catch (IOException e) {
-        dfs.getClient().removePathBasedCacheDescriptor(id);
+        dfs.getClient().removePathBasedCacheDirective(id);
-      } catch (RemovePathBasedCacheDescriptorException e) {
+      } catch (IOException e) {
-      return "[" + getName() + " <path>]\n";
+      return "[" + getName() + " -path <path>]\n";
-      listing.addRow("<path>", "The path of the cache directives to remove.  " +
+      listing.addRow("-path <path>", "The path of the cache directives to remove.  " +
-      RemoteIterator<PathBasedCacheDescriptor> iter =
-          dfs.listPathBasedCacheDescriptors(null, new Path(path));
+      RemoteIterator<PathBasedCacheDirective> iter =
+          dfs.listPathBasedCacheDirectives(
+              new PathBasedCacheDirective.Builder().
+                  setPath(new Path(path)).build());
-        PathBasedCacheDescriptor entry = iter.next();
+        PathBasedCacheDirective directive = iter.next();
-          dfs.removePathBasedCacheDescriptor(entry);
+          dfs.removePathBasedCacheDirective(directive.getId());
-              entry.getEntryId());
-        } catch (RemovePathBasedCacheDescriptorException e) {
+              directive.getId());
+        } catch (IOException e) {
+      PathBasedCacheDirective.Builder builder =
+          new PathBasedCacheDirective.Builder();
+      if (pathFilter != null) {
+        builder.setPath(new Path(pathFilter));
+      }
+      if (poolFilter != null) {
+        builder.setPool(poolFilter);
+      }
-      RemoteIterator<PathBasedCacheDescriptor> iter =
-          dfs.listPathBasedCacheDescriptors(poolFilter, pathFilter != null ?
-              new Path(pathFilter) : null);
+      RemoteIterator<PathBasedCacheDirective> iter =
+          dfs.listPathBasedCacheDirectives(builder.build());
-        PathBasedCacheDescriptor entry = iter.next();
+        PathBasedCacheDirective directive = iter.next();
-            "" + entry.getEntryId(), entry.getPool(),
-            entry.getPath().toUri().getPath(),
+            "" + directive.getId(), directive.getPool(),
+            directive.getPath().toUri().getPath(),
-      commandName = commandName.replaceAll("^[-]*", "");
