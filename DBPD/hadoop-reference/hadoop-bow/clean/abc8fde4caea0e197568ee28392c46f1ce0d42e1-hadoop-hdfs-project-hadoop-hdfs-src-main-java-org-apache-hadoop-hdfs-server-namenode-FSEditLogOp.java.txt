HDFS-13596. NN restart fails after RollingUpgrade from 2.x to 3.x. Contributed by Fei Hui.

+  public void writeFields(DataOutputStream out, int logVersion)
+      throws IOException {
+    writeFields(out);
+  }
+
+      throw new IOException("Unsupported without logversion");
+    }
+
+    @Override
+    public void writeFields(DataOutputStream out, int logVersion)
+        throws IOException {
-        FSImageSerialization.writeByte(erasureCodingPolicyId, out);
+        if (NameNodeLayoutVersion.supports(
+            NameNodeLayoutVersion.Feature.ERASURE_CODING, logVersion)) {
+          FSImageSerialization.writeByte(erasureCodingPolicyId, out);
+        }
+     * @param logVersion The version of edit log
-    public void writeOp(FSEditLogOp op) throws IOException {
+    public void writeOp(FSEditLogOp op, int logVersion)
+        throws IOException {
-      op.writeFields(buf);
+      op.writeFields(buf, logVersion);
