HADOOP-15659. Code changes for bug fix and new tests.
Contributed by Da Zhou.

+  private boolean supportFlush;
-      final int bufferSize) {
+      final int bufferSize,
+      final boolean supportFlush) {
+    this.supportFlush = supportFlush;
-    flushInternalAsync();
+    if (supportFlush) {
+      flushInternalAsync();
+    }
-    flushInternal();
+    if (supportFlush) {
+      flushInternal();
+    }
-    flushInternal();
+    if (supportFlush) {
+      flushInternal();
+    }
-          ex = (AzureBlobFileSystemException)ex.getCause();
+          ex = (AzureBlobFileSystemException) ex.getCause();
-
-    this.lastTotalAppendOffset = 0;
-        lastError = (AzureBlobFileSystemException)e.getCause();
+        lastError = (AzureBlobFileSystemException) e.getCause();
-        lastError = (IOException)new InterruptedIOException(e.toString()).initCause(e);
+        lastError = (IOException) new InterruptedIOException(e.toString()).initCause(e);
