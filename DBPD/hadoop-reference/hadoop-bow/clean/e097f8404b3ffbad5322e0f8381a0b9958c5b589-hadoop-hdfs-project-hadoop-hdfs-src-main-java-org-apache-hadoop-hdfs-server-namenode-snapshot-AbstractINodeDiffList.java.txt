HDFS-4773. Fix bugs in quota usage computation and OfflineImageViewer.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1477367 13f79535-47bb-0310-9956-ffa450edef68

-   * Search for the snapshot whose id is 1) no larger than the given id, and 2)
-   * most close to the given id
-   */
-  public final Snapshot searchSnapshotById(final int snapshotId) {
-    final int i = Collections.binarySearch(diffs, snapshotId);
-    if (i == -1) {
-      return null;
-    } else {
-      int index = i < 0 ? -i - 2 : i;
-      return diffs.get(index).getSnapshot();
-    }
-  }
-  
-  /**
-    if (snapshot == null) {
-      // snapshot == null means the current state, therefore, return null.
+    return getDiffById(snapshot == null ? 
+        Snapshot.INVALID_ID : snapshot.getId());
+  }
+  
+  private final D getDiffById(final int snapshotId) {
+    if (snapshotId == Snapshot.INVALID_ID) {
-    final int i = Collections.binarySearch(diffs, snapshot.getId());
+    final int i = Collections.binarySearch(diffs, snapshotId);
-      // snapshot was not recorded.  Thus, return the next state.
+      // snapshot was not recorded. Thus, return the next state.
+   * Search for the snapshot whose id is 1) no less than the given id, 
+   * and 2) most close to the given id.
+   */
+  public final Snapshot getSnapshotById(final int snapshotId) {
+    D diff = getDiffById(snapshotId);
+    return diff == null ? null : diff.getSnapshot();
+  }
+  
+  /**
