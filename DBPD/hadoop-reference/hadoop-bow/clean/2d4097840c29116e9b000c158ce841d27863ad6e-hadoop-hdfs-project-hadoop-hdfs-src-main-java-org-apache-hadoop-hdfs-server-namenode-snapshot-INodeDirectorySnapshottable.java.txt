HDFS-4244. Support snapshot deletion.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1430953 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.util.ReadOnlyList;
+  
+  /**
+   * Remove the snapshot with the given name from {@link #snapshotsByNames},
+   * and delete all the corresponding SnapshotDiff.
+   * 
+   * @param snapshotName The name of the snapshot to be removed
+   * @param collectedBlocks Used to collect information to update blocksMap
+   * @return The removed snapshot. Null if no snapshot with the given name 
+   *         exists.
+   */
+  Snapshot removeSnapshot(String snapshotName,
+      BlocksMapUpdateInfo collectedBlocks) throws SnapshotException {
+    final int indexOfOld = searchSnapshot(DFSUtil.string2Bytes(snapshotName));
+    if (indexOfOld < 0) {
+      throw new SnapshotException("Cannot delete snapshot " + snapshotName
+          + " from path " + this.getFullPathName()
+          + ": the snapshot does not exist.");
+    } else {
+      Snapshot snapshot = snapshotsByNames.remove(indexOfOld);
+      deleteDiffsForSnapshot(snapshot, this, collectedBlocks);
+      return snapshot;
+    }
+  }
+  
+  /**
+   * Recursively delete SnapshotDiff associated with the given snapshot under a
+   * directory
+   */
+  private void deleteDiffsForSnapshot(Snapshot snapshot, INodeDirectory dir,
+      BlocksMapUpdateInfo collectedBlocks) {
+    if (dir instanceof INodeDirectoryWithSnapshot) {
+      INodeDirectoryWithSnapshot sdir = (INodeDirectoryWithSnapshot) dir;
+      sdir.deleteSnapshotDiff(snapshot, collectedBlocks);
+    }
+    ReadOnlyList<INode> children = dir.getChildrenList(null);
+    for (INode child : children) {
+      if (child instanceof INodeDirectory) {
+        deleteDiffsForSnapshot(snapshot, (INodeDirectory) child,
+            collectedBlocks);
+      }
+    }
+  }
