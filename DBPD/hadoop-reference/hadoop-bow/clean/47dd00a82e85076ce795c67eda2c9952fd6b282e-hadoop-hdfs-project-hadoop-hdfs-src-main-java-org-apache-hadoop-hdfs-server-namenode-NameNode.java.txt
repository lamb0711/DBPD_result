Merge branch 'HDFS-12943' into trunk

+  public static final HAState OBSERVER_STATE = new StandbyState(true);
-    if (!haEnabled || startOpt == StartupOption.UPGRADE 
+    if (!haEnabled || startOpt == StartupOption.UPGRADE
+    } else if (startOpt == StartupOption.OBSERVER) {
+      return OBSERVER_STATE;
+      } else if (StartupOption.OBSERVER.getName().equalsIgnoreCase(cmd)) {
+        startOpt = StartupOption.OBSERVER;
+    if (state == OBSERVER_STATE) {
+      throw new ServiceFailedException(
+          "Cannot transition from '" + OBSERVER_STATE + "' to '" +
+              ACTIVE_STATE + "'");
+    }
-  
-  synchronized void transitionToStandby() 
+
+  synchronized void transitionToStandby()
+  synchronized void transitionToObserver()
+      throws ServiceFailedException, AccessControlException {
+    namesystem.checkSuperuserPrivilege();
+    if (!haEnabled) {
+      throw new ServiceFailedException("HA for namenode is not enabled");
+    }
+    // Transition from ACTIVE to OBSERVER is forbidden.
+    if (state == ACTIVE_STATE) {
+      throw new ServiceFailedException(
+          "Cannot transition from '" + ACTIVE_STATE + "' to '" +
+              OBSERVER_STATE + "'");
+    }
+    state.setState(haContext, OBSERVER_STATE);
+  }
+
-        namesystem.startStandbyServices(getConf());
+        namesystem.startStandbyServices(getConf(),
+            state == NameNode.OBSERVER_STATE);
+      if (state == OBSERVER_STATE) {
+        return true;
+      }
+  public boolean isObserverState() {
+    return state.equals(OBSERVER_STATE);
+  }
+
