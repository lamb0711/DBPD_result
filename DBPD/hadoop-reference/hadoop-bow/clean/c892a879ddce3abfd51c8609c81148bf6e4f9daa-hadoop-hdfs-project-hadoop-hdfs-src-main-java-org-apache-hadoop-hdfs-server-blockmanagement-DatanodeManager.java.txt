HDFS-14882. Consider DataNode load when #getBlockLocation. Contributed by Xiaoqiao He.

Signed-off-by: Wei-Chiu Chuang <weichiu@apache.org>

Reviewed-by: Inigo Goiri <inigoiri@apache.org>
Reviewed-by: Istvan Fajth <pifta@cloudera.com>

-import org.apache.hadoop.fs.StorageType;
+import java.util.function.Consumer;
+  /** Whether or not to consider lad for reading. */
+  private final boolean readConsiderLoad;
+
+    this.readConsiderLoad = conf.getBoolean(
+        DFSConfigKeys.DFS_NAMENODE_READ_CONSIDERLOAD_KEY,
+        DFSConfigKeys.DFS_NAMENODE_READ_CONSIDERLOAD_DEFAULT);
-          lb.getLocations(), activeLen);
+          lb.getLocations(), activeLen, createSecondaryNodeSorter());
-      networktopology.sortByDistance(client, lb.getLocations(), activeLen);
+      networktopology.sortByDistance(client, lb.getLocations(), activeLen,
+          createSecondaryNodeSorter());
+  private Consumer<List<DatanodeInfo>> createSecondaryNodeSorter() {
+    Consumer<List<DatanodeInfo>> secondarySort =
+        list -> Collections.shuffle(list);
+    if (readConsiderLoad) {
+      Comparator<DatanodeInfo> comp =
+          Comparator.comparingInt(DatanodeInfo::getXceiverCount);
+      secondarySort = list -> Collections.sort(list, comp);
+    }
+    return secondarySort;
+  }
+
