HDFS-7945. The WebHdfs system on DN does not honor the length parameter. Contributed by Haohui Mai.

+import org.apache.hadoop.util.LimitInputStream;
+import java.io.InputStream;
+    final long length = params.length();
-    if (in.getVisibleLength() >= offset) {
-      headers.set(CONTENT_LENGTH, in.getVisibleLength() - offset);
+    long contentLength = in.getVisibleLength() - offset;
+    if (length >= 0) {
+      contentLength = Math.min(contentLength, length);
+    }
+    final InputStream data;
+    if (contentLength >= 0) {
+      headers.set(CONTENT_LENGTH, contentLength);
+      data = new LimitInputStream(in, contentLength);
+    } else {
+      data = in;
-    ctx.writeAndFlush(new ChunkedStream(in) {
+    ctx.writeAndFlush(new ChunkedStream(data) {
