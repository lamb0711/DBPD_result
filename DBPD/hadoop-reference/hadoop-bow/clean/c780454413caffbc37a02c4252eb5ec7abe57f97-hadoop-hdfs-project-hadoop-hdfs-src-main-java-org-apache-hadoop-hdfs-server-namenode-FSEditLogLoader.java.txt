HDFS-5869. When starting rolling upgrade or NN restarts, NN should create a checkpoint right before the upgrade marker.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535@1565516 13f79535-47bb-0310-9956-ffa450edef68

-  static long REPLAY_TRANSACTION_LOG_INTERVAL = 1000; // 1sec
+  static final long REPLAY_TRANSACTION_LOG_INTERVAL = 1000; // 1sec
+
+  /** Total number of end transactions loaded. */
+  private int totalEdits = 0;
+            if (LOG.isTraceEnabled()) {
+              LOG.trace("op=" + op + ", startOpt=" + startOpt
+                  + ", numEdits=" + numEdits + ", totalEdits=" + totalEdits);
+            }
+          totalEdits++;
-        if (startOpt.getRollingUpgradeStartupOption()
-            == RollingUpgradeStartupOption.ROLLBACK) {
+        final RollingUpgradeStartupOption rollingUpgradeOpt
+            = startOpt.getRollingUpgradeStartupOption(); 
+        if (rollingUpgradeOpt == RollingUpgradeStartupOption.ROLLBACK) {
-        } else if (startOpt.getRollingUpgradeStartupOption()
-            == RollingUpgradeStartupOption.DOWNGRADE) {
+        } else if (rollingUpgradeOpt == RollingUpgradeStartupOption.DOWNGRADE) {
-        } else if (startOpt.getRollingUpgradeStartupOption()
-            == RollingUpgradeStartupOption.STARTED) {
+        } else if (rollingUpgradeOpt == RollingUpgradeStartupOption.STARTED) {
+          if (totalEdits > 1) {
+            // save namespace if this is not the second edit transaction
+            // (the first must be OP_START_LOG_SEGMENT)
+            fsNamesys.getFSImage().saveNamespace(fsNamesys);
+          }
