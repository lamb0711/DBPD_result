HDDS-1672. Improve locking in OzoneManager. (#1016)



+import static org.apache.hadoop.ozone.om.lock.OzoneManagerLock.Resource.VOLUME_LOCK;
+import static org.apache.hadoop.ozone.om.lock.OzoneManagerLock.Resource.USER_LOCK;
+
+    boolean acquiredUserLock = false;
+    IOException exception = null;
-    omMetadataManager.getLock().acquireUserLock(owner);
-    omMetadataManager.getLock().acquireVolumeLock(volume);
-
-    IOException exception = null;
+    omMetadataManager.getLock().acquireLock(VOLUME_LOCK, volume);
+      acquiredUserLock = omMetadataManager.getLock().acquireLock(USER_LOCK,
+          owner);
-      omMetadataManager.getLock().releaseVolumeLock(volumeInfo.getVolume());
-      omMetadataManager.getLock().releaseUserLock(dbUserKey);
+      if (acquiredUserLock) {
+        omMetadataManager.getLock().releaseLock(USER_LOCK, owner);
+      }
+      omMetadataManager.getLock().releaseLock(VOLUME_LOCK, volume);
