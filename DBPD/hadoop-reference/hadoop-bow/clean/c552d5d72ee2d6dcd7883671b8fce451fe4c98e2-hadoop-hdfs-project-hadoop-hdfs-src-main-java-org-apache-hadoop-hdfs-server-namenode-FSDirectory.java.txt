HDFS-5685. Implement ACL as a INode feature. Contributed by Haohui Mai.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-4685@1552465 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.fs.permission.AclEntry;
+import org.apache.hadoop.fs.permission.AclStatus;
+import com.google.common.collect.Lists;
-  
+
+  void removeAcl(String src) throws IOException {
+    writeLock();
+    try {
+      final INodeWithAdditionalFields node = resolveINodeWithAdditionalField(src);
+      AclFeature f = node.getAclFeature();
+      if (f != null)
+        node.removeAclFeature();
+    } finally {
+      writeUnlock();
+    }
+  }
+
+  void setAcl(String src, Iterable<AclEntry> aclSpec) throws IOException {
+    writeLock();
+    try {
+      final INodeWithAdditionalFields node = resolveINodeWithAdditionalField(src);
+      AclFeature f = node.getAclFeature();
+      if (f == null) {
+        f = new AclFeature();
+        node.addAclFeature(f);
+      }
+      f.setEntries(Lists.newArrayList(aclSpec));
+    } finally {
+      writeUnlock();
+    }
+  }
+
+  AclStatus getAclStatus(String src) throws IOException {
+    readLock();
+    try {
+      final INodeWithAdditionalFields node = resolveINodeWithAdditionalField(src);
+      AclFeature f = node.getAclFeature();
+
+      AclStatus.Builder builder = new AclStatus.Builder()
+          .owner(node.getUserName()).group(node.getGroupName())
+          .stickyBit(node.getFsPermission().getStickyBit());
+      if (f != null) {
+        builder.addEntries(f.getEntries());
+      }
+      return builder.build();
+    } finally {
+      readUnlock();
+    }
+  }
+
+  private INodeWithAdditionalFields resolveINodeWithAdditionalField(String src)
+      throws UnresolvedLinkException, SnapshotAccessControlException,
+      FileNotFoundException {
+    String srcs = normalizePath(src);
+    final INodesInPath iip = rootDir.getINodesInPath4Write(srcs, true);
+    INode inode = iip.getLastINode();
+    if (!(inode instanceof INodeWithAdditionalFields))
+      throw new FileNotFoundException("cannot find " + src);
+
+    final INodeWithAdditionalFields node = (INodeWithAdditionalFields) inode;
+    return node;
+  }
+
