YARN-3464. Race condition in LocalizerRunner kills localizer before localizing all resources. (Zhihai Xu via kasha)

+import java.util.concurrent.atomic.AtomicBoolean;
+import org.apache.hadoop.yarn.server.nodemanager.containermanager.localizer.event.ContainerLocalizationEvent;
+    case CONTAINER_RESOURCES_LOCALIZED:
+      handleContainerResourcesLocalized((ContainerLocalizationEvent) event);
+      break;
-  
+
+  /**
+   * Once a container's resources are localized, kill the corresponding
+   * {@link ContainerLocalizer}
+   */
+  private void handleContainerResourcesLocalized(
+      ContainerLocalizationEvent event) {
+    Container c = event.getContainer();
+    String locId = ConverterUtils.toString(c.getContainerId());
+    localizerTracker.endContainerLocalization(locId);
+  }
+
-        return localizer.update(status.getResources());
+        return localizer.processHeartbeat(status.getResources());
+
+    public void endContainerLocalization(String locId) {
+      LocalizerRunner localizer;
+      synchronized (privLocalizers) {
+        localizer = privLocalizers.get(locId);
+        if (null == localizer) {
+          return; // ignore
+        }
+      }
+      localizer.endContainerLocalization();
+    }
+    private AtomicBoolean killContainerLocalizer = new AtomicBoolean(false);
+    public void endContainerLocalization() {
+      killContainerLocalizer.set(true);
+    }
+
-    LocalizerHeartbeatResponse update(
+    LocalizerHeartbeatResponse processHeartbeat(
-      LocalizerAction action = LocalizerAction.LIVE;
+      boolean fetchFailed = false;
-            action = LocalizerAction.DIE;
+            fetchFailed = true;
-            action = LocalizerAction.DIE;
+            fetchFailed = true;
-      if (action == LocalizerAction.DIE) {
-        response.setLocalizerAction(action);
+      if (fetchFailed || killContainerLocalizer.get()) {
+        response.setLocalizerAction(LocalizerAction.DIE);
-      } else if (pending.isEmpty()) {
-        // TODO: Synchronization
-        action = LocalizerAction.DIE;
-      response.setLocalizerAction(action);
+      response.setLocalizerAction(LocalizerAction.LIVE);
