HDDS-1856. Make required changes for Non-HA to use new HA code in OM. (#1174)


+import org.apache.hadoop.ozone.om.ratis.utils.OzoneManagerDoubleBufferHelper;
-      long transactionLogIndex) {
+      long transactionLogIndex,
+      OzoneManagerDoubleBufferHelper ozoneManagerDoubleBufferHelper) {
+    OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();
+    IOException exception = null;
+    boolean acquireVolumeLock = false;
+    OMClientResponse omClientResponse = null;
-    } catch (IOException ex) {
-      LOG.error("Changing volume quota failed for volume:{} quota:{}", volume,
-          setVolumePropertyRequest.getQuotaInBytes(), ex);
-      omMetrics.incNumVolumeUpdateFails();
-      auditLog(auditLogger, buildAuditMessage(OMAction.SET_QUOTA, auditMap,
-          ex, userInfo));
-      return new OMVolumeSetQuotaResponse(null,
-          createErrorOMResponse(omResponse, ex));
-    }
+      OmVolumeArgs omVolumeArgs = null;
-    OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();
-
-    IOException exception = null;
-    OmVolumeArgs omVolumeArgs = null;
-
-    omMetadataManager.getLock().acquireLock(VOLUME_LOCK, volume);
-    try {
+      acquireVolumeLock = omMetadataManager.getLock().acquireLock(VOLUME_LOCK,
+          volume);
+      omResponse.setSetVolumePropertyResponse(
+          SetVolumePropertyResponse.newBuilder().build());
+      omClientResponse = new OMVolumeSetQuotaResponse(omVolumeArgs,
+        omResponse.build());
+      omClientResponse = new OMVolumeSetQuotaResponse(null,
+          createErrorOMResponse(omResponse, exception));
-      omMetadataManager.getLock().releaseLock(VOLUME_LOCK, volume);
+      if (omClientResponse != null) {
+        omClientResponse.setFlushFuture(
+            ozoneManagerDoubleBufferHelper.add(omClientResponse,
+                transactionLogIndex));
+      }
+      if (acquireVolumeLock) {
+        omMetadataManager.getLock().releaseLock(VOLUME_LOCK, volume);
+      }
-      omResponse.setSetVolumePropertyResponse(
-          SetVolumePropertyResponse.newBuilder().build());
-      return new OMVolumeSetQuotaResponse(omVolumeArgs, omResponse.build());
+      LOG.debug("Changing volume quota is successfully completed for volume: " +
+          "{} quota:{}", volume, setVolumePropertyRequest.getQuotaInBytes());
-      return new OMVolumeSetQuotaResponse(null,
-          createErrorOMResponse(omResponse, exception));
+    return omClientResponse;
+
+
