HDFS-4103. Support O(1) snapshot creation.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1424782 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.server.namenode.snapshot.Snapshot;
-  void setPermission(FsPermission permission) {
-    super.setPermission(permission.applyUMask(UMASK));
+  void setPermission(FsPermission permission, Snapshot latest) {
+    super.setPermission(permission.applyUMask(UMASK), latest);
-  protected void setFileReplication(short replication) {
+  protected void setFileReplication(short replication, Snapshot latest) {
+    if (latest != null) {
+      final Pair<? extends INode, ? extends INode> p = recordModification(latest);
+      if (p != null) {
+        ((INodeFile)p.left).setFileReplication(replication, null);
+        return;
+      }
+    }
+
