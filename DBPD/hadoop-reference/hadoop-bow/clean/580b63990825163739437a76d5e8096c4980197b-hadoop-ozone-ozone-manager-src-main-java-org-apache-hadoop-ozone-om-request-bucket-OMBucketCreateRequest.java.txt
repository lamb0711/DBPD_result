HDDS-1600. Add userName and IPAddress as part of OMRequest. (#857)



-import org.apache.hadoop.ozone.om.request.OMClientRequest;
+import org.apache.hadoop.ozone.om.request.OMClientRequest;
-import org.apache.hadoop.ozone.om.ratis.utils.OzoneManagerRatisUtils;
+import org.apache.hadoop.ozone.security.acl.IAccessAuthorizer;
+import org.apache.hadoop.ozone.security.acl.OzoneObj;
-    return getOmRequest().toBuilder().setCreateBucketRequest(
-        newCreateBucketRequest.build()).build();
+    return getOmRequest().toBuilder().setUserInfo(getUserInfo())
+        .setCreateBucketRequest(newCreateBucketRequest.build()).build();
-    OmBucketInfo omBucketInfo = null;
+    OmBucketInfo omBucketInfo = OmBucketInfo.getFromProtobuf(bucketInfo);
+    try {
+      // check Acl
+      if (ozoneManager.getAclsEnabled()) {
+        checkAcls(ozoneManager, OzoneObj.ResourceType.BUCKET,
+            OzoneObj.StoreType.OZONE, IAccessAuthorizer.ACLType.CREATE,
+            volumeName, bucketName, null);
+      }
+    } catch (IOException ex) {
+      LOG.error("Bucket creation failed for bucket:{} in volume:{}",
+          bucketName, volumeName, ex);
+      omMetrics.incNumBucketCreateFails();
+      return new OMBucketCreateResponse(omBucketInfo,
+          createErrorOMResponse(omResponse, ex));
+    }
+
+    String volumeKey = metadataManager.getVolumeKey(volumeName);
+    String bucketKey = metadataManager.getBucketKey(volumeName, bucketName);
-
-      String volumeKey = metadataManager.getVolumeKey(volumeName);
-      String bucketKey = metadataManager.getBucketKey(volumeName, bucketName);
-      omBucketInfo = OmBucketInfo.getFromProtobuf(bucketInfo);
-      // TODO: check acls.
+      // return response.
+      omResponse.setCreateBucketResponse(
+          CreateBucketResponse.newBuilder().build());
+      return new OMBucketCreateResponse(omBucketInfo, omResponse.build());
+
-      omResponse.setStatus(
-          OzoneManagerRatisUtils.exceptionToResponseStatus(ex));
-      omResponse.setMessage(ex.getMessage());
-      omResponse.setSuccess(false);
+      return new OMBucketCreateResponse(omBucketInfo,
+          createErrorOMResponse(omResponse, ex));
-    omResponse.setCreateBucketResponse(
-        CreateBucketResponse.newBuilder().build());
-    return new OMBucketCreateResponse(omBucketInfo, omResponse.build());
