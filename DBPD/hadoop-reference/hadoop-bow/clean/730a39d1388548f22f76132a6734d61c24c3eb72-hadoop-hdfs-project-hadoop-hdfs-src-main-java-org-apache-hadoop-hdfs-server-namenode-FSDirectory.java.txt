HDFS-15372. Files in snapshots no longer see attribute provider permissions. Contributed by Stephen O'Donnell.

Signed-off-by: Wei-Chiu Chuang <weichiu@apache.org>

-import java.lang.reflect.Method;
-      byte[][] components = iip.getPathComponents();
+      // Due to HDFS-15372 the attribute provider should received the resolved
+      // snapshot path. Ie, rather than seeing /d/.snapshot/sn/data it should
+      // see /d/data. However, for the path /d/.snapshot/sn it should see this
+      // full path. Node.getPathComponents always resolves the path to the
+      // original location, so we need to check if ".snapshot/sn" is the last
+      // path to ensure the provider receives the correct components.
+      byte[][] components;
+      if (iip.isSnapshot() && !iip.isDotSnapshotDirPrefix()) {
+        // For snapshot paths, node.getPathComponents unless the last component
+        // is like ".snapshot/sn"
+        components = node.getPathComponents();
+      } else {
+        components = iip.getPathComponents();
+      }
