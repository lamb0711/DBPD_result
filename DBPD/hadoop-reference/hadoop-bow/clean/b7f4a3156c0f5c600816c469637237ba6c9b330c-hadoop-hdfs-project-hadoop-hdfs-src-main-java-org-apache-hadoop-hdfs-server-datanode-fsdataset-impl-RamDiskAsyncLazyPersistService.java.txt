HDFS-7496. Fix FsVolume removal race conditions on the DataNode by reference-counting the volume instances (lei via cmccabe)

+import org.apache.hadoop.hdfs.server.datanode.fsdataset.FsVolumeReference;
+import javax.ws.rs.HEAD;
-      FsVolumeImpl targetVolume) throws IOException {
+      FsVolumeReference target) throws IOException {
-    File lazyPersistDir  = targetVolume.getLazyPersistDir(bpId);
+    FsVolumeImpl volume = (FsVolumeImpl)target.getVolume();
+    File lazyPersistDir  = volume.getLazyPersistDir(bpId);
-        targetVolume, lazyPersistDir);
-    execute(targetVolume.getCurrentDir(), lazyPersistTask);
+        target, lazyPersistDir);
+    execute(volume.getCurrentDir(), lazyPersistTask);
-    final FsVolumeImpl targetVolume;
+    final FsVolumeReference targetVolume;
-        FsVolumeImpl targetVolume, File lazyPersistDir) {
+        FsVolumeReference targetVolume, File lazyPersistDir) {
-      try {
+      try (FsVolumeReference ref = this.targetVolume) {
-                creationTime, targetFiles, targetVolume);
+                creationTime, targetFiles, (FsVolumeImpl)ref.getVolume());
