YARN-1029. Added embedded leader election in the ResourceManager. Contributed by Karthik Kambatla.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1556103 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.ArrayList;
-import java.util.List;
-import java.util.concurrent.ConcurrentMap;
+import org.apache.hadoop.security.AccessControlException;
-import org.apache.hadoop.service.AbstractService;
+import org.apache.hadoop.service.CompositeService;
+import org.apache.hadoop.yarn.conf.HAUtil;
-public class AdminService extends AbstractService implements
+public class AdminService extends CompositeService implements
+  private boolean autoFailoverEnabled;
+
+    if (rmContext.isHAEnabled()) {
+      autoFailoverEnabled = HAUtil.isAutomaticFailoverEnabled(conf);
+      if (autoFailoverEnabled) {
+        if (HAUtil.isAutomaticFailoverEmbedded(conf)) {
+          addIfService(createEmbeddedElectorService());
+        }
+      }
+    }
+
+  protected EmbeddedElectorService createEmbeddedElectorService() {
+    return new EmbeddedElectorService(rmContext);
+  }
+
+  /**
+   * Check that a request to change this node's HA state is valid.
+   * In particular, verifies that, if auto failover is enabled, non-forced
+   * requests from the HAAdmin CLI are rejected, and vice versa.
+   *
+   * @param req the request to check
+   * @throws AccessControlException if the request is disallowed
+   */
+  private void checkHaStateChange(StateChangeRequestInfo req)
+      throws AccessControlException {
+    switch (req.getSource()) {
+      case REQUEST_BY_USER:
+        if (autoFailoverEnabled) {
+          throw new AccessControlException(
+              "Manual failover for this ResourceManager is disallowed, " +
+                  "because automatic failover is enabled.");
+        }
+        break;
+      case REQUEST_BY_USER_FORCED:
+        if (autoFailoverEnabled) {
+          LOG.warn("Allowing manual failover from " +
+              org.apache.hadoop.ipc.Server.getRemoteAddress() +
+              " even though automatic failover is enabled, because the user " +
+              "specified the force flag");
+        }
+        break;
+      case REQUEST_BY_ZKFC:
+        if (!autoFailoverEnabled) {
+          throw new AccessControlException(
+              "Request from ZK failover controller at " +
+                  org.apache.hadoop.ipc.Server.getRemoteAddress() + " denied " +
+                  "since automatic failover is not enabled");
+        }
+        break;
+    }
+  }
+
-    // TODO (YARN-1177): When automatic failover is enabled,
-    // check if transition should be allowed for this request
+    checkHaStateChange(reqInfo);
-    // TODO (YARN-1177): When automatic failover is enabled,
-    // check if transition should be allowed for this request
+    checkHaStateChange(reqInfo);
-  
+
