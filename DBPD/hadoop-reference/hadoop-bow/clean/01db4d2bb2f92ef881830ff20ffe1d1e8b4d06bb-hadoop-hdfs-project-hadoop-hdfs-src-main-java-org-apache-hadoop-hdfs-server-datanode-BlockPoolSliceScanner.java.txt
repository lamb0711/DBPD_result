HDFS-3828. Block Scanner rescans blocks too frequently. Contributed by Andy Isaacson


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1381472 13f79535-47bb-0310-9956-ffa450edef68

+import com.google.common.annotations.VisibleForTesting;
+
+  @VisibleForTesting
+  long getTotalScans() {
+    return totalScans;
+  }
+
+  private synchronized boolean workRemainingInCurrentPeriod() {
+    if (bytesLeft <= 0 && Time.now() < currentPeriodStart + scanPeriod) {
+      if (LOG.isDebugEnabled()) {
+        LOG.debug("Skipping scan since bytesLeft=" + bytesLeft + ", Start=" +
+                  currentPeriodStart + ", period=" + scanPeriod + ", now=" +
+                  Time.now() + " " + blockPoolId);
+      }
+      return false;
+    } else {
+      return true;
+    }
+  }
+
+    if (!workRemainingInCurrentPeriod()) {
+      return;
+    }
+
-      cleanUp();
+      rollVerificationLogs();
-  private synchronized void cleanUp() {
+  private synchronized void rollVerificationLogs() {
