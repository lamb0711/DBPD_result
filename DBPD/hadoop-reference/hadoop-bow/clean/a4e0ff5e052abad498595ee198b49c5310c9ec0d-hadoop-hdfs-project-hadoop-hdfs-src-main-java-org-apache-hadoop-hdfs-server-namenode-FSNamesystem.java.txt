HDFS-6480. Move waitForReady() from FSDirectory to FSNamesystem. Contributed by Haohui Mai.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1603705 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.concurrent.locks.Condition;
+  private volatile boolean imageLoaded = false;
+  private final Condition cond;
+  /**
+   * Notify that loading of this FSDirectory is complete, and
+   * it is imageLoaded for use
+   */
+  void imageLoadComplete() {
+    Preconditions.checkState(!imageLoaded, "FSDirectory already loaded");
+    setImageLoaded();
+  }
+
+  void setImageLoaded() {
+    if(imageLoaded) return;
+    writeLock();
+    try {
+      setImageLoaded(true);
+      dir.markNameCacheInitialized();
+      cond.signalAll();
+    } finally {
+      writeUnlock();
+    }
+  }
+
+  //This is for testing purposes only
+  @VisibleForTesting
+  boolean isImageLoaded() {
+    return imageLoaded;
+  }
+
+  // exposed for unit tests
+  protected void setImageLoaded(boolean flag) {
+    imageLoaded = flag;
+  }
+
+  /**
+   * Block until the object is imageLoaded to be used.
+   */
+  void waitForLoadingFSImage() {
+    if (!imageLoaded) {
+      writeLock();
+      try {
+        while (!imageLoaded) {
+          try {
+            cond.await(5000, TimeUnit.MILLISECONDS);
+          } catch (InterruptedException ignored) {
+          }
+        }
+      } finally {
+        writeUnlock();
+      }
+    }
+  }
+
+    setImageLoaded(false);
+    cond = fsLock.writeLock().newCondition();
-    dir.imageLoadComplete();
+    imageLoadComplete();
+    waitForLoadingFSImage();
+    waitForLoadingFSImage();
+
+    waitForLoadingFSImage();
+    waitForLoadingFSImage();
+    waitForLoadingFSImage();
+    waitForLoadingFSImage();
+      waitForLoadingFSImage();
+    waitForLoadingFSImage();
+
+    waitForLoadingFSImage();
+
+    waitForLoadingFSImage();
+
+    waitForLoadingFSImage();
+    waitForLoadingFSImage();
-    dir.waitForReady();
+    waitForLoadingFSImage();
-    dir.waitForReady();
+    waitForLoadingFSImage();
-      dir.waitForReady();
+      waitForLoadingFSImage();
+    waitForLoadingFSImage();
