HDFS-14814. RBF: RouterQuotaUpdateService supports inherited rule. Contributed by Jinglun.

+import java.util.Arrays;
+import java.util.HashMap;
+import java.util.Map;
+import java.util.Map.Entry;
-import org.apache.hadoop.hdfs.protocol.HdfsConstants;
+import org.apache.hadoop.hdfs.server.federation.resolver.RemoteLocation;
+      Map<RemoteLocation, QuotaUsage> remoteQuotaUsage = new HashMap<>();
-            currentQuotaUsage = this.rpcServer.getQuotaModule()
-                .getQuotaUsage(src);
+            Quota quotaModule = this.rpcServer.getQuotaModule();
+            Map<RemoteLocation, QuotaUsage> usageMap =
+                quotaModule.getEachQuotaUsage(src);
+            currentQuotaUsage = quotaModule.aggregateQuota(usageMap);
+            remoteQuotaUsage.putAll(usageMap);
-        // If quota is not set in some subclusters under federation path,
-        // set quota for this path.
-        if (currentQuotaUsage.getQuota() == HdfsConstants.QUOTA_RESET) {
-          try {
-            this.rpcServer.setQuota(src, nsQuota, ssQuota, null);
-          } catch (IOException ioe) {
-            LOG.error("Unable to set quota at remote location for "
-                + src, ioe);
-          }
-        }
-
+      // Fix inconsistent quota.
+      for (Entry<RemoteLocation, QuotaUsage> en : remoteQuotaUsage
+          .entrySet()) {
+        RemoteLocation remoteLocation = en.getKey();
+        QuotaUsage currentQuota = en.getValue();
+        fixGlobalQuota(remoteLocation, currentQuota);
+      }
+
+  private void fixGlobalQuota(RemoteLocation location, QuotaUsage remoteQuota)
+      throws IOException {
+    QuotaUsage gQuota =
+        this.rpcServer.getQuotaModule().getGlobalQuota(location.getSrc());
+    if (remoteQuota.getQuota() != gQuota.getQuota()
+        || remoteQuota.getSpaceQuota() != gQuota.getSpaceQuota()) {
+      this.rpcServer.getQuotaModule()
+          .setQuotaInternal(location.getSrc(), Arrays.asList(location),
+              gQuota.getQuota(), gQuota.getSpaceQuota(), null);
+      LOG.info("[Fix Quota] src={} dst={} oldQuota={}/{} newQuota={}/{}",
+          location.getSrc(), location, remoteQuota.getQuota(),
+          remoteQuota.getSpaceQuota(), gQuota.getQuota(),
+          gQuota.getSpaceQuota());
+    }
+  }
+
