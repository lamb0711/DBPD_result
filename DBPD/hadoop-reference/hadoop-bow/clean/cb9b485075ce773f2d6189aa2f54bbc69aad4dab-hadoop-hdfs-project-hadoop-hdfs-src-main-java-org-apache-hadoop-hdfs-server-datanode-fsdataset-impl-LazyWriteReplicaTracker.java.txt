HDFS-6930. Improve replica eviction from RAM disk. (Arpit Agarwal)

+   * Stale entries are GC'd by dequeueNextReplicaToPersist.
-   * A map of blockId to persist complete time for transient blocks. This allows
-   * us to evict LRU blocks from transient storage. Protected by 'this'
-   * Object lock.
+   * Queue of replicas in the order in which they were persisted.
+   * We'll dequeue them in the same order.
+   * We can improve the eviction scheme later.
+   * Stale entries are GC'd by getNextCandidateForEviction.
-  final Map<ReplicaState, Long> replicasPersisted;
+  final Queue<ReplicaState> replicasPersisted;
-    replicasPersisted = new HashMap<ReplicaState, Long>();
-  }
-
-  TreeMultimap<Long, ReplicaState> getLruMap() {
-    // TODO: This can be made more efficient.
-    TreeMultimap<Long, ReplicaState> reversedMap = TreeMultimap.create();
-    for (Map.Entry<ReplicaState, Long> entry : replicasPersisted.entrySet()) {
-      reversedMap.put(entry.getValue(), entry.getKey());
-    }
-    return reversedMap;
+    replicasPersisted = new LinkedList<ReplicaState>();
-    replicasPersisted.put(replicaState, System.currentTimeMillis() / 1000);
+
+    replicasPersisted.add(replicaState);
-  synchronized void reenqueueReplica(final ReplicaState replicaState) {
+  synchronized void reenqueueReplicaNotPersisted(final ReplicaState replicaState) {
+  synchronized void reenqueueReplicaPersisted(final ReplicaState replicaState) {
+    replicasPersisted.add(replicaState);
+  }
+
+  synchronized ReplicaState getNextCandidateForEviction() {
+    while (replicasPersisted.size() != 0) {
+      ReplicaState replicaState = replicasPersisted.remove();
+      Map<Long, ReplicaState> replicaMap = replicaMaps.get(replicaState.bpid);
+
+      if (replicaMap != null && replicaMap.get(replicaState.blockId) != null) {
+        return replicaState;
+      }
+
+      // The replica no longer exists, look for the next one.
+    }
+    return null;
+  }
+
+  void discardReplica(ReplicaState replicaState, boolean force) {
+    discardReplica(replicaState.bpid, replicaState.blockId, force);
+  }
+
-    replicasPersisted.remove(replicaState);
-
-    // Leave the replica in replicasNotPersisted if its present.
-    // dequeueNextReplicaToPersist will GC it eventually.
