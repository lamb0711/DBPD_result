Merge r1360400 through r1399945 from trunk.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1399950 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.util.Time;
+@InterfaceAudience.LimitedPrivate(value = { "Common", "HDFS", "MapReduce", "Yarn" })
+@InterfaceStability.Evolving
-    private boolean useSasl;
-      this.useSasl = UserGroupInformation.isSecurityEnabled();
-      if (useSasl && protocol != null) {
+      if (protocol != null) {
-      if (!useSasl) {
-        authMethod = AuthMethod.SIMPLE;
-      } else if (token != null) {
+      if (token != null) {
-      } else {
+      } else if (UserGroupInformation.isSecurityEnabled()) {
+      } else {
+        authMethod = AuthMethod.SIMPLE;
-      lastActivity.set(System.currentTimeMillis());
+      lastActivity.set(Time.now());
+      @Override
+      @Override
+        @Override
-          if (useSasl) {
+          if (authMethod != AuthMethod.SIMPLE) {
-            if (authMethod == AuthMethod.KERBEROS) {
-              if (ticket.getRealUser() != null) {
-                ticket = ticket.getRealUser();
-              }
+            if (ticket.getRealUser() != null) {
+              ticket = ticket.getRealUser();
-              useSasl = false;
-              (System.currentTimeMillis()-lastActivity.get());
+              (Time.now()-lastActivity.get());
-      long curTime = System.currentTimeMillis();
+      long curTime = Time.now();
+    @Override
-        return call.rpcResponse;
+        return call.getRpcResult();
+    
+    @Override
+    public String toString() {
+      return serverPrincipal + "@" + address;
+    }
