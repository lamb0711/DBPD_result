HDFS-13068. RBF: Add router admin option to manage safe mode. Contributed by Yiqun Lin.

+import org.apache.hadoop.hdfs.server.federation.store.protocol.EnterSafeModeRequest;
+import org.apache.hadoop.hdfs.server.federation.store.protocol.EnterSafeModeResponse;
+import org.apache.hadoop.hdfs.server.federation.store.protocol.GetSafeModeRequest;
+import org.apache.hadoop.hdfs.server.federation.store.protocol.GetSafeModeResponse;
+import org.apache.hadoop.hdfs.server.federation.store.protocol.LeaveSafeModeRequest;
+import org.apache.hadoop.hdfs.server.federation.store.protocol.LeaveSafeModeResponse;
-    implements MountTableManager {
+    implements MountTableManager, RouterStateManager {
+  @Override
+  public EnterSafeModeResponse enterSafeMode(EnterSafeModeRequest request)
+      throws IOException {
+    this.router.updateRouterState(RouterServiceState.SAFEMODE);
+    this.router.getRpcServer().setSafeMode(true);
+    return EnterSafeModeResponse.newInstance(verifySafeMode(true));
+  }
+
+  @Override
+  public LeaveSafeModeResponse leaveSafeMode(LeaveSafeModeRequest request)
+      throws IOException {
+    this.router.updateRouterState(RouterServiceState.RUNNING);
+    this.router.getRpcServer().setSafeMode(false);
+    return LeaveSafeModeResponse.newInstance(verifySafeMode(false));
+  }
+
+  @Override
+  public GetSafeModeResponse getSafeMode(GetSafeModeRequest request)
+      throws IOException {
+    boolean isInSafeMode = this.router.getRpcServer().isInSafeMode();
+    return GetSafeModeResponse.newInstance(isInSafeMode);
+  }
+
+  /**
+   * Verify if Router set safe mode state correctly.
+   * @param isInSafeMode Expected state to be set.
+   * @return
+   */
+  private boolean verifySafeMode(boolean isInSafeMode) {
+    boolean serverInSafeMode = this.router.getRpcServer().isInSafeMode();
+    RouterServiceState currentState = this.router.getRouterState();
+
+    return (isInSafeMode && currentState == RouterServiceState.SAFEMODE
+        && serverInSafeMode)
+        || (!isInSafeMode && currentState != RouterServiceState.SAFEMODE
+            && !serverInSafeMode);
+  }
+
