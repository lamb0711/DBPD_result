MAPREDUCE-2775. Fixed ResourceManager and NodeManager to force a decommissioned node to shutdown. Contributed by Devaraj K.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1190467 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.yarn.server.resourcemanager.ClusterMetrics;
-                                           RMNodeEvent>(RMNodeState.RUNNING)
+                                           RMNodeEvent>(RMNodeState.NEW)
+     .addTransition(RMNodeState.NEW, RMNodeState.RUNNING, 
+         RMNodeEventType.STARTED, new AddNodeTransition())
-    context.getDispatcher().getEventHandler().handle(
-        new NodeAddedSchedulerEvent(this));
+  public static class AddNodeTransition implements
+      SingleArcTransition<RMNodeImpl, RMNodeEvent> {
+
+    @SuppressWarnings("unchecked")
+    @Override
+    public void transition(RMNodeImpl rmNode, RMNodeEvent event) {
+      // Inform the scheduler
+
+      rmNode.context.getDispatcher().getEventHandler().handle(
+          new NodeAddedSchedulerEvent(rmNode));
+
+      ClusterMetrics.getMetrics().addNode();
+    }
+  }
+  
+    @SuppressWarnings("unchecked")
+      //Update the metrics 
+      ClusterMetrics.getMetrics().removeNode(event.getType());
+    @SuppressWarnings("unchecked")
+        ClusterMetrics.getMetrics().incrNumUnhealthyNMs();
+    @SuppressWarnings("unchecked")
+        ClusterMetrics.getMetrics().decrNumUnhealthyNMs();
