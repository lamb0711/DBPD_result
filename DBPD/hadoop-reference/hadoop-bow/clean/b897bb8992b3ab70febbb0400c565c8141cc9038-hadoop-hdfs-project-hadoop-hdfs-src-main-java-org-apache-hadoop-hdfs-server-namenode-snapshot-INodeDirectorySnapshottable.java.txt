HDFS-4091. Add snapshot quota to limit the number of snapshots allowed.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1401868 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.HadoopIllegalArgumentException;
-  static public INodeDirectorySnapshottable newInstance(final INodeDirectory dir) {
+  static public INodeDirectorySnapshottable newInstance(
+      final INodeDirectory dir, final int snapshotQuota) {
-    return new INodeDirectorySnapshottable(nsq, dsq, dir);
+    return new INodeDirectorySnapshottable(nsq, dsq, dir, snapshotQuota);
+  /** Number of snapshots is allowed. */
+  private int snapshotQuota;
-      INodeDirectory dir) {
+      INodeDirectory dir, final int snapshotQuota) {
+    setSnapshotQuota(snapshotQuota);
+  }
+
+  public int getSnapshotQuota() {
+    return snapshotQuota;
+  }
+
+  public void setSnapshotQuota(int snapshotQuota) {
+    if (snapshotQuota <= 0) {
+      throw new HadoopIllegalArgumentException(
+          "Cannot set snapshot quota to " + snapshotQuota + " <= 0");
+    }
+    this.snapshotQuota = snapshotQuota;
-  INodeDirectorySnapshotRoot addSnapshotRoot(final String name) {
+  INodeDirectorySnapshotRoot addSnapshotRoot(final String name
+      ) throws SnapshotException {
+    //check snapshot quota
+    if (snapshots.size() + 1 > snapshotQuota) {
+      throw new SnapshotException("Failed to add snapshot: there are already "
+          + snapshots.size() + " snapshot(s) and the snapshot quota is "
+          + snapshotQuota);
+    }
+
