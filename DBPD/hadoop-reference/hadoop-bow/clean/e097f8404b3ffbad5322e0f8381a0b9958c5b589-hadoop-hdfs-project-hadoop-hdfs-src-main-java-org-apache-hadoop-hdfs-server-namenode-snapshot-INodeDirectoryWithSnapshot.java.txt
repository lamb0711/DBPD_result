HDFS-4773. Fix bugs in quota usage computation and OfflineImageViewer.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1477367 13f79535-47bb-0310-9956-ffa450edef68

-    final int diffNum = 0;
-    Snapshot lastSnapshot = null;
-    Snapshot lastInDiff = diffs.getLastSnapshot();
-    // if lastSnapshotId > lastInDiff.getId(), the snapshot diff associated with
-    // lastSnapshotId must have been deleted. We should call 
-    // getChildrenList(null) to get the children list for the continuous 
-    // computation. In the meanwhile, there must be some snapshot diff whose
-    // snapshot id is no less than lastSnapshotId. Otherwise the WithName node
-    // itself should have been deleted.
-    if (lastInDiff != null && lastInDiff.getId() >= lastSnapshotId) {
-      lastSnapshot = diffs.searchSnapshotById(lastSnapshotId);
-    }
+    Snapshot lastSnapshot = diffs.getSnapshotById(lastSnapshotId);
-    counts.add(Quota.NAMESPACE, diffNum + 1);
+    counts.add(Quota.NAMESPACE, 1);
