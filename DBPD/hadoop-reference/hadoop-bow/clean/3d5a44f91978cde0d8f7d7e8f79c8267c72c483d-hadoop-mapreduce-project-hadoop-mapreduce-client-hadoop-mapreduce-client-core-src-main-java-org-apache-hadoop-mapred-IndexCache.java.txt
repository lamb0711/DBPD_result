MAPREDUCE-4384. Race conditions in IndexCache (Kihwal Lee via tgraves)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1357937 13f79535-47bb-0310-9956-ffa450edef68

-      synchronized (info) {
-        while (null == info.mapSpillRecord) {
-          try {
-            info.wait();
-          } catch (InterruptedException e) {
-            throw new IOException("Interrupted waiting for construction", e);
-          }
+      while (isUnderConstruction(info)) {
+        try {
+          // In case the entry is ready after the above check but
+          // before the following wait, we do timed wait.
+          info.wait(200);
+        } catch (InterruptedException e) {
+          throw new IOException("Interrupted waiting for construction", e);
+  private boolean isUnderConstruction(IndexInformation info) {
+    synchronized(info) {
+      return (null == info.mapSpillRecord);
+    }
+  }
+
-      synchronized (info) {
-        while (null == info.mapSpillRecord) {
-          try {
-            info.wait();
-          } catch (InterruptedException e) {
-            throw new IOException("Interrupted waiting for construction", e);
-          }
+      while (isUnderConstruction(info)) {
+        try {
+          // In case the entry is ready after the above check but
+          // before the following wait, we do timed wait.
+          info.wait(200);
+        } catch (InterruptedException e) {
+          throw new IOException("Interrupted waiting for construction", e);
-    if ((info != null) && (info.getSize() == 0)) {
+    if (info == null || ((info != null) && isUnderConstruction(info))) {
