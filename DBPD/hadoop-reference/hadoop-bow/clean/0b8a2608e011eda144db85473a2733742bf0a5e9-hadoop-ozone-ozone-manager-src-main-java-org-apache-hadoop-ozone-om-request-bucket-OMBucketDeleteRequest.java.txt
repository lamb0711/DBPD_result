HDDS-1605. Implement AuditLogging for OM HA Bucket write requests. (#867)


+import java.util.Map;
-import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos;
+import org.apache.hadoop.ozone.audit.AuditLogger;
+import org.apache.hadoop.ozone.audit.OMAction;
+import org.apache.hadoop.ozone.OzoneConsts;
+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos;
+
+    AuditLogger auditLogger = ozoneManager.getAuditLogger();
+    Map<String, String> auditMap = buildVolumeAuditMap(volumeName);
+    auditMap.put(OzoneConsts.BUCKET, bucketName);
+
+    OzoneManagerProtocolProtos.UserInfo userInfo = getOmRequest().getUserInfo();
+
+
+      auditLog(auditLogger, buildAuditMessage(OMAction.DELETE_BUCKET,
+          auditMap, ex, userInfo));
+    IOException exception = null;
-      // return response.
+    } catch (IOException ex) {
+      exception = ex;
+    } finally {
+      omMetadataManager.getLock().releaseBucketLock(volumeName, bucketName);
+    }
+
+    // Performing audit logging outside of the lock.
+    auditLog(auditLogger, buildAuditMessage(OMAction.DELETE_BUCKET,
+        auditMap, exception, userInfo));
+
+    // return response.
+    if (exception == null) {
+      LOG.debug("Deleted bucket:{} in volume:{}", bucketName, volumeName);
-
-    } catch (IOException ex) {
+    } else {
-          volumeName, ex);
+          volumeName, exception);
-          createErrorOMResponse(omResponse, ex));
-    } finally {
-      omMetadataManager.getLock().releaseBucketLock(volumeName, bucketName);
+          createErrorOMResponse(omResponse, exception));
