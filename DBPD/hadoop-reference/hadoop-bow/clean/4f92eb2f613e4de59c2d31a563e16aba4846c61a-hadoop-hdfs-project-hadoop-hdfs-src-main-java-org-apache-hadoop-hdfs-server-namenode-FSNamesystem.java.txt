HDFS-5848. Add rolling upgrade status to heartbeat response.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535@1563384 13f79535-47bb-0310-9956-ffa450edef68

-import static org.apache.hadoop.hdfs.DFSConfigKeys.DFS_NAMENODE_AUDIT_LOG_TOKEN_TRACKING_ID_DEFAULT;
-import static org.apache.hadoop.hdfs.DFSConfigKeys.DFS_NAMENODE_AUDIT_LOG_TOKEN_TRACKING_ID_KEY;
+import static org.apache.hadoop.hdfs.DFSConfigKeys.DFS_NAMENODE_AUDIT_LOG_TOKEN_TRACKING_ID_DEFAULT;
+import static org.apache.hadoop.hdfs.DFSConfigKeys.DFS_NAMENODE_AUDIT_LOG_TOKEN_TRACKING_ID_KEY;
+      //get datanode commands
-      return new HeartbeatResponse(cmds, createHaStatusHeartbeat());
+      
+      //create ha status
+      final NNHAStatusHeartbeat haState = new NNHAStatusHeartbeat(
+          haContext.getState().getServiceState(),
+          getFSImage().getLastAppliedOrWrittenTxId());
+
+      return new HeartbeatResponse(cmds, haState, rollingUpgradeInfo);
-  private NNHAStatusHeartbeat createHaStatusHeartbeat() {
-    HAState state = haContext.getState();
-    return new NNHAStatusHeartbeat(state.getServiceState(),
-        getFSImage().getLastAppliedOrWrittenTxId());
-  }
-
-      if (rollingUpgradeInfo != null) {
+      if (isRollingUpgrade()) {
-
+      
-    rollingUpgradeInfo = new RollingUpgradeInfo(startTime);;
+    rollingUpgradeInfo = new RollingUpgradeInfo(blockPoolId, startTime);
+  }
+
+  /** Is rolling upgrade in progress? */
+  boolean isRollingUpgrade() {
+    return rollingUpgradeInfo != null;
-      if (rollingUpgradeInfo == null) {
+      if (!isRollingUpgrade()) {
-      returnInfo = new RollingUpgradeInfo(rollingUpgradeInfo.getStartTime(), now());
+      returnInfo = new RollingUpgradeInfo(blockPoolId,
+          rollingUpgradeInfo.getStartTime(), now());
