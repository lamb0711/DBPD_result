MAPREDUCE-2652. Enabled multiple NMs to be runnable on a single node by making shuffle service port to be truely configurable. Contributed by Robert Joseph Evans.



git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1163585 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.mapred.ProgressSplitsBlock;
-import org.apache.hadoop.mapreduce.v2.api.records.CounterGroup;
+import org.apache.hadoop.mapreduce.v2.app.job.event.TaskAttemptContainerLaunchedEvent;
-@SuppressWarnings("all")
+  private int shufflePort = -1;
-      DataOutputBuffer jobToken_dob = new DataOutputBuffer();
-      jobToken.write(jobToken_dob);
-              ByteBuffer.wrap(jobToken_dob.getData(), 0,
-                  jobToken_dob.getLength()));
+              ShuffleHandler.serializeServiceData(jobToken));
+
+  @Override
+  public int getShufflePort() {
+    readLock.lock();
+    try {
+      return shufflePort;
+    } finally {
+      readLock.unlock();
+    }
+  }
+
-        TaskAttemptEvent event) {
+        TaskAttemptEvent evnt) {
+
+      TaskAttemptContainerLaunchedEvent event =
+        (TaskAttemptContainerLaunchedEvent) evnt;
+
+      taskAttempt.shufflePort = event.getShufflePort();
