Merge r1360400 through r1399945 from trunk.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1399950 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.util.Time;
+
+import com.google.common.annotations.VisibleForTesting;
-  private long currentPeriodStart = System.currentTimeMillis();
+  private long currentPeriodStart = Time.now();
+    @Override
+    @Override
+    @Override
-    return System.currentTimeMillis() - scanPeriod + 
+    return Time.now() - scanPeriod + 
+  @VisibleForTesting
+  long getTotalScans() {
+    return totalScans;
+  }
+
-    long now = System.currentTimeMillis();
+    long now = Time.now();
-    long timeLeft = currentPeriodStart+scanPeriod - System.currentTimeMillis();
+    long timeLeft = currentPeriodStart+scanPeriod - Time.now();
-  private void verifyBlock(ExtendedBlock block) {
+  @VisibleForTesting
+  void verifyBlock(ExtendedBlock block) {
-      long now = System.currentTimeMillis();
+      long now = Time.now();
-      long lastScanTime = System.currentTimeMillis() - scanPeriod;
+      long lastScanTime = Time.now() - scanPeriod;
-    currentPeriodStart = System.currentTimeMillis();
+    currentPeriodStart = Time.now();
+  private synchronized boolean workRemainingInCurrentPeriod() {
+    if (bytesLeft <= 0 && Time.now() < currentPeriodStart + scanPeriod) {
+      if (LOG.isDebugEnabled()) {
+        LOG.debug("Skipping scan since bytesLeft=" + bytesLeft + ", Start=" +
+                  currentPeriodStart + ", period=" + scanPeriod + ", now=" +
+                  Time.now() + " " + blockPoolId);
+      }
+      return false;
+    } else {
+      return true;
+    }
+  }
+
-    startNewPeriod();
+    if (!workRemainingInCurrentPeriod()) {
+      return;
+    }
+
-      lastScanTime.set(System.currentTimeMillis());
+      lastScanTime.set(Time.now());
-        long now = System.currentTimeMillis();
+        long now = Time.now();
-      cleanUp();
+      rollVerificationLogs();
-  private synchronized void cleanUp() {
+  private synchronized void rollVerificationLogs() {
-    long now = System.currentTimeMillis();
+    long now = Time.now();
