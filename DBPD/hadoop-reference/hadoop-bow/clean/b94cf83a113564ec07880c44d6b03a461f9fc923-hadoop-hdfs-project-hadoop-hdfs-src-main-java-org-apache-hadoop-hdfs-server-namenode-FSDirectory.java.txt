HDFS-4159. Rename should fail when the destination directory is snapshottable and has snapshots. Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1406771 13f79535-47bb-0310-9956-ffa450edef68

+      INode snapshotNode = hasSnapshot(dstInode);
+      if (snapshotNode != null) {
+        error = "The direcotry " + dstInode.getFullPathName()
+            + " cannot be deleted for renaming since "
+            + snapshotNode.getFullPathName()
+            + " is snapshottable and already has snapshots";
+        NameNode.stateChangeLog.warn("DIR* FSDirectory.unprotectedRenameTo: "
+            + error);
+        throw new IOException(error);
+      }
-      for (INode child : targetDir.getChildren()) {
-        INode snapshotDir = hasSnapshot(child);
-        if (snapshotDir != null) {
-          return snapshotDir;
+      List<INode> children = targetDir.getChildren();
+      if (children != null) {
+        for (INode child : children) {
+          INode snapshotDir = hasSnapshot(child);
+          if (snapshotDir != null) {
+            return snapshotDir;
+          }
