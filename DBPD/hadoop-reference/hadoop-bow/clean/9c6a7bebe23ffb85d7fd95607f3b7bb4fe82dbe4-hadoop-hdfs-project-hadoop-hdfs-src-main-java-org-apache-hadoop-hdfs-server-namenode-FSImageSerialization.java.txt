HDFS-4675. Fix rename across snapshottable directories.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1467540 13f79535-47bb-0310-9956-ffa450edef68

+import com.google.common.base.Preconditions;
+
-    out.writeBoolean(ref instanceof INodeReference.WithName);
-
+    final boolean isWithName = ref instanceof INodeReference.WithName;
+    out.writeBoolean(isWithName);
+    
+    if (!isWithName) {
+      Preconditions.checkState(ref instanceof INodeReference.DstReference);
+      // dst snapshot id
+      out.writeInt(((INodeReference.DstReference) ref).getDstSnapshotId());
+    }
+    
-    referenceMap.writeINodeReferenceWithCount(withCount, out, writeUnderConstruction);
+    referenceMap.writeINodeReferenceWithCount(withCount, out,
+        writeUnderConstruction);
-      writeINodeReference(node.asReference(), out, writeUnderConstruction, referenceMap);
+      writeINodeReference(node.asReference(), out, writeUnderConstruction,
+          referenceMap);
