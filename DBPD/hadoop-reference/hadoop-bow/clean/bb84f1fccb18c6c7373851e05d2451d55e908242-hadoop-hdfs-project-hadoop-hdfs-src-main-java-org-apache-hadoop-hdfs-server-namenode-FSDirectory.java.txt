HDFS-7159. Use block storage policy to set lazy persist preference. (Arpit Agarwal)

+import org.apache.hadoop.hdfs.protocol.BlockStoragePolicy;
-      long mtime, long atime, short replication, long preferredBlockSize,
-      boolean isLazyPersist) {
-    return newINodeFile(id, permissions, mtime, atime, replication, preferredBlockSize,
-        isLazyPersist, (byte)0);
+      long mtime, long atime, short replication, long preferredBlockSize) {
+    return new INodeFile(id, null, permissions, mtime, atime,
+        BlockInfo.EMPTY_ARRAY, replication, preferredBlockSize,
+        (byte) 0);
-      boolean isLazyPersist, byte storagePolicyId) {
+      byte storagePolicyId) {
-        isLazyPersist, storagePolicyId);
+        storagePolicyId);
-                    boolean isLazyPersist,
-        permissions, modTime, modTime, replication, preferredBlockSize,
-        isLazyPersist);
+        permissions, modTime, modTime, replication, preferredBlockSize);
-                            boolean isLazyPersist,
-          modificationTime, replication, preferredBlockSize, isLazyPersist, storagePolicyId);
+          modificationTime, replication, preferredBlockSize, storagePolicyId);
-          replication, preferredBlockSize, isLazyPersist, storagePolicyId);
+          replication, preferredBlockSize, storagePolicyId);
+      BlockStoragePolicy newPolicy = getBlockManager().getStoragePolicy(policyId);
+      if (newPolicy.isCopyOnCreateFile()) {
+        throw new HadoopIllegalArgumentException(
+            "Policy " + newPolicy + " cannot be set after file creation.");
+      }
+
+      BlockStoragePolicy currentPolicy =
+          getBlockManager().getStoragePolicy(inode.getLocalStoragePolicyID());
+
+      if (currentPolicy != null && currentPolicy.isCopyOnCreateFile()) {
+        throw new HadoopIllegalArgumentException(
+            "Existing policy " + currentPolicy.getName() +
+                " cannot be changed after file creation.");
+      }
-      return new HdfsFileStatus(0, true, 0, 0, false, 0, 0, null, null, null, null,
+      return new HdfsFileStatus(0, true, 0, 0, 0, 0, null, null, null, null,
-     boolean isLazyPersist = false;
-       isLazyPersist = fileNode.getLazyPersistFlag();
-        isLazyPersist,
-    boolean isLazyPersist = false;
-      isLazyPersist = fileNode.getLazyPersistFlag();
-          blocksize, isLazyPersist, node.getModificationTime(snapshot),
+          blocksize, node.getModificationTime(snapshot),
