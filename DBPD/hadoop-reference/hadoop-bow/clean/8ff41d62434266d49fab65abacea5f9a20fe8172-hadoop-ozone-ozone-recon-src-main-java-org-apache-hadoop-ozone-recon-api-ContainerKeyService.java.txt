HDDS-1358 : Recon Server REST API not working as expected. (#668)



+import java.util.ArrayList;
+import java.util.Collections;
+import java.util.TreeMap;
+import javax.inject.Inject;
+import javax.ws.rs.Produces;
+import javax.ws.rs.core.MediaType;
+import org.apache.hadoop.ozone.om.helpers.OmKeyLocationInfo;
+import org.apache.hadoop.ozone.recon.ReconServer;
+import org.apache.hadoop.ozone.recon.api.types.KeyMetadata.ContainerBlockMetadata;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
-import com.google.inject.Inject;
+@Produces(MediaType.APPLICATION_JSON)
+  private static final Logger LOG = LoggerFactory.getLogger(ReconServer.class);
+
-  @Path("{id}")
+  @Path("/{id}")
-        List<Long> matchedVersions = omKeyInfo.getKeyLocationVersions()
+        List<OmKeyLocationInfoGroup> matchedKeys = omKeyInfo
+            .getKeyLocationVersions()
-            .mapToLong(OmKeyLocationInfoGroup::getVersion)
-            .boxed()
+        List<ContainerBlockMetadata> blockIds = new ArrayList<>();
+        for (OmKeyLocationInfoGroup omKeyLocationInfoGroup : matchedKeys) {
+          List<OmKeyLocationInfo> omKeyLocationInfos = omKeyLocationInfoGroup
+              .getLocationList()
+              .stream()
+              .filter(c -> c.getContainerID() == containerId)
+              .collect(Collectors.toList());
+          for (OmKeyLocationInfo omKeyLocationInfo : omKeyLocationInfos) {
+            blockIds.add(new ContainerBlockMetadata(omKeyLocationInfo
+                .getContainerID(), omKeyLocationInfo.getLocalID()));
+          }
+        }
+
-          keyMetadataMap.get(ozoneKey).getVersions().addAll(matchedVersions);
+          keyMetadataMap.get(ozoneKey).getVersions()
+              .add(containerKeyPrefix.getKeyVersion());
+
+          keyMetadataMap.get(ozoneKey).getBlockIds().putAll(
+              Collections.singletonMap(containerKeyPrefix.getKeyVersion(),
+                  blockIds));
-          keyMetadata.setVersions(matchedVersions);
+          keyMetadata.setVersions(new ArrayList<Long>() {{
+              add(containerKeyPrefix.getKeyVersion());
+            }});
+          keyMetadata.setBlockIds(new TreeMap<Long,
+              List<ContainerBlockMetadata>>() {{
+              put(containerKeyPrefix.getKeyVersion(), blockIds);
+            }});
