HDFS-8567. Erasure Coding: SafeMode handles file smaller than a full stripe. Contributed by Walter Su.

-    return block.isStriped() ?
-        ((BlockInfoStriped) block).getTotalBlockNum() : defaultReplication;
+    if (block.isStriped()) {
+      return ((BlockInfoStriped) block).getRealTotalBlockNum();
+    } else {
+      return defaultReplication;
+    }
-      return getStripedDataBlockNum(block);
+      return ((BlockInfoStriped) block).getRealDataBlockNum();
-        ((BlockInfoStriped) curBlock).getDataBlockNum() : minReplication;
+        ((BlockInfoStriped) curBlock).getRealDataBlockNum() : minReplication;
-      return (short) (getStripedDataBlockNum(block) + 
-          ((BlockInfoStriped) block).getParityBlockNum());
+      return ((BlockInfoStriped) block).getRealTotalBlockNum();
-  
-  short getStripedDataBlockNum(BlockInfo block) {
-    assert block.isStriped();
-    final BlockInfoStriped sblock = (BlockInfoStriped) block;
-    short dataBlockNum = sblock.getDataBlockNum();
-    if (sblock.isComplete() ||
-        sblock.getBlockUCState() == BlockUCState.COMMITTED) {
-      // if the sblock is committed/completed and its length is less than a
-      // full stripe, the minimum storage number needs to be adjusted
-      dataBlockNum = (short) Math.min(dataBlockNum,
-          (sblock.getNumBytes() - 1) / BLOCK_STRIPED_CELL_SIZE + 1);
-    }
-    return dataBlockNum;
-  }
-  
+
