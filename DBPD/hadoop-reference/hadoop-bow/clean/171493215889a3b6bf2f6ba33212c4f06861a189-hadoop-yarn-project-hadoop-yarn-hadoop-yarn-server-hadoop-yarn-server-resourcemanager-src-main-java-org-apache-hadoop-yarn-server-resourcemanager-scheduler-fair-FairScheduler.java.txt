YARN-333. Schedulers cannot control the queue-name of an application. (sandyr via tucu)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1502374 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.yarn.server.resourcemanager.rmapp.RMApp;
+import com.google.common.annotations.VisibleForTesting;
+
-
-    FSLeafQueue queue = queueMgr.getLeafQueue(queueName);
-    if (queue == null) {
-      // queue is not an existing or createable leaf queue
-      queue = queueMgr.getLeafQueue(YarnConfiguration.DEFAULT_QUEUE_NAME);
-    }
+    RMApp rmApp = rmContext.getRMApps().get(applicationAttemptId);
+    FSLeafQueue queue = assignToQueue(rmApp, queueName, user);
+  
+  @VisibleForTesting
+  FSLeafQueue assignToQueue(RMApp rmApp, String queueName, String user) {
+    // Potentially set queue to username if configured to do so
+    if (queueName.equals(YarnConfiguration.DEFAULT_QUEUE_NAME) &&
+        userAsDefaultQueue) {
+      queueName = user;
+    }
+    
+    FSLeafQueue queue = queueMgr.getLeafQueue(queueName);
+    if (queue == null) {
+      // queue is not an existing or createable leaf queue
+      queue = queueMgr.getLeafQueue(YarnConfiguration.DEFAULT_QUEUE_NAME);
+    }
+    
+    if (rmApp != null) {
+      rmApp.setQueue(queue.getName());
+    }
+    
+    return queue;
+  }
-
-      // Potentially set queue to username if configured to do so
-      String def = YarnConfiguration.DEFAULT_QUEUE_NAME;
-      if (queue.equals(def) && userAsDefaultQueue) {
-        queue = appAddedEvent.getUser();
-      }
-
