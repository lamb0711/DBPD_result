MAPREDUCE-2652. Enabled multiple NMs to be runnable on a single node by making shuffle service port to be truely configurable. Contributed by Robert Joseph Evans.



git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1163585 13f79535-47bb-0310-9956-ffa450edef68

+import java.nio.ByteBuffer;
-import org.apache.hadoop.fs.CommonConfigurationKeysPublic;
+import org.apache.hadoop.mapred.ShuffleHandler;
+import org.apache.hadoop.mapreduce.v2.app.job.event.TaskAttemptContainerLaunchedEvent;
+import org.apache.hadoop.yarn.api.protocolrecords.StartContainerResponse;
+    @SuppressWarnings("unchecked")
-          proxy.startContainer(startRequest);
-
-          LOG.info("Returning from container-launch for " + taskAttemptID);
+          StartContainerResponse response = proxy.startContainer(startRequest);
+          ByteBuffer portInfo = response
+              .getServiceResponse(ShuffleHandler.MAPREDUCE_SHUFFLE_SERVICEID);
+          int port = -1;
+          if(portInfo != null) {
+            port = ShuffleHandler.deserializeMetaData(portInfo);
+          }
+          LOG.info("Shuffle port returned by ContainerManager for "
+              + taskAttemptID + " : " + port);
+          
+          if(port < 0) {
+            throw new IllegalStateException("Invalid shuffle port number "
+                + port + " returned for " + taskAttemptID);
+          }
-              new TaskAttemptEvent(taskAttemptID,
-                  TaskAttemptEventType.TA_CONTAINER_LAUNCHED));
+              new TaskAttemptContainerLaunchedEvent(taskAttemptID, port));
