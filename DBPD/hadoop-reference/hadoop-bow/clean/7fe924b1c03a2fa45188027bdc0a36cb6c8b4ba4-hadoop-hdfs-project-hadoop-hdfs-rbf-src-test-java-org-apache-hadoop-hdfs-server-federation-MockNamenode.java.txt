HDFS-15016. RBF: getDatanodeReport() should return the latest update. Contributed by Inigo Goiri.

+import org.apache.hadoop.hdfs.protocol.HdfsConstants.DatanodeReportType;
+import org.apache.hadoop.hdfs.server.protocol.DatanodeStorage;
+import org.apache.hadoop.hdfs.server.protocol.DatanodeStorageReport;
+import org.apache.hadoop.hdfs.server.protocol.StorageReport;
+  /** Datanodes registered in this Namenode. */
+  private List<DatanodeInfo> dns = new ArrayList<>();
+   * Get the datanodes that this NN will return.
+   * @return The datanodes that this NN will return.
+   */
+  public List<DatanodeInfo> getDatanodes() {
+    return this.dns;
+  }
+
+  /**
+  /**
+   * Add datanode related operations.
+   * @throws IOException If it cannot be setup.
+   */
+  public void addDatanodeMock() throws IOException {
+    when(mockNn.getDatanodeReport(any(DatanodeReportType.class))).thenAnswer(
+        invocation -> {
+          LOG.info("{} getDatanodeReport()", nsId, invocation.getArgument(0));
+          return dns.toArray();
+        });
+    when(mockNn.getDatanodeStorageReport(any(DatanodeReportType.class)))
+        .thenAnswer(invocation -> {
+          LOG.info("{} getDatanodeStorageReport()",
+              nsId, invocation.getArgument(0));
+          DatanodeStorageReport[] ret = new DatanodeStorageReport[dns.size()];
+          for (int i = 0; i < dns.size(); i++) {
+            DatanodeInfo dn = dns.get(i);
+            DatanodeStorage storage = new DatanodeStorage(dn.getName());
+            StorageReport[] storageReports = new StorageReport[] {
+                new StorageReport(storage, false, 0L, 0L, 0L, 0L, 0L)
+            };
+            ret[i] = new DatanodeStorageReport(dn, storageReports);
+          }
+          return ret;
+        });
+  }
+
