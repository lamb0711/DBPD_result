HDFS-6005. Simplify Datanode rollback and downgrade. (Contributed by Suresh Srinivas)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535@1571431 13f79535-47bb-0310-9956-ffa450edef68

-import java.io.File;
-import java.io.FileInputStream;
-import java.io.FileOutputStream;
-import java.io.IOException;
-import java.io.RandomAccessFile;
-import java.nio.channels.FileLock;
-import java.util.*;
-import java.util.concurrent.ConcurrentHashMap;
-
-import org.apache.hadoop.fs.FileUtil;
-import org.apache.hadoop.fs.HardLink;
-import org.apache.hadoop.fs.LocalFileSystem;
-import org.apache.hadoop.fs.Path;
+import org.apache.hadoop.fs.*;
+import java.io.*;
+import java.nio.channels.FileLock;
+import java.util.*;
+import java.util.concurrent.ConcurrentHashMap;
+
-  public StorageInfo getBPStorage(String bpid) {
+  public BlockPoolSliceStorage getBPStorage(String bpid) {
-   *
-   * @param bpid
-   * @param  inProgress
-  /**
-   * Disable trash for the specified block pool storage.
-   * Existing files in trash are purged i.e. permanently deleted.
-   *
-   * @param bpid
-   * @param  inProgress
-   */
-  public void disableAndPurgeTrash(String bpid) {
-    if (trashEnabledBpids.remove(bpid)) {
-      LOG.info("Disabled trash for bpid " + bpid);
+  public void restoreTrash(String bpid) {
+    if (trashEnabledBpids.contains(bpid)) {
+      getBPStorage(bpid).restoreTrash();
+      trashEnabledBpids.remove(bpid);
+      LOG.info("Restored trash for bpid " + bpid);
-    ((BlockPoolSliceStorage) getBPStorage(bpid)).emptyTrash();
+  }
+
+  public boolean trashEnabled(String bpid) {
+    return trashEnabledBpids.contains(bpid);
-   * @param blockFile
-    // 4. mark DN storage is initilized
+    // 4. mark DN storage is initialized
+   * This also empties trash created during rolling upgrade and disables
+   * trash functionality.
-    // To handle finalizing a snapshot taken at datanode level while 
+    // To handle finalizing a snapshot taken at datanode level while
