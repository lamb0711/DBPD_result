HDDS-709. Modify Close Container handling sequence on datanodes. Contributed by Shashikant Banerjee.

+import org.apache.hadoop.hdds.protocol.datanode.proto.ContainerProtos.
+    ContainerDataProto.State;
+import org.apache.hadoop.ozone.container.common.impl.ContainerData;
-      if (!container.getContainerData().isClosed()) {
+      ContainerData containerData = container.getContainerData();
+      State containerState = container.getContainerData().getState();
+      if (containerState != State.CLOSED) {
+        // when a closeContainerCommand arrives at a Datanode and if the
+        // container is open, each replica will be moved to closing state first.
+        if (containerState == State.OPEN) {
+          containerData.setState(State.CLOSING);
+        }
+
+        // if the container is already closed, it will be just ignored.
+        // ICR will get triggered to change the replica state in SCM.
-        ozoneContainer.submitContainerRequest(
-            request.build(), replicationType, pipelineID);
+        ozoneContainer.submitContainerRequest(request.build(), replicationType,
+            pipelineID);
-        IncrementalContainerReportProto icr = IncrementalContainerReportProto
-            .newBuilder()
-            .addReport(ozoneContainer.getContainerSet()
-                .getContainer(containerID).getContainerReport())
-            .build();
+        IncrementalContainerReportProto icr =
+            IncrementalContainerReportProto.newBuilder().addReport(
+                ozoneContainer.getContainerSet().getContainer(containerID)
+                    .getContainerReport()).build();
