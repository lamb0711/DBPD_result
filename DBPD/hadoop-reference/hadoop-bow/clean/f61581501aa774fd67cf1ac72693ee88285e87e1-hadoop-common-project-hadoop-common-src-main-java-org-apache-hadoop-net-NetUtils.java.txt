Merge trunk into HDFS-347 branch.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-347@1446832 13f79535-47bb-0310-9956-ffa450edef68

+import java.lang.reflect.Constructor;
-    if (ch == null) {
-      // let the default implementation handle it.
-      socket.connect(endpoint, timeout);
-    } else {
-      SocketIOWithTimeout.connect(ch, endpoint, timeout);
+    try {
+      if (ch == null) {
+        // let the default implementation handle it.
+        socket.connect(endpoint, timeout);
+      } else {
+        SocketIOWithTimeout.connect(ch, endpoint, timeout);
+      }
+    } catch (SocketTimeoutException ste) {
+      throw new ConnectTimeoutException(ste.getMessage());
-      return (ConnectException) new ConnectException(
+      return wrapWithMessage(exception, 
-              + see("ConnectionRefused"))
-          .initCause(exception);
+              + see("ConnectionRefused"));
-      return (UnknownHostException) new UnknownHostException(
+      return wrapWithMessage(exception,
-              + see("UnknownHost"))
-          .initCause(exception);
+              + see("UnknownHost"));
-      return (SocketTimeoutException) new SocketTimeoutException(
+      return wrapWithMessage(exception,
-              + see("SocketTimeout"))
-          .initCause(exception);
+              + see("SocketTimeout"));
-      return (NoRouteToHostException) new NoRouteToHostException(
+      return wrapWithMessage(exception,
-              + see("NoRouteToHost"))
-          .initCause(exception);
+              + see("NoRouteToHost"));
+  
+  @SuppressWarnings("unchecked")
+  private static <T extends IOException> T wrapWithMessage(
+      T exception, String msg) {
+    Class<? extends Throwable> clazz = exception.getClass();
+    try {
+      Constructor<? extends Throwable> ctor = clazz.getConstructor(String.class);
+      Throwable t = ctor.newInstance(msg);
+      return (T)(t.initCause(exception));
+    } catch (Throwable e) {
+      LOG.warn("Unable to wrap exception of type " +
+          clazz + ": it has no (String) constructor", e);
+      return exception;
+    }
+  }
