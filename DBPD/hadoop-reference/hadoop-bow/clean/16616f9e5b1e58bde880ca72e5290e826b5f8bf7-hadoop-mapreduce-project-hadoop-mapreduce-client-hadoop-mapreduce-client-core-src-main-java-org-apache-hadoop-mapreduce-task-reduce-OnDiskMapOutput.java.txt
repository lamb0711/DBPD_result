MAPREDUCE-5194. Heed interrupts during Fetcher shutdown.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1494416 13f79535-47bb-0310-9956-ffa450edef68

+import com.google.common.annotations.VisibleForTesting;
+
-  private final FileSystem localFS;
+  private final FileSystem fs;
-                         MergeManagerImpl<K, V> merger, long size,
+                         MergeManagerImpl<K,V> merger, long size,
-    throws IOException {
-    super(mapId, size, primaryMapOutput);
-    this.merger = merger;
-    this.localFS = FileSystem.getLocal(conf);
-    outputPath =
-        mapOutputFile.getInputFileForWrite(mapId.getTaskID(),size);
-    tmpOutputPath = outputPath.suffix(String.valueOf(fetcher));
-    
-    disk = localFS.create(tmpOutputPath);
+      throws IOException {
+    this(mapId, reduceId, merger, size, conf, mapOutputFile, fetcher,
+        primaryMapOutput, FileSystem.getLocal(conf),
+        mapOutputFile.getInputFileForWrite(mapId.getTaskID(), size));
+  }
+  @VisibleForTesting
+  OnDiskMapOutput(TaskAttemptID mapId, TaskAttemptID reduceId,
+                         MergeManagerImpl<K,V> merger, long size,
+                         JobConf conf,
+                         MapOutputFile mapOutputFile,
+                         int fetcher, boolean primaryMapOutput,
+                         FileSystem fs, Path outputPath) throws IOException {
+    super(mapId, size, primaryMapOutput);
+    this.fs = fs;
+    this.merger = merger;
+    this.outputPath = outputPath;
+    tmpOutputPath = getTempPath(outputPath, fetcher);
+    disk = fs.create(tmpOutputPath);
+  }
+
+  @VisibleForTesting
+  static Path getTempPath(Path outPath, int fetcher) {
+    return outPath.suffix(String.valueOf(fetcher));
-    localFS.rename(tmpOutputPath, outputPath);
+    fs.rename(tmpOutputPath, outputPath);
-      localFS.delete(tmpOutputPath, false);
+      fs.delete(tmpOutputPath, false);
+
