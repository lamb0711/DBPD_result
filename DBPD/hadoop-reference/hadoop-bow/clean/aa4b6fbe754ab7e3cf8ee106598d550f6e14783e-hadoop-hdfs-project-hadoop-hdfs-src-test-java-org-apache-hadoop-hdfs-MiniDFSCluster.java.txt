HDFS-10391. Always enable NameNode service RPC port. Contributed by Gergely Novak.

+    private int nameNodeServicePort = 0;
+
+    /**
+     * Default: 0
+     */
+    public Builder nameNodeServicePort(int val) {
+      this.nameNodeServicePort = val;
+      return this;
+    }
-     * Default: false
-     * When true the hosts file/include file for the cluster is setup
+     * Default: false.
+     * When true the hosts file/include file for the cluster is setup.
-     * federated nameservices
+     * federated nameservices.
-          builder.nameNodePort, builder.nameNodeHttpPort);
+          builder.nameNodePort, builder.nameNodeServicePort,
+          builder.nameNodeHttpPort);
-                       MiniDFSNNTopology.simpleSingleNN(nameNodePort, 0),
+                       MiniDFSNNTopology.simpleSingleNN(nameNodePort, 0, 0),
+
+    key = DFSUtil.addKeySuffixes(
+        DFS_NAMENODE_SERVICE_RPC_ADDRESS_KEY, nameserviceId,
+        nnConf.getNnId());
+    conf.set(key, "127.0.0.1:" + nnConf.getServicePort());
+    hdfsConf.set(DFSUtil.addKeySuffixes(DFS_NAMENODE_SERVICE_RPC_ADDRESS_KEY,
+        nameserviceId, nnId), nn.getServiceRpcAddressHostPortString());
+  /**
+   * Return the cluster-wide configuration.
+   * @return
+   */
+  public Configuration getClusterConfiguration() {
+    return conf;
+  }
+
+   * Gets the service rpc port used by the NameNode, because the caller
+   * supplied port is not necessarily the actual port used.
+   * Assumption: cluster has a single namenode
+   */
+  public int getNameNodeServicePort() {
+    checkSingleNameNode();
+    return getNameNodeServicePort(0);
+  }
+
+  /**
-    InetSocketAddress addr = info.nameNode.getServiceRpcAddress();
-    assert addr.getPort() != 0;
-    DFSClient client = new DFSClient(addr, conf);
+    InetSocketAddress nameNodeAddress = info.nameNode.getNameNodeAddress();
+    assert nameNodeAddress.getPort() != 0;
+    DFSClient client = new DFSClient(nameNodeAddress, conf);
-    while (shouldWait(client.datanodeReport(DatanodeReportType.LIVE), addr)) {
+    InetSocketAddress serviceAddress = info.nameNode.getServiceRpcAddress();
+    while (shouldWait(client.datanodeReport(DatanodeReportType.LIVE),
+        serviceAddress)) {
+  public void addNameNode(Configuration conf, int namenodePort)
+      throws IOException{
+    addNameNode(conf, namenodePort, 0);
+  }
+
-  public void addNameNode(Configuration conf, int namenodePort)
+  public void addNameNode(Configuration conf, int namenodePort, int servicePort)
-        new NNConf(nnId).setIpcPort(namenodePort));
+        new NNConf(nnId)
+            .setIpcPort(namenodePort)
+            .setServicePort(servicePort));
