HDFS-4446. Support file snapshots with diff lists.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1443825 13f79535-47bb-0310-9956-ffa450edef68

-  protected INodeFile(INodeFile that) {
+  public INodeFile(INodeFile that) {
-  @Override
-  INodeFile recordModification(final Snapshot latest) {
-    //TODO: change it to use diff list
-    return (INodeFile)super.recordModification(latest);
-  }
-
-  @Override
-  public Pair<? extends INodeFile, ? extends INodeFile> createSnapshotCopy() {
-    return parent.replaceChild4INodeFileWithSnapshot(this).createSnapshotCopy();
-  }
-
+  @Override
+  public INodeFile recordModification(final Snapshot latest) {
+    return latest == null? this
+        : parent.replaceChild4INodeFileWithSnapshot(this)
+            .recordModification(latest);
+  }
+
-  INode setPermission(FsPermission permission, Snapshot latest) {
+  final INode setPermission(FsPermission permission, Snapshot latest) {
-  public final short getFileReplication() {
+  public short getFileReplication(Snapshot snapshot) {
+  /** The same as getFileReplication(null). */
+  public final short getFileReplication() {
+    return getFileReplication(null);
+  }
+
-    return getFileReplication();
+    return getFileReplication(null);
-    parent = null;
+    clearReferences();
-    summary[0] += computeFileSize(true);
+    summary[0] += computeFileSize(true, null);
+  /** The same as computeFileSize(includesBlockInfoUnderConstruction, null). */
+  public long computeFileSize(boolean includesBlockInfoUnderConstruction) {
+    return computeFileSize(includesBlockInfoUnderConstruction, null);
+  }
+
-  public long computeFileSize(boolean includesBlockInfoUnderConstruction) {
+  public long computeFileSize(boolean includesBlockInfoUnderConstruction,
+      Snapshot snapshot) {
-    out.print(", fileSize=" + computeFileSize(true));
+    out.print(", fileSize=" + computeFileSize(true, snapshot));
