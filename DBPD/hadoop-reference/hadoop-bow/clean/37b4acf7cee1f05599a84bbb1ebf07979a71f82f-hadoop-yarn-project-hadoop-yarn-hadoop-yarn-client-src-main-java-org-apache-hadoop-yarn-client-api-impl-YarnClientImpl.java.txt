YARN-6137. Yarn client implicitly invoke ATS client which accesses HDFS. Contributed by Li Lu

-  protected TimelineClient timelineClient;
+  protected volatile TimelineClient timelineClient;
-      try {
-        timelineServiceEnabled = true;
-        timelineClient = createTimelineClient();
-        timelineClient.init(conf);
-        timelineDTRenewer = getTimelineDelegationTokenRenewer(conf);
-        timelineService = TimelineUtils.buildTimelineTokenService(conf);
-      } catch (NoClassDefFoundError error) {
-        // When attempt to initiate the timeline client with
-        // different set of dependencies, it may fail with
-        // NoClassDefFoundError. When some of them are not compatible
-        // with timeline server. This is not necessarily a fatal error
-        // to the client.
-        LOG.warn("Timeline client could not be initialized "
-            + "because dependency missing or incompatible,"
-            + " disabling timeline client.",
-            error);
-        timelineServiceEnabled = false;
-      }
+      timelineServiceEnabled = true;
+      timelineDTRenewer = getTimelineDelegationTokenRenewer(conf);
+      timelineService = TimelineUtils.buildTimelineTokenService(conf);
-      if (timelineServiceEnabled) {
-        timelineClient.start();
-      }
-    if (timelineServiceEnabled) {
+    if (timelineClient != null) {
-        try {
-          return timelineClient.getDelegationToken(timelineDTRenewer);
-        } catch (Exception e ) {
-          if (timelineServiceBestEffort) {
-            LOG.warn("Failed to get delegation token from the timeline server: "
-                + e.getMessage());
-            return null;
+    try {
+      // Only reachable when both security and timeline service are enabled.
+      if (timelineClient == null) {
+        synchronized (this) {
+          if (timelineClient == null) {
+            timelineClient = createTimelineClient();
+            timelineClient.init(getConfig());
+            timelineClient.start();
-          throw e;
+      }
+      return timelineClient.getDelegationToken(timelineDTRenewer);
+    } catch (Exception e) {
+      if (timelineServiceBestEffort) {
+        LOG.warn("Failed to get delegation token from the timeline server: "
+            + e.getMessage());
+        return null;
+      }
+      throw e;
+    }
