HDFS-73. DFSOutputStream does not close all the sockets. Contributed by Uma Maheswara Rao G


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1157232 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.conf.Configuration;
-import org.apache.hadoop.hdfs.server.datanode.DataNode;
+          setLastException(e);
+          setLastException(e);
+      if (null != s) {
+        try {
+          s.close();
+        } catch (IOException e) {
+          setLastException(e);
+        } finally {
+          s = null;
+        }
+      }
+      DataOutputStream out = null;
+        assert null == s : "Previous socket unclosed";
-        DataOutputStream out = new DataOutputStream(new BufferedOutputStream(
+        out = new DataOutputStream(new BufferedOutputStream(
+        
+        assert null == blockReplyStream : "Previous blockReplyStream unclosed";
-
+        assert null == blockStream : "Previous blockStream unclosed";
-        blockReplyStream = null;
+          IOUtils.closeStream(out);
+          out = null;
+          IOUtils.closeStream(blockReplyStream);
+          blockReplyStream = null;
