HDFS-11727. Block Storage: Retry Blocks should be requeued when cblock is restarted. Contributed by Mukul Kumar Singh.

+import org.apache.hadoop.cblock.jscsiHelper.cache.impl.AsyncBlockWriter;
+import org.apache.hadoop.utils.LevelDBStore;
-  private static final String RETRY_LOG_PREFIX = "RetryLog";
+  private final int maxRetryCount;
-      String dbPath, String fileName) {
+      String dbPath, int tryCount, String fileName, int maxRetryCount) {
-    tryCount = 0;
+    this.tryCount = tryCount;
+    this.maxRetryCount = maxRetryCount;
+    LevelDBStore levelDBStore = null;
-      data = flusher.getCacheDB(this.dbPath).get(keybuf);
+      levelDBStore = flusher.getCacheDB(this.dbPath);
+      data = levelDBStore.get(keybuf);
+      Preconditions.checkNotNull(data);
-      flusher.getLOG().error("Writing of block failed, We have attempted " +
+      flusher.getLOG().error("Writing of block:{} failed, We have attempted " +
-          this.getTryCount(), containerName, "", ex);
+          block.getBlockID(), this.getTryCount(), containerName, "", ex);
+      if (this.getTryCount() >= maxRetryCount) {
+        flusher.getTargetMetrics().incNumWriteMaxRetryBlocks();
+      }
+      if (levelDBStore != null) {
+        flusher.releaseCacheDB(dbPath);
+      }
-        String.format("%s.%d.%s", RETRY_LOG_PREFIX, currentBlock.getBlockID(),
-            Time.monotonicNow());
+        String.format("%s.%d.%s.%s", AsyncBlockWriter.RETRY_LOG_PREFIX,
+            currentBlock.getBlockID(), Time.monotonicNow(), tryCount);
+    buffer.flip();
+      flusher.getTargetMetrics().incNumFailedRetryLogFileWrites();
