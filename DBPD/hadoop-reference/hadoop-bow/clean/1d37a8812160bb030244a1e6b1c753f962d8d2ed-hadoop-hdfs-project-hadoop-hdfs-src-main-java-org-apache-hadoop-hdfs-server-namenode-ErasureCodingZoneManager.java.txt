HDFS-8854. Erasure coding: add ECPolicy to replace schema+cellSize in hadoop-hdfs. Contributed by Walter Su.

+import org.apache.hadoop.hdfs.protocol.ErasureCodingPolicy;
-import org.apache.hadoop.hdfs.protocol.HdfsConstants;
-import org.apache.hadoop.io.erasurecode.ECSchema;
-  ECSchema getErasureCodingSchema(INodesInPath iip) throws IOException {
+  ErasureCodingPolicy getErasureCodingPolicy(INodesInPath iip) throws IOException {
-    return ecZone == null ? null : ecZone.getSchema();
+    return ecZone == null ? null : ecZone.getErasureCodingPolicy();
-          int cellSize = WritableUtils.readVInt(dIn);
-          String schemaName = WritableUtils.readString(dIn);
-          ECSchema schema = dir.getFSNamesystem()
-              .getErasureCodingSchemaManager().getSchema(schemaName);
+          String ecPolicyName = WritableUtils.readString(dIn);
+          ErasureCodingPolicy ecPolicy = dir.getFSNamesystem()
+              .getErasureCodingPolicyManager().getPolicy(ecPolicyName);
-              .getFullPathName(), schema, cellSize);
+              .getFullPathName(), ecPolicy);
-      ECSchema schema, int cellSize) throws IOException {
+      ErasureCodingPolicy ecPolicy) throws IOException {
-    if (getErasureCodingSchema(srcIIP) != null) {
+    if (getErasureCodingPolicy(srcIIP) != null) {
-    // System default schema will be used since no specified.
-    if (schema == null) {
-      schema = ErasureCodingSchemaManager.getSystemDefaultSchema();
+    // System default erasure coding policy will be used since no specified.
+    if (ecPolicy == null) {
+      ecPolicy = ErasureCodingPolicyManager.getSystemDefaultPolicy();
-    if (cellSize <= 0) {
-      cellSize = HdfsConstants.BLOCK_STRIPED_CELL_SIZE;
-    }
-
-    // Write the cellsize first and then schema name
-      WritableUtils.writeVInt(dOut, cellSize);
-      // Now persist the schema name in xattr
-      WritableUtils.writeString(dOut, schema.getSchemaName());
+      WritableUtils.writeString(dOut, ecPolicy.getName());
-    final ECSchema srcSchema = (srcZone != null) ? srcZone.getSchema() : null;
-    final ECSchema dstSchema = (dstZone != null) ? dstZone.getSchema() : null;
-    if ((srcSchema != null && !srcSchema.equals(dstSchema)) ||
-        (dstSchema != null && !dstSchema.equals(srcSchema))) {
+    final ErasureCodingPolicy srcECPolicy =
+        srcZone != null ? srcZone.getErasureCodingPolicy() : null;
+    final ErasureCodingPolicy dstECPolicy =
+        dstZone != null ? dstZone.getErasureCodingPolicy() : null;
+    if (srcECPolicy != null && !srcECPolicy.equals(dstECPolicy) ||
+        dstECPolicy != null && !dstECPolicy.equals(srcECPolicy)) {
