Merge remote-tracking branch 'apache/trunk' into HDFS-7285

+import org.apache.hadoop.hdfs.server.namenode.INodeId;
-    final int numExpected = blockManager.getExpectedReplicaNum(bc, block);
+    final int numExpected = blockManager.getExpectedReplicaNum(block);
-    if (!blockManager.isNeededReplication(block, numExpected, numLive)) {
+    if (!blockManager.isNeededReplication(block, numLive)) {
-  private void logBlockReplicationInfo(BlockInfo block, BlockCollection bc,
+  private void logBlockReplicationInfo(BlockInfo block,
+      BlockCollection bc,
-    int curExpectedReplicas = blockManager.getExpectedReplicaNum(bc, block);
+    int curExpectedReplicas = blockManager.getExpectedReplicaNum(block);
-        BlockCollection bc = blockManager.getBlockCollection(block);
-        if (bc == null) {
+
+        long bcId = block.getBlockCollectionId();
+        if (bcId == INodeId.INVALID_INODE_ID) {
+        BlockCollection bc = namesystem.getBlockCollection(bcId);
-        if (blockManager.isNeededReplication(block,
-            blockManager.getExpectedReplicaNum(bc, block), liveReplicas)) {
+        if (blockManager.isNeededReplication(block, liveReplicas)) {
-                blockManager.getExpectedReplicaNum(bc, block));
+                blockManager.getExpectedReplicaNum(block));
