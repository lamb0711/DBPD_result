Merging r1527684 through r1532876 from trunk to branch HDFS-2832

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2832@1532910 13f79535-47bb-0310-9956-ffa450edef68

-      boolean cleanOnStart, Clock clock, boolean shutdown) {
+      boolean cleanOnStart, Clock clock, boolean unregistered) {
-        shutdown);
+        unregistered);
-      boolean cleanOnStart, boolean shutdown) {
-    this(maps, reduces, autoComplete, testName, cleanOnStart, 1, shutdown);
+      boolean cleanOnStart, boolean unregistered) {
+    this(maps, reduces, autoComplete, testName, cleanOnStart, 1, unregistered);
-      boolean cleanOnStart, int startCount, boolean shutdown) {
+      boolean cleanOnStart, int startCount, boolean unregistered) {
-        new SystemClock(), shutdown);
+        new SystemClock(), unregistered);
-      boolean cleanOnStart, int startCount, Clock clock, boolean shutdown) {
+      boolean cleanOnStart, int startCount, Clock clock, boolean unregistered) {
-      cleanOnStart, startCount, clock, shutdown);
+      cleanOnStart, startCount, clock, unregistered);
-      boolean cleanOnStart, int startCount, boolean shutdown) {
+      boolean cleanOnStart, int startCount, boolean unregistered) {
-        cleanOnStart, startCount, new SystemClock(), shutdown);
+        cleanOnStart, startCount, new SystemClock(), unregistered);
-      boolean cleanOnStart, int startCount, Clock clock, boolean shutdown) {
+      boolean cleanOnStart, int startCount, Clock clock, boolean unregistered) {
-    this.safeToReportTerminationToUser.set(shutdown);
+    this.successfullyUnregistered.set(unregistered);
+    //TODO: fix the bug where the speculator gets events with 
+    //not-fully-constructed objects. For now, disable speculative exec
+    return submit(conf, false, false);
+  }
+
+  public Job submit(Configuration conf, boolean mapSpeculative,
+      boolean reduceSpeculative) throws Exception {
-      .getCurrentUser().getShortUserName());
+        .getCurrentUser().getShortUserName());
-    //TODO: fix the bug where the speculator gets events with 
-    //not-fully-constructed objects. For now, disable speculative exec
-    LOG.info("****DISABLING SPECULATIVE EXECUTION*****");
-    conf.setBoolean(MRJobConfig.MAP_SPECULATIVE, false);
-    conf.setBoolean(MRJobConfig.REDUCE_SPECULATIVE, false);
+    // TODO: fix the bug where the speculator gets events with
+    // not-fully-constructed objects. For now, disable speculative exec
+    conf.setBoolean(MRJobConfig.MAP_SPECULATIVE, mapSpeculative);
+    conf.setBoolean(MRJobConfig.REDUCE_SPECULATIVE, reduceSpeculative);
-      TypeConverter.fromYarn(job.getID()));
+        TypeConverter.fromYarn(job.getID()));
