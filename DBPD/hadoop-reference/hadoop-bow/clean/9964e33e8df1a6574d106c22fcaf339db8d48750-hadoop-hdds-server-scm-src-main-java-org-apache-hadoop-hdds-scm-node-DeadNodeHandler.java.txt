HDDS-369. Remove the containers of a dead node from the container state map. Contributed by Elek, Marton

- *
- *     http://www.apache.org/licenses/LICENSE-2.0
- *
+ * <p>
+ * http://www.apache.org/licenses/LICENSE-2.0
+ * <p>
+import java.util.Set;
+
+import org.apache.hadoop.hdds.scm.container.ContainerID;
+import org.apache.hadoop.hdds.scm.container.ContainerStateManager;
+import org.apache.hadoop.hdds.scm.exceptions.SCMException;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
-  public DeadNodeHandler(Node2ContainerMap node2ContainerMap) {
+  private final ContainerStateManager containerStateManager;
+
+  private static final Logger LOG =
+      LoggerFactory.getLogger(DeadNodeHandler.class);
+
+  public DeadNodeHandler(
+      Node2ContainerMap node2ContainerMap,
+      ContainerStateManager containerStateManager) {
+    this.containerStateManager = containerStateManager;
-                        EventPublisher publisher) {
-    //TODO: add logic to handle dead node.
+      EventPublisher publisher) {
+    Set<ContainerID> containers =
+        node2ContainerMap.getContainers(datanodeDetails.getUuid());
+    LOG.info(
+        "Datanode {}  is dead. Removing replications from the in-memory state.",
+        datanodeDetails.getUuid());
+    for (ContainerID container : containers) {
+      try {
+        containerStateManager.removeContainerReplica(container,
+            datanodeDetails);
+      } catch (SCMException e) {
+        LOG.error("Can't remove container from containerStateMap {}", container
+            .getId(), e);
+      }
+    }
