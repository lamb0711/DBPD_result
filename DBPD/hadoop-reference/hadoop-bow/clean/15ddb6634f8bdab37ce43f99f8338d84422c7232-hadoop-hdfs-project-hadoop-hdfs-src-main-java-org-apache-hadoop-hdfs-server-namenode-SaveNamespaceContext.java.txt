HDFS-2800. Fix cancellation of checkpoints in the standby node to be more reliable. Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1339745 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.util.Canceler;
-
-  /**
-   * If the operation has been canceled, set to the reason why
-   * it has been canceled (eg standby moving to active)
-   */
-  private volatile String cancelReason = null;
+  private final Canceler canceller;
-  
+
-      long txid) {
+      long txid,
+      Canceler canceller) {
+    this.canceller = canceller;
-  /**
-   * Requests that the current saveNamespace operation be
-   * canceled if it is still running.
-   * @param reason the reason why cancellation is requested
-   * @throws InterruptedException 
-   */
-  void cancel(String reason) throws InterruptedException {
-    this.cancelReason = reason;
-    completionLatch.await();
-  }
-  
-    if (cancelReason != null) {
+    if (canceller.isCancelled()) {
-          cancelReason);
+          canceller.getCancellationReason());
-
-  boolean isCancelled() {
-    return cancelReason != null;
-  }
