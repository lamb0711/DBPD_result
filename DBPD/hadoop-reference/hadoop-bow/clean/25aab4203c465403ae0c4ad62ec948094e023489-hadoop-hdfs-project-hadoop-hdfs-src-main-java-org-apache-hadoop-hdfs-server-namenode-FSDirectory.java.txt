HDFS-4636. Update quota usage when deleting files/dirs that were created after taking the latest snapshot. Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1462192 13f79535-47bb-0310-9956-ffa450edef68

-      final int removedSrc = removeLastINode(srcIIP);
+      final long removedSrc = removeLastINode(srcIIP);
-    final int removedSrc = removeLastINode(srcIIP);
+    final long removedSrc = removeLastINode(srcIIP);
-    final int removed = removeLastINode(iip);
+    long removed = removeLastINode(iip);
-    targetNode.getParent().updateModificationTime(mtime, latestSnapshot);
+    final INodeDirectory parent = targetNode.getParent();
+    parent.updateModificationTime(mtime, latestSnapshot);
-
+    
-    final long inodesRemoved = targetNode.cleanSubtree(null, latestSnapshot,
-        collectedBlocks).get(Quota.NAMESPACE);
+    if (!targetNode.isInLatestSnapshot(latestSnapshot)) {
+      targetNode.destroyAndCollectBlocks(collectedBlocks);
+    } else {
+      Quota.Counts counts = targetNode.cleanSubtree(null, latestSnapshot,
+          collectedBlocks);
+      parent.addSpaceConsumed(-counts.get(Quota.NAMESPACE),
+          -counts.get(Quota.DISKSPACE));
+      removed = counts.get(Quota.NAMESPACE);
+    }
-    return inodesRemoved;
+    return removed;
-  private int removeLastINode(final INodesInPath iip)
+  private long removeLastINode(final INodesInPath iip)
-    if (latestSnapshot == null) {
+    if (!last.isInLatestSnapshot(latestSnapshot)) {
+      } else {
+        return counts.get(Quota.NAMESPACE);
