HDFS-11402. HDFS Snapshots should capture point-in-time copies of OPEN files. (Manoj Govindassamy via Yongjun Zhang)

+import static org.apache.hadoop.hdfs.DFSConfigKeys.DFS_NAMENODE_SNAPSHOT_CAPTURE_OPENFILES;
+import static org.apache.hadoop.hdfs.DFSConfigKeys.DFS_NAMENODE_SNAPSHOT_CAPTURE_OPENFILES_DEFAULT;
+
+import org.apache.hadoop.conf.Configuration;
+import org.apache.hadoop.hdfs.server.namenode.LeaseManager;
-  private boolean allowNestedSnapshots = false;
+  private final boolean captureOpenFiles;
+  private final AtomicInteger numSnapshots = new AtomicInteger();
-  private final AtomicInteger numSnapshots = new AtomicInteger();
-
+  private boolean allowNestedSnapshots = false;
-  public SnapshotManager(final FSDirectory fsdir) {
+  public SnapshotManager(final Configuration conf, final FSDirectory fsdir) {
+    this.captureOpenFiles = conf.getBoolean(
+        DFS_NAMENODE_SNAPSHOT_CAPTURE_OPENFILES,
+        DFS_NAMENODE_SNAPSHOT_CAPTURE_OPENFILES_DEFAULT);
-  public String createSnapshot(final INodesInPath iip, String snapshotRoot,
-      String snapshotName) throws IOException {
+  public String createSnapshot(final LeaseManager leaseManager,
+      final INodesInPath iip, String snapshotRoot, String snapshotName)
+      throws IOException {
-    srcRoot.addSnapshot(snapshotCounter, snapshotName);
+    srcRoot.addSnapshot(snapshotCounter, snapshotName, leaseManager,
+        this.captureOpenFiles);
