YARN-4846. Fix random failures for TestCapacitySchedulerPreemption#testPreemptionPolicyShouldRespectAlreadyMarkedKillableContainers. (Bibin A Chundatt via wangda)

-  public void editSchedule() {
+  public synchronized void editSchedule() {
-      Map<ApplicationAttemptId, Set<RMContainer>> selectedCandidates) {
+      Map<ApplicationAttemptId, Set<RMContainer>> selectedCandidates,
+      long currentTime) {
-            && preemptionCandidates.get(container) + maxWaitTime < clock
-            .getTime()) {
+            && preemptionCandidates.get(container)
+                + maxWaitTime <= currentTime) {
-          preemptionCandidates.put(container, clock.getTime());
+          preemptionCandidates.put(container, currentTime);
-  private void cleanupStaledPreemptionCandidates() {
+  private void cleanupStaledPreemptionCandidates(long currentTime) {
-      if (preemptionCandidates.get(id) + 2 * maxWaitTime < clock.getTime()) {
+      // And avoid preempt selected containers for *this execution*
+      // or within 1 ms
+      if (preemptionCandidates.get(id) + 2 * maxWaitTime < currentTime) {
+    long currentTime = clock.getTime();
+
-    preemptOrkillSelectedContainerAfterWait(toPreempt);
+    preemptOrkillSelectedContainerAfterWait(toPreempt, currentTime);
-    cleanupStaledPreemptionCandidates();
+    cleanupStaledPreemptionCandidates(currentTime);
