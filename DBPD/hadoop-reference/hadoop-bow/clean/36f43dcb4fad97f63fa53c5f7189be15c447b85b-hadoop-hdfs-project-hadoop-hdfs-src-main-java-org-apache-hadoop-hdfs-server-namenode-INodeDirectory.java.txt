HDFS-4742. Fix appending to a renamed file with snapshot.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1475903 13f79535-47bb-0310-9956-ffa450edef68

-  public void replaceChild(final INode oldChild, final INode newChild) {
+  public void replaceChild(INode oldChild, final INode newChild) {
-    Preconditions.checkState(oldChild == children.get(i));
+    Preconditions.checkState(oldChild == children.get(i)
+        || oldChild == children.get(i).asReference().getReferredINode()
+            .asReference().getReferredINode());
+    oldChild = children.get(i);
-      // TODO: add a unit test for rename + append
-      final INode removed = children.set(i, newChild);
-      Preconditions.checkState(removed == oldChild);
+      children.set(i, newChild);
