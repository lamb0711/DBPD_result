HDFS-4414. Add support for getting snapshot diff from DistributedFileSystem. Contributed by Jing Zhao.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1441808 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.protocol.SnapshotDiffReport;
+import org.apache.hadoop.hdfs.protocol.SnapshotDiffReport.DiffReportEntry;
+import org.apache.hadoop.hdfs.protocol.SnapshotDiffReport.DiffType;
-  public static class SnapshotDiffReport {
+  public static class SnapshotDiffInfo {
-    public SnapshotDiffReport(INodeDirectorySnapshottable snapshotRoot,
+    public SnapshotDiffInfo(INodeDirectorySnapshottable snapshotRoot,
-    /**
-     * dump the diff
+    /** 
+     * Get the name of the given snapshot. 
+     * @param s The given snapshot.
+     * @return The name of the snapshot, or an empty string if {@code s} is null
-    public String dump() {
-      StringBuilder strBuffer = new StringBuilder();
-      String fromStr = from == null ? "current directory" : "snapshot "
-          + from.getRoot().getLocalName();
-      String toStr = to == null ? "current directory" : "snapshot "
-          + to.getRoot().getLocalName();
-      strBuffer.append("Diffence between snapshot " + fromStr + " and " + toStr
-          + " under directory " + snapshotRoot.getFullPathName() + ":\n");
-      
-      if (!diffMap.isEmpty()) {
-        for (Map.Entry<INodeDirectoryWithSnapshot, ChildrenDiff> entry : diffMap
-            .entrySet()) {
-          strBuffer.append("M\t" + entry.getKey().getFullPathName() + "\n");
-          entry.getValue().printDiff(strBuffer, entry.getKey(),
-              from == null || 
-              (to != null && Snapshot.ID_COMPARATOR.compare(from, to) > 0));
-        }
+    private static String getSnapshotName(Snapshot s) {
+      return s != null ? s.getRoot().getLocalName() : "";
+    }
+    
+    /** @return True if {@link #from} is earlier than {@link #to} */
+    private boolean isFromEarlier() {
+      return to == null
+          || (from != null && Snapshot.ID_COMPARATOR.compare(from, to) < 0);
+    }
+    
+    /**
+     * Generate a {@link SnapshotDiffReport} based on detailed diff information.
+     * @return A {@link SnapshotDiffReport} describing the difference
+     */
+    public SnapshotDiffReport generateReport() {
+      List<DiffReportEntry> diffList = new ArrayList<DiffReportEntry>();
+      for (Map.Entry<INodeDirectoryWithSnapshot, ChildrenDiff> entry : diffMap
+          .entrySet()) {
+        diffList.add(new DiffReportEntry(DiffType.MODIFY, entry.getKey()
+            .getFullPathName()));
+        List<DiffReportEntry> subList = entry.getValue().generateReport(
+            entry.getKey(), isFromEarlier());
+        diffList.addAll(subList);
-      return strBuffer.toString();
+      return new SnapshotDiffReport(snapshotRoot.getFullPathName(),
+          getSnapshotName(from), getSnapshotName(to), diffList);
-  SnapshotDiffReport computeDiff(final String from, final String to)
+  SnapshotDiffInfo computeDiff(final String from, final String to)
-    SnapshotDiffReport diffs = new SnapshotDiffReport(this, fromSnapshot,
+    SnapshotDiffInfo diffs = new SnapshotDiffInfo(this, fromSnapshot,
-      SnapshotDiffReport diffReport) {
+      SnapshotDiffInfo diffReport) {
