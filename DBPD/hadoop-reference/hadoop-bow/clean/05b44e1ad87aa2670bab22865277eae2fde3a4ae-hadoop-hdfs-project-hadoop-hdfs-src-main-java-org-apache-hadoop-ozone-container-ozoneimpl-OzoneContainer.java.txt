HDFS-11108. Ozone: use containers with the state machine. Contributed by Anu Engineer

- * <p/>
+ * <p>
- * <p/>
+ * <p>
-import org.apache.hadoop.hdfs.server.datanode.fsdataset.FsDatasetSpi;
-import org.apache.hadoop.hdfs.server.datanode.fsdataset.FsVolumeSpi;
+import static org.apache.hadoop.hdfs.DFSConfigKeys.DFS_DATANODE_DATA_DIR_KEY;
+
-   * @param dataSet     - FsDataset.
-      Configuration ozoneConfig,
-      FsDatasetSpi<? extends FsVolumeSpi> dataSet) throws Exception {
+      Configuration ozoneConfig) throws IOException {
+    this.ozoneConfig = ozoneConfig;
-      getDataDir(dataSet, locations);
+      getDataDir(locations);
-    this.ozoneConfig = ozoneConfig;
-
-   * @throws Exception
+   *
+   * @throws IOException
-  public void start() throws Exception {
+  public void start() throws IOException {
-   *
-   * Shutdown logic is not very obvious from the following code.
-   * if you need to  modify the logic, please keep these comments in mind.
-   * Here is the shutdown sequence.
-   *
+   * <p>
+   * Shutdown logic is not very obvious from the following code. if you need to
+   * modify the logic, please keep these comments in mind. Here is the shutdown
+   * sequence.
+   * <p>
-   *
+   * <p>
-   *
-   * 3. The container manager lock is a read-write lock with "Fairness" enabled.
-   *
+   * <p>
+   * 3. The container manager lock is a read-write lock with "Fairness"
+   * enabled.
+   * <p>
-   *
+   * <p>
-   *
+   * <p>
-   *
+   * <p>
-   *
+   * <p>
-   *
-   * @param dataset - FSDataset.
+   *
-  private void getDataDir(
-      FsDatasetSpi<? extends FsVolumeSpi> dataset,
-      List<StorageLocation> pathList) throws IOException {
-    FsDatasetSpi.FsVolumeReferences references;
-    try {
-      synchronized (dataset) {
-        references = dataset.getFsVolumeReferences();
-        for (int ndx = 0; ndx < references.size(); ndx++) {
-          FsVolumeSpi vol = references.get(ndx);
-          pathList.add(StorageLocation.parse(vol.getBaseURI().getPath()));
-        }
-        references.close();
-      }
-    } catch (IOException ex) {
-      LOG.error("Unable to get volume paths.", ex);
-      throw new IOException("Internal error", ex);
+  private void getDataDir(List<StorageLocation> pathList) throws IOException {
+    for (String dir : ozoneConfig.getStrings(DFS_DATANODE_DATA_DIR_KEY)) {
+      StorageLocation location = StorageLocation.parse(dir);
+      pathList.add(location);
