MAPREDUCE-4043. Secret keys set in Credentials are not seen by tasks (Jason Lowe via bobby)


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1304587 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.Collection;
-import org.apache.hadoop.security.token.TokenIdentifier;
-  private Collection<Token<? extends TokenIdentifier>> fsTokens;
+  private Credentials credentials;
-      Collection<Token<? extends TokenIdentifier>> fsTokens, Clock clock,
+      Credentials credentials, Clock clock,
-    this.fsTokens = fsTokens;
+    this.credentials = credentials;
-      Collection<Token<? extends TokenIdentifier>> fsTokens) {
+      Credentials credentials) {
-    ByteBuffer tokens = ByteBuffer.wrap(new byte[]{});
+    ByteBuffer taskCredentialsBuffer = ByteBuffer.wrap(new byte[]{});
-      // Setup up tokens
+      // Setup up task credentials buffer
-        // Add file-system tokens
-        for (Token<? extends TokenIdentifier> token : fsTokens) {
-          LOG.info("Putting fs-token for NM use for launching container : "
-              + token.toString());
-          taskCredentials.addToken(token.getService(), token);
-        }
+        LOG.info("Adding #" + credentials.numberOfTokens()
+            + " tokens and #" + credentials.numberOfSecretKeys()
+            + " secret keys for NM use for launching container");
+        taskCredentials.addAll(credentials);
-      tokens = 
+      taskCredentialsBuffer =
-            environment, null, serviceData, tokens, applicationACLs);
+            environment, null, serviceData, taskCredentialsBuffer,
+            applicationACLs);
-      Collection<Token<? extends TokenIdentifier>> fsTokens) {
+      Credentials credentials) {
-            applicationACLs, conf, jobToken, oldJobId, fsTokens);
+            applicationACLs, conf, jobToken, oldJobId, credentials);
-          taskAttempt.fsTokens);
+          taskAttempt.credentials);
