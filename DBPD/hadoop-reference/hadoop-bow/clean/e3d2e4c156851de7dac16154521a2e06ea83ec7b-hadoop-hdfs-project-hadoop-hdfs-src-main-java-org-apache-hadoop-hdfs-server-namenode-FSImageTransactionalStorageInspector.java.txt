HDFS-6000. Avoid saving namespace when starting rolling upgrade. Contributed by Jing Zhao.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535@1571840 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.EnumSet;
+
+import com.google.common.collect.Lists;
-  private final Pattern namePattern;
+  private final List<Pattern> namePatterns = Lists.newArrayList();
-    this(NameNodeFile.IMAGE);
+    this(EnumSet.of(NameNodeFile.IMAGE));
-  FSImageTransactionalStorageInspector(NameNodeFile nnf) {
-    namePattern = Pattern.compile(nnf.getName() + "_(\\d+)");
+  FSImageTransactionalStorageInspector(EnumSet<NameNodeFile> nnfs) {
+    for (NameNodeFile nnf : nnfs) {
+      Pattern pattern = Pattern.compile(nnf.getName() + "_(\\d+)");
+      namePatterns.add(pattern);
+    }
+  }
+
+  private Matcher matchPattern(String name) {
+    for (Pattern p : namePatterns) {
+      Matcher m = p.matcher(name);
+      if (m.matches()) {
+        return m;
+      }
+    }
+    return null;
-      Matcher imageMatch = namePattern.matcher(name);
-      if (imageMatch.matches()) {
+      Matcher imageMatch = this.matchPattern(name);
+      if (imageMatch != null) {
