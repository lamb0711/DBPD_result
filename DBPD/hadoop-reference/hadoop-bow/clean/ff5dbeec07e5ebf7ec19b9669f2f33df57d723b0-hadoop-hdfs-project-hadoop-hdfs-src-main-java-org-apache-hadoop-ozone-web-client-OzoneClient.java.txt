HDFS-11846. Ozone: Fix Http connection leaks in ozone clients. Contributed by Weiwei Yang.

+import com.google.common.annotations.VisibleForTesting;
+import org.apache.hadoop.ozone.OzoneClientUtils;
-import org.apache.http.impl.client.HttpClients;
-
-    try {
-      CloseableHttpClient httpClient = HttpClients.createDefault();
+    HttpPost httpPost = null;
+    try (CloseableHttpClient httpClient = newHttpClient()) {
-      HttpPost httppost = getHttpPost(onBehalfOf, builder.build().toString());
-      executeCreateVolume(httppost, httpClient);
+      httpPost = getHttpPost(onBehalfOf, builder.build().toString());
+      executeCreateVolume(httpPost, httpClient);
+    } finally {
+      OzoneClientUtils.releaseConnection(httpPost);
-    try {
-      CloseableHttpClient httpClient = HttpClients.createDefault();
-
+    HttpGet httpGet = null;
+    try (CloseableHttpClient httpClient = newHttpClient()) {
-      HttpGet httpget = getHttpGet(builder.toString());
-      return executeInfoVolume(httpget, httpClient);
-
+      httpGet = getHttpGet(builder.toString());
+      return executeInfoVolume(httpGet, httpClient);
+    } finally {
+      OzoneClientUtils.releaseConnection(httpGet);
-    try {
-      CloseableHttpClient httpClient = HttpClients.createDefault();
-
+    HttpGet httpGet = null;
+    try (CloseableHttpClient httpClient = newHttpClient()) {
-      HttpGet httpget = getHttpGet(builder.toString());
+      httpGet = getHttpGet(builder.toString());
-        httpget.addHeader(Header.OZONE_USER, onBehalfOf);
+        httpGet.addHeader(Header.OZONE_USER, onBehalfOf);
-      return executeListVolume(httpget, httpClient);
-
+      return executeListVolume(httpGet, httpClient);
+    } finally {
+      OzoneClientUtils.releaseConnection(httpGet);
-    try {
-      CloseableHttpClient httpClient = HttpClients.createDefault();
-
+    HttpGet httpGet = null;
+    try (CloseableHttpClient httpClient = newHttpClient()) {
-      HttpGet httpget = getHttpGet(builder.toString());
-      return executeListVolume(httpget, httpClient);
+      httpGet = getHttpGet(builder.toString());
+      return executeListVolume(httpGet, httpClient);
+    } finally {
+      OzoneClientUtils.releaseConnection(httpGet);
-    try {
-      CloseableHttpClient httpClient = HttpClients.createDefault();
-
+    HttpDelete httpDelete = null;
+    try (CloseableHttpClient httpClient = newHttpClient()) {
-      HttpDelete httpdelete = getHttpDelete(builder.toString());
-      executeDeleteVolume(httpdelete, httpClient);
+      httpDelete = getHttpDelete(builder.toString());
+      executeDeleteVolume(httpDelete, httpClient);
+    } finally {
+      OzoneClientUtils.releaseConnection(httpDelete);
-
+    HttpPut putRequest = null;
-    try {
-      CloseableHttpClient httpClient = HttpClients.createDefault();
-
+    try (CloseableHttpClient httpClient = newHttpClient()) {
-      HttpPut putRequest = getHttpPut(builder.toString());
+      putRequest = getHttpPut(builder.toString());
+    } finally {
+      OzoneClientUtils.releaseConnection(putRequest);
-    try {
-      CloseableHttpClient httpClient = HttpClients.createDefault();
-
+    HttpPut putRequest = null;
+    try (CloseableHttpClient httpClient = newHttpClient()) {
-      HttpPut putRequest = getHttpPut(builder.toString());
+      putRequest = getHttpPut(builder.toString());
+    } finally {
+      OzoneClientUtils.releaseConnection(putRequest);
-      CloseableHttpClient httpClient)
+      final CloseableHttpClient httpClient)
-      CloseableHttpClient httpClient)
+      final CloseableHttpClient httpClient)
-      CloseableHttpClient httpClient)
+      final CloseableHttpClient httpClient)
-      CloseableHttpClient httpClient)
+      final CloseableHttpClient httpClient)
-      CloseableHttpClient httpClient)
+      final CloseableHttpClient httpClient)
-    HttpPost httppost = new HttpPost(uriString);
-    addOzoneHeaders(httppost);
+    HttpPost httpPost = new HttpPost(uriString);
+    addOzoneHeaders(httpPost);
-      httppost.addHeader(Header.OZONE_USER, onBehalfOf);
+      httpPost.addHeader(Header.OZONE_USER, onBehalfOf);
-    return httppost;
+    return httpPost;
-    HttpGet httpget = new HttpGet(uriString);
-    addOzoneHeaders(httpget);
-    return httpget;
+    HttpGet httpGet = new HttpGet(uriString);
+    addOzoneHeaders(httpGet);
+    return httpGet;
+
+  @VisibleForTesting
+  public CloseableHttpClient newHttpClient() {
+    return OzoneClientUtils.newHttpClient();
+  }
