Merge branch 'trunk' into HADOOP-12756

+    boolean needShutdown = false;
-        shutdownExecutor();
+        scheduler.shutdown();
+        needShutdown = true;
+    // no need to hold lock while shutting down executor.
+    if (needShutdown) {
+      shutdownExecutor();
+    }
-    scheduler.shutdown();
+    boolean needShutdown = false;
-        this.blockMover.setExitFlag();
-        shutdownExecutor();
+        this.blockMover.setExitFlag();
+        scheduler.shutdown();
+        needShutdown = true;
+    // no need to hold lock while shutting down executor.
+    if (needShutdown) {
+      shutdownExecutor();
+    }
-                planFile, planID);
-        try {
-          for (Map.Entry<VolumePair, DiskBalancerWorkItem> entry :
-              workMap.entrySet()) {
-            blockMover.copyBlocks(entry.getKey(), entry.getValue());
-          }
-        } finally {
-          blockMover.setExitFlag();
+            planFile, planID);
+        for (Map.Entry<VolumePair, DiskBalancerWorkItem> entry :
+            workMap.entrySet()) {
+          blockMover.setRunnable();
+          blockMover.copyBlocks(entry.getKey(), entry.getValue());
-        LOG.info("Maximum error count exceeded. Error count: {} Max error:{} "
-            , item.getErrorCount(), item.getMaxDiskErrors());
+        LOG.info("Maximum error count exceeded. Error count: {} Max error:{} ",
+            item.getErrorCount(), item.getMaxDiskErrors());
-              break;
+              this.setExitFlag();
+              continue;
-              break;
+              this.setExitFlag();
+              continue;
-              break;
+              this.setExitFlag();
+              continue;
-              break;
+              continue;
-              break;
+              this.setExitFlag();
+              continue;
