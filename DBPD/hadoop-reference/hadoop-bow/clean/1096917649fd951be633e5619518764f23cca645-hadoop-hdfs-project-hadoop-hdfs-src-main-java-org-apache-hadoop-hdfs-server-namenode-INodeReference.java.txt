HDFS-4611. Update FSImage for INodeReference.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1463332 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.PrintWriter;
+
+import com.google.common.base.Preconditions;
+
-  INodeReference(INode referred) {
-    super(referred.getParent());
+  public INodeReference(INode parent, INode referred) {
+    super(parent);
-
-    referred.setParentReference(this);
-    return referred.recordModification(latest);
+    referred.recordModification(latest);
+    // reference is never replaced 
+    return this;
-    referred.clear();
+  @Override
+  public void dumpTreeRecursively(PrintWriter out, StringBuilder prefix,
+      final Snapshot snapshot) {
+    super.dumpTreeRecursively(out, prefix, snapshot);
+    if (this instanceof WithCount) {
+      out.print(", count=" + ((WithCount)this).getReferenceCount());
+    }
+    out.println();
+    
+    final StringBuilder b = new StringBuilder();
+    for(int i = 0; i < prefix.length(); i++) {
+      b.append(' ');
+    }
+    b.append("->");
+    getReferredINode().dumpTreeRecursively(out, b, snapshot);
+  }
+
-    private int referenceCount = 0;
+    private int referenceCount = 1;
-    WithCount(INode inode) {
-      super(inode);
+    public WithCount(INodeReference parent, INode referred) {
+      super(parent, referred);
+      Preconditions.checkArgument(!referred.isReference());
+      referred.setParentReference(this);
+    /** @return the reference count. */
+    public int getReferenceCount() {
+      return referenceCount;
+    }
+
+    /** Increment and then return the reference count. */
+    /** Decrement and then return the reference count. */
-    public WithName(WithCount referred, byte[] name) {
-      super(referred);
+    public WithName(INodeDirectory parent, WithCount referred, byte[] name) {
+      super(parent, referred);
