HDDS-662. Introduce ContainerReplicaState in StorageContainerManager. Contributed by Nanda kumar.

-import org.apache.hadoop.hdds.scm.container.common.helpers.ContainerInfo;
-import org.apache.hadoop.hdds.scm.exceptions.SCMException;
-
-
-  private ContainerStateManager containerStateManager;
-
-    this.containerStateManager = containerManager.getStateManager();
-          .processContainerReports(datanodeOrigin, containerReport, false);
+          .processContainerReports(datanodeOrigin, containerReport);
-        containerStateManager
-            .removeContainerReplica(containerID, datanodeOrigin);
+        final ContainerReplica replica = ContainerReplica.newBuilder()
+            .setContainerID(containerID)
+            .setDatanodeDetails(datanodeOrigin)
+            .build();
+        containerManager
+            .removeContainerReplica(containerID, replica);
-        containerStateManager.addContainerReplica(containerID, datanodeOrigin);
+        final ContainerReplica replica = ContainerReplica.newBuilder()
+            .setContainerID(containerID)
+            .setDatanodeDetails(datanodeOrigin)
+            .build();
+        containerManager.updateContainerReplica(containerID, replica);
-      EventPublisher publisher)
-      throws SCMException {
-    ContainerInfo container = containerStateManager.getContainer(containerID);
-
-    if (container == null) {
-      //warning unknown container
+      EventPublisher publisher) {
+    try {
+      ContainerInfo container = containerManager.getContainer(containerID);
+      replicateIfNeeded(container, publisher);
+    } catch (ContainerNotFoundException ex) {
-      return;
-    }
-    if (container.isContainerOpen()) {
-      return;
-    ReplicationRequest replicationState =
-        containerStateManager.checkReplicationState(containerID);
-    if (replicationState != null) {
-      if (replicationStatus.isReplicationEnabled()) {
+  }
+
+  private void replicateIfNeeded(ContainerInfo container,
+      EventPublisher publisher) throws ContainerNotFoundException {
+    if (!container.isOpen() && replicationStatus.isReplicationEnabled()) {
+      final int existingReplicas = containerManager
+          .getContainerReplicas(container.containerID()).size();
+      final int expectedReplicas = container.getReplicationFactor().getNumber();
+      if (existingReplicas != expectedReplicas) {
-            replicationState);
-      } else {
-        LOG.warn(
-            "Over/under replicated container but the replication is not "
-                + "(yet) enabled: "
-                + replicationState.toString());
+            new ReplicationRequest(container.getContainerID(),
+                existingReplicas, expectedReplicas));
-
