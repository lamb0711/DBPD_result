HDDS-1672. Improve locking in OzoneManager. (#1016)



+import static org.apache.hadoop.ozone.om.lock.OzoneManagerLock.Resource.VOLUME_LOCK;
+
+    boolean acquiredUserLocks = false;
-    omMetadataManager.getLock().acquireUserLock(newOwner);
-    omMetadataManager.getLock().acquireVolumeLock(volume);
-
-    boolean needToreleaseOldOwnerLock = false;
+    omMetadataManager.getLock().acquireLock(VOLUME_LOCK, volume);
+      acquiredUserLocks =
+          omMetadataManager.getLock().acquireMultiUserLock(newOwner, oldOwner);
-      // Release and reacquire lock for now it will not be a problem, as
-      // applyTransaction serializes the operation's.
-      // TODO: Revisit this logic once HDDS-1672 checks in.
-
-      // releasing volume lock, as to acquire user lock we need to release
-      // volume lock.
-      omMetadataManager.getLock().releaseVolumeLock(volume);
-      omMetadataManager.getLock().acquireUserLock(oldOwner);
-      omMetadataManager.getLock().acquireVolumeLock(volume);
-
-      needToreleaseOldOwnerLock = true;
-
-      omMetadataManager.getLock().releaseVolumeLock(volume);
-      omMetadataManager.getLock().releaseUserLock(newOwner);
-      if (needToreleaseOldOwnerLock) {
-        omMetadataManager.getLock().releaseUserLock(oldOwner);
+      if (acquiredUserLocks) {
+        omMetadataManager.getLock().releaseMultiUserLock(newOwner, oldOwner);
+      omMetadataManager.getLock().acquireLock(VOLUME_LOCK, volume);
