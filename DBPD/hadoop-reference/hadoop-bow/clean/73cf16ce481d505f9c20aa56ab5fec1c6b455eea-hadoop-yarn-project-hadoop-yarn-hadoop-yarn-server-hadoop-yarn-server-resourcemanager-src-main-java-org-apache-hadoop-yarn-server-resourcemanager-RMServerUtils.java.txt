Merging r1536573 through r1536889 from trunk to branch HDFS-2832

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2832@1536890 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.IOException;
+import org.apache.commons.logging.Log;
+import org.apache.hadoop.security.AccessControlException;
+import org.apache.hadoop.security.UserGroupInformation;
+import org.apache.hadoop.security.authorize.AccessControlList;
-import org.apache.hadoop.yarn.api.records.YarnApplicationState;
-import org.apache.hadoop.yarn.exceptions.YarnRuntimeException;
-import org.apache.hadoop.yarn.server.resourcemanager.rmapp.RMAppState;
+
+  /**
+   * Utility method to verify if the current user has access based on the
+   * passed {@link AccessControlList}
+   * @param acl the {@link AccessControlList} to check against
+   * @param method the method name to be logged
+   * @param LOG the logger to use
+   * @return {@link UserGroupInformation} of the current user
+   * @throws IOException
+   */
+  public static UserGroupInformation verifyAccess(
+      AccessControlList acl, String method, final Log LOG)
+      throws IOException {
+    UserGroupInformation user;
+    try {
+      user = UserGroupInformation.getCurrentUser();
+    } catch (IOException ioe) {
+      LOG.warn("Couldn't get current user", ioe);
+      RMAuditLogger.logFailure("UNKNOWN", method, acl.toString(),
+          "AdminService", "Couldn't get current user");
+      throw ioe;
+    }
+
+    if (!acl.isUserAllowed(user)) {
+      LOG.warn("User " + user.getShortUserName() + " doesn't have permission" +
+          " to call '" + method + "'");
+
+      RMAuditLogger.logFailure(user.getShortUserName(), method,
+          acl.toString(), "AdminService",
+          RMAuditLogger.AuditConstants.UNAUTHORIZED_USER);
+
+      throw new AccessControlException("User " + user.getShortUserName() +
+              " doesn't have permission" +
+              " to call '" + method + "'");
+    }
+    if (LOG.isTraceEnabled()) {
+      LOG.trace(method + " invoked by user " + user.getShortUserName());
+    }
+    return user;
+  }
