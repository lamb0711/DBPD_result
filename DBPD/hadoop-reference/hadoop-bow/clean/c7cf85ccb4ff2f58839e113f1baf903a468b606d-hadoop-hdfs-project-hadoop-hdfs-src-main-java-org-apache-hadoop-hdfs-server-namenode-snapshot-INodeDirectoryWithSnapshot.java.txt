HDFS-4507. Update quota verification for snapshots.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1451081 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.protocol.NSQuotaExceededException;
+import org.apache.hadoop.hdfs.server.namenode.Quota;
-        currentINode.removeChild(c, null);
+        currentINode.removeChild(c);
-      copy.setChildren(null);
+      copy.clearChildren();
-  public INodeDirectoryWithSnapshot recordModification(final Snapshot latest) {
+  public INodeDirectoryWithSnapshot recordModification(final Snapshot latest)
+      throws NSQuotaExceededException {
-      final Snapshot latest, final INodeDirectory snapshotCopy) {
+      final Snapshot latest, final INodeDirectory snapshotCopy)
+          throws NSQuotaExceededException {
-      final INode snapshotCopy) {
+      final INode snapshotCopy) throws NSQuotaExceededException {
-  public boolean addChild(INode inode, boolean setModTime, Snapshot latest) {
+  public boolean addChild(INode inode, boolean setModTime, Snapshot latest)
+      throws NSQuotaExceededException {
-  public boolean removeChild(INode child, Snapshot latest) {
+  public boolean removeChild(INode child, Snapshot latest)
+      throws NSQuotaExceededException {
-      final BlocksMapUpdateInfo collectedBlocks) {
+      final BlocksMapUpdateInfo collectedBlocks)
+          throws NSQuotaExceededException {
-    diffs.clear();
+    total += diffs.clear();
+  public Quota.Counts computeQuotaUsage4CurrentDirectory(Quota.Counts counts) {
+    super.computeQuotaUsage4CurrentDirectory(counts);
+
+    for(DirectoryDiff d : diffs) {
+      for(INode deleted : d.getChildrenDiff().getDeletedList()) {
+        deleted.computeQuotaUsage(counts, false);
+      }
+    }
+    counts.add(Quota.NAMESPACE, diffs.asList().size());
+    return counts;
+  }
+
+  @Override
