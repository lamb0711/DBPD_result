HDFS-5966. Fix rollback of rolling upgrade in NameNode HA setup.  Contributed by jing9


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535@1569885 13f79535-47bb-0310-9956-ffa450edef68

+    final String digestString = StringUtils.byteToHexString(digest.getDigest());
+    saveMD5File(dataFile, digestString);
+  }
+
+  private static void saveMD5File(File dataFile, String digestString)
+      throws IOException {
-    String digestString = StringUtils.byteToHexString(
-        digest.getDigest());
-    
+
-    LOG.debug("Saved MD5 " + digest + " to " + md5File);
+
+    if (LOG.isDebugEnabled()) {
+      LOG.debug("Saved MD5 " + digestString + " to " + md5File);
+    }
+  }
+
+  public static void renameMD5File(File oldDataFile, File newDataFile)
+      throws IOException {
+    File fromFile = getDigestFileForFile(oldDataFile);
+    BufferedReader in = null;
+    final String digestString;
+    try {
+      in = new BufferedReader(new InputStreamReader(new FileInputStream(
+          fromFile), Charsets.UTF_8));
+      String line = in.readLine();
+      String[] split = line.split(" \\*");
+      digestString = split[0];
+    } finally {
+      IOUtils.cleanup(LOG, in);
+    }
+
+    saveMD5File(newDataFile, digestString);
+
+    if (!fromFile.delete()) {
+      LOG.warn("deleting  " + fromFile.getAbsolutePath() + " FAILED");
+    }
