HDFS-13665. [SBN read] Move RPC response serialization into Server.doResponse(). Contributed by Plamen Jeliazkov.
-    private RpcResponseHeaderProto bufferedHeader; // the response header
-    private Writable bufferedRv;                   // the byte response
+    private ResponseParams responseParams; // the response params
+    private Writable rv;                   // the byte response
-      this.bufferedRv = call.bufferedRv;
-      this.bufferedHeader = call.bufferedHeader;
+      this.rv = call.rv;
+      this.responseParams = call.responseParams;
-    public void setBufferedHeader(RpcResponseHeaderProto header) {
-      this.bufferedHeader = header;
-    }
-
-    public void setBufferedRv(Writable rv) {
-      this.bufferedRv = rv;
+    void setResponseFields(Writable returnValue,
+                           ResponseParams responseParams) {
+      this.rv = returnValue;
+      this.responseParams = responseParams;
-        setupResponse(this, responseParams.returnStatus,
-            responseParams.detailedErr,
-            value, responseParams.errorClass, responseParams.error);
+        setResponseFields(value, responseParams);
-      } else if (alignmentContext != null) {
-        // rebuild response with state context in header
-        RpcResponseHeaderProto.Builder responseHeader =
-            call.bufferedHeader.toBuilder();
-        alignmentContext.updateResponseState(responseHeader);
-        RpcResponseHeaderProto builtHeader = responseHeader.build();
-        setupResponse(call, builtHeader, call.bufferedRv);
+      } else {
+        setupResponse(call, call.responseParams.returnStatus,
+            call.responseParams.detailedErr, call.rv,
+            call.responseParams.errorClass,
+            call.responseParams.error);
+    if (alignmentContext != null) {
+      alignmentContext.updateResponseState(headerBuilder);
+    }
-    if (alignmentContext != null && call.bufferedHeader == null
-        && call.bufferedRv == null) {
-      call.setBufferedHeader(header);
-      call.setBufferedRv(rv);
-    }
-
