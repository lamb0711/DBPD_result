MAPREDUCE-3960. Fix web-proxy to forward request to AM with configured hostname or IP. Contributed by Thomas Graves. 


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1296878 13f79535-47bb-0310-9956-ffa450edef68

+import java.net.InetAddress;
+import org.apache.commons.httpclient.HostConfiguration;
-      HttpServletResponse resp, URI link,Cookie c) throws IOException {
+      HttpServletResponse resp, URI link, Cookie c, String proxyHost)
+      throws IOException {
+    // Make sure we send the request from the proxy address in the config
+    // since that is what the AM filter checks against. IP aliasing or
+    // similar could cause issues otherwise.
+    HostConfiguration config = new HostConfiguration();
+    InetAddress localAddress = InetAddress.getByName(proxyHost);
+    if (LOG.isDebugEnabled()) {
+      LOG.debug("local InetAddress for proxy host: " + localAddress.toString());
+    }
+    config.setLocalAddress(localAddress);
-      resp.setStatus(client.executeMethod(method));
+      resp.setStatus(client.executeMethod(config, method));
+  private String getProxyHost() throws IOException {
+    return ((String) getServletContext()
+        .getAttribute(WebAppProxy.PROXY_HOST_ATTRIBUTE));
+  }
+  
-      proxyLink(req, resp, toFetch, c);
+      proxyLink(req, resp, toFetch, c, getProxyHost());
