HDFS-2709. Appropriately handle error conditions in EditLogTailer. Contributed by Aaron T. Myers.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1228390 13f79535-47bb-0310-9956-ffa450edef68

-                           FSNamesystem target) throws IOException {
+      FSNamesystem target) throws IOException, EditLogInputException {
-    int numLoaded = 0;
+    long numLoaded = 0;
-        int thisNumLoaded = loader.loadFSEdits(editIn, startingTxId);
-        lastAppliedTxId = startingTxId + thisNumLoaded - 1;
-        startingTxId += thisNumLoaded;
-        numLoaded += thisNumLoaded;
+        long thisNumLoaded = 0;
+        try {
+          thisNumLoaded = loader.loadFSEdits(editIn, startingTxId);
+        } catch (EditLogInputException elie) {
+          thisNumLoaded = elie.getNumEditsLoaded();
+          throw elie;
+        } finally {
+          // Update lastAppliedTxId even in case of error, since some ops may
+          // have been successfully applied before the error.
+          lastAppliedTxId = startingTxId + thisNumLoaded - 1;
+          startingTxId += thisNumLoaded;
+          numLoaded += thisNumLoaded;
+        }
-      // TODO(HA): Should this happen when called by the tailer?
+      // update the counts
+      // TODO(HA): this may be very slow -- we probably want to
+      // update them as we go for HA.
+      target.dir.updateCountForINodeWithQuota();   
-
-    // update the counts
-    // TODO(HA): this may be very slow -- we probably want to
-    // update them as we go for HA.
-    target.dir.updateCountForINodeWithQuota();    
+    
