HDFS-5557. Write pipeline recovery for the last packet in the block may cause rejection of valid replicas. Contributed by Kihwal Lee.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1547173 13f79535-47bb-0310-9956-ffa450edef68

+    // Set the generation stamp for the block.
+    setGenerationStamp(genStamp);
-            + "from location: " + r);
+            + "from location: " + r.getExpectedLocation());
-
-    // Set the generation stamp for the block.
-    setGenerationStamp(genStamp);
+    // Sort out invalid replicas.
+    setGenerationStampAndVerifyReplicas(block.getGenerationStamp());
