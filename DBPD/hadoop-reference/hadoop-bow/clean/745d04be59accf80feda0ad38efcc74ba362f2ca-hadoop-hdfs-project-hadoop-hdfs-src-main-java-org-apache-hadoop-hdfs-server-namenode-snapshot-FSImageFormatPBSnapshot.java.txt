HDFS-8823. Move replication factor into individual blocks. Contributed by Haohui Mai.

+import org.apache.hadoop.hdfs.server.blockmanagement.BlockManager;
+      final BlockManager bm = fsn.getBlockManager();
-          BlockInfo storedBlock =  fsn.getBlockManager().getStoredBlock(blk);
+          BlockInfo storedBlock = bm.getStoredBlock(blk);
-            storedBlock = fsn.getBlockManager().addBlockCollection(
+            storedBlock = bm.addBlockCollection(
+      short repl = file.getPreferredBlockReplication();
+      for (BlockInfo b : file.getBlocks()) {
+        if (b.getReplication() < repl) {
+          bm.setReplication(b.getReplication(), repl, b);
+        }
+      }
