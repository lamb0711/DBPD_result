HDFS-4103. Support O(1) snapshot creation.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1424782 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.server.namenode.INodeDirectory.INodesInPath;
-      INodeFile oldFile = getINodeFile(fsDir, addCloseOp.path);
+      final INodesInPath iip = fsDir.getINodesInPath(addCloseOp.path);
+      final INodeFile oldFile = toINodeFile(iip.getINode(0), addCloseOp.path);
-              false);
+              false, iip.getLatestSnapshot());
-      newFile.setAccessTime(addCloseOp.atime);
-      newFile.setModificationTime(addCloseOp.mtime);
+      newFile.setAccessTime(addCloseOp.atime, null);
+      newFile.setModificationTime(addCloseOp.mtime, null);
-      INodeFile oldFile = getINodeFile(fsDir, addCloseOp.path);
+      final INodesInPath iip = fsDir.getINodesInPath(addCloseOp.path);
+      final INodeFile oldFile = toINodeFile(iip.getINode(0), addCloseOp.path);
-      oldFile.setAccessTime(addCloseOp.atime);
-      oldFile.setModificationTime(addCloseOp.mtime);
+      oldFile.setAccessTime(addCloseOp.atime, null);
+      oldFile.setModificationTime(addCloseOp.mtime, null);
-        fsDir.unprotectedReplaceINodeFile(addCloseOp.path, ucFile, newFile);
+        fsDir.unprotectedReplaceINodeFile(addCloseOp.path, ucFile, newFile,
+            iip.getLatestSnapshot());
-    INode inode = fsDir.getINode(path);
+    return toINodeFile(fsDir.getINode(path), path);
+  }
+
+  private static INodeFile toINodeFile(INode inode, String path)
+      throws IOException {
