Merge trunk to branch.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/fs-encryption@1608603 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.yarn.util.resource.Resources;
-          submissionContext, conf, maxAppAttempts == attempts.size());
+          submissionContext, conf,
+          // The newly created attempt maybe last attempt if (number of
+          // previously failed attempts(which should not include Preempted,
+          // hardware error and NM resync) + 1) equal to the max-attempt
+          // limit.
+          maxAppAttempts == (getNumFailedAppAttempts() + 1));
-                  && app.attempts.size() == app.maxAppAttempts))) {
+                  && app.getNumFailedAppAttempts() == app.maxAppAttempts))) {
-    } else if (this.attempts.size() >= this.maxAppAttempts) {
+    } else if (getNumFailedAppAttempts() >= this.maxAppAttempts) {
+  private int getNumFailedAppAttempts() {
+    int completedAttempts = 0;
+    // Do not count AM preemption, hardware failures or NM resync
+    // as attempt failure.
+    for (RMAppAttempt attempt : attempts.values()) {
+      if (attempt.shouldCountTowardsMaxAttemptRetry()) {
+        completedAttempts++;
+      }
+    }
+    return completedAttempts;
+  }
+
+
-          && app.attempts.size() < app.maxAppAttempts) {
+          && app.getNumFailedAppAttempts() < app.maxAppAttempts) {
