HDFS-5614. NameNode: implement handling of ACLs in combination with snapshots. Contributed by Chris Nauroth.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-4685@1563304 13f79535-47bb-0310-9956-ffa450edef68

-      AclFeature aclFeature = loadAclFeature(in, imgVersion);
-      if (aclFeature != null) {
-        file.addAclFeature(aclFeature);
+      if (permissions.getPermission().getAclBit()) {
+        AclFeature aclFeature = loadAclFeature(in, imgVersion);
+        if (aclFeature != null) {
+          file.addAclFeature(aclFeature);
+        }
-      AclFeature aclFeature = loadAclFeature(in, imgVersion);
-      if (aclFeature != null) {
-        dir.addAclFeature(aclFeature);
+      if (permissions.getPermission().getAclBit()) {
+        AclFeature aclFeature = loadAclFeature(in, imgVersion);
+        if (aclFeature != null) {
+          dir.addAclFeature(aclFeature);
+        }
-        aclFeature = new AclFeature();
-        aclFeature.setEntries(PBHelper.convertAclEntry(p.getEntriesList()));
+        aclFeature = new AclFeature(PBHelper.convertAclEntry(
+            p.getEntriesList()));
-      
-      return new INodeFileAttributes.SnapshotCopy(name, permissions, modificationTime,
-          accessTime, replication, preferredBlockSize);
+      AclFeature aclFeature = permissions.getPermission().getAclBit() ?
+          loadAclFeature(in, layoutVersion) : null;
+      return new INodeFileAttributes.SnapshotCopy(name, permissions, aclFeature,
+          modificationTime, accessTime, replication, preferredBlockSize);
+      AclFeature aclFeature = permissions.getPermission().getAclBit() ?
+          loadAclFeature(in, layoutVersion) : null;
-          new INodeDirectoryAttributes.SnapshotCopy(name, permissions, modificationTime)
+          new INodeDirectoryAttributes.SnapshotCopy(name, permissions,
+            aclFeature, modificationTime)
-            modificationTime, nsQuota, dsQuota);
+            aclFeature, modificationTime, nsQuota, dsQuota);
