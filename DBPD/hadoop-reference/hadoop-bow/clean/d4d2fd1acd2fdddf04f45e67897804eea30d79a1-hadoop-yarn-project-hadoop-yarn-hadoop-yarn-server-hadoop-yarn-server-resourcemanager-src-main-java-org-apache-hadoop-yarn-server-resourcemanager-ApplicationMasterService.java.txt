YARN-2037. Add work preserving restart support for Unmanaged AMs. (Botong Huang via Subru).

+import org.apache.hadoop.yarn.api.records.ApplicationSubmissionContext;
-import org.apache.hadoop.yarn.server.resourcemanager.security
-    .AMRMTokenSecretManager;
+import org.apache.hadoop.yarn.server.resourcemanager.security.AMRMTokenSecretManager;
-        String message = AMRMClientUtils.APP_ALREADY_REGISTERED_MESSAGE + appID;
-        LOG.warn(message);
-        RMAuditLogger.logFailure(
-          this.rmContext.getRMApps()
-            .get(appID).getUser(),
-          AuditConstants.REGISTER_AM, "", "ApplicationMasterService", message,
-          appID, applicationAttemptId);
-        throw new InvalidApplicationMasterRequestException(message);
+        // allow UAM re-register if work preservation is enabled
+        ApplicationSubmissionContext appContext =
+            rmContext.getRMApps().get(appID).getApplicationSubmissionContext();
+        if (!(appContext.getUnmanagedAM()
+            && appContext.getKeepContainersAcrossApplicationAttempts())) {
+          String message =
+              AMRMClientUtils.APP_ALREADY_REGISTERED_MESSAGE + appID;
+          LOG.warn(message);
+          RMAuditLogger.logFailure(
+              this.rmContext.getRMApps().get(appID).getUser(),
+              AuditConstants.REGISTER_AM, "", "ApplicationMasterService",
+              message, appID, applicationAttemptId);
+          throw new InvalidApplicationMasterRequestException(message);
+        }
