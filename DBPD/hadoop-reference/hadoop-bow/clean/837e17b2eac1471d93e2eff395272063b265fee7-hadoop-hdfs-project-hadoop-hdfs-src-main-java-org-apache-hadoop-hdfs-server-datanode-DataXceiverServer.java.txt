svn merge -c -1430507 . for reverting HDFS-4353. Encapsulate connections to peers in Peer and PeerServer classes


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1430662 13f79535-47bb-0310-9956-ffa450edef68

+import java.net.ServerSocket;
+import java.net.Socket;
+import java.util.Collections;
+import java.util.Iterator;
-import org.apache.hadoop.hdfs.net.Peer;
-import org.apache.hadoop.hdfs.net.PeerServer;
-  private final PeerServer peerServer;
-  private final DataNode datanode;
-  private final Set<Peer> peers = new HashSet<Peer>();
+  ServerSocket ss;
+  DataNode datanode;
+  // Record all sockets opened for data transfer
+  Set<Socket> childSockets = Collections.synchronizedSet(
+                                       new HashSet<Socket>());
-  DataXceiverServer(PeerServer peerServer, Configuration conf,
+  DataXceiverServer(ServerSocket ss, Configuration conf, 
-    this.peerServer = peerServer;
+    this.ss = ss;
-    Peer peer = null;
+      Socket s = null;
-        peer = peerServer.accept();
+        s = ss.accept();
+        s.setTcpNoDelay(true);
+        // Timeouts are set within DataXceiver.run()
-            DataXceiver.create(peer, datanode, this))
+            DataXceiver.create(s, datanode, this))
-        IOUtils.cleanup(null, peer);
+        IOUtils.closeSocket(s);
-        IOUtils.cleanup(null, peer);
+        IOUtils.closeSocket(s);
-    synchronized (this) {
-      for (Peer p : peers) {
-        IOUtils.cleanup(LOG, p);
-      }
-    }
-      peerServer.close();
+      ss.close();
-
+  
-      this.peerServer.close();
+      this.ss.close();
-  }
-  
-  synchronized void addPeer(Peer peer) {
-    peers.add(peer);
-  }
-  synchronized void closePeer(Peer peer) {
-    peers.remove(peer);
-    IOUtils.cleanup(null, peer);
+    // close all the sockets that were accepted earlier
+    synchronized (childSockets) {
+      for (Iterator<Socket> it = childSockets.iterator();
+           it.hasNext();) {
+        Socket thissock = it.next();
+        try {
+          thissock.close();
+        } catch (IOException e) {
+        }
+      }
+    }
