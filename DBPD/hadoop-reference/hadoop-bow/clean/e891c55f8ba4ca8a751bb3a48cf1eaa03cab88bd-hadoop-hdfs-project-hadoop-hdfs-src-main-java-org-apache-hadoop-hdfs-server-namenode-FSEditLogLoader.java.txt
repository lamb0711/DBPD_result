HDFS-5963. TestRollingUpgrade#testSecondaryNameNode causes subsequent tests to fail. (Contributed by szetszwo)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535@1569993 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.hdfs.protocol.RollingUpgradeException;
-      boolean started = false;
-        } else if (rollingUpgradeOpt == RollingUpgradeStartupOption.STARTED) {
-          started = true;
-      if (started || fsNamesys.isInStandbyState()) {
-        if (totalEdits > 1) {
-          // save namespace if this is not the second edit transaction
-          // (the first must be OP_START_LOG_SEGMENT)
-          fsNamesys.getFSImage().saveNamespace(fsNamesys,
-              NameNodeFile.IMAGE_ROLLBACK, null);
-        }
-        //rolling upgrade is already started, set info
-        final RollingUpgradeOp upgradeOp = (RollingUpgradeOp)op; 
-        fsNamesys.setRollingUpgradeInfo(upgradeOp.getTime());
-        break;
-      }
-
-      throw new RollingUpgradeException(
-          "Unexpected OP_ROLLING_UPGRADE_START in edit log: op=" + op);
+      // save namespace if this is not the second edit transaction
+      // (the first must be OP_START_LOG_SEGMENT)
+      final boolean saveNamespace = totalEdits > 1;
+      final long startTime = ((RollingUpgradeOp) op).getTime();
+      fsNamesys.startRollingUpgradeInternal(startTime, saveNamespace);
+      break;
-      if (!fsNamesys.isRollingUpgrade()) {
-        throw new RollingUpgradeException(
-            "Unexpected OP_ROLLING_UPGRADE_FINALIZE "
-            + " since there is no rolling upgrade in progress.");
-      }
+      final long finalizeTime = ((RollingUpgradeOp) op).getTime();
+      fsNamesys.finalizeRollingUpgradeInternal(finalizeTime);
