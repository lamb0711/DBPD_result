HADOOP-16801. S3Guard listFiles will not query S3 if all listings are authoritative (#1815). Contributed by Mustafa Ä°man.


+  private final boolean recursivelyAuthoritative;
-    prefetch(meta);
+    this.recursivelyAuthoritative = prefetch(meta);
-  private void prefetch(PathMetadata meta) throws IOException {
+  /**
+   * Walks the listing tree, starting from given metadata path. All
+   * encountered files and empty directories are added to
+   * {@link leafNodesIterator} unless a directory seems to be empty
+   * and at least one of the following conditions hold:
+   * <ul>
+   *   <li>
+   *     The directory listing is not marked authoritative
+   *   </li>
+   *   <li>
+   *     Authoritative mode is not allowed
+   *   </li>
+   * </ul>
+   * @param meta starting point for tree walk
+   * @return {@code true} if all encountered directory listings
+   *          are marked as authoritative
+   * @throws IOException
+   */
+  private boolean prefetch(PathMetadata meta) throws IOException {
+    boolean allListingsAuthoritative = true;
+          if (!rootListing.isAuthoritative()) {
+            allListingsAuthoritative = false;
+          }
+    } else {
+      allListingsAuthoritative = false;
+          if (!children.isAuthoritative()) {
+            allListingsAuthoritative = false;
+          }
+        } else {
+          // we do not have a listing, so directory definitely non-authoritative
+          allListingsAuthoritative = false;
+    return allListingsAuthoritative;
+  public boolean isRecursivelyAuthoritative() {
+    return recursivelyAuthoritative;
+  }
+
