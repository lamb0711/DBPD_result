HDFS-12720. Ozone: Ratis options are not passed from KSM Client protobuf helper correctly. Contributed by Mukul Kumar Singh.

-    .LifeCycleState.ALLOCATED;
-import static org.apache.hadoop.ozone.protocol.proto.OzoneProtos
-      pipeline = findOpenPipeline();
+      Pipeline openPipeline = findOpenPipeline(replicationFactor);
+      if (openPipeline != null) {
+        // if an open pipeline is found use the same machines
+        pipeline = allocateRatisPipeline(openPipeline.getMachines(),
+            containerName, replicationFactor);
+      }
-  Pipeline findOpenPipeline() {
+  Pipeline findOpenPipeline(OzoneProtos.ReplicationFactor factor) {
-      if (temp.getLifeCycleState() == OPEN) {
+      if ((temp.getLifeCycleState() == OPEN) && (temp.getFactor() == factor)) {
-      pipeline.setLifeCycleState(ALLOCATED);
+      pipeline.setLifeCycleState(OPEN);
-        // once a datanode has been added to a pipeline, exclude it from
-        // further allocations
-        ratisMembers.add(datanode);
+          // once a datanode has been added to a pipeline, exclude it from
+          // further allocations
+          ratisMembers.addAll(newNodesList);
