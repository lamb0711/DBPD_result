HDFS-5914. Incorporate ACLs with the changes from HDFS-5698. Contributed by Haohui Mai.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-4685@1566991 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.hdfs.protocol.proto.AclProtos.AclFsImageProto;
-import org.apache.hadoop.hdfs.protocolPB.PBHelper;
-import org.apache.hadoop.hdfs.protocol.LayoutFlags;
- *
- *     fsPermission: short, PermissionStatus,
- *     AclEntries {
- *       size: int,
- *       protobuf encoding of {@link AclFsImageProto}
- *     }(when {@link Feature#EXTENDED_ACL} is supported),
+ *     fsPermission: short, PermissionStatus
- *     fsPermission: short, PermissionStatus,
- *     AclEntries {
- *       size: int,
- *       protobuf encoding of {@link AclFsImageProto}
- *     }(when {@link Feature#EXTENDED_ACL} is supported),
- *   } for INodeFile,
+ *     fsPermission: short, PermissionStatus
+ *   } for INodeFile
+ * }
-
-      if (permissions.getPermission().getAclBit()) {
-        AclFeature aclFeature = loadAclFeature(in, imgVersion);
-        if (aclFeature != null) {
-          file.addAclFeature(aclFeature);
-        }
-      }
-
-      return fileDiffs == null ? file : new INodeFile(file, fileDiffs);
-
-    } else if (numBlocks == -1) {
-      //directory
+        return fileDiffs == null ? file : new INodeFile(file, fileDiffs);
+      } else if (numBlocks == -1) {
+        //directory
-
-      if (permissions.getPermission().getAclBit()) {
-        AclFeature aclFeature = loadAclFeature(in, imgVersion);
-        if (aclFeature != null) {
-          dir.addAclFeature(aclFeature);
-        }
-      }
-
-    private AclFeature loadAclFeature(DataInput in, final int imgVersion)
-        throws IOException {
-      namesystem.getAclConfigFlag().checkForFsImage();
-      AclFeature aclFeature = null;
-      if (LayoutVersion.supports(Feature.EXTENDED_ACL, imgVersion)) {
-        AclFsImageProto p = AclFsImageProto
-            .parseDelimitedFrom((DataInputStream) in);
-        aclFeature = new AclFeature(PBHelper.convertAclEntry(
-            p.getEntriesList()));
-      }
-      return aclFeature;
-    }
-
-      AclFeature aclFeature = permissions.getPermission().getAclBit() ?
-          loadAclFeature(in, layoutVersion) : null;
-      return new INodeFileAttributes.SnapshotCopy(name, permissions, aclFeature,
-          modificationTime, accessTime, replication, preferredBlockSize);
+
+      return new INodeFileAttributes.SnapshotCopy(name, permissions, null, modificationTime,
+          accessTime, replication, preferredBlockSize);
-      AclFeature aclFeature = permissions.getPermission().getAclBit() ?
-          loadAclFeature(in, layoutVersion) : null;
-          new INodeDirectoryAttributes.SnapshotCopy(name, permissions,
-            aclFeature, modificationTime)
+          new INodeDirectoryAttributes.SnapshotCopy(name, permissions, null, modificationTime)
-            aclFeature, modificationTime, nsQuota, dsQuota);
+            null, modificationTime, nsQuota, dsQuota);
