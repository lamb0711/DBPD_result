HADOOP-16433. S3Guard: Filter expired entries and tombstones when listing with MetadataStore.listChildren().

Contributed by Gabor Bota.

This pulls the tracking of the lastUpdated timestamp of metadata entries up from the DDB metastore into all s3guard stores, and then uses this to filter out expired tombstones from listings.

Change-Id: I80f121236b49c75a024116f65a3ef29d3580b462

-    doDelete(p, false, true, ttlTimeProvider);
+    doDelete(p, false, true);
-    doDelete(p, false, false, null);
+    doDelete(p, false, false);
-    doDelete(path, true, true, ttlTimeProvider);
+    doDelete(path, true, true);
-      boolean tombstone, ITtlTimeProvider ttlTp) {
+      boolean tombstone) {
-
-    deleteCacheEntries(path, tombstone, ttlTp);
+    deleteCacheEntries(path, tombstone);
-      deleteEntryByAncestor(path, localCache, tombstone, ttlTp);
+      deleteEntryByAncestor(path, localCache, tombstone, ttlTimeProvider);
-    // Make a copy so callers can mutate without affecting our state
-    return listing == null ? null : new DirListingMetadata(listing);
+
+    if (listing != null) {
+      listing.removeExpiredEntriesFromListing(
+          ttlTimeProvider.getMetadataTtl(), ttlTimeProvider.getNow());
+      LOG.debug("listChildren [after removing expired entries] ({}) -> {}",
+          path, listing.prettyPrint());
+      // Make a copy so callers can mutate without affecting our state
+      return new DirListingMetadata(listing);
+    }
+    return null;
+          parentDirMeta.setLastUpdated(meta.getLastUpdated());
-        // Add the child status to the listing
-        parentMeta.getDirListingMeta().put(status);
+        // Add the child pathMetadata to the listing
+        parentMeta.getDirListingMeta().put(meta);
-          parentMeta.getDirListingMeta().markDeleted(path);
+          parentMeta.getDirListingMeta().markDeleted(path,
+              ttlTimeProvider.getNow());
-            final PathMetadata pmTombstone = PathMetadata.tombstone(path);
-            pmTombstone.setLastUpdated(ttlTimeProvider.getNow());
+            final PathMetadata pmTombstone = PathMetadata.tombstone(path,
+                ttlTimeProvider.getNow());
-  private void deleteCacheEntries(Path path, boolean tombstone,
-      ITtlTimeProvider ttlTp) {
+  private void deleteCacheEntries(Path path, boolean tombstone) {
-        PathMetadata pmd = PathMetadata.tombstone(path);
-        pmd.setLastUpdated(ttlTp.getNow());
+        PathMetadata pmd = PathMetadata.tombstone(path,
+            ttlTimeProvider.getNow());
-          dir.markDeleted(path);
-          dir.setLastUpdated(ttlTp.getNow());
+          dir.markDeleted(path, ttlTimeProvider.getNow());
-        PathMetadata meta = new PathMetadata(status, Tristate.FALSE, false);
+        PathMetadata meta = new PathMetadata(status, Tristate.FALSE, false,
+            ttlTimeProvider.getNow());
