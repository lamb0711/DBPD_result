HDFS-2991. Fix case where OP_ADD would not be logged in append(). Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1295214 13f79535-47bb-0310-9956-ffa450edef68

-                assert oldFile.isUnderConstruction() : 
-                  "File is not under construction: " + addCloseOp.path;
+                if (!oldFile.isUnderConstruction() &&
+                    logVersion <= LayoutVersion.BUGFIX_HDFS_2991_VERSION) {
+                  // There was a bug (HDFS-2991) in hadoop < 0.23.1 where OP_CLOSE
+                  // could show up twice in a row. But after that version, this
+                  // should be fixed, so we should treat it as an error.
+                  throw new IOException(
+                      "File is not under construction: " + addCloseOp.path);
+                }
-                INodeFile newFile =
-                  ((INodeFileUnderConstruction)oldFile).convertToInodeFile();
-                fsDir.replaceNode(addCloseOp.path, oldFile, newFile);
+                
+                if (oldFile.isUnderConstruction()) {
+                  INodeFile newFile =
+                    ((INodeFileUnderConstruction)oldFile).convertToInodeFile();
+                  fsDir.replaceNode(addCloseOp.path, oldFile, newFile);
+                }
-              fsNamesys.leaseManager.removeLease(
-                  ((INodeFileUnderConstruction)oldFile).getClientName(), addCloseOp.path);
+              if (oldFile.isUnderConstruction()) {
+                fsNamesys.leaseManager.removeLease(
+                    ((INodeFileUnderConstruction)oldFile).getClientName(), addCloseOp.path);
+              }
