HDDS-400. Check global replication state for containers of dead node. Contributed by Elek, Marton.

-
-import org.apache.hadoop.hdds.protocol.proto
-    .StorageContainerDatanodeProtocolProtos.ContainerReportsProto;
+import org.apache.hadoop.hdds.protocol.proto.StorageContainerDatanodeProtocolProtos;
+import org.apache.hadoop.hdds.protocol.proto.StorageContainerDatanodeProtocolProtos.ContainerReportsProto;
-import org.apache.hadoop.hdds.scm.container.replication
-    .ReplicationActivityStatus;
+import org.apache.hadoop.hdds.scm.container.replication.ReplicationActivityStatus;
-import org.apache.hadoop.hdds.scm.server.SCMDatanodeHeartbeatDispatcher
-    .ContainerReportFromDatanode;
+import org.apache.hadoop.hdds.scm.server.SCMDatanodeHeartbeatDispatcher.ContainerReportFromDatanode;
-
+    this.containerStateManager = containerMapping.getStateManager();
-    this.containerStateManager = containerMapping.getStateManager();
-                        EventPublisher publisher) {
+      EventPublisher publisher) {
-          .map(containerProto -> containerProto.getContainerID())
+          .map(StorageContainerDatanodeProtocolProtos
+              .ContainerInfo::getContainerID)
-        emitReplicationRequestEvent(containerID, publisher);
+        checkReplicationState(containerID, publisher);
-
-        emitReplicationRequestEvent(containerID, publisher);
+        checkReplicationState(containerID, publisher);
-  private void emitReplicationRequestEvent(ContainerID containerID,
-      EventPublisher publisher) throws SCMException {
+  private void checkReplicationState(ContainerID containerID,
+      EventPublisher publisher)
+      throws SCMException {
-    if (replicationStatus.isReplicationEnabled()) {
-      int existingReplicas =
-          containerStateManager.getContainerReplicas(containerID).size();
-
-      int expectedReplicas = container.getReplicationFactor().getNumber();
-
-      if (existingReplicas != expectedReplicas) {
-
+    ReplicationRequest replicationState =
+        containerStateManager.checkReplicationState(containerID);
+    if (replicationState != null) {
+      if (replicationStatus.isReplicationEnabled()) {
-            new ReplicationRequest(containerID.getId(), existingReplicas,
-                container.getReplicationFactor().getNumber()));
+            replicationState);
+      } else {
+        LOG.warn(
+            "Over/under replicated container but the replication is not "
+                + "(yet) enabled: "
+                + replicationState.toString());
