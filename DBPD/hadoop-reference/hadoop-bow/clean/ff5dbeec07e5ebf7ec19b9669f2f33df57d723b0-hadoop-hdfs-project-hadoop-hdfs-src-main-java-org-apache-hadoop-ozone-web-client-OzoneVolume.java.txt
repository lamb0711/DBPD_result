HDFS-11846. Ozone: Fix Http connection leaks in ozone clients. Contributed by Weiwei Yang.

+import com.google.common.annotations.VisibleForTesting;
+import org.apache.hadoop.ozone.OzoneClientUtils;
-import org.apache.http.impl.client.HttpClients;
-    try {
+    HttpPost httpPost = null;
+    try (CloseableHttpClient httpClient = newHttpClient()) {
-      CloseableHttpClient httpClient = HttpClients.createDefault();
-      HttpPost httppost = client.getHttpPost(null, builder.toString());
+      httpPost = client.getHttpPost(null, builder.toString());
-          httppost
+          httpPost
-      httppost.addHeader(Header.OZONE_STORAGE_TYPE, storageType.toString());
-      httppost.addHeader(Header.OZONE_BUCKET_VERSIONING, versioning.toString());
-      executeCreateBucket(httppost, httpClient);
+      httpPost.addHeader(Header.OZONE_STORAGE_TYPE, storageType.toString());
+      httpPost.addHeader(Header.OZONE_BUCKET_VERSIONING, versioning.toString());
+      executeCreateBucket(httpPost, httpClient);
+    } finally {
+      OzoneClientUtils.releaseConnection(httpPost);
-
-
-    try {
+    HttpPut putRequest = null;
+    try (CloseableHttpClient httpClient = newHttpClient()) {
-      CloseableHttpClient httpClient = HttpClients.createDefault();
-      HttpPut putRequest = client.getHttpPut(builder.toString());
+      putRequest = client.getHttpPut(builder.toString());
+    } finally {
+      OzoneClientUtils.releaseConnection(putRequest);
-    try {
+    HttpPut putRequest = null;
+    try (CloseableHttpClient httpClient = newHttpClient()) {
-      CloseableHttpClient httpClient = HttpClients.createDefault();
-      HttpPut putRequest = client.getHttpPut(builder.toString());
+      putRequest = client.getHttpPut(builder.toString());
+    } finally {
+      OzoneClientUtils.releaseConnection(putRequest);
-    try {
+    HttpGet getRequest = null;
+    try (CloseableHttpClient httpClient = newHttpClient()) {
-      CloseableHttpClient httpClient = HttpClients.createDefault();
-      HttpGet getRequest = client.getHttpGet(builder.toString());
+      getRequest = client.getHttpGet(builder.toString());
+    } finally {
+      OzoneClientUtils.releaseConnection(getRequest);
-    try {
-      CloseableHttpClient httpClient = HttpClients.createDefault();
-
+    HttpGet getRequest = null;
+    try (CloseableHttpClient httpClient = newHttpClient()) {
-      HttpGet getRequest = client.getHttpGet(builder.toString());
+      getRequest = client.getHttpGet(builder.toString());
+    } finally {
+      OzoneClientUtils.releaseConnection(getRequest);
-    try {
+    HttpDelete delRequest = null;
+    try (CloseableHttpClient httpClient = newHttpClient()) {
-      CloseableHttpClient httpClient = HttpClients.createDefault();
-      HttpDelete delRequest = client.getHttpDelete(builder.toString());
+      delRequest = client.getHttpDelete(builder.toString());
+    } finally {
+      OzoneClientUtils.releaseConnection(delRequest);
+
+  @VisibleForTesting
+  public CloseableHttpClient newHttpClient() {
+    return OzoneClientUtils.newHttpClient();
+  }
