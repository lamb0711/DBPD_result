YARN-1303. Fixed DistributedShell to not fail with multiple commands separated by a semi-colon as shell-command. Contributed by Xuan Gong.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1544023 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.commons.io.IOUtils;
+import org.apache.hadoop.fs.FSDataOutputStream;
+import org.apache.hadoop.fs.permission.FsPermission;
+  private final String shellCommandPath = "shellCommands";
+    if (!shellCommand.isEmpty()) {
+      String shellCommandSuffix =
+          appName + "/" + appId.getId() + "/" + shellCommandPath;
+      Path shellCommandDst =
+          new Path(fs.getHomeDirectory(), shellCommandSuffix);
+      FSDataOutputStream ostream = null;
+      try {
+        ostream = FileSystem
+            .create(fs, shellCommandDst, new FsPermission((short) 0710));
+        ostream.writeUTF(shellCommand);
+      } finally {
+        IOUtils.closeQuietly(ostream);
+      }
+      FileStatus scFileStatus = fs.getFileStatus(shellCommandDst);
+      LocalResource scRsrc = Records.newRecord(LocalResource.class);
+      scRsrc.setType(LocalResourceType.FILE);
+      scRsrc.setVisibility(LocalResourceVisibility.APPLICATION);
+      scRsrc.setResource(ConverterUtils.getYarnUrlFromURI(shellCommandDst
+          .toUri()));
+      scRsrc.setTimestamp(scFileStatus.getModificationTime());
+      scRsrc.setSize(scFileStatus.getLen());
+      localResources.put("shellCommands", scRsrc);
+    }
+
-      vargs.add("--shell_command " + shellCommand + "");
+      vargs.add("--shell_command " + shellCommandPath + "");
