merge the rest of trunk to branch HDFS-4949

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-4949@1532967 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.regex.Pattern;
+import org.apache.hadoop.security.UserGroupInformation;
+  private String nonsecureLocalUser;
+  private Pattern nonsecureLocalUserPattern;
+    nonsecureLocalUser = conf.get(
+        YarnConfiguration.NM_NONSECURE_MODE_LOCAL_USER_KEY,
+        YarnConfiguration.DEFAULT_NM_NONSECURE_MODE_LOCAL_USER);
+    nonsecureLocalUserPattern = Pattern.compile(
+        conf.get(YarnConfiguration.NM_NONSECURE_MODE_USER_PATTERN_KEY,
+            YarnConfiguration.DEFAULT_NM_NONSECURE_MODE_USER_PATTERN));        
+  }
+
+  void verifyUsernamePattern(String user) {
+    if (!UserGroupInformation.isSecurityEnabled() &&
+        !nonsecureLocalUserPattern.matcher(user).matches()) {
+        throw new IllegalArgumentException("Invalid user name '" + user + "'," +
+            " it must match '" + nonsecureLocalUserPattern.pattern() + "'");
+      }
+  }
+
+  String getRunAsUser(String user) {
+    return UserGroupInformation.isSecurityEnabled() ? user : nonsecureLocalUser;
+    verifyUsernamePattern(user);
+    String runAsUser = getRunAsUser(user);
+                   runAsUser,
+    verifyUsernamePattern(user);
+    String runAsUser = getRunAsUser(user);
+
-            containerExecutorExe, user, Integer
+            containerExecutorExe, runAsUser, user, Integer
+    verifyUsernamePattern(user);
+    String runAsUser = getRunAsUser(user);
+
+                   runAsUser,
+    verifyUsernamePattern(user);
+    String runAsUser = getRunAsUser(user);
+
+                    runAsUser,
