HDFS-4684. Use INode id for image serialization when writing INodeReference.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1466718 13f79535-47bb-0310-9956-ffa450edef68

-import com.google.common.base.Preconditions;
-
-  /** A reference with a fixed id for fsimage serialization. */
-  private static class INodeReferenceWithId extends INodeReference {
-    final long id;
-
-    private INodeReferenceWithId(WithCount parent, INode referred, long id) {
-      super(parent, referred);
-      this.id = id;
-    }
-    
-    /** @return the reference id. */
-    private long getReferenceId() {
-      return id;
-    }
-  }
-
-    private long referenceId = 0;
-      final boolean firstReferred = !(referred instanceof INodeReferenceWithId);
+      final long id = withCount.getId();
+      final boolean firstReferred = !referenceMap.containsKey(id);
-        final long id = ++referenceId;
-
-        final INodeReferenceWithId withId = new INodeReferenceWithId(
-            withCount, referred, id);
-        withCount.setReferredINode(withId);
-        referred.setParentReference(withId);
-        final long id = ((INodeReferenceWithId)referred).getReferenceId();
-        Preconditions.checkState(referenceMap.containsKey(id));
-        referenceMap.put(++referenceId, withCount);
+        referenceMap.put(withCount.getId(), withCount);
-    
-    public void removeAllINodeReferenceWithId() {
-      for(INodeReference.WithCount withCount : referenceMap.values()) {
-        final INodeReference ref = withCount.getReferredINode().asReference();
-        final INode referred = ref.getReferredINode();
-        withCount.setReferredINode(referred);
-        referred.setParentReference(withCount);
-        ref.clear();
-      }
-      referenceMap.clear();
-    }
