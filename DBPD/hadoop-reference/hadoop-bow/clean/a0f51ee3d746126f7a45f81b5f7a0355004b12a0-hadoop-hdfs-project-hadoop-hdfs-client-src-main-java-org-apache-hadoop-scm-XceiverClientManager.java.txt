HDFS-11850. Ozone: Stack Overflow in XceiverClientManager because of race condition in accessing openClient. Contributed by Mukul Kumar Singh.

-    XceiverClientWithAccessInfo info = openClient.getIfPresent(containerName);
+    synchronized(openClient) {
+      XceiverClientWithAccessInfo info =
+          openClient.getIfPresent(containerName);
-    if (info != null) {
-      // we do have this connection, add reference and return
-      info.incrementReference();
-      return info.getXceiverClient();
-    } else {
-      // connection not found, create new, add reference and return
-      final XceiverClientSpi xceiverClient = useRatis?
-          XceiverClientRatis.newXceiverClientRatis(pipeline, conf)
-          : new XceiverClient(pipeline, conf);
-      try {
-        xceiverClient.connect();
-      } catch (Exception e) {
-        throw new IOException("Exception connecting XceiverClient.", e);
-      }
-      info = new XceiverClientWithAccessInfo(xceiverClient);
-      info.incrementReference();
-      synchronized (openClient) {
+      if (info != null) {
+        // we do have this connection, add reference and return
+        info.incrementReference();
+        return info.getXceiverClient();
+      } else {
+        // connection not found, create new, add reference and return
+        final XceiverClientSpi xceiverClient = useRatis ?
+            XceiverClientRatis.newXceiverClientRatis(pipeline, conf)
+            : new XceiverClient(pipeline, conf);
+        try {
+          xceiverClient.connect();
+        } catch (Exception e) {
+          throw new IOException("Exception connecting XceiverClient.", e);
+        }
+        info = new XceiverClientWithAccessInfo(xceiverClient);
+        info.incrementReference();
+        return xceiverClient;
-      return xceiverClient;
+      Preconditions.checkNotNull(info);
+      info.decrementReference();
-    Preconditions.checkNotNull(info);
-    info.decrementReference();
