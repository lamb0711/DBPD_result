HDDS-1456. Stop the datanode, when any datanode statemachine state isâ€¦ (#769)



+import java.util.concurrent.atomic.AtomicBoolean;
+  private volatile AtomicBoolean isStopped = new AtomicBoolean(false);
-            dnCertClient);
+            dnCertClient, this::terminateDatanode);
+  public void terminateDatanode() {
+    stop();
+    terminate(1);
+  }
+
+
-    if (plugins != null) {
-      for (ServicePlugin plugin : plugins) {
+    if (!isStopped.get()) {
+      isStopped.set(true);
+      if (plugins != null) {
+        for (ServicePlugin plugin : plugins) {
+          try {
+            plugin.stop();
+            LOG.info("Stopped plug-in {}", plugin);
+          } catch (Throwable t) {
+            LOG.warn("ServicePlugin {} could not be stopped", plugin, t);
+          }
+        }
+      }
+      if (datanodeStateMachine != null) {
+        datanodeStateMachine.stopDaemon();
+      }
+      if (httpServer != null) {
-          plugin.stop();
-          LOG.info("Stopped plug-in {}", plugin);
-        } catch (Throwable t) {
-          LOG.warn("ServicePlugin {} could not be stopped", plugin, t);
+          httpServer.stop();
+        } catch (Exception e) {
+          LOG.error("Stopping HttpServer is failed.", e);
-    if (datanodeStateMachine != null) {
-      datanodeStateMachine.stopDaemon();
-    }
-    if (httpServer != null) {
-      try {
-        httpServer.stop();
-      } catch (Exception e) {
-        LOG.error("Stopping HttpServer is failed.", e);
-      }
-    }
-
