HDFS-4647. Rename should call setLocalName after an inode is removed from snapshots.  Contributed by Arpit Agarwal


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1464795 13f79535-47bb-0310-9956-ffa450edef68

-    if (oldChild.isReference()) {
+    if (oldChild.isReference() && !newChild.isReference()) {
+  INodeReference.WithName replaceChild4ReferenceWithName(INode oldChild) {
+    if (oldChild instanceof INodeReference.WithName) {
+      return (INodeReference.WithName)oldChild;
+    }
+
+    final INodeReference.WithCount withCount;
+    if (oldChild.isReference()) {
+      withCount = (INodeReference.WithCount) oldChild.asReference().getReferredINode();
+    } else {
+      withCount = new INodeReference.WithCount(null, oldChild);
+    }
+    final INodeReference.WithName ref = new INodeReference.WithName(
+        this, withCount, oldChild.getLocalNameBytes());
+    replaceChild(oldChild, ref);
+    return ref;
+  }
+  
