HDFS-3582. Hook daemon process exit for testing. Contributed by Eli Collins


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1360329 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.util.ExitUtil.ExitException;
+
+import static org.apache.hadoop.util.ExitUtil.terminate;
-  private Runtime runtime = Runtime.getRuntime();
-        System.exit(aborted ? 1 : 0);
+        terminate(aborted ? 1 : 0);
-        System.exit(0);
+        terminate(0);
-        System.exit(aborted ? 1 : 0);
+        terminate(aborted ? 1 : 0);
-        System.exit(rc);
+        terminate(rc);
-        System.exit(aborted ? 1 : 0);
+        terminate(aborted ? 1 : 0);
-      default:
+      default: {
+      }
-      LOG.error("Exception in namenode join", e);
-      System.exit(-1);
+      LOG.fatal("Exception in namenode join", e);
+      terminate(1);
-  
-  @VisibleForTesting
-  public synchronized void setRuntimeForTesting(Runtime runtime) {
-    this.runtime = runtime;
-  }
-   * @throws ServiceFailedException thrown only for testing.
+   * @throws ExitException thrown only for testing.
-      throws ServiceFailedException {
+      throws ExitException {
-    runtime.exit(1);
-    // This code is only reached during testing, when runtime is stubbed out.
-    throw new ServiceFailedException(message, t);
+    terminate(1, t.getMessage());
