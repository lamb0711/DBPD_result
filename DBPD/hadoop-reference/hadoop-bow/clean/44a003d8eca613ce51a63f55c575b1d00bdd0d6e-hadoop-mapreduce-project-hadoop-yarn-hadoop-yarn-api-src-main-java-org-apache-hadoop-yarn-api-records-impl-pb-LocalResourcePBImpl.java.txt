MAPREDUCE-3931. Changed PB implementation of LocalResource to take locks so that race conditions don't fail tasks by inadvertantly changing the timestamps. Contributed by Siddarth Seth.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1294970 13f79535-47bb-0310-9956-ffa450edef68

-public class LocalResourcePBImpl extends ProtoBase<LocalResourceProto> implements LocalResource {
+public class LocalResourcePBImpl extends ProtoBase<LocalResourceProto>
+    implements LocalResource {
-  
+
-  
-  
+
-  
-  public LocalResourceProto getProto() {
-    mergeLocalToProto();
+
+  public synchronized LocalResourceProto getProto() {
+    mergeLocalToBuilder();
-  private void mergeLocalToBuilder() {
-    if (this.url != null) {
+  private synchronized void mergeLocalToBuilder() {
+    LocalResourceProtoOrBuilder l = viaProto ? proto : builder;
+    if (this.url != null
+        && !(l.getResource().equals(((URLPBImpl) url).getProto()))) {
+      maybeInitBuilder();
+      l = builder;
-  private void mergeLocalToProto() {
-    if (viaProto) 
-      maybeInitBuilder();
-    mergeLocalToBuilder();
-    proto = builder.build();
-    viaProto = true;
-  }
-
-  private void maybeInitBuilder() {
+  private synchronized void maybeInitBuilder() {
-    
-  
+
-  public long getSize() {
+  public synchronized long getSize() {
-  public void setSize(long size) {
+  public synchronized void setSize(long size) {
-  public long getTimestamp() {
+  public synchronized long getTimestamp() {
-  public void setTimestamp(long timestamp) {
+  public synchronized void setTimestamp(long timestamp) {
-  public LocalResourceType getType() {
+  public synchronized LocalResourceType getType() {
-  public void setType(LocalResourceType type) {
+  public synchronized void setType(LocalResourceType type) {
-  public URL getResource() {
+  public synchronized URL getResource() {
-  public void setResource(URL resource) {
+  public synchronized void setResource(URL resource) {
-  public LocalResourceVisibility getVisibility() {
+  public synchronized LocalResourceVisibility getVisibility() {
-  public void setVisibility(LocalResourceVisibility visibility) {
+  public synchronized void setVisibility(LocalResourceVisibility visibility) {
-
-
-
