Merge changes from trunk

-import org.apache.hadoop.crypto.CryptoCodec;
-import org.apache.hadoop.crypto.key.KeyProvider;
-  private KeyProvider.Options providerOptions = null;
-
-  private final CryptoCodec codec;
-    providerOptions = KeyProvider.options(conf);
-    this.codec = CryptoCodec.getInstance(conf);
+    BlocksMapUpdateInfo collectedBlocks = new BlocksMapUpdateInfo();
-      renameToInternal(pc, src, dst, cacheEntry != null, options);
+      renameToInternal(pc, src, dst, cacheEntry != null, 
+          collectedBlocks, options);
+    if (!collectedBlocks.getToDeleteList().isEmpty()) {
+      removeBlocks(collectedBlocks);
+      collectedBlocks.clear();
+    }
-  private void renameToInternal(FSPermissionChecker pc, String src, String dst,
-      boolean logRetryCache, Options.Rename... options) throws IOException {
+  private void renameToInternal(FSPermissionChecker pc, String src, 
+      String dst, boolean logRetryCache, BlocksMapUpdateInfo collectedBlocks, 
+      Options.Rename... options) throws IOException {
-    dir.renameTo(src, dst, mtime, options);
+    dir.renameTo(src, dst, mtime, collectedBlocks, options);
