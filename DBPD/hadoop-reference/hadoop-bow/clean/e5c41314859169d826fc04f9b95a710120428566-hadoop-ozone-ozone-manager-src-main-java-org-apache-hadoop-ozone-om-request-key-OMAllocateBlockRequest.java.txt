HDDS-1856. Make required changes for Non-HA to use new HA code in OM. (#1174)


+import org.apache.hadoop.ozone.om.ratis.utils.OzoneManagerDoubleBufferHelper;
-      long transactionLogIndex) {
+      long transactionLogIndex,
+      OzoneManagerDoubleBufferHelper ozoneManagerDoubleBufferHelper) {
+    IOException exception = null;
+    OmKeyInfo omKeyInfo = null;
-    } catch (IOException ex) {
-      LOG.error("AllocateBlock failed for Key: {} in volume/bucket:{}/{}",
-          keyName, bucketName, volumeName, ex);
-      omMetrics.incNumBlockAllocateCallFails();
-      auditLog(auditLogger, buildAuditMessage(OMAction.ALLOCATE_BLOCK, auditMap,
-          ex, getOmRequest().getUserInfo()));
-      return new OMAllocateBlockResponse(null, -1L,
-          createErrorOMResponse(omResponse, ex));
-    }
-    OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();
-    try {
+      OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();
-    } catch (IOException ex) {
-      LOG.error("AllocateBlock failed for Key: {} in volume/bucket:{}/{}",
-          keyName, bucketName, volumeName, ex);
-      omMetrics.incNumBlockAllocateCallFails();
-      auditLog(auditLogger, buildAuditMessage(OMAction.ALLOCATE_BLOCK, auditMap,
-          ex, getOmRequest().getUserInfo()));
-      return new OMAllocateBlockResponse(null, -1L,
-          createErrorOMResponse(omResponse, ex));
-    }
-    String openKey = omMetadataManager.getOpenKey(
-        volumeName, bucketName, keyName, clientID);
+      String openKey = omMetadataManager.getOpenKey(
+          volumeName, bucketName, keyName, clientID);
-    IOException exception = null;
-    OmKeyInfo omKeyInfo =  null;
+      // Here we don't acquire bucket/volume lock because for a single client
+      // allocateBlock is called in serial fashion.
-    // Here we don't acquire bucket/volume lock because for a single client
-    // allocateBlock is called in serial fashion.
-    try {
-
+    OMClientResponse omClientResponse = null;
-      return new OMAllocateBlockResponse(omKeyInfo, clientID,
-          omResponse.build());
+      omClientResponse = new OMAllocateBlockResponse(omKeyInfo,
+          clientID, omResponse.build());
-      return new OMAllocateBlockResponse(null, -1L,
+      omClientResponse = new OMAllocateBlockResponse(null, -1L,
+    omClientResponse.setFlushFuture(
+        ozoneManagerDoubleBufferHelper.add(omClientResponse,
+            transactionLogIndex));
+    return omClientResponse;
+
