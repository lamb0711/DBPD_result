HDFS-4170. Add snapshot information to INodesInPath.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1407703 13f79535-47bb-0310-9956-ffa450edef68

+  /** Snapshots of this directory in ascending order of snapshot names. */
+  private final List<Snapshot> snapshotsByNames = new ArrayList<Snapshot>();
-  /** @return the root directory of a snapshot. */
-  public INodeDirectory getSnapshotRoot(byte[] snapshotName) {
-    if (snapshots == null || snapshots.size() == 0) {
-      return null;
-    }
-    int low = Collections.binarySearch(snapshots, snapshotName);
-    if (low >= 0) {
-      return snapshots.get(low).getRoot();
-    }
-    return null;
+  private int searchSnapshot(byte[] snapshotName) {
+    return Collections.binarySearch(snapshotsByNames, snapshotName);
+  }
+
+  /** @return the snapshot with the given name. */
+  public Snapshot getSnapshot(byte[] snapshotName) {
+    final int i = searchSnapshot(snapshotName);
+    return i < 0? null: snapshotsByNames.get(i);
+  }
+
+  /** @return the last snapshot. */
+  public Snapshot getLastSnapshot() {
+    final int n = snapshots.size();
+    return n == 0? null: snapshots.get(n - 1);
-  /** Add a snapshot root under this directory. */
-  void addSnapshot(final Snapshot s) throws SnapshotException {
+  /** Add a snapshot. */
+  Snapshot addSnapshot(int id, String name) throws SnapshotException {
+    final Snapshot s = new Snapshot(id, name, this);
+    final byte[] nameBytes = s.getRoot().getLocalNameBytes();
+    final int i = searchSnapshot(nameBytes);
+    if (i >= 0) {
+      throw new SnapshotException("Failed to add snapshot: there is already a "
+          + "snapshot with the same name \"" + name + "\".");
+    }
+    snapshotsByNames.add(-i - 1, s);
+    return s;
