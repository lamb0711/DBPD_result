HDFS-4729. Fix OfflineImageViewer and permission checking for snapshot operations.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1471665 13f79535-47bb-0310-9956-ffa450edef68

-    final FSPermissionChecker pc = getPermissionChecker();
-      checkOwner(pc, path);
+      checkSuperuserPrivilege();
-    final FSPermissionChecker pc = getPermissionChecker();
-      checkOwner(pc, path);
+      checkSuperuserPrivilege();
-      checkOwner(pc, snapshotRoot);
+      if (isPermissionEnabled) {
+        checkOwner(pc, snapshotRoot);
+      }
-      checkOwner(pc, path);
+      if (isPermissionEnabled) {
+        checkOwner(pc, path);
+      }
+    final FSPermissionChecker pc = getPermissionChecker();
+      if (isPermissionEnabled) {
+        checkSubtreeReadPermission(pc, path, fromSnapshot);
+        checkSubtreeReadPermission(pc, path, toSnapshot);
+      }
+  private void checkSubtreeReadPermission(final FSPermissionChecker pc,
+      final String snapshottablePath, final String snapshot)
+          throws AccessControlException, UnresolvedLinkException {
+    final String fromPath = snapshot == null?
+        snapshottablePath: Snapshot.getSnapshotPath(snapshottablePath, snapshot);
+    checkPermission(pc, fromPath, false, null, null, FsAction.READ, FsAction.READ);
+  }
+  
