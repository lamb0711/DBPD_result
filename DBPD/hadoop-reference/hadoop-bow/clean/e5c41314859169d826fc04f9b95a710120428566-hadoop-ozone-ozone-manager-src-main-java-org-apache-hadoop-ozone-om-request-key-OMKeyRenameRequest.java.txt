HDDS-1856. Make required changes for Non-HA to use new HA code in OM. (#1174)


+import org.apache.hadoop.ozone.om.ratis.utils.OzoneManagerDoubleBufferHelper;
-      long transactionLogIndex) {
+      long transactionLogIndex,
+      OzoneManagerDoubleBufferHelper ozoneManagerDoubleBufferHelper) {
+    OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();
+    boolean acquiredLock = false;
+    OMClientResponse omClientResponse = null;
+    IOException exception = null;
+    OmKeyInfo fromKeyValue = null;
-    } catch (IOException ex) {
-      LOG.error(
-          "Rename key failed for volume:{} bucket:{} fromKey:{} toKey:{}. "
-              + "Key: {} not found.", volumeName, bucketName, fromKeyName,
-          toKeyName, fromKeyName);
-      omMetrics.incNumKeyRenameFails();
-      auditLog(auditLogger, buildAuditMessage(OMAction.RENAME_KEY, auditMap,
-          ex, getOmRequest().getUserInfo()));
-      return new OMKeyRenameResponse(null, null, null,
-          createErrorOMResponse(omResponse, ex));
-    }
-    OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();
-    omMetadataManager.getLock().acquireLock(BUCKET_LOCK, volumeName,
-        bucketName);
-
-    IOException exception = null;
-    OmKeyInfo fromKeyValue = null;
-    try {
+      acquiredLock = omMetadataManager.getLock().acquireLock(BUCKET_LOCK,
+          volumeName, bucketName);
+      omClientResponse = new OMKeyRenameResponse(fromKeyValue, toKeyName,
+        fromKeyName, omResponse.setRenameKeyResponse(
+            RenameKeyResponse.newBuilder()).build());
+      omClientResponse = new OMKeyRenameResponse(null, null, null,
+          createErrorOMResponse(omResponse, exception));
-      omMetadataManager.getLock().releaseLock(BUCKET_LOCK, volumeName,
-          bucketName);
+      if (omClientResponse != null) {
+        omClientResponse.setFlushFuture(
+            ozoneManagerDoubleBufferHelper.add(omClientResponse,
+                transactionLogIndex));
+      }
+      if (acquiredLock) {
+        omMetadataManager.getLock().releaseLock(BUCKET_LOCK, volumeName,
+            bucketName);
+      }
-      return new OMKeyRenameResponse(fromKeyValue, toKeyName, fromKeyName,
-          omResponse.setRenameKeyResponse(
-              RenameKeyResponse.newBuilder()).build());
+      LOG.debug("Rename Key is successfully completed for volume:{} bucket:{}" +
+          " fromKey:{} toKey:{}. ", volumeName, bucketName, fromKeyName,
+          toKeyName);
+      return omClientResponse;
-      return new OMKeyRenameResponse(null, null, null,
-          createErrorOMResponse(omResponse, exception));
+      return omClientResponse;
