Merged r1185354 from trunk for HDFS-2188.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1185363 13f79535-47bb-0310-9956-ffa450edef68

-
+import java.net.URI;
+import java.util.Collections;
+import org.apache.hadoop.conf.Configuration;
+import com.google.common.collect.Lists;
+  final private Collection<URI> editsDirs;
+
+  /**
+   * Construct FSEditLog with default configuration, taking editDirs from NNStorage
+   * @param storage Storage object used by namenode
+   */
+  @VisibleForTesting
+    this(new Configuration(), storage, Collections.<URI>emptyList());
+  }
+
+  /**
+   * Constructor for FSEditLog. Add underlying journals are constructed, but 
+   * no streams are opened until open() is called.
+   * 
+   * @param conf The namenode configuration
+   * @param storage Storage object used by namenode
+   * @param editsDirs List of journals to use
+   */
+  FSEditLog(Configuration conf, NNStorage storage, Collection<URI> editsDirs) {
+    
+    if (editsDirs.isEmpty()) { 
+      // if this is the case, no edit dirs have been explictly configured
+      // image dirs are to be used for edits too
+      try {
+        editsDirs = Lists.newArrayList(storage.getEditsDirectories());
+      } catch (IOException ioe) {
+        // cannot get list from storage, so the empty editsDirs 
+        // will be assigned. an error will be thrown on first use
+        // of the editlog, as no journals will exist
+      }
+      this.editsDirs = editsDirs;
+    } else {
+      this.editsDirs = Lists.newArrayList(editsDirs);
+    }
-    for (StorageDirectory sd : storage.dirIterable(NameNodeDirType.EDITS)) {
-      journalSet.add(new FileJournalManager(sd));
+    for (URI u : this.editsDirs) {
+      StorageDirectory sd = storage.getStorageDirectory(u);
+      if (sd != null) {
+        journalSet.add(new FileJournalManager(sd));
+      }
-    
+ 
-  
+
+  /**
+   * Get the list of URIs the editlog is using for storage
+   * @return collection of URIs in use by the edit log
+   */
+  Collection<URI> getEditURIs() {
+    return editsDirs;
+  }
+
