HDDS-1101. SCM CA: Write Certificate information to SCM Metadata. Contributed by Anu Engineer.

+    if (OzoneSecurityUtil.isSecurityEnabled(conf)) {
+      loginAsSCMUser(conf);
+    }
-    // Authenticate SCM if security is enabled
+    // Creates the SCM DBs or opens them if it exists.
+    // A valid pointer to the store is required by all the other services below.
+    initalizeMetadataStore(conf, configurator);
+
+    // Authenticate SCM if security is enabled, this initialization can only
+    // be done after the metadata store is initialized.
-    // Creates the SCM DBs or opens them if it exists.
-    initalizeMetadataStore(conf, configurator);
-      throws IOException, AuthenticationException {
-    loginAsSCMUser(conf);
+      throws IOException {
+      // This assumes that SCM init has run, and DB metadata stores are created.
-    return new DefaultCAServer(subject, clusterID, scmID);
+    if(this.scmMetadataStore == null) {
+      LOG.error("Cannot initialize Certificate Server without a valid meta " +
+          "data layer.");
+      throw new SCMException("Cannot initialize CA without a valid metadata " +
+          "store", ResultCodes.SCM_NOT_INITIALIZED);
+    }
+    SCMCertStore certStore = new SCMCertStore(this.scmMetadataStore);
+    return new DefaultCAServer(subject, clusterID, scmID, certStore);
