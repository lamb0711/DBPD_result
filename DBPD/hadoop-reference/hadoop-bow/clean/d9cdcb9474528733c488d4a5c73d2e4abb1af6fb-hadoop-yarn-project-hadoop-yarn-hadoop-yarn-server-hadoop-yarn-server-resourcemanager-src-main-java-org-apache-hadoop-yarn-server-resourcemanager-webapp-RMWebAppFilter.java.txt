YARN-1658. Modified web-app framework to let standby RMs redirect web-service calls to the active RM. Contributed by Cindy Li.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1577408 13f79535-47bb-0310-9956-ffa450edef68

+import javax.inject.Inject;
+import javax.inject.Singleton;
+import javax.servlet.FilterChain;
-import org.apache.hadoop.classification.InterfaceAudience;
-import org.apache.hadoop.yarn.webapp.Dispatcher;
-import org.apache.hadoop.yarn.webapp.Router;
-import org.apache.hadoop.yarn.webapp.WebApp;
-import com.google.inject.Inject;
-import com.google.inject.Singleton;
+import com.sun.jersey.guice.spi.container.servlet.GuiceContainer;
-@InterfaceAudience.LimitedPrivate({ "YARN", "MapReduce" })
-public class RMDispatcher extends Dispatcher {
+public class RMWebAppFilter extends GuiceContainer {
+  private Injector injector;
-   *
+   * 
-  RMDispatcher(WebApp webApp, Injector injector, Router router) {
-    super(webApp, injector, router);
+  public RMWebAppFilter(Injector injector) {
+    super(injector);
+    this.injector=injector;
-  public void service(HttpServletRequest req, HttpServletResponse res)
-      throws ServletException, IOException {
-    res.setCharacterEncoding("UTF-8");
-    String uri = HtmlQuoting.quoteHtmlChars(req.getRequestURI());
+  public void doFilter(HttpServletRequest request,
+      HttpServletResponse response, FilterChain chain) throws IOException,
+      ServletException {
+    response.setCharacterEncoding("UTF-8");
+    String uri = HtmlQuoting.quoteHtmlChars(request.getRequestURI());
-
-    RMWebApp rmWebApp = (RMWebApp) webApp;
+    RMWebApp rmWebApp = injector.getInstance(RMWebApp.class);
+        && !uri.equals("/" + rmWebApp.wsName() + "/v1/cluster/info")
+
-        res.addHeader("Refresh", "3; url=" + redirectPath);
-        PrintWriter out = res.getWriter();
+        response.addHeader("Refresh", "3; url=" + redirectPath);
+        PrintWriter out = response.getWriter();
-    super.service(req, res);
+
+    super.doFilter(request, response, chain);
+
+
