HDFS-4353. Encapsulate connections to peers in Peer and PeerServer classes. Contributed by Colin Patrick McCabe.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-347@1431097 13f79535-47bb-0310-9956-ffa450edef68

-import java.net.ServerSocket;
-import java.net.Socket;
-import java.util.Collections;
-import java.util.Iterator;
+import org.apache.hadoop.hdfs.net.Peer;
+import org.apache.hadoop.hdfs.net.PeerServer;
-  ServerSocket ss;
-  DataNode datanode;
-  // Record all sockets opened for data transfer
-  Set<Socket> childSockets = Collections.synchronizedSet(
-                                       new HashSet<Socket>());
+  private final PeerServer peerServer;
+  private final DataNode datanode;
+  private final Set<Peer> peers = new HashSet<Peer>();
-  DataXceiverServer(ServerSocket ss, Configuration conf, 
+  DataXceiverServer(PeerServer peerServer, Configuration conf,
-    this.ss = ss;
+    this.peerServer = peerServer;
+    Peer peer = null;
-      Socket s = null;
-        s = ss.accept();
-        s.setTcpNoDelay(true);
-        // Timeouts are set within DataXceiver.run()
+        peer = peerServer.accept();
-            DataXceiver.create(s, datanode, this))
+            DataXceiver.create(peer, datanode, this))
-        IOUtils.closeSocket(s);
+        IOUtils.cleanup(null, peer);
-        IOUtils.closeSocket(s);
+        IOUtils.cleanup(null, peer);
+    synchronized (this) {
+      for (Peer p : peers) {
+        IOUtils.cleanup(LOG, p);
+      }
+    }
-      ss.close();
+      peerServer.close();
-  
+
-      this.ss.close();
+      this.peerServer.close();
+  }
+  
+  synchronized void addPeer(Peer peer) {
+    peers.add(peer);
+  }
-    // close all the sockets that were accepted earlier
-    synchronized (childSockets) {
-      for (Iterator<Socket> it = childSockets.iterator();
-           it.hasNext();) {
-        Socket thissock = it.next();
-        try {
-          thissock.close();
-        } catch (IOException e) {
-        }
-      }
-    }
+  synchronized void closePeer(Peer peer) {
+    peers.remove(peer);
+    IOUtils.cleanup(null, peer);
