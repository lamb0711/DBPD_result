HDFS-4563. Update namespace/diskspace usage after deleting snapshots.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1455396 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.hdfs.protocol.NSQuotaExceededException;
+import org.apache.hadoop.hdfs.protocol.QuotaExceededException;
+import org.apache.hadoop.hdfs.server.namenode.Content;
+import org.apache.hadoop.hdfs.server.namenode.Content.CountsMap.Key;
-import org.apache.hadoop.hdfs.server.namenode.INode.Content.CountsMap.Key;
+import org.apache.hadoop.hdfs.server.namenode.Quota;
-      throws SnapshotException, NSQuotaExceededException {
+      throws SnapshotException, QuotaExceededException {
-        cleanSubtree(snapshot, prior, collectedBlocks);
-      } catch(NSQuotaExceededException e) {
+        Quota.Counts counts = cleanSubtree(snapshot, prior, collectedBlocks);
+        INodeDirectory parent = getParent();
+        if (parent != null) {
+          parent.addSpaceConsumed(counts.get(Quota.NAMESPACE),
+              counts.get(Quota.DISKSPACE));
+        }
+      } catch(QuotaExceededException e) {
-  void replaceSelf(final Snapshot latest) throws NSQuotaExceededException {
+  void replaceSelf(final Snapshot latest) throws QuotaExceededException {
