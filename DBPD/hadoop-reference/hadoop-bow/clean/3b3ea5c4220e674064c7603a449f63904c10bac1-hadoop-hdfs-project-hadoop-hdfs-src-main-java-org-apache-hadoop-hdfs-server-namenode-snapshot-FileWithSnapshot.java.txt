HDFS-4563. Update namespace/diskspace usage after deleting snapshots.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1455396 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.server.namenode.Quota;
+    private static Quota.Counts updateQuotaAndCollectBlocks(
+        INodeFile currentINode, FileDiff removed,
+        BlocksMapUpdateInfo collectedBlocks) {
+      FileWithSnapshot sFile = (FileWithSnapshot) currentINode;
+      long oldDiskspace = currentINode.diskspaceConsumed();
+      if (removed.snapshotINode != null) {
+        short replication = removed.snapshotINode.getFileReplication();
+        if (replication > currentINode.getBlockReplication()) {
+          oldDiskspace = oldDiskspace / currentINode.getBlockReplication()
+              * replication;
+        }
+      }
+      
+      Util.collectBlocksAndClear(sFile, collectedBlocks);
+      
+      long dsDelta = oldDiskspace - currentINode.diskspaceConsumed();
+      return Quota.Counts.newInstance(0, dsDelta);
+    }
+    
-    int combinePosteriorAndCollectBlocks(INodeFile currentINode,
+    Quota.Counts combinePosteriorAndCollectBlocks(INodeFile currentINode,
-      Util.collectBlocksAndClear((FileWithSnapshot) currentINode,
+      return updateQuotaAndCollectBlocks(currentINode, posterior,
-      return 0;
-    int destroyAndCollectBlocks(INodeFile currentINode,
+    Quota.Counts destroyDiffAndCollectBlocks(INodeFile currentINode,
-      Util.collectBlocksAndClear((FileWithSnapshot) currentINode,
+      return updateQuotaAndCollectBlocks(currentINode, this,
-      return 0;
