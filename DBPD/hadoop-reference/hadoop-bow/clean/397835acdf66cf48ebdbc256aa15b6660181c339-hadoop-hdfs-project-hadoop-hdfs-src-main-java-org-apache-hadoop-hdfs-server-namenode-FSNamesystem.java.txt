svn merge -c -1432788 for reverting HDFS-4098. Add FileWithLink, INodeFileUnderConstructionWithLink and INodeFileUnderConstructionSnapshot in order to support append to snapshotted files.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1433284 13f79535-47bb-0310-9956-ffa450edef68

-        final INodesInPath iip = dir.getINodesInPath(src);
+        long now = now();
+        final INodesInPath iip = dir.getMutableINodesInPath(src);
-        if (!iip.isSnapshot() //snapshots are readonly, so don't update atime.
-            && doAccessTime && isAccessTimeSupported()) {
-          final long now = now();
+        if (doAccessTime && isAccessTimeSupported()) {
-    if (latestSnapshot != null) {
-      file = (INodeFile)file.recordModification(latestSnapshot).left;
-    }
-    final INodeFileUnderConstruction cons
-        = INodeFileUnderConstruction.toINodeFileUnderConstruction(
-            file, leaseHolder, clientMachine, clientNode);
-
+    //TODO SNAPSHOT: INodeFileUnderConstruction with link
+    INodeFileUnderConstruction cons = new INodeFileUnderConstruction(
+                                    file.getId(),
+                                    file.getLocalNameBytes(),
+                                    file.getFileReplication(),
+                                    file.getModificationTime(),
+                                    file.getPreferredBlockSize(),
+                                    file.getBlocks(),
+                                    file.getPermissionStatus(),
+                                    leaseHolder,
+                                    clientMachine,
+                                    clientNode);
-    INodeFile newFile = pendingFile.toINodeFile(now());
+    INodeFile newFile = pendingFile.convertToInodeFile(now());
