Merging trunk to HDFS-2802 branch.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1416603 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.hdfs.protocol.HdfsFileStatus;
+import org.apache.hadoop.hdfs.server.namenode.INodeDirectory.INodesInPath;
-      INodeFile oldFile = getINodeFile(fsDir, addCloseOp.path);
+      final INodesInPath inodesInPath = fsDir.getINodesInPath(addCloseOp.path);
+      INodeFile oldFile = toINodeFile(inodesInPath.getINode(0), addCloseOp.path);
-              false);
+              false, inodesInPath.getLatestSnapshot());
-      newFile.setModificationTimeForce(addCloseOp.mtime);
+      newFile.setModificationTime(addCloseOp.mtime);
-      INodeFile oldFile = getINodeFile(fsDir, addCloseOp.path);
+      final INodesInPath inodesInPath = fsDir.getINodesInPath(addCloseOp.path);
+      INodeFile oldFile = toINodeFile(inodesInPath.getINode(0), addCloseOp.path);
-      oldFile.setModificationTimeForce(addCloseOp.mtime);
+      oldFile.setModificationTime(addCloseOp.mtime);
-        fsDir.replaceNode(addCloseOp.path, ucFile, newFile);
+        fsDir.replaceNode(addCloseOp.path, ucFile, newFile,
+            inodesInPath.getLatestSnapshot());
-      HdfsFileStatus dinfo = fsDir.getFileInfo(renameOp.dst, false);
-      fsNamesys.unprotectedChangeLease(renameOp.src, renameOp.dst, dinfo);
-
-      HdfsFileStatus dinfo = fsDir.getFileInfo(renameOp.dst, false);
-      fsNamesys.unprotectedChangeLease(renameOp.src, renameOp.dst, dinfo);
-    INode inode = fsDir.getINode(path);
+    return toINodeFile(fsDir.getINode(path), path);
+  }
+
+  private static INodeFile toINodeFile(INode inode, String path)
+      throws IOException {
