HDFS-5119. Persist CacheManager state in the edit log. (Contributed by Andrew Wang)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-4949@1529238 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.DataInput;
+import java.io.DataOutput;
+import org.apache.hadoop.fs.permission.PermissionStatus;
+import org.apache.hadoop.hdfs.util.XMLUtils;
+import org.apache.hadoop.hdfs.util.XMLUtils.InvalidXmlException;
+import org.apache.hadoop.hdfs.util.XMLUtils.Stanza;
+import org.apache.hadoop.io.Text;
+import org.xml.sax.ContentHandler;
+import org.xml.sax.SAXException;
-  
+
-    this.weight = weight != null ? weight : 100;
+    this.weight = weight != null ? weight : DEFAULT_WEIGHT;
-  public String getName() {
+  public String getPoolName() {
+
+  public void writeTo(DataOutput out) throws IOException {
+    Text.writeString(out, poolName);
+    PermissionStatus perm = PermissionStatus.createImmutable(
+        ownerName, groupName, mode);
+    perm.write(out);
+    out.writeInt(weight);
+  }
+
+  public static CachePool readFrom(DataInput in) throws IOException {
+    String poolName = Text.readString(in);
+    PermissionStatus perm = PermissionStatus.read(in);
+    int weight = in.readInt();
+    return new CachePool(poolName, perm.getUserName(), perm.getGroupName(),
+        perm.getPermission(), weight);
+  }
+
+  public void writeXmlTo(ContentHandler contentHandler) throws SAXException {
+    XMLUtils.addSaxString(contentHandler, "POOLNAME", poolName);
+    PermissionStatus perm = new PermissionStatus(ownerName,
+        groupName, mode);
+    FSEditLogOp.permissionStatusToXml(contentHandler, perm);
+    XMLUtils.addSaxString(contentHandler, "WEIGHT", Integer.toString(weight));
+  }
+
+  public static CachePool readXmlFrom(Stanza st) throws InvalidXmlException {
+    String poolName = st.getValue("POOLNAME");
+    PermissionStatus perm = FSEditLogOp.permissionStatusFromXml(st);
+    int weight = Integer.parseInt(st.getValue("WEIGHT"));
+    try {
+      return new CachePool(poolName, perm.getUserName(), perm.getGroupName(),
+          perm.getPermission(), weight);
+    } catch (IOException e) {
+      String error = "Invalid cache pool XML, missing fields.";
+      LOG.warn(error);
+      throw new InvalidXmlException(error);
+    }
+  }
