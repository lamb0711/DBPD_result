HADOOP-6930. AvroRpcEngine doesn't work with generated Avro code. Contributed by Sharad Agarwal.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@993529 13f79535-47bb-0310-9956-ffa450edef68

-import java.io.*;
-import java.util.*;
-import java.net.InetSocketAddress;
-import java.nio.ByteBuffer;
+import java.io.Closeable;
+import java.io.DataInput;
+import java.io.DataOutput;
+import java.io.IOException;
+import java.net.InetSocketAddress;
+import java.nio.ByteBuffer;
+import java.util.ArrayList;
+import java.util.List;
+
-import javax.security.auth.login.LoginException;
-import org.apache.commons.logging.*;
-
+import org.apache.avro.ipc.Responder;
+import org.apache.avro.ipc.Transceiver;
+import org.apache.avro.reflect.ReflectRequestor;
+import org.apache.avro.reflect.ReflectResponder;
+import org.apache.avro.specific.SpecificRequestor;
+import org.apache.commons.logging.Log;
+import org.apache.commons.logging.LogFactory;
+import org.apache.hadoop.classification.InterfaceStability;
-import org.apache.hadoop.net.NetUtils;
-
-import org.apache.avro.*;
-import org.apache.avro.ipc.*;
-import org.apache.avro.reflect.*;
-class AvroRpcEngine implements RpcEngine {
+@InterfaceStability.Evolving
+public class AvroRpcEngine implements RpcEngine {
-  private static class Invoker implements InvocationHandler, Closeable {
+  private class Invoker implements InvocationHandler, Closeable {
-    private final ReflectRequestor requestor;
+    private final SpecificRequestor requestor;
-      this.requestor = new ReflectRequestor(protocol, tx);
+      this.requestor = createRequestor(protocol, tx);
-  /** An Avro RPC Responder that can process requests passed via Hadoop RPC. */
-  private static class TunnelResponder extends ReflectResponder
-    implements TunnelProtocol {
+  protected SpecificRequestor createRequestor(Class<?> protocol, 
+      Transceiver transeiver) throws IOException {
+    return new ReflectRequestor(protocol, transeiver);
+  }
+  protected Responder createResponder(Class<?> iface, Object impl) {
+    return new ReflectResponder(iface, impl);
+  }
+
+  /** An Avro RPC Responder that can process requests passed via Hadoop RPC. */
+  private class TunnelResponder implements TunnelProtocol {
+    private Responder responder;
-      super(iface, impl);
+      responder = createResponder(iface, impl);
-      return new BufferListWritable(respond(request.buffers));
+      return new BufferListWritable(responder.respond(request.buffers));
