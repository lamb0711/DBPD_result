HDFS-4446. Support file snapshots with diff lists.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1443825 13f79535-47bb-0310-9956-ffa450edef68

-  void checkAndInitINode(N snapshotCopy) {
+  void checkAndInitINode(N currentINode, N snapshotCopy) {
-        @SuppressWarnings("unchecked")
-        final N right = (N)getCurrentINode().createSnapshotCopy().right;
-        snapshotCopy = right;
+        snapshotCopy = createSnapshotCopyOfCurrentINode(currentINode);
-  /** @return the current inode. */
-  abstract N getCurrentINode();
+  /** @return a snapshot copy of the current inode. */
+  abstract N createSnapshotCopyOfCurrentINode(N currentINode);
-    // get from this diff, then the posterior diff and then the current inode
+    // get from this diff, then the posterior diff
+    // and then null for the current inode
-        return getCurrentINode();
+        return null;
-  abstract void combinePosteriorAndCollectBlocks(final D posterior,
-      final BlocksMapUpdateInfo collectedBlocks);
+  abstract void combinePosteriorAndCollectBlocks(final N currentINode,
+      final D posterior, final BlocksMapUpdateInfo collectedBlocks);
+
+  @Override
+  public String toString() {
+    return getClass().getSimpleName() + ": " + snapshot + " (post="
+        + (posteriorDiff == null? null: posteriorDiff.snapshot) + ")";
+  }
