HDFS-4119. Complete the allowSnapshot code and add a test for it.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1403087 13f79535-47bb-0310-9956-ffa450edef68

+  /** @return the FSDirectory. */
+  public FSDirectory getFSDirectory() {
+    return dir;
+  }
-  // Allow snapshot on a directroy.
-  @VisibleForTesting
-  public void allowSnapshot(String snapshotRoot)
-      throws SafeModeException, IOException {
-    // TODO: implement
+  /** Allow snapshot on a directroy. */
+  public void allowSnapshot(String path) throws SafeModeException, IOException {
+    writeLock();
+    try {
+      checkOperation(OperationCategory.WRITE);
+      if (isInSafeMode()) {
+        throw new SafeModeException("Cannot allow snapshot for " + path, safeMode);
+      }
+      checkOwner(path);
+
+      //TODO: do not hardcode snapshot quota value
+      snapshotManager.setSnapshottable(path, 256);
+      getEditLog().logAllowSnapshot(path);
+    } finally {
+      writeUnlock();
+    }
+    getEditLog().logSync();
+    
+    //TODO: audit log
+        getEditLog().logCreateSnapshot(snapshotName, path);
