HDFS-4760. Update inodeMap after node replacement.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1477827 13f79535-47bb-0310-9956-ffa450edef68

-    file = file.recordModification(latestSnapshot);
+    file = file.recordModification(latestSnapshot, dir.getINodeMap());
-    pendingFile = pendingFile.recordModification(latestSnapshot);
+    pendingFile = pendingFile.recordModification(latestSnapshot,
+        dir.getINodeMap());
-      snapshotManager.setSnapshottable(path);
+      dir.writeLock();
+      try {
+        snapshotManager.setSnapshottable(path);
+      } finally {
+        dir.writeUnlock();
+      }
-      snapshotManager.resetSnapshottable(path);
+      dir.writeLock();
+      try {
+        snapshotManager.resetSnapshottable(path);
+      } finally {
+        dir.writeUnlock();
+      }
