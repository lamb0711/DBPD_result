HDFS-5619. NameNode: record ACL modifications to edit log. Contributed by Haohui Mai.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-4685@1553224 13f79535-47bb-0310-9956-ffa450edef68

-import com.google.common.collect.Lists;
-      final INodeWithAdditionalFields node = resolveINodeWithAdditionalField(src);
-      AclFeature f = node.getAclFeature();
-      if (f != null)
-        node.removeAclFeature();
+      unprotectedRemoveAcl(src);
+      fsImage.getEditLog().logSetAcl(src, AclFeature.EMPTY_ENTRY_LIST);
-  void setAcl(String src, Iterable<AclEntry> aclSpec) throws IOException {
+  private void unprotectedRemoveAcl(String src) throws UnresolvedLinkException,
+      SnapshotAccessControlException, FileNotFoundException {
+    assert hasWriteLock();
+    final INodeWithAdditionalFields node = resolveINodeWithAdditionalField(src);
+    AclFeature f = node.getAclFeature();
+    if (f != null)
+      node.removeAclFeature();
+  }
+
+  void setAcl(String src, List<AclEntry> aclSpec) throws IOException {
-      final INodeWithAdditionalFields node = resolveINodeWithAdditionalField(src);
-      AclFeature f = node.getAclFeature();
-      if (f == null) {
-        f = new AclFeature();
-        node.addAclFeature(f);
-      }
-      f.setEntries(Lists.newArrayList(aclSpec));
+      unprotectedSetAcl(src, aclSpec);
+      fsImage.getEditLog().logSetAcl(src, aclSpec);
+  void unprotectedSetAcl(String src, List<AclEntry> aclSpec)
+      throws UnresolvedLinkException, SnapshotAccessControlException,
+      FileNotFoundException {
+    assert hasWriteLock();
+    final INodeWithAdditionalFields node = resolveINodeWithAdditionalField(src);
+    AclFeature f = node.getAclFeature();
+
+    if (aclSpec.size() == 0) {
+      if (f != null)
+        node.removeAclFeature();
+      return;
+    }
+
+    if (f == null) {
+      f = new AclFeature();
+      node.addAclFeature(f);
+    }
+    f.setEntries(aclSpec);
+  }
+
