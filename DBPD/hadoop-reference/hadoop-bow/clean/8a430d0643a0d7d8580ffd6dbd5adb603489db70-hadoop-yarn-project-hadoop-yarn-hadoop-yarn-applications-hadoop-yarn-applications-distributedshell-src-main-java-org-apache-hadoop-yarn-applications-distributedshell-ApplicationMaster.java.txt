YARN-716. Fixed unit test failures - TestDistributedShell and TestUnmanagedAMLauncher. Contributed by Vinod Kumar Vavilapalli.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1485579 13f79535-47bb-0310-9956-ffa450edef68

+import java.security.PrivilegedAction;
-
+import org.apache.hadoop.security.UserGroupInformation;
+import org.apache.hadoop.security.token.Token;
-
-
+import org.apache.hadoop.yarn.security.ContainerTokenIdentifier;
+import org.apache.hadoop.yarn.util.ProtoUtils;
-      InetSocketAddress cmAddress = NetUtils.createSocketAddr(cmIpPortStr);
+      final InetSocketAddress cmAddress =
+          NetUtils.createSocketAddr(cmIpPortStr);
-      this.cm = ((ContainerManager) rpc.getProxy(ContainerManager.class,
-          cmAddress, conf));
+      UserGroupInformation ugi =
+          UserGroupInformation.createRemoteUser(container.getId().toString());
+      Token<ContainerTokenIdentifier> token =
+          ProtoUtils.convertFromProtoFormat(container.getContainerToken(),
+            cmAddress);
+      ugi.addToken(token);
+      this.cm = ugi.doAs(new PrivilegedAction<ContainerManager>() {
+        @Override
+        public ContainerManager run() {
+          return ((ContainerManager) rpc.getProxy(ContainerManager.class,
+            cmAddress, conf));
+        }
+      });
