HDFS-5501. Fix pendingReceivedRequests tracking in BPServiceActor.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2832@1541371 13f79535-47bb-0310-9956-ffa450edef68

-        ReceivedDeletedBlockInfo[] receivedAndDeletedBlockArray = null;
-          receivedAndDeletedBlockArray = perStorageMap.dequeueBlockInfos();
-          pendingReceivedRequests -= receivedAndDeletedBlockArray.length;
-          blockArrays.put(storageUuid, receivedAndDeletedBlockArray);
+          ReceivedDeletedBlockInfo[] rdbi = perStorageMap.dequeueBlockInfos();
+          pendingReceivedRequests =
+              (pendingReceivedRequests > rdbi.length ?
+                  (pendingReceivedRequests - rdbi.length) : 0);
+          blockArrays.put(storageUuid, rdbi);
-            perStorageMap.putMissingBlockInfos(rdbi);
-            pendingReceivedRequests += perStorageMap.getBlockInfoCount();
+            pendingReceivedRequests += perStorageMap.putMissingBlockInfos(rdbi);
+     * @return the number of missing blocks that we added.
-    void putMissingBlockInfos(ReceivedDeletedBlockInfo[] blockArray) {
+    int putMissingBlockInfos(ReceivedDeletedBlockInfo[] blockArray) {
+      int blocksPut = 0;
+          ++blocksPut;
+      return blocksPut;
