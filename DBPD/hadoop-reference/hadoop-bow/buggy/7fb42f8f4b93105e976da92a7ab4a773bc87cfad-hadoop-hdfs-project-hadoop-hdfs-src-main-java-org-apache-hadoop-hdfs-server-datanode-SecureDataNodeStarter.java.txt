HDFS-3951. datanode web ui does not work over HTTPS when datanode is started in secure mode. (tucu)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1387688 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.IOException;
+import java.security.GeneralSecurityException;
+import org.apache.hadoop.http.HttpConfig;
+import org.apache.hadoop.security.ssl.SSLFactory;
+import org.mortbay.jetty.Connector;
+import org.mortbay.jetty.security.SslSocketConnector;
+
+import javax.net.ssl.SSLServerSocketFactory;
-    private final SelectChannelConnector listener;
+    private final Connector listener;
-        SelectChannelConnector listener) {
+        Connector listener) {
-    public SelectChannelConnector getListener() { return listener; }
+    public Connector getListener() { return listener; }
-  
+  private SSLFactory sslFactory;
+
-    SelectChannelConnector listener = 
-                   (SelectChannelConnector)HttpServer.createDefaultChannelConnector();
+    Connector listener;
+    if (HttpConfig.isSecure()) {
+      sslFactory = new SSLFactory(SSLFactory.Mode.SERVER, conf);
+      try {
+        sslFactory.init();
+      } catch (GeneralSecurityException ex) {
+        throw new IOException(ex);
+      }
+      SslSocketConnector sslListener = new SslSocketConnector() {
+        @Override
+        protected SSLServerSocketFactory createFactory() throws Exception {
+          return sslFactory.createSSLServerSocketFactory();
+        }
+      };
+      listener = sslListener;
+    } else {
+      listener = HttpServer.createDefaultChannelConnector();
+    }
+
-    listener.open(); 
+    listener.open();
-  @Override public void destroy() { /* Nothing to do */ }
+  @Override public void destroy() {
+    sslFactory.destroy();
+  }
+
