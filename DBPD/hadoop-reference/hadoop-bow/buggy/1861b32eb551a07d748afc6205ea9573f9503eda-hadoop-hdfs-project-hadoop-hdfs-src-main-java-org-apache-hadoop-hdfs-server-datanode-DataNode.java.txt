HDFS-6808. Add command line option to ask DataNode reload configuration. (Lei Xu via Colin McCabe)

+import org.apache.hadoop.conf.ReconfigurationTaskStatus;
+   * Creates a dummy DataNode for testing purpose.
+   */
+  @VisibleForTesting
+  @InterfaceAudience.LimitedPrivate("HDFS")
+  DataNode(final Configuration conf) {
+    super(conf);
+    this.fileDescriptorPassingDisabledReason = null;
+    this.maxNumberOfBlocksToLog = 0;
+    this.confVersion = null;
+    this.usersWithLocalPathAccess = null;
+    this.connectToDnViaHostname = false;
+    this.getHdfsBlockLocationsEnabled = false;
+  }
+
+  /**
-    String oldVolumes = conf.get(DFS_DATANODE_DATA_DIR_KEY);
+    StringBuilder errorMessageBuilder = new StringBuilder();
+              errorMessageBuilder.append("FAILED TO ADD:");
+            } else {
+              errorMessageBuilder.append("ADDED:");
+            errorMessageBuilder.append(location);
+            errorMessageBuilder.append("\n");
+
+      if (errorMessageBuilder.length() > 0) {
+        throw new IOException(errorMessageBuilder.toString());
+      }
-      LOG.warn("There is IOException when refreshing volumes! "
-          + "Recover configurations: " + DFS_DATANODE_DATA_DIR_KEY
-          + " = " + oldVolumes, e);
+      LOG.warn("There is IOException when refresh volumes! ", e);
+    // wait reconfiguration thread, if any, to exit
+    shutdownReconfigurationTask();
+
+  @Override // ClientDatanodeProtocol
+  public void startReconfiguration() throws IOException {
+    checkSuperuserPrivilege();
+    startReconfigurationTask();
+  }
+
+  @Override // ClientDatanodeProtocol
+  public ReconfigurationTaskStatus getReconfigurationStatus() throws IOException {
+    checkSuperuserPrivilege();
+    return getReconfigurationTaskStatus();
+  }
+
