HADOOP-9716. Rpc retries should use the same call ID as the original call.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1504362 13f79535-47bb-0310-9956-ffa450edef68

+import java.lang.reflect.InvocationHandler;
+import java.lang.reflect.Proxy;
-import org.apache.hadoop.util.ThreadUtil;
+import org.apache.hadoop.ipc.Client;
+import org.apache.hadoop.ipc.RpcConstants;
+import org.apache.hadoop.util.ThreadUtil;
-  
-  public RetryInvocationHandler(FailoverProxyProvider proxyProvider,
+
+  RetryInvocationHandler(FailoverProxyProvider proxyProvider,
-  public RetryInvocationHandler(FailoverProxyProvider proxyProvider,
+  RetryInvocationHandler(FailoverProxyProvider proxyProvider,
+    final boolean isRpc = isRpcInvocation();
+    final int callId = isRpc? Client.nextCallId(): RpcConstants.INVALID_CALL_ID;
+
+      if (isRpc) {
+        Client.setCallId(callId);
+      }
+  private boolean isRpcInvocation() {
+    if (!Proxy.isProxyClass(currentProxy.getClass())) {
+      return false;
+    }
+    final InvocationHandler ih = Proxy.getInvocationHandler(currentProxy);
+    return ih instanceof RpcInvocationHandler;
+  }
+
