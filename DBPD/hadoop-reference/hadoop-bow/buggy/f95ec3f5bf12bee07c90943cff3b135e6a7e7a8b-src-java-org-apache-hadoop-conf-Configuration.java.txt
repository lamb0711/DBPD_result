HADOOP-6133. Add a caching layer to Configuration::getClassByName to
alleviate a performance regression introduced in a compatibility layer.
Contributed by Todd Lipcon


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@812285 13f79535-47bb-0310-9956-ffa450edef68

+
+  private static final Map<ClassLoader, Map<String, Class<?>>>
+    CACHE_CLASSES = new WeakHashMap<ClassLoader, Map<String, Class<?>>>();
-    return Class.forName(name, true, classLoader);
+    Map<String, Class<?>> map;
+    
+    synchronized (CACHE_CLASSES) {
+      map = CACHE_CLASSES.get(classLoader);
+      if (map == null) {
+        map = Collections.synchronizedMap(
+          new WeakHashMap<String, Class<?>>());
+        CACHE_CLASSES.put(classLoader, map);
+      }
+    }
+
+    Class clazz = map.get(name);
+    if (clazz == null) {
+      clazz = Class.forName(name, true, classLoader);
+      if (clazz != null) {
+        // two putters can race here, but they'll put the same class
+        map.put(name, clazz);
+      }
+    }
+
+    return clazz;
