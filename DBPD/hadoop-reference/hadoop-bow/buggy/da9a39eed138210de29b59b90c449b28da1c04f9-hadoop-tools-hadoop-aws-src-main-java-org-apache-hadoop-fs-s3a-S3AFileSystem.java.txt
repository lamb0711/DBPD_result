HADOOP-15583. Stabilize S3A Assumed Role support.
Contributed by Steve Loughran.

+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
-import org.apache.commons.io.IOUtils;
-import org.slf4j.Logger;
-import org.slf4j.LoggerFactory;
-
+  private AWSCredentialProviderList credentials;
+
+
+      credentials = createAWSCredentialProviderSet(name, conf);
-          .createS3Client(name);
+          .createS3Client(name, bucket, credentials);
-      if (metadataStore != null) {
-        metadataStore.close();
-        metadataStore = null;
-      }
-      IOUtils.closeQuietly(instrumentation);
+      S3AUtils.closeAll(LOG, metadataStore, instrumentation);
+      metadataStore = null;
+      closeAutocloseables(LOG, credentials);
+      credentials = null;
+    sb.append(", credentials=").append(credentials);
+
+  /**
+   * Get a shared copy of the AWS credentials, with its reference
+   * counter updated.
+   * Caller is required to call {@code close()} on this after
+   * they have finished using it.
+   * @param purpose what is this for? This is initially for logging
+   * @return a reference to shared credentials.
+   */
+  public AWSCredentialProviderList shareCredentials(final String purpose) {
+    LOG.debug("Sharing credentials for: {}", purpose);
+    return credentials.share();
+  }
