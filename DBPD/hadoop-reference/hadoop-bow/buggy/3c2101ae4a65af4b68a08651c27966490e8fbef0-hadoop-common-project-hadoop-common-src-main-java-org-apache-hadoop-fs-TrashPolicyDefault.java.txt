HADOOP-8110. Fix trash checkpoint collisions (Jason Lowe via daryn)


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1356897 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.fs.Options.Rename;
+  @SuppressWarnings("deprecation")
-    Path checkpoint;
+    Path checkpointBase;
-      checkpoint = new Path(trash, CHECKPOINT.format(new Date()));
+      checkpointBase = new Path(trash, CHECKPOINT.format(new Date()));
+    }
+    Path checkpoint = checkpointBase;
+
+    int attempt = 0;
+    while (true) {
+      try {
+        fs.rename(current, checkpoint, Rename.NONE);
+        break;
+      } catch (FileAlreadyExistsException e) {
+        if (++attempt > 1000) {
+          throw new IOException("Failed to checkpoint trash: "+checkpoint);
+        }
+        checkpoint = checkpointBase.suffix("-" + attempt);
+      }
-    if (fs.rename(current, checkpoint)) {
-      LOG.info("Created trash checkpoint: "+checkpoint.toUri().getPath());
-    } else {
-      throw new IOException("Failed to checkpoint trash: "+checkpoint);
-    }
+    LOG.info("Created trash checkpoint: "+checkpoint.toUri().getPath());
