HADOOP-7140. IPC Reader threads do not stop when server stops. Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1070790 13f79535-47bb-0310-9956-ffa450edef68

-    private ExecutorService readPool;
-      readPool = Executors.newFixedThreadPool(readThreads);
-        Reader reader = new Reader(readSelector);
+        Reader reader = new Reader("Socket Reader #" + (i + 1) + " for port " + port,
+                                   readSelector);
-        readPool.execute(reader);
+        reader.start();
-    private class Reader implements Runnable {
+    private class Reader extends Thread {
-      Reader(Selector readSelector) {
+      Reader(String name, Selector readSelector) {
+        super(name);
-        LOG.info("Starting SocketReader");
+        LOG.info("Starting " + getName());
+
+      void shutdown() {
+        assert !running;
+        readSelector.wakeup();
+        try {
+          join();
+        } catch (InterruptedException ie) {
+          Thread.currentThread().interrupt();
+        }
+      }
-      readPool.shutdown();
+      for (Reader r : readers) {
+        r.shutdown();
+      }
