HADOOP-8204. TestHealthMonitor fails occasionally. Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1305199 13f79535-47bb-0310-9956-ffa450edef68

-import java.net.InetSocketAddress;
-import javax.net.SocketFactory;
-
-import org.apache.hadoop.ha.protocolPB.HAServiceProtocolClientSideTranslatorPB;
-import org.apache.hadoop.net.NetUtils;
-  /** The address running the HA Service */
-  private final InetSocketAddress addrToMonitor;
+  /** The HA service to monitor */
+  private final HAServiceTarget targetToMonitor;
-  HealthMonitor(Configuration conf, InetSocketAddress addrToMonitor) {
+  HealthMonitor(Configuration conf, HAServiceTarget target) {
+    this.targetToMonitor = target;
-    this.addrToMonitor = addrToMonitor;
-      LOG.warn("Could not connect to local service at " + addrToMonitor +
+      LOG.warn("Could not connect to local service at " + targetToMonitor +
-    SocketFactory socketFactory = NetUtils.getDefaultSocketFactory(conf);
-    return new HAServiceProtocolClientSideTranslatorPB(
-        addrToMonitor,
-        conf, socketFactory, rpcTimeout);
+    return targetToMonitor.getProxy(conf, rpcTimeout);
-            addrToMonitor + ": " + t.getLocalizedMessage());
+            targetToMonitor + ": " + t.getLocalizedMessage());
-      setName("Health Monitor for " + addrToMonitor);
+      setName("Health Monitor for " + targetToMonitor);
-
-  /**
-   * Simple main() for testing.
-   */
-  public static void main(String[] args) throws InterruptedException {
-    if (args.length != 1) {
-      System.err.println("Usage: " + HealthMonitor.class.getName() +
-          " <addr to monitor>");
-      System.exit(1);
-    }
-    Configuration conf = new Configuration();
-    
-    String target = args[0];
-    InetSocketAddress addr = NetUtils.createSocketAddr(target);
-    
-    HealthMonitor hm = new HealthMonitor(conf, addr);
-    hm.start();
-    hm.join();
-  }
-
