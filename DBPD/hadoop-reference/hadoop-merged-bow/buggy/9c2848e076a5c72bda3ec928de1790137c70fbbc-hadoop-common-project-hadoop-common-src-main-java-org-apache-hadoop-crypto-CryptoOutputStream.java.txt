HADOOP-10632. Minor improvements to Crypto input and output streams. Contributed by Yi Liu

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/fs-encryption@1598485 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.conf.Configuration;
-import static org.apache.hadoop.fs.CommonConfigurationKeysPublic.HADOOP_SECURITY_CRYPTO_BUFFER_SIZE_KEY;
-import static org.apache.hadoop.fs.CommonConfigurationKeysPublic.HADOOP_SECURITY_CRYPTO_BUFFER_SIZE_DEFAULT;
-@InterfaceAudience.Public
+@InterfaceAudience.Private
-  private static final int MIN_BUFFER_SIZE = 512;
+  private final int bufferSize;
-    Preconditions.checkArgument(bufferSize >= MIN_BUFFER_SIZE, 
-        "Minimum value of buffer size is 512.");
-    this.key = key;
-    this.initIV = iv;
-    this.iv = iv.clone();
-    inBuffer = ByteBuffer.allocateDirect(bufferSize);
-    outBuffer = ByteBuffer.allocateDirect(bufferSize);
-    this.streamOffset = streamOffset;
+    this.bufferSize = CryptoStreamUtils.checkBufferSize(codec, bufferSize);
+    this.key = key.clone();
+    this.initIV = iv.clone();
+    this.iv = iv.clone();
+    inBuffer = ByteBuffer.allocateDirect(this.bufferSize);
+    outBuffer = ByteBuffer.allocateDirect(this.bufferSize);
+    this.streamOffset = streamOffset;
-      encryptor = codec.getEncryptor();
+      encryptor = codec.createEncryptor();
-    this(out, codec, getBufferSize(codec.getConf()), key, iv, streamOffset);
+    this(out, codec, CryptoStreamUtils.getBufferSize(codec.getConf()), 
+        key, iv, streamOffset);
-  /**
-   * Update the {@link #encryptor}: calculate counter and {@link #padding}.
-   */
+  /** Update the {@link #encryptor}: calculate counter and {@link #padding}. */
-      tmpBuf = new byte[outBuffer.capacity()];
+      tmpBuf = new byte[bufferSize];
-  /** Forcibly free the direct buffer. */
-  private void freeBuffers() {
-    final sun.misc.Cleaner inBufferCleaner =
-        ((sun.nio.ch.DirectBuffer) inBuffer).cleaner();
-    inBufferCleaner.clean();
-    final sun.misc.Cleaner outBufferCleaner =
-        ((sun.nio.ch.DirectBuffer) outBuffer).cleaner();
-    outBufferCleaner.clean();
-  }
-  
-  private static int getBufferSize(Configuration conf) {
-    return conf.getInt(HADOOP_SECURITY_CRYPTO_BUFFER_SIZE_KEY, 
-        HADOOP_SECURITY_CRYPTO_BUFFER_SIZE_DEFAULT);
+  /** Forcibly free the direct buffers. */
+  private void freeBuffers() {
+    CryptoStreamUtils.freeDB(inBuffer);
+    CryptoStreamUtils.freeDB(outBuffer);

MOV23 MOV31 UPD40 MOV21 UPD42 INS7 UPD66 UPD66 INS22 INS32 INS32 INS32 INS42 UPD42 UPD42 INS42 UPD42 UPD42 INS42 INS52 INS42 UPD42 MOV42 UPD42 MOV42 INS42 INS42 INS42 INS42 INS42 INS42 INS22 INS22 INS52 INS42 INS52 INS42 UPD42 INS42 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL83 DEL34 DEL42 DEL42 DEL27 DEL45 DEL32 DEL42 DEL42 DEL42 DEL42 DEL42 DEL42 DEL32 DEL83 DEL40 DEL43 DEL42 DEL40 DEL43 DEL42 DEL11 DEL36 DEL42 DEL32 DEL59 DEL60 DEL83 DEL40 DEL43 DEL42 DEL40 DEL43 DEL42 DEL11 DEL36 DEL42 DEL32 DEL59 DEL60 DEL83 DEL83 DEL39 DEL42 DEL42 DEL43 DEL42 DEL44 DEL42 DEL42 DEL42 DEL42 DEL32 DEL41 DEL8 DEL31