HADOOP-12484. Single File Rename Throws Incorrectly In Potential Race Condition Scenarios. Contributed by Gaurav Kanade.

-        SelfRenewingLease lease = fs.acquireLease(srcFile);
-
-        // Delete the file. This will free the lease too.
-        fs.getStoreInterface().delete(srcName, lease);
+        SelfRenewingLease lease = null;
+        try {
+          lease = fs.acquireLease(srcFile);
+          // Delete the file. This will free the lease too.
+          fs.getStoreInterface().delete(srcName, lease);
+        } catch(AzureException e) {
+            String errorCode = "";
+            try {
+              StorageException e2 = (StorageException) e.getCause();
+              errorCode = e2.getErrorCode();
+            } catch(Exception e3) {
+              // do nothing if cast fails
+            }
+            // If the rename already finished do nothing
+            if(!errorCode.equals("BlobNotFound")){
+              throw e;
+            }
+        } finally {
+          try {
+            if(lease != null){
+              lease.free();
+            }
+          } catch(StorageException e) {
+            LOG.warn("Unable to free lease because: " + e.getMessage());
+          }
+        }
-}
+}

INS8 MOV60 INS60 INS54 MOV43 INS59 MOV8 INS12 INS8 INS42 INS33 INS21 INS44 INS8 INS54 INS7 INS43 INS42 INS60 INS54 INS25 INS8 INS12 INS42 MOV32 INS42 INS43 INS59 INS8 INS12 INS38 INS8 INS25 INS44 INS8 INS42 INS42 INS45 INS60 INS21 INS44 INS8 INS32 INS53 INS27 INS8 INS43 INS42 INS21 INS43 INS59 INS7 INS43 INS42 INS42 INS42 INS45 INS42 INS42 INS33 INS21 INS42 INS32 INS42 INS42 INS11 INS42 INS32 INS42 INS32 INS42 INS42 INS27 INS43 INS32 INS42 INS42 INS42 INS42 INS45 INS32 INS42 INS42 INS42 INS42 INS42 DEL42 DEL59 DEL60