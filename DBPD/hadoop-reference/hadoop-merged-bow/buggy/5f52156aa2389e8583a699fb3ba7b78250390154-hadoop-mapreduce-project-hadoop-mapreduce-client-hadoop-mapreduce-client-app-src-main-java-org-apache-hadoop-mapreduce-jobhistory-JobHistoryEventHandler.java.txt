MAPREDUCE-3614. Fixed MR AM to close history file quickly and send a correct final state to the RM when it is killed. Contributed by Ravi Prakash.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1296747 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.mapreduce.TypeConverter;
-  private static final Map<JobId, MetaInfo> fileMap =
+  protected static final Map<JobId, MetaInfo> fileMap =
+  // Has a signal (SIGTERM etc) been issued?
+  protected volatile boolean isSignalled = false;
+
-    
+
+    // Process JobUnsuccessfulCompletionEvent for jobIds which still haven't
+    // closed their event writers
+    Iterator<JobId> jobIt = fileMap.keySet().iterator();
+    if(isSignalled) {
+      while (jobIt.hasNext()) {
+        JobId toClose = jobIt.next();
+        MetaInfo mi = fileMap.get(toClose);
+        if(mi != null && mi.isWriterActive()) {
+          LOG.warn("Found jobId " + toClose
+            + " to have not been closed. Will close");
+          //Create a JobFinishEvent so that it is written to the job history
+          JobUnsuccessfulCompletionEvent jucEvent =
+            new JobUnsuccessfulCompletionEvent(TypeConverter.fromYarn(toClose),
+              System.currentTimeMillis(), context.getJob(toClose)
+              .getCompletedMaps(), context.getJob(toClose).getCompletedReduces(),
+              JobState.KILLED.toString());
+          JobHistoryEvent jfEvent = new JobHistoryEvent(toClose, jucEvent);
+          //Bypass the queue mechanism which might wait. Call the method directly
+          handleEvent(jfEvent);
+        }
+      }
+    }
+
-  private class MetaInfo {
+  protected class MetaInfo {
+
+  public void setSignalled(boolean isSignalled) {
+    this.isSignalled = isSignalled;
+    LOG.info("JobHistoryEventHandler notified that isSignalled was "
+      + isSignalled);
+  }

INS26 INS40 INS23 INS31 UPD83 INS83 INS83 INS39 INS59 UPD83 INS83 INS39 INS42 INS44 INS8 INS42 INS9 INS60 INS25 INS39 INS42 INS21 INS21 INS74 INS59 INS42 INS8 INS7 INS32 INS43 INS43 INS42 INS32 INS61 INS22 INS42 INS42 INS42 INS27 INS42 INS42 INS32 INS42 INS32 INS8 INS52 INS42 INS45 INS42 INS42 INS42 INS42 INS42 INS60 INS60 INS25 INS43 INS59 INS43 INS59 INS27 INS8 INS42 INS42 INS32 INS42 INS42 INS32 INS27 INS32 INS21 INS60 INS60 INS21 INS42 INS42 INS42 INS42 INS42 INS42 INS33 INS42 INS42 INS32 INS43 INS59 INS43 INS59 INS32 INS42 INS42 INS27 INS42 INS42 INS14 INS42 INS42 INS14 INS42 INS42 INS45 INS42 INS45 INS43 INS32 INS32 INS32 INS32 INS32 INS43 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS32 INS42 INS40 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42