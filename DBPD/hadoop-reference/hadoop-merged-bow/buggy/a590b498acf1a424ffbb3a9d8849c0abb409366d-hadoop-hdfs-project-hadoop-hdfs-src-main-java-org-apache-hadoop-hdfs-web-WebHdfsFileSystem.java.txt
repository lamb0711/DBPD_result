HDFS-2528. Webhdfs: set delegation kind to WEBHDFS and add a HDFS token when http requests are redirected to datanode.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1198903 13f79535-47bb-0310-9956-ffa450edef68

+  /** Token selector */
+  public static final AbstractDelegationTokenSelector<DelegationTokenIdentifier> DT_SELECTOR
+      = new AbstractDelegationTokenSelector<DelegationTokenIdentifier>(TOKEN_KIND) {};
-  private static final DelegationTokenRenewer<WebHdfsFileSystem> dtRenewer
-      = new DelegationTokenRenewer<WebHdfsFileSystem>(WebHdfsFileSystem.class);
-  static {
-    dtRenewer.start();
+  private static DelegationTokenRenewer<WebHdfsFileSystem> DT_RENEWER = null;
+
+  private static synchronized void addRenewAction(final WebHdfsFileSystem webhdfs) {
+    if (DT_RENEWER == null) {
+      DT_RENEWER = new DelegationTokenRenewer<WebHdfsFileSystem>(WebHdfsFileSystem.class);
+      DT_RENEWER.start();
+    }
+
+    DT_RENEWER.addRenewAction(webhdfs);
-  private Token<?> renewToken;
-    Token<?> token = webhdfspTokenSelector.selectToken(
-        serviceName, ugi.getTokens());      
+    Token<?> token = DT_SELECTOR.selectToken(serviceName, ugi.getTokens());      
-        dtRenewer.addRenewAction(this);
+        addRenewAction(this);
-    return renewToken;
+    return delegationToken;
-      renewToken = token;
-      // emulate the 203 usage of the tokens
-      // by setting the kind and service as if they were hdfs tokens
-      delegationToken = new Token<T>(token);
-      // NOTE: the remote nn must be configured to use hdfs
-      delegationToken.setKind(DelegationTokenIdentifier.HDFS_DELEGATION_KIND);
-      // no need to change service because we aren't exactly sure what it
-      // should be.  we can guess, but it might be wrong if the local conf
-      // value is incorrect.  the service is a client side field, so the remote
-      // end does not care about the value
+      delegationToken = token;
-  private static final DtSelector webhdfspTokenSelector = new DtSelector();
-
-  private static class DtSelector
-      extends AbstractDelegationTokenSelector<DelegationTokenIdentifier> {
-    private DtSelector() {
-      super(TOKEN_KIND);
-    }
-  }
-

INS23 INS31 INS29 UPD83 MOV74 INS83 INS83 MOV74 INS59 INS83 INS83 INS83 INS39 INS42 INS44 INS8 INS65 INS42 INS14 INS42 INS33 INS83 INS43 INS42 INS25 INS21 INS66 INS74 INS42 INS1 INS42 INS27 INS8 INS32 UPD42 INS43 INS43 INS42 INS33 INS21 MOV21 INS42 INS42 INS42 INS42 INS42 INS7 UPD42 INS42 MOV14 UPD42 INS42 DEL42 DEL83 DEL8 DEL28 DEL83 DEL42 DEL43 DEL76 DEL74 DEL42 DEL59 DEL23 DEL42 DEL42 DEL42 DEL7 DEL21 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL14 DEL42 DEL42 DEL40 DEL32 DEL21 DEL83 DEL83 DEL83 DEL42 DEL43 DEL42 DEL42 DEL43 DEL14 DEL59 DEL23 DEL83 DEL83 DEL42 DEL83 DEL42 DEL42 DEL46 DEL8 DEL31 DEL55