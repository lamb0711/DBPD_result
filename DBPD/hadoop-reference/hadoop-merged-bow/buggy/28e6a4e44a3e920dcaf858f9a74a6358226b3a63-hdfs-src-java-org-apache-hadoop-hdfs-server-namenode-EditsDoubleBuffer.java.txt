HDFS-1073. Redesign the NameNode's storage layout for image checkpoints and edit logs to introduce transaction IDs and be more robust. Contributed by Todd Lipcon and Ivan Kelly.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1152295 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.protocol.FSConstants;
-  private DataOutputBuffer bufCurrent; // current buffer for writing
-  private DataOutputBuffer bufReady; // buffer ready for flushing
+  private TxnBuffer bufCurrent; // current buffer for writing
+  private TxnBuffer bufReady; // buffer ready for flushing
-  private Writer writer;
-    bufCurrent = new DataOutputBuffer(initBufferSize);
-    bufReady = new DataOutputBuffer(initBufferSize);
-    writer = new FSEditLogOp.Writer(bufCurrent);
+    bufCurrent = new TxnBuffer(initBufferSize);
+    bufReady = new TxnBuffer(initBufferSize);
+
-    writer.writeOp(op);
+    bufCurrent.writeOp(op);
-    DataOutputBuffer tmp = bufReady;
+    TxnBuffer tmp = bufReady;
-    writer = new FSEditLogOp.Writer(bufCurrent);
+  /**
+   * @return the transaction ID of the first transaction ready to be flushed 
+   */
+  public long getFirstReadyTxId() {
+    assert bufReady.firstTxId > 0;
+    return bufReady.firstTxId;
+  }
+
+  /**
+   * @return the number of transactions that are ready to be flushed
+   */
+  public int countReadyTxns() {
+    return bufReady.numTxns;
+  }
+
+  
+  private static class TxnBuffer extends DataOutputBuffer {
+    long firstTxId;
+    int numTxns;
+    private Writer writer;
+    
+    public TxnBuffer(int initBufferSize) {
+      super(initBufferSize);
+      writer = new FSEditLogOp.Writer(this);
+      reset();
+    }
+
+    public void writeOp(FSEditLogOp op) throws IOException {
+      if (firstTxId == FSConstants.INVALID_TXID) {
+        firstTxId = op.txid;
+      } else {
+        assert op.txid > firstTxId;
+      }
+      writer.writeOp(op);
+      numTxns++;
+    }
+    
+    @Override
+    public DataOutputBuffer reset() {
+      super.reset();
+      firstTxId = FSConstants.INVALID_TXID;
+      numTxns = 0;
+      return this;
+    }
+  }
+

INS26 INS40 INS31 INS31 INS31 INS31 INS55 INS43 INS43 MOV83 MOV42 MOV44 INS8 INS83 INS39 INS42 INS44 INS43 INS8 INS29 INS83 INS39 INS42 INS8 INS29 INS83 INS39 INS42 INS8 INS83 INS83 INS42 MOV43 INS23 INS23 MOV23 INS31 MOV31 INS31 INS42 INS42 MOV21 MOV21 MOV21 INS43 INS42 INS42 INS21 INS65 INS6 INS41 INS65 INS41 INS39 INS59 INS39 INS59 INS83 INS42 INS44 INS8 INS8 INS78 INS83 MOV43 INS42 INS8 INS42 INS32 UPD43 INS66 INS27 INS40 INS66 INS40 INS42 INS42 INS39 INS42 INS46 MOV21 INS21 INS25 MOV21 INS21 INS42 INS21 INS21 INS21 INS41 INS42 INS42 INS42 UPD42 INS40 INS34 INS42 INS32 INS27 INS8 INS8 INS37 INS48 INS7 INS7 INS52 UPD43 UPD43 INS42 INS42 INS40 INS21 INS6 INS42 INS42 INS42 INS40 INS42 INS34 UPD42 UPD42 INS52 INS7 INS27 INS42 INS40 INS40 INS42 DEL42 DEL40 DEL43 DEL42 DEL14 DEL7 DEL21 DEL8 DEL31 DEL42 DEL8