HADOOP-9717. Add retry attempt count to the RPC requests. Contributed by Jing Zhao.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1504725 13f79535-47bb-0310-9956-ffa450edef68

+  
+  /**
+   * @return The current active RPC call's retry count. -1 indicates the retry
+   *         cache is not supported in the client side.
+   */
+  public static int getCallRetryCount() {
+    Call call = CurCall.get();
+    return call != null ? call.retryCount : RpcConstants.INVALID_RETRY_COUNT;
+  }
+    private final int retryCount;        // the retry count of the call
-    private Call(int id, Writable param, Connection connection) {
-      this(id, param, connection, RPC.RpcKind.RPC_BUILTIN,
+    private Call(int id, int retryCount, Writable param, 
+        Connection connection) {
+      this(id, retryCount, param, connection, RPC.RpcKind.RPC_BUILTIN,
-    private Call(int id, Writable param, Connection connection,
+    private Call(int id, int retryCount, Writable param, Connection connection,
+      this.retryCount = retryCount;
-      return rpcRequest + " from " + connection + " Call#" + callId;
+      return rpcRequest + " from " + connection + " Call#" + callId + " Retry#"
+          + retryCount;
-    private final Call authFailedCall = 
-      new Call(AUTHORIZATION_FAILED_CALLID, null, this);
+    private final Call authFailedCall = new Call(AUTHORIZATION_FAILED_CALLID,
+        RpcConstants.INVALID_RETRY_COUNT, null, this);
-    private final Call saslCall = new Call(AuthProtocol.SASL.callId, null, this);
+    private final Call saslCall = new Call(AuthProtocol.SASL.callId,
+        RpcConstants.INVALID_RETRY_COUNT, null, this);
-        Call fakeCall =  new Call(-1, null, this);
+        Call fakeCall = new Call(-1, RpcConstants.INVALID_RETRY_COUNT, null,
+            this);
-        Call fakeCall =  new Call(-1, null, this);
+        Call fakeCall = new Call(-1, RpcConstants.INVALID_RETRY_COUNT, null,
+            this);
-        Call fakeCall =  new Call(0, null, this);
+        Call fakeCall = new Call(0, RpcConstants.INVALID_RETRY_COUNT, null,
+            this);
-      Call fakeCall =  new Call(0, null, this);
+      Call fakeCall = new Call(0, RpcConstants.INVALID_RETRY_COUNT, null, this);
+      int retry = RpcConstants.INVALID_RETRY_COUNT;
+        retry = header.getRetryCount();
-        final Call call = new Call(callId, null, this);
+        final Call call = new Call(callId, retry, null, this);
-      Call call = new Call(header.getCallId(), rpcRequest, this,
-          ProtoUtil.convert(header.getRpcKind()), header.getClientId()
-              .toByteArray());
+      Call call = new Call(header.getCallId(), header.getRetryCount(),
+          rpcRequest, this, ProtoUtil.convert(header.getRpcKind()), header
+              .getClientId().toByteArray());

INS31 INS29 INS83 INS83 INS39 INS42 INS8 INS23 INS65 INS60 INS41 INS83 INS83 INS39 INS59 INS44 INS44 MOV43 MOV43 INS66 INS66 INS43 INS59 INS16 INS42 INS39 INS42 INS39 INS42 INS21 INS60 INS42 INS42 INS32 INS27 INS40 INS40 INS42 INS7 MOV43 INS40 MOV43 INS40 MOV43 INS39 INS59 INS42 INS42 INS42 INS33 INS22 INS42 INS45 INS42 INS42 INS40 INS21 INS52 INS42 INS43 MOV43 INS40 INS7 INS32 INS42 INS42 INS32 INS42 INS42 INS43 MOV38 INS40 MOV43 INS42 INS42 INS42 MOV38 INS40 MOV42 INS42 INS40