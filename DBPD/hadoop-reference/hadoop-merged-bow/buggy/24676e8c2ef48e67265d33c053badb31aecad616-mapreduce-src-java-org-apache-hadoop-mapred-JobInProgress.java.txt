 MAPREDUCE-901. Efficient framework counters. Contributed by Luke Lu.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1157290 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.mapreduce.counters.LimitExceededException;
+    try {
+      throw new IOException("");
+    } catch (IOException ioe) {
+      LOG.info("getJC", ioe);
+    }
-    for (TaskInProgress tip : tips) {
-      counters.incrAllCounters(tip.getCounters());
+    try {
+      for (TaskInProgress tip : tips) {
+        counters.incrAllCounters(tip.getCounters());
+      }
+    } catch (LimitExceededException e) {
+      // too many user counters/groups, leaving existing counters intact.
+        if (canLaunchJobCleanupTask()) {
+          checkCountersLimitsOrFail();
+        }
+        if (canLaunchJobCleanupTask()) {
+          checkCountersLimitsOrFail();
+        }
+
+  /*
+   * add up the counters and fail the job if it exceeds the limits.
+   * Make sure we do not recalculate the counters after we fail the job.
+   * Currently this is taken care by terminateJob() since it does not
+   * calculate the counters.
+   */
+  private void checkCountersLimitsOrFail() {
+    Counters counters = getCounters();
+    if (counters.limits().violation() != null) {
+      jobtracker.failJob(this);
+    }
+  }

INS26 INS40 INS31 INS8 INS8 INS83 INS39 INS42 INS8 INS54 MOV41 INS54 MOV41 INS60 INS25 INS8 INS12 MOV8 INS12 INS43 INS59 INS27 INS8 INS53 INS44 INS8 INS44 INS8 INS42 INS42 INS32 INS32 INS33 INS21 INS14 INS43 INS42 INS21 INS43 INS42 INS42 INS32 INS42 INS32 INS43 INS45 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS52 INS42 INS42 INS42 INS45 INS42 INS25 INS25 INS32 INS8 INS32 INS8 INS42 INS21 INS42 INS21 INS32 INS32 INS42 INS42 DEL8