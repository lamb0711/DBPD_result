HADOOP6638. try to relogin in a case of failed RPC connection (expired tgt) only in case the subject is loginUser or proxyUgi.realUser.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@948523 13f79535-47bb-0310-9956-ffa450edef68

+        UserGroupInformation loginUser = UserGroupInformation.getLoginUser();
+        UserGroupInformation currentUser = UserGroupInformation.getCurrentUser();
+        UserGroupInformation realUser = currentUser.getRealUser();
-            UserGroupInformation.isLoginKeytabBased()) {
-          //try re-login
-          UserGroupInformation.getCurrentUser().reloginFromKeytab();
+          UserGroupInformation.isLoginKeytabBased() &&
+          // relogin only in case it is the login user (e.g. JT)
+          // or superuser (like oozie).
+          ((currentUser != null && currentUser.equals(loginUser)) ||
+           (realUser != null && realUser.equals(loginUser)))) {
+            //try re-login
+            loginUser.reloginFromKeytab();
-            UserGroupInformation.
-            setLastUnsuccessfulAuthenticationAttemptTime
-            (System.currentTimeMillis());
-                UserGroupInformation.getCurrentUser().getUserName() +
+                loginUser.getUserName() +
+          } catch (IOException ie) {
+            ie.initCause(je);
+            throw ie;
-        } else throw je;
+        } 
+        throw je;

INS60 INS60 INS60 MOV53 INS43 INS59 INS43 INS59 INS43 INS59 INS27 INS42 INS42 INS32 INS42 INS42 MOV32 INS42 INS42 INS32 MOV27 INS36 INS42 INS42 INS42 INS42 INS27 INS12 INS36 INS36 INS21 INS44 INS8 INS27 INS27 INS32 INS43 INS42 INS21 INS53 INS27 INS32 INS27 INS32 INS42 INS42 INS42 INS32 INS42 INS42 INS33 INS42 INS42 INS42 INS42 INS33 INS42 INS42 INS42 INS42 INS42 INS42 UPD42 MOV42 DEL42 DEL32 DEL21 DEL42 DEL42 DEL42 DEL42 DEL32 DEL32 DEL21 DEL42 DEL32