HADOOP-6543. Allows secure clients to talk to unsecure clusters. Contributed by Kan Zhang.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@915097 13f79535-47bb-0310-9956-ffa450edef68

+   * @return true if connection is set up, or false if needs to switch 
+   *             to simple Auth.
-  public void saslConnect(InputStream inS, OutputStream outS)
+  public boolean saslConnect(InputStream inS, OutputStream outS)
-        saslToken = new byte[inStream.readInt()];
+        int len = inStream.readInt();
+        if (len == SaslRpcServer.SWITCH_TO_SIMPLE_AUTH) {
+          if (LOG.isDebugEnabled())
+            LOG.debug("Server asks us to fall back to simple auth.");
+          saslClient.dispose();
+          return false;
+        }
+        saslToken = new byte[len];
+      return true;
-      saslClient.dispose();
+      try {
+        saslClient.dispose();
+      } catch (SaslException ignored) {
+        // ignore further exceptions during cleanup
+      }

UPD39 INS65 INS66 INS66 INS41 INS8 INS9 INS54 MOV53 INS60 INS25 MOV8 INS12 INS39 INS59 INS27 INS8 INS44 INS8 INS42 MOV32 INS42 INS40 INS25 INS21 INS41 INS43 INS42 INS32 INS21 INS32 INS9 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS45