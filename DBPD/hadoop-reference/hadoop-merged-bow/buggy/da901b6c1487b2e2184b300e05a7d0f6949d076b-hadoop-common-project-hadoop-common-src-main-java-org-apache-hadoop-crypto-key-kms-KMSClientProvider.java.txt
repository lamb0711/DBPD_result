Revert "HDFS-10757. KMSClientProvider combined with KeyProviderCache can result in wrong UGI being used. Contributed by Xiaoyu Yao."

This reverts commit be7237224819e2491aef91cd4f055c7efcf7b90d.

+  private final UserGroupInformation actualUgi;
+    UserGroupInformation.AuthenticationMethod authMethod =
+        UserGroupInformation.getCurrentUser().getAuthenticationMethod();
+    if (authMethod == UserGroupInformation.AuthenticationMethod.PROXY) {
+      actualUgi = UserGroupInformation.getCurrentUser().getRealUser();
+    } else if (authMethod == UserGroupInformation.AuthenticationMethod.TOKEN) {
+      actualUgi = UserGroupInformation.getLoginUser();
+    } else {
+      actualUgi =UserGroupInformation.getCurrentUser();
+    }
-      final String doAsUser = getDoAsUser();
-      conn = getActualUgi().doAs(new PrivilegedExceptionAction
-          <HttpURLConnection>() {
+      // if current UGI is different from UGI at constructor time, behave as
+      // proxyuser
+      UserGroupInformation currentUgi = UserGroupInformation.getCurrentUser();
+      final String doAsUser = (currentUgi.getAuthenticationMethod() ==
+          UserGroupInformation.AuthenticationMethod.PROXY)
+                              ? currentUgi.getShortUserName() : null;
+
+      // If current UGI contains kms-dt && is not proxy, doAs it to use its dt.
+      // Otherwise, create the HTTP connection using the UGI at constructor time
+      UserGroupInformation ugiToUse =
+          (currentUgiContainsKmsDt() && doAsUser == null) ?
+              currentUgi : actualUgi;
+      conn = ugiToUse.doAs(new PrivilegedExceptionAction<HttpURLConnection>() {
-      return getActualUgi().doAs(
+      return actualUgi.doAs(
-      return getActualUgi().doAs(
+      return actualUgi.doAs(
-        token = getActualUgi().doAs(new PrivilegedExceptionAction<Token<?>>() {
+        token = actualUgi.doAs(new PrivilegedExceptionAction<Token<?>>() {
-  private UserGroupInformation getActualUgi() throws IOException {
-    final UserGroupInformation currentUgi = UserGroupInformation
-        .getCurrentUser();
-    if (LOG.isDebugEnabled()) {
-      UserGroupInformation.logAllUserInfo(currentUgi);
-    }
-    // Use current user by default
-    UserGroupInformation actualUgi = currentUgi;
-    if (currentUgi.getRealUser() != null) {
-      // Use real user for proxy user
-      actualUgi = currentUgi.getRealUser();
-    } else if (!currentUgiContainsKmsDt() &&
-        !currentUgi.hasKerberosCredentials()) {
-      // Use login user for user that does not have either
-      // Kerberos credential or KMS delegation token for KMS operations
-      actualUgi = currentUgi.getLoginUser();
-    }
-    return actualUgi;
-  }
-

INS23 INS83 INS83 MOV43 INS59 MOV42 INS60 INS25 INS43 INS59 INS27 INS8 INS25 INS40 INS42 INS32 INS42 INS40 INS21 INS27 INS8 INS8 INS60 INS60 INS32 INS42 INS7 INS42 INS40 INS21 INS21 MOV43 MOV59 MOV43 INS59 INS42 INS42 INS42 INS32 INS7 INS7 INS16 INS42 INS16 UPD42 MOV42 UPD42 MOV42 INS32 INS42 INS42 INS32 INS42 INS32 INS36 INS32 INS33 INS36 INS42 INS42 UPD42 MOV42 INS42 INS42 INS42 INS42 INS42 INS42 INS27 INS42 UPD42 MOV42 INS27 INS32 INS40 MOV32 INS27 UPD42 MOV42 INS42 INS42 INS42 INS33 DEL32 DEL32 DEL32 DEL32 DEL32 DEL83 DEL42 DEL42 DEL43 DEL83 DEL60 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32 DEL21 DEL8 DEL25 DEL42 DEL59 DEL60 DEL42 DEL42 DEL32 DEL33 DEL27 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL8 DEL38 DEL42 DEL42 DEL32 DEL38 DEL27 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL8 DEL25 DEL25 DEL42 DEL41 DEL8 DEL31