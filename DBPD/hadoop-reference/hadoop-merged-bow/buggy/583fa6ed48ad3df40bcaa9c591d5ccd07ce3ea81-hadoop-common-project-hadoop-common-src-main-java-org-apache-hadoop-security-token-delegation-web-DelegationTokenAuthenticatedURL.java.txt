HADOOP-14445. Delegation tokens are not shared between KMS instances. Contributed by Xiao Chen and Rushabh S Shah.

-        InetSocketAddress serviceAddr = new InetSocketAddress(url.getHost(),
-            url.getPort());
-        Text service = SecurityUtil.buildTokenService(serviceAddr);
-        dToken = creds.getToken(service);
-        LOG.debug("Using delegation token {} from service:{}", dToken, service);
+        dToken = getDelegationToken(url, creds);
+   * Select a delegation token from all tokens in credentials, based on url.
+   */
+  @InterfaceAudience.Private
+  public org.apache.hadoop.security.token.Token<? extends TokenIdentifier>
+      getDelegationToken(URL url, Credentials creds) {
+    final InetSocketAddress serviceAddr =
+        new InetSocketAddress(url.getHost(), url.getPort());
+    final Text service = SecurityUtil.buildTokenService(serviceAddr);
+    org.apache.hadoop.security.token.Token<? extends TokenIdentifier> dToken =
+        creds.getToken(service);
+    LOG.debug("Selected delegation token {} using service:{}", dToken, service);
+    return dToken;
+  }
+
+  /**

INS31 INS29 INS78 INS83 INS74 INS42 INS44 INS44 INS8 INS65 INS40 INS43 INS76 INS43 INS42 INS43 INS42 MOV60 MOV60 INS60 INS21 INS41 INS66 INS40 INS43 INS42 INS42 INS83 INS83 INS74 INS59 INS32 INS42 INS42 INS43 INS76 INS42 MOV32 INS42 INS42 INS45 INS42 INS42 INS40 INS43 INS21 INS42 INS7 MOV42 INS32 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 DEL7 DEL21 DEL45 DEL42 DEL32 DEL21