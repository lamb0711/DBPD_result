HADOOP-11176. KMSClientProvider authentication fails when both currentUgi and loginUgi are a proxied user. Contributed by Arun Suresh.

-  private UserGroupInformation loginUgi;
+  private final UserGroupInformation actualUgi;
-    loginUgi = UserGroupInformation.getCurrentUser();
+    actualUgi =
+        (UserGroupInformation.getCurrentUser().getAuthenticationMethod() ==
+        UserGroupInformation.AuthenticationMethod.PROXY) ? UserGroupInformation
+            .getCurrentUser().getRealUser() : UserGroupInformation
+            .getCurrentUser();
-      conn = loginUgi.doAs(new PrivilegedExceptionAction<HttpURLConnection>() {
+      conn = actualUgi.doAs(new PrivilegedExceptionAction<HttpURLConnection>() {
-      KMSClientProvider.this.loginUgi =
-          UserGroupInformation.getCurrentUser();
-    } finally {
-      KMSClientProvider.this.loginUgi =
-          UserGroupInformation.getCurrentUser();

MOV23 INS83 UPD42 UPD42 INS16 INS36 INS32 MOV32 INS27 MOV32 INS42 INS32 INS40 UPD42 MOV32 INS42 DEL42 DEL52 DEL42 DEL22 DEL7 DEL21 DEL42 DEL52 DEL42 DEL22 DEL7 DEL21 DEL8