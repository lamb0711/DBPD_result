HADOOP-9652.  RawLocalFs#getFileLinkStatus does not fill in the link owner and mode.  (Andrew Wang via Colin Patrick McCabe)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1514088 13f79535-47bb-0310-9956-ffa450edef68

+  private static final boolean useDeprecatedFileStatus = !Stat.isAvailable();
+      if (!useDeprecatedFileStatus) {
+        return new FileStatus[] { getFileStatus(f) };
+      }
-        new RawLocalFileStatus(localf, getDefaultBlockSize(f), this) };
+        new DeprecatedRawLocalFileStatus(localf, getDefaultBlockSize(f), this)};
+    return getFileLinkStatusInternal(f, true);
+  }
+
+  @Deprecated
+  private FileStatus deprecatedGetFileStatus(Path f) throws IOException {
-      return new RawLocalFileStatus(pathToFile(f), getDefaultBlockSize(f), this);
+      return new DeprecatedRawLocalFileStatus(pathToFile(f),
+          getDefaultBlockSize(f), this);
-  static class RawLocalFileStatus extends FileStatus {
+  @Deprecated
+  static class DeprecatedRawLocalFileStatus extends FileStatus {
-    RawLocalFileStatus(File f, long defaultBlockSize, FileSystem fs) { 
+    DeprecatedRawLocalFileStatus(File f, long defaultBlockSize, FileSystem fs) {
-    FileStatus fi = getFileLinkStatusInternal(f);
+    FileStatus fi = getFileLinkStatusInternal(f, false);
-  private FileStatus getFileLinkStatusInternal(final Path f) throws IOException {
+  /**
+   * Public {@link FileStatus} methods delegate to this function, which in turn
+   * either call the new {@link Stat} based implementation or the deprecated
+   * methods based on platform support.
+   * 
+   * @param f Path to stat
+   * @param dereference whether to dereference the final path component if a
+   *          symlink
+   * @return FileStatus of f
+   * @throws IOException
+   */
+  private FileStatus getFileLinkStatusInternal(final Path f,
+      boolean dereference) throws IOException {
+    if (!useDeprecatedFileStatus) {
+      return getNativeFileLinkStatus(f, dereference);
+    } else if (dereference) {
+      return deprecatedGetFileStatus(f);
+    } else {
+      return deprecatedGetFileLinkStatusInternal(f);
+    }
+  }
+
+  /**
+   * Deprecated. Remains for legacy support. Should be removed when {@link Stat}
+   * gains support for Windows and other operating systems.
+   */
+  @Deprecated
+  private FileStatus deprecatedGetFileLinkStatusInternal(final Path f)
+      throws IOException {
+  /**
+   * Calls out to platform's native stat(1) implementation to get file metadata
+   * (permissions, user, group, atime, mtime, etc). This works around the lack
+   * of lstat(2) in Java 6.
+   * 
+   *  Currently, the {@link Stat} class used to do this only supports Linux
+   *  and FreeBSD, so the old {@link #deprecatedGetFileLinkStatusInternal(Path)}
+   *  implementation (deprecated) remains further OS support is added.
+   *
+   * @param f File to stat
+   * @param dereference whether to dereference symlinks
+   * @return FileStatus of f
+   * @throws IOException
+   */
+  private FileStatus getNativeFileLinkStatus(final Path f,
+      boolean dereference) throws IOException {
+    checkPath(f);
+    Stat stat = new Stat(f, getDefaultBlockSize(f), dereference, this);
+    FileStatus status = stat.getFileStatus();
+    return status;
+  }
-    FileStatus fi = getFileLinkStatusInternal(f);
+    FileStatus fi = getFileLinkStatusInternal(f, false);

INS23 INS31 INS31 INS31 INS83 INS83 INS83 INS39 INS59 MOV78 INS83 INS43 INS42 INS44 INS43 INS8 INS78 UPD83 UPD42 INS78 UPD42 INS29 INS83 INS43 INS42 INS44 INS44 INS43 INS8 INS29 INS78 UPD42 INS29 INS83 INS43 INS42 INS44 INS44 INS43 INS8 INS42 INS38 INS42 INS43 INS42 INS42 INS41 INS42 INS42 UPD42 INS65 INS65 INS65 INS65 INS65 INS42 INS83 INS43 INS42 INS39 INS42 INS42 INS25 INS65 INS42 INS65 INS65 INS65 INS65 INS65 INS42 INS83 INS43 INS42 INS39 INS42 INS42 INS21 INS60 INS60 INS41 INS32 INS42 INS32 INS66 INS65 INS66 INS66 INS65 INS66 INS66 INS42 INS66 INS42 INS66 INS66 INS66 INS42 INS42 INS38 INS8 INS25 INS66 INS65 INS66 INS66 INS66 INS66 INS66 INS65 INS66 INS66 INS65 INS66 INS42 INS66 INS42 INS66 INS66 INS42 INS42 INS32 INS43 INS59 MOV43 INS59 INS42 INS43 INS42 INS42 INS25 INS42 INS42 INS9 INS42 INS42 INS42 INS41 INS42 INS8 INS8 INS42 INS42 INS68 INS42 INS42 INS42 INS42 INS14 INS42 INS32 INS42 INS38 INS8 INS9 INS32 INS41 INS41 INS42 INS69 INS43 INS42 INS32 INS42 INS52 INS42 INS42 INS9 INS42 INS41 INS5 UPD43 INS42 INS42 INS42 INS32 INS32 INS43 INS42 INS42 INS42 INS3 INS43 INS85 UPD42 INS42 INS42 INS42 INS42 INS42 MOV5 INS4 INS42 UPD43 INS32 UPD42 INS42 INS42