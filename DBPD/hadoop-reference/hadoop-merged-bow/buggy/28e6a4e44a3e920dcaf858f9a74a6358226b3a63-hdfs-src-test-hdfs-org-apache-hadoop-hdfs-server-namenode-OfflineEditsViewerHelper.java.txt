HDFS-1073. Redesign the NameNode's storage layout for image checkpoints and edit logs to introduce transaction IDs and be more robust. Contributed by Todd Lipcon and Ivan Kelly.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1152295 13f79535-47bb-0310-9956-ffa450edef68

-    runOperations();
-    return getEditsFilename();
+    CheckpointSignature signature = runOperations();
+    return getEditsFilename(signature);
-  private String getEditsFilename() throws IOException {
+  private String getEditsFilename(CheckpointSignature sig) throws IOException {
-    return image.getStorage().getEditFile(sd).getAbsolutePath();
+    File ret = NNStorage.getFinalizedEditsFile(
+        sd, 1, sig.curSegmentTxId - 1);
+    assert ret.exists() : "expected " + ret + " exists";
+    return ret.getAbsolutePath();
-  private void runOperations() throws IOException {
+  private CheckpointSignature runOperations() throws IOException {
+
+    // Force a roll so we get an OP_END_LOG_SEGMENT txn
+    return cluster.getNameNode().rollEditLog();

INS44 INS43 INS60 INS43 INS42 INS60 INS6 INS41 INS42 INS41 INS43 INS59 INS42 INS43 INS59 INS32 INS27 INS32 INS32 INS42 INS42 MOV32 INS42 INS42 INS42 INS32 INS42 INS42 INS45 INS42 INS45 INS42 MOV42 INS32 INS42 UPD42 MOV42 UPD42 MOV42 MOV42 INS34 INS27 INS42 INS42 INS40 INS34 DEL21 DEL42 DEL32 DEL32 DEL32 DEL41 DEL39