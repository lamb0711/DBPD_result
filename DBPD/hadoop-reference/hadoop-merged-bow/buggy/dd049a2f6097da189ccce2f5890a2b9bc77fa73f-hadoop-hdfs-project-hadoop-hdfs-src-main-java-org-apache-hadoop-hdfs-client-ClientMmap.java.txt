HDFS-5950. The DFSClient and DataNode should use shared memory segments to communicate short-circuit information (cmccabe)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1573433 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.Closeable;
-import java.util.concurrent.atomic.AtomicInteger;
- * A memory-mapped region used by an HDFS client.
- * 
- * This class includes a reference count and some other information used by
- * ClientMmapManager to track and cache mmaps.
+ * A reference to a memory-mapped region used by an HDFS client.
-public class ClientMmap {
+public class ClientMmap implements Closeable {
-  private final ShortCircuitReplica replica;
+  private ShortCircuitReplica replica;
-   * Reference count of this ClientMmap object.
+   * Whether or not this ClientMmap anchors the replica into memory while
+   * it exists.  Closing an anchored ClientMmap unanchors the replica.
-  private final AtomicInteger refCount = new AtomicInteger(1);
+  private final boolean anchored;
-  ClientMmap(ShortCircuitReplica replica, MappedByteBuffer map) {
+  ClientMmap(ShortCircuitReplica replica, MappedByteBuffer map,
+      boolean anchored) {
+    this.anchored = anchored;
-   * Increment the reference count.
-   *
-   * @return   The new reference count.
+   * Close the ClientMmap object.
-  void ref() {
-    refCount.addAndGet(1);
-  }
-
-  /**
-   * Decrement the reference count.
-   *
-   * The parent replica gets unreferenced each time the reference count 
-   * of this object goes to 0.
-   */
-  public void unref() {
-    refCount.addAndGet(-1);
-    replica.unref();
+  @Override
+  public void close() {
+    if (replica != null) {
+      if (anchored) {
+        replica.removeNoChecksumAnchor();
+      }
+      replica.unref();
+    }
+    replica = null;

MOV26 UPD40 INS43 INS42 INS39 INS44 INS78 UPD42 INS8 UPD66 UPD42 INS39 INS42 INS21 INS42 INS25 INS21 UPD66 INS66 INS7 UPD66 INS27 INS8 INS7 INS22 INS42 INS42 INS33 INS25 MOV21 INS42 INS33 INS52 INS42 INS42 INS8 MOV21 UPD42 UPD42 DEL66 DEL66 DEL83 DEL42 DEL43 DEL42 DEL43 DEL34 DEL14 DEL66 DEL65 DEL66 DEL65 DEL29 DEL39 DEL42 DEL42 DEL42 DEL34 DEL32 DEL21 DEL8 DEL31 DEL66 DEL66 DEL34 DEL38 DEL8