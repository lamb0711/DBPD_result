HDFS-2582. Scope dfs.ha.namenodes config by nameservice. Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1207738 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Map;
-   * Returns true if HA for namenode is configured.
+   * Returns true if HA for namenode is configured for the given nameservice
+   * @param nsId nameservice, or null if no federated NS is configured
-  public static boolean isHAEnabled(Configuration conf) {
-    Collection<String> collection = DFSUtil.getNameNodeIds(conf);
-    return collection != null && !collection.isEmpty();
+  public static boolean isHAEnabled(Configuration conf, String nsId) {
+    Map<String, Map<String, InetSocketAddress>> addresses =
+      DFSUtil.getHaNnRpcAddresses(conf);
+    if (addresses == null) return false;
+    Map<String, InetSocketAddress> nnMap = addresses.get(nsId);
+    return nnMap != null && nnMap.size() > 1;
-  public static String getNameNodeId(Configuration conf) {
-    String namenodeId = conf.get(DFS_HA_NAMENODE_ID_KEY);
+  public static String getNameNodeId(Configuration conf, String nsId) {
+    String namenodeId = conf.getTrimmed(DFS_HA_NAMENODE_ID_KEY);
-    if (!isHAEnabled(conf)) {
-      return null;
-    }
-    namenodeId = DFSUtil.getSuffixIDs(conf, DFS_NAMENODE_RPC_ADDRESS_KEY,
-        DFSUtil.LOCAL_ADDRESS_MATCHER)[1];
-    if (namenodeId == null) {
+    
+    String suffixes[] = DFSUtil.getSuffixIDs(conf, DFS_NAMENODE_RPC_ADDRESS_KEY,
+        nsId, null, DFSUtil.LOCAL_ADDRESS_MATCHER);
+    if (suffixes == null) {
-    return namenodeId;
+    
+    return suffixes[1];
-    if (!isHAEnabled(conf)) {
-      return null;
-    }
-    
+

INS26 INS40 INS44 INS44 INS65 INS43 INS42 INS25 INS60 MOV43 INS42 INS60 INS41 UPD66 INS42 INS66 INS42 INS74 INS27 INS41 INS74 INS59 INS43 INS43 INS59 INS2 INS43 MOV43 INS74 UPD42 INS42 INS33 INS9 INS43 INS43 INS43 INS42 INS32 INS27 INS42 INS42 INS42 INS85 INS32 UPD42 INS42 MOV34 INS42 UPD43 MOV43 INS43 INS43 UPD42 INS42 INS42 INS42 INS42 INS42 INS42 UPD42 INS32 INS34 UPD42 MOV42 MOV42 MOV42 MOV42 INS42 INS33 MOV40 UPD42 INS42 INS42 UPD42 MOV42 UPD42 MOV42 DEL74 DEL32 DEL38 DEL42 DEL42 DEL32 DEL38 DEL33 DEL41 DEL8 DEL25 DEL42 DEL32 DEL2 DEL7 DEL21 DEL42 DEL41 DEL42 DEL42 DEL32 DEL38 DEL33 DEL41 DEL8 DEL25