HADOOP-13433 Race in UGI.reloginFromKeytab. Contributed by Duo Zhang.

+import com.google.common.annotations.VisibleForTesting;
+
+import javax.security.auth.DestroyFailedException;
-
-import com.google.common.annotations.VisibleForTesting;
+  // if the first kerberos ticket is not TGT, then remove and destroy it since
+  // the kerberos library of jdk always use the first kerberos ticket as TGT.
+  // See HADOOP-13433 for more details.
+  @VisibleForTesting
+  void fixKerberosTicketOrder() {
+    Set<Object> creds = getSubject().getPrivateCredentials();
+    synchronized (creds) {
+      for (Iterator<Object> iter = creds.iterator(); iter.hasNext();) {
+        Object cred = iter.next();
+        if (cred instanceof KerberosTicket) {
+          KerberosTicket ticket = (KerberosTicket) cred;
+          if (!ticket.getServer().getName().startsWith("krbtgt")) {
+            LOG.warn(
+                "The first kerberos ticket is not TGT"
+                    + "(the server principal is {}), remove and destroy it.",
+                ticket.getServer());
+            iter.remove();
+            try {
+              ticket.destroy();
+            } catch (DestroyFailedException e) {
+              LOG.warn("destroy ticket failed", e);
+            }
+          } else {
+            return;
+          }
+        }
+      }
+    }
+    LOG.warn("Warning, no kerberos ticket found while attempting to renew ticket");
+  }
+
-   * method assumes that {@link #loginUserFromKeytab(String, String)} had 
+   * method assumes that {@link #loginUserFromKeytab(String, String)} had
-    if (!isSecurityEnabled() ||
-         user.getAuthenticationMethod() != AuthenticationMethod.KERBEROS ||
-         !isKeytab)
+    if (!isSecurityEnabled()
+        || user.getAuthenticationMethod() != AuthenticationMethod.KERBEROS
+        || !isKeytab) {
-    
+    }
+
-    
+
-    
+
+        fixKerberosTicketOrder();
-    } 
+    }
-    if (!isSecurityEnabled() || 
-        user.getAuthenticationMethod() != AuthenticationMethod.KERBEROS ||
-        !isKrbTkt)
+    if (!isSecurityEnabled()
+        || user.getAuthenticationMethod() != AuthenticationMethod.KERBEROS
+        || !isKrbTkt) {
+    }
+      fixKerberosTicketOrder();
-    } 
+    }
-

MOV26 INS26 INS40 INS31 INS78 INS39 INS42 INS8 INS42 INS60 INS51 INS21 INS74 INS59 INS42 INS8 INS32 UPD66 INS8 INS8 INS43 INS43 INS42 INS32 INS24 INS42 INS42 INS45 INS41 INS41 INS21 INS42 INS42 INS32 INS42 INS58 INS32 INS8 INS32 INS42 INS74 INS59 INS42 INS42 INS60 INS25 INS21 INS42 INS43 INS43 INS42 INS32 INS43 INS59 INS62 INS8 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS43 INS60 INS25 INS42 INS42 INS42 INS42 INS43 INS59 INS38 INS8 INS8 INS42 INS42 INS11 INS32 INS21 INS21 INS54 INS41 INS43 INS42 INS32 INS42 INS45 INS32 INS32 INS8 INS12 INS42 INS32 INS42 INS42 INS42 INS27 INS32 INS42 INS42 INS21 INS44 INS8 INS42 INS42 INS45 INS45 INS42 INS42 INS32 INS43 INS42 INS21 INS42 INS42 INS42 INS32 INS42 INS42 INS45 INS42 DEL41 DEL41