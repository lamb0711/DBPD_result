HADOOP-13345 HS3Guard: Improved Consistency for S3A.
Contributed by: Chris Nauroth, Aaron Fabbri, Mingliang Liu, Lei (Eddy) Xu,
Sean Mackrory, Steve Loughran and others.

-  private boolean isEmptyDirectory;
+  private Tristate isEmptyDirectory;
+    this(Tristate.fromBool(isemptydir), path, owner);
+  }
+
+  /**
+   * Create a directory status.
+   * @param isemptydir is this an empty directory?
+   * @param path the path
+   * @param owner the owner
+   */
+  public S3AFileStatus(Tristate isemptydir,
+      Path path,
+      String owner) {
-    isEmptyDirectory = false;
+    isEmptyDirectory = Tristate.FALSE;
-  public boolean isEmptyDirectory() {
+  /**
+   * Convenience constructor for creating from a vanilla FileStatus plus
+   * an isEmptyDirectory flag.
+   * @param source FileStatus to convert to S3AFileStatus
+   * @param isEmptyDirectory TRUE/FALSE if known to be / not be an empty
+   *     directory, UNKNOWN if that information was not computed.
+   * @return a new S3AFileStatus
+   */
+  public static S3AFileStatus fromFileStatus(FileStatus source,
+      Tristate isEmptyDirectory) {
+    if (source.isDirectory()) {
+      return new S3AFileStatus(isEmptyDirectory, source.getPath(),
+          source.getOwner());
+    } else {
+      return new S3AFileStatus(source.getLen(), source.getModificationTime(),
+          source.getPath(), source.getBlockSize(), source.getOwner());
+    }
+  }
+
+
+  /**
+   * @return FALSE if status is not a directory, or its a dir, but known to
+   * not be empty.  TRUE if it is an empty directory.  UNKNOWN if it is a
+   * directory, but we have not computed whether or not it is empty.
+   */
+  public Tristate isEmptyDirectory() {
-        String.format(" isEmptyDirectory=%s", isEmptyDirectory());
+        String.format(" isEmptyDirectory=%s", isEmptyDirectory().name());

INS31 INS31 INS43 INS29 INS83 INS42 MOV44 INS44 INS44 INS8 INS44 INS29 INS83 INS43 INS42 INS44 INS44 INS8 INS29 INS83 INS43 INS42 MOV8 INS42 INS65 INS65 INS65 INS65 INS43 INS42 INS43 INS42 INS17 INS43 INS42 INS65 INS65 INS65 INS65 INS42 INS43 INS42 INS43 INS42 INS25 INS65 INS42 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS42 INS42 INS32 INS42 INS42 INS42 INS66 INS66 INS42 INS66 INS42 INS66 INS66 INS66 INS42 INS42 INS32 INS8 INS8 INS66 INS66 INS66 INS42 INS42 INS42 INS40 INS42 INS42 INS41 INS41 INS32 INS14 INS14 INS42 INS42 INS45 MOV32 MOV42 INS43 INS42 INS32 INS32 INS43 INS32 INS32 INS32 INS32 INS32 UPD42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL39 DEL9 DEL39 DEL42 DEL42 DEL45