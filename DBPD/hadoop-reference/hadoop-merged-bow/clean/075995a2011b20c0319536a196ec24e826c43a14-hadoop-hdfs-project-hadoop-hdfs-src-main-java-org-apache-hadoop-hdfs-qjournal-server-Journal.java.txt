Merge all changes from trunk to branch HDFS-2832

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2832@1516230 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Iterator;
-import java.util.regex.Matcher;
-import java.util.regex.Pattern;
-import org.apache.hadoop.hdfs.qjournal.protocol.QJournalProtocol;
+import org.apache.hadoop.hdfs.qjournal.protocol.QJournalProtocol;
+import org.apache.hadoop.hdfs.server.protocol.RemoteEditLog;
-      boolean forReading) throws IOException {
+      boolean forReading, boolean inProgressOk) throws IOException {
-    RemoteEditLogManifest manifest = new RemoteEditLogManifest(
-        fjm.getRemoteEditLogs(sinceTxId, forReading));
-    return manifest;
+    // if this is for reading, ignore the in-progress editlog segment
+    inProgressOk = forReading ? false : inProgressOk;
+    List<RemoteEditLog> logs = fjm.getRemoteEditLogs(sinceTxId, forReading,
+        inProgressOk);
+    
+    if (inProgressOk) {
+      RemoteEditLog log = null;
+      for (Iterator<RemoteEditLog> iter = logs.iterator(); iter.hasNext();) {
+        log = iter.next();
+        if (log.isInProgress()) {
+          iter.remove();
+          break;
+        }
+      }
+      if (log != null && log.isInProgress()) {
+        logs.add(new RemoteEditLog(log.getStartTxId(), getHighestWrittenTxId()));
+      }
+    }
+    
+    return new RemoteEditLogManifest(logs);

MOV26 MOV26 MOV26 UPD40 UPD40 INS44 INS39 INS42 INS21 INS25 INS7 INS74 INS42 INS8 INS14 INS42 INS16 INS43 INS43 UPD42 INS32 INS60 INS24 INS25 MOV43 INS42 INS42 INS9 INS42 INS42 UPD42 MOV42 MOV42 MOV42 MOV42 MOV42 INS42 INS43 INS59 INS58 INS32 INS8 INS27 INS8 INS42 INS42 INS33 INS74 INS59 INS42 INS42 INS21 INS25 INS27 INS32 INS21 INS43 INS43 INS42 INS32 INS7 INS32 INS8 INS42 INS33 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS21 INS10 INS42 INS42 INS14 INS42 INS42 INS32 INS43 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 DEL43 DEL32 DEL14 DEL42