HDFS-8323. Bump GenerationStamp for write faliure in DFSStripedOutputStream. Contributed by Tsz Wo Nicholas Sze.

-   * This method is called for recovering a failed pipeline or setting up
-   * a pipeline to append to a block.
+   * This method is called for recovering a failed write or setting up
+   * a block for appended.
-  LocatedBlock updateBlockForPipeline(ExtendedBlock block, 
+  LocatedBlock bumpBlockGenerationStamp(ExtendedBlock block,
-    LocatedBlock locatedBlock;
+    final LocatedBlock locatedBlock;
-      checkUCBlock(block, clientName);
+      final INodeFile file = checkUCBlock(block, clientName);
-      locatedBlock = new LocatedBlock(block, new DatanodeInfo[0]);
-      blockManager.setBlockToken(locatedBlock, BlockTokenIdentifier.AccessMode.WRITE);
+
+      locatedBlock = BlockManager.newLocatedBlock(
+          block, file.getLastBlock(), null, -1);
-    // when updating pipeline, the last block must be contiguous block
-    assert lastBlock instanceof BlockInfoContiguousUnderConstruction;
-    BlockInfoContiguousUnderConstruction blockinfo =
-        (BlockInfoContiguousUnderConstruction) lastBlock;
+    final BlockInfoUnderConstruction blockinfo = (BlockInfoUnderConstruction)lastBlock;
-    if (newBlock.getGenerationStamp() <= blockinfo.getGenerationStamp() ||
-        newBlock.getNumBytes() < blockinfo.getNumBytes()) {
-      String msg = "Update " + oldBlock + " (len = " + 
-        blockinfo.getNumBytes() + ") to an older state: " + newBlock + 
-        " (len = " + newBlock.getNumBytes() +")";
+    if (newBlock.getGenerationStamp() <= lastBlock.getGenerationStamp()) {
+      final String msg = "Update " + oldBlock + " but the new block " + newBlock
+          + " does not have a larger generation stamp than the last block "
+          + lastBlock;
+      LOG.warn(msg);
+      throw new IOException(msg);
+    }
+    if (newBlock.getNumBytes() < lastBlock.getNumBytes()) {
+      final String msg = "Update " + oldBlock + " (size="
+          + oldBlock.getNumBytes() + ") to a smaller size block " + newBlock
+          + " (size=" + newBlock.getNumBytes() + ")";
-    blockinfo.setNumBytes(newBlock.getNumBytes());
+    lastBlock.setNumBytes(newBlock.getNumBytes());

UPD42 INS25 UPD66 UPD66 INS83 INS83 UPD43 MOV27 MOV27 INS8 INS60 UPD42 INS60 INS21 INS53 UPD42 INS83 INS43 INS59 UPD43 UPD42 INS83 UPD42 INS83 INS43 INS59 INS32 INS14 INS42 INS42 MOV32 INS32 UPD42 INS42 INS42 INS27 INS42 INS42 INS42 INS43 INS42 INS42 INS42 INS42 INS32 INS33 INS38 UPD45 INS42 UPD45 UPD42 INS45 INS42 INS45 INS32 INS45 INS42 INS45 MOV32 INS45 INS42 INS42 INS42 INS34 INS42 INS42 DEL21 DEL42 DEL43 DEL42 DEL42 DEL43 DEL85 DEL5 DEL34 DEL3 DEL14 DEL42 DEL42 DEL42 DEL40 DEL32 DEL21 DEL42 DEL42 DEL43 DEL62 DEL6 DEL27 DEL42 DEL42 DEL32 DEL45 DEL45