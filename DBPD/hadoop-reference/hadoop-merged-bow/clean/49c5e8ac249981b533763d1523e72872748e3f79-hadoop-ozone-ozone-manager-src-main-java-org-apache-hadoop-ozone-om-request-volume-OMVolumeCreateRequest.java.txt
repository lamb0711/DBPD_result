HDDS-1672. Improve locking in OzoneManager. (#1016)



+import static org.apache.hadoop.ozone.om.lock.OzoneManagerLock.Resource.VOLUME_LOCK;
+import static org.apache.hadoop.ozone.om.lock.OzoneManagerLock.Resource.USER_LOCK;
+
+    boolean acquiredUserLock = false;
+    IOException exception = null;
-    omMetadataManager.getLock().acquireUserLock(owner);
-    omMetadataManager.getLock().acquireVolumeLock(volume);
-
-    IOException exception = null;
+    omMetadataManager.getLock().acquireLock(VOLUME_LOCK, volume);
+      acquiredUserLock = omMetadataManager.getLock().acquireLock(USER_LOCK,
+          owner);
-      omMetadataManager.getLock().releaseVolumeLock(volumeInfo.getVolume());
-      omMetadataManager.getLock().releaseUserLock(dbUserKey);
+      if (acquiredUserLock) {
+        omMetadataManager.getLock().releaseLock(USER_LOCK, owner);
+      }
+      omMetadataManager.getLock().releaseLock(VOLUME_LOCK, volume);

INS26 INS26 INS40 INS40 MOV21 INS60 INS39 INS59 INS42 INS9 UPD42 INS42 MOV21 INS25 INS7 INS42 INS8 INS42 MOV32 MOV21 UPD42 UPD42 MOV42 UPD42 MOV42 UPD42 INS42 UPD42 UPD42 INS42 DEL32