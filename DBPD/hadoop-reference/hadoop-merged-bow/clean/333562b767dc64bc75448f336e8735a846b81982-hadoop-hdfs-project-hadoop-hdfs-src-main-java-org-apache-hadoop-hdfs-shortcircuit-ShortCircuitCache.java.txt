merge from trunk r1598430

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/fs-encryption@1598435 13f79535-47bb-0310-9956-ffa450edef68

-      // If the replica is stale, but we haven't purged it yet, let's do that.
-      // It would be a shame to evict a non-stale replica so that we could put
-      // a stale one into the cache.
-      if ((!replica.purged) && replica.isStale()) {
-        purge(replica);
+      // If the replica is stale or unusable, but we haven't purged it yet,
+      // let's do that.  It would be a shame to evict a non-stale replica so
+      // that we could put a stale or unusable one into the cache.
+      if (!replica.purged) {
+        String purgeReason = null;
+        if (!replica.getDataStream().getChannel().isOpen()) {
+          purgeReason = "purging replica because its data channel is closed.";
+        } else if (!replica.getMetaStream().getChannel().isOpen()) {
+          purgeReason = "purging replica because its meta channel is closed.";
+        } else if (replica.isStale()) {
+          purgeReason = "purging replica because it is stale.";
+        }
+        if (purgeReason != null) {
+          LOG.debug(this + ": " + purgeReason);
+          purge(replica);
+        }

INS25 MOV38 INS8 INS60 INS25 MOV25 INS43 INS59 INS38 INS8 INS25 UPD27 INS42 INS42 INS33 INS32 INS21 INS38 INS8 INS25 INS42 INS33 INS21 INS32 INS42 INS7 INS32 INS21 MOV32 INS8 INS32 INS32 INS42 INS42 INS45 INS32 INS42 INS7 INS21 INS42 INS42 INS27 INS42 INS42 INS32 INS42 INS42 INS45 INS7 INS52 INS45 INS42 INS42 INS42 INS42 INS45 DEL36