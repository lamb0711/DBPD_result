HDFS-4372. Track NameNode startup progress. Contributed by Chris Nauroth.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1502120 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.server.namenode.startupprogress.Phase;
+import org.apache.hadoop.hdfs.server.namenode.startupprogress.StartupProgress;
+import org.apache.hadoop.hdfs.server.namenode.startupprogress.StartupProgress.Counter;
+import org.apache.hadoop.hdfs.server.namenode.startupprogress.Step;
+import org.apache.hadoop.hdfs.server.namenode.startupprogress.StepType;
+   * @param sdPath String storage directory path
-  public synchronized void saveSecretManagerState(DataOutputStream out)
-      throws IOException {
+  public synchronized void saveSecretManagerState(DataOutputStream out,
+      String sdPath) throws IOException {
-    saveAllKeys(out);
+    saveAllKeys(out, sdPath);
-    saveCurrentTokens(out);
+    saveCurrentTokens(out, sdPath);
-  private synchronized void saveCurrentTokens(DataOutputStream out)
-      throws IOException {
+  private synchronized void saveCurrentTokens(DataOutputStream out,
+      String sdPath) throws IOException {
+    StartupProgress prog = NameNode.getStartupProgress();
+    Step step = new Step(StepType.DELEGATION_TOKENS, sdPath);
+    prog.beginStep(Phase.SAVING_CHECKPOINT, step);
+    prog.setTotal(Phase.SAVING_CHECKPOINT, step, currentTokens.size());
+    Counter counter = prog.getCounter(Phase.SAVING_CHECKPOINT, step);
+      counter.increment();
+    prog.endStep(Phase.SAVING_CHECKPOINT, step);
-  private synchronized void saveAllKeys(DataOutputStream out)
+  private synchronized void saveAllKeys(DataOutputStream out, String sdPath)
+    StartupProgress prog = NameNode.getStartupProgress();
+    Step step = new Step(StepType.DELEGATION_KEYS, sdPath);
+    prog.beginStep(Phase.SAVING_CHECKPOINT, step);
+    prog.setTotal(Phase.SAVING_CHECKPOINT, step, currentTokens.size());
+    Counter counter = prog.getCounter(Phase.SAVING_CHECKPOINT, step);
+      counter.increment();
+    prog.endStep(Phase.SAVING_CHECKPOINT, step);
+    StartupProgress prog = NameNode.getStartupProgress();
+    Step step = new Step(StepType.DELEGATION_TOKENS);
+    prog.beginStep(Phase.LOADING_FSIMAGE, step);
+    prog.setTotal(Phase.LOADING_FSIMAGE, step, numberOfTokens);
+    Counter counter = prog.getCounter(Phase.LOADING_FSIMAGE, step);
+      counter.increment();
+    prog.endStep(Phase.LOADING_FSIMAGE, step);
+    StartupProgress prog = NameNode.getStartupProgress();
+    Step step = new Step(StepType.DELEGATION_KEYS);
+    prog.beginStep(Phase.LOADING_FSIMAGE, step);
+    prog.setTotal(Phase.LOADING_FSIMAGE, step, numberOfKeys);
+    Counter counter = prog.getCounter(Phase.LOADING_FSIMAGE, step);
+      counter.increment();
+    prog.endStep(Phase.LOADING_FSIMAGE, step);

INS26 INS26 INS26 INS26 INS26 INS40 INS40 INS40 INS40 INS40 INS44 INS44 INS44 INS65 INS43 INS42 INS43 INS42 INS60 INS60 INS21 INS21 INS60 INS21 INS43 INS42 INS60 INS60 INS21 INS21 INS60 INS21 INS60 INS60 INS21 INS21 INS60 INS21 INS60 INS60 INS21 INS21 INS60 INS21 INS42 INS66 INS42 INS42 INS43 INS59 INS43 INS59 INS32 INS32 INS43 INS59 INS32 INS42 INS43 INS59 INS43 INS59 INS32 INS32 INS43 INS59 INS32 INS43 INS59 INS43 INS59 INS32 INS32 INS43 INS59 INS32 INS43 INS59 INS43 INS59 INS32 INS32 INS43 INS59 INS32 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS14 INS42 INS42 INS40 INS42 INS42 INS42 INS40 INS42 INS32 INS42 INS42 INS32 INS21 INS42 INS42 INS40 INS42 INS42 INS42 INS32 INS42 INS42 INS14 INS42 INS42 INS40 INS42 INS42 INS42 INS40 INS42 INS32 INS42 INS42 INS32 INS21 INS42 INS42 INS40 INS42 INS42 INS42 INS32 INS42 INS42 INS14 INS42 INS42 INS40 INS42 INS42 INS42 INS40 INS42 INS42 INS42 INS42 INS32 INS21 INS42 INS42 INS40 INS42 INS42 INS42 INS32 INS42 INS42 INS14 INS42 INS42 INS40 INS42 INS42 INS42 INS40 INS42 INS42 INS42 INS42 INS32 INS21 INS42 INS42 INS40 INS42 INS42 INS42 INS43 INS40 INS42 INS42 INS42 INS42 INS42 INS40 INS42 INS32 INS42 INS42 INS43 INS40 INS42 INS42 INS42 INS42 INS42 INS40 INS42 INS32 INS42 INS42 INS43 INS40 INS42 INS42 INS40 INS42 INS32 INS42 INS42 INS43 INS40 INS42 INS42 INS40 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42