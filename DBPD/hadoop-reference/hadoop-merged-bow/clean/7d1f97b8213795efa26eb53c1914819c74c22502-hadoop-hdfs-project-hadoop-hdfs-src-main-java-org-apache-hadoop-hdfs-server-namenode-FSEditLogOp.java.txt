HDFS-3440. More effectively limit stream memory consumption when reading corrupt edit logs. Contributed by Colin Patrick McCabe.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1339978 13f79535-47bb-0310-9956-ffa450edef68

-  private static final int MAX_OP_SIZE = 100 * 1024 * 1024;
+  /**
+   * Opcode size is limited to 1.5 megabytes
+   */
+  public static final int MAX_OP_SIZE = (3 * 1024 * 1024) / 2;
+    private final StreamLimiter limiter;
-    public Reader(DataInputStream in, int logVersion) {
+    public Reader(DataInputStream in, StreamLimiter limiter, int logVersion) {
+      this.limiter = limiter;
+          limiter.setLimit(MAX_OP_SIZE);

INS29 UPD83 INS23 INS65 INS27 INS83 INS83 INS43 INS59 INS44 INS66 INS36 INS34 INS42 INS42 INS43 INS42 INS21 INS27 INS42 INS7 UPD34 MOV34 MOV34 MOV34 INS22 INS42 INS52 INS42 INS21 INS32 INS42 INS42 INS42 DEL27