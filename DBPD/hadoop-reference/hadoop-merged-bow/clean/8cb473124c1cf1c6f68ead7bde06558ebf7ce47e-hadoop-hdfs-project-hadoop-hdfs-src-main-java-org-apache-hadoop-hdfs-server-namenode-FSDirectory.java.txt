HDFS-6651. Deletion failure can leak inodes permanently. Contributed by Jing Zhao.

-  void updateCountForDelete(final INode inode, final INodesInPath iip)
-      throws QuotaExceededException {
+  void updateCountForDelete(final INode inode, final INodesInPath iip) {
-      updateCount(iip, -counts.get(Quota.NAMESPACE),
-          -counts.get(Quota.DISKSPACE), false);
+      unprotectedUpdateCount(iip, iip.length() - 1,
+          -counts.get(Quota.NAMESPACE), -counts.get(Quota.DISKSPACE));
-  private void updateCountNoQuotaCheck(INodesInPath inodesInPath,
-      int numOfINodes, long nsDelta, long dsDelta) {
+  void updateCountNoQuotaCheck(INodesInPath inodesInPath, int numOfINodes,
+      long nsDelta, long dsDelta) {
-  INodesInPath addLastINode(INodesInPath existing, INode inode,
+  @VisibleForTesting
+  public INodesInPath addLastINode(INodesInPath existing, INode inode,
-  long removeLastINode(final INodesInPath iip) throws QuotaExceededException {
+  @VisibleForTesting
+  public long removeLastINode(final INodesInPath iip) {

INS78 INS83 INS78 INS83 INS42 INS42 UPD42 INS27 INS32 INS34 INS42 INS42 DEL42 DEL43 DEL9 DEL83 DEL42 DEL43