HDFS-6094. The same block can be counted twice towards safe mode threshold. (Arpit Agarwal)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1578478 13f79535-47bb-0310-9956-ffa450edef68

+import com.google.common.annotations.VisibleForTesting;
-  DatanodeStorageInfo getStorageInfo(String storageID) {
+  @VisibleForTesting
+  public DatanodeStorageInfo getStorageInfo(String storageID) {
-      DatanodeStorageInfo storage = storageMap.get(report.getStorage().getStorageID());
-      if (storage == null) {
-        // This is seen during cluster initialization when the heartbeat
-        // is received before the initial block reports from each storage.
-        storage = updateStorage(report.getStorage());
-      }
+      DatanodeStorageInfo storage = updateStorage(report.getStorage());
+      } else if (storage.getState() != s.getState() ||
+                 storage.getStorageType() != s.getStorageType()) {
+        // For backwards compatibility, make sure that the type and
+        // state are updated. Some reports from older datanodes do
+        // not include these fields so we may have assumed defaults.
+        // This check can be removed in the next major release after
+        // 2.4.
+        storage.updateFromStorage(s);
+        storageMap.put(storage.getStorageID(), storage);

INS26 INS40 INS78 INS83 INS42 INS25 MOV32 INS27 INS8 INS27 INS27 INS21 INS21 INS32 INS32 INS32 INS32 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 DEL42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL32 DEL42 DEL33 DEL27 DEL42 DEL7 DEL21 DEL8 DEL25