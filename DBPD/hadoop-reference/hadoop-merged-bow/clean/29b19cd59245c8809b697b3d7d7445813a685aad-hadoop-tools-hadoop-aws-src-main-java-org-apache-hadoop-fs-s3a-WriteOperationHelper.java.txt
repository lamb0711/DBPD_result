HADOOP-16900. Very large files can be truncated when written through the S3A FileSystem.

Contributed by Mukund Thakur and Steve Loughran.

This patch ensures that writes to S3A fail when more than 10,000 blocks are
written. That upper bound still exists. To write massive files, make sure
that the value of fs.s3a.multipart.size is set to a size which is large
enough to upload the files in fewer than 10,000 blocks.

Change-Id: Icec604e2a357ffd38d7ae7bc3f887ff55f2d721a

+import org.apache.hadoop.fs.PathIOException;
+import static org.apache.hadoop.fs.s3a.S3AUtils.longOption;
+import static org.apache.hadoop.fs.s3a.impl.InternalConstants.DEFAULT_UPLOAD_PART_COUNT_LIMIT;
+import static org.apache.hadoop.fs.s3a.impl.InternalConstants.UPLOAD_PART_COUNT_LIMIT;
+   * The part number must be less than 10000.
+   * @throws IllegalArgumentException if the parameters are invalid -including
+   * @throws PathIOException if the part number is out of range.
-      Long offset) {
+      Long offset) throws PathIOException {
-    checkArgument(partNumber > 0 && partNumber <= 10000,
-        "partNumber must be between 1 and 10000 inclusive, but is %s",
-        partNumber);
+    checkArgument(partNumber > 0,
+        "partNumber must be between 1 and %s inclusive, but is %s",
+            DEFAULT_UPLOAD_PART_COUNT_LIMIT, partNumber);
+    long partCountLimit = longOption(conf,
+        UPLOAD_PART_COUNT_LIMIT,
+        DEFAULT_UPLOAD_PART_COUNT_LIMIT,
+        1);
+    if (partCountLimit != DEFAULT_UPLOAD_PART_COUNT_LIMIT) {
+      LOG.warn("Configuration property {} shouldn't be overridden by client",
+              UPLOAD_PART_COUNT_LIMIT);
+    }
+    final String pathErrorMsg = "Number of parts in multipart upload exceeded."
+        + " Current part count = %s, Part count limit = %s ";
+    if (partNumber > partCountLimit) {
+      throw new PathIOException(destKey,
+          String.format(pathErrorMsg, partNumber, partCountLimit));
+    }

INS26 INS26 INS26 INS26 INS40 INS40 INS40 INS40 INS43 INS65 INS65 INS42 INS21 INS60 INS25 INS60 INS25 INS66 INS42 INS66 INS42 INS66 INS32 INS39 INS59 INS27 INS8 INS83 INS43 INS59 INS27 INS8 MOV42 MOV27 INS45 INS42 INS42 INS42 INS32 INS42 INS42 INS21 INS42 INS42 INS27 INS42 INS42 INS53 INS42 INS42 INS42 INS42 INS34 INS32 INS45 INS45 INS14 INS42 INS42 INS45 INS42 INS43 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 DEL42 DEL34 DEL27 DEL27 DEL45 DEL42 DEL32 DEL21