HDFS-4077. Add support for Snapshottable Directory. Contributed by Nicholas.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1400318 13f79535-47bb-0310-9956-ffa450edef68

-   * Replaces the specified inode with the specified one.
+   * Replaces the specified INode.
-  public void replaceNode(String path, INodeFile oldnode, INodeFile newnode)
-      throws IOException, UnresolvedLinkException {    
+  private void replaceINodeUnsynced(String path, INode oldnode, INode newnode
+      ) throws IOException {    
+    //remove the old node from the namespace 
+    if (!oldnode.removeNode()) {
+      final String mess = "FSDirectory.replaceINodeUnsynced: failed to remove "
+          + path;
+      NameNode.stateChangeLog.warn("DIR* " + mess);
+      throw new IOException(mess);
+    } 
+    
+    //add the new node
+    rootDir.addNode(path, newnode); 
+  }
+
+  /**
+   * Replaces the specified INodeDirectory.
+   */
+  public void replaceINodeDirectory(String path, INodeDirectory oldnode,
+      INodeDirectory newnode) throws IOException {    
-      //
-      // Remove the node from the namespace 
-      //
-      if (!oldnode.removeNode()) {
-        NameNode.stateChangeLog.warn("DIR* FSDirectory.replaceNode: " +
-                                     "failed to remove " + path);
-        throw new IOException("FSDirectory.replaceNode: " +
-                              "failed to remove " + path);
-      } 
-      
-      /* Currently oldnode and newnode are assumed to contain the same
-       * blocks. Otherwise, blocks need to be removed from the blocksMap.
-       */
-      rootDir.addNode(path, newnode); 
+      replaceINodeUnsynced(path, oldnode, newnode);
+      //update children's parent directory
+      for(INode i : newnode.getChildren()) {
+        i.parent = newnode;
+      }
+    } finally {
+      writeUnlock();
+    }
+  }
+
+  /**
+   * Replaces the specified INodeFile with the specified one.
+   */
+  public void replaceNode(String path, INodeFile oldnode, INodeFile newnode
+      ) throws IOException {    
+    writeLock();
+    try {
+      replaceINodeUnsynced(path, oldnode, newnode);
+      
+      //Currently, oldnode and newnode are assumed to contain the same blocks.
+      //Otherwise, blocks need to be removed from the blocksMap.

INS31 INS31 INS29 INS83 INS39 INS42 INS44 INS44 INS44 INS43 INS8 INS29 INS83 INS39 INS42 INS44 INS44 INS44 INS43 INS8 INS65 INS43 INS42 INS43 INS42 INS43 INS42 INS42 INS25 MOV21 INS65 INS43 INS42 INS43 INS42 INS43 INS42 INS42 INS21 INS54 INS66 INS42 INS42 INS42 MOV38 INS8 INS66 INS42 INS42 INS42 INS32 INS8 INS8 UPD66 INS60 INS21 INS53 INS42 INS21 INS70 INS21 MOV21 INS83 INS43 INS59 INS32 INS14 INS32 INS44 INS32 INS8 INS32 INS42 INS42 INS27 INS40 INS42 INS27 MOV43 INS42 INS42 INS42 INS42 INS42 INS43 INS42 INS42 INS42 INS21 INS42 UPD42 INS42 INS42 INS42 INS45 INS42 INS45 INS42 INS42 INS7 INS40 INS42 DEL42 DEL43 DEL40 DEL45 DEL45 DEL42 DEL27 DEL45 DEL45 DEL42 DEL27 DEL14 DEL53 DEL8 DEL25