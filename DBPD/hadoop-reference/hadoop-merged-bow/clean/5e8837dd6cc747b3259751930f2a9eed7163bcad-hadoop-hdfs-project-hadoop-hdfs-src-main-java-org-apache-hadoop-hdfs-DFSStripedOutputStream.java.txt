HDFS-8120. Erasure coding: created util class to analyze striped block groups. Contributed by Zhe Zhang and Li Bo.

+import org.apache.hadoop.hdfs.util.StripedBlockUtil;
-        } else {
-          streamer.countTailingBlockGroupBytes();
-
+    assert leadingStreamer != null : "One streamer should be leader";
-    if(currentBlockGroupBytes == 0 ||
-        currentBlockGroupBytes % stripeDataSize() == 0)
+    long parityBlkSize = StripedBlockUtil.getInternalBlockLength(
+        currentBlockGroupBytes, cellSize, blockGroupDataBlocks,
+        blockGroupDataBlocks + 1);
+    if (parityBlkSize == 0 || currentBlockGroupBytes % stripeDataSize() == 0) {
-    int lastStripeLen =(int)(currentBlockGroupBytes % stripeDataSize());
-    // Size of parity cells should equal the size of the first cell, if it
-    // is not full.
-    int parityCellSize = cellSize;
-    int index = lastStripeLen / cellSize;
-    if (lastStripeLen < cellSize) {
-      parityCellSize = lastStripeLen;
-      index++;
+    int parityCellSize = parityBlkSize % cellSize == 0 ? cellSize :
+                        (int) (parityBlkSize % cellSize);
+
-      if (i >= index) {
+      long internalBlkLen = StripedBlockUtil.getInternalBlockLength(
+          currentBlockGroupBytes, cellSize, blockGroupDataBlocks, i);
+      // Pad zero bytes to make all cells exactly the size of parityCellSize
+      // If internal block is smaller than parity block, pad zero bytes.
+      // Also pad zero bytes to all parity cells
+      if (internalBlkLen < parityBlkSize || i >= blockGroupDataBlocks) {
+        assert position <= parityCellSize : "If an internal block is smaller" +
+            " than parity block, then its last cell should be small than last" +
+            " parity cell";
-          cellBuffers[i].put((byte)0);
+          cellBuffers[i].put((byte) 0);

INS26 INS40 MOV25 INS6 INS60 INS27 INS45 UPD39 INS8 MOV39 INS59 INS42 INS33 INS42 INS32 INS41 MOV42 INS16 INS60 INS42 INS42 INS42 UPD42 MOV42 INS42 INS27 UPD42 INS27 INS42 INS11 INS39 INS59 INS27 INS42 INS34 INS27 INS34 INS39 INS36 INS42 INS32 INS27 INS27 INS6 UPD42 MOV42 MOV42 INS27 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 MOV42 UPD42 MOV42 INS27 INS27 INS42 INS42 INS42 INS42 INS45 INS45 INS45 DEL42 DEL42 DEL32 DEL21 DEL8 DEL42 DEL39 DEL42 DEL32 DEL27 DEL36 DEL11 DEL41 DEL42 DEL59 DEL60 DEL39 DEL42 DEL27 DEL59 DEL60 DEL42 DEL42 DEL27 DEL42 DEL42 DEL7 DEL21 DEL42 DEL37 DEL21 DEL8 DEL25 DEL27