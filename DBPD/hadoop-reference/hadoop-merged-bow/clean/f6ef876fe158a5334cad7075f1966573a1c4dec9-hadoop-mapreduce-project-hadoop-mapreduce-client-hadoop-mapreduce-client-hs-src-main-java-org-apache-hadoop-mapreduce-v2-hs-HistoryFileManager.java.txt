MAPREDUCE-6657. Job history server can fail on startup when NameNode is in start phase. Contributed by Haibo Chen.

+import org.apache.hadoop.hdfs.server.common.HdfsServerConstants;
+import org.apache.hadoop.hdfs.server.namenode.NameNode;
+import org.apache.hadoop.ipc.RetriableException;
+   * Check if the NameNode is still not started yet as indicated by the
+   * exception type and message.
-   * being in safe mode.
+   * being in safe mode. In addition, Name Node may have not started yet, in
+   * which case, the message contains "NameNode still not started".
-  private boolean isBecauseSafeMode(Throwable ex) {
-    return ex.toString().contains("SafeModeException");
+  private boolean isNameNodeStillNotStarted(Exception ex) {
+    String nameNodeNotStartedMsg = NameNode.composeNotStartedMessage(
+        HdfsServerConstants.NamenodeRole.NAMENODE);
+    return ex.toString().contains("SafeModeException") ||
+        (ex instanceof RetriableException && ex.getMessage().contains(
+            nameNodeNotStartedMsg));
-      if (isBecauseSafeMode(e)) {
+      if (isNameNodeStillNotStarted(e)) {
-        if (isBecauseSafeMode(e)) {
+        if (isNameNodeStillNotStarted(e)) {

INS26 INS26 INS26 INS40 INS40 INS40 UPD42 UPD43 INS60 INS66 INS66 UPD66 INS66 UPD42 INS43 INS59 INS27 INS42 INS42 INS32 MOV32 INS36 INS42 INS42 INS40 INS27 INS62 INS32 INS42 INS43 INS32 INS42 INS42 UPD42 INS42 INS42 INS42 UPD42