Merge branch 'trunk' into HADOOP-12756

+import static org.apache.hadoop.security.UGIExceptionMessages.*;
-import java.util.HashSet;
-
-  /**
-   * Copies the Subject of this UGI and creates a new UGI with the new subject.
-   * This can be used to add credentials (e.g. tokens) to different copies of
-   * the same UGI, allowing multiple users with different tokens to reuse the
-   * UGI without re-authenticating with Kerberos.
-   * @return clone of the UGI with a new subject.
-   */
-  @InterfaceAudience.Public
-  @InterfaceStability.Evolving
-  public UserGroupInformation copySubjectAndUgi() {
-    Subject subj = getSubject();
-    // The ctor will set other fields automatically from the principals.
-    return new UserGroupInformation(new Subject(false, subj.getPrincipals(),
-        cloneCredentials(subj.getPublicCredentials()),
-        cloneCredentials(subj.getPrivateCredentials())));
-  }
-
-  private static Set<Object> cloneCredentials(Set<Object> old) {
-    Set<Object> set = new HashSet<>();
-    // Make sure Hadoop credentials objects do not reuse the maps.
-    for (Object o : old) {
-      set.add(o instanceof Credentials ? new Credentials((Credentials)o) : o);
-    }
-    return set;
-  }
-
+  
-      throw new IOException("failure to login using ticket cache file " +
-          ticketCache, le);
+      KerberosAuthException kae =
+          new KerberosAuthException(FAILURE_TO_LOGIN, le);
+      kae.setUser(user);
+      kae.setTicketCacheFile(ticketCache);
+      throw kae;
-   * @throws IOException        if the kerberos login fails
+   * @throws IOException
+   * @throws KerberosAuthException if the kerberos login fails
-      throw new IOException("Subject must not be null");
+      throw new KerberosAuthException(SUBJECT_MUST_NOT_BE_NULL);
-      throw new IOException("Provided Subject must contain a KerberosPrincipal");
+      throw new KerberosAuthException(SUBJECT_MUST_CONTAIN_PRINCIPAL);
-      throw new IOException("failure to login: " + le, le);
+      throw new KerberosAuthException(FAILURE_TO_LOGIN, le);
-   * @throws IOException if the keytab file can't be read
+   * @throws IOException
+   * @throws KerberosAuthException if it's a kerberos login exception.
-      throw new IOException("Login failure for " + user + " from keytab " + 
-                            path+ ": " + le, le);
+      KerberosAuthException kae = new KerberosAuthException(LOGIN_FAILURE, le);
+      kae.setUser(user);
+      kae.setKeytabFile(path);
+      throw kae;
-   * @throws IOException if a failure occurred in logout, or if the user did
-   * not log in by invoking loginUserFromKeyTab() before.
+   * @throws IOException
+   * @throws KerberosAuthException if a failure occurred in logout,
+   * or if the user did not log in by invoking loginUserFromKeyTab() before.
-      throw new IOException("loginUserFromKeytab must be done first");
+      throw new KerberosAuthException(MUST_FIRST_LOGIN_FROM_KEYTAB);
-      throw new IOException("Logout failure for " + user + " from keytab " +
-          keytabFile + ": " + le,
-          le);
+      KerberosAuthException kae = new KerberosAuthException(LOGOUT_FAILURE, le);
+      kae.setUser(user.toString());
+      kae.setKeytabFile(keytabFile);
+      throw kae;
+   * @throws KerberosAuthException if it's a kerberos login exception.
-   * @throws IOException on a failure
+   * @throws IOException
+   * @throws KerberosAuthException on a failure
-  public synchronized void reloginFromKeytab()
-  throws IOException {
+  public synchronized void reloginFromKeytab() throws IOException {
-      throw new IOException("loginUserFromKeyTab must be done first");
+      throw new KerberosAuthException(MUST_FIRST_LOGIN_FROM_KEYTAB);
-      throw new IOException("Login failure for " + keytabPrincipal + 
-          " from keytab " + keytabFile + ": " + le, le);
+      KerberosAuthException kae = new KerberosAuthException(LOGIN_FAILURE, le);
+      kae.setPrincipal(keytabPrincipal);
+      kae.setKeytabFile(keytabFile);
+      throw kae;
-   * @throws IOException on a failure
+   * @throws IOException
+   * @throws KerberosAuthException on a failure
-  public synchronized void reloginFromTicketCache()
-  throws IOException {
+  public synchronized void reloginFromTicketCache() throws IOException {
-      throw new IOException("login must be done first");
+      throw new KerberosAuthException(MUST_FIRST_LOGIN);
-      throw new IOException("Login failure for " + getUserName() + ": " + le,
-          le);
+      KerberosAuthException kae = new KerberosAuthException(LOGIN_FAILURE, le);
+      kae.setUser(getUserName());
+      throw kae;
-      throw new IOException("Login failure for " + user + " from keytab " + 
-                            path + ": " + le, le);
+      KerberosAuthException kae = new KerberosAuthException(LOGIN_FAILURE, le);
+      kae.setUser(user);
+      kae.setKeytabFile(path);
+      throw kae;
-        if (iter.next() instanceof Token.PrivateToken) {
+        if (iter.next().isPrivate()) {

MOV26 UPD40 INS65 INS65 INS65 INS65 INS65 INS65 INS42 UPD42 UPD66 INS42 UPD42 UPD66 INS42 UPD42 UPD66 UPD66 INS42 INS66 INS42 UPD42 INS42 UPD42 MOV44 MOV44 INS8 INS60 INS21 INS21 INS53 INS60 INS21 INS21 INS53 INS60 INS21 INS21 INS53 INS60 INS21 INS21 INS53 INS60 INS21 INS53 INS60 INS21 INS21 INS53 INS43 INS59 INS32 INS32 INS42 UPD43 INS42 UPD43 INS42 INS42 INS43 INS59 INS32 INS32 INS42 UPD43 INS42 INS43 INS59 INS32 INS32 INS42 UPD43 INS42 INS43 INS59 INS32 INS32 INS42 UPD43 INS42 INS43 INS59 INS32 INS42 INS43 INS59 INS32 INS32 INS42 INS42 INS42 INS14 INS42 INS42 INS42 INS42 INS42 INS42 UPD42 UPD42 UPD43 INS42 UPD42 MOV42 INS42 INS14 INS42 INS42 INS42 INS42 INS42 INS42 UPD42 UPD42 MOV42 INS42 INS14 INS42 INS42 INS32 INS42 INS42 INS42 UPD42 UPD42 MOV42 INS42 INS14 INS42 INS42 INS42 INS42 INS42 INS42 UPD42 INS42 INS42 INS14 INS42 INS42 MOV32 UPD42 MOV42 INS42 INS14 INS42 INS42 INS42 INS42 INS42 INS42 INS32 UPD43 MOV43 INS42 MOV42 UPD42 INS43 INS42 INS42 UPD43 MOV43 INS42 INS42 INS42 INS42 INS43 INS42 INS42 UPD43 MOV43 INS42 MOV42 INS43 INS42 INS42 MOV32 INS42 UPD42 INS42 UPD42 INS42 UPD42 INS42 DEL66 DEL66 DEL66 DEL66 DEL65 DEL66 DEL65 DEL29 DEL40 DEL78 DEL40 DEL78 DEL83 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL43 DEL42 DEL43 DEL9 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32 DEL32 DEL42 DEL42 DEL42 DEL32 DEL32 DEL14 DEL14 DEL41 DEL8 DEL31 DEL83 DEL83 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL44 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL42 DEL43 DEL74 DEL14 DEL59 DEL60 DEL42 DEL43 DEL42 DEL44 DEL42 DEL42 DEL42 DEL42 DEL42 DEL43 DEL62 DEL42 DEL43 DEL42 DEL43 DEL42 DEL11 DEL14 DEL42 DEL16 DEL32 DEL21 DEL8 DEL70 DEL42 DEL41 DEL8 DEL31 DEL45 DEL42 DEL27 DEL14 DEL53 DEL45 DEL45 DEL45 DEL42 DEL27 DEL43 DEL45 DEL42 DEL45 DEL42 DEL45 DEL42 DEL27 DEL42 DEL14 DEL53 DEL45 DEL45 DEL42 DEL45 DEL42 DEL45 DEL42 DEL27 DEL42 DEL14 DEL53 DEL8 DEL45 DEL43 DEL45 DEL42 DEL45 DEL42 DEL45 DEL42 DEL27 DEL42 DEL14 DEL53 DEL45 DEL45 DEL45 DEL42 DEL27 DEL14 DEL53 DEL43 DEL45 DEL42 DEL45 DEL42 DEL45 DEL42 DEL27 DEL42 DEL14 DEL53 DEL40 DEL43 DEL62