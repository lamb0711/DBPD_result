HDFS-3391. Fix InvalidateBlocks to compare blocks including their generation stamps. Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1339897 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.Collection;
-  /** Does this contain the block which is associated with the storage? */
+  /**
+   * @return true if the given storage has the given block listed for
+   * invalidation. Blocks are compared including their generation stamps:
+   * if a block is pending invalidation but with a different generation stamp,
+   * returns false.
+   * @param storageID the storage to check
+   * @param the block to look for
+   * 
+   */
-    final Collection<Block> s = node2blocks.get(storageID);
-    return s != null && s.contains(block);
+    final LightWeightHashSet<Block> s = node2blocks.get(storageID);
+    if (s == null) {
+      return false; // no invalidate blocks for this storage ID
+    }
+    Block blockInSet = s.getElement(block);
+    return blockInSet != null &&
+        block.getGenerationStamp() == blockInSet.getGenerationStamp();

UPD65 INS65 INS65 INS25 INS60 UPD66 INS66 INS66 INS66 INS42 INS66 INS42 INS66 UPD74 INS27 INS8 INS43 INS59 UPD43 INS42 INS33 INS41 INS42 INS42 INS32 INS27 UPD42 INS9 INS42 INS42 INS42 UPD42 INS32 INS32 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 INS42 DEL40 DEL26 DEL32