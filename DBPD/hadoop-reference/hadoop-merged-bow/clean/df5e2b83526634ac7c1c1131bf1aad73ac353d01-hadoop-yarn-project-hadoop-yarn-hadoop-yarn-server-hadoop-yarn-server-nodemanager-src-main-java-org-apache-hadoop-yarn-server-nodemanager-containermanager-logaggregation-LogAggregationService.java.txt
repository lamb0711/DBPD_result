MAPREDUCE-4323. NM leaks filesystems (Jason Lowe via jeagles)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1375164 13f79535-47bb-0310-9956-ffa450edef68

-import com.google.common.annotations.VisibleForTesting;
-  private void createAppDir(final String user, final ApplicationId appId,
+  protected void createAppDir(final String user, final ApplicationId appId,
-  @VisibleForTesting
-  public void initAppAggregator(final ApplicationId appId, String user,
+  protected void initAppAggregator(final ApplicationId appId, String user,
-    UserGroupInformation userUgi =
+    final UserGroupInformation userUgi =
-    // Create the app dir
-    createAppDir(user, appId, userUgi);
-
+    // wait until check for existing aggregator to create dirs
+    try {
+      // Create the app dir
+      createAppDir(user, appId, userUgi);
+    } catch (YarnException e) {
+      closeFileSystems(userUgi);
+      throw e;
+    }
+          closeFileSystems(userUgi);
+  protected void closeFileSystems(final UserGroupInformation userUgi) {
+    try {
+      FileSystem.closeAllForUGI(userUgi);
+    } catch (IOException e) {
+      LOG.warn("Failed to close filesystems: ", e);
+    }
+  }
+

INS31 UPD83 UPD83 INS83 INS39 INS42 INS44 INS8 INS54 INS83 INS43 INS42 INS54 INS83 INS8 INS12 INS42 INS8 INS12 MOV21 INS44 INS8 INS21 INS44 INS8 INS43 INS42 INS21 INS53 INS32 INS43 INS42 INS21 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS45 INS42 INS21 INS32 INS42 INS42 DEL40 DEL26 DEL42 DEL78