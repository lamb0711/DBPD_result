HDFS-3343. Improve metrics for DN read latency. Contributed by Andrew Wang.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1356928 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.metrics2.lib.MutableRate;
+import org.apache.hadoop.util.Progressable;
-   * {@link FileChannel#transferTo(long, long, WritableByteChannel)}. 
+   * {@link FileChannel#transferTo(long, long, WritableByteChannel)}.
+   * Updates <code>waitForWritableTime</code> and <code>transferToTime</code>
+   * with the time spent blocked on the network and the time spent transferring
+   * data from disk to network respectively.
+   * @param waitForWritableTime updated by the nanoseconds spent waiting for 
+   * the socket to become writable
+   * @param transferTime updated by the nanoseconds spent transferring data
-  public void transferToFully(FileChannel fileCh, long position, int count) 
-                              throws IOException {
-    
+  public void transferToFully(FileChannel fileCh, long position, int count,
+      MutableRate waitForWritableTime,
+      MutableRate transferToTime) throws IOException {
+    long waitTime = 0;
+    long transferTime = 0;
+      long start = System.nanoTime();
+      long wait = System.nanoTime();
+
+      long transfer = System.nanoTime();
+      waitTime += wait - start;
+      transferTime += transfer - wait;
-  }  
+
+    if (waitForWritableTime != null) {
+      waitForWritableTime.add(waitTime);
+    }
+    if (transferToTime != null) {
+      transferToTime.add(transferTime);
+    }
+  }
+
+  /**
+   * Call
+   * {@link #transferToFully(FileChannel, long, int, MutableRate, MutableRate)}
+   * with null <code>waitForWritableTime</code> and <code>transferToTime</code>
+   */
+  public void transferToFully(FileChannel fileCh, long position, int count)
+      throws IOException {
+    transferToFully(fileCh, position, count, null, null);
+  }

INS26 INS26 INS40 INS40 INS31 INS44 INS44 INS29 INS83 INS39 INS42 INS44 INS44 INS44 INS43 INS8 INS65 INS65 INS43 INS42 INS43 INS42 INS60 INS60 INS25 INS25 INS65 INS43 INS42 INS39 INS42 INS39 INS42 INS42 INS21 UPD66 INS66 INS66 INS66 INS42 INS66 INS66 INS42 INS66 INS42 INS42 INS39 INS59 INS39 INS59 INS27 INS8 INS27 INS8 INS66 INS65 INS66 INS42 INS32 INS42 INS34 INS42 INS34 INS60 INS60 INS60 INS21 INS21 INS42 INS33 INS21 INS42 INS33 INS21 INS68 INS42 INS42 INS42 INS42 INS33 INS33 INS39 INS59 INS39 INS59 INS39 INS59 INS7 INS7 INS32 INS32 INS42 INS69 INS69 INS69 INS69 INS69 INS42 INS32 INS42 INS32 INS42 INS32 INS42 INS27 INS42 INS27 INS42 INS42 INS42 INS42 INS42 INS42 INS43 INS39 INS39 INS43 INS43 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42