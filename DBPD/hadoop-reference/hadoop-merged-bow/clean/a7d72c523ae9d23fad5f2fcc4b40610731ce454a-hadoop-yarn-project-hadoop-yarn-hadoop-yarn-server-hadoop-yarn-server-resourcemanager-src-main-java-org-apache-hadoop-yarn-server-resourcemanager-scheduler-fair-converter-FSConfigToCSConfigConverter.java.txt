YARN-10099. FS-CS converter: handle allow-undeclared-pools and user-as-default-queue properly and fix misc issues. Contributed by Peter Bacsko

+import javax.xml.parsers.DocumentBuilder;
+import javax.xml.parsers.DocumentBuilderFactory;
+
+import org.apache.hadoop.fs.FileSystem;
+import org.apache.hadoop.yarn.security.ConfiguredYarnAuthorizer;
+import org.apache.hadoop.yarn.security.YarnAuthorizationProvider;
+import org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.AllocationFileLoaderService;
+import org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.allocation.AllocationFileParser;
+import org.w3c.dom.Document;
+import org.w3c.dom.Element;
+import org.w3c.dom.NodeList;
-  private Configuration yarnSiteConfig;
+  private Configuration convertedYarnSiteConfig;
-    Configuration conf = createConfiguration(params);
-    handleFairSchedulerConfig(params, conf);
+    Configuration inputYarnSiteConfig = getInputYarnSiteConfig(params);
+    handleFairSchedulerConfig(params, inputYarnSiteConfig);
-    convert(conf);
+    convert(inputYarnSiteConfig);
-  private Configuration createConfiguration(
+  private Configuration getInputYarnSiteConfig(
-    conf.setBoolean(FairSchedulerConfiguration.MIGRATION_MODE, true);
-    conf.setBoolean(FairSchedulerConfiguration.NO_TERMINAL_RULE_CHECK,
-        conversionOptions.isNoRuleTerminalCheck());
-  void convert(Configuration conf) throws Exception {
+  void convert(Configuration inputYarnSiteConfig) throws Exception {
+    // Prepare a separate config for the FS instance
+    // to force the use of ConfiguredYarnAuthorizer, otherwise
+    // it might use that of Ranger
+    Configuration fsConfig = new Configuration(inputYarnSiteConfig);
+    fsConfig.setBoolean(FairSchedulerConfiguration.MIGRATION_MODE, true);
+    fsConfig.setBoolean(FairSchedulerConfiguration.NO_TERMINAL_RULE_CHECK,
+        conversionOptions.isNoRuleTerminalCheck());
+    fsConfig.setClass(YarnConfiguration.YARN_AUTHORIZATION_PROVIDER,
+        ConfiguredYarnAuthorizer.class, YarnAuthorizationProvider.class);
-    fs.init(conf);
+    fs.init(fsConfig);
+    boolean havePlacementPolicies =
+        checkPlacementPoliciesPresent(fs, inputYarnSiteConfig);
-    yarnSiteConfig = new Configuration(false);
+    convertedYarnSiteConfig = new Configuration(false);
-    convertYarnSiteXml(conf);
+    convertYarnSiteXml(inputYarnSiteConfig, havePlacementPolicies);
-    yarnSiteConfig.writeXml(yarnSiteOutputStream);
+    convertedYarnSiteConfig.writeXml(yarnSiteOutputStream);
-  private void convertYarnSiteXml(Configuration conf) {
+  private void convertYarnSiteXml(Configuration inputYarnSiteConfig,
+      boolean havePlacementPolicies) {
-    siteConverter.convertSiteProperties(conf, yarnSiteConfig, drfUsed);
+    siteConverter.convertSiteProperties(inputYarnSiteConfig,
+        convertedYarnSiteConfig, drfUsed);
-    autoCreateChildQueues = siteConverter.isAutoCreateChildQueues();
+    // See docs: "allow-undeclared-pools" and "user-as-default-queue" are
+    // ignored if we have placement rules
+    autoCreateChildQueues =
+        !havePlacementPolicies && siteConverter.isAutoCreateChildQueues();
+    userAsDefaultQueue =
+        !havePlacementPolicies && siteConverter.isUserAsDefaultQueue();
-    userAsDefaultQueue = siteConverter.isUserAsDefaultQueue();
-    checkReservationSystem(conf);
+    checkReservationSystem(inputYarnSiteConfig);
-    return yarnSiteConfig;
+    return convertedYarnSiteConfig;
+  }
+
+  /*
+   * Determines whether <queuePlacementPolicy> is present
+   * in the allocation file or not.
+   *
+   * Note that placementManager.getPlacementRules.size()
+   * doesn't work - by default, "allow-undeclared-pools" and
+   * "user-as-default-queue" are translated to policies internally
+   * inside QueuePlacementPolicy.fromConfiguration().
+   *
+   */
+  private boolean checkPlacementPoliciesPresent(FairScheduler scheduler,
+      Configuration inputYarnSiteConfig)
+      throws RuntimeException {
+
+    try (AllocationFileLoaderService loader =
+        new AllocationFileLoaderService(scheduler)){
+
+      Path allocFilePath = loader.getAllocationFile(inputYarnSiteConfig);
+      FileSystem fs = allocFilePath.getFileSystem(inputYarnSiteConfig);
+
+      DocumentBuilderFactory docBuilderFactory =
+          DocumentBuilderFactory.newInstance();
+      DocumentBuilder builder = docBuilderFactory.newDocumentBuilder();
+      Document doc = builder.parse(fs.open(allocFilePath));
+      Element root = doc.getDocumentElement();
+
+      NodeList elements = root.getChildNodes();
+
+      AllocationFileParser allocationFileParser =
+          new AllocationFileParser(elements);
+      allocationFileParser.parse();
+      docBuilderFactory.setIgnoringComments(true);
+
+      return
+          allocationFileParser.getQueuePlacementPolicy().isPresent();
+    } catch (Exception e) {
+      throw new PreconditionException("Unable to parse allocation file", e);
+    }

INS26 INS26 INS26 INS26 INS26 INS26 INS26 INS26 INS26 INS26 INS40 INS40 INS40 INS40 INS40 INS40 INS40 INS40 INS40 INS40 INS31 UPD42 INS44 MOV21 INS83 INS39 INS42 INS44 INS44 INS43 INS8 UPD42 UPD42 INS60 INS21 MOV21 INS21 INS60 UPD42 INS39 INS42 INS43 INS42 INS43 INS42 INS42 INS54 INS43 INS59 INS32 INS32 INS39 INS59 UPD42 INS42 INS42 INS58 INS8 INS12 UPD42 UPD42 UPD42 INS42 INS42 INS14 INS42 INS42 INS40 INS9 UPD42 INS42 INS42 INS40 INS57 INS57 UPD42 INS42 INS32 UPD42 UPD42 INS42 UPD42 UPD42 UPD42 INS27 INS27 UPD42 INS43 INS59 INS60 INS60 INS60 INS60 INS60 INS60 INS60 INS60 INS21 INS21 INS41 INS44 INS8 UPD42 INS43 INS42 INS43 INS43 INS42 INS42 INS42 INS38 MOV32 INS38 MOV32 INS42 INS42 INS14 INS43 INS59 INS43 INS59 INS43 INS59 INS43 INS59 INS43 INS59 INS43 INS59 INS43 INS59 INS43 INS59 INS32 INS32 INS32 INS43 INS42 INS53 INS42 INS42 INS42 INS42 INS42 INS43 INS42 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS14 INS42 INS42 INS42 INS42 INS9 INS32 INS42 INS42 INS14 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS43 INS42 INS42 INS42 INS43 INS45 INS42 INS42 INS42 INS42 INS42 INS42 DEL42 DEL42 DEL40 DEL9 DEL32 DEL21