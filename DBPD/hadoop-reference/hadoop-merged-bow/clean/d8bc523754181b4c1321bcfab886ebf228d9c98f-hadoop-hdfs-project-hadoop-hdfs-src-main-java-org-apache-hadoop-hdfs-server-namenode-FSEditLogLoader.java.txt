HDFS-5753. Add new NN startup options for downgrade and rollback using upgrade marker.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535@1559907 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.protocol.RollingUpgradeException;
+import org.apache.hadoop.hdfs.server.common.HdfsServerConstants.RollingUpgradeStartupOption;
+import org.apache.hadoop.hdfs.server.common.HdfsServerConstants.StartupOption;
+  long loadFSEdits(EditLogInputStream edits, long expectedStartingTxId)
+      throws IOException {
+    return loadFSEdits(edits, expectedStartingTxId, null, null);
+  }
+
-      MetaRecoveryContext recovery) throws IOException {
+      StartupOption startOpt, MetaRecoveryContext recovery) throws IOException {
-      long numEdits = loadEditRecords(edits, false, 
-                                 expectedStartingTxId, recovery);
+      long numEdits = loadEditRecords(edits, false, expectedStartingTxId,
+          startOpt, recovery);
-                      long expectedStartingTxId, MetaRecoveryContext recovery)
-      throws IOException {
+      long expectedStartingTxId, StartupOption startOpt,
+      MetaRecoveryContext recovery) throws IOException {
-            long inodeId = applyEditLogOp(op, fsDir, in.getVersion(), lastInodeId);
+            long inodeId = applyEditLogOp(op, fsDir, startOpt,
+                in.getVersion(), lastInodeId);
+            if (recovery == null) {
+              throw e instanceof IOException? (IOException)e: new IOException(e);
+            }
+
-      int logVersion, long lastInodeId) throws IOException {
+      StartupOption startOpt, int logVersion, long lastInodeId) throws IOException {
-      throw new UpgradeMarkerException();
+      if (startOpt == StartupOption.ROLLINGUPGRADE) {
+        if (startOpt.getRollingUpgradeStartupOption()
+            == RollingUpgradeStartupOption.ROLLBACK) {
+          throw new UpgradeMarkerException();
+        } else if (startOpt.getRollingUpgradeStartupOption()
+            == RollingUpgradeStartupOption.DOWNGRADE) {
+          //ignore upgrade marker
+          break;
+        }
+      }
+      throw new RollingUpgradeException(
+          "Unexpected upgrade marker in edit log: op=" + op);

INS26 INS26 INS26 INS40 INS40 INS40 INS31 INS39 INS42 INS44 INS44 INS43 INS8 INS44 INS44 INS44 INS43 INS42 INS39 INS42 INS42 INS41 INS43 INS42 INS43 INS42 INS43 INS42 INS42 INS32 INS42 INS42 INS42 INS8 INS42 INS42 INS42 INS33 INS33 INS25 INS53 INS27 INS8 INS14 INS42 INS40 INS25 INS43 INS27 INS42 INS27 MOV8 INS25 INS42 INS45 INS42 INS32 INS40 INS27 INS8 INS42 INS42 INS32 INS40 INS10 INS42 INS42 INS25 INS27 INS8 INS42 INS42 INS33 INS53 INS16 INS62 INS11 INS14 INS42 INS43 INS43 INS42 INS43 INS42 INS42 INS42 INS42