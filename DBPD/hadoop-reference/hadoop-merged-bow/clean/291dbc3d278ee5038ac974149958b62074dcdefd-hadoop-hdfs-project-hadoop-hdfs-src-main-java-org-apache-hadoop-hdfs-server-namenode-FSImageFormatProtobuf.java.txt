svn merge --reintegrate https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535 back to trunk.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1574259 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.hdfs.protocol.LayoutVersion;
+      if (s.hasRollingUpgradeStartTime()
+          && fsn.getFSImage().hasRollbackFSImage()) {
+        // we set the rollingUpgradeInfo only when we make sure we have the
+        // rollback image
+        fsn.setRollingUpgradeInfo(true, s.getRollingUpgradeStartTime());
+      }
-          .setLayoutVersion(LayoutVersion.getCurrentLayoutVersion());
+          .setLayoutVersion(NameNodeLayoutVersion.CURRENT_LAYOUT_VERSION);
+      if (fsn.isRollingUpgrade()) {
+        b.setRollingUpgradeStartTime(fsn.getRollingUpgradeInfo().getStartTime());
+      }

INS25 INS25 INS27 INS8 INS32 INS8 INS32 INS32 INS21 INS42 INS42 INS21 INS42 INS42 INS32 INS42 INS32 INS40 INS32 INS42 INS42 INS42 INS42 INS9 INS32 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS42 DEL40 DEL26 DEL42 DEL42 DEL32