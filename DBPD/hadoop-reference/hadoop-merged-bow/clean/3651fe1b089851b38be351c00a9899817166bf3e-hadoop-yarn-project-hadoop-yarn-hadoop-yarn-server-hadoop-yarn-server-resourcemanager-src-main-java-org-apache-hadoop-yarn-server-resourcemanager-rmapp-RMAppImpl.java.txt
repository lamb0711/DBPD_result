YARN-2853. Fixed a bug in ResourceManager causing apps to hang when the user kill request races with ApplicationMaster finish. Contributed by Jian He.

+    .addTransition(RMAppState.KILLING, RMAppState.FINAL_SAVING,
+        RMAppEventType.ATTEMPT_UNREGISTERED,
+        new FinalSavingTransition(
+          new AttemptUnregisteredTransition(),
+          RMAppState.FINISHING, RMAppState.FINISHED))
+    .addTransition(RMAppState.KILLING, RMAppState.FINISHED,
+      // UnManagedAM directly jumps to finished
+        RMAppEventType.ATTEMPT_FINISHED, FINISHED_TRANSITION)
+    .addTransition(RMAppState.KILLING,
+        EnumSet.of(RMAppState.FINAL_SAVING),
+        RMAppEventType.ATTEMPT_FAILED,
+        new AttemptFailedTransition(RMAppState.KILLING))
+
-            RMAppEventType.ATTEMPT_UNREGISTERED,
-            RMAppEventType.ATTEMPT_FINISHED,
-            RMAppEventType.ATTEMPT_FAILED,
+        if (initialState.equals(RMAppState.KILLING)) {
+          // If this is not last attempt, app should be killed instead of
+          // launching a new attempt
+          app.rememberTargetTransitionsAndStoreState(event,
+            new AppKilledTransition(), RMAppState.KILLED, RMAppState.KILLED);
+          return RMAppState.FINAL_SAVING;
+        }
+

INS25 INS32 INS42 INS40 INS40 INS32 INS8 MOV32 MOV42 MOV40 MOV40 INS40 MOV14 INS42 INS42 INS40 INS21 INS41 INS32 INS42 INS40 INS40 MOV32 INS32 INS40 INS32 INS42 UPD40 MOV40 UPD40 MOV40 MOV40 MOV14 INS42 INS42 INS42 INS14 INS40 INS40 MOV32 MOV42 INS40 INS40 INS32 INS43 UPD40 INS32 INS40 INS14 INS42 INS42 INS40 INS40 INS40 INS40 INS40 INS42 UPD40 UPD40 INS42 INS42 INS42 UPD40 MOV40 INS43 INS40 UPD40 INS40 INS14 INS42 INS43 INS14 INS40 INS40 INS42 INS43 INS42 DEL42 DEL42 DEL40 DEL40 DEL40 DEL40 DEL40 DEL40 DEL40 DEL40 DEL32