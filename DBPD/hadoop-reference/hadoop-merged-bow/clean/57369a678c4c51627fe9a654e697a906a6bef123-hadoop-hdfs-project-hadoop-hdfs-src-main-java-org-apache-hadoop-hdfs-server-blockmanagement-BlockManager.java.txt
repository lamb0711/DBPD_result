HDFS-10343. BlockManager#createLocatedBlocks may return blocks on failed storages. Contributed by Kuhu Shukla.

+import java.util.Arrays;
-    final DatanodeStorageInfo[] machines = new DatanodeStorageInfo[numMachines];
+    DatanodeStorageInfo[] machines = new DatanodeStorageInfo[numMachines];
-        if (isCorrupt || (!replicaCorrupt)) {
+        if ((isCorrupt || (!replicaCorrupt)) &&
+            storage.getState() != State.FAILED) {
+
+    if(j < machines.length) {
+      machines = Arrays.copyOf(machines, j);
+    }
+

INS26 INS40 INS25 INS27 INS8 INS42 INS40 INS21 INS7 INS42 INS32 INS27 INS42 INS42 INS42 INS42 INS36 INS27 MOV27 INS32 INS40 INS42 INS42 DEL83