YARN-8929. DefaultOOMHandler should only pick running containers to kill upon oom events (haibochen via rkanter)

-import static org.apache.hadoop.yarn.server.nodemanager.containermanager.linux.resources.CGroupsHandler.CGROUP_FILE_TASKS;
+import static org.apache.hadoop.yarn.server.nodemanager.containermanager.linux.resources.CGroupsHandler.CGROUP_PROCS_FILE;
+   * @return true if the container is killed successfully, false otherwise
-  private void sigKill(Container container) {
+  private boolean sigKill(Container container) {
+    boolean containerKilled = false;
-                CGROUP_FILE_TASKS)
+                CGROUP_PROCS_FILE)
+      containerKilled = true;
+      // the tasks file of the container may not be available because the
+      // container may not have been launched at this point when the root
+      // cgroup is under oom
+
+    return containerKilled;
+      if (!container.isRunning()) {
+        // skip containers that are not running yet because killing them
+        // won't release any memory to get us out of OOM.
+        continue;
+        // note even if it is indicated that the container is running from
+        // container.isRunning(), the container process might not have been
+        // running yet. From NM's perspective, a container is running as
+        // soon as the container launch is handed over the container executor
+      }
+    if (candidates.isEmpty()) {
+      LOG.warn(
+          "Found no running containers to kill in order to release memory");
+    }
-    if (candidates.size() > 0) {
-      ContainerCandidate candidate = candidates.get(0);
-      sigKill(candidate.container);
-      String message = String.format(
-          "container %s killed by elastic cgroups OOM handler.",
-          candidate.container.getContainerId());
-      LOG.warn(message);
-      containerKilled = true;
+    // make sure one container is killed successfully to release memory
+    for(int i = 0; !containerKilled && i < candidates.size(); i++) {
+      ContainerCandidate candidate = candidates.get(i);
+      if (sigKill(candidate.container)) {
+        String message = String.format(
+            "container %s killed by elastic cgroups OOM handler.",
+            candidate.container.getContainerId());
+        LOG.warn(message);
+        containerKilled = true;
+      }

UPD40 UPD39 INS65 INS60 INS41 INS25 INS24 INS66 INS39 INS59 INS42 INS32 INS8 INS58 INS27 INS37 INS8 INS42 INS9 INS21 INS25 INS42 INS42 INS21 INS39 INS59 INS38 UPD27 MOV27 INS42 INS60 MOV25 INS7 INS38 INS8 INS32 INS42 INS34 INS42 INS42 MOV43 INS59 MOV32 INS42 INS9 INS32 INS18 INS42 INS42 INS45 INS42 INS32 INS42 INS42 INS42 INS42 INS42 UPD42 DEL34 DEL42 DEL42 DEL42 DEL34 DEL32 DEL59 DEL60 DEL21