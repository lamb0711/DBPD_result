HADOOP-11572. s3a delete() operation fails during a concurrent delete of child entries.
Contributed by Steve Loughran.

(cherry picked from commit 2ac5aab8d725f761a9f9723471a4426f6b5d78c4)

+import com.amazonaws.services.s3.model.MultiObjectDeleteException;
-  private String pathToKey(Path path) {
+  @VisibleForTesting
+  String pathToKey(Path path) {
+   * @throws MultiObjectDeleteException one or more of the keys could not
+   * be deleted.
+   * @throws AmazonClientException amazon-layer failure.
-  private void deleteObjects(DeleteObjectsRequest deleteRequest) {
+  private void deleteObjects(DeleteObjectsRequest deleteRequest)
+      throws MultiObjectDeleteException, AmazonClientException {
-    s3.deleteObjects(deleteRequest);
+    try {
+      s3.deleteObjects(deleteRequest);
+    } catch (MultiObjectDeleteException e) {
+      // one or more of the operations failed.
+      List<MultiObjectDeleteException.DeleteError> errors = e.getErrors();
+      LOG.error("Partial failure of delete, {} errors", errors.size(), e);
+      for (MultiObjectDeleteException.DeleteError error : errors) {
+        LOG.error("{}: \"{}\" - {}",
+            error.getKey(), error.getCode(), error.getMessage());
+      }
+      throw e;
+    }
+   * @throws MultiObjectDeleteException one or more of the keys could not
+   * be deleted in a multiple object delete operation.
+   * @throws AmazonClientException amazon-layer failure.
-  private void removeKeys(List<DeleteObjectsRequest.KeyVersion> keysToDelete,
+  @VisibleForTesting
+  void removeKeys(List<DeleteObjectsRequest.KeyVersion> keysToDelete,
-      throws AmazonClientException, InvalidRequestException {
+      throws MultiObjectDeleteException, AmazonClientException,
+      InvalidRequestException {

INS26 INS40 INS78 INS43 INS43 INS8 INS78 INS43 INS42 INS65 INS65 INS42 INS42 MOV21 MOV21 INS54 INS65 INS65 INS42 INS42 INS42 INS66 INS66 INS42 INS66 MOV8 INS12 INS42 INS66 INS66 INS42 INS66 INS44 INS8 INS43 INS42 INS60 INS21 INS70 INS53 INS42 INS74 INS59 INS32 INS44 INS42 INS8 INS42 INS43 INS43 INS42 INS32 INS42 INS42 INS45 INS32 INS42 INS43 INS42 INS21 INS42 INS40 INS42 INS42 INS42 INS42 INS40 INS32 INS42 INS42 INS45 INS32 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 DEL83 DEL83