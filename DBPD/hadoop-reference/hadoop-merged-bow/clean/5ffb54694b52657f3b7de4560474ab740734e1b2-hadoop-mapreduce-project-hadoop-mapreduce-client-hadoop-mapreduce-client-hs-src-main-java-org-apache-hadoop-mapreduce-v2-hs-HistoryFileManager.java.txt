MAPREDUCE-6684. High contention on scanning of user directory under immediate_done in Job History Server. Contributed by Haibo Chen

-    private HistoryInfoState state;
+    private volatile HistoryInfoState state;
-    synchronized boolean isMovePending() {
+    boolean isMovePending() {
-    synchronized boolean didMoveFail() {
+    boolean didMoveFail() {
-    
+
-    public synchronized boolean isDeleted() {
+    public boolean isDeleted() {
+    moveToDoneExecutor = createMoveToDoneThreadPool(numMoveThreads);
+    super.serviceInit(conf);
+  }
+
+  protected ThreadPoolExecutor createMoveToDoneThreadPool(int numMoveThreads) {
-    moveToDoneExecutor = new HadoopThreadPoolExecutor(numMoveThreads,
-        numMoveThreads, 1, TimeUnit.HOURS,
-        new LinkedBlockingQueue<Runnable>(), tf);
-
-    super.serviceInit(conf);
+    return new HadoopThreadPoolExecutor(numMoveThreads, numMoveThreads,
+        1, TimeUnit.HOURS, new LinkedBlockingQueue<Runnable>(), tf);
+  protected HistoryFileInfo createHistoryFileInfo(Path historyFile,
+      Path confFile, Path summaryFile, JobIndexInfo jobIndexInfo,
+      boolean isInDone) {
+    return new HistoryFileInfo(
+        historyFile, confFile, summaryFile, jobIndexInfo, isInDone);
+  }
+
-      HistoryFileInfo fileInfo = new HistoryFileInfo(fs.getPath(), new Path(fs
+      HistoryFileInfo fileInfo = createHistoryFileInfo(fs.getPath(), new Path(fs
-      HistoryFileInfo fileInfo = new HistoryFileInfo(fs.getPath(), new Path(fs
+      HistoryFileInfo fileInfo = createHistoryFileInfo(fs.getPath(), new Path(fs
-        HistoryFileInfo fileInfo = new HistoryFileInfo(fs.getPath(), new Path(
+        HistoryFileInfo fileInfo = createHistoryFileInfo(fs.getPath(), new Path(
-            fileInfo = new HistoryFileInfo(historyFile.getPath(), new Path(
+            fileInfo = createHistoryFileInfo(historyFile.getPath(), new Path(

INS31 INS31 INS83 INS43 INS42 INS44 INS8 INS83 MOV43 INS42 INS44 INS44 INS44 INS44 INS44 INS8 INS83 INS42 INS39 INS42 MOV60 INS41 INS43 INS42 INS43 INS42 INS43 INS42 INS43 INS42 INS39 INS42 INS41 MOV14 INS42 INS42 INS42 INS42 INS14 INS32 MOV43 INS42 INS42 INS42 INS42 INS42 INS42 INS42 MOV43 MOV43 INS32 INS32 INS42 MOV32 MOV14 MOV14 INS42 INS9 INS42 MOV32 MOV14 MOV14 INS42 INS9 MOV43 INS32 INS42 MOV32 MOV14 MOV14 INS42 INS9 INS32 INS42 MOV32 MOV14 INS33 INS42 INS9 DEL83 DEL83 DEL83 DEL42 DEL9 DEL14 DEL42 DEL9 DEL14 DEL42 DEL43 DEL42 DEL9 DEL14 DEL42 DEL43 DEL33 DEL42 DEL9 DEL14