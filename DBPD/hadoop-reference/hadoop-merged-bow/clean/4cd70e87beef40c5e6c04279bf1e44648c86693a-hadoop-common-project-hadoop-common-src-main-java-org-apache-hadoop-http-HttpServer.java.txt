Merge trunk into auto-HA branch


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-3042@1337645 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.security.Krb5AndCertsSslSocketConnector;
-import org.apache.hadoop.security.Krb5AndCertsSslSocketConnector.MODE;
+  public static final String SPNEGO_FILTER = "SpnegoFilter";
-    
-    defineFilter(webAppContext, "krb5Filter", 
-        Krb5AndCertsSslSocketConnector.Krb5SslFilter.class.getName(), 
-        null, null);
-    
+        
-   * servlets added using this method, filters (except internal Kerberized
+   +   * servlets added using this method, filters (except internal Kerberos
+   * @param requireAuth Require Kerberos authenticate to access servlet
-       LOG.info("Adding Kerberos filter to " + name);
+       LOG.info("Adding Kerberos (SPNEGO) filter to " + name);
-       fmap.setFilterName("krb5Filter");
+       fmap.setFilterName(SPNEGO_FILTER);
-   * @param needClientAuth whether client authentication is required
-   */
-  public void addSslListener(InetSocketAddress addr, Configuration sslConf,
-      boolean needClientAuth) throws IOException {
-    addSslListener(addr, sslConf, needClientAuth, false);
-  }
-
-  /**
-   * Configure an ssl listener on the server.
-   * @param addr address to listen on
-   * @param sslConf conf to retrieve ssl options
-   * @param needKrbAuth whether to allow kerberos auth
-      boolean needCertsAuth, boolean needKrbAuth) throws IOException {
+      boolean needCertsAuth) throws IOException {
-    Krb5AndCertsSslSocketConnector.MODE mode;
-    if(needCertsAuth && needKrbAuth)
-      mode = MODE.BOTH;
-    else if (!needCertsAuth && needKrbAuth)
-      mode = MODE.KRB;
-    else // Default to certificates
-      mode = MODE.CERTS;
-
-    SslSocketConnector sslListener = new Krb5AndCertsSslSocketConnector(mode);
+    SslSocketConnector sslListener = new SslSocketConnector();
+   * Checks the user has privileges to access to instrumentation servlets.
+   * <p/>
+   * If <code>hadoop.security.instrumentation.requires.admin</code> is set to FALSE
+   * (default value) it always returns TRUE.
+   * <p/>
+   * If <code>hadoop.security.instrumentation.requires.admin</code> is set to TRUE
+   * it will check that if the current user is in the admin ACLS. If the user is
+   * in the admin ACLs it returns TRUE, otherwise it returns FALSE.
+   *
+   * @param servletContext the servlet context.
+   * @param request the servlet request.
+   * @param response the servlet response.
+   * @return TRUE/FALSE based on the logic decribed above.
+   */
+  public static boolean isInstrumentationAccessAllowed(
+    ServletContext servletContext, HttpServletRequest request,
+    HttpServletResponse response) throws IOException {
+    Configuration conf =
+      (Configuration) servletContext.getAttribute(CONF_CONTEXT_ATTRIBUTE);
+
+    boolean access = true;
+    boolean adminAccess = conf.getBoolean(
+      CommonConfigurationKeys.HADOOP_SECURITY_INSTRUMENTATION_REQUIRES_ADMIN,
+      false);
+    if (adminAccess) {
+      access = hasAdministratorAccess(servletContext, request, response);
+    }
+    return access;
+  }
+
+  /**
-
-      response.setContentType("text/plain; charset=UTF-8");
-      // Do the authorization
-      if (!HttpServer.hasAdministratorAccess(getServletContext(), request,
-          response)) {
+      if (!HttpServer.isInstrumentationAccessAllowed(getServletContext(),
+                                                     request, response)) {
+      response.setContentType("text/plain; charset=UTF-8");

MOV31 INS23 INS83 INS83 INS83 INS43 INS59 INS83 UPD39 UPD42 INS44 INS44 INS8 INS42 INS42 INS45 INS65 INS60 INS65 UPD43 UPD42 INS43 INS42 INS43 INS42 INS60 INS60 INS60 INS25 INS41 MOV21 UPD66 INS42 INS66 UPD43 MOV43 MOV59 UPD66 INS66 INS66 INS66 INS66 INS66 INS66 INS66 UPD42 UPD66 UPD42 UPD66 UPD42 UPD66 INS66 UPD42 INS42 INS42 INS43 INS59 INS39 INS59 INS39 INS59 INS42 INS8 INS42 INS42 MOV42 INS42 INS11 INS42 INS9 INS42 INS32 MOV21 MOV43 INS43 INS32 INS42 INS42 INS40 INS9 INS7 INS42 INS42 INS42 INS42 INS42 INS42 INS32 UPD42 UPD45 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 DEL40 DEL26 DEL40 DEL26 DEL42 DEL42 DEL45 DEL40 DEL43 DEL57 DEL42 DEL32 DEL33 DEL33 DEL32 DEL21 DEL45 DEL42 DEL66 DEL65 DEL39 DEL42 DEL44 DEL40 DEL42 DEL43 DEL42 DEL42 DEL59 DEL60 DEL42 DEL42 DEL27 DEL42 DEL40 DEL7 DEL21 DEL42 DEL38 DEL42 DEL27 DEL42 DEL40 DEL7 DEL21 DEL42 DEL40 DEL7 DEL21 DEL25 DEL25 DEL60 DEL43 DEL42 DEL44 DEL39 DEL42 DEL44 DEL9 DEL32 DEL8