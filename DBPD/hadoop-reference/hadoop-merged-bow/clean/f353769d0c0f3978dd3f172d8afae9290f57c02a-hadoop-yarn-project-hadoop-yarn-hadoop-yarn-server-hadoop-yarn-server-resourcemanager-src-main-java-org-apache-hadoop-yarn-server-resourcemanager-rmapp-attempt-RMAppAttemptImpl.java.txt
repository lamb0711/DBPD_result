Merging r1518852 through r1519883 from trunk to branch HDFS-2832

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2832@1519885 13f79535-47bb-0310-9956-ffa450edef68

+import javax.crypto.SecretKey;
+
-import org.apache.hadoop.io.Text;
-import org.apache.hadoop.yarn.security.client.ClientToAMTokenIdentifier;
-import org.apache.hadoop.yarn.security.client.ClientToAMTokenSelector;
-  private Token<ClientToAMTokenIdentifier> clientToAMToken;
+  private SecretKey clientTokenMasterKey = null;
-  public Token<ClientToAMTokenIdentifier> getClientToAMToken() {
-    return this.clientToAMToken;
+  public SecretKey getClientTokenMasterKey() {
+    return this.clientTokenMasterKey;
-    recoverAppAttemptTokens(attemptState.getAppAttemptTokens());
+    recoverAppAttemptCredentials(attemptState.getAppAttemptCredentials());
-  private void recoverAppAttemptTokens(Credentials appAttemptTokens) {
+  private void recoverAppAttemptCredentials(Credentials appAttemptTokens) {
-    if (UserGroupInformation.isSecurityEnabled()) {
-      ClientToAMTokenSelector clientToAMTokenSelector =
-          new ClientToAMTokenSelector();
-      this.clientToAMToken =
-          clientToAMTokenSelector.selectToken(new Text(),
-            appAttemptTokens.getAllTokens());
+    if (UserGroupInformation.isSecurityEnabled()) {
+      byte[] clientTokenMasterKeyBytes = appAttemptTokens.getSecretKey(
+          RMStateStore.AM_CLIENT_TOKEN_MASTER_KEY_NAME);
+      clientTokenMasterKey = rmContext.getClientToAMTokenSecretManager()
+          .registerMasterKey(applicationAttemptId, clientTokenMasterKeyBytes);
-
-        appAttempt.rmContext.getClientToAMTokenSecretManager()
-          .registerApplication(appAttempt.applicationAttemptId);
-
-        // create clientToAMToken
-        appAttempt.clientToAMToken =
-            new Token<ClientToAMTokenIdentifier>(new ClientToAMTokenIdentifier(
-              appAttempt.applicationAttemptId),
-              appAttempt.rmContext.getClientToAMTokenSecretManager());
+        appAttempt.clientTokenMasterKey = appAttempt.rmContext
+            .getClientToAMTokenSecretManager()
+            .registerApplication(appAttempt.applicationAttemptId);
-      appAttempt.removeTokens(appAttempt);
+      appAttempt.removeCredentials(appAttempt);
-      appAttempt.removeTokens(appAttempt);
+      appAttempt.removeCredentials(appAttempt);
-  private void removeTokens(RMAppAttemptImpl appAttempt) {
+  private void removeCredentials(RMAppAttemptImpl appAttempt) {

MOV26 MOV23 UPD40 INS43 INS43 UPD42 UPD42 UPD42 UPD42 MOV42 UPD42 INS33 UPD42 MOV42 UPD42 UPD42 UPD42 INS5 UPD42 UPD42 INS39 INS85 UPD42 INS32 INS42 INS7 INS42 INS42 INS40 INS32 INS42 UPD42 MOV42 UPD42 MOV42 INS40 MOV32 UPD42 MOV42 UPD42 MOV42 DEL40 DEL26 DEL40 DEL26 DEL43 DEL42 DEL43 DEL74 DEL43 DEL42 DEL43 DEL74 DEL42 DEL43 DEL42 DEL43 DEL14 DEL52 DEL42 DEL22 DEL42 DEL43 DEL14 DEL32 DEL40 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL43 DEL40 DEL14 DEL40 DEL42 DEL32 DEL14 DEL7 DEL21