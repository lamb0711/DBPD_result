HADOOP-14442. Owner support for ranger-wasb integration. Contributed by Varada Hemeswari

+import org.apache.hadoop.security.UserGroupInformation;
+import org.apache.hadoop.util.StringUtils;
+  private boolean performOwnerMatch;
-  // The full qualified URL to the root directory
+ // The full qualified URL to the root directory
+    init(conf, false);
+  }
+
+  /*
+  authorization matches owner with currentUserShortName while evaluating auth rules
+  if currentUserShortName is set to a string that is not empty
+  */
+  public void init(Configuration conf, boolean matchOwner) {
+    this.performOwnerMatch = matchOwner;
-
-    wasbAbsolutePath = qualifiedPrefixUrl + wasbAbsolutePath;
-
-    AuthorizationComponent component = wasbAbsolutePath.endsWith("*")
+        wasbAbsolutePath = qualifiedPrefixUrl + wasbAbsolutePath;
+        AuthorizationComponent component = wasbAbsolutePath.endsWith("*")
-  public boolean authorize(String wasbAbsolutePath, String accessType)
+  public boolean authorize(String wasbAbsolutePath, String accessType, String owner)
+    String currentUserShortName = "";
+    if (this.performOwnerMatch) {
+      try {
+        UserGroupInformation ugi = UserGroupInformation.getCurrentUser();
+        currentUserShortName = ugi.getShortUserName();
+      } catch (Exception e) {
+        //no op
+      }
+    }
+
+    // In case of root("/"), owner match does not happen because owner is returned as empty string.
+    // we try to force owner match just for purpose of tests to make sure all operations work seemlessly with owner.
+    if (this.performOwnerMatch
+      && StringUtils.equalsIgnoreCase(wasbAbsolutePath, qualifiedPrefixUrl + "/")) {
+      owner = currentUserShortName;
+    }
+
+    boolean shouldEvaluateOwnerAccess = owner != null && !owner.isEmpty()
+      && this.performOwnerMatch;
+
+    boolean isOwnerMatch =  StringUtils.equalsIgnoreCase(currentUserShortName, owner);
+
-      return authRules.get(component);
+      return shouldEvaluateOwnerAccess ? isOwnerMatch && authRules.get(component) : authRules.get(component);
-          return entry.getValue();
+          return shouldEvaluateOwnerAccess ? isOwnerMatch && entry.getValue() : entry.getValue();
+
+  public void deleteAllAuthRules() {
+    authRules.clear();
+  }

INS26 INS26 INS40 INS40 INS23 INS31 INS31 INS83 INS39 INS59 MOV78 INS83 INS39 INS42 INS44 INS8 INS44 INS44 INS83 INS39 INS42 INS8 INS42 INS43 INS42 INS21 INS39 INS42 INS21 INS43 INS42 INS60 INS25 INS25 INS60 INS60 INS21 INS42 INS32 INS7 INS42 INS43 INS59 INS22 INS8 INS27 INS8 INS39 INS59 INS39 INS59 INS32 INS42 INS42 INS9 INS22 INS42 INS42 INS42 INS45 INS52 INS42 INS54 INS22 INS32 INS21 INS42 INS27 INS42 INS32 INS42 INS42 INS52 INS42 INS8 INS12 INS52 INS42 INS42 INS42 INS42 INS27 INS7 INS27 INS22 INS42 INS42 INS42 INS42 INS16 INS60 INS21 INS44 INS8 INS42 INS45 INS42 INS42 INS27 INS38 INS52 INS42 INS42 INS27 INS32 INS43 INS59 INS7 INS43 INS42 INS42 INS33 INS32 INS42 MOV32 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS16 INS42 INS27 INS32 INS42 MOV32 INS42 INS42