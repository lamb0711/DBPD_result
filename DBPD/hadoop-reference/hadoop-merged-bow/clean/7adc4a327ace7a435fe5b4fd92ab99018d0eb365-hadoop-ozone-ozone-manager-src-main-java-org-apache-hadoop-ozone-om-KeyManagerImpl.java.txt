HDDS-1775. Make OM KeyDeletingService compatible with HA model (#1063)



+import com.google.common.annotations.VisibleForTesting;
+  private final OzoneManager ozoneManager;
+  @VisibleForTesting
-    this(new ScmClient(scmBlockClient, null), metadataManager,
+    this(null, new ScmClient(scmBlockClient, null), metadataManager,
-  public KeyManagerImpl(ScmClient scmClient,
+  public KeyManagerImpl(OzoneManager om, ScmClient scmClient,
+      OzoneConfiguration conf, String omId) {
+    this (om, scmClient, om.getMetadataManager(), conf, omId,
+        om.getBlockTokenMgr(), om.getKmsProvider(), om.getPrefixManager());
+  }
+
+  @SuppressWarnings("parameternumber")
+  private KeyManagerImpl(OzoneManager om, ScmClient scmClient,
-      KeyProviderCryptoExtension kmsProvider,
-      PrefixManager prefixManager) {
-    this.scmClient = scmClient;
-    this.metadataManager = metadataManager;
-    this.prefixManager = prefixManager;
+      KeyProviderCryptoExtension kmsProvider, PrefixManager prefixManager) {
-    this.omId = omId;
-    start(conf);
-    this.secretManager = secretManager;
+
+    this.ozoneManager = om;
+    this.omId = omId;
+    this.scmClient = scmClient;
+    this.metadataManager = metadataManager;
+    this.prefixManager = prefixManager;
+    this.secretManager = secretManager;
+
+    start(conf);
-      keyDeletingService = new KeyDeletingService(scmClient.getBlockClient(),
-          this, blockDeleteInterval, serviceTimeout, configuration);
+      keyDeletingService = new KeyDeletingService(ozoneManager,
+          scmClient.getBlockClient(), this, blockDeleteInterval,
+          serviceTimeout, configuration);

INS26 INS40 INS23 INS31 MOV29 INS83 INS83 INS43 INS59 INS78 INS83 INS42 INS44 INS44 INS44 INS44 INS8 INS79 UPD83 INS44 MOV21 MOV21 MOV21 MOV21 MOV21 INS42 INS42 INS42 INS43 INS42 INS43 INS42 INS43 INS42 INS43 INS42 INS17 INS42 INS45 INS43 INS42 INS21 INS33 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS32 INS32 INS32 INS42 INS7 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS22 INS42 INS52 INS42 INS42