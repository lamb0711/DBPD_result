HDDS-1843. Undetectable corruption after restart of a datanode. Contributed by Shashikant Banerjee(#1364).

-   * Builds the missing container set by taking a diff total no containers
-   * actually found and number of containers which actually got created.
+   * Builds the missing container set by taking a diff between total no
+   * containers actually found and number of containers which actually
+   * got created. It also validates the BCSID stored in the snapshot file
+   * for each container as against what is reported in containerScan.
-   * @param createdContainerSet ContainerId set persisted in the Ratis snapshot
+   * @param container2BCSIDMap Map of containerId to BCSID persisted in the
+   *                           Ratis snapshot
-  public void buildMissingContainerSet(Set<Long> createdContainerSet) {
-    missingContainerSet.addAll(createdContainerSet);
-    missingContainerSet.removeAll(containerMap.keySet());
+  public void buildMissingContainerSetAndValidate(
+      Map<Long, Long> container2BCSIDMap) {
+    container2BCSIDMap.entrySet().parallelStream().forEach((mapEntry) -> {
+      long id = mapEntry.getKey();
+      if (!containerMap.containsKey(id)) {
+        LOG.warn("Adding container {} to missing container set.", id);
+        missingContainerSet.add(id);
+      } else {
+        Container container = containerMap.get(id);
+        long containerBCSID = container.getBlockCommitSequenceId();
+        long snapshotBCSID = mapEntry.getValue();
+        if (containerBCSID < snapshotBCSID) {
+          LOG.warn(
+              "Marking container {} unhealthy as reported BCSID {} is smaller"
+                  + " than ratis snapshot recorded value {}", id,
+              containerBCSID, snapshotBCSID);
+          // just mark the container unhealthy. Once the DatanodeStateMachine
+          // thread starts it will send container report to SCM where these
+          // unhealthy containers would be detected
+          try {
+            container.markContainerUnhealthy();
+          } catch (StorageContainerException sce) {
+            // The container will still be marked unhealthy in memory even if
+            // exception occurs. It won't accept any new transactions and will
+            // be handled by SCM. Eve if dn restarts, it will still be detected
+            // as unheathy as its BCSID won't change.
+            LOG.error("Unable to persist unhealthy state for container {}", id);
+          }
+        }
+      }
+    });
+

UPD42 INS8 UPD74 UPD42 INS21 UPD66 UPD66 INS66 INS66 UPD42 UPD66 INS66 UPD43 INS43 INS32 UPD42 INS42 INS32 INS42 INS86 INS32 INS42 INS59 INS8 INS42 INS42 INS42 INS60 INS25 INS39 INS59 INS38 INS8 INS8 INS42 INS32 INS32 INS21 MOV21 INS60 INS60 INS60 INS25 INS42 INS42 INS42 INS42 INS42 INS32 INS43 INS59 INS39 INS59 INS39 INS59 INS27 INS8 INS42 INS42 INS45 INS42 UPD42 UPD42 INS42 INS42 INS32 INS42 INS32 INS42 INS32 INS42 INS42 INS21 INS54 MOV42 UPD42 MOV42 INS42 INS42 INS42 INS42 INS42 INS32 INS8 INS12 INS42 INS42 INS27 INS42 INS42 INS42 INS21 INS44 INS8 INS45 INS45 INS32 INS43 INS42 INS21 INS42 INS42 INS42 INS32 INS42 INS42 INS45 INS42 DEL42 DEL42 DEL32 DEL32 DEL21 DEL8