HADOOP-13226 Support async call retry and failover.

-import org.apache.hadoop.util.concurrent.AsyncGetFuture;
-  private static final ThreadLocal<Future<?>> ASYNC_RPC_RESPONSE
-      = new ThreadLocal<>();
+  private static final ThreadLocal<AsyncGet<? extends Writable, IOException>>
+      ASYNC_RPC_RESPONSE = new ThreadLocal<>();
-  public static <T> Future<T> getAsyncRpcResponse() {
-    return (Future<T>) ASYNC_RPC_RESPONSE.get();
+  public static <T extends Writable> AsyncGet<T, IOException>
+      getAsyncRpcResponse() {
+    return (AsyncGet<T, IOException>) ASYNC_RPC_RESPONSE.get();
+
+        @Override
+        public boolean isDone() {
+          synchronized (call) {
+            return call.done;
+          }
+        }
-      ASYNC_RPC_RESPONSE.set(new AsyncGetFuture<>(asyncGet));
+      ASYNC_RPC_RESPONSE.set(asyncGet);
-          final long waitTimeout = AsyncGet.Util.asyncGetTimeout2WaitTimeout(
-              timeout, unit);
-          call.wait(waitTimeout); // wait for the result
-          if (waitTimeout > 0 && !call.done) {
+          AsyncGet.Util.wait(call, timeout, unit);
+          if (timeout >= 0 && !call.done) {

UPD74 UPD74 UPD74 INS43 UPD43 MOV43 INS43 UPD43 UPD76 INS43 INS42 UPD42 INS42 UPD42 INS43 INS42 UPD74 INS42 UPD43 MOV43 INS43 UPD42 INS42 INS42 INS31 INS21 INS78 INS83 INS39 INS42 INS8 INS32 INS42 INS51 MOV40 UPD42 MOV42 INS42 MOV42 MOV42 UPD27 INS42 INS8 UPD42 INS41 INS40 DEL40 DEL26 DEL42 DEL43 DEL74 DEL42 DEL14 DEL83 DEL39 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL42 DEL32 DEL21