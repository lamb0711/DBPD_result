HDFS-9701. DN may deadlock when hot-swapping under load. (Xiao Chen via lei)

-   * Close this volume and wait all other threads to release the reference count
-   * on this volume.
-   * @throws IOException if the volume is closed or the waiting is interrupted.
+   * Close this volume.
+   * @throws IOException if the volume is closed.
-  void closeAndWait() throws IOException {
+  void setClosed() throws IOException {
-    final int SLEEP_MILLIS = 500;
-    while (this.reference.getReferenceCount() > 0) {
+  }
+
+  /**
+   * Check whether this volume has successfully been closed.
+   */
+  boolean checkClosed() {
+    if (this.reference.getReferenceCount() > 0) {
-      try {
-        Thread.sleep(SLEEP_MILLIS);
-      } catch (InterruptedException e) {
-        throw new IOException(e);
-      }
+      return false;
+    return true;

INS31 UPD42 INS8 INS29 INS39 INS42 MOV8 MOV54 INS65 INS25 INS41 UPD66 UPD66 INS66 MOV27 MOV8 INS9 INS41 INS9 DEL66 DEL42 DEL42 DEL42 DEL32 DEL21 DEL8 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL14 DEL53 DEL8 DEL12 DEL54 DEL83 DEL39 DEL42 DEL34 DEL59 DEL60 DEL61