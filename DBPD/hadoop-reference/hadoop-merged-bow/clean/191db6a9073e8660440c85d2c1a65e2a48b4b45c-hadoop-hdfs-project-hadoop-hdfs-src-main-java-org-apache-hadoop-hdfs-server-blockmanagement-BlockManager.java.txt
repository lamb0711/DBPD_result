HDFS-2718. Optimize OP_ADD in edits loading. Contributed by Konstantin Shvachko.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1239760 13f79535-47bb-0310-9956-ffa450edef68

+    return completeBlock(fileINode, blkIndex, false);
+  }
+
+  public BlockInfo completeBlock(final INodeFile fileINode, 
+      final int blkIndex, final boolean force) throws IOException {
-    if(ucBlock.numNodes() < minReplication)
+    if(!force && ucBlock.numNodes() < minReplication)
+    if(!force && ucBlock.getBlockUCState() != BlockUCState.COMMITTED)
+      throw new IOException(
+          "Cannot complete block: block has not been COMMITTED by the client");

INS31 MOV29 INS83 INS43 INS42 INS44 INS44 INS43 INS8 UPD83 INS44 INS42 INS83 INS43 INS42 INS83 INS39 INS42 INS42 INS41 INS83 INS39 INS42 INS25 INS42 INS32 INS27 INS27 INS53 INS42 INS42 INS42 INS9 INS38 MOV27 INS38 INS27 INS14 INS42 INS42 INS32 INS40 INS43 INS45 INS42 INS42 INS42