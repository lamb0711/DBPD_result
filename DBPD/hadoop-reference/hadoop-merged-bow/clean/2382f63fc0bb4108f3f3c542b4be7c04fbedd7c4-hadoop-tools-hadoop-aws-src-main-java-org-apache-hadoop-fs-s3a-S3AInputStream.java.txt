HADOOP-14747. S3AInputStream to implement CanUnbuffer.

Author:    Sahil Takiar <stakiar@cloudera.com>

+import com.google.common.annotations.VisibleForTesting;
+import org.apache.hadoop.fs.CanUnbuffer;
+import org.apache.hadoop.fs.StreamCapabilities;
+import static org.apache.hadoop.util.StringUtils.toLowerCase;
-public class S3AInputStream extends FSInputStream implements CanSetReadahead {
+public class S3AInputStream extends FSInputStream implements  CanSetReadahead,
+        CanUnbuffer, StreamCapabilities {
-    if (wrappedStream != null) {
+    if (isObjectStreamOpen()) {
-    if (wrappedStream != null) {
+    if (isObjectStreamOpen()) {
-    boolean connectionOpen = wrappedStream != null;
-    if (connectionOpen) {
+    if (isObjectStreamOpen()) {
-    return connectionOpen;
+    return isObjectStreamOpen();
-          .append(wrappedStream != null ? "open" : "closed");
+          .append(isObjectStreamOpen() ? "open" : "closed");
+
+  @Override
+  public synchronized void unbuffer() {
+    closeStream("unbuffer()", contentRangeFinish, false);
+  }
+
+  @Override
+  public boolean hasCapability(String capability) {
+    switch (toLowerCase(capability)) {
+    case StreamCapabilities.READAHEAD:
+    case StreamCapabilities.UNBUFFER:
+      return true;
+    default:
+      return false;
+    }
+  }
+
+  @VisibleForTesting
+  boolean isObjectStreamOpen() {
+    return wrappedStream != null;
+  }

INS26 INS26 INS26 INS26 INS40 INS40 INS40 INS40 INS43 INS43 INS31 INS31 INS31 INS42 INS42 INS78 INS83 INS83 INS39 INS42 INS8 INS78 INS83 INS39 INS42 INS44 INS8 INS78 INS39 INS42 INS8 INS42 INS21 INS42 INS43 INS42 INS50 INS42 INS41 INS32 INS32 INS32 INS32 INS32 INS42 INS32 INS49 INS49 INS41 INS49 INS41 MOV27 INS42 INS42 INS42 INS42 INS42 INS45 INS42 INS9 INS42 INS42 INS40 INS40 INS9 INS9 INS32 INS42 DEL42 DEL33 DEL27 DEL42 DEL33 DEL27 DEL39 DEL42 DEL42 DEL33 DEL27 DEL59 DEL60 DEL42 DEL42