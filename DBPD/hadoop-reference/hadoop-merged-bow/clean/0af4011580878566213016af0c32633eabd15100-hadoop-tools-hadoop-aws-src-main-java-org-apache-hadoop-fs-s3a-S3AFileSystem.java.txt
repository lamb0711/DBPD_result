HADOOP-16221. S3Guard: add option to fail operation on metadata write failure.

+  private boolean failOnMetadataWriteError;
+      failOnMetadataWriteError = conf.getBoolean(FAIL_ON_METADATA_WRITE_ERROR,
+          FAIL_ON_METADATA_WRITE_ERROR_DEFAULT);
+
+   * @throws MetadataPersistenceException if metadata about the write could
+   * not be saved to the metadata store and
+   * fs.s3a.metadatastore.fail.on.write.error=true
-  @Retries.OnceRaw("For PUT; post-PUT actions are RetriesExceptionsSwallowed")
+  @Retries.OnceRaw("For PUT; post-PUT actions are RetryTranslated")
-      throws AmazonClientException {
+      throws AmazonClientException, MetadataPersistenceException {
+   * @throws MetadataPersistenceException if metadata about the write could
+   * not be saved to the metadata store and
+   * fs.s3a.metadatastore.fail.on.write.error=true
-  @Retries.OnceRaw("For PUT; post-PUT actions are RetriesExceptionsSwallowed")
+  @Retries.OnceRaw("For PUT; post-PUT actions are RetryTranslated")
-      throws InterruptedIOException {
+      throws InterruptedIOException, MetadataPersistenceException {
+   * @throws MetadataPersistenceException if metadata about the write could
+   * not be saved to the metadata store and
+   * fs.s3a.metadatastore.fail.on.write.error=true
-  @Retries.RetryExceptionsSwallowed
-  void finishedWrite(String key, long length) {
+  @Retries.RetryTranslated("Except if failOnMetadataWriteError=false, in which"
+      + " case RetryExceptionsSwallowed")
+  void finishedWrite(String key, long length)
+      throws MetadataPersistenceException {
-      LOG.error("S3Guard: Error updating MetadataStore for write to {}:",
-          key, e);
+      if (failOnMetadataWriteError) {
+        throw new MetadataPersistenceException(p.toString(), e);
+      } else {
+        LOG.error("S3Guard: Error updating MetadataStore for write to {}",
+            p, e);
+      }

INS23 INS83 INS39 INS59 INS43 INS43 INS79 INS43 INS42 INS65 UPD45 INS42 INS65 UPD45 INS42 INS65 INS40 INS27 INS42 INS42 INS66 INS66 INS66 INS42 INS66 INS66 INS66 INS42 INS66 INS66 INS66 INS45 INS45 INS21 INS8 INS7 INS25 MOV21 INS42 INS32 INS42 INS8 INS8 INS42 INS42 INS42 INS42 INS53 MOV21 INS14 INS43 INS32 INS42 UPD45 UPD42 INS42 INS42 INS42 DEL40 DEL78 DEL8