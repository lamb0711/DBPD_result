HDFS-2053. Bug in INodeDirectory#computeContentSummary warning. Contributed by Michael Noll


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1140707 13f79535-47bb-0310-9956-ffa450edef68

+    // Walk through the children of this node, using a new summary array
+    // for the (sub)tree rooted at this node
+    assert 4 == summary.length;
+    long[] subtreeSummary = new long[]{0,0,0,0};
-        child.computeContentSummary(summary);
+        child.computeContentSummary(subtreeSummary);
-      if (-1 != node.getDsQuota() && space != summary[3]) {
+      assert -1 == node.getDsQuota() || space == subtreeSummary[3];
+      if (-1 != node.getDsQuota() && space != subtreeSummary[3]) {
-            +getLocalName()+". Cached: "+space+" Computed: "+summary[3]);
+            +getLocalName()+". Cached: "+space+" Computed: "+subtreeSummary[3]);
+
+    // update the passed summary array with the values for this node's subtree
+    for (int i = 0; i < summary.length; i++) {
+      summary[i] += subtreeSummary[i];
+    }
+

INS6 INS60 INS24 INS27 INS5 INS59 INS58 INS27 INS37 INS8 INS34 INS40 INS39 INS85 INS42 INS3 INS6 INS39 INS59 INS42 INS40 INS42 INS21 INS5 INS4 INS27 INS42 INS34 INS7 INS39 INS85 INS34 INS34 INS34 INS34 INS27 INS27 INS2 INS2 INS38 INS32 INS42 INS2 INS42 INS42 INS42 INS42 UPD42 INS34 INS42 INS42 INS42 INS34 UPD42 UPD42