YARN-8242. YARN NM: OOM error while reading back the state store on recovery. Contributed by Pradeep Ambati and Kanwaljeet Sachdev

+
+import org.apache.hadoop.yarn.server.nodemanager.recovery.RecoveryIterator;
-import java.util.List;
-    List<DeletionServiceDeleteTaskProto> taskProtos = state.getTasks();
-        new HashMap<>(taskProtos.size());
-    Set<Integer> successorTasks = new HashSet<>();
-    for (DeletionServiceDeleteTaskProto proto : taskProtos) {
-      DeletionTaskRecoveryInfo info =
-          NMProtoUtils.convertProtoToDeletionTaskRecoveryInfo(proto, this);
-      idToInfoMap.put(info.getTask().getTaskId(), info);
-      nextTaskId.set(Math.max(nextTaskId.get(), info.getTask().getTaskId()));
-      successorTasks.addAll(info.getSuccessorTaskIds());
+        new HashMap<Integer, DeletionTaskRecoveryInfo>();
+    Set<Integer> successorTasks = new HashSet<Integer>();
+
+    try (RecoveryIterator<DeletionServiceDeleteTaskProto> it =
+             state.getIterator()) {
+      while (it.hasNext()) {
+        DeletionServiceDeleteTaskProto proto = it.next();
+        DeletionTaskRecoveryInfo info =
+            NMProtoUtils.convertProtoToDeletionTaskRecoveryInfo(proto, this);
+        idToInfoMap.put(info.getTask().getTaskId(), info);
+        nextTaskId.set(Math.max(nextTaskId.get(), info.getTask().getTaskId()));
+        successorTasks.addAll(info.getSuccessorTaskIds());
+      }

MOV26 UPD40 INS54 INS58 INS8 UPD74 MOV74 INS59 INS61 UPD74 UPD74 UPD43 UPD42 MOV42 MOV32 INS32 MOV8 INS43 INS43 INS43 UPD42 UPD42 INS42 INS42 INS60 INS42 INS42 INS42 MOV43 INS59 INS42 INS32 INS42 INS42 DEL59 DEL60 DEL42 DEL42 DEL32 DEL42 DEL44 DEL42 DEL70