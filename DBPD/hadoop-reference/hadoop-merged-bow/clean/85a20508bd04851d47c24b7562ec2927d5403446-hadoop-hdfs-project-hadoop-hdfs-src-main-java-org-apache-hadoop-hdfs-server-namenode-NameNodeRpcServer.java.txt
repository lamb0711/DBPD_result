HDFS-10301. Interleaving processing of storages from repeated block reports causes false zombie storage detection, removes valid blocks. Contributed by Vinitha Gankidi.
-      //
-      // BlockManager.processReport accumulates information of prior calls
-      // for the same node and storage, so the value returned by the last
-      // call of this loop is the final updated value for noStaleStorage.
-      //
-      final int index = r;
-      noStaleStorages = bm.runBlockOp(new Callable<Boolean>() {
-        @Override
-        public Boolean call() throws IOException {
-          return bm.processReport(nodeReg, reports[index].getStorage(),
-              blocks, context, (index == reports.length - 1));
-        }
-      });
-      metrics.incrStorageBlockReportOps();
+      if (!blocks.isStorageReport()) {
+        //
+        // BlockManager.processReport accumulates information of prior calls
+        // for the same node and storage, so the value returned by the last
+        // call of this loop is the final updated value for noStaleStorage.
+        //
+        final int index = r;
+        noStaleStorages = bm.runBlockOp(new Callable<Boolean>() {
+          @Override
+          public Boolean call()
+              throws IOException {
+            return bm.processReport(nodeReg, reports[index].getStorage(),
+                blocks, context);
+          }
+        });
+        metrics.incrStorageBlockReportOps();
+      }
+        context.getTotalRpcs() == context.getCurRpc() + 1) {
+      Set<String> storageIDsInBlockReport = new HashSet<>();
+      for (StorageBlockReport report : reports) {
+        storageIDsInBlockReport.add(report.getStorage().getStorageID());
+      }
+      bm.removeZombieStorages(nodeReg, context, storageIDsInBlockReport);
+    }
+
+    if (nn.getFSImage().isUpgradeFinalized() &&

INS25 INS27 INS8 INS25 INS32 INS27 INS60 INS70 INS21 INS38 INS8 INS32 INS42 INS32 INS27 INS74 INS59 INS44 INS42 INS8 INS32 INS32 MOV60 MOV21 MOV21 INS42 INS42 INS42 INS42 INS32 INS34 INS43 INS43 INS42 INS14 INS43 INS42 INS21 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS74 INS42 INS32 INS43 INS42 INS42 INS32 INS42 INS32 INS42 INS42 INS42 DEL42 DEL40 DEL34 DEL27 DEL27 DEL36