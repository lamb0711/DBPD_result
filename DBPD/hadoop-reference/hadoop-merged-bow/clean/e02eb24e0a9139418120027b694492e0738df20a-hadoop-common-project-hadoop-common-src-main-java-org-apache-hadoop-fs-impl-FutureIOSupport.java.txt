HADOOP-15183. S3Guard store becomes inconsistent after partial failure of rename.

Contributed by Steve Loughran.

Change-Id: I825b0bc36be960475d2d259b1cdab45ae1bb78eb

+import java.util.concurrent.CompletionException;
+    throw unwrapInnerException(e);
+  }
+
+  /**
+   * Extract the cause of a completion failure and rethrow it if an IOE
+   * or RTE.
+   * @param e exception.
+   * @param <T> type of return value.
+   * @return nothing, ever.
+   * @throws IOException either the inner IOException, or a wrapper around
+   * any non-Runtime-Exception
+   * @throws RuntimeException if that is the inner cause.
+   */
+  public static <T> T raiseInnerCause(final CompletionException e)
+      throws IOException {
+    throw unwrapInnerException(e);
+  }
+
+  /**
+   * From the inner cause of an execution exception, extract the inner cause.
+   * If it is an RTE: throw immediately.
+   * If it is an IOE: Return.
+   * If it is a WrappedIOException: Unwrap and return
+   * Else: create a new IOException.
+   *
+   * Recursively handles wrapped Execution and Completion Exceptions in
+   * case something very complicated has happened.
+   * @param e exception.
+   * @return an IOException extracted or built from the cause.
+   * @throws RuntimeException if that is the inner cause.
+   */
+  private static IOException unwrapInnerException(final Throwable e) {
-      throw (IOException) cause;
+      return (IOException) cause;
-      throw ((WrappedIOException) cause).getCause();
+      return ((WrappedIOException) cause).getCause();
+    } else if (cause instanceof CompletionException){
+      return unwrapInnerException(cause);
+    } else if (cause instanceof ExecutionException){
+      return unwrapInnerException(cause);
-      throw new IOException(cause);
+      return new IOException(cause);
-      // this only happens if somebody deliberately raises
-      // an ExecutionException
-      throw new IOException(e);
+      // this only happens if there was no cause.
+      return new IOException(e);

INS26 INS40 INS31 INS31 MOV29 INS83 INS83 MOV73 MOV43 INS42 MOV44 MOV43 INS8 INS29 INS83 INS83 INS73 INS43 INS42 INS44 INS43 INS8 INS29 UPD83 INS43 UPD42 INS44 INS53 INS65 INS65 INS65 INS65 INS65 INS65 INS42 INS42 INS83 INS43 INS42 INS42 INS53 INS65 INS65 INS65 INS65 INS42 INS83 INS43 INS42 INS32 INS66 INS66 INS42 INS66 INS66 INS42 INS66 INS66 INS66 INS42 INS66 INS66 INS42 INS66 INS42 INS32 INS66 INS66 INS66 INS66 INS66 INS66 INS66 INS42 INS66 INS66 INS42 INS66 INS42 INS42 INS42 INS42 INS42 INS41 INS25 MOV11 INS41 INS62 INS8 INS25 MOV32 INS42 INS43 INS41 INS62 INS8 MOV25 INS42 INS32 INS42 INS43 INS41 INS42 INS42 INS42 INS32 INS42 INS42 INS41 INS41 MOV14 MOV14 DEL53 DEL53 DEL53 DEL53