HADOOP-15358. SFTPConnectionPool connections leakage. Contributed by Mikhail Pryakhin.

+import com.google.common.annotations.VisibleForTesting;
-          root.makeQualified(this.getUri(), this.getWorkingDirectory()));
+          root.makeQualified(this.getUri(), this.getWorkingDirectory(client)));
-            this.getUri(), this.getWorkingDirectory()));
+            this.getUri(), this.getWorkingDirectory(channel)));
-
-    FSDataInputStream fis =
-        new FSDataInputStream(new SFTPInputStream(is, channel, statistics));
-    return fis;
+    return new FSDataInputStream(new SFTPInputStream(is, statistics)){
+      @Override
+      public void close() throws IOException {
+        super.close();
+        disconnect(channel);
+      }
+    };
+  /**
+   * Convenience method, so that we don't open a new connection when using this
+   * method from within another method. Otherwise every API invocation incurs
+   * the overhead of opening/closing a TCP connection.
+   */
+  private Path getWorkingDirectory(ChannelSftp client) {
+    // Return home directory always since we do not maintain state.
+    return getHomeDirectory(client);
+  }
+
+  /**
+   * Convenience method, so that we don't open a new connection when using this
+   * method from within another method. Otherwise every API invocation incurs
+   * the overhead of opening/closing a TCP connection.
+   */
+  private Path getHomeDirectory(ChannelSftp channel) {
+    try {
+      return new Path(channel.pwd());
+    } catch (Exception ioe) {
+      return null;
+    }
+  }
+
+
+  @VisibleForTesting
+  SFTPConnectionPool getConnectionPool() {
+    return connectionPool;
+  }

INS26 INS40 INS31 INS31 INS31 INS29 INS83 INS43 INS42 INS44 INS8 INS29 INS83 INS43 INS42 INS44 INS8 INS78 INS43 INS42 INS8 INS41 INS65 INS42 INS43 INS42 INS41 INS65 INS42 INS43 INS42 INS54 INS42 INS42 INS41 INS14 INS66 INS66 INS66 INS42 INS32 INS66 INS66 INS66 INS42 INS8 INS12 INS42 MOV43 INS14 INS1 INS42 INS42 INS41 INS44 INS8 MOV43 INS42 INS42 INS31 INS14 INS43 INS42 INS41 INS42 INS78 INS83 INS39 INS42 INS43 INS8 INS43 INS32 INS42 INS33 INS42 INS42 INS21 INS21 INS42 INS42 INS42 INS42 INS48 INS32 INS42 INS42 INS42 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL14 DEL14 DEL59 DEL60 DEL42 DEL41