HDFS-3211. Add fence(..) and replace NamenodeRegistration with JournalInfo and epoch in JournalProtocol.  Contributed by suresh 


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1310649 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.server.protocol.FenceResponse;
+import org.apache.hadoop.hdfs.server.protocol.JournalInfo;
-  public boolean setSafeMode(SafeModeAction action) throws IOException {
+  public boolean setSafeMode(@SuppressWarnings("unused") SafeModeAction action)
+      throws IOException {
-     * @param nodeReg node registration
-     * @throws UnregisteredNodeException if the registration is invalid
-    void verifyJournalRequest(NamenodeRegistration reg) throws IOException {
-      verifyVersion(reg.getLayoutVersion());
+    private void verifyJournalRequest(JournalInfo journalInfo)
+        throws IOException {
+      verifyVersion(journalInfo.getLayoutVersion());
-      if (reg.getNamespaceID() != expectedNamespaceID) {
+      if (journalInfo.getNamespaceId() != expectedNamespaceID) {
-            + " actual " + reg.getNamespaceID();
+            + " actual " + journalInfo.getNamespaceId();
-        throw new UnregisteredNodeException(reg);
+        throw new UnregisteredNodeException(journalInfo);
-      if (!reg.getClusterID().equals(namesystem.getClusterId())) {
+      if (!journalInfo.getClusterId().equals(namesystem.getClusterId())) {
-            + reg.getClusterID() + " actual " + namesystem.getClusterId();
+            + journalInfo.getClusterId() + " actual " + namesystem.getClusterId();
-        throw new UnregisteredNodeException(reg);
+        throw new UnregisteredNodeException(journalInfo);
-
-    public void startLogSegment(NamenodeRegistration registration, long txid)
-        throws IOException {
+    public void startLogSegment(JournalInfo journalInfo, long epoch,
+        long txid) throws IOException {
-      verifyJournalRequest(registration);
+      verifyJournalRequest(journalInfo);
-    public void journal(NamenodeRegistration nnReg,
-        long firstTxId, int numTxns,
-        byte[] records) throws IOException {
+    public void journal(JournalInfo journalInfo, long epoch, long firstTxId,
+        int numTxns, byte[] records) throws IOException {
-      verifyJournalRequest(nnReg);
+      verifyJournalRequest(journalInfo);
+
+    @Override
+    public FenceResponse fence(JournalInfo journalInfo, long epoch,
+        String fencerInfo) throws IOException {
+      LOG.info("Fenced by " + fencerInfo + " with epoch " + epoch);
+      throw new UnsupportedOperationException(
+          "BackupNode does not support fence");
+    }

INS26 INS26 INS40 INS40 INS31 INS79 INS83 INS44 INS44 INS78 INS83 INS43 INS42 INS44 INS44 INS44 INS43 INS8 INS42 INS45 UPD43 UPD42 UPD43 UPD42 INS39 INS42 UPD43 UPD42 INS39 INS42 INS42 INS42 INS43 INS42 INS39 INS42 INS43 INS42 INS42 INS21 INS53 UPD42 UPD42 UPD42 INS42 INS42 INS32 INS14 UPD42 UPD42 INS42 INS42 INS27 INS43 INS45 UPD42 UPD42 UPD42 INS45 INS42 INS45 INS42 INS42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 DEL42 DEL66 DEL65 DEL42 DEL66 DEL65