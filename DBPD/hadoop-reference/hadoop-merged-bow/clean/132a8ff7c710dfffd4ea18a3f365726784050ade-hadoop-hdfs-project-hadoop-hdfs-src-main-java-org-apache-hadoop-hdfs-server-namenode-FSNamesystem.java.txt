Merging r1541618 through r1542122 from trunk to branch HDFS-2832

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2832@1542125 13f79535-47bb-0310-9956-ffa450edef68

-      blockManager.getDatanodeManager().setSendCachingCommands(true);
+      blockManager.getDatanodeManager().setShouldSendCachingCommands(true);
-      blockManager.getDatanodeManager().setSendCachingCommands(false);
+      blockManager.getDatanodeManager().setShouldSendCachingCommands(false);
+  public int getReadHoldCount() {
+    return this.fsLock.getReadHoldCount();
+  }
+
+  public int getWriteHoldCount() {
+    return this.fsLock.getWriteHoldCount();
+  }
+
+    removeBlocksAndUpdateSafemodeTotal(blocks);
+  }
+
+  /**
+   * Removes the blocks from blocksmap and updates the safemode blocks total
+   * 
+   * @param blocks
+   *          An instance of {@link BlocksMapUpdateInfo} which contains a list
+   *          of blocks that need to be removed from blocksMap
+   */
+  void removeBlocksAndUpdateSafemodeTotal(BlocksMapUpdateInfo blocks) {
+    assert hasWriteLock();
-        LOG.debug("Adjusting safe-mode totals for deletion of " + src + ":" +
-            "decreasing safeBlocks by " + numRemovedSafe +
-            ", totalBlocks by " + numRemovedComplete);
+        LOG.debug("Adjusting safe-mode totals for deletion."
+            + "decreasing safeBlocks by " + numRemovedSafe
+            + ", totalBlocks by " + numRemovedComplete);
-    blockinfo.setGenerationStamp(newBlock.getGenerationStamp());
+    blockinfo.setGenerationStampAndVerifyReplicas(newBlock.getGenerationStamp());
+    BlocksMapUpdateInfo collectedBlocks = new BlocksMapUpdateInfo();
-      BlocksMapUpdateInfo collectedBlocks = new BlocksMapUpdateInfo();
-      this.removeBlocks(collectedBlocks);
-      collectedBlocks.clear();
-    
+
+    removeBlocks(collectedBlocks);
+    collectedBlocks.clear();
+

INS31 INS31 INS31 INS83 INS39 INS42 INS8 INS83 INS39 INS42 INS8 MOV29 INS39 INS42 MOV44 INS44 MOV44 INS8 INS29 UPD42 MOV21 INS41 INS41 INS43 INS42 INS6 MOV21 MOV25 MOV25 INS21 INS65 INS65 MOV60 INS21 MOV21 INS32 INS32 INS42 INS32 INS32 INS66 INS42 INS66 INS65 INS66 INS66 INS32 INS22 INS42 INS22 INS42 INS42 INS42 INS42 INS42 UPD42 INS42 INS42 INS52 INS42 INS52 INS42 UPD42 UPD42 INS27 UPD45 MOV45 MOV45 DEL42 DEL45 DEL52 DEL42 DEL42 DEL32 DEL21