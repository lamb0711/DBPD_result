HDFS-8801. Convert BlockInfoUnderConstruction as a feature. Contributed by Jing Zhao.

-import org.apache.hadoop.hdfs.server.blockmanagement.BlockInfoContiguousUnderConstruction;
-      Block oldLastBlock = oldBlocks[oldBlocks.length - 1];
+      BlockInfo oldLastBlock = oldBlocks[oldBlocks.length - 1];
-      if (oldLastBlock instanceof BlockInfoContiguousUnderConstruction) {
-        fsNamesys.getBlockManager().forceCompleteBlock(file,
-            (BlockInfoContiguousUnderConstruction) oldLastBlock);
+      if (!oldLastBlock.isComplete()) {
+        fsNamesys.getBlockManager().forceCompleteBlock(file, oldLastBlock);
-    BlockInfo newBI = new BlockInfoContiguousUnderConstruction(
-          newBlock, file.getPreferredBlockReplication());
+    BlockInfo newBI = new BlockInfoContiguous(newBlock,
+        file.getPreferredBlockReplication());
+    newBI.convertToBlockUnderConstruction(
+        HdfsServerConstants.BlockUCState.UNDER_CONSTRUCTION, null);
-      if (oldBlock instanceof BlockInfoContiguousUnderConstruction &&
+      if (!oldBlock.isComplete() &&
-        fsNamesys.getBlockManager().forceCompleteBlock(file,
-            (BlockInfoContiguousUnderConstruction) oldBlock);
+        fsNamesys.getBlockManager().forceCompleteBlock(file, oldBlock);
-          newBI = new BlockInfoContiguousUnderConstruction(
-              newBlock, file.getPreferredBlockReplication());
+          newBI = new BlockInfoContiguous(newBlock,
+              file.getPreferredBlockReplication());
+          newBI.convertToBlockUnderConstruction(
+              HdfsServerConstants.BlockUCState.UNDER_CONSTRUCTION, null);

INS21 INS32 INS42 INS42 INS40 INS33 UPD43 INS38 UPD43 UPD42 INS32 UPD42 INS38 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS21 INS32 INS42 INS42 INS40 INS33 UPD43 UPD42 DEL40 DEL26 DEL42 DEL42 DEL43 DEL62 DEL42 DEL43 DEL42 DEL11 DEL42 DEL42 DEL43 DEL62 DEL42 DEL43 DEL42 DEL11