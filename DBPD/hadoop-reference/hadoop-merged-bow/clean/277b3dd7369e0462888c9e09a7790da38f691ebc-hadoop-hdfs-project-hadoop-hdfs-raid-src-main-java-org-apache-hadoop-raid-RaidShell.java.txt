MAPREDUCE-3868. Make Raid Compile. (Weiyan Wang via schen)



git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1351548 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.fs.FileUtil;
-      LOG.debug("RaidShell recoverFile for " + path + " corruptOffset " + corruptOffset);
-      paths[j] = new Path(raidnode.recoverFile(path, corruptOffset));
-      LOG.debug("Raidshell created recovery file " + paths[j]);
+      LOG.info("RaidShell recoverFile for " + path + " corruptOffset " + corruptOffset);
+      Path recovered = new Path("/tmp/recovered." + System.currentTimeMillis());
+      FileSystem fs = recovered.getFileSystem(conf);
+      DistributedFileSystem dfs = (DistributedFileSystem)fs;
+      Configuration raidConf = new Configuration(conf);
+      raidConf.set("fs.hdfs.impl",
+                     "org.apache.hadoop.hdfs.DistributedRaidFileSystem");
+      raidConf.set("fs.raid.underlyingfs.impl",
+                     "org.apache.hadoop.hdfs.DistributedFileSystem");
+      raidConf.setBoolean("fs.hdfs.impl.disable.cache", true);
+      java.net.URI dfsUri = dfs.getUri();
+      FileSystem raidFs = FileSystem.get(dfsUri, raidConf);
+      FileUtil.copy(raidFs, new Path(path), fs, recovered, false, conf);
+
+      paths[j] = recovered;
+      LOG.info("Raidshell created recovery file " + paths[j]);

INS26 INS40 INS60 INS60 INS60 INS60 INS21 INS21 INS21 INS60 INS60 INS21 MOV43 INS59 INS43 INS59 INS43 INS59 INS43 INS59 INS32 INS32 INS32 INS43 INS59 INS43 INS59 INS32 INS7 UPD42 INS42 INS14 INS42 INS42 INS32 INS42 INS42 INS11 INS42 INS42 INS14 INS42 INS42 INS45 INS45 INS42 INS42 INS45 INS45 INS42 INS42 INS45 INS9 INS40 INS42 INS32 INS42 INS42 INS32 INS42 INS42 UPD42 MOV42 INS14 INS42 INS42 INS9 UPD42 MOV42 MOV2 INS42 UPD42 INS43 INS27 INS42 INS42 INS42 INS43 INS42 INS43 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS43 INS42 INS42 INS45 INS32 INS42 INS42 INS42 INS42 INS42 DEL42 DEL42 DEL32 DEL14 DEL7