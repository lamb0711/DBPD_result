Merge trunk into auto-HA branch


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-3042@1327724 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.hdfs.server.common.Storage;
+import org.apache.hadoop.util.VersionInfo;
+import org.apache.hadoop.util.VersionUtil;
-    String nsBuildVer = nsInfo.getBuildVersion();
-    String stBuildVer = Storage.getBuildVersion();
-    if (!nsBuildVer.equals(stBuildVer)) {
-      LOG.warn("Data-node and name-node Build versions must be the same. " +
-        "Namenode build version: " + nsBuildVer + "Datanode " +
-        "build version: " + stBuildVer);
-      throw new IncorrectVersionException(nsBuildVer, "namenode", stBuildVer);
+    String nnVersion = nsInfo.getSoftwareVersion();
+    String minimumNameNodeVersion = dnConf.getMinimumNameNodeVersion();
+    if (VersionUtil.compareVersions(nnVersion, minimumNameNodeVersion) < 0) {
+      IncorrectVersionException ive = new IncorrectVersionException(
+          minimumNameNodeVersion, nnVersion, "NameNode", "DataNode");
+      LOG.warn(ive.getMessage());
+      throw ive;
+    }
+    String dnVersion = VersionInfo.getVersion();
+    if (!nnVersion.equals(dnVersion)) {
+      LOG.info("Reported NameNode version '" + nnVersion + "' does not match " +
+          "DataNode version '" + dnVersion + "' but is within acceptable " +
+          "limits. Note: This is normal during a rolling upgrade.");
-      LOG.warn("Data-node and name-node layout versions must be the same." +
+      LOG.warn("DataNode and NameNode layout versions must be the same." +

MOV26 INS26 UPD40 INS40 INS60 INS25 MOV43 INS59 INS27 INS8 INS43 UPD42 INS42 INS32 INS32 INS34 INS60 INS21 INS53 INS42 UPD42 UPD42 INS42 INS42 INS42 INS42 INS42 INS42 INS43 INS59 INS32 INS42 UPD42 UPD42 UPD42 UPD42 INS42 INS42 INS14 INS42 INS42 INS32 UPD42 MOV43 INS42 INS42 INS45 INS45 INS42 INS42 UPD45 MOV45 UPD42 UPD45 UPD45 UPD42 INS45 INS45 UPD45 DEL45 DEL27 DEL42 DEL45 DEL42 DEL14 DEL53