Merge r1360400 through r1399945 from trunk.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1399950 13f79535-47bb-0310-9956-ffa450edef68

-import static org.apache.hadoop.hdfs.server.common.Util.now;
+import static org.apache.hadoop.util.Time.now;
+  @Override
-   * @throws QuotaExceededException 
-   * @throws FileAlreadyExistsException 
+   * @throws FileAlreadyExistsException
+   * @throws QuotaExceededException
+   * @throws UnresolvedLinkException
-    if (!mkdirs(new Path(path).getParent().toString(), permissions, true,
-        modTime)) {
+    
+    Path parent = new Path(path).getParent();
+    if (parent == null) {
+      // Trying to add "/" as a file - this path has no
+      // parent -- avoids an NPE below.
+      return null;
+    }
+    
+    if (!mkdirs(parent.toString(), permissions, true, modTime)) {
-  /**
-   */
-                            String clientMachine)
-      throws UnresolvedLinkException {
+                            String clientMachine) {
+      if(NameNode.stateChangeLog.isDebugEnabled()) {
+        NameNode.stateChangeLog.debug(
+            "DIR* FSDirectory.unprotectedAddFile: exception when add " + path
+                + " to the file system", e);
+      }
-      INode newNode, boolean propagateModTime) throws UnresolvedLinkException {
+      INode newNode, boolean propagateModTime) {
-          fileINode.getPreferredBlockSize()*fileINode.getReplication(), true);
+          fileINode.getPreferredBlockSize()*fileINode.getBlockReplication(), true);
-            fileINode.getReplication(),
+            fileINode.getBlockReplication(),
-        -fileNode.getPreferredBlockSize()*fileNode.getReplication(), true);
+        -fileNode.getPreferredBlockSize()*fileNode.getBlockReplication(), true);
-    final short oldRepl = fileNode.getReplication();
+    final short oldRepl = fileNode.getBlockReplication();
-       replication = fileNode.getReplication();
+       replication = fileNode.getBlockReplication();
-        replication = fileNode.getReplication();
+        replication = fileNode.getBlockReplication();

UPD40 INS78 INS42 INS65 INS60 INS25 INS42 UPD42 INS43 INS59 INS27 MOV8 INS8 INS42 INS42 MOV32 INS42 INS33 INS41 INS33 INS25 MOV43 UPD42 INS42 INS32 INS8 UPD42 INS40 INS42 INS21 MOV43 UPD42 UPD42 INS32 UPD42 UPD42 INS40 INS42 INS27 INS42 INS45 INS42 INS45 DEL66 DEL66 DEL29 DEL42 DEL43 DEL42 DEL43