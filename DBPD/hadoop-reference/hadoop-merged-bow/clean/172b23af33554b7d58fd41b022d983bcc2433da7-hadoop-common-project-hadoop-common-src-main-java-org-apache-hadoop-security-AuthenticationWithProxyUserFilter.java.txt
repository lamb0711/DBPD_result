HADOOP-14077. Add ability to access jmx via proxy.  Contributed by Yuanbo Liu.

+import org.apache.commons.logging.Log;
+import org.apache.commons.logging.LogFactory;
-import org.apache.hadoop.util.HttpExceptionUtils;
+  public static final Log LOG =
+      LogFactory.getLog(AuthenticationWithProxyUserFilter.class);
+
-    // authorize proxy user before calling next filter.
-    String proxyUser = getDoAs(request);
+    final String proxyUser = getDoAs(request);
-      UserGroupInformation realUser =
-          UserGroupInformation.createRemoteUser(request.getRemoteUser());
-      UserGroupInformation proxyUserInfo =
-          UserGroupInformation.createProxyUser(proxyUser, realUser);
-      try {
-        ProxyUsers.authorize(proxyUserInfo, request.getRemoteAddr());
-      } catch (AuthorizationException ex) {
-        HttpExceptionUtils.createServletExceptionResponse(response,
-            HttpServletResponse.SC_FORBIDDEN, ex);
-        // stop filter chain if there is an Authorization Exception.
-        return;
-      }
-
-      final UserGroupInformation finalProxyUser = proxyUserInfo;
-      request = new HttpServletRequestWrapper(request) {
+      final HttpServletRequest finalReq = request;
+      request = new HttpServletRequestWrapper(finalReq) {
+
+        private String getRemoteOrProxyUser() throws AuthorizationException {
+          UserGroupInformation realUser =
+              UserGroupInformation.createRemoteUser(finalReq.getRemoteUser());
+          UserGroupInformation proxyUserInfo =
+              UserGroupInformation.createProxyUser(proxyUser, realUser);
+          ProxyUsers.authorize(proxyUserInfo, finalReq.getRemoteAddr());
+          return proxyUserInfo.getUserName();
+        }
+
-          return finalProxyUser.getUserName();
+          try {
+            return getRemoteOrProxyUser();
+          } catch (AuthorizationException ex) {
+            LOG.error("Unable to verify proxy user: " + ex.getMessage(), ex);
+          }
+          return null;

MOV26 INS26 UPD40 INS40 INS23 INS83 INS83 INS83 INS43 INS59 INS42 INS42 INS32 INS42 INS42 INS57 INS83 INS43 INS60 INS21 INS42 INS83 INS43 INS59 INS7 INS42 INS42 INS42 INS42 INS14 MOV43 INS42 INS1 INS31 INS31 INS83 INS43 INS42 INS43 INS8 MOV78 INS83 MOV43 INS42 INS8 INS42 INS42 MOV60 MOV60 MOV21 INS41 INS54 INS41 INS32 INS8 INS12 INS33 UPD42 MOV42 UPD42 MOV42 INS41 MOV44 INS8 UPD42 INS32 MOV21 UPD42 INS42 INS32 INS42 INS42 INS27 INS42 INS45 INS32 UPD42 MOV42 UPD42 MOV42 DEL42 DEL42 DEL83 DEL42 DEL32 DEL41 DEL8 DEL31 DEL1 DEL14 DEL7 DEL8 DEL42 DEL40 DEL42 DEL32 DEL21 DEL41 DEL8 DEL12 DEL54 DEL83 DEL42 DEL43 DEL42 DEL42 DEL59 DEL60