Merge trunk into the HDFS-347 branch.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-347@1467511 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.security.SecurityUtil;
+import org.apache.hadoop.yarn.security.client.RMTokenSelector;
-@SuppressWarnings({ "rawtypes", "unchecked" })
+@SuppressWarnings("unchecked")
-  /* usually is false unless the jobclient get delegation token is 
-   *  called. This is a hack wherein we do return a token from RM 
-   *  on getDelegationtoken but due to the restricted api on jobclient
-   *  we just add a job history DT token when submitting a job.
-   */
-  private static final boolean DEFAULT_HS_DELEGATION_TOKEN_REQUIRED = 
-      false;
-  
+  void addHistoyToken(Credentials ts) throws IOException, InterruptedException {
+    /* check if we have a hsproxy, if not, no need */
+    MRClientProtocol hsProxy = clientCache.getInitializedHSProxy();
+    if (UserGroupInformation.isSecurityEnabled() && (hsProxy != null)) {
+      /*
+       * note that get delegation token was called. Again this is hack for oozie
+       * to make sure we add history server delegation tokens to the credentials
+       */
+      RMTokenSelector tokenSelector = new RMTokenSelector();
+      Text service = SecurityUtil.buildTokenService(resMgrDelegate
+          .getConnectAddress());
+      if (tokenSelector.selectToken(service, ts.getAllTokens()) != null) {
+        Text hsService = SecurityUtil.buildTokenService(hsProxy
+            .getConnectAddress());
+        if (ts.getToken(hsService) == null) {
+          ts.addToken(hsService, getDelegationTokenFromHS(hsProxy));
+        }
+      }
+    }
+  }
+  
+  @VisibleForTesting
-    /* check if we have a hsproxy, if not, no need */
-    MRClientProtocol hsProxy = clientCache.getInitializedHSProxy();
-    if (hsProxy != null) {
-      // JobClient will set this flag if getDelegationToken is called, if so, get
-      // the delegation tokens for the HistoryServer also.
-      if (conf.getBoolean(JobClient.HS_DELEGATION_TOKEN_REQUIRED, 
-          DEFAULT_HS_DELEGATION_TOKEN_REQUIRED)) {
-        Token hsDT = getDelegationTokenFromHS(hsProxy);
-        ts.addToken(hsDT.getService(), hsDT);
-      }
-    }
-
+    addHistoyToken(ts);
+    
-        .newContainerLaunchContext(null, UserGroupInformation
-            .getCurrentUser().getShortUserName(), capability, localResources,
+        .newContainerLaunchContext(UserGroupInformation
+            .getCurrentUser().getShortUserName(), localResources,
-    appContext.setUser(                                        // User name
-        UserGroupInformation.getCurrentUser().getShortUserName());
-
+    appContext.setResource(capability);

INS26 INS26 INS40 INS40 INS31 INS45 INS78 INS39 INS42 INS44 INS43 INS43 INS8 INS42 INS43 INS42 INS42 INS42 MOV60 INS25 MOV21 INS60 INS21 INS42 INS27 INS8 MOV43 INS59 INS32 INS32 INS36 INS60 INS60 INS25 UPD42 UPD42 MOV42 MOV42 MOV32 MOV42 UPD42 MOV42 UPD42 MOV42 MOV42 INS42 INS42 MOV27 INS43 INS59 INS43 INS59 INS27 INS8 INS42 UPD42 INS42 INS42 INS42 INS33 UPD42 INS42 INS42 UPD42 MOV42 INS14 INS42 INS42 INS32 INS32 INS33 INS60 INS25 INS43 INS42 INS42 INS32 INS42 INS42 INS42 INS32 INS43 INS59 INS27 INS8 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS32 INS33 INS21 INS42 INS42 INS32 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 MOV32 DEL45 DEL45 DEL4 DEL83 DEL83 DEL83 DEL39 DEL9 DEL59 DEL23 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL40 DEL42 DEL32 DEL42 DEL43 DEL42 DEL59 DEL60 DEL8 DEL25 DEL8 DEL25 DEL42 DEL33 DEL42 DEL42 DEL32 DEL32 DEL42 DEL42 DEL42 DEL33 DEL42 DEL42 DEL32 DEL59 DEL60 DEL21