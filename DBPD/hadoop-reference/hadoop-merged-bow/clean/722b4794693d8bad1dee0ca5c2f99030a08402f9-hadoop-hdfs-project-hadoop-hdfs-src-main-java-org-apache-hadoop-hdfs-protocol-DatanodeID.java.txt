HDFS-7434. DatanodeID hashCode should not be mutable. Contributed by Daryn Sharp.

-  private int hashCode = -1;
-  private String datanodeUuid = null;
+  private final String datanodeUuid;
+    this(from.getDatanodeUuid(), from);
+  }
+
+  @VisibleForTesting
+  public DatanodeID(String datanodeUuid, DatanodeID from) {
-        from.getDatanodeUuid(),
+        datanodeUuid,
-    this.ipAddr = ipAddr;
+    setIpAndXferPort(ipAddr, xferPort);
-    this.xferPort = xferPort;
-    updateXferAddrAndInvalidateHashCode();
+    //updated during registration, preserve former xferPort
+    setIpAndXferPort(ipAddr, xferPort);
+  }
+
+  private void setIpAndXferPort(String ipAddr, int xferPort) {
+    // build xferAddr string to reduce cost of frequent use
-    updateXferAddrAndInvalidateHashCode();
+    this.xferPort = xferPort;
+    this.xferAddr = ipAddr + ":" + xferPort;
-  @VisibleForTesting
-  public void setDatanodeUuidForTesting(String datanodeUuid) {
-    this.datanodeUuid = datanodeUuid;
-    updateXferAddrAndInvalidateHashCode();
-  }
-
-    if (hashCode == -1) {
-      int newHashCode = xferAddr.hashCode() ^ datanodeUuid.hashCode();
-      hashCode = newHashCode & Integer.MAX_VALUE;
-    }
-    return hashCode;
+    return datanodeUuid.hashCode();
-    ipAddr = nodeReg.getIpAddr();
+    setIpAndXferPort(nodeReg.getIpAddr(), nodeReg.getXferPort());
-    xferPort = nodeReg.getXferPort();
-    updateXferAddrAndInvalidateHashCode();
-
-  // NOTE: mutable hash codes are dangerous, however this class chooses to
-  // use them.  this method must be called when a value mutates that is used
-  // to compute the hash, equality, or comparison of instances.
-  private void updateXferAddrAndInvalidateHashCode() {
-    xferAddr = ipAddr + ":" + xferPort;
-    // can't compute new hash yet because uuid might still null...
-    hashCode = -1;
-  }

MOV31 INS31 INS83 INS83 INS42 INS44 INS8 MOV78 INS44 MOV21 UPD83 UPD42 INS44 INS8 INS43 INS42 INS17 INS43 INS42 INS21 UPD42 INS39 INS42 MOV21 MOV21 MOV21 INS42 MOV32 INS42 INS42 INS42 INS32 MOV32 INS32 UPD42 INS42 INS42 INS42 INS42 UPD42 MOV42 INS22 INS42 MOV32 MOV32 INS52 INS42 DEL83 DEL39 DEL42 DEL34 DEL38 DEL59 DEL23 DEL33 DEL52 DEL42 DEL22 DEL42 DEL7 DEL21 DEL32 DEL21 DEL42 DEL52 DEL42 DEL22 DEL42 DEL7 DEL21 DEL42 DEL32 DEL21 DEL8 DEL42 DEL34 DEL38 DEL27 DEL39 DEL42 DEL42 DEL42 DEL32 DEL27 DEL59 DEL60 DEL42 DEL42 DEL40 DEL27 DEL7 DEL21 DEL8 DEL25 DEL42 DEL42 DEL7 DEL42 DEL7 DEL21 DEL42 DEL32 DEL21 DEL83 DEL39 DEL42 DEL42 DEL34 DEL38 DEL7 DEL21 DEL8 DEL31