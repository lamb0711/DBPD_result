YARN-3222. Fixed NPE on RMNodeImpl#ReconnectNodeTransition when a node is reconnected with a different port. Contributed by Rohith Sharmaks

-        
+
-          if (rmNode.getState() != NodeState.UNHEALTHY) {
-            // Only add new node if old state is not UNHEALTHY
+          if (rmNode.getState().equals(NodeState.RUNNING)) {
+            // Only add new node if old state is RUNNING
-        rmNode.totalCapability = newNode.getTotalCapability();
+        boolean isCapabilityChanged = false;
+        if (rmNode.getTotalCapability() != newNode.getTotalCapability()) {
+          rmNode.totalCapability = newNode.getTotalCapability();
+          isCapabilityChanged = true;
+        }
-      }
-      if (null != reconnectEvent.getRunningApplications()) {
-      }
-      rmNode.context.getDispatcher().getEventHandler().handle(
-          new NodesListManagerEvent(
-              NodesListManagerEventType.NODE_USABLE, rmNode));
-      if (rmNode.getState().equals(NodeState.RUNNING)) {
-        // Update scheduler node's capacity for reconnect node.
-        rmNode.context.getDispatcher().getEventHandler().handle(
-            new NodeResourceUpdateSchedulerEvent(rmNode, 
-                ResourceOption.newInstance(newNode.getTotalCapability(), -1)));
+        if (isCapabilityChanged
+            && rmNode.getState().equals(NodeState.RUNNING)) {
+          // Update scheduler node's capacity for reconnect node.
+          rmNode.context
+              .getDispatcher()
+              .getEventHandler()
+              .handle(
+                  new NodeResourceUpdateSchedulerEvent(rmNode, ResourceOption
+                      .newInstance(newNode.getTotalCapability(), -1)));
+        }
-      

INS60 INS25 MOV70 INS25 INS39 INS59 INS27 INS8 INS27 MOV8 INS42 INS9 INS32 INS32 MOV21 INS21 INS42 INS32 MOV32 INS42 INS42 INS42 INS42 INS7 INS32 INS42 INS40 INS42 INS9 INS42 INS42 MOV42 DEL32 DEL40 DEL27 DEL33 DEL42 DEL42 DEL32 DEL27 DEL8 DEL25 DEL40 DEL42 DEL32 DEL42 DEL32 DEL42 DEL42 DEL43 DEL40 DEL42 DEL14 DEL32 DEL21 DEL25