HDFS-7811. Avoid recursive call getStoragePolicyID in INodeFile#computeQuotaUsage. Contributed by Xiaoyu Yao and Jing Zhao.

+   * Entry point for FSDirectory where blockStoragePolicyId is given its initial
+   * value.
-    return computeQuotaUsage(bsps, new QuotaCounts.Builder().build(), true);
+    final byte storagePolicyId = isSymlink() ?
+        BlockStoragePolicySuite.ID_UNSPECIFIED : getStoragePolicyID();
+    return computeQuotaUsage(bsps, storagePolicyId,
+        new QuotaCounts.Builder().build(), true, Snapshot.CURRENT_STATE_ID);
+   * @param blockStoragePolicyId block storage policy id of the current INode
-    BlockStoragePolicySuite bsps,
+    BlockStoragePolicySuite bsps, byte blockStoragePolicyId,
-    return computeQuotaUsage(bsps, counts, useCache, Snapshot.CURRENT_STATE_ID);
+    final byte storagePolicyId = isSymlink() ?
+        BlockStoragePolicySuite.ID_UNSPECIFIED : getStoragePolicyID();
+    return computeQuotaUsage(bsps, storagePolicyId, counts,
+        useCache, Snapshot.CURRENT_STATE_ID);
+   * Get the storage policy ID while computing quota usage
+   * @param parentStoragePolicyId the storage policy ID of the parent directory
+   * @return the storage policy ID of this INode. Note that for an
+   * {@link INodeSymlink} we return {@link BlockStoragePolicySuite#ID_UNSPECIFIED}
+   * instead of throwing Exception
+   */
+  public byte getStoragePolicyIDForQuota(byte parentStoragePolicyId) {
+    byte localId = isSymlink() ?
+        BlockStoragePolicySuite.ID_UNSPECIFIED : getLocalStoragePolicyID();
+    return localId != BlockStoragePolicySuite.ID_UNSPECIFIED ?
+        localId : parentStoragePolicyId;
+  }
+
+  /**

INS31 INS44 INS29 INS83 INS39 INS42 INS44 INS8 INS60 INS65 INS39 INS42 INS60 INS65 INS65 INS65 INS39 INS42 INS60 INS41 INS66 INS66 INS83 INS39 INS59 INS42 INS66 INS83 INS39 INS59 INS66 INS42 INS66 INS66 INS65 INS66 INS65 INS66 INS39 INS59 INS16 INS42 INS16 INS42 INS40 INS42 INS16 INS42 INS42 INS67 INS42 INS16 INS27 INS42 INS42 INS32 INS40 INS32 INS32 INS40 INS32 INS42 INS42 INS32 INS40 INS32 INS42 INS40 INS42 INS42 INS42 INS42 INS42 INS42