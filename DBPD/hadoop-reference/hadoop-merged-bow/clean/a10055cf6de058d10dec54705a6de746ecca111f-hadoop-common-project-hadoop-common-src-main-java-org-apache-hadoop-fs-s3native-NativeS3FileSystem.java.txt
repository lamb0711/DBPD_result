HADOOP-9258 Add stricter tests to FileSystemContractTestBase (includes fixes for production code HADOOP-9261 & HADOOP-9265 and test enhancements HADOOP-9228, HADOOP-9227 & HADOOP-9259)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1460646 13f79535-47bb-0310-9956-ffa450edef68

+    final String debugPreamble = "Renaming '" + src + "' to '" + dst + "' - ";
+      if (LOG.isDebugEnabled()) {
+        LOG.debug(debugPreamble +
+                  "returning false as cannot rename the root of a filesystem");
+      }
-    final String debugPreamble = "Renaming '" + src + "' to '" + dst + "' - ";
-
+    //get status of source
+    boolean srcIsFile;
+    try {
+      srcIsFile = getFileStatus(src).isFile();
+    } catch (FileNotFoundException e) {
+      //bail out fast if the source does not exist
+      if (LOG.isDebugEnabled()) {
+        LOG.debug(debugPreamble + "returning false as src does not exist");
+      }
+      return false;
+    }
-    String dstKey;
+    String dstKey = pathToKey(makeAbsolute(dst));
+
+        //destination is a file.
+        //you can't copy a file or a directory onto an existing file
+        //except for the special case of dest==src, which is a no-op
-              "returning false as dst is an already existing file");
+              "returning without rename as dst is an already existing file");
-        return false;
+        //exit, returning true iff the rename is onto self
+        return srcKey.equals(dstKey);
+        //destination exists and is a directory
+        //destination goes under the dst path, with the name of the
+        //source entry
+      //destination does not exist => the source file or directory
+      //is copied over with the name of the destination
-      dstKey = pathToKey(makeAbsolute(dst));
-    boolean srcIsFile;
-    try {
-      srcIsFile = getFileStatus(src).isFile();
-    } catch (FileNotFoundException e) {
-      if(LOG.isDebugEnabled()) {
-        LOG.debug(debugPreamble + "returning false as src does not exist");
+    //rename to self behavior follows Posix rules and is different
+    //for directories and files -the return code is driven by src type
+    if (srcKey.equals(dstKey)) {
+      //fully resolved destination key matches source: fail
+      if (LOG.isDebugEnabled()) {
+        LOG.debug(debugPreamble + "renamingToSelf; returning true");
-      return false;
+      return true;
+      //source is a file; COPY then DELETE
+      //src is a directory
+      //Verify dest is not a child of the parent
+      if (dstKey.startsWith(srcKey + "/")) {
+        if (LOG.isDebugEnabled()) {
+          LOG.debug(
+            debugPreamble + "cannot rename a directory to a subdirectory of self");
+        }
+        return false;
+      }
+      //create the subdir under the destination

MOV60 MOV54 INS25 INS25 MOV27 INS8 INS32 INS8 MOV25 MOV41 MOV32 INS42 INS42 INS42 INS25 INS41 INS25 MOV32 INS32 INS8 INS9 INS32 INS8 INS21 INS41 INS42 INS42 INS21 INS42 INS42 INS27 INS25 MOV41 INS32 INS32 INS32 INS32 INS42 INS45 INS32 INS8 INS42 INS42 INS27 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS27 INS42 INS42 INS21 INS42 INS45 INS42 INS45 INS32 INS42 INS42 INS27 UPD45 INS42 INS45 DEL42 DEL7 DEL21