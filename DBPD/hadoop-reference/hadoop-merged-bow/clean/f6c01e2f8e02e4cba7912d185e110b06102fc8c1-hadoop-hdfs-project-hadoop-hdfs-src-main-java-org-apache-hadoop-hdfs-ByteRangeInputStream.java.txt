Merge trunk into auto-HA branch


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-3042@1333291 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.commons.io.input.BoundedInputStream;
+import com.google.common.annotations.VisibleForTesting;
+
-    NORMAL, SEEK
+    NORMAL, SEEK, CLOSED
-  private InputStream getInputStream() throws IOException {
-    if (status != StreamStatus.NORMAL) {
-      
-      if (in != null) {
-        in.close();
-        in = null;
-      }
-      
-      // Use the original url if no resolved url exists, eg. if
-      // it's the first time a request is made.
-      final URLOpener opener =
-        (resolvedURL.getURL() == null) ? originalURL : resolvedURL;
-
-      final HttpURLConnection connection = opener.openConnection(startPos);
-      connection.connect();
-      checkResponseCode(connection);
-
-      final String cl = connection.getHeaderField(StreamFile.CONTENT_LENGTH);
-      filelength = (cl == null) ? -1 : Long.parseLong(cl);
-      in = connection.getInputStream();
-
-      resolvedURL.setURL(getResolvedUrl(connection));
-      status = StreamStatus.NORMAL;
+  @VisibleForTesting
+  protected InputStream getInputStream() throws IOException {
+    switch (status) {
+      case NORMAL:
+        break;
+      case SEEK:
+        if (in != null) {
+          in.close();
+        }
+        in = openInputStream();
+        status = StreamStatus.NORMAL;
+        break;
+      case CLOSED:
+        throw new IOException("Stream closed");
-    
-  private void update(final boolean isEOF, final int n)
-      throws IOException {
-    if (!isEOF) {
+  @VisibleForTesting
+  protected InputStream openInputStream() throws IOException {
+    // Use the original url if no resolved url exists, eg. if
+    // it's the first time a request is made.
+    final URLOpener opener =
+      (resolvedURL.getURL() == null) ? originalURL : resolvedURL;
+
+    final HttpURLConnection connection = opener.openConnection(startPos);
+    connection.connect();
+    checkResponseCode(connection);
+
+    final String cl = connection.getHeaderField(StreamFile.CONTENT_LENGTH);
+    if (cl == null) {
+      throw new IOException(StreamFile.CONTENT_LENGTH+" header is missing");
+    }
+    final long streamlength = Long.parseLong(cl);
+    filelength = startPos + streamlength;
+    // Java has a bug with >2GB request streams.  It won't bounds check
+    // the reads so the transfer blocks until the server times out
+    InputStream is =
+        new BoundedInputStream(connection.getInputStream(), streamlength);
+
+    resolvedURL.setURL(getResolvedUrl(connection));
+    
+    return is;
+  }
+  
+  private int update(final int n) throws IOException {
+    if (n != -1) {
+    return n;
+  @Override
-    update(b == -1, 1);
+    update((b == -1) ? -1 : 1);
+
+  @Override
+  public int read(byte b[], int off, int len) throws IOException {
+    return update(getInputStream().read(b, off, len));
+  }
+  @Override
-      status = StreamStatus.SEEK;
+      if (status != StreamStatus.CLOSED) {
+        status = StreamStatus.SEEK;
+      }
+  @Override
+  @Override
-}
+  
+  @Override
+  public void close() throws IOException {
+    if (in != null) {
+      in.close();
+      in = null;
+    }
+    status = StreamStatus.CLOSED;
+  }
+}

INS26 INS26 INS40 INS40 INS31 INS31 INS31 INS72 INS78 INS83 INS43 INS42 INS43 INS8 INS78 UPD83 UPD42 MOV8 UPD39 INS78 INS78 INS83 INS39 INS42 INS44 INS44 INS44 INS43 INS8 INS78 INS78 INS78 INS78 INS83 INS39 INS42 INS43 INS8 INS42 INS42 INS42 INS42 INS50 MOV41 INS42 INS25 INS60 INS60 INS41 INS41 INS42 INS42 INS39 INS42 INS85 INS39 INS42 INS39 INS42 INS42 INS41 INS42 INS42 INS42 INS42 INS42 MOV25 INS21 INS42 INS49 INS10 INS49 INS25 INS21 MOV21 INS10 INS49 INS53 MOV27 INS8 INS83 INS39 INS59 INS43 INS59 INS42 INS27 INS42 INS32 INS7 INS42 INS42 INS27 INS8 INS7 INS42 INS14 INS53 INS42 MOV32 INS27 INS42 INS42 INS14 INS42 MOV38 INS16 INS42 INS32 INS25 INS42 INS40 INS42 INS33 INS21 INS42 INS32 INS43 INS45 INS14 INS42 INS42 INS43 MOV32 INS42 INS36 INS38 INS34 INS32 INS42 INS42 INS42 INS42 INS27 INS8 INS32 INS42 INS42 INS43 INS27 INS42 MOV27 INS34 INS42 INS42 INS40 MOV21 INS42 INS42 INS42 INS40 INS45 DEL36 DEL16 DEL42 DEL7 DEL21 DEL42 DEL40 DEL27 DEL25 DEL8 DEL83 DEL39 DEL42 DEL44 DEL42 DEL38 DEL34