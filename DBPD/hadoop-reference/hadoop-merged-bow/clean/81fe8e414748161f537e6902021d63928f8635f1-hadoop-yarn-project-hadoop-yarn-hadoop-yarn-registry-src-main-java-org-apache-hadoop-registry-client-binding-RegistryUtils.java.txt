YARN-2677 registry punycoding of usernames doesn't fix all usernames to be  DNS-valid (stevel)

+import java.util.Locale;
-   * @param shortname username or ""
+   * @param username username or ""
-  public static String homePathForUser(String shortname) {
-    Preconditions.checkArgument(shortname != null, "null user");
+  public static String homePathForUser(String username) {
+    Preconditions.checkArgument(username != null, "null user");
-    if (shortname.startsWith(RegistryConstants.PATH_USERS)) {
-      return shortname;
+    if (username.startsWith(RegistryConstants.PATH_USERS)) {
+      return username;
-    if (shortname.isEmpty()) {
+    if (username.isEmpty()) {
+
+    // convert username to registry name
+    String convertedName = convertUsername(username);
+
-        encodeForRegistry(shortname));
+        encodeForRegistry(convertedName));
+  }
+
+  /**
+   * Convert the username to that which can be used for registry
+   * entries. Lower cases it,
+   * Strip the kerberos realm off a username if needed, and any "/" hostname
+   * entries
+   * @param username user
+   * @return the converted username
+   */
+  public static String convertUsername(String username) {
+    String converted= username.toLowerCase(Locale.ENGLISH);
+    int atSymbol = converted.indexOf('@');
+    if (atSymbol > 0) {
+      converted = converted.substring(0, atSymbol);
+    }
+    int slashSymbol = converted.indexOf('/');
+    if (slashSymbol > 0) {
+      converted = converted.substring(0, slashSymbol);
+    }
+    return converted;

INS26 INS40 INS31 INS29 INS83 INS83 INS43 INS42 INS44 INS8 UPD42 INS60 INS65 INS65 INS65 INS42 INS43 INS42 INS60 INS60 INS25 INS60 INS25 INS41 UPD42 INS43 INS59 INS66 INS66 INS66 INS66 INS42 INS66 INS66 INS42 INS43 INS59 INS39 INS59 INS27 INS8 INS39 INS59 INS27 INS8 INS42 UPD42 UPD42 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS32 INS42 INS34 INS21 INS42 INS32 INS42 INS34 INS21 UPD42 UPD42 INS42 INS42 UPD42 INS42 INS42 INS40 INS42 INS42 INS13 INS7 INS42 INS42 INS13 INS7 INS42 INS32 INS42 INS32 INS42 INS42 INS34 INS42 INS42 INS42 INS34 INS42