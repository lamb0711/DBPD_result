HDDS-2169. Avoid buffer copies while submitting client requests in Ratis. Contributed by Tsz-wo Sze(#1517).

+import org.apache.hadoop.hdds.ratis.ContainerCommandRequestMessage;
-import org.apache.ratis.thirdparty.com.google.protobuf.ByteString;
-      ContainerCommandRequestProto finalPayload =
-          ContainerCommandRequestProto.newBuilder(request)
-              .setTraceID(TracingUtil.exportCurrentSpan())
-              .build();
-      boolean isReadOnlyRequest = HddsUtils.isReadOnly(finalPayload);
-      ByteString byteString = finalPayload.toByteString();
-      if (LOG.isDebugEnabled()) {
-        LOG.debug("sendCommandAsync {} {}", isReadOnlyRequest,
-            sanitizeForDebug(finalPayload));
+      final ContainerCommandRequestMessage message
+          = ContainerCommandRequestMessage.toMessage(
+              request, TracingUtil.exportCurrentSpan());
+      if (HddsUtils.isReadOnly(request)) {
+        LOG.debug("sendCommandAsync ReadOnly {}", message);
+        return getClient().sendReadOnlyAsync(message);
+      } else {
+        LOG.debug("sendCommandAsync {}", message);
+        return getClient().sendAsync(message);
-      return isReadOnlyRequest ?
-          getClient().sendReadOnlyAsync(() -> byteString) :
-          getClient().sendAsync(() -> byteString);
-    }
-  }
-
-  private ContainerCommandRequestProto sanitizeForDebug(
-      ContainerCommandRequestProto request) {
-    switch (request.getCmdType()) {
-    case PutSmallFile:
-      return request.toBuilder()
-          .setPutSmallFile(request.getPutSmallFile().toBuilder()
-              .clearData()
-          )
-          .build();
-    case WriteChunk:
-      return request.toBuilder()
-          .setWriteChunk(request.getWriteChunk().toBuilder()
-              .clearData()
-          )
-          .build();
-    default:
-      return request;

MOV26 UPD40 INS25 INS83 UPD43 INS32 INS8 INS8 UPD42 UPD42 INS32 MOV42 MOV42 UPD42 MOV42 INS21 INS41 MOV21 MOV41 UPD42 MOV42 UPD42 MOV42 MOV42 MOV32 INS32 INS32 INS32 INS42 INS42 INS45 UPD42 MOV42 MOV32 UPD42 MOV42 UPD42 MOV42 UPD45 UPD42 MOV32 MOV42 INS42 DEL32 DEL42 DEL32 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL86 DEL32 DEL42 DEL86 DEL32 DEL16 DEL39 DEL42 DEL32 DEL59 DEL60 DEL42 DEL43 DEL42 DEL42 DEL32 DEL59 DEL60 DEL32 DEL8 DEL25 DEL83 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL44 DEL42 DEL42 DEL32 DEL42 DEL49 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL42 DEL32 DEL32 DEL42 DEL32 DEL41 DEL42 DEL49 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL42 DEL32 DEL32 DEL42 DEL32 DEL41 DEL49 DEL42 DEL41 DEL50 DEL8 DEL31