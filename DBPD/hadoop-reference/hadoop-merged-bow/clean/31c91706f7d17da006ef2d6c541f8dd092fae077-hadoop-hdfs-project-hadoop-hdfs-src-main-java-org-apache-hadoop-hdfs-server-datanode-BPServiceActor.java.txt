HDFS-1972. Fencing mechanism for block invalidations and replications. Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1221608 13f79535-47bb-0310-9956-ffa450edef68

+    synchronized (receivedAndDeletedBlockList) {
-      blockReport();
+      lastHeartbeat = 0;
+      receivedAndDeletedBlockList.notifyAll();
+      while (lastBlockReport == 0) {
+        try {
+          receivedAndDeletedBlockList.wait(100);
+        } catch (InterruptedException e) {
+          return;
+        }
+      }
+    }
+      while (lastHeartbeat == 0) {
+        try {
+          receivedAndDeletedBlockList.wait(100);
+        } catch (InterruptedException e) {
+          return;
+        }
+      }
+    }
+  }
+
+  @VisibleForTesting
+  void triggerDeletionReportForTests() throws IOException {
+    synchronized (receivedAndDeletedBlockList) {
+      lastDeletedReport = 0;
+      receivedAndDeletedBlockList.notifyAll();
+
+      while (lastDeletedReport == 0) {
+        try {
+          receivedAndDeletedBlockList.wait(100);
+        } catch (InterruptedException e) {
+          return;
+        }
+      }

INS31 INS8 INS78 INS39 INS42 INS43 INS8 INS51 INS42 INS42 INS51 INS42 INS8 INS8 INS42 INS8 MOV21 INS21 INS21 INS61 MOV21 MOV21 INS61 INS21 INS21 INS61 INS7 INS32 INS27 INS8 INS27 INS8 INS7 INS32 INS27 INS8 INS42 INS34 INS42 INS42 INS42 INS34 INS54 INS42 INS34 INS54 INS42 INS34 INS42 INS42 INS42 INS34 INS54 INS8 INS12 INS8 INS12 INS8 INS12 MOV21 INS44 INS8 INS21 INS44 INS8 INS21 INS44 INS8 INS43 INS42 INS41 INS32 INS43 INS42 INS41 INS32 INS43 INS42 INS41 UPD42 INS42 INS34 INS42 INS42 INS42 INS34 INS42 INS42 INS42 INS34 INS42 DEL8 DEL8