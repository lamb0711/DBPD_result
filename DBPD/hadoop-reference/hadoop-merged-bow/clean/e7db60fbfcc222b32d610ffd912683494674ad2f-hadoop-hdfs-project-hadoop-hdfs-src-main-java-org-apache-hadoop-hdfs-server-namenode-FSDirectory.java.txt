HDFS-4464. Combine collectSubtreeBlocksAndClear with deleteDiffsForSnapshot and rename it to destroySubtreeAndCollectBlocks.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1441680 13f79535-47bb-0310-9956-ffa450edef68

-          filesDeleted = rmdst.collectSubtreeBlocksAndClear(collectedBlocks);
+          filesDeleted = rmdst.destroySubtreeAndCollectBlocks(null, collectedBlocks);
-    int filesRemoved;
+    final int filesRemoved;
-      final INode[] inodes = inodesInPath.getINodes();
-      if (checkPathINodes(inodes, src) == 0) {
+      if (!deleteAllowed(inodesInPath, src) ) {
-        INode targetNode = inodes[inodes.length-1];
+        final INode targetNode = inodesInPath.getLastINode();
-  private int checkPathINodes(INode[] inodes, String src) {
+  private static boolean deleteAllowed(final INodesInPath iip,
+      final String src) {
+    final INode[] inodes = iip.getINodes(); 
-      return 0;
+      return false;
-      return 0;
+      return false;
-    return inodes.length;
+    return true;
-    int filesRemoved = 0;
-    final INode[] inodes = inodesInPath.getINodes();
-    if (checkPathINodes(inodes, src) == 0) {
-      filesRemoved = 0;
-    } else {
-      filesRemoved = unprotectedDelete(inodesInPath, collectedBlocks, mtime);
-    }
+    final int filesRemoved = deleteAllowed(inodesInPath, src)?
+        unprotectedDelete(inodesInPath, collectedBlocks, mtime): 0;
-        : targetNode.collectSubtreeBlocksAndClear(collectedBlocks);
+        : targetNode.destroySubtreeAndCollectBlocks(null, collectedBlocks);

INS83 UPD39 UPD42 INS83 INS43 INS42 INS83 INS60 INS60 INS83 INS42 INS83 MOV5 INS59 INS9 INS83 MOV39 INS59 INS42 INS32 MOV42 INS16 INS38 INS42 INS42 INS9 INS32 MOV32 INS34 INS32 INS9 UPD42 MOV42 UPD42 MOV42 MOV42 UPD42 INS33 UPD42 MOV42 UPD42 MOV42 MOV42 INS83 INS32 INS42 INS42 UPD42 INS33 DEL83 DEL42 DEL43 DEL85 DEL5 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL32 DEL34 DEL27 DEL42 DEL40 DEL34 DEL27 DEL2 DEL42 DEL34 DEL34 DEL40 DEL34 DEL59 DEL60 DEL83 DEL42 DEL43 DEL85 DEL5 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL32 DEL34 DEL27 DEL42 DEL34 DEL7 DEL21 DEL8 DEL42 DEL7 DEL21 DEL8 DEL25