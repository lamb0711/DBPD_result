MAPREDUCE-2966. Added ShutDown hooks for MRV2 processes so that they can gracefully exit. Contributed by Abhijit Suresh Shingate.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1170746 13f79535-47bb-0310-9956-ffa450edef68

-    } catch(Throwable e) {
+      super.start();
+    } catch (Throwable e) {
-      for (int j = i-1; j >= 0; j--) {
-        Service service = serviceList.get(j);
-        try {
-          service.stop();
-        } catch(Throwable t) {
-          LOG.info("Error stopping " + service.getName(), t);
-        }
-      }
+      // Note that the state of the failed service is still INITED and not
+      // STARTED. Even though the last service is not started completely, still
+      // call stop() on all services including failed service to make sure cleanup
+      // happens.
+      stop(i);
-    super.start();
+
-    //stop in reserve order of start
-    for (int i = serviceList.size() - 1; i >= 0; i--) {
-      Service service = serviceList.get(i);
-      service.stop();
+    if (serviceList.size() > 0) {
+      stop(serviceList.size() - 1);
+  private synchronized void stop(int numOfServicesStarted) {
+    // stop in reserve order of start
+    for (int i = numOfServicesStarted; i >= 0; i--) {
+      Service service = serviceList.get(i);
+      try {
+        service.stop();
+      } catch (Throwable t) {
+        LOG.info("Error stopping " + service.getName(), t);
+      }
+    }
+  }
+
+  /**
+   * JVM Shutdown hook for CompositeService which will stop the give
+   * CompositeService gracefully in case of JVM shutdown.
+   */
+  public static class CompositeServiceShutdownHook extends Thread {
+
+    private CompositeService compositeService;
+
+    public CompositeServiceShutdownHook(CompositeService compositeService) {
+      this.compositeService = compositeService;
+    }
+
+    @Override
+    public void run() {
+      try {
+        // Stop the Composite Service
+        compositeService.stop();
+      } catch (Throwable t) {
+        LOG.info("Error stopping " + compositeService.getName(), t);
+      }
+    }
+  }
+  

INS31 INS31 INS55 MOV83 MOV83 MOV39 MOV42 INS8 INS83 INS83 INS39 INS42 INS44 MOV8 INS29 INS83 INS83 INS42 INS43 INS23 INS31 INS31 INS25 MOV21 INS39 INS42 INS65 INS42 INS83 INS43 INS59 INS83 INS42 INS44 INS8 INS78 INS83 INS39 INS42 INS8 INS27 INS8 MOV27 MOV37 INS66 INS66 UPD42 MOV42 UPD42 MOV42 INS43 INS42 INS21 INS42 INS54 MOV21 INS8 INS32 MOV34 INS21 MOV34 UPD42 MOV42 MOV60 INS42 INS7 INS8 INS12 MOV21 INS21 MOV53 INS42 INS42 INS32 INS42 INS42 INS22 INS42 MOV21 INS44 INS8 INS32 INS42 MOV27 MOV42 MOV42 MOV32 INS52 INS42 INS43 INS42 INS21 INS42 INS42 UPD42 UPD42 INS42 INS32 INS42 INS42 INS27 INS42 INS45 INS32 INS42 INS42 DEL42 DEL42 DEL34 DEL27 DEL39 DEL42 DEL59 DEL58 DEL8 DEL24 DEL8 DEL31