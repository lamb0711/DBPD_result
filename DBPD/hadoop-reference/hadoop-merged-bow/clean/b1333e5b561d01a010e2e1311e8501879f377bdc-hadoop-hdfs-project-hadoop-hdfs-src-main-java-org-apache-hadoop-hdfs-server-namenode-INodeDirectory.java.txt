HDFS-4545. With snapshots, FSDirectory.unprotectedSetReplication(..) always changes file replication but it may or may not changes block replication.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1452636 13f79535-47bb-0310-9956-ffa450edef68

-    return (INodeDirectory)inode; 
+    return inode.asDirectory(); 
+  /** @return this object. */
+  @Override
+  public final INodeDirectory asDirectory() {
+    return this;
+  }
+
-      if (curNode instanceof INodeDirectoryWithSnapshot) {
+      final boolean isDir = curNode.isDirectory();
+      final INodeDirectory dir = isDir? curNode.asDirectory(): null;  
+      if (isDir && dir instanceof INodeDirectoryWithSnapshot) {
-              ((INodeDirectoryWithSnapshot)curNode).getLastSnapshot());
+              ((INodeDirectoryWithSnapshot)dir).getLastSnapshot());
-        final String target = ((INodeSymlink)curNode).getSymlinkString();
+        final String target = curNode.asSymlink().getSymlinkString();
-      if (lastComp || !curNode.isDirectory()) {
+      if (lastComp || !isDir) {
-      final INodeDirectory parentDir = (INodeDirectory)curNode;
-          && (curNode instanceof INodeDirectorySnapshottable)) {
+          && isDir && dir instanceof INodeDirectoryWithSnapshot) {
-        final Snapshot s = ((INodeDirectorySnapshottable)parentDir).getSnapshot(
+        final Snapshot s = ((INodeDirectorySnapshottable)dir).getSnapshot(
-        curNode = parentDir.getChild(childName, existing.getPathSnapshot());
+        curNode = dir.getChild(childName, existing.getPathSnapshot());
-        for (int i = 0; i < capacity; i++) {
-          newNodes[i] = inodes[i];
-        }
+        System.arraycopy(inodes, 0, newNodes, 0, capacity);

INS31 INS29 INS78 INS83 INS83 MOV43 INS42 INS8 INS65 INS42 INS41 INS32 INS66 INS52 MOV60 INS42 INS42 INS60 INS25 INS83 INS39 INS59 INS27 INS27 MOV8 INS21 INS42 MOV32 UPD42 INS16 INS42 MOV62 INS42 INS38 INS42 INS62 INS32 INS42 INS32 INS33 UPD42 INS42 UPD42 MOV42 UPD43 MOV43 INS42 INS42 INS42 INS34 INS42 INS34 INS42 INS42 INS42 UPD42 INS32 UPD42 INS42 INS42 UPD42 UPD42 DEL42 DEL11 DEL42 DEL43 DEL42 DEL11 DEL42 DEL43 DEL42 DEL11 DEL36 DEL42 DEL38 DEL27 DEL25 DEL62 DEL36 DEL39 DEL42 DEL34 DEL59 DEL58 DEL42 DEL42 DEL27 DEL42 DEL37 DEL42 DEL42 DEL2 DEL42 DEL42 DEL2 DEL7 DEL21 DEL8 DEL24