HDFS-4760. Update inodeMap after node replacement.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1477827 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.server.namenode.INodeMap;
-  public INodeDirectoryWithSnapshot recordModification(final Snapshot latest)
-      throws QuotaExceededException {
+  public INodeDirectoryWithSnapshot recordModification(final Snapshot latest,
+      final INodeMap inodeMap) throws QuotaExceededException {
-      final INode snapshotCopy) throws QuotaExceededException {
+      final INode snapshotCopy, final INodeMap inodeMap)
+      throws QuotaExceededException {
-  public boolean addChild(INode inode, boolean setModTime, Snapshot latest)
-      throws QuotaExceededException {
+  public boolean addChild(INode inode, boolean setModTime, Snapshot latest,
+      final INodeMap inodeMap) throws QuotaExceededException {
-    final boolean added = super.addChild(inode, setModTime, null);
+    final boolean added = super.addChild(inode, setModTime, null, inodeMap);
-  public boolean removeChild(INode child, Snapshot latest)
-      throws QuotaExceededException {
+  public boolean removeChild(INode child, Snapshot latest,
+      final INodeMap inodeMap) throws QuotaExceededException {
-  public void replaceChild(final INode oldChild, final INode newChild) {
-    super.replaceChild(oldChild, newChild);
+  public void replaceChild(final INode oldChild, final INode newChild,
+      final INodeMap inodeMap) {
+    super.replaceChild(oldChild, newChild, inodeMap);
-    addChild(newChild, true, null);
+    // pass null for inodeMap since the parent node will not get replaced when
+    // undoing rename
+    addChild(newChild, true, null, null);
+    // pass null for inodeMap since the parent node will not get replaced when
+    // undoing rename
-        : latestSnapshot);
+        : latestSnapshot, null);
-      recordModification(prior);
+      recordModification(prior, null);

INS26 INS40 INS44 INS44 INS44 INS44 INS44 INS83 INS43 INS42 INS83 INS43 INS42 INS83 INS43 INS42 INS83 INS43 INS42 INS83 INS43 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS33 INS42 INS33 INS33