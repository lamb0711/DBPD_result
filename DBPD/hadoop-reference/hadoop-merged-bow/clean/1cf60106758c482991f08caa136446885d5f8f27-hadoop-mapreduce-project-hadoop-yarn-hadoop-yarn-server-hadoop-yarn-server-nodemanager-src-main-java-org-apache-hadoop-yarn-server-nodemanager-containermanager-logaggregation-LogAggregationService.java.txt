MAPREDUCE-4302. NM goes down if error encountered during log aggregation (Daryn Sharp via bobby)


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1345362 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.yarn.server.nodemanager.containermanager.application.ApplicationEvent;
+import org.apache.hadoop.yarn.server.nodemanager.containermanager.application.ApplicationEventType;
+import org.apache.hadoop.yarn.server.nodemanager.containermanager.application.ApplicationFinishEvent;
+import com.google.common.annotations.VisibleForTesting;
-      throw new YarnException("Unable to get Remote FileSystem isntance", e);
+      throw new YarnException("Unable to get Remote FileSystem instance", e);
-      throw new YarnException("Failed to check for existance of remoteLogDir ["
+      throw new YarnException("Failed to check for existence of remoteLogDir ["
+  @SuppressWarnings("unchecked")
+    ApplicationEvent eventResponse;
+    try {
+      initAppAggregator(appId, user, credentials, logRetentionPolicy, appAcls);
+      eventResponse = new ApplicationEvent(appId,
+          ApplicationEventType.APPLICATION_LOG_HANDLING_INITED);
+    } catch (YarnException e) {
+      eventResponse = new ApplicationFinishEvent(appId,
+          "Application failed to init aggregation: " + e.getMessage());
+    }
+    this.dispatcher.getEventHandler().handle(eventResponse);
+  }
+
+  @VisibleForTesting
+  public void initAppAggregator(final ApplicationId appId, String user,
+      Credentials credentials, ContainerLogsRetentionPolicy logRetentionPolicy,
+      Map<ApplicationAccessType, String> appAcls) {

INS26 INS26 INS26 INS26 INS40 INS40 INS40 INS40 INS31 INS79 INS83 INS39 INS42 INS44 INS44 INS44 INS44 INS44 INS8 INS78 UPD83 UPD42 INS42 INS45 INS83 INS43 INS42 INS43 INS42 INS43 INS42 INS43 INS42 INS74 INS42 INS60 INS54 INS21 INS42 INS42 INS42 INS42 INS42 INS43 INS43 INS43 INS43 INS59 INS8 INS12 INS32 INS42 INS42 INS42 INS42 INS42 INS21 INS21 INS44 INS8 INS32 INS42 INS42 INS32 INS7 INS43 INS42 INS21 INS22 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS14 INS42 INS7 INS52 INS42 UPD45 INS43 INS42 INS40 INS42 INS14 UPD45 INS42 INS43 INS42 INS27 INS42 INS45 INS32 INS42 INS42