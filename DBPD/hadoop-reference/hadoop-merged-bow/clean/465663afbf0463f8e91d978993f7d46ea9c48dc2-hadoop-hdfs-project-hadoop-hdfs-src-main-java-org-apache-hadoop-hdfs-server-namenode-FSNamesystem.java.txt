HDFS-2804. Should not mark blocks under-replicated when exiting safemode. Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1235033 13f79535-47bb-0310-9956-ffa450edef68

+  private boolean isInStandbyState() {
+    if (haContext == null || haContext.getState() == null) {
+      // We're still starting up. In this case, if HA is
+      // on for the cluster, we always start in standby. Otherwise
+      // start in active.
+      return haEnabled;
+    }
+  
+    return haContext.getState() instanceof StandbyState;
+  }
+
-      // if not done yet, initialize replication queues
-      if (!isPopulatingReplQueues()) {
+      // if not done yet, initialize replication queues.
+      // In the standby, do not populate repl queues
+      if (!isPopulatingReplQueues() && !isInStandbyState()) {
-      return blockSafe >= blockReplQueueThreshold;
+      return !isInStandbyState() && blockSafe >= blockReplQueueThreshold;
-    if (haContext != null && // null during startup!
-        !haContext.getState().shouldPopulateReplQueues()) {
+    if (isInStandbyState()) {

INS31 INS83 INS39 INS42 INS8 INS25 INS41 INS27 INS8 INS62 INS32 INS27 INS27 INS41 MOV32 INS43 INS27 INS27 UPD42 MOV42 INS42 INS33 INS32 INS33 INS42 INS42 MOV38 INS38 INS38 MOV27 INS42 INS42 INS32 INS32 INS42 INS42 DEL42 DEL33 DEL27 DEL32 DEL38 DEL27