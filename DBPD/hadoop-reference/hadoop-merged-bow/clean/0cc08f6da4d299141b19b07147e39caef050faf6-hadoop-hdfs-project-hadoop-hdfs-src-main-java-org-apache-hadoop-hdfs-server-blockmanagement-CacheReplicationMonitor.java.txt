Merge from trunk to branch.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/fs-encryption@1618700 13f79535-47bb-0310-9956-ffa450edef68

-   * Whether there are pending CacheManager operations that necessitate a
-   * CacheReplicationMonitor rescan. Protected by the CRM lock.
-   */
-  private boolean needsRescan = true;
-
-  /**
-   * Whether we are currently doing a rescan. Protected by the CRM lock.
-   */
-  private boolean isScanning = false;
-
-  /**
-  private long scanCount = 0;
+  private long completedScanCount = 0;
+
+  /**
+   * The scan we're currently performing, or -1 if no scan is in progress.
+   * Protected by the CacheReplicationMonitor lock.
+   */
+  private long curScanCount = -1;
+
+  /**
+   * The number of rescans we need to complete.  Protected by the CRM lock.
+   */
+  private long neededScanCount = 0;
-            if (needsRescan) {
+            if (completedScanCount < neededScanCount) {
-          isScanning = true;
-          needsRescan = false;
-          isScanning = false;
-          scanCount++;
+          completedScanCount = curScanCount;
+          curScanCount = -1;
-    if (!needsRescan) {
+    if (neededScanCount <= completedScanCount) {
-    if (!isScanning) {
+    if (curScanCount < 0) {
-    final long startCount = scanCount;
-    while ((!shutdown) && (startCount >= scanCount)) {
+    while ((!shutdown) && (completedScanCount < neededScanCount)) {
-    this.needsRescan = true;
+    if (curScanCount >= 0) {
+      // If there is a scan in progress, we need to wait for the scan after
+      // that.
+      neededScanCount = curScanCount + 1;
+    } else {
+      // If there is no scan in progress, we need to wait for the next scan.
+      neededScanCount = completedScanCount + 1;
+    }
-    namesystem.writeLock();
-      if (shutdown) {
-        throw new InterruptedException("CacheReplicationMonitor was " +
-            "shut down.");
+      namesystem.writeLock();
+      try {
+        lock.lock();
+        if (shutdown) {
+          throw new InterruptedException("CacheReplicationMonitor was " +
+              "shut down.");
+        }
+        curScanCount = completedScanCount + 1;
+      } finally {
+        lock.unlock();
+

MOV29 UPD39 UPD39 INS29 INS8 UPD42 INS34 UPD42 INS38 INS65 UPD42 INS25 MOV21 INS25 INS66 UPD66 INS34 INS66 INS27 MOV8 INS27 INS27 INS8 INS8 INS42 INS42 INS42 INS34 INS42 INS34 MOV21 INS21 MOV21 INS54 UPD27 INS7 INS8 INS8 UPD42 UPD42 INS42 INS27 INS42 INS27 INS21 MOV25 INS21 INS21 INS42 INS34 INS42 INS34 INS32 INS7 INS32 INS42 INS42 INS42 INS27 INS42 INS42 INS7 INS42 INS34 INS42 UPD42 INS42 INS38 INS27 INS34 INS42 INS42 DEL66 DEL66 DEL65 DEL29 DEL9 DEL9 DEL42 DEL42 DEL9 DEL7 DEL21 DEL42 DEL9 DEL7 DEL21 DEL9 DEL42 DEL37 DEL42 DEL38 DEL25 DEL42 DEL38 DEL83 DEL39 DEL42 DEL42 DEL59 DEL60 DEL52 DEL42 DEL22 DEL9 DEL8