HDFS-8946. Improve choosing datanode storage for block placement. (yliu)

-
+
+import org.apache.hadoop.hdfs.server.common.HdfsServerConstants;
-   * Return the sum of remaining spaces of the specified type. If the remaining
-   * space of a storage is less than minSize, it won't be counted toward the
-   * sum.
+   * Find whether the datanode contains good storage of given type to
+   * place block of size <code>blockSize</code>.
-   * @param t The storage type. If null, the type is ignored.
-   * @param minSize The minimum free space required.
-   * @return the sum of remaining spaces that are bigger than minSize.
+   * <p>Currently datanode only cares about the storage type, in this
+   * method, the first storage of given type we see is returned.
+   *
+   * @param t requested storage type
+   * @param blockSize requested block size
+   * @return
-  public long getRemaining(StorageType t, long minSize) {
+  public DatanodeStorageInfo chooseStorage4Block(StorageType t,
+      long blockSize) {
+    final long requiredSize =
+        blockSize * HdfsServerConstants.MIN_BLOCKS_FOR_WRITE;
+    final long scheduledSize = blockSize * getBlocksScheduled(t);
+    DatanodeStorageInfo storage = null;
-          (t == null || s.getStorageType() == t)) {
+          s.getStorageType() == t) {
+        if (storage == null) {
+          storage = s;
+        }
-        if (r >= minSize) {
+        if (r >= requiredSize) {
-    return remaining;
+    if (requiredSize > remaining - scheduledSize) {
+      return null;
+    }
+    return storage;

INS26 INS40 INS43 INS42 INS42 UPD42 INS60 INS60 INS60 INS25 INS41 UPD66 INS66 UPD66 UPD66 UPD66 UPD42 UPD66 INS83 INS39 INS59 INS83 INS39 INS59 INS43 INS59 INS27 INS8 INS42 INS42 INS27 INS42 INS27 INS42 INS42 INS33 INS42 INS27 INS41 INS42 INS40 INS42 INS32 UPD27 MOV27 INS42 INS42 INS33 INS42 INS42 MOV27 INS25 INS27 INS8 INS42 INS33 INS21 UPD42 INS7 INS42 INS42 DEL66 DEL39 DEL42 DEL42 DEL33 DEL27 DEL36 DEL27 DEL42 DEL41