YARN-6669.  Implemented Kerberos security for YARN service framework.  (Contributed by Jian He)

+import org.apache.hadoop.classification.InterfaceAudience;
+import org.apache.zookeeper.client.ZooKeeperSaslClient;
+import java.util.HashMap;
+import java.util.Map;
-  private String jaasClientContext;
+  private String jaasClientEntry;
+  private String principal;
+
+  private String keytab;
+
+      LOG.info("Registry default system acls: " + System.lineSeparator() +
+          systemACLs);
+      LOG.info("Registry User ACLs " + System.lineSeparator()+ userACLs);
-          jaasClientContext = getOrFail(KEY_REGISTRY_CLIENT_JAAS_CONTEXT,
+          jaasClientEntry = getOrFail(KEY_REGISTRY_CLIENT_JAAS_CONTEXT,
-                jaasClientIdentity,
-                jaasClientContext);
+                jaasClientIdentity, jaasClientEntry);
-          // bind to the current identity and context within the JAAS file
-          setZKSaslClientProperties(jaasClientIdentity, jaasClientContext);
+          JaasConfiguration jconf =
+              new JaasConfiguration(jaasClientEntry, principal, keytab);
+          javax.security.auth.login.Configuration.setConfiguration(jconf);
+          setSystemPropertyIfUnset(ZooKeeperSaslClient.ENABLE_CLIENT_SASL_KEY,
+              "true");
+          setSystemPropertyIfUnset(ZooKeeperSaslClient.LOGIN_CONTEXT_NAME_KEY,
+              jaasClientEntry);
+          LOG.info(
+              "Enabling ZK sasl client: jaasClientEntry = " + jaasClientEntry
+                  + ", principal = " + principal + ", keytab = " + keytab);
+  public void setKerberosPrincipalAndKeytab(String principal, String keytab) {
+    this.principal = principal;
+    this.keytab = keytab;
+  }
+
+  /**
+   * Creates a programmatic version of a jaas.conf file. This can be used
+   * instead of writing a jaas.conf file and setting the system property,
+   * "java.security.auth.login.config", to point to that file. It is meant to be
+   * used for connecting to ZooKeeper.
+   */
+  @InterfaceAudience.Private
+  public static class JaasConfiguration extends
+      javax.security.auth.login.Configuration {
+
+    private final javax.security.auth.login.Configuration baseConfig =
+        javax.security.auth.login.Configuration.getConfiguration();
+    private static AppConfigurationEntry[] entry;
+    private String entryName;
+
+    /**
+     * Add an entry to the jaas configuration with the passed in name,
+     * principal, and keytab. The other necessary options will be set for you.
+     *
+     * @param entryName The name of the entry (e.g. "Client")
+     * @param principal The principal of the user
+     * @param keytab The location of the keytab
+     */
+    public JaasConfiguration(String entryName, String principal, String keytab) {
+      this.entryName = entryName;
+      Map<String, String> options = new HashMap<String, String>();
+      options.put("keyTab", keytab);
+      options.put("principal", principal);
+      options.put("useKeyTab", "true");
+      options.put("storeKey", "true");
+      options.put("useTicketCache", "false");
+      options.put("refreshKrb5Config", "true");
+      String jaasEnvVar = System.getenv("HADOOP_JAAS_DEBUG");
+      if (jaasEnvVar != null && "true".equalsIgnoreCase(jaasEnvVar)) {
+        options.put("debug", "true");
+      }
+      entry = new AppConfigurationEntry[]{
+          new AppConfigurationEntry(getKrb5LoginModuleName(),
+              AppConfigurationEntry.LoginModuleControlFlag.REQUIRED,
+              options)};
+    }
+
+    @Override
+    public AppConfigurationEntry[] getAppConfigurationEntry(String name) {
+      return (entryName.equals(name)) ? entry : ((baseConfig != null)
+          ? baseConfig.getAppConfigurationEntry(name) : null);
+    }
+
+    private String getKrb5LoginModuleName() {
+      String krb5LoginModuleName;
+      if (System.getProperty("java.vendor").contains("IBM")) {
+        krb5LoginModuleName = "com.ibm.security.auth.module.Krb5LoginModule";
+      } else {
+        krb5LoginModuleName = "com.sun.security.auth.module.Krb5LoginModule";
+      }
+      return krb5LoginModuleName;
+    }
+  }
+
-             .append(jaasClientContext)
+             .append(jaasClientEntry)

INS26 INS26 INS26 INS26 INS40 INS40 INS40 INS40 INS23 INS23 INS31 INS55 INS83 INS43 INS59 INS83 INS43 INS59 INS83 INS39 INS42 INS44 INS44 INS8 INS29 INS78 INS83 INS83 INS42 INS43 INS23 INS23 INS23 INS31 INS31 INS31 UPD42 INS42 INS42 INS42 INS42 INS43 INS42 INS43 INS42 INS21 INS21 INS65 INS40 INS40 INS83 INS83 INS43 INS59 INS83 INS83 INS5 INS59 INS83 INS43 INS59 INS29 INS83 INS42 INS44 INS44 INS44 INS8 INS78 INS83 INS5 INS42 INS44 INS8 INS83 INS43 INS42 INS8 INS42 INS42 INS7 INS7 INS66 INS66 INS66 INS66 INS40 INS42 INS32 INS43 INS85 INS42 INS42 INS42 INS65 INS65 INS65 INS65 INS43 INS42 INS43 INS42 INS43 INS42 INS21 INS60 INS21 INS21 INS21 INS21 INS21 INS21 INS60 INS25 INS21 INS42 INS43 INS85 INS43 INS42 INS41 INS42 INS60 INS25 INS41 INS21 INS21 INS22 INS42 INS22 INS42 INS40 INS42 INS42 INS66 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS42 INS42 INS42 INS7 INS74 INS59 INS32 INS32 INS32 INS32 INS32 INS32 INS43 INS59 INS27 INS8 INS7 INS42 INS42 INS16 INS43 INS59 INS32 INS8 INS8 INS42 INS32 INS32 INS60 INS21 INS21 INS21 INS52 INS42 INS52 INS42 INS22 INS42 INS43 INS43 INS43 INS42 INS14 INS42 INS42 INS45 INS42 INS42 INS42 INS45 INS42 INS42 INS42 INS45 INS45 INS42 INS42 INS45 INS45 INS42 INS42 INS45 INS45 INS42 INS42 INS45 INS45 INS42 INS42 INS32 INS27 INS32 INS21 INS42 INS3 INS36 INS42 INS36 INS42 INS42 INS32 INS42 INS45 INS21 INS21 INS42 INS42 INS27 INS42 INS42 INS27 INS43 INS59 INS32 INS32 INS32 INS52 INS42 INS42 INS42 INS42 INS74 INS42 INS42 INS45 INS42 INS33 INS45 INS42 INS42 INS32 INS5 INS4 INS32 INS16 INS42 INS42 INS45 INS7 INS7 INS45 INS32 INS42 INS45 INS32 INS42 UPD42 INS42 INS42 INS14 INS40 INS42 INS42 INS42 INS40 INS45 INS42 INS40 INS42 UPD42 INS42 INS27 INS43 INS43 INS43 INS42 INS42 INS45 INS45 INS43 INS85 INS14 INS42 INS42 INS42 INS36 INS32 INS33 INS42 INS45 INS42 INS45 UPD42 INS42 INS42 INS42 INS42 INS43 INS42 INS42 INS42 INS45 INS42 INS45 INS42 INS45 INS42 INS42 INS42 INS42 INS42 INS43 INS32 INS40 INS42 INS27 INS42 INS42 INS42 UPD42 INS42 INS42 INS42 INS42 INS33 DEL42 DEL42