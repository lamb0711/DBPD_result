HDDS-1827. Load Snapshot info when OM Ratis server starts. (#1130)



-import org.apache.hadoop.ozone.container.common.transport.server.ratis
-    .ContainerStateMachine;
+import org.apache.ratis.statemachine.SnapshotInfo;
-      LoggerFactory.getLogger(ContainerStateMachine.class);
+      LoggerFactory.getLogger(OzoneManagerStateMachine.class);
-  private long lastAppliedIndex = 0;
+  private long lastAppliedIndex;
+  private final OMRatisSnapshotInfo snapshotInfo;
+
+    this.snapshotInfo = ozoneManager.getSnapshotInfo();
+    updateLastAppliedIndexWithSnaphsotIndex();
+
+
+
+  @Override
+  public SnapshotInfo getLatestSnapshot() {
+    return snapshotInfo;
+  }
+
+  /**
+   * Called to notify state machine about indexes which are processed
+   * internally by Raft Server, this currently happens when conf entries are
+   * processed in raft Server. This keep state machine to keep a track of index
+   * updates.
+   * @param term term of the current log entry
+   * @param index index which is being updated
+   */
+  @Override
+  public void notifyIndexUpdate(long term, long index) {
+    // SnapshotInfo should be updated when the term changes.
+    // The index here refers to the log entry index and the index in
+    // SnapshotInfo represents the snapshotIndex i.e. the index of the last
+    // transaction included in the snapshot. Hence, snaphsotInfo#index is not
+    // updated here.
+    snapshotInfo.updateTerm(term);
+  }
+
-      return ozoneManager.saveRatisSnapshot(true);
+      return ozoneManager.saveRatisSnapshot();
+  public void updateLastAppliedIndexWithSnaphsotIndex() {
+    this.lastAppliedIndex = snapshotInfo.getIndex();
+  }
+

MOV26 UPD40 INS23 INS31 INS31 INS31 INS83 INS83 INS43 INS59 INS78 INS83 INS43 INS42 INS8 INS29 INS78 INS83 INS39 INS42 INS44 INS44 INS8 INS83 INS39 INS42 INS8 INS42 INS42 INS21 INS21 INS42 INS42 INS41 INS65 INS65 INS65 INS42 INS39 INS42 INS39 INS42 INS21 INS21 INS7 INS32 INS42 INS66 INS66 INS66 INS66 INS42 INS66 INS42 INS66 INS32 INS7 UPD43 INS22 INS32 INS42 INS42 INS42 INS42 INS22 INS32 UPD42 INS52 INS42 INS42 INS42 INS52 INS42 INS42 INS42 DEL34 DEL9