HADOOP-15141 Support IAM Assumed roles in S3A. Contributed by Steve Loughran.

+import java.lang.reflect.InvocationTargetException;
-   * Create the AWS credentials from the providers and the URI.
+   * Create the AWS credentials from the providers, the URI and
+   * the key {@link Constants#AWS_CREDENTIALS_PROVIDER} in the configuration.
-    Class<?>[] awsClasses;
-    try {
-      awsClasses = conf.getClasses(AWS_CREDENTIALS_PROVIDER);
-    } catch (RuntimeException e) {
-      Throwable c = e.getCause() != null ? e.getCause() : e;
-      throw new IOException("From option " + AWS_CREDENTIALS_PROVIDER +
-          ' ' + c, c);
-    }
+    Class<?>[] awsClasses = loadAWSProviderClasses(conf,
+        AWS_CREDENTIALS_PROVIDER);
+   * Load list of AWS credential provider/credential provider factory classes.
+   * @param conf configuration
+   * @param key key
+   * @param defaultValue list of default values
+   * @return the list of classes, possibly empty
+   * @throws IOException on a failure to load the list.
+   */
+  static Class<?>[] loadAWSProviderClasses(Configuration conf,
+      String key,
+      Class<?>... defaultValue) throws IOException {
+    try {
+      return conf.getClasses(key, defaultValue);
+    } catch (RuntimeException e) {
+      Throwable c = e.getCause() != null ? e.getCause() : e;
+      throw new IOException("From option " + key + ' ' + c, c);
+    }
+  }
+
+  /**
-    AWSCredentialsProvider credentials = null;
+    AWSCredentialsProvider credentials;
+    } catch (InvocationTargetException e) {
+      Throwable targetException = e.getTargetException();
+      if (targetException == null) {
+        targetException =  e;
+      }
+      if (targetException instanceof IOException) {
+        throw (IOException) targetException;
+      } else if (targetException instanceof SdkBaseException) {
+        throw translateException("Instantiate " + className, "",
+            (SdkBaseException) targetException);
+      } else {
+        // supported constructor or factory method found, but the call failed
+        throw new IOException(className + " " + INSTANTIATION_EXCEPTION
+            + ": " + targetException,
+            targetException);
+      }
-      throw new IOException(className + " " + INSTANTIATION_EXCEPTION +".", e);
+      throw new IOException(className + " " + INSTANTIATION_EXCEPTION
+          + ": " + e,
+          e);

INS26 INS40 INS31 INS29 INS83 INS5 INS42 INS44 INS44 INS44 INS43 INS8 INS65 INS65 INS65 INS65 INS65 INS65 INS74 INS85 INS43 INS42 INS43 INS42 INS74 INS42 INS42 MOV54 UPD66 INS66 INS65 INS66 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS66 INS42 INS66 INS43 INS76 INS42 INS42 INS43 INS76 INS12 INS67 INS32 INS42 INS42 INS41 INS44 INS8 INS42 INS42 INS42 INS42 INS42 INS32 INS43 INS42 INS60 INS25 INS25 MOV42 MOV42 UPD42 MOV42 INS42 INS42 INS43 INS59 INS27 INS8 INS62 INS8 INS25 INS42 INS42 INS32 INS42 INS33 INS21 INS42 INS43 INS53 INS62 INS8 INS8 INS43 UPD42 INS42 INS42 INS7 INS42 INS11 INS42 INS43 INS53 INS53 INS42 UPD45 INS42 INS42 INS42 MOV43 INS42 INS42 INS32 INS14 INS42 INS27 INS45 INS11 INS43 INS27 INS42 INS45 INS42 INS43 INS42 INS42 INS42 INS45 INS42 INS45 INS42 INS42 DEL42 DEL32 DEL7 DEL21 DEL33