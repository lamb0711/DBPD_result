Merge commit '456e901a4c5c639267ee87b8e5f1319f256d20c2' (HDFS-6407. Add sorting and pagination in the datanode tab of the NN Web UI. Contributed by Haohui Mai.) into HDFS-7285-merge

-import static org.apache.hadoop.hdfs.DFSConfigKeys.DFS_ADMIN;
+
-import org.apache.hadoop.hdfs.server.common.JspHelper;
-import org.apache.hadoop.http.HttpServer2;
-import org.apache.hadoop.security.authorize.AccessControlList;
-      "Usage: java DataNode [-regular | -rollback]\n" +
+      "Usage: hdfs datanode [-regular | -rollback | -rollingupgrade rollback" +
+      " ]\n" +
+      "    -rollingupgrade rollback : Rollback a rolling upgrade operation.\n" +
+  /** A list of property that are reconfigurable at runtime. */
+  private static final List<String> RECONFIGURABLE_PROPERTIES =
+      Collections.unmodifiableList(
+          Arrays.asList(DFS_DATANODE_DATA_DIR_KEY));
+
+  private volatile boolean cacheReportsDisabledForTests = false;
-  private HttpServer2 infoServer = null;
+  @Override  // ReconfigurableBase
+  protected Configuration getNewConf() {
+    return new HdfsConfiguration();
+  }
+
-  @Override
+  @Override // Reconfigurable
-    List<String> reconfigurable =
-        Collections.unmodifiableList(Arrays.asList(DFS_DATANODE_DATA_DIR_KEY));
-    return reconfigurable;
+    return RECONFIGURABLE_PROPERTIES;
-    Configuration confForInfoServer = new Configuration(conf);
-    confForInfoServer.setInt(HttpServer2.HTTP_MAX_THREADS, 10);
-    HttpServer2.Builder builder = new HttpServer2.Builder()
-      .setName("datanode")
-      .setConf(conf).setACL(new AccessControlList(conf.get(DFS_ADMIN, " ")))
-      .addEndpoint(URI.create("http://localhost:0"))
-      .setFindPort(true);
-
-    this.infoServer = builder.build();
-
-    this.infoServer.setAttribute("datanode", this);
-    this.infoServer.setAttribute(JspHelper.CURRENT_CONF, conf);
-    this.infoServer.addServlet(null, "/blockScannerReport",
-                               BlockScanner.Servlet.class);
-
-    this.infoServer.start();
-    InetSocketAddress jettyAddr = infoServer.getConnectorAddress(0);
-
-      secureResources.getHttpServerChannel() : null;
-    this.httpServer = new DatanodeHttpServer(conf, jettyAddr, httpServerChannel);
+        secureResources.getHttpServerChannel() : null;
+
+    this.httpServer = new DatanodeHttpServer(conf, this, httpServerChannel);
+  @VisibleForTesting
-  
+
+  @VisibleForTesting
-  
+
+  @VisibleForTesting
+  void setCacheReportsDisabledForTest(boolean disabled) {
+    this.cacheReportsDisabledForTests = disabled;
+  }
+
+  @VisibleForTesting
+  boolean areCacheReportsDisabledForTests() {
+    return this.cacheReportsDisabledForTests;
+  }
+
-    initDirectoryScanner(conf);
+    initDirectoryScanner(conf);
-    if (infoServer != null) {
-      try {
-        infoServer.stop();
-      } catch (Exception e) {
-        LOG.warn("Exception shutting down DataNode", e);
-      }
-    }
+  public List<String> listReconfigurableProperties()
+      throws IOException {
+    return RECONFIGURABLE_PROPERTIES;
+  }
+
+  @Override // ClientDatanodeProtocol

MOV23 INS23 INS31 INS31 INS31 INS31 INS29 INS83 INS83 INS83 MOV74 MOV59 INS83 INS39 INS78 INS83 MOV43 INS42 INS8 INS78 INS78 INS78 INS39 INS42 INS44 INS8 INS78 INS39 INS42 INS8 MOV21 INS78 INS83 INS74 INS42 INS43 INS8 INS65 UPD42 UPD42 INS9 INS42 INS41 INS42 INS42 INS42 INS39 INS42 INS21 INS42 INS41 INS42 INS43 INS43 INS42 INS41 UPD45 INS45 INS45 INS66 INS14 UPD42 INS7 INS22 INS42 INS42 INS42 INS43 INS22 INS42 INS52 INS42 INS42 INS52 INS52 INS42 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26 DEL42 DEL43 DEL33 DEL60 DEL42 DEL42 DEL43 DEL42 DEL14 DEL59 DEL60 DEL42 DEL42 DEL40 DEL34 DEL32 DEL21 DEL40 DEL43 DEL42 DEL40 DEL43 DEL14 DEL42 DEL45 DEL32 DEL42 DEL42 DEL32 DEL42 DEL42 DEL43 DEL42 DEL42 DEL42 DEL45 DEL32 DEL14 DEL32 DEL42 DEL42 DEL42 DEL45 DEL32 DEL32 DEL42 DEL9 DEL32 DEL59 DEL60 DEL52 DEL42 DEL22 DEL42 DEL42 DEL32 DEL7 DEL21 DEL52 DEL42 DEL22 DEL42 DEL45 DEL52 DEL32 DEL21 DEL52 DEL42 DEL22 DEL42 DEL40 DEL42 DEL32 DEL21 DEL52 DEL42 DEL22 DEL42 DEL33 DEL45 DEL40 DEL43 DEL57 DEL32 DEL21 DEL52 DEL42 DEL22 DEL42 DEL32 DEL21 DEL42 DEL43 DEL42 DEL42 DEL42 DEL34 DEL32 DEL59 DEL60 DEL42 DEL42 DEL33 DEL27 DEL42 DEL42 DEL32 DEL21 DEL8 DEL42 DEL43 DEL42 DEL44 DEL42 DEL42 DEL45 DEL42 DEL32 DEL21 DEL8 DEL12 DEL54 DEL8 DEL25