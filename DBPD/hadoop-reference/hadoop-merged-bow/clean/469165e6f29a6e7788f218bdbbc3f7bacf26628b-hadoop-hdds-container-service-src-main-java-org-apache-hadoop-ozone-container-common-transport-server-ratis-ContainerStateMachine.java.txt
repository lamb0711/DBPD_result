HDDS-1843. Undetectable corruption after restart of a datanode. Contributed by Shashikant Banerjee(#1364).

-    ContainerIdSetProto;
+    Container2BCSIDMapProto;
-import java.util.Set;
-import java.util.concurrent.ConcurrentSkipListSet;
-  private final Set<Long> createContainerSet;
+  private final Map<Long, Long> container2BCSIDMap;
-    this.createContainerSet = new ConcurrentSkipListSet<>();
+    this.container2BCSIDMap = new ConcurrentHashMap<>();
-      byte[] containerIds = IOUtils.toByteArray(fin);
-      ContainerProtos.ContainerIdSetProto proto =
-          ContainerProtos.ContainerIdSetProto.parseFrom(containerIds);
+      byte[] container2BCSIDData = IOUtils.toByteArray(fin);
+      ContainerProtos.Container2BCSIDMapProto proto =
+          ContainerProtos.Container2BCSIDMapProto
+              .parseFrom(container2BCSIDData);
-      // the createContainerSet here.
-      // createContainerSet will further grow as and when containers get created
-      createContainerSet.addAll(proto.getContainerIdList());
-      dispatcher.buildMissingContainerSet(createContainerSet);
+      // the container2BCSIDMap here.
+      // container2BCSIDMap will further grow as and when containers get created
+      container2BCSIDMap.putAll(proto.getContainer2BCSIDMap());
+      dispatcher.buildMissingContainerSetAndValidate(container2BCSIDMap);
-    ContainerIdSetProto.Builder builder = ContainerIdSetProto.newBuilder();
-    builder.addAllContainerId(createContainerSet);
+    Container2BCSIDMapProto.Builder builder =
+        Container2BCSIDMapProto.newBuilder();
+    builder.putAllContainer2BCSID(container2BCSIDMap);
-            .setCreateContainerSet(createContainerSet)
+            .setContainer2BCSIDMap(container2BCSIDMap)
-      if (cmdType == Type.WriteChunk || cmdType ==Type.PutSmallFile) {
-        builder.setCreateContainerSet(createContainerSet);
+      if (cmdType == Type.WriteChunk || cmdType == Type.PutSmallFile
+          || cmdType == Type.PutBlock) {
+        builder.setContainer2BCSIDMap(container2BCSIDMap);
-    for (Long cid : createContainerSet) {
+    for (Long cid : container2BCSIDMap.keySet()) {

UPD40 UPD74 UPD43 INS43 UPD42 UPD42 INS42 UPD43 INS32 UPD40 UPD42 UPD42 INS42 INS42 UPD42 UPD74 UPD43 UPD42 INS27 UPD43 UPD42 UPD40 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 MOV27 INS27 UPD42 UPD40 UPD42 UPD42 INS42 INS40 UPD42 UPD42 DEL40 DEL26 DEL40 DEL26 DEL42