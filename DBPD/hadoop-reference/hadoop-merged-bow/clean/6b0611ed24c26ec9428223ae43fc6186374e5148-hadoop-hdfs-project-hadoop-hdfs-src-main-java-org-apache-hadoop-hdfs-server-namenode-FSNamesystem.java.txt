Merging r1539737 through r1539896 from trunk to branch HDFS-2832

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2832@1539898 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.hdfs.protocol.PathBasedCacheDescriptor;
-  PathBasedCacheDescriptor addPathBasedCacheDirective(
+  long addPathBasedCacheDirective(
-      return (PathBasedCacheDescriptor) cacheEntry.getPayload();
+      return (Long) cacheEntry.getPayload();
-    PathBasedCacheDescriptor result = null;
+    Long result = null;
-      result = cacheManager.addDirective(directive, pc);
-      getEditLog().logAddPathBasedCacheDirective(directive,
+      if (directive.getId() != null) {
+        throw new IOException("addDirective: you cannot specify an ID " +
+            "for this operation.");
+      }
+      PathBasedCacheDirective effectiveDirective = 
+          cacheManager.addDirective(directive, pc);
+      getEditLog().logAddPathBasedCacheDirective(effectiveDirective,
+      result = effectiveDirective.getId();
-  void removePathBasedCacheDescriptor(Long id) throws IOException {
+  void modifyPathBasedCacheDirective(
+      PathBasedCacheDirective directive) throws IOException {
+    checkOperation(OperationCategory.WRITE);
+    final FSPermissionChecker pc = isPermissionEnabled ?
+        getPermissionChecker() : null;
+    boolean success = false;
+    CacheEntry cacheEntry = RetryCache.waitForCompletion(retryCache);
+    if (cacheEntry != null && cacheEntry.isSuccess()) {
+      return;
+    }
+    writeLock();
+    try {
+      checkOperation(OperationCategory.WRITE);
+      if (isInSafeMode()) {
+        throw new SafeModeException(
+            "Cannot add PathBasedCache directive", safeMode);
+      }
+      cacheManager.modifyDirective(directive, pc);
+      getEditLog().logModifyPathBasedCacheDirective(directive,
+          cacheEntry != null);
+      success = true;
+    } finally {
+      writeUnlock();
+      if (success) {
+        getEditLog().logSync();
+      }
+      if (isAuditEnabled() && isExternalInvocation()) {
+        logAuditEvent(success, "addPathBasedCacheDirective", null, null, null);
+      }
+      RetryCache.setState(cacheEntry, success);
+    }
+  }
+
+  void removePathBasedCacheDirective(Long id) throws IOException {
-      cacheManager.removeDescriptor(id, pc);
-      getEditLog().logRemovePathBasedCacheDescriptor(id, cacheEntry != null);
+      cacheManager.removeDirective(id, pc);
+      getEditLog().logRemovePathBasedCacheDirective(id, cacheEntry != null);
-        logAuditEvent(success, "removePathBasedCacheDescriptor", null, null,
+        logAuditEvent(success, "removePathBasedCacheDirective", null, null,
-  BatchedListEntries<PathBasedCacheDescriptor> listPathBasedCacheDescriptors(
-      long startId, String pool, String path) throws IOException {
+  BatchedListEntries<PathBasedCacheDirective> listPathBasedCacheDirectives(
+      long startId, PathBasedCacheDirective filter) throws IOException {
-    BatchedListEntries<PathBasedCacheDescriptor> results;
+    BatchedListEntries<PathBasedCacheDirective> results;
-          cacheManager.listPathBasedCacheDescriptors(startId, pool, path, pc);
+          cacheManager.listPathBasedCacheDirectives(startId, filter, pc);
-        logAuditEvent(success, "listPathBasedCacheDescriptors", null, null,
+        logAuditEvent(success, "listPathBasedCacheDirectives", null, null,

INS31 INS39 MOV60 INS39 INS42 INS44 INS43 INS8 UPD42 UPD74 MOV74 UPD42 INS43 INS42 INS42 INS21 INS60 INS60 INS60 INS25 INS21 INS54 UPD43 UPD43 UPD42 UPD43 MOV21 INS42 INS32 INS83 INS43 INS59 INS39 INS59 INS43 INS59 INS27 INS8 INS32 INS8 INS8 UPD42 UPD42 UPD74 MOV74 UPD42 INS25 INS60 INS42 INS40 INS42 INS42 INS16 INS42 INS9 INS42 INS42 INS32 INS27 INS32 INS41 INS42 INS21 INS25 INS21 MOV21 INS21 MOV21 INS25 INS25 INS21 INS21 INS21 UPD43 INS27 INS8 INS43 INS59 INS42 INS32 INS33 INS42 INS42 INS42 INS42 INS33 INS42 INS42 INS32 INS32 INS8 INS32 INS7 INS42 INS8 MOV27 INS8 INS32 INS32 INS32 INS27 UPD42 UPD43 INS32 INS33 INS53 INS42 INS42 MOV32 UPD42 INS32 INS42 INS42 INS40 INS42 INS53 INS42 INS42 INS42 INS42 UPD42 UPD42 INS42 INS9 INS21 INS21 INS42 INS42 INS42 INS42 UPD42 INS32 INS42 INS42 INS27 INS42 INS32 INS32 UPD42 INS42 INS42 INS14 INS42 INS42 INS14 INS32 INS32 INS42 INS42 INS33 INS42 INS42 UPD42 UPD42 INS43 INS27 INS43 INS45 INS42 INS32 INS42 INS42 INS42 INS45 INS33 INS33 INS33 UPD45 UPD45 INS42 INS45 INS45 INS42 INS42 DEL40 DEL26 DEL42 DEL43 DEL42 DEL43 DEL42 DEL44 DEL42