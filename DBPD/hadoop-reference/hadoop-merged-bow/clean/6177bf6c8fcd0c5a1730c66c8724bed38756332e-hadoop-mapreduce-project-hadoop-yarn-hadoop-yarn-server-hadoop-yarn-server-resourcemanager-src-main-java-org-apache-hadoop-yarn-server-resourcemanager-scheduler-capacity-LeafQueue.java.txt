Merge trunk into HA branch.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1233105 13f79535-47bb-0310-9956-ffa450edef68

-import java.net.InetSocketAddress;
-import org.apache.hadoop.net.NetUtils;
+  private static final CSAssignment NULL_ASSIGNMENT =
+      new CSAssignment(Resources.createResource(0), NodeType.NODE_LOCAL);
+  
-  public synchronized Resource 
+  public synchronized CSAssignment 
-      return assignReservedContainer(application, node, reservedContainer, 
-          clusterResource);
+      return new CSAssignment(
+          assignReservedContainer(application, node, reservedContainer, 
+              clusterResource),
+          NodeType.NODE_LOCAL); // Don't care about locality constraints 
+                                // for reserved containers
-            return Resources.none();
+            return NULL_ASSIGNMENT;
-          Resource assigned = 
+          CSAssignment assignment =  
-  
+          
+          Resource assigned = assignment.getResource();
+            
-            Resource assignedResource = 
-              application.getResourceRequest(priority, RMNode.ANY).getCapability();
-            allocateResource(clusterResource, 
-                application, assignedResource);
+            allocateResource(clusterResource, application, assigned);
-            return assignedResource; 
+            return assignment;
-    return Resources.none();
+    return NULL_ASSIGNMENT;
-      return container.getResource();
+      return container.getResource(); // Ugh, return resource to force re-sort
-    assignContainersOnNode(clusterResource, node, application, priority, rmContainer);
+    assignContainersOnNode(clusterResource, node, application, priority, 
+        rmContainer);
-  private Resource assignContainersOnNode(Resource clusterResource, 
+  private CSAssignment assignContainersOnNode(Resource clusterResource, 
-      return assigned;
+      return new CSAssignment(assigned, NodeType.NODE_LOCAL);
-      return assigned;
+      return new CSAssignment(assigned, NodeType.RACK_LOCAL);
-    return assignOffSwitchContainers(clusterResource, node, application, 
-        priority, reservedContainer);
+    return new CSAssignment(
+        assignOffSwitchContainers(clusterResource, node, application, 
+            priority, reservedContainer), 
+        NodeType.OFF_SWITCH);
-        " user=" + userName + " resources=" + user.getConsumedResources());
+        " user=" + userName + " user-resources=" + user.getConsumedResources());
-        " user=" + userName + " resources=" + user.getConsumedResources());
+        " user=" + userName + " user-resources=" + user.getConsumedResources());

INS23 INS83 INS83 INS83 INS43 INS59 UPD43 UPD43 INS42 INS42 INS14 UPD42 UPD42 INS43 INS32 INS40 INS42 INS14 INS42 INS42 INS42 INS34 INS43 MOV32 INS40 INS14 INS14 INS14 INS42 UPD45 UPD45 INS43 MOV32 INS40 INS43 INS42 INS40 INS43 INS42 INS40 INS42 INS42 INS42 INS60 UPD43 MOV43 INS59 UPD42 UPD42 INS42 INS32 INS42 INS42 INS42 UPD42 UPD42 DEL40 DEL26 DEL40 DEL26 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL42 DEL40 DEL32 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL32 DEL42 DEL42