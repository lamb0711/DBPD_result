HDFS-4760. Update inodeMap after node replacement.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1477827 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.server.namenode.snapshot.INodeFileWithSnapshot;
-  public INodeFile recordModification(final Snapshot latest)
-      throws QuotaExceededException {
-    return isInLatestSnapshot(latest)?
-        getParent().replaceChild4INodeFileWithSnapshot(this)
-            .recordModification(latest)
-        : this;
+  public INodeFile recordModification(final Snapshot latest,
+      final INodeMap inodeMap) throws QuotaExceededException {
+    if (isInLatestSnapshot(latest)) {
+      INodeFileWithSnapshot newFile = getParent()
+          .replaceChild4INodeFileWithSnapshot(this, inodeMap)
+          .recordModification(latest, inodeMap);
+      return newFile;
+    } else {
+      return this;
+    }
-  final INode setPermission(FsPermission permission, Snapshot latest)
-      throws QuotaExceededException {
-    return super.setPermission(permission.applyUMask(UMASK), latest);
+  final INode setPermission(FsPermission permission, Snapshot latest,
+      final INodeMap inodeMap) throws QuotaExceededException {
+    return super.setPermission(permission.applyUMask(UMASK), latest, inodeMap);
-  public final INodeFile setFileReplication(short replication, Snapshot latest)
-      throws QuotaExceededException {
-    final INodeFile nodeToUpdate = recordModification(latest);
+  public final INodeFile setFileReplication(short replication, Snapshot latest,
+      final INodeMap inodeMap) throws QuotaExceededException {
+    final INodeFile nodeToUpdate = recordModification(latest, inodeMap);

INS26 INS40 INS44 INS44 INS44 INS83 INS43 INS42 INS25 INS83 INS43 INS42 INS83 INS43 INS42 INS42 MOV32 INS8 INS8 INS42 INS42 INS60 INS41 INS41 INS42 INS43 INS59 INS42 INS52 INS42 INS42 INS42 INS32 MOV32 MOV42 MOV42 INS42 INS42 DEL32 DEL52 DEL16 DEL41