HDFS-4809. When a QuotaExceededException is thrown during rename, the quota usage should be subtracted back.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1480508 13f79535-47bb-0310-9956-ffa450edef68

-          // srcParent is not an INodeDirectoryWithSnapshot, we only need to add
+          // original srcChild is not in latest snapshot, we only need to add
-    final boolean added = parent.addChild(child, true, iip.getLatestSnapshot(),
-        inodeMap);
+    boolean added = false;
+    try {
+      added = parent.addChild(child, true, iip.getLatestSnapshot(),
+          inodeMap);
+    } catch (QuotaExceededException e) {
+      updateCountNoQuotaCheck(iip, pos,
+          -counts.get(Quota.NAMESPACE), -counts.get(Quota.DISKSPACE));
+      throw e;
+    }

INS54 INS8 INS12 INS9 INS21 INS44 INS8 INS7 INS43 INS42 INS21 INS53 INS42 MOV32 INS42 INS32 INS42 INS42 INS42 INS42 INS38 INS38 INS32 INS32 INS42 INS42 INS40 INS42 INS42 INS40 DEL83