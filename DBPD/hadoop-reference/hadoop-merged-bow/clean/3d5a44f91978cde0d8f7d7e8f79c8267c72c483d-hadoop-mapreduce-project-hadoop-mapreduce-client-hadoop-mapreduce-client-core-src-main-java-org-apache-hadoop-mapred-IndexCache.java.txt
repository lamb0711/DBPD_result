MAPREDUCE-4384. Race conditions in IndexCache (Kihwal Lee via tgraves)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1357937 13f79535-47bb-0310-9956-ffa450edef68

-      synchronized (info) {
-        while (null == info.mapSpillRecord) {
-          try {
-            info.wait();
-          } catch (InterruptedException e) {
-            throw new IOException("Interrupted waiting for construction", e);
-          }
+      while (isUnderConstruction(info)) {
+        try {
+          // In case the entry is ready after the above check but
+          // before the following wait, we do timed wait.
+          info.wait(200);
+        } catch (InterruptedException e) {
+          throw new IOException("Interrupted waiting for construction", e);
+  private boolean isUnderConstruction(IndexInformation info) {
+    synchronized(info) {
+      return (null == info.mapSpillRecord);
+    }
+  }
+
-      synchronized (info) {
-        while (null == info.mapSpillRecord) {
-          try {
-            info.wait();
-          } catch (InterruptedException e) {
-            throw new IOException("Interrupted waiting for construction", e);
-          }
+      while (isUnderConstruction(info)) {
+        try {
+          // In case the entry is ready after the above check but
+          // before the following wait, we do timed wait.
+          info.wait(200);
+        } catch (InterruptedException e) {
+          throw new IOException("Interrupted waiting for construction", e);
-    if ((info != null) && (info.getSize() == 0)) {
+    if (info == null || ((info != null) && isUnderConstruction(info))) {

INS31 MOV8 INS83 INS39 INS42 INS44 INS8 MOV60 INS25 MOV25 MOV41 INS43 INS42 INS51 MOV27 MOV8 MOV8 INS42 INS42 INS8 MOV8 INS27 MOV21 INS41 MOV21 MOV41 INS27 INS36 INS32 INS36 INS32 INS42 INS33 MOV27 INS42 INS42 INS42 UPD42 MOV42 MOV27 INS42 INS42 MOV32 INS45 INS42 INS45 MOV42 UPD45 MOV45 UPD42 UPD42 UPD45 MOV45 INS34 INS34 DEL33 DEL40 DEL27 DEL42 DEL51 DEL25 DEL8 DEL42 DEL51 DEL8 DEL34 DEL27 DEL36