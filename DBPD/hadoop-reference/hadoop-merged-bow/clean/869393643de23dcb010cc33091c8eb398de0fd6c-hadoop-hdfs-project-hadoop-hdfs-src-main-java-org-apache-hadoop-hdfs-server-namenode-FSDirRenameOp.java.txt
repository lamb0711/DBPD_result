HDFS-10745. Directly resolve paths into INodesInPath. Contributed by Daryn Sharp.

-    src = fsd.resolvePath(pc, src);
-    dst = fsd.resolvePath(pc, dst);
+    // Rename does not operate on link targets
+    // Do not resolveLink when checking permissions of src and dst
+    INodesInPath srcIIP = fsd.resolvePathForWrite(pc, src, false);
+    INodesInPath dstIIP = fsd.resolvePathForWrite(pc, dst, false);
-    final boolean status = renameTo(fsd, pc, src, dst, logRetryCache);
+    final boolean status = renameTo(fsd, pc, srcIIP, dstIIP, logRetryCache);
-      INodesInPath dstIIP = fsd.getINodesInPath(dst, false);
+      dstIIP = fsd.getINodesInPath(dstIIP.getPath(), false);
-    src = fsd.resolvePath(pc, src);
-    dst = fsd.resolvePath(pc, dst);
-    renameTo(fsd, pc, src, dst, collectedBlocks, logRetryCache, options);
+    // returns resolved path
+    dst = renameTo(fsd, pc, src, dst, collectedBlocks, logRetryCache, options);
-  static void renameTo(FSDirectory fsd, FSPermissionChecker pc, String src,
+  static String renameTo(FSDirectory fsd, FSPermissionChecker pc, String src,
-    final INodesInPath srcIIP = fsd.getINodesInPath4Write(src, false);
-    final INodesInPath dstIIP = fsd.getINodesInPath4Write(dst, false);
+    final INodesInPath srcIIP = fsd.resolvePathForWrite(pc, src, false);
+    final INodesInPath dstIIP = fsd.resolvePathForWrite(pc, dst, false);
+    src = srcIIP.getPath();
+    dst = dstIIP.getPath();
+    return dst;
-      String src, String dst, boolean logRetryCache) throws IOException {
-    // Rename does not operate on link targets
-    // Do not resolveLink when checking permissions of src and dst
-    // Check write access to parent of src
-    final INodesInPath srcIIP = fsd.getINodesInPath4Write(src, false);
+      INodesInPath srcIIP, INodesInPath dstIIP, boolean logRetryCache)
+          throws IOException {
+    String src = srcIIP.getPath();
+    String dst = dstIIP.getPath();
-    final String actualDst = fsd.isDir(dst) ?
-        dst + Path.SEPARATOR + new Path(src).getName() : dst;
-    final INodesInPath dstIIP = fsd.getINodesInPath4Write(actualDst, false);
+    if (fsd.isDir(dst)) {
+      dstIIP = INodesInPath.append(dstIIP, null, srcIIP.getLastLocalName());
+    }
+    final String actualDst = dstIIP.getPath();
+      // Check write access to parent of src

INS43 INS60 INS60 INS42 INS21 INS21 INS41 MOV43 UPD42 MOV43 UPD42 INS60 INS25 INS43 INS59 INS43 INS59 INS7 MOV43 MOV43 INS7 INS7 INS42 INS43 INS43 INS59 MOV32 INS8 MOV43 INS42 INS42 INS32 INS42 INS42 INS32 INS21 INS42 MOV32 INS42 INS32 INS42 INS32 INS42 UPD42 INS42 INS42 INS32 INS21 UPD42 MOV42 UPD42 MOV42 MOV42 MOV42 INS9 MOV42 UPD42 MOV42 MOV42 MOV42 INS9 UPD42 UPD42 INS7 UPD42 INS42 UPD42 INS42 INS42 INS42 INS42 INS42 UPD42 UPD42 INS42 INS42 INS7 UPD42 UPD42 INS42 INS32 INS42 INS32 MOV42 MOV42 INS32 MOV9 INS42 INS42 INS42 INS33 INS32 UPD42 MOV42 INS42 INS42 UPD42 MOV42 DEL42 DEL32 DEL7 DEL21 DEL42 DEL32 DEL7 DEL21 DEL42 DEL43 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL42 DEL42 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL39 DEL42 DEL43 DEL42 DEL43 DEL83 DEL42 DEL9 DEL83 DEL42 DEL42 DEL40 DEL42 DEL43 DEL42 DEL14 DEL32 DEL27 DEL42 DEL16 DEL59 DEL60 DEL42 DEL9