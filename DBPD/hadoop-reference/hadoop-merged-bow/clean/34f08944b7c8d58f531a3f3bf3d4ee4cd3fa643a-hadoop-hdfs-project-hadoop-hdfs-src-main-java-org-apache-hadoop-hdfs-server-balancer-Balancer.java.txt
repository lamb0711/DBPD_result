merge trunk to branch HDFS-4949

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-4949@1532952 13f79535-47bb-0310-9956-ffa450edef68

-    protected long scheduledSize = 0L;
+    private long scheduledSize = 0L;
-    protected boolean hasSpaceForScheduling() {
+    protected synchronized boolean hasSpaceForScheduling() {
-    protected long availableSizeToMove() {
+    protected synchronized long availableSizeToMove() {
-    /* increment scheduled size */
-    protected void incScheduledSize(long size) {
+    /** increment scheduled size */
+    protected synchronized void incScheduledSize(long size) {
+    /** decrement scheduled size */
+    protected synchronized void decScheduledSize(long size) {
+      scheduledSize -= size;
+    }
+    
+    /** get scheduled size */
+    protected synchronized long getScheduledSize(){
+      return scheduledSize;
+    }
+    
+    /** get scheduled size */
+    protected synchronized void setScheduledSize(long size){
+      scheduledSize = size;
+    }
+    
-            long blockSize = pendingBlock.block.getNumBytes(); 
-            scheduledSize -= blockSize;
+            long blockSize = pendingBlock.block.getNumBytes();
+            decScheduledSize(blockSize);
+      long scheduledSize = getScheduledSize();
-      while(!isTimeUp && scheduledSize>0 &&
+      while(!isTimeUp && getScheduledSize()>0 &&
-            scheduledSize = 0;
+            setScheduledSize(0);
-      bytesToMove += src.scheduledSize;
+      bytesToMove += src.getScheduledSize();
-    private long get() {
+    private synchronized long get() {

INS31 INS31 INS31 UPD83 INS83 INS83 INS29 INS83 INS29 INS83 INS83 INS39 INS42 INS44 INS8 INS29 INS83 INS83 INS39 INS42 INS8 INS29 INS83 INS83 INS39 INS42 INS44 INS8 INS83 INS65 INS65 INS39 INS42 INS21 INS65 INS41 INS65 INS39 INS42 INS21 INS60 INS66 INS66 INS7 INS66 INS42 INS66 INS7 INS39 INS59 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS32 INS32 INS42 INS42 INS42 INS32 INS32 INS42 INS42 INS42 INS34 DEL42 DEL42 DEL7 DEL42 DEL42 DEL34 DEL7 DEL40