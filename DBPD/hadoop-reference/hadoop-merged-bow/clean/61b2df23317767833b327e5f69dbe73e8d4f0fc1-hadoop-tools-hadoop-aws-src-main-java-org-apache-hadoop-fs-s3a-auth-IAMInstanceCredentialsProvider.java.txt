HADOOP-16470. Make last AWS credential provider in default auth chain EC2ContainerCredentialsProviderWrapper.

Contributed by Steve Loughran.

Contains HADOOP-16471. Restore (documented) fs.s3a.SharedInstanceProfileCredentialsProvider.

Change-Id: I06b99b57459cac80bf743c5c54f04e59bb54c2f8

-import com.amazonaws.auth.InstanceProfileCredentialsProvider;
+import com.amazonaws.auth.EC2ContainerCredentialsProviderWrapper;
- * This is going to be an IAM credential provider which performs
- * async refresh for lower-latency on IO calls.
- * Initially it does not do this, simply shares the single IAM instance
- * across all instances. This makes it less expensive to declare.
- *
+ * This is an IAM credential provider which wraps
+ * an {@code EC2ContainerCredentialsProviderWrapper}
+ * to provide credentials when the S3A connector is instantiated on AWS EC2
+ * or the AWS container services.
+ * <p>
+ * When it fails to authenticate, it raises a
+ * {@link NoAwsCredentialsException} which can be recognized by retry handlers
+ * as a non-recoverable failure.
+ * <p>
+ * It is implicitly public; marked evolving as we can change its semantics.
-@InterfaceAudience.Private
-@InterfaceStability.Unstable
+@InterfaceAudience.Public
+@InterfaceStability.Evolving
-  private static final InstanceProfileCredentialsProvider INSTANCE =
-      InstanceProfileCredentialsProvider.getInstance();
+  private final AWSCredentialsProvider provider =
+      new EC2ContainerCredentialsProviderWrapper();
-   * as it invariably means "you aren't running on EC2"
+   * Failure invariably means "you aren't running in an EC2 VM or AWS container".
+   * @throws NoAwsCredentialsException on auth failure to indicate non-recoverable.
-      return INSTANCE.getCredentials();
+      return provider.getCredentials();
-    INSTANCE.refresh();
+    provider.refresh();
-    // until async, no-op.
+    // no-op.

UPD40 UPD40 UPD40 UPD43 UPD66 UPD66 INS65 UPD66 INS66 INS66 UPD66 INS65 INS66 INS66 INS66 INS66 UPD42 UPD42 INS14 INS65 INS66 INS42 INS43 UPD66 INS42 INS66 INS42 UPD42 UPD42 DEL83 DEL42 DEL42 DEL32