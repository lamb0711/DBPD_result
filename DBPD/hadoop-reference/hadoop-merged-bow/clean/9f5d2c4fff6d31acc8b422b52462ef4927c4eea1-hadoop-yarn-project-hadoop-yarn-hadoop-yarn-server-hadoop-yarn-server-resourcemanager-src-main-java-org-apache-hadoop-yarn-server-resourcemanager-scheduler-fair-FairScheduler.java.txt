YARN-5136. Error in handling event type APP_ATTEMPT_REMOVED to the scheduler
(Contributed by Wilfred Spiegelenburg via Daniel Templeton)

-      LOG.info(
-          "Application " + applicationAttemptId + " is done." + " finalState="
+      LOG.info("Application " + applicationAttemptId + " is done. finalState="
+      // Check if the attempt is already stopped and don't stop it twice.
+      if (attempt.isStopped()) {
+        LOG.info("Application " + applicationAttemptId + " has already been "
+            + "stopped!");
+        return;
+      }
+
+        // Check if the attempt is already stopped: don't move stopped app
+        // attempt. The attempt has already been removed from all queues.
+        if (attempt.isStopped()) {
+          LOG.info("Application " + appId + " is stopped and can't be moved!");
+          throw new YarnException("Application " + appId
+              + " is stopped and can't be moved!");
+        }
-      FSAppAttempt attempt, FSLeafQueue oldQueue, FSLeafQueue newQueue) {
-    boolean wasRunnable = oldQueue.removeApp(attempt);
+      FSAppAttempt attempt, FSLeafQueue oldQueue, FSLeafQueue newQueue)
+      throws YarnException {
+    // Check current runs state. Do not remove the attempt from the queue until
+    // after the check has been performed otherwise it could remove the app
+    // from a queue without moving it to a new queue.
+    boolean wasRunnable = oldQueue.isRunnableApp(attempt);
-      throw new IllegalStateException("Should have already verified that app "
+      throw new YarnException("Should have already verified that app "
-    
+
+    // Now it is safe to remove from the queue.
+    oldQueue.removeApp(attempt);
+

INS43 INS42 INS21 MOV32 INS25 INS32 INS32 INS8 INS42 INS42 INS42 INS42 INS42 INS21 INS41 INS25 UPD43 UPD45 INS32 INS32 INS8 UPD42 INS42 INS42 INS27 INS42 INS42 INS21 INS53 INS45 INS42 INS45 INS45 INS32 INS14 INS42 INS42 INS27 INS43 INS27 INS45 INS42 INS45 INS42 INS45 INS42 INS45 DEL45