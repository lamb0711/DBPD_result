Merge trunk into auto-failover branch.

Needs a few tweaks to fix compilation - will do in followup commit. This is just a straight merge


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-3042@1324567 13f79535-47bb-0310-9956-ffa450edef68

-  @Override // JournalStream
+  @Override
-  @Override // JournalStream
-  public JournalType getType() {
-    return JournalType.BACKUP;
+  @Override
+  protected FSEditLogOp nextOp() throws IOException {
+    Preconditions.checkState(reader != null,
+        "Must call setBytes() before readOp()");
+    return reader.readOp(false);
-  public FSEditLogOp readOp() throws IOException {
-    Preconditions.checkState(reader != null,
-        "Must call setBytes() before readOp()");
-    return reader.readOp();
+  protected FSEditLogOp nextValidOp() {
+    try {
+      return reader.readOp(true);
+    } catch (IOException e) {
+      throw new RuntimeException("got unexpected IOException " + e, e);
+    }

MOV31 UPD83 UPD42 UPD83 UPD43 UPD42 INS8 UPD42 INS54 INS8 INS12 INS9 MOV41 INS44 INS8 INS32 INS43 INS42 INS53 INS42 INS42 INS9 INS42 INS14 INS43 INS27 INS42 INS42 INS45 INS42 DEL40 DEL8