HDFS-13596. NN restart fails after RollingUpgrade from 2.x to 3.x. Contributed by Fei Hui.

+  public void writeFields(DataOutputStream out, int logVersion)
+      throws IOException {
+    writeFields(out);
+  }
+
+      throw new IOException("Unsupported without logversion");
+    }
+
+    @Override
+    public void writeFields(DataOutputStream out, int logVersion)
+        throws IOException {
-        FSImageSerialization.writeByte(erasureCodingPolicyId, out);
+        if (NameNodeLayoutVersion.supports(
+            NameNodeLayoutVersion.Feature.ERASURE_CODING, logVersion)) {
+          FSImageSerialization.writeByte(erasureCodingPolicyId, out);
+        }
+     * @param logVersion The version of edit log
-    public void writeOp(FSEditLogOp op) throws IOException {
+    public void writeOp(FSEditLogOp op, int logVersion)
+        throws IOException {
-      op.writeFields(buf);
+      op.writeFields(buf, logVersion);

INS31 INS83 INS39 INS42 INS44 INS44 INS43 INS8 INS31 INS43 INS42 INS39 INS42 INS42 INS21 INS78 INS83 INS39 INS42 INS44 INS43 INS8 INS44 INS44 INS42 INS32 INS42 INS43 INS42 INS42 INS53 INS39 INS42 INS65 INS39 INS42 INS42 INS42 INS42 INS14 INS42 INS66 INS43 INS45 INS25 INS42 INS42 INS32 INS8 INS42 INS42 INS40 INS42 MOV21