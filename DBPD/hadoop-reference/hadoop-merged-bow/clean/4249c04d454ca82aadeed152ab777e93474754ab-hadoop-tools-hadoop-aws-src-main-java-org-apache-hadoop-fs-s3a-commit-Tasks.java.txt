HADOOP-16798. S3A Committer thread pool shutdown problems. (#1963)



Contributed by Steve Loughran.

Fixes a condition which can cause job commit to fail if a task was
aborted < 60s before the job commit commenced: the task abort
will shut down the thread pool with a hard exit after 60s; the
job commit POST requests would be scheduled through the same pool,
so be interrupted and fail. At present the access is synchronized,
but presumably the executor shutdown code is calling wait() and releasing
locks.

Task abort is triggered from the AM when task attempts succeed but
there are still active speculative task attempts running. Thus it
only surfaces when speculation is enabled and the final tasks are
speculating, which, given they are the stragglers, is not unheard of.

Note: this problem has never been seen in production; it has surfaced
in the hadoop-aws tests on a heavily overloaded desktop
-import java.util.concurrent.ExecutorService;
-    private ExecutorService service = null;
+    private Submitter service = null;
-     * @param executorService service to schedule tasks with.
+     * @param submitter service to schedule tasks with.
-    public Builder<I> executeWith(ExecutorService executorService) {
-      this.service = executorService;
+    public Builder<I> executeWith(Submitter submitter) {
+      this.service = submitter;
+
+  /**
+   * Interface to whatever lets us submit tasks.
+   */
+  public interface Submitter {
+
+    /**
+     * Submit work.
+     * @param task task to execute
+     * @return the future of the submitted task.
+     */
+    Future<?> submit(Runnable task);
+  }
+

INS55 INS29 INS83 INS42 INS31 UPD43 INS65 INS29 INS74 INS42 INS44 UPD42 UPD43 UPD42 INS66 INS65 INS65 INS65 INS43 INS76 INS43 INS42 UPD42 UPD42 INS66 INS42 INS66 INS66 INS42 INS42 UPD42 DEL40 DEL26