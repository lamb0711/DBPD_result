HDFS-8033. Erasure coding: stateful (non-positional) read from files in striped layout. Contributed by Zhe Zhang.

-  private AtomicBoolean closed = new AtomicBoolean(false);
-  private final String src;
-  private final boolean verifyChecksum;
+  protected AtomicBoolean closed = new AtomicBoolean(false);
+  protected final String src;
+  protected final boolean verifyChecksum;
-  private LocatedBlock currentLocatedBlock = null;
-  private long pos = 0;
-  private long blockEnd = -1;
+  protected LocatedBlock currentLocatedBlock = null;
+  protected long pos = 0;
+  protected long blockEnd = -1;
-  private LocatedBlocks locatedBlocks = null;
+  protected LocatedBlocks locatedBlocks = null;
-  private CachingStrategy cachingStrategy;
+  protected CachingStrategy cachingStrategy;
-  private final ReadStatistics readStatistics = new ReadStatistics();
+  protected final ReadStatistics readStatistics = new ReadStatistics();
-  private final Object infoLock = new Object();
+  protected final Object infoLock = new Object();
-  private int failures = 0;
+  protected int failures = 0;
-  private void fetchBlockAt(long offset) throws IOException {
+  protected void fetchBlockAt(long offset) throws IOException {
-    closeCurrentBlockReader();
+    closeCurrentBlockReaders();
-          DFSClient.LOG.info("Will fetch a new encryption key and retry, " 
+          DFSClient.LOG.info("Will fetch a new encryption key and retry, "
-    closeCurrentBlockReader();
+    closeCurrentBlockReaders();
-  private void updateReadStatistics(ReadStatistics readStatistics, 
+  protected void updateReadStatistics(ReadStatistics readStatistics,
-  private class ByteBufferStrategy implements ReaderStrategy {
+  protected class ByteBufferStrategy implements ReaderStrategy {
+        if (ret == 0) {
+          DFSClient.LOG.warn("zero");
+        }
-  private synchronized int readWithStrategy(ReaderStrategy strategy, int off, int len) throws IOException {
+  protected synchronized int readWithStrategy(ReaderStrategy strategy, int off, int len) throws IOException {
-  private void addIntoCorruptedBlockMap(ExtendedBlock blk, DatanodeInfo node, 
+  protected void addIntoCorruptedBlockMap(ExtendedBlock blk, DatanodeInfo node,
-  private DNAddrPair getBestNodeDNAddrPair(LocatedBlock block,
+  protected DNAddrPair getBestNodeDNAddrPair(LocatedBlock block,
-  private static boolean tokenRefetchNeeded(IOException ex,
+  protected static boolean tokenRefetchNeeded(IOException ex,
-  private void reportCheckSumFailure(
+  protected void reportCheckSumFailure(
-  private void closeCurrentBlockReader() {
+  protected void closeCurrentBlockReaders() {
-    closeCurrentBlockReader();
+    closeCurrentBlockReaders();
-    closeCurrentBlockReader();
+    closeCurrentBlockReaders();
-    closeCurrentBlockReader();
+    closeCurrentBlockReaders();

UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD83 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 INS25 INS27 INS8 INS42 INS34 INS21 INS32 INS40 INS42 INS45