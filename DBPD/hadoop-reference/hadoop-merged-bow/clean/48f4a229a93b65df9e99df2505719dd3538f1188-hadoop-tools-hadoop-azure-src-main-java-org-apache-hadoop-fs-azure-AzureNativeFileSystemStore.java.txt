HADOOP-14461 Azure: handle failure gracefully in case of missing account access key.
Contributed by Mingliang Liu.

+
+  /** The error message template when container is not accessible. */
+  static final String NO_ACCESS_TO_CONTAINER_MSG = "No credentials found for "
+      + "account %s in the configuration, and its container %s is not "
+      + "accessible using anonymous credentials. Please check if the container "
+      + "exists first. If it is not publicly available, you have to provide "
+      + "account credentials.";
+
+    boolean canAccess;
-      if (!container.exists(getInstrumentedContext())) {
-        throw new AzureException("Container " + containerName + " in account "
-            + accountName + " not found, and we can't create"
-            + " it using anoynomous credentials, and no credentials found for them"
-            + " in the configuration.");
-      }
+      canAccess = container.exists(getInstrumentedContext());
-      throw new AzureException("Unable to access container " + containerName
-          + " in account " + accountName
-          + " using anonymous credentials, and no credentials found for them "
-          + " in the configuration.", ex);
+      LOG.error("Service returned StorageException when checking existence "
+          + "of container {} in account {}", containerName, accountName, ex);
+      canAccess = false;
+    }
+    if (!canAccess) {
+      throw new AzureException(String.format(NO_ACCESS_TO_CONTAINER_MSG,
+          accountName, containerName));
-      if (propertyValue != null) {
-
+      if (StringUtils.isNotEmpty(propertyValue)) {
-
-        // Return to caller
-        return;
+      } else {
+        LOG.debug("The account access key is not configured for {}. "
+            + "Now try anonymous access.", sessionUri);
+        connectUsingAnonymousCredentials(sessionUri);
-
-      // The account access is not configured for this cluster. Try anonymous
-      // access.
-      connectUsingAnonymousCredentials(sessionUri);
-

INS23 INS29 INS83 INS83 INS43 INS59 INS65 INS42 INS42 INS27 INS60 INS54 INS25 INS66 INS45 INS45 INS45 INS45 INS45 INS39 INS59 INS8 INS12 INS38 INS8 INS42 INS21 MOV44 INS8 INS42 MOV53 INS7 INS21 INS21 INS32 INS8 INS42 MOV32 INS32 INS7 INS32 INS42 INS42 INS42 INS21 MOV21 INS42 INS42 INS27 INS42 INS42 INS42 INS42 INS9 INS42 INS42 INS42 INS42 INS42 INS32 INS45 UPD45 MOV45 INS42 INS42 INS27 INS42 INS45 INS45 DEL45 DEL42 DEL45 DEL42 DEL45 DEL45 DEL27 DEL42 DEL38 DEL42 DEL43 DEL42 DEL45 DEL42 DEL45 DEL45 DEL45 DEL27 DEL14 DEL53 DEL8 DEL25 DEL8 DEL8 DEL12 DEL54 DEL42 DEL33 DEL27 DEL41