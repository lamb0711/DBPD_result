YARN-569. Add support for requesting and enforcing preemption requests via
a capacity monitor. Contributed by Carlo Curino, Chris Douglas


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1502083 13f79535-47bb-0310-9956-ffa450edef68

-    launchedContainers.remove(container.getId());
-    updateResource(container);
+    if (null != launchedContainers.remove(container.getId())) {
+      updateResource(container);
+    }
-    // Cannot unreserve for wrong application...
-    ApplicationAttemptId reservedApplication = 
-        reservedContainer.getContainer().getId().getApplicationAttemptId(); 
-    if (!reservedApplication.equals(
-        application.getApplicationAttemptId())) {
-      throw new IllegalStateException("Trying to unreserve " +  
-          " for application " + application.getApplicationAttemptId() + 
-          " when currently reserved " + 
-          " for application " + reservedApplication.getApplicationId() + 
-          " on node " + this);
-    }
+    // adding NP checks as this can now be called for preemption
+    if (reservedContainer != null
+        && reservedContainer.getContainer() != null
+        && reservedContainer.getContainer().getId() != null
+        && reservedContainer.getContainer().getId().getApplicationAttemptId() != null) {
+
+      // Cannot unreserve for wrong application...
+      ApplicationAttemptId reservedApplication =
+          reservedContainer.getContainer().getId().getApplicationAttemptId();
+      if (!reservedApplication.equals(
+          application.getApplicationAttemptId())) {
+        throw new IllegalStateException("Trying to unreserve " +
+            " for application " + application.getApplicationAttemptId() +
+            " when currently reserved " +
+            " for application " + reservedApplication.getApplicationId() +
+            " on node " + this);
+      }
+    }

INS8 INS25 INS25 MOV21 INS27 INS8 INS27 MOV8 INS33 MOV32 MOV21 INS27 INS27 INS27 INS27 INS32 INS33 INS27 INS27 INS32 INS33 INS32 INS42 INS42 INS33 INS32 INS33 INS32 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL21