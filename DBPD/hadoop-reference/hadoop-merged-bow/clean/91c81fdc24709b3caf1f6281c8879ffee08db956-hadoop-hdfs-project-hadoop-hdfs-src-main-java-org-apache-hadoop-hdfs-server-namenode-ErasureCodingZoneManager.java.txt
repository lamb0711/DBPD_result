HDFS-8375. Add cellSize as an XAttr to ECZone. Contributed by Vinayakumar B.

+
+import org.apache.hadoop.hdfs.protocol.HdfsConstants;
+import org.apache.hadoop.io.IOUtils;
+import org.apache.hadoop.io.WritableUtils;
+import java.io.ByteArrayInputStream;
+import java.io.ByteArrayOutputStream;
+import java.io.DataInputStream;
+import java.io.DataOutputStream;
-          String schemaName = new String(xAttr.getValue());
+          ByteArrayInputStream bIn=new ByteArrayInputStream(xAttr.getValue());
+          DataInputStream dIn=new DataInputStream(bIn);
+          int cellSize = WritableUtils.readVInt(dIn);
+          String schemaName = WritableUtils.readString(dIn);
-          return new ErasureCodingZoneInfo(inode.getFullPathName(), schema);
+          return new ErasureCodingZoneInfo(inode.getFullPathName(), schema,
+              cellSize);
-  XAttr createErasureCodingZone(String src, ECSchema schema)
+  XAttr createErasureCodingZone(String src, ECSchema schema, int cellSize)
-    // Now persist the schema name in xattr
-    byte[] schemaBytes = schema.getSchemaName().getBytes();
-    final XAttr ecXAttr = XAttrHelper.buildXAttr(XATTR_ERASURECODING_ZONE,
-        schemaBytes);
+    if (cellSize <= 0) {
+      cellSize = HdfsConstants.BLOCK_STRIPED_CELL_SIZE;
+    }
+
+    // Write the cellsize first and then schema name
+    final XAttr ecXAttr;
+    DataOutputStream dOut = null;
+    try {
+      ByteArrayOutputStream bOut = new ByteArrayOutputStream();
+      dOut = new DataOutputStream(bOut);
+      WritableUtils.writeVInt(dOut, cellSize);
+      // Now persist the schema name in xattr
+      WritableUtils.writeString(dOut, schema.getSchemaName());
+      ecXAttr = XAttrHelper.buildXAttr(XATTR_ERASURECODING_ZONE,
+          bOut.toByteArray());
+    } finally {
+      IOUtils.closeStream(dOut);
+    }

INS26 INS26 INS26 INS26 INS26 INS26 INS26 INS40 INS40 INS40 INS40 INS40 INS40 INS40 INS44 INS39 INS42 INS25 INS60 INS60 INS54 INS27 INS8 INS83 MOV43 INS59 INS43 INS59 INS8 INS8 INS42 INS34 INS21 INS42 INS42 INS42 INS33 MOV60 INS21 INS21 INS21 INS21 INS21 INS7 INS43 INS7 INS32 MOV32 MOV32 INS7 INS32 INS42 INS40 INS42 INS42 INS14 INS42 INS14 INS42 INS42 INS42 INS42 UPD42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS43 INS43 INS42 MOV42 MOV42 MOV42 INS32 INS60 INS60 INS60 INS42 INS42 INS42 UPD42 MOV42 UPD43 INS43 INS59 INS39 INS59 MOV43 INS59 UPD42 UPD42 INS42 INS42 INS14 INS42 INS32 INS42 INS32 INS42 INS43 INS43 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL39 DEL85 DEL5 DEL42 DEL83 DEL42 DEL32 DEL59 DEL60