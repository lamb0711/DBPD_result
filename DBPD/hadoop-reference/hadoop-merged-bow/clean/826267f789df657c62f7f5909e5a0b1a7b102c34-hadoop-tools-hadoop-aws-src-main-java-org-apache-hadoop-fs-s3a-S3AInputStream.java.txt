HADOOP-11570. S3AInputStream.close() downloads the remaining bytes of the object from S3. (Dan Hecht via stevel).

-  private S3Object wrappedObject;
-
+  public static final long CLOSE_THRESHOLD = 4096;
-    this.wrappedObject = null;
-    if (wrappedObject == null) {
+    if (wrappedStream == null) {
-    wrappedObject = client.getObject(request);
-    wrappedStream = wrappedObject.getObjectContent();
+    wrappedStream = client.getObject(request).getObjectContent();
-    if (wrappedObject != null) {
-      wrappedObject.close();
+    if (wrappedStream != null) {
+      if (contentLength - pos <= CLOSE_THRESHOLD) {
+        // Close, rather than abort, so that the http connection can be reused.
+        wrappedStream.close();
+      } else {
+        // Abort, rather than just close, the underlying stream.  Otherwise, the
+        // remaining object payload is read from S3 while closing the stream.
+        wrappedStream.abort();
+      }

MOV23 UPD83 INS83 INS83 INS39 UPD42 INS34 INS8 UPD42 UPD42 INS32 UPD42 INS25 MOV32 INS42 INS27 MOV8 INS8 INS27 INS42 INS21 INS42 INS42 INS32 UPD42 INS42 INS42 DEL42 DEL43 DEL52 DEL42 DEL22 DEL33 DEL7 DEL21 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21