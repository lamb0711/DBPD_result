YARN-1855. Made Application-history server to be optional in MiniYARNCluster and thus avoid the failure of TestRMFailover#testRMWebAppRedirect. Contributed by Zhijie Shen.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1579838 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.yarn.server.applicationhistoryservice.ApplicationHistoryStore;
+import org.apache.hadoop.yarn.server.applicationhistoryservice.MemoryApplicationHistoryStore;
+import org.apache.hadoop.yarn.server.applicationhistoryservice.timeline.MemoryTimelineStore;
+import org.apache.hadoop.yarn.server.applicationhistoryservice.timeline.TimelineStore;
-import org.apache.hadoop.yarn.server.resourcemanager.RMFatalEvent;
-  private ApplicationHistoryServerWrapper appHistoryServerWrapper;
+  private boolean enableAHS;
+   * @param enableAHS enable ApplicationHistoryServer or not
-      int numLocalDirs, int numLogDirs) {
+      int numLocalDirs, int numLogDirs, boolean enableAHS) {
+    this.enableAHS = enableAHS;
+   * @param numResourceManagers the number of resource managers in the cluster
+   * @param numNodeManagers the number of node managers in the cluster
+   * @param numLocalDirs the number of nm-local-dirs per nodemanager
+   * @param numLogDirs the number of nm-log-dirs per nodemanager
+   */
+  public MiniYARNCluster(
+      String testName, int numResourceManagers, int numNodeManagers,
+      int numLocalDirs, int numLogDirs) {
+    this(testName, numResourceManagers, numNodeManagers, numLocalDirs,
+        numLogDirs, false);
+  }
+
+  /**
+   * @param testName name of the test
-    addService(new ApplicationHistoryServerWrapper());
+    if (enableAHS) {
+      addService(new ApplicationHistoryServerWrapper());
+    }
-      if (!conf.getBoolean(YarnConfiguration.YARN_MINICLUSTER_FIXED_PORTS,
-          YarnConfiguration.DEFAULT_YARN_MINICLUSTER_FIXED_PORTS)) {
-        conf.set(YarnConfiguration.TIMELINE_SERVICE_ADDRESS,
-            YarnConfiguration.DEFAULT_TIMELINE_SERVICE_ADDRESS);
-        conf.set(YarnConfiguration.TIMELINE_SERVICE_WEBAPP_ADDRESS,
-            YarnConfiguration.DEFAULT_TIMELINE_SERVICE_WEBAPP_ADDRESS);
-      }
+      conf.setClass(YarnConfiguration.APPLICATION_HISTORY_STORE,
+          MemoryApplicationHistoryStore.class, ApplicationHistoryStore.class);
+      conf.setClass(YarnConfiguration.TIMELINE_SERVICE_STORE,
+          MemoryTimelineStore.class, TimelineStore.class);

MOV26 INS26 INS26 INS26 INS40 INS40 INS40 UPD40 INS23 INS31 MOV83 INS39 INS59 INS29 INS44 MOV29 INS83 INS42 INS44 INS44 INS44 INS44 INS44 INS8 INS42 INS65 INS65 INS65 INS65 INS65 INS65 INS39 INS42 INS21 INS43 INS42 INS39 INS42 INS39 INS42 INS39 INS42 INS39 INS42 INS17 INS25 INS8 INS42 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS7 UPD42 MOV42 INS42 INS42 INS42 INS42 INS42 INS9 INS42 INS8 MOV21 MOV21 MOV21 MOV21 MOV21 INS22 INS42 MOV21 INS52 INS42 UPD42 UPD40 INS57 INS57 UPD42 UPD40 INS57 INS57 INS43 INS43 INS43 INS43 INS42 INS42 INS42 INS42 DEL43 DEL42 DEL59 DEL23 DEL40 DEL40 DEL42 DEL42 DEL40 DEL40 DEL32 DEL38 DEL8 DEL25 DEL8