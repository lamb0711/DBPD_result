HDFS-10391. Always enable NameNode service RPC port. Contributed by Gergely Novak.

+    private int nameNodeServicePort = 0;
+
+    /**
+     * Default: 0
+     */
+    public Builder nameNodeServicePort(int val) {
+      this.nameNodeServicePort = val;
+      return this;
+    }
-     * Default: false
-     * When true the hosts file/include file for the cluster is setup
+     * Default: false.
+     * When true the hosts file/include file for the cluster is setup.
-     * federated nameservices
+     * federated nameservices.
-          builder.nameNodePort, builder.nameNodeHttpPort);
+          builder.nameNodePort, builder.nameNodeServicePort,
+          builder.nameNodeHttpPort);
-                       MiniDFSNNTopology.simpleSingleNN(nameNodePort, 0),
+                       MiniDFSNNTopology.simpleSingleNN(nameNodePort, 0, 0),
+
+    key = DFSUtil.addKeySuffixes(
+        DFS_NAMENODE_SERVICE_RPC_ADDRESS_KEY, nameserviceId,
+        nnConf.getNnId());
+    conf.set(key, "127.0.0.1:" + nnConf.getServicePort());
+    hdfsConf.set(DFSUtil.addKeySuffixes(DFS_NAMENODE_SERVICE_RPC_ADDRESS_KEY,
+        nameserviceId, nnId), nn.getServiceRpcAddressHostPortString());
+  /**
+   * Return the cluster-wide configuration.
+   * @return
+   */
+  public Configuration getClusterConfiguration() {
+    return conf;
+  }
+
+   * Gets the service rpc port used by the NameNode, because the caller
+   * supplied port is not necessarily the actual port used.
+   * Assumption: cluster has a single namenode
+   */
+  public int getNameNodeServicePort() {
+    checkSingleNameNode();
+    return getNameNodeServicePort(0);
+  }
+
+  /**
-    InetSocketAddress addr = info.nameNode.getServiceRpcAddress();
-    assert addr.getPort() != 0;
-    DFSClient client = new DFSClient(addr, conf);
+    InetSocketAddress nameNodeAddress = info.nameNode.getNameNodeAddress();
+    assert nameNodeAddress.getPort() != 0;
+    DFSClient client = new DFSClient(nameNodeAddress, conf);
-    while (shouldWait(client.datanodeReport(DatanodeReportType.LIVE), addr)) {
+    InetSocketAddress serviceAddress = info.nameNode.getServiceRpcAddress();
+    while (shouldWait(client.datanodeReport(DatanodeReportType.LIVE),
+        serviceAddress)) {
+  public void addNameNode(Configuration conf, int namenodePort)
+      throws IOException{
+    addNameNode(conf, namenodePort, 0);
+  }
+
-  public void addNameNode(Configuration conf, int namenodePort)
+  public void addNameNode(Configuration conf, int namenodePort, int servicePort)
-        new NNConf(nnId).setIpcPort(namenodePort));
+        new NNConf(nnId)
+            .setIpcPort(namenodePort)
+            .setServicePort(servicePort));

INS31 INS31 INS31 INS23 INS31 INS29 INS83 INS43 INS42 INS8 INS29 INS83 INS39 INS42 INS8 MOV60 INS83 INS39 INS42 INS44 INS44 INS43 INS8 INS44 INS83 INS39 INS59 INS29 INS83 INS43 INS42 INS44 INS8 INS21 INS21 INS21 INS65 INS65 INS42 INS41 INS65 INS21 INS41 INS60 INS43 INS42 INS39 INS42 INS42 INS21 INS39 INS42 INS42 INS34 INS65 INS42 INS39 INS42 INS21 INS41 INS7 INS32 INS32 INS66 INS42 INS66 INS66 INS66 INS32 INS32 INS43 INS59 MOV43 INS42 INS32 INS32 INS66 INS7 INS52 UPD66 UPD66 UPD66 INS42 INS32 INS42 INS42 INS42 INS27 INS42 INS42 INS32 INS32 INS42 INS42 INS34 INS42 INS42 INS32 UPD42 UPD42 INS42 INS42 INS42 INS34 INS42 INS42 INS42 MOV32 MOV32 INS22 INS42 INS34 INS42 INS42 INS42 INS42 INS32 INS45 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS40 INS42 UPD42 MOV43 UPD42 UPD42 UPD42 INS52 INS42 INS42 INS42 INS42 INS42 INS40 DEL42