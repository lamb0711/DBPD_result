Merge branch 'trunk' into HDFS-6581

-  // TODO: Eliminate null elements from inodes (to be provided by HDFS-7104)
-   * Index of {@link INodeDirectoryWithSnapshot} for snapshot path, else -1
+   * index of the {@link Snapshot.Root} node in the inodes array,
+   * -1 for non-snapshot paths.
-   * @return the inodes array excluding the null elements.
+   * @return a new array of inodes excluding the null elements introduced by
+   * snapshot path elements. E.g., after resolving path "/dir/.snapshot",
+   * {@link #inodes} is {/, dir, null}, while the returned array only contains
+   * inodes of "/" and "dir". Note the length of the returned array is always
+   * equal to {@link #capacity}.
-    if (capacity < inodes.length) {
-      INode[] newNodes = new INode[capacity];
-      System.arraycopy(inodes, 0, newNodes, 0, capacity);
-      inodes = newNodes;
+    if (capacity == inodes.length) {
+      return inodes;
-    return inodes;
+
+    INode[] newNodes = new INode[capacity];
+    System.arraycopy(inodes, 0, newNodes, 0, capacity);
+    return newNodes;
-   * @return index of the {@link INodeDirectoryWithSnapshot} in
-   *         {@link #inodes} for snapshot path, else -1.
+   * @return index of the {@link Snapshot.Root} node in the inodes array,
+   * -1 for non-snapshot paths.

MOV8 INS25 INS41 UPD66 INS66 UPD66 UPD66 INS66 MOV65 INS66 INS66 INS66 INS65 INS66 INS27 INS8 INS42 UPD66 UPD66 INS40 INS67 INS42 INS40 MOV41 INS40 INS42 DEL42 DEL42 DEL42 DEL7 DEL21 DEL42 DEL40 DEL27 DEL25 DEL8 DEL42