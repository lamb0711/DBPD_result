HDFS-3256. HDFS considers blocks under-replicated if topology script is configured with only 1 rack. Contributed by Aaron T. Myers.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1325531 13f79535-47bb-0310-9956-ffa450edef68

+import com.google.common.annotations.VisibleForTesting;
+  /**
+   * Whether or not this cluster has ever consisted of more than 1 rack,
+   * according to the NetworkTopology.
+   */
+  private boolean hasClusterEverBeenMultiRack = false;
+  
+    checkIfClusterIsNowMultiRack(node);
+   * @return true if this cluster has ever consisted of multiple racks, even if
+   *         it is not now a multi-rack cluster.
+   */
+  boolean hasClusterEverBeenMultiRack() {
+    return hasClusterEverBeenMultiRack;
+  }
+
+  /**
+   * Check if the cluster now consists of multiple racks. If it does, and this
+   * is the first time it's consisted of multiple racks, then process blocks
+   * that may now be misreplicated.
+   * 
+   * @param node DN which caused cluster to become multi-rack. Used for logging.
+   */
+  @VisibleForTesting
+  void checkIfClusterIsNowMultiRack(DatanodeDescriptor node) {
+    if (!hasClusterEverBeenMultiRack && networktopology.getNumOfRacks() > 1) {
+      String message = "DN " + node + " joining cluster has expanded a formerly " +
+          "single-rack cluster to be multi-rack. ";
+      if (namesystem.isPopulatingReplQueues()) {
+        message += "Re-checking all blocks for replication, since they should " +
+            "now be replicated cross-rack";
+        LOG.info(message);
+      } else {
+        message += "Not checking for mis-replicated blocks because this NN is " +
+            "not yet processing repl queues.";
+        LOG.debug(message);
+      }
+      hasClusterEverBeenMultiRack = true;
+      if (namesystem.isPopulatingReplQueues()) {
+        blockManager.processMisReplicatedBlocks();
+      }
+    }
+  }
+
+  /**

INS26 INS40 INS23 INS31 INS31 INS29 INS83 INS39 INS59 INS29 INS39 INS42 INS8 INS29 INS78 INS39 INS42 INS44 INS8 INS65 INS42 INS9 INS21 INS65 INS41 INS65 INS65 INS42 INS43 INS42 INS25 INS66 INS66 INS32 INS66 INS66 INS42 INS66 INS66 INS66 INS42 INS66 INS42 INS27 INS8 INS42 INS42 INS38 INS27 INS60 INS25 INS21 INS25 INS42 INS32 INS34 INS43 INS59 INS32 INS8 INS8 INS7 INS32 INS8 INS42 INS42 INS42 INS42 INS27 INS42 INS42 INS21 INS21 INS21 INS21 INS42 INS9 INS42 INS42 INS21 INS45 INS42 INS45 INS45 INS7 INS32 INS7 INS32 INS32 INS42 INS27 INS42 INS42 INS42 INS42 INS27 INS42 INS42 INS42 INS42 INS42 INS45 INS45 INS45 INS45