HDFS-6120. Fix and improve safe mode log messages. (Arpit Agarwal)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1580047 13f79535-47bb-0310-9956-ffa450edef68

-import java.io.DataOutputStream;
-      if (reached == 0)
-        return false;
-      if (now() - reached < extension) {
-        reportStatus("STATE* Safe mode ON.", false);
+      if (reached == 0) {
-      return !needEnter();
+
+      if (now() - reached < extension) {
+        reportStatus("STATE* Safe mode ON, in safe mode extension.", false);
+        return false;
+      }
+
+      if (needEnter()) {
+        reportStatus("STATE* Safe mode ON, thresholds not met.", false);
+        return false;
+      }
+
+      return true;
-      if(!isOn())
+      if(!isOn()) {
+      }
-      String leaveMsg = "It was turned on manually. ";
+      String adminMsg = "It was turned on manually. ";
-        leaveMsg = "Resources are low on NN. Please add or free up more "
+        adminMsg = "Resources are low on NN. Please add or free up more "
-        return leaveMsg
+        return adminMsg
-      //Automatic safemode. System will come out of safemode automatically.
-      leaveMsg = "Safe mode will be turned off automatically";
+      boolean thresholdsMet = true;
-      if (reached == 0) {
-        if (blockSafe < blockThreshold) {
-          msg += String.format(
-            "The reported blocks %d needs additional %d"
-            + " blocks to reach the threshold %.4f of total blocks %d.\n",
-            blockSafe, (blockThreshold - blockSafe) + 1, threshold, blockTotal);
-        }
-        if (numLive < datanodeThreshold) {
-          msg += String.format(
-            "The number of live datanodes %d needs an additional %d live "
-            + "datanodes to reach the minimum number %d.\n",
-            numLive, (datanodeThreshold - numLive), datanodeThreshold);
-        }
+      if (blockSafe < blockThreshold) {
+        msg += String.format(
+          "The reported blocks %d needs additional %d"
+          + " blocks to reach the threshold %.4f of total blocks %d.\n",
+          blockSafe, (blockThreshold - blockSafe) + 1, threshold, blockTotal);
+        thresholdsMet = false;
-        msg = String.format("The reported blocks %d has reached the threshold"
+        msg += String.format("The reported blocks %d has reached the threshold"
-
+      }
+      if (numLive < datanodeThreshold) {
+        msg += String.format(
+          "The number of live datanodes %d needs an additional %d live "
+          + "datanodes to reach the minimum number %d.\n",
+          numLive, (datanodeThreshold - numLive), datanodeThreshold);
+        thresholdsMet = false;
+      } else {
-                               + "the minimum number %d. ",
-                               numLive, datanodeThreshold);
+            + "the minimum number %d. ",
+            numLive, datanodeThreshold);
-      msg += leaveMsg;
-      // threshold is not reached or manual or resources low
-      if(reached == 0 || (isManual() && !areResourcesLow())) {
-        return msg;
+      msg += (reached > 0) ? "In safe mode extension. " : "";
+      msg += "Safe mode will be turned off automatically ";
+
+      if (!thresholdsMet) {
+        msg += "once the thresholds have been reached.";
+      } else if (reached + extension - now() > 0) {
+        msg += ("in " + (reached + extension - now()) / 1000 + " seconds.");
+      } else {
+        msg += "soon.";
-      // extension period is in progress
-      return msg + (reached + extension - now() > 0 ?
-        " in " + (reached + extension - now()) / 1000 + " seconds."
-        : " soon.");
+
+      return msg;

INS25 INS60 MOV25 MOV25 INS21 MOV21 INS25 MOV41 INS8 MOV32 INS8 INS9 INS8 INS39 INS59 INS8 INS8 INS7 UPD7 INS38 INS8 INS25 INS41 INS21 MOV41 MOV41 UPD42 INS42 INS9 INS21 INS21 INS21 INS21 UPD42 MOV42 INS16 INS45 INS42 MOV21 MOV27 INS8 INS8 INS9 INS32 INS7 INS7 INS7 INS7 INS36 INS45 INS45 MOV21 INS21 UPD45 INS42 INS45 INS9 UPD42 UPD42 INS42 INS9 INS42 MOV32 INS42 INS9 INS42 MOV32 INS27 INS45 INS7 MOV42 MOV34 MOV36 INS42 INS45 MOV27 UPD45 DEL40 DEL26 DEL38 DEL45 DEL7 DEL21 DEL45 DEL16 DEL42 DEL27 DEL8 DEL8 DEL25 DEL42 DEL34 DEL27 DEL42 DEL32 DEL42 DEL32 DEL38 DEL27 DEL36 DEL27 DEL8 DEL25 DEL42 DEL27 DEL41