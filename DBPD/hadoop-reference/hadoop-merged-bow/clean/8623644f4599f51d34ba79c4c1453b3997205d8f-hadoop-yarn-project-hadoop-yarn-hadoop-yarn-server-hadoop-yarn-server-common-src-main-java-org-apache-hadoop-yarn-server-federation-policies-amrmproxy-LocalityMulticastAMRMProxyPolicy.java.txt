YARN-6190. Validation and synchronization fixes in LocalityMulticastAMRMProxyPolicy. (Botong Huang via curino)

(cherry picked from commit 5c486961cd3a175b122ef86275c99b72964f2c50)

+import org.apache.hadoop.yarn.exceptions.YarnRuntimeException;
-    if (policy.getAMRMPolicyWeights() == null
-        || policy.getAMRMPolicyWeights().size() == 0) {
-      allInactive = false;
-    } else {
+
+    if (policy.getAMRMPolicyWeights() != null
+        && policy.getAMRMPolicyWeights().size() > 0) {
-    this.bookkeeper = new AllocationBookkeeper();
-    // active subclusters.
+    // active subclusters. Create a new instance per call because this method
+    // can be called concurrently.
+    bookkeeper = new AllocationBookkeeper();
+        boolean hasActive = false;
+            hasActive = true;
-        continue;
+        if (hasActive) {
+          continue;
+        }
-        if (out.isAnyLocation(out.getResourceName())) {
+        if (ResourceRequest.isAnyLocation(out.getResourceName())) {
-    float totWeight = allocationBookkeeper.getTotNumLocalizedContainers();
+    float totWeight = allocationBookkeeper.getTotNumLocalizedContainers(reqId);
-    Float localWeight = weights.get(targetId);
+    Float localWeight = allocationBookkeeper.policyWeights.get(targetId);
+    private Map<Long, AtomicLong> totNumLocalizedContainers = new HashMap<>();
-    private long totNumLocalizedContainers = 0;
+    private Map<SubClusterId, Float> policyWeights;
+      if (activeSubclusters == null) {
+        throw new YarnRuntimeException("null activeSubclusters received");
+      }
+      totNumLocalizedContainers.clear();
-      totNumLocalizedContainers = 0;
+      // save the reference locally in case the weights get reinitialized
+      // concurrently
+      policyWeights = weights;
-      for (Map.Entry<SubClusterId, Float> entry : weights.entrySet()) {
+      for (Map.Entry<SubClusterId, Float> entry : policyWeights.entrySet()) {
-
-      Preconditions.checkArgument(!rr.isAnyLocation(rr.getResourceName()));
+      Preconditions
+          .checkArgument(!ResourceRequest.isAnyLocation(rr.getResourceName()));
-      totNumLocalizedContainers += rr.getNumContainers();
+      if (!totNumLocalizedContainers.containsKey(rr.getAllocationRequestId())) {
+        totNumLocalizedContainers.put(rr.getAllocationRequestId(),
+            new AtomicLong(0));
+      }
+      totNumLocalizedContainers.get(rr.getAllocationRequestId())
+          .addAndGet(rr.getNumContainers());
-      Preconditions.checkArgument(!rr.isAnyLocation(rr.getResourceName()));
+      Preconditions
+          .checkArgument(!ResourceRequest.isAnyLocation(rr.getResourceName()));
-      Preconditions.checkArgument(rr.isAnyLocation(rr.getResourceName()));
+      Preconditions
+          .checkArgument(ResourceRequest.isAnyLocation(rr.getResourceName()));
-     * Return the total number of container coming from localized requests.
+     * Return the total number of container coming from localized requests
+     * matching an allocation Id.
-    private long getTotNumLocalizedContainers() {
-      return totNumLocalizedContainers;
+    private long getTotNumLocalizedContainers(long allocationId) {
+      AtomicLong c = totNumLocalizedContainers.get(allocationId);
+      return c == null ? 0 : c.get();

INS26 INS40 MOV23 MOV31 INS23 MOV21 INS74 INS83 INS74 INS59 MOV21 MOV29 UPD83 UPD42 MOV44 MOV44 MOV29 UPD83 UPD42 MOV44 MOV44 INS44 UPD27 INS43 INS43 INS43 INS14 INS43 INS43 INS43 INS42 INS25 INS21 INS25 INS21 INS39 INS42 INS60 INS41 UPD27 UPD27 INS42 INS42 INS42 INS42 INS74 INS42 INS42 INS42 INS27 INS8 INS32 INS38 INS8 INS32 UPD66 INS66 INS43 INS59 INS16 INS42 INS40 INS43 INS42 INS33 INS53 INS42 INS42 INS42 UPD42 UPD42 INS32 MOV21 INS32 INS42 MOV32 INS38 MOV32 INS42 INS42 INS32 INS27 INS34 INS32 INS60 INS25 INS42 INS14 INS42 INS42 INS32 INS32 INS42 INS42 INS32 MOV32 UPD42 INS42 INS42 INS42 INS42 INS33 INS42 INS42 INS39 INS59 INS42 INS8 INS43 INS45 UPD42 INS42 INS42 INS42 INS42 INS32 INS14 INS42 INS42 UPD42 INS42 INS9 MOV18 UPD42 INS42 INS42 INS42 INS43 INS34 INS42 INS21 INS7 INS42 INS9 DEL42 DEL9 DEL7 DEL21 DEL8 DEL52 DEL42 DEL22 DEL42 DEL39 DEL34 DEL34 DEL42 DEL7 DEL38 DEL42 DEL41