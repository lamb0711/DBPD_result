HDFS-3368. Missing blocks due to bad DataNodes coming up and down. 

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1342512 13f79535-47bb-0310-9956-ffa450edef68

+import static org.apache.hadoop.hdfs.server.common.Util.now;
+
+import org.apache.commons.logging.impl.Log4JLogger;
+  private static final String enableDebugLogging =
+    "For more information, please enable DEBUG log level on "
+    + ((Log4JLogger)LOG).getLogger().getName();
+
-  static final String enableDebugLogging = "For more information, please enable"
-    + " DEBUG level logging on the "
-    + "org.apache.hadoop.hdfs.server.namenode.FSNamesystem logger.";
+  private long heartbeatInterval;   // interval for DataNode heartbeats
+  /**
+   * A miss of that many heartbeats is tolerated for replica deletion policy.
+   */
+  private int tolerateHeartbeatMultiplier;
+    this.heartbeatInterval = conf.getLong(
+        DFSConfigKeys.DFS_HEARTBEAT_INTERVAL_KEY,
+        DFSConfigKeys.DFS_HEARTBEAT_INTERVAL_DEFAULT) * 1000;
+    this.tolerateHeartbeatMultiplier = conf.getInt(
+        DFSConfigKeys.DFS_NAMENODE_TOLERATE_HEARTBEAT_MULTIPLIER_KEY,
+        DFSConfigKeys.DFS_NAMENODE_TOLERATE_HEARTBEAT_MULTIPLIER_DEFAULT);
+    long oldestHeartbeat =
+      now() - heartbeatInterval * tolerateHeartbeatMultiplier;
+    DatanodeDescriptor oldestHeartbeatNode = null;
-    DatanodeDescriptor cur = null;
+    DatanodeDescriptor minSpaceNode = null;
-    // pick node with least free space
+    // Pick the node with the oldest heartbeat or with the least free space,
+    // if all hearbeats are within the tolerable heartbeat interval
+      long lastHeartbeat = node.getLastUpdate();
+      if(lastHeartbeat < oldestHeartbeat) {
+        oldestHeartbeat = lastHeartbeat;
+        oldestHeartbeatNode = node;
+      }
-        cur = node;
+        minSpaceNode = node;
-    return cur;
+    return oldestHeartbeatNode != null ? oldestHeartbeatNode : minSpaceNode;

INS26 INS26 MOV23 INS40 INS40 INS23 INS23 INS83 INS83 INS39 INS59 INS29 INS83 INS39 INS59 MOV60 INS42 INS65 INS42 INS21 INS21 INS60 INS60 UPD45 INS32 INS66 INS7 INS7 INS39 INS59 INS43 INS59 INS16 INS32 INS42 INS22 INS27 INS22 INS32 INS42 INS27 UPD42 INS42 INS42 INS33 INS60 INS25 INS27 INS42 INS42 INS36 INS42 INS52 INS42 INS32 INS34 INS52 INS42 INS42 INS42 INS40 INS40 INS32 INS27 INS39 INS59 INS27 INS8 INS42 INS33 INS11 INS42 INS42 INS40 INS40 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS21 INS21 INS43 INS42 INS42 INS42 INS7 INS7 INS42 INS42 INS42 INS42 INS42 UPD42 DEL45 DEL45 DEL42