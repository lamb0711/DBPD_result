HDFS-8593. Calculation of effective layout version mishandles comparison to current layout version in storage. Contributed by Chris Nauroth.

-    if (isRollingUpgrade()) {
-      int storageLV = fsImage.getStorage().getLayoutVersion();
-      if (storageLV >=
-          NameNodeLayoutVersion.MINIMUM_COMPATIBLE_LAYOUT_VERSION) {
+    return getEffectiveLayoutVersion(isRollingUpgrade(),
+        fsImage.getStorage().getLayoutVersion(),
+        NameNodeLayoutVersion.MINIMUM_COMPATIBLE_LAYOUT_VERSION,
+        NameNodeLayoutVersion.CURRENT_LAYOUT_VERSION);
+  }
+
+  @VisibleForTesting
+  static int getEffectiveLayoutVersion(boolean isRollingUpgrade, int storageLV,
+      int minCompatLV, int currentLV) {
+    if (isRollingUpgrade) {
+      if (storageLV <= minCompatLV) {
-    return NameNodeLayoutVersion.CURRENT_LAYOUT_VERSION;
+    return currentLV;

INS31 INS8 INS78 INS83 INS39 INS42 INS44 INS44 INS44 INS44 MOV8 INS41 INS42 INS39 INS42 INS39 INS42 INS39 INS42 INS39 INS42 INS32 INS42 INS42 INS42 MOV32 MOV32 INS40 INS40 UPD27 INS42 DEL39 DEL42 DEL59 DEL60 DEL40 DEL40