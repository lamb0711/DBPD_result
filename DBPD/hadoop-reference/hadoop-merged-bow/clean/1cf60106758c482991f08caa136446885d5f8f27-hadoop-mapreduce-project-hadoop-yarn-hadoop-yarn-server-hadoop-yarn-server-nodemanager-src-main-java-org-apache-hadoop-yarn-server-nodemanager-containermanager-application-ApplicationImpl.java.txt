MAPREDUCE-4302. NM goes down if error encountered during log aggregation (Daryn Sharp via bobby)


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1345362 13f79535-47bb-0310-9956-ffa450edef68

+           .addTransition(ApplicationState.INITING, ApplicationState.INITING,
+               ApplicationEventType.APPLICATION_LOG_HANDLING_INITED,
+               new AppLogInitDoneTransition())
-   * In particular, this requests that the {@link ResourceLocalizationService}
-   * localize the application-scoped resources.
+   * In particular, this initializes the {@link LogAggregationService}
+      // Inform the logAggregator
+      app.dispatcher.getEventHandler().handle(
+          new LogHandlerAppStartedEvent(app.appId, app.user,
+              app.credentials, ContainerLogsRetentionPolicy.ALL_CONTAINERS,
+              app.applicationACLs)); 
+    }
+  }
+
+  /**
+   * Handles the APPLICATION_LOG_HANDLING_INITED event that occurs after
+   * {@link LogAggregationService} has created the directories for the app
+   * and started the aggregation thread for the app.
+   * 
+   * In particular, this requests that the {@link ResourceLocalizationService}
+   * localize the application-scoped resources.
+   */
+  @SuppressWarnings("unchecked")
+  static class AppLogInitDoneTransition implements
+      SingleArcTransition<ApplicationImpl, ApplicationEvent> {
+    @Override
+    public void transition(ApplicationImpl app, ApplicationEvent event) {
-
-      // Inform the logAggregator
-      app.dispatcher.getEventHandler().handle(
-          new LogHandlerAppStartedEvent(app.appId, app.user,
-              app.credentials, ContainerLogsRetentionPolicy.ALL_CONTAINERS,
-              app.applicationACLs)); 
-

INS83 INS42 INS55 INS29 INS79 INS83 INS42 INS74 INS31 INS65 INS42 INS45 INS43 INS43 INS43 INS78 INS83 INS39 INS42 INS44 INS44 INS8 UPD66 INS65 MOV21 INS66 INS65 INS66 INS66 INS66 MOV65 INS66 INS42 INS42 INS42 INS42 INS43 INS42 INS43 INS42 MOV21 INS42 INS42 INS42 INS42 INS32 INS42 INS40 MOV32 MOV42 MOV40 INS40 INS40 INS42 UPD40 MOV14 UPD40 UPD40 MOV14 UPD40 UPD40 INS14 INS43 INS42 DEL83 DEL42 DEL42 DEL66