YARN-4108. CapacityScheduler: Improve preemption to only kill containers that would satisfy the incoming request. (Wangda Tan)

(cherry picked from commit 7e8c9beb4156dcaeb3a11e60aaa06d2370626913)

+import java.util.ArrayList;
+import java.util.List;
+
-    assert Resources.greaterThan(
-        rc, clusterResource, available, Resources.none());
-
+    // Check if we need to kill some containers to allocate this one
+    List<RMContainer> toKillContainers = null;
+    if (availableContainers == 0 && currentResoureLimits.isAllowPreemption()) {
+      Resource availableAndKillable = Resources.clone(available);
+      for (RMContainer killableContainer : node
+          .getKillableContainers().values()) {
+        if (null == toKillContainers) {
+          toKillContainers = new ArrayList<>();
+        }
+        toKillContainers.add(killableContainer);
+        Resources.addTo(availableAndKillable,
+                        killableContainer.getAllocatedResource());
+        if (Resources.fitsIn(rc,
+                             clusterResource,
+                             capability,
+                             availableAndKillable)) {
+          // Stop if we find enough spaces
+          availableContainers = 1;
+          break;
+        }
+      }
+    }
+
+      result.setToKillContainers(toKillContainers);
-
+        result.setToKillContainers(null);
-      Resource clusterResource, FiCaSchedulerNode node,
-      SchedulingMode schedulingMode, Priority priority,
+      FiCaSchedulerNode node, Priority priority,
-      result =
-          doAllocation(result, clusterResource, node, schedulingMode, priority,
-              reservedContainer);
+      result = doAllocation(result, node, priority, reservedContainer);

INS26 INS26 INS40 INS40 INS60 INS25 INS74 INS59 INS27 INS8 INS43 INS43 INS42 INS33 INS27 INS32 INS60 INS70 INS21 INS42 INS42 INS42 INS34 INS42 INS42 INS43 INS59 INS44 INS32 INS8 INS32 INS42 INS42 INS32 INS43 INS42 INS32 UPD42 MOV42 INS25 INS21 INS21 INS25 INS42 INS42 INS42 INS21 MOV42 INS42 INS42 INS42 INS42 UPD42 MOV42 INS27 INS8 INS32 INS32 INS32 INS8 INS32 INS33 INS42 INS21 INS42 INS42 INS42 UPD42 MOV42 INS42 UPD42 MOV42 INS32 MOV42 INS42 INS42 UPD42 MOV42 INS42 INS42 INS21 INS10 INS42 INS42 INS33 INS7 INS42 INS42 INS7 INS42 INS14 INS42 INS34 INS74 INS43 INS42 DEL32 DEL32 DEL6 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL44 DEL42 DEL42