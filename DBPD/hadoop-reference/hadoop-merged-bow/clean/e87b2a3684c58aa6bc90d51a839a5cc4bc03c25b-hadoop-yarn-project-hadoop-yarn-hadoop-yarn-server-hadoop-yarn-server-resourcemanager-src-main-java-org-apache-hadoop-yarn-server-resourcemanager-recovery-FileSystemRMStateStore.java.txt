merge trunk into HDFS-4949 branch

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-4949@1535563 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.IOException;
+          if (checkAndRemovePartialRecord(childNodeStatus.getPath())) {
+            continue;
+          }
+  private boolean checkAndRemovePartialRecord(Path record) throws IOException {
+    // If the file ends with .tmp then it shows that it failed
+    // during saving state into state store. The file will be deleted as a
+    // part of this call
+    if (record.getName().endsWith(".tmp")) {
+      LOG.error("incomplete rm state store entry found :"
+          + record);
+      fs.delete(record, false);
+      return true;
+    }
+    return false;
+  }
+
+      if (checkAndRemovePartialRecord(childNodeStatus.getPath())) {
+        continue;
+      }
+  /*
+   * In order to make this write atomic as a part of write we will first write
+   * data to .tmp file and then rename it. Here we are assuming that rename is
+   * atomic for underlying file system.
+   */
-    FSDataOutputStream fsOut = fs.create(outputPath, false);
+    Path tempPath =
+        new Path(outputPath.getParent(), outputPath.getName() + ".tmp");
+    FSDataOutputStream fsOut = null;
+    fsOut = fs.create(tempPath, false);
+    fs.rename(tempPath, outputPath);

INS26 INS40 INS31 INS83 INS39 INS42 INS44 INS43 INS8 INS43 INS42 INS42 INS25 INS41 INS60 INS60 INS21 INS21 INS42 INS32 INS8 INS9 INS43 INS59 MOV43 INS59 INS7 INS32 INS32 INS42 INS45 INS21 INS21 INS41 INS25 INS42 INS42 INS14 MOV42 INS33 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS32 INS9 INS32 INS8 INS43 INS32 INS27 MOV42 MOV42 UPD42 MOV42 MOV9 INS42 INS42 INS27 INS42 INS42 INS42 INS9 INS42 INS32 INS18 INS42 INS42 INS42 INS32 INS45 INS45 INS42 INS42 INS42 INS42 INS42 INS25 INS32 INS8 INS42 INS32 INS18 INS42 INS42 DEL32 DEL59 DEL60