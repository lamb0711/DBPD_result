Merge r1550130 through r1555020 from trunk.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535@1555021 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Random;
+import com.google.common.annotations.VisibleForTesting;
-   * The block-id of the indexTh block
-   * @param index - the block whose block-id is desired
-   * @return the block-id
+   * Corrupt the generation stamp of the block with the given index.
+   * Not meant to be used outside of tests.
-  @Deprecated
-  public long getBlockId(final int index)  {
-    return blockId(index);
-  }
-  
-  /**
-   * The block-len of the indexTh block
-   * @param index - the block whose block-len is desired
-   * @return - the block-len
-   */
-  @Deprecated
-  public long getBlockLen(final int index)  {
-    return blockLength(index);
+  @VisibleForTesting
+  public long corruptBlockGSForTesting(final int blockIndex, Random rand) {
+    long oldGS = blockList[index2BlockId(blockIndex) + 2];
+    while (blockList[index2BlockId(blockIndex) + 2] == oldGS) {
+      blockList[index2BlockId(blockIndex) + 2] = rand.nextInt();
+    }
+    return oldGS;
-   * The generation stamp of the indexTh block
-   * @param index - the block whose block-len is desired
-   * @return - the generation stamp
+   * Corrupt the length of the block with the given index by truncation.
+   * Not meant to be used outside of tests.
-  @Deprecated
-  public long getBlockGenStamp(final int index)  {
-    return blockGenerationStamp(index);
+  @VisibleForTesting
+  public long corruptBlockLengthForTesting(final int blockIndex, Random rand) {
+    long oldLength = blockList[index2BlockId(blockIndex) + 1];
+    blockList[index2BlockId(blockIndex) + 1] =
+        rand.nextInt((int) oldLength - 1);
+    return oldLength;

INS26 INS26 INS40 INS40 INS31 MOV29 MOV78 MOV83 MOV39 UPD42 MOV42 MOV44 INS44 INS8 UPD42 INS44 UPD42 UPD42 INS43 INS42 INS60 INS61 INS41 UPD42 UPD42 INS43 INS42 INS60 INS21 INS41 UPD66 INS66 INS42 INS39 INS59 INS27 INS8 INS42 UPD66 INS66 INS42 INS39 INS59 INS7 INS42 INS42 INS2 INS2 INS42 INS21 INS42 INS2 INS2 INS32 INS42 INS27 INS42 INS27 INS7 INS42 INS27 INS42 INS27 INS42 INS42 INS27 INS32 INS34 INS32 INS34 INS2 INS32 INS32 INS34 INS32 INS34 INS11 INS34 UPD42 MOV42 UPD42 MOV42 INS42 INS42 INS42 INS27 INS42 INS42 UPD42 MOV42 UPD42 MOV42 INS42 INS42 INS39 INS42 INS32 INS34 UPD42 MOV42 UPD42 MOV42 DEL42 DEL66 DEL65 DEL66 DEL65 DEL32 DEL41 DEL8 DEL31 DEL66 DEL65 DEL42 DEL66 DEL65 DEL66 DEL65 DEL29 DEL42 DEL78 DEL83 DEL39 DEL42 DEL83 DEL39 DEL42 DEL44 DEL32 DEL41 DEL8 DEL31 DEL42 DEL66 DEL65 DEL66 DEL65 DEL32 DEL41