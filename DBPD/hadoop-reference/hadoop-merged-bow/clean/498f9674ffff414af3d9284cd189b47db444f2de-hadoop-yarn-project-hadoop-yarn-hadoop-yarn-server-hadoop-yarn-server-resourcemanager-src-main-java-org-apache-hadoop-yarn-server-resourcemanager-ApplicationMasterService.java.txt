Merge r1550130 through r1555020 from trunk.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535@1555021 13f79535-47bb-0310-9956-ffa450edef68

-      rmContext.getDispatcher().getEventHandler().handle(
+      RMApp rmApp =
+          rmContext.getRMApps().get(applicationAttemptId.getApplicationId());
+
+      if (rmApp.getApplicationSubmissionContext().getUnmanagedAM()) {
+        // No recovery supported yet for unmanaged AM. Send the unregister event
+        // and (falsely) acknowledge state-store write immediately.
+        rmContext.getDispatcher().getEventHandler().handle(
+        return FinishApplicationMasterResponse.newInstance(true);
+      }
-      if (rmContext.getRMApps().get(applicationAttemptId.getApplicationId())
-          .isAppSafeToUnregister()) {
+      // Not an unmanaged-AM.
+      if (rmApp.isAppSafeToTerminate()) {
+        // keep sending the unregister event as RM may crash in the meanwhile.
+        rmContext.getDispatcher().getEventHandler().handle(
+          new RMAppAttemptUnregistrationEvent(applicationAttemptId, request
+              .getTrackingUrl(), request.getFinalApplicationStatus(), request
+              .getDiagnostics()));

INS8 MOV21 INS60 INS25 INS25 INS43 INS59 INS32 INS8 INS32 MOV8 MOV8 INS42 INS42 MOV32 INS32 INS42 INS21 INS41 INS42 INS42 MOV41 INS42 INS42 INS32 INS32 INS32 INS42 INS14 INS42 INS42 INS9 INS32 INS42 INS43 INS42 INS32 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL42 DEL32 DEL8 DEL25