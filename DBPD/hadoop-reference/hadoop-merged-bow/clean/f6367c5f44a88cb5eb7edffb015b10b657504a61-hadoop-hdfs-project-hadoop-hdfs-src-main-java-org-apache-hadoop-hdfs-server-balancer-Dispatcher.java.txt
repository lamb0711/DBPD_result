HDFS-11015. Enforce timeout in balancer. Contributed by Kihwal Lee.

+  private final long blockMoveTimeout;
+        // Set read timeout so that it doesn't hang forever against
+        // unresponsive nodes. Datanode normally sends IN_PROGRESS response
+        // twice within the client read timeout period (every 30 seconds by
+        // default). Here, we make it give up after 5 minutes of no response.
+        sock.setSoTimeout(HdfsConstants.READ_TIMEOUT * 5);
+    /** Check whether to continue waiting for response */
+    private boolean stopWaitingForResponse(long startTime) {
+      return source.isIterationOver() ||
+          (blockMoveTimeout > 0 &&
+          (Time.monotonicNow() - startTime > blockMoveTimeout));
+    }
+
+      long startTime = Time.monotonicNow();
+        // Stop waiting for slow block moves. Even if it stops waiting,
+        // the actual move may continue.
+        if (stopWaitingForResponse(startTime)) {
+          throw new IOException("Block move timed out");
+        }
+    private final long startTime = Time.monotonicNow();
+    /**
+     * Check if the iteration is over
+     */
+    public boolean isIterationOver() {
+      return (Time.monotonicNow()-startTime > MAX_ITERATION_TIME);
+    }
+
-      final long startTime = Time.monotonicNow();
-      boolean isTimeUp = false;
-      while (!isTimeUp && getScheduledSize() > 0
+      while (getScheduledSize() > 0 && !isIterationOver()
-        // check if time is up or not
-        if (Time.monotonicNow() - startTime > MAX_ITERATION_TIME) {
-          LOG.info("Time up (max time=" + MAX_ITERATION_TIME/1000
-              + " seconds).  Skipping " + this);
-          isTimeUp = true;
-          continue;
-        }
+
+      if (isIterationOver()) {
+        LOG.info("The maximum iteration time (" + MAX_ITERATION_TIME/1000
+            + " seconds) has been reached. Stopping " + this);
+      }
-        0L, 0L, conf);
+        0L, 0L, 0,  conf);
-      long getBlocksSize, long getBlocksMinBlockSize, Configuration conf) {
+      long getBlocksSize, long getBlocksMinBlockSize,
+      int blockMoveTimeout, Configuration conf) {
+    this.blockMoveTimeout = blockMoveTimeout;

INS23 INS83 INS83 INS39 INS59 INS31 INS23 INS31 INS44 INS42 INS29 INS83 INS39 INS42 INS44 INS8 INS83 INS83 INS39 MOV59 INS29 INS83 INS39 INS42 INS8 INS39 INS42 INS21 INS65 INS39 INS42 INS41 INS60 INS65 INS41 MOV25 INS34 INS7 INS66 INS27 INS39 INS59 INS66 INS36 INS32 INS22 INS42 INS21 INS32 INS36 INS42 INS32 INS25 MOV27 MOV38 INS42 INS52 INS42 INS32 INS42 INS42 INS27 INS42 INS42 INS32 INS8 INS42 INS42 INS27 INS27 INS36 INS42 INS42 INS53 INS32 INS40 INS34 INS42 INS34 INS27 INS14 INS42 INS27 INS42 INS43 INS45 UPD45 INS32 INS42 INS42 UPD45 INS42 INS42 DEL83 DEL39 DEL60 DEL39 DEL42 DEL9 DEL59 DEL60 DEL42 DEL42 DEL9 DEL7 DEL21 DEL18