HDFS-11708. Positional read will fail if replicas moved to different DNs after stream is opened. Contributed by Vinayakumar B.

+      // Latest block if refreshed by chooseDatanode()
+      targetBlock = retval.block;
-    return new DNAddrPair(chosenNode, targetAddr, storageType);
+    return new DNAddrPair(chosenNode, targetAddr, storageType, block);
-    block = refreshLocatedBlock(block);
+      // Latest block, if refreshed internally
+      block = addressPair.block;
-        actualGetFromOneDataNode(addressPair, block, start, end,
-            buf, corruptedBlocks);
+        actualGetFromOneDataNode(addressPair, start, end, buf,
+            corruptedBlocks);
-          actualGetFromOneDataNode(datanode, block, start, end, bb,
-              corruptedBlocks);
+          actualGetFromOneDataNode(datanode, start, end, bb, corruptedBlocks);
-   * @param block             the located block containing the requested data
-  void actualGetFromOneDataNode(final DNAddrPair datanode, LocatedBlock block,
-      final long startInBlk, final long endInBlk, ByteBuffer buf,
-                                CorruptedBlocks corruptedBlocks)
+  void actualGetFromOneDataNode(final DNAddrPair datanode, final long startInBlk,
+      final long endInBlk, ByteBuffer buf, CorruptedBlocks corruptedBlocks)
-
+    LocatedBlock block = datanode.block;
-      // cached block locations may have been updated by chooseDataNode()
-      // or fetchBlockAt(). Always get the latest list of locations at the
-      // start of the loop.
-      block = refreshLocatedBlock(block);
+        // Refresh the block for updated tokens in case of token failures or
+        // encryption key failures.
+        block = refreshLocatedBlock(block);
-    block = refreshLocatedBlock(block);
+        // Latest block, if refreshed internally
+        block = chosenNode.block;
+          // Latest block, if refreshed internally
+          block = chosenNode.block;
+    final LocatedBlock block;
-        StorageType storageType) {
+        StorageType storageType, LocatedBlock block) {
+      this.block = block;

INS23 INS60 INS83 INS43 INS59 MOV44 INS43 INS59 INS42 INS42 INS21 INS21 INS42 INS21 INS42 INS42 INS40 INS7 INS7 INS7 INS22 INS42 INS42 INS40 INS42 INS40 INS21 INS52 INS42 MOV21 INS7 INS42 INS40 INS21 INS7 INS42 INS40 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL42 DEL42 DEL42 DEL66 DEL65 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21