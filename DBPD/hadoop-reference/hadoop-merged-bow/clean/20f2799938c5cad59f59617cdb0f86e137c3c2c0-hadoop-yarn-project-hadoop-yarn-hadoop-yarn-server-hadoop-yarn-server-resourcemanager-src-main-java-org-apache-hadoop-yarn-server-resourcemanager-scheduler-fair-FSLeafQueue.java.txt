YARN-5077. Fix FSLeafQueue#getFairShare() for queues with zero fairshare. (Yufei Gu via kasha)

-import org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.policies.DominantResourceFairnessPolicy;
-   * maxAMShare limit. For FIFO and FAIR policies, check if the VCore usage
-   * takes up the entire cluster or maxResources for the queue.
+   * maxAMShare limit.
-    Resource maxAMResource = Resources.multiply(getFairShare(), maxAMShare);
-    Resource ifRunAMResource = Resources.add(amResourceUsage, amResource);
-    boolean overMaxAMShareLimit = policy
-            .checkIfAMResourceUsageOverLimit(ifRunAMResource, maxAMResource);
-
-    // For fair policy and fifo policy which doesn't check VCore usages,
-    // additionally check if the AM takes all available VCores or
-    // over maxResource to avoid deadlock.
-    if (!overMaxAMShareLimit && !policy.equals(
-        SchedulingPolicy.getInstance(DominantResourceFairnessPolicy.class))) {
-      overMaxAMShareLimit =
-         isVCoresOverMaxResource(ifRunAMResource.getVirtualCores()) ||
-         ifRunAMResource.getVirtualCores() >=
-         scheduler.getRootQueueMetrics().getAvailableVirtualCores();
+    // If FairShare is zero, use min(maxShare, available resource) to compute
+    // maxAMResource
+    Resource maxResource = Resources.clone(getFairShare());
+    if (maxResource.getMemorySize() == 0) {
+      maxResource.setMemory(
+          Math.min(scheduler.getRootQueueMetrics().getAvailableMB(),
+                   getMaxShare().getMemorySize()));
-    return !overMaxAMShareLimit;
+    if (maxResource.getVirtualCoresSize() == 0) {
+      maxResource.setVirtualCores(Math.min(
+          scheduler.getRootQueueMetrics().getAvailableVirtualCores(),
+          getMaxShare().getVirtualCoresSize()));
+    }
+
+    Resource maxAMResource = Resources.multiply(maxResource, maxAMShare);
+    Resource ifRunAMResource = Resources.add(amResourceUsage, amResource);
+    return Resources.fitsIn(ifRunAMResource, maxAMResource);

INS25 INS25 INS60 UPD66 INS27 INS8 INS27 INS8 INS43 INS59 INS32 UPD42 MOV32 INS32 INS34 INS21 INS32 INS34 INS21 INS42 INS42 INS32 INS42 INS42 INS42 INS42 UPD42 UPD42 MOV42 UPD42 MOV42 INS32 INS42 INS42 INS32 INS42 INS42 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 INS42 INS32 UPD42 MOV42 INS42 INS32 UPD42 MOV42 UPD42 MOV42 MOV32 INS32 INS42 INS42 MOV32 MOV32 INS32 INS42 INS32 INS42 INS32 UPD42 UPD42 MOV42 UPD42 MOV42 INS42 UPD42 MOV42 DEL40 DEL26 DEL66 DEL42 DEL42 DEL43 DEL57 DEL39 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL38 DEL32 DEL38 DEL27 DEL42 DEL32 DEL32 DEL27 DEL27 DEL7 DEL21 DEL8 DEL25 DEL42 DEL38