HDDS-369. Remove the containers of a dead node from the container state map. Contributed by Elek, Marton

- *
- *     http://www.apache.org/licenses/LICENSE-2.0
- *
+ * <p>
+ * http://www.apache.org/licenses/LICENSE-2.0
+ * <p>
+import java.util.Set;
+
+import org.apache.hadoop.hdds.scm.container.ContainerID;
+import org.apache.hadoop.hdds.scm.container.ContainerStateManager;
+import org.apache.hadoop.hdds.scm.exceptions.SCMException;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
-  public DeadNodeHandler(Node2ContainerMap node2ContainerMap) {
+  private final ContainerStateManager containerStateManager;
+
+  private static final Logger LOG =
+      LoggerFactory.getLogger(DeadNodeHandler.class);
+
+  public DeadNodeHandler(
+      Node2ContainerMap node2ContainerMap,
+      ContainerStateManager containerStateManager) {
+    this.containerStateManager = containerStateManager;
-                        EventPublisher publisher) {
-    //TODO: add logic to handle dead node.
+      EventPublisher publisher) {
+    Set<ContainerID> containers =
+        node2ContainerMap.getContainers(datanodeDetails.getUuid());
+    LOG.info(
+        "Datanode {}  is dead. Removing replications from the in-memory state.",
+        datanodeDetails.getUuid());
+    for (ContainerID container : containers) {
+      try {
+        containerStateManager.removeContainerReplica(container,
+            datanodeDetails);
+      } catch (SCMException e) {
+        LOG.error("Can't remove container from containerStateMap {}", container
+            .getId(), e);
+      }
+    }

INS26 INS26 INS26 INS26 INS26 INS26 INS40 INS40 INS40 INS40 INS40 INS40 INS23 INS23 INS83 INS83 INS43 INS59 INS83 INS83 INS83 INS43 INS59 INS44 INS8 INS66 INS66 INS42 INS42 INS42 INS42 INS32 INS43 INS42 INS21 INS60 INS21 INS70 INS42 INS42 INS57 INS42 INS7 INS74 INS59 INS32 INS44 INS42 INS8 INS43 INS22 INS42 INS43 INS43 INS42 INS32 INS42 INS42 INS45 INS32 INS43 INS42 INS54 INS42 INS52 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS8 INS12 INS42 INS42 INS21 INS44 INS8 INS32 INS43 INS42 INS21 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS45 INS32 INS42 INS42 INS42 DEL8