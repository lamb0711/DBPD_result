HDFS-6710. Change BlockPlacementPolicy to consider block storage policy in replica deletion.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-6584@1612265 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.Iterator;
-    final List<StorageType> storageTypes = chooseStorageTypes(storagePolicy,
-        (short)totalReplicasExpected, results); 
+    final List<StorageType> storageTypes = storagePolicy.chooseStorageTypes(
+        (short)totalReplicasExpected, DatanodeStorageInfo.toStorageTypes(results));
-  
-  private static List<StorageType> chooseStorageTypes(
-      final BlockStoragePolicy storagePolicy, final short replication,
-      final Iterable<DatanodeStorageInfo> chosen) {
-    return storagePolicy.chooseStorageTypes(
-        replication, new Iterable<StorageType>() {
-          @Override
-          public Iterator<StorageType> iterator() {
-            return new Iterator<StorageType>() {
-              final Iterator<DatanodeStorageInfo> i = chosen.iterator();
-              @Override
-              public boolean hasNext() {return i.hasNext();}
-              @Override
-              public StorageType next() {return i.next().getStorageType();}
-              @Override
-              public void remove() {
-                throw new UnsupportedOperationException();
-              }
-            };
-          }
-        });
-  }
-      Collection<DatanodeStorageInfo> second) {
+      Collection<DatanodeStorageInfo> second,
+      final List<StorageType> excessTypes) {
+      if (!excessTypes.contains(storage.getStorageType())) {
+        continue;
+      }
+
-
-    return oldestHeartbeatStorage != null? oldestHeartbeatStorage
-        : minSpaceStorage;
+    final DatanodeStorageInfo storage = oldestHeartbeatStorage != null?
+        oldestHeartbeatStorage : minSpaceStorage;
+    excessTypes.remove(storage.getStorageType());
+    return storage;

INS44 INS83 MOV74 INS42 INS60 INS21 INS83 MOV43 INS59 INS32 INS42 INS25 INS42 MOV16 INS42 INS42 INS32 INS42 INS32 INS38 INS8 INS42 INS42 INS42 UPD42 MOV42 MOV42 INS32 INS18 INS42 INS42 INS32 INS42 INS42 DEL40 DEL26 DEL83 DEL83 DEL42 DEL83 DEL42 DEL43 DEL42 DEL44 DEL83 DEL39 DEL42 DEL44 DEL83 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL44 DEL42 DEL42 DEL42 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL78 DEL83 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL42 DEL43 DEL42 DEL43 DEL74 DEL83 DEL42 DEL43 DEL74 DEL42 DEL42 DEL42 DEL32 DEL59 DEL23 DEL42 DEL78 DEL83 DEL39 DEL42 DEL42 DEL42 DEL32 DEL41 DEL8 DEL31 DEL42 DEL78 DEL83 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL41 DEL8 DEL31 DEL42 DEL78 DEL83 DEL39 DEL42 DEL42 DEL43 DEL14 DEL53 DEL8 DEL31 DEL1 DEL14 DEL41 DEL8 DEL31 DEL1 DEL14 DEL32 DEL41 DEL8 DEL31