Merge trunk into HA branch.
Some conflicts around TestBlockRecovery: mocking changed for new heartbeat types/responses


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1243691 13f79535-47bb-0310-9956-ffa450edef68

+  /**
+   * Connect to the NN. This is separated out for easier testing.
+   */
+  DatanodeProtocolClientSideTranslatorPB connectToNN(
+      InetSocketAddress nnAddr) throws IOException {
+    return new DatanodeProtocolClientSideTranslatorPB(nnAddr, conf);
+  }
+
-      throw new IOException("cannot find a namnode proxy for bpid=" + bpid);
+      throw new IOException("No block pool offer service for bpid=" + bpid);
-    return bpos.getActiveNN();
+    
+    DatanodeProtocolClientSideTranslatorPB activeNN = bpos.getActiveNN();
+    if (activeNN == null) {
+      throw new IOException(
+          "Block pool " + bpid + " has not recognized an active NN");
+    }
+    return activeNN;
+    assert nn != null;
-

INS31 INS29 INS43 INS42 INS44 INS43 INS8 INS65 INS42 INS43 INS42 INS42 INS41 INS60 INS25 INS6 INS66 INS42 INS14 INS43 INS59 INS27 INS8 INS42 INS27 INS43 INS42 INS42 INS42 INS42 MOV32 INS42 INS33 INS53 INS42 INS33 INS42 INS14 INS43 INS27 UPD45 INS42 INS45 INS42 INS45