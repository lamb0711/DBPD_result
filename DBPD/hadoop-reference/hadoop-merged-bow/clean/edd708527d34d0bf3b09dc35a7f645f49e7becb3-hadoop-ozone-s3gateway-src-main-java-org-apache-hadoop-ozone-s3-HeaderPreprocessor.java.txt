HDDS-1948. S3 MPU can't be created with octet-stream content-type  (#1266)


+import javax.annotation.Priority;
+import javax.ws.rs.core.MultivaluedMap;
+ *
+ * It should be executed AFTER signature check (VirtualHostStyleFilter) as the
+ * original Content-Type could be part of the base of the signature.
-
+@Priority(VirtualHostStyleFilter.PRIORITY
+    + S3GatewayHttpServer.FILTER_PRIORITY_DO_AFTER)
+  public static final String MULTIPART_UPLOAD_MARKER = "ozone/mpu";
+
-    if (requestContext.getUriInfo().getQueryParameters()
-        .containsKey("delete")) {
+    MultivaluedMap<String, String> queryParameters =
+        requestContext.getUriInfo().getQueryParameters();
+
+    if (queryParameters.containsKey("delete")) {
-    if (requestContext.getUriInfo().getQueryParameters()
-        .containsKey("uploadId")) {
+    if (queryParameters.containsKey("uploadId")) {
+    } else if (queryParameters.containsKey("uploads")) {
+      // uploads defined but uploadId is not --> this is the creation of the
+      // multi-part-upload requests.
+      //
+      //In  AWS SDK for go uses application/octet-stream which also
+      //should be fixed to route the request to the right jaxrs method.
+      //
+      //Should be empty instead of XML as the body is empty which can not be
+      //serialized as as CompleteMultipartUploadRequest
+      requestContext.getHeaders()
+          .putSingle("Content-Type", MULTIPART_UPLOAD_MARKER);
+

INS26 INS26 INS40 INS40 INS79 INS23 INS42 INS27 INS83 INS83 INS83 INS43 INS59 MOV25 INS66 INS66 INS40 INS40 INS42 INS42 INS45 INS60 INS74 INS59 INS32 INS25 INS43 INS43 INS43 INS42 MOV32 INS42 UPD45 UPD42 MOV42 UPD42 MOV42 INS45 INS32 INS8 INS42 INS42 INS42 UPD42 MOV42 MOV42 INS45 INS21 INS32 INS32 INS42 UPD45 MOV45 INS42 INS42 INS42 DEL32 DEL32 DEL32