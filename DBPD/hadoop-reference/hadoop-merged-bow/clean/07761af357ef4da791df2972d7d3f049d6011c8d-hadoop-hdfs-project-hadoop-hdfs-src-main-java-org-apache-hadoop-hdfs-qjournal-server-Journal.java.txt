HDFS-11448. JN log segment syncing should support HA upgrade. Contributed by Hanisha Koneru.

+import java.nio.file.Files;
+import java.nio.file.StandardCopyOption;
-  synchronized boolean renameTmpSegment(File tmpFile, File finalFile,
+  synchronized boolean moveTmpSegmentToCurrent(File tmpFile, File finalFile,
-      success = tmpFile.renameTo(finalFile);
-      if (!success) {
-        LOG.warn("Unable to rename edits file from " + tmpFile + " to " +
+      if (!finalFile.getParentFile().exists()) {
+        LOG.error(finalFile.getParentFile() + " doesn't exist. Aborting tmp " +
+            "segment move to current directory");
+        return false;
+      }
+      Files.move(tmpFile.toPath(), finalFile.toPath(),
+          StandardCopyOption.ATOMIC_MOVE);
+      if (finalFile.exists() && FileUtil.canRead(finalFile)) {
+        success = true;
+      } else {
+        success = false;
+        LOG.warn("Unable to move edits file from " + tmpFile + " to " +
-          "last committed transaction id. Aborting renaming to final file" +
+          "last committed transaction id. Aborting move to final file" +

INS26 INS26 INS40 INS40 UPD42 INS25 INS21 INS38 INS8 INS32 INS27 INS8 INS7 INS32 INS21 INS41 INS42 INS42 INS32 INS32 INS40 INS32 INS32 INS21 MOV21 INS42 INS9 INS32 INS42 INS32 INS9 MOV42 UPD42 MOV42 MOV42 INS42 INS42 INS42 INS42 INS42 INS42 INS7 UPD45 INS42 INS42 INS42 INS42 INS27 INS42 INS9 INS32 INS45 INS45 UPD45 INS42 INS42 DEL42 DEL32 DEL7 DEL42 DEL38