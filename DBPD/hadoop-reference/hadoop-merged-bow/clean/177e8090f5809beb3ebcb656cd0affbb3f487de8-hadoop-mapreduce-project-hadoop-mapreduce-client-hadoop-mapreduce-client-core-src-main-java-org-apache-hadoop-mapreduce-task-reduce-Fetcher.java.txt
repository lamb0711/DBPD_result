MAPREDUCE-6156. Fetcher - connect() doesn't handle connection refused correctly. Contributed by Junping Du

-              + fetchRetryTimeout + "milliseconds.");
+              + fetchRetryTimeout + " milliseconds.");
-          + "after " + fetchRetryTimeout + "milliseconds.");
+          + "after " + fetchRetryTimeout + " milliseconds.");
+    long startTime = Time.monotonicNow();
+    long lastTime = startTime;
+    int attempts = 0;
+        attempts++;
-        // update the total remaining connect-timeout
-        connectionTimeout -= unit;
-
+        long currentTime = Time.monotonicNow();
+        long retryTime = currentTime - startTime;
+        long leftTime = connectionTimeout - retryTime;
+        long timeSinceLastIteration = currentTime - lastTime;
-        if (connectionTimeout == 0) {
+        if (leftTime <= 0) {
+          int retryTimeInSeconds = (int) retryTime/1000;
+          LOG.error("Connection retry failed with " + attempts + 
+              " attempts in " + retryTimeInSeconds + " seconds");
-
-        if (connectionTimeout < unit) {
-          unit = connectionTimeout;
+        if (leftTime < unit) {
+          unit = (int)leftTime;
+        
+        if (timeSinceLastIteration < unit) {
+          try {
+            // sleep the left time of unit
+            sleep(unit - timeSinceLastIteration);
+          } catch (InterruptedException e) {
+            LOG.warn("Sleep in connection retry get interrupted.");
+            if (stopped) {
+              return;
+            }
+          }
+        }
+        // update the total remaining connect-timeout
+        lastTime = Time.monotonicNow();

INS60 INS60 INS60 INS39 INS59 INS39 INS59 INS39 INS59 INS42 INS32 INS42 INS42 INS42 INS34 INS42 INS42 INS21 UPD45 INS37 INS60 INS60 INS60 INS60 INS25 INS21 INS42 INS39 INS59 INS39 INS59 INS39 INS59 INS39 INS59 UPD27 INS27 INS8 INS7 INS42 INS32 INS42 INS27 INS42 INS27 INS42 INS27 UPD42 INS60 INS21 UPD42 INS42 INS42 INS54 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS39 INS59 INS32 INS8 INS12 INS42 INS42 INS42 INS27 INS42 INS42 INS27 INS11 INS21 INS44 INS8 UPD45 INS11 INS34 INS45 INS42 INS45 INS42 INS45 INS39 INS42 INS32 INS43 INS42 INS21 INS25 INS39 INS42 INS42 INS27 INS42 INS32 INS42 INS8 INS42 INS42 INS42 INS42 INS45 INS41 DEL42 DEL42 DEL7 DEL21 DEL42