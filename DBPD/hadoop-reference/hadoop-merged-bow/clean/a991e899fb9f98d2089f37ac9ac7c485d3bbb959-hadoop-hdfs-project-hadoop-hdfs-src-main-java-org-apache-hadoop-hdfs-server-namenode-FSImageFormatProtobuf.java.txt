HDFS-13314. NameNode should optionally exit if it detects FsImage corruption. Contributed by Arpit Agarwal.

-    void save(File file, FSImageCompression compression) throws IOException {
+    /**
+     * @return number of non-fatal errors detected while writing the image.
+     * @throws IOException on fatal error.
+     */
+    long save(File file, FSImageCompression compression) throws IOException {
-        saveInternal(fout, compression, file.getAbsolutePath());
-        LOG.info("Image file {} of size {} bytes saved in {} seconds.", file,
-            file.length(), (monotonicNow() - startTime) / 1000);
+        long numErrors = saveInternal(
+            fout, compression, file.getAbsolutePath());
+        LOG.info("Image file {} of size {} bytes saved in {} seconds {}.", file,
+            file.length(), (monotonicNow() - startTime) / 1000,
+            (numErrors > 0 ? (" with" + numErrors + " errors") : ""));
+        return numErrors;
-    private void saveSnapshots(FileSummary.Builder summary) throws IOException {
+    /**
+     * @return number of non-fatal errors detected while saving the image.
+     * @throws IOException on fatal error.
+     */
+    private long saveSnapshots(FileSummary.Builder summary) throws IOException {
+      return snapshotSaver.getNumImageErrors();
-    private void saveInternal(FileOutputStream fout,
+    /**
+     * @return number of non-fatal errors detected while writing the FsImage.
+     * @throws IOException on fatal error.
+     */
+    private long saveInternal(FileOutputStream fout,
-      saveSnapshots(b);
+      long numErrors = saveSnapshots(b);
+      return numErrors;

INS29 UPD39 INS29 UPD39 INS29 UPD39 INS65 INS65 INS65 INS65 INS41 INS65 INS65 INS60 INS41 INS66 INS42 INS66 INS66 INS42 INS66 INS32 INS66 INS42 INS66 INS39 INS59 INS42 INS60 INS41 INS42 INS42 INS42 MOV32 INS39 INS59 INS42 INS42 MOV32 UPD45 INS36 INS16 INS27 INS36 INS45 INS42 INS34 INS27 INS45 INS42 INS45 DEL21 DEL21