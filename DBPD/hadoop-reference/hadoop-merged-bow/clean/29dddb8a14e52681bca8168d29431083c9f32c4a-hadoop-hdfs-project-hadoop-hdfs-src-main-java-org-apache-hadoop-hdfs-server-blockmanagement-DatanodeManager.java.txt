HDFS-15255. Consider StorageType when DatanodeManager#sortLocatedBlock(). Contributed by Lisheng Sun.

+  /** Whether or not to consider storageType for reading. */
+  private final boolean readConsiderStorageType;
+
+    this.readConsiderStorageType = conf.getBoolean(
+        DFSConfigKeys.DFS_NAMENODE_READ_CONSIDERSTORAGETYPE_KEY,
+        DFSConfigKeys.DFS_NAMENODE_READ_CONSIDERSTORAGETYPE_DEFAULT);
+    LOG.warn(
+        "{} and {} are incompatible and only one can be enabled. "
+            + "Both are currently enabled.",
+        DFSConfigKeys.DFS_NAMENODE_READ_CONSIDERLOAD_KEY,
+        DFSConfigKeys.DFS_NAMENODE_READ_CONSIDERSTORAGETYPE_KEY);
+
-    DatanodeInfo[] di = lb.getLocations();
+    DatanodeInfoWithStorage[] di = lb.getLocations();
-  private Consumer<List<DatanodeInfo>> createSecondaryNodeSorter() {
-    Consumer<List<DatanodeInfo>> secondarySort = null;
+  private Consumer<List<DatanodeInfoWithStorage>> createSecondaryNodeSorter() {
+    Consumer<List<DatanodeInfoWithStorage>> secondarySort = null;
+    if (readConsiderStorageType) {
+      Comparator<DatanodeInfoWithStorage> comp =
+          Comparator.comparing(DatanodeInfoWithStorage::getStorageType);
+      secondarySort = list -> Collections.sort(list, comp);
+    }
-      Comparator<DatanodeInfo> comp =
+      Comparator<DatanodeInfoWithStorage> comp =

INS23 INS29 INS83 INS83 INS39 INS59 UPD74 MOV74 INS65 INS42 INS21 INS21 UPD74 INS60 INS25 INS66 INS7 INS32 UPD5 UPD43 UPD74 MOV74 MOV59 INS42 INS8 INS22 INS32 INS42 INS42 INS27 INS40 INS40 UPD43 UPD42 UPD74 MOV60 INS21 INS52 INS42 INS42 INS42 INS40 INS40 INS45 INS45 UPD42 UPD43 UPD74 MOV74 INS59 INS7 INS74 UPD42 UPD43 INS42 INS32 INS42 INS86 INS43 INS43 UPD42 INS42 INS42 INS90 INS59 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42