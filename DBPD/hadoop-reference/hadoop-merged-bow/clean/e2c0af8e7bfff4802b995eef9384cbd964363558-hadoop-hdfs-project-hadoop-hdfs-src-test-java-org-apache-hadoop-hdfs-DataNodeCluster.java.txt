HDFS-5742. DatanodeCluster (mini cluster of DNs) fails to start. (Arpit Agarwal)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1570067 13f79535-47bb-0310-9956-ffa450edef68

-    " -n <numDataNodes> " + 
+    " -n <numDataNodes> " +
+    " -bpid <bpid>" +
-    " [-simulated] " +
+    " [-simulated [<simulatedCapacityPerDn>]] " +
-  public static void main(String[] args) {
+  public static void main(String[] args) throws InterruptedException {
+    long simulatedCapacityPerDn = SimulatedFSDataset.DEFAULT_CAPACITY;
+    String bpid = null;
-          printUsageExit("Missing replicaiton factor");
+          printUsageExit("Missing replication factor");
+        if ((i+1) < args.length && !args[i+1].startsWith("-")) {
+          simulatedCapacityPerDn = Long.parseLong(args[++i]);
+        }
+      } else if (args[i].equals("-bpid")) {
+        if (++i >= args.length || args[i].startsWith("-")) {
+          printUsageExit("Missing blockpoolid parameter");
+        }
+        bpid = args[i];
+    if (bpid == null) {
+      printUsageExit("BlockPoolId must be provided");
+    }
-  
+
+    long simulatedCapacities[] = new long[numDataNodes];
+    for (int i = 0; i < numDataNodes; ++i) {
+      simulatedCapacities[i] = simulatedCapacityPerDn;
+    }
+
-        
-        
-          rack4DataNode, null, null, false, checkDataNodeAddrConfig);
+          rack4DataNode, null, simulatedCapacities, false, checkDataNodeAddrConfig);
+      Thread.sleep(10*1000);   // Give the DN some time to connect to NN and init storage directories.
-            mc.injectBlocks((i_dn + i- 1)% numDataNodes, Arrays.asList(blocks));
+            mc.injectBlocks((i_dn + i- 1)% numDataNodes, Arrays.asList(blocks), bpid);

INS43 INS42 INS60 INS60 INS25 INS60 INS24 INS39 INS59 INS43 INS59 INS27 INS8 INS39 INS59 INS58 INS27 INS38 INS8 INS45 UPD45 INS42 INS40 INS42 INS42 INS33 INS42 INS33 INS21 INS42 INS85 INS3 INS39 INS59 INS42 INS42 INS42 INS21 INS21 INS32 INS5 INS42 INS42 INS34 INS7 INS32 INS42 INS45 INS39 INS85 INS2 INS42 INS42 INS42 INS42 INS27 INS42 INS42 INS34 INS34 INS25 MOV32 INS8 MOV25 MOV21 INS25 INS32 INS8 INS27 INS8 INS2 INS42 INS45 INS25 INS21 UPD45 INS27 INS38 INS21 INS42 INS42 INS27 MOV8 INS7 INS42 INS36 INS40 INS32 INS7 INS27 INS32 INS21 INS42 INS2 INS27 INS2 INS42 INS45 INS42 INS32 INS38 INS40 INS2 INS42 INS45 INS32 INS42 INS42 INS42 INS34 INS42 INS27 INS42 INS42 INS2 INS42 INS42 INS42 INS42 INS45 INS42 INS34 INS42 INS38 INS42 DEL33