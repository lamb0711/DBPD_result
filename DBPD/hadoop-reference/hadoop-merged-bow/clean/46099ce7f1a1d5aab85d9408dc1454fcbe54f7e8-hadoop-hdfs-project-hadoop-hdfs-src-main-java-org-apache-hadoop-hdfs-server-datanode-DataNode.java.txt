HDFS-4988. Datanode must support all the volumes as individual storages.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2832@1526969 13f79535-47bb-0310-9956-ffa450edef68

-               reason);
+                   reason);
-        getDatanodeUuid(), getXferPort(), getInfoPort(), getIpcPort());
+        storage.getDatanodeUuid(), getXferPort(), getInfoPort(), getIpcPort());
-    if (storage.getStorageID().equals("")) {
-      // This is a fresh datanode, persist the NN-provided storage ID
-      storage.setStorageID(bpRegistration.getDatanodeUuid());
+    if (storage.getDatanodeUuid() == null) {
+      // This is a fresh datanode, persist the NN-provided Datanode ID
+      storage.setDatanodeUuid(bpRegistration.getDatanodeUuid());
-      LOG.info("New storage id " + bpRegistration.getDatanodeUuid()
-          + " is assigned to data-node " + bpRegistration);
-    } else if(!storage.getStorageID().equals(bpRegistration.getDatanodeUuid())) {
-      throw new IOException("Inconsistent storage IDs. Name-node returned "
+      LOG.info("Datanode ID " + bpRegistration.getDatanodeUuid()
+          + " is assigned to new storage " + bpRegistration);
+    } else if(!storage.getDatanodeUuid().equals(bpRegistration.getDatanodeUuid())) {
+      throw new IOException("Inconsistent Datanode IDs. Name-node returned "
-          + ". Expecting " + storage.getStorageID());
+          + ". Expecting " + storage.getDatanodeUuid());
-  String getDatanodeUuid() {
-    return storage.getStorageID();
-  }
-
-  public static void setNewStorageID(DatanodeID dnId) {
-    LOG.info("Datanode is " + dnId);
-    dnId.setDatanodeUuid(DatanodeStorage.newStorageID());
-  }
-  
-        + "', storageID='" + getDatanodeUuid() + "', xmitsInProgress="
+        + "', datanodeUuid='" + storage.getDatanodeUuid() + "', xmitsInProgress="
-   * This method is used for testing. 
+  public String getDatanodeUuid() {
+    return id == null ? null : id.getDatanodeUuid();
+  }
+

INS31 INS83 MOV43 INS42 INS8 INS41 INS27 INS16 INS32 INS33 UPD45 INS27 INS33 INS32 MOV42 UPD42 MOV42 INS42 INS42 INS33 INS42 INS42 INS42 UPD42 UPD45 UPD45 UPD42 UPD45 UPD42 DEL32 DEL42 DEL45 DEL32 DEL42 DEL42 DEL42 DEL32 DEL41 DEL8 DEL31 DEL83 DEL83 DEL39 DEL42 DEL42 DEL43 DEL42 DEL44 DEL42 DEL42 DEL45 DEL42 DEL27 DEL32 DEL21 DEL42 DEL42 DEL42 DEL42 DEL32 DEL32 DEL21 DEL8 DEL31 DEL66