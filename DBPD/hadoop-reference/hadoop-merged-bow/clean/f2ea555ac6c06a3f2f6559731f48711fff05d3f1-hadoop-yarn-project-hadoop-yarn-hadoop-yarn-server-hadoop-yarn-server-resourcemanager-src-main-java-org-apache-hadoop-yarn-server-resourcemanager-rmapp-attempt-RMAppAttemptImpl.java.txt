YARN-2496. Enhanced Capacity Scheduler to have basic support for allocating resources based on node-labels. Contributed by Wangda Tan.
YARN-2500. Ehnaced ResourceManager to support schedulers allocating resources based on node-labels. Contributed by Wangda Tan.

-import org.apache.hadoop.yarn.server.utils.BuilderUtils;
+  private ResourceRequest amReq = null;
-      Configuration conf, boolean maybeLastAttempt) {
+      Configuration conf, boolean maybeLastAttempt, ResourceRequest amReq) {
+
+    
+    this.amReq = amReq;
-  private static final class ScheduleTransition
+  @VisibleForTesting
+  public static final class ScheduleTransition
-      if (!appAttempt.submissionContext.getUnmanagedAM()) {
-        // Request a container for the AM.
-        ResourceRequest request =
-            BuilderUtils.newResourceRequest(
-                AM_CONTAINER_PRIORITY, ResourceRequest.ANY, appAttempt
-                    .getSubmissionContext().getResource(), 1);
-
+      ApplicationSubmissionContext subCtx = appAttempt.submissionContext;
+      if (!subCtx.getUnmanagedAM()) {
+        // Need reset #containers before create new attempt, because this request
+        // will be passed to scheduler, and scheduler will deduct the number after
+        // AM container allocated
+        
+        // Currently, following fields are all hard code,
+        // TODO: change these fields when we want to support
+        // priority/resource-name/relax-locality specification for AM containers
+        // allocation.
+        appAttempt.amReq.setNumContainers(1);
+        appAttempt.amReq.setPriority(AM_CONTAINER_PRIORITY);
+        appAttempt.amReq.setResourceName(ResourceRequest.ANY);
+        appAttempt.amReq.setRelaxLocality(true);
+        
-        Allocation amContainerAllocation = appAttempt.scheduler.allocate(
-            appAttempt.applicationAttemptId,
-            Collections.singletonList(request), EMPTY_CONTAINER_RELEASE_LIST, null, null);
+        Allocation amContainerAllocation =
+            appAttempt.scheduler.allocate(appAttempt.applicationAttemptId,
+                Collections.singletonList(appAttempt.amReq),
+                EMPTY_CONTAINER_RELEASE_LIST, null, null);

INS23 INS83 INS43 INS59 INS44 INS78 UPD83 INS42 INS42 INS33 MOV43 INS42 INS21 INS42 INS7 INS60 INS22 INS42 INS43 INS59 INS52 INS42 INS42 INS42 INS40 INS21 INS21 INS21 INS21 INS42 INS32 INS32 INS32 INS32 INS40 INS42 INS34 INS40 INS42 UPD42 MOV42 INS40 UPD42 MOV42 MOV40 INS40 UPD42 MOV42 INS9 INS40 DEL40 DEL26 DEL40 DEL42 DEL42 DEL42 DEL42 DEL32 DEL32 DEL34 DEL32 DEL59 DEL60 DEL42