HDFS-7621. Erasure Coding: update the Balancer/Mover data migration logic. Contributed by Walter Su.

+import org.apache.hadoop.hdfs.server.protocol.BlocksWithLocations.StripedBlockWithLocations;
-   * return the length of the added block; 0 if the block is not added
+   * @return the length of the added block; 0 if the block is not added. If the
+   * added block is a block group, return its approximate internal block size
-  private long addBlock(Block block, List<BlockWithLocations> results) {
+  private long addBlock(BlockInfo block, List<BlockWithLocations> results) {
-      results.add(new BlockWithLocations(block, datanodeUuids, storageIDs,
-          storageTypes));
-      return block.getNumBytes();
+      BlockWithLocations blkWithLocs = new BlockWithLocations(block,
+          datanodeUuids, storageIDs, storageTypes);
+      if(block.isStriped()) {
+        BlockInfoStriped blockStriped = (BlockInfoStriped) block;
+        byte[] indices = new byte[locations.size()];
+        for (int i = 0; i < locations.size(); i++) {
+          indices[i] =
+              (byte) blockStriped.getStorageBlockIndex(locations.get(i));
+        }
+        results.add(new StripedBlockWithLocations(blkWithLocs, indices,
+            blockStriped.getDataBlockNum()));
+        // approximate size
+        return block.getNumBytes() / blockStriped.getDataBlockNum();
+      }else{
+        results.add(blkWithLocs);
+        return block.getNumBytes();
+      }

INS26 INS40 INS65 INS65 UPD43 MOV66 UPD66 MOV66 INS66 UPD42 INS60 INS25 INS43 INS59 INS32 INS8 INS8 INS42 INS42 MOV14 INS42 INS42 INS60 INS60 INS24 MOV21 INS41 INS21 MOV41 INS43 INS59 INS5 INS59 INS58 INS27 INS37 INS8 INS27 INS32 INS42 INS42 INS11 INS39 INS85 INS42 INS3 INS39 INS59 INS42 INS32 INS42 INS21 INS14 INS32 INS32 INS42 INS42 INS42 INS43 INS42 INS5 INS32 INS42 INS34 INS42 INS42 INS7 INS43 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS39 INS85 INS42 INS42 INS2 INS11 INS42 INS42 INS42 INS42 INS42 INS39 INS32 INS42 INS42 INS32 INS42 INS42 INS42 DEL65