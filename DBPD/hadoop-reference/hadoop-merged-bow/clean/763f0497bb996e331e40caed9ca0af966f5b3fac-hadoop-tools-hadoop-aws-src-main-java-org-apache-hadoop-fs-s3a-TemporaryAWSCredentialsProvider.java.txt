HADOOP-13252. Tune S3A provider plugin mechanism. Contributed by Steve Loughran.

+import java.io.IOException;
+import org.apache.hadoop.security.ProviderUtils;
+ *
+ * Please note that users may reference this class name from configuration
+ * property fs.s3a.aws.credentials.provider.  Therefore, changing the class name
+ * would be a backward-incompatible change.
-@InterfaceAudience.Private
+@InterfaceAudience.Public
-  private final String accessKey;
-  private final String secretKey;
-  private final String sessionToken;
+  private String accessKey;
+  private String secretKey;
+  private String sessionToken;
+  private IOException lookupIOE;
-    this.accessKey = conf.get(ACCESS_KEY, null);
-    this.secretKey = conf.get(SECRET_KEY, null);
-    this.sessionToken = conf.get(SESSION_TOKEN, null);
+    try {
+      Configuration c = ProviderUtils.excludeIncompatibleCredentialProviders(
+          conf, S3AFileSystem.class);
+      this.accessKey = S3AUtils.lookupPassword(c, ACCESS_KEY, null);
+      this.secretKey = S3AUtils.lookupPassword(c, SECRET_KEY, null);
+      this.sessionToken = S3AUtils.lookupPassword(c, SESSION_TOKEN, null);
+    } catch (IOException e) {
+      lookupIOE = e;
+    }
+    if (lookupIOE != null) {
+      // propagate any initialization problem
+      throw new CredentialInitializationException(lookupIOE.toString(),
+          lookupIOE);
+    }

INS26 INS26 INS40 INS40 INS23 UPD40 INS83 INS43 INS59 INS8 INS66 INS66 INS66 INS42 INS42 INS54 INS25 INS8 INS12 INS27 INS8 INS60 MOV21 MOV21 MOV21 INS44 INS8 INS42 INS33 INS53 INS43 INS59 INS43 INS42 INS21 INS14 INS42 INS42 INS32 INS42 INS7 INS43 INS32 INS42 INS42 INS42 INS42 INS57 UPD42 UPD42 INS42 UPD42 UPD42 INS42 UPD42 UPD42 INS42 INS42 INS42 INS42 INS42 INS42 INS43 INS42 DEL83 DEL83 DEL83 DEL8