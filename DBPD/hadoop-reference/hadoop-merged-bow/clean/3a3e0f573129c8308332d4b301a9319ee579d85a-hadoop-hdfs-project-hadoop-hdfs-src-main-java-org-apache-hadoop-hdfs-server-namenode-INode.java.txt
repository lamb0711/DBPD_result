HDFS-4760. Update inodeMap after node replacement.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1477827 13f79535-47bb-0310-9956-ffa450edef68

-  final INode setUser(String user, Snapshot latest)
+  final INode setUser(String user, Snapshot latest, INodeMap inodeMap)
-    final INode nodeToUpdate = recordModification(latest);
+    final INode nodeToUpdate = recordModification(latest, inodeMap);
-  final INode setGroup(String group, Snapshot latest)
+  final INode setGroup(String group, Snapshot latest, INodeMap inodeMap)
-    final INode nodeToUpdate = recordModification(latest);
+    final INode nodeToUpdate = recordModification(latest, inodeMap);
-  INode setPermission(FsPermission permission, Snapshot latest)
-      throws QuotaExceededException {
-    final INode nodeToUpdate = recordModification(latest);
+  INode setPermission(FsPermission permission, Snapshot latest,
+      INodeMap inodeMap) throws QuotaExceededException {
+    final INode nodeToUpdate = recordModification(latest, inodeMap);
+   * @param inodeMap while recording modification, the inode or its parent may 
+   *                 get replaced, and the inodeMap needs to be updated.
-  abstract INode recordModification(final Snapshot latest)
-      throws QuotaExceededException;
+  abstract INode recordModification(final Snapshot latest,
+      final INodeMap inodeMap) throws QuotaExceededException;
-  public abstract INode updateModificationTime(long mtime, Snapshot latest)
-      throws QuotaExceededException;
+  public abstract INode updateModificationTime(long mtime, Snapshot latest,
+      INodeMap inodeMap) throws QuotaExceededException;
-  public final INode setModificationTime(long modificationTime, Snapshot latest)
-      throws QuotaExceededException {
-    final INode nodeToUpdate = recordModification(latest);
+  public final INode setModificationTime(long modificationTime,
+      Snapshot latest, INodeMap inodeMap) throws QuotaExceededException {
+    final INode nodeToUpdate = recordModification(latest, inodeMap);
-  public final INode setAccessTime(long accessTime, Snapshot latest)
-      throws QuotaExceededException {
-    final INode nodeToUpdate = recordModification(latest);
+  public final INode setAccessTime(long accessTime, Snapshot latest,
+      INodeMap inodeMap) throws QuotaExceededException {
+    final INode nodeToUpdate = recordModification(latest, inodeMap);

INS44 INS44 INS44 INS44 INS44 INS44 INS44 INS43 INS42 INS43 INS42 INS43 INS42 INS65 INS83 INS43 INS42 INS43 INS42 INS43 INS42 INS43 INS42 INS42 INS42 INS42 INS42 INS66 INS66 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42