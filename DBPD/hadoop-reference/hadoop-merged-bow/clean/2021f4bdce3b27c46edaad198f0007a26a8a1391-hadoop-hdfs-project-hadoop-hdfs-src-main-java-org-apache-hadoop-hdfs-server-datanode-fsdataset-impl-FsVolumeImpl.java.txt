HDFS-11187. Optimize disk access for last partial chunk checksum of Finalized replica. Contributed by Wei-Chiu Chuang.

+import org.apache.hadoop.hdfs.server.datanode.FinalizedReplica;
+import org.apache.hadoop.hdfs.server.datanode.ReplicaBeingWritten;
+    byte[] checksum = null;
+    // copy the last partial checksum if the replica is originally
+    // in finalized or rbw state.
+    if (replicaInfo.getState() == ReplicaState.FINALIZED) {
+      FinalizedReplica finalized = (FinalizedReplica)replicaInfo;
+      checksum = finalized.getLastPartialChunkChecksum();
+    } else if (replicaInfo.getState() == ReplicaState.RBW) {
+      ReplicaBeingWritten rbw = (ReplicaBeingWritten)replicaInfo;
+      checksum = rbw.getLastChecksumAndDataLen().getChecksum();
+    }
+
+        .setLastPartialChunkChecksum(checksum)
+    // Only a finalized replica can be appended.
+    FinalizedReplica finalized = (FinalizedReplica)replicaInfo;
-    LocalReplica localReplica = (LocalReplica)replicaInfo;
-    byte[] lastChunkChecksum = loadLastPartialChunkChecksum(
-        localReplica.getBlockFile(), localReplica.getMetaFile());
-        replicaInfo.getNumBytes(), lastChunkChecksum);
+        finalized.getVisibleLength(), finalized.getLastPartialChunkChecksum());

INS26 INS26 INS40 INS40 INS60 INS25 MOV5 INS59 INS27 INS8 INS25 INS32 UPD43 INS42 INS33 INS32 INS40 INS60 INS21 INS27 INS8 MOV32 INS42 UPD42 UPD42 INS32 INS42 INS42 INS43 INS59 INS7 INS32 INS40 INS60 INS21 UPD42 INS42 UPD43 UPD42 UPD42 INS42 UPD42 MOV42 INS42 INS42 INS11 INS42 INS32 INS42 INS42 INS43 INS59 INS7 UPD42 INS43 INS42 INS42 INS42 INS42 INS42 INS11 INS42 INS32 INS42 INS43 INS42 INS32 INS42 INS42 INS42 INS42 DEL42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL32 DEL59 DEL60