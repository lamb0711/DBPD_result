HDDS-1105 : Add mechanism in Recon to obtain DB snapshot 'delta' updates from Ozone Manager (#1259)


+import static org.apache.hadoop.ozone.om.OmMetadataManagerImpl.KEY_TABLE;
+
-import java.util.ArrayList;
+import java.util.Collections;
+import com.google.inject.Inject;
+
-public class ContainerKeyMapperTask extends ReconDBUpdateTask {
+public class ContainerKeyMapperTask implements ReconDBUpdateTask {
-  private Collection<String> tables = new ArrayList<>();
+  @Inject
-                                    containerDBServiceProvider,
-                                OMMetadataManager omMetadataManager) {
-    super("ContainerKeyMapperTask");
+                                    containerDBServiceProvider) {
-    try {
-      tables.add(omMetadataManager.getKeyTable().getName());
-    } catch (IOException ioEx) {
-      LOG.error("Unable to listen on Key Table updates ", ioEx);
-    }
-  protected Collection<String> getTaskTables() {
-    return tables;
+  public String getTaskName() {
+    return "ContainerKeyMapperTask";
-  Pair<String, Boolean> process(OMUpdateEventBatch events) {
+  public Collection<String> getTaskTables() {
+    return Collections.singletonList(KEY_TABLE);
+  }
+
+  @Override
+  public Pair<String, Boolean> process(OMUpdateEventBatch events) {
+    int eventCount = 0;
+        eventCount++;
+    LOG.info("{} successfully processed {} OM DB update event(s).",
+        getTaskName(), eventCount);

MOV26 INS26 INS26 INS40 UPD40 INS40 INS31 INS31 INS78 MOV83 MOV42 MOV44 INS8 INS78 INS83 INS43 INS42 INS8 UPD83 INS83 INS42 MOV21 INS42 UPD42 MOV42 INS41 INS60 INS21 INS45 INS32 INS39 INS59 INS32 INS42 INS42 INS42 INS42 INS34 INS42 INS42 INS45 INS32 INS42 INS42 INS21 INS37 INS42 DEL83 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL42 DEL43 DEL74 DEL14 DEL59 DEL23 DEL42 DEL43 DEL42 DEL44 DEL45 DEL46 DEL42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL32 DEL21 DEL8 DEL43 DEL42 DEL44 DEL42 DEL42 DEL45 DEL42 DEL32 DEL21 DEL8 DEL12 DEL54 DEL8 DEL31 DEL42