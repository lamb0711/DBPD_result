YARN-2753. Fixed a bunch of bugs in the NodeLabelsManager classes. Contributed by Zhihai xu.

-      if (isInState(STATE.STARTED)) {
-        handleStoreEvent(event);
-      }
+      handleStoreEvent(event);
-
+    Set<String> newLabels = new HashSet<String>();
-      this.labelCollections.put(label, new Label());
+      // shouldn't overwrite it to avoid changing the Label.resource
+      if (this.labelCollections.get(label) == null) {
+        this.labelCollections.put(label, new Label());
+        newLabels.add(label);
+      }
-    if (null != dispatcher) {
+    if (null != dispatcher && !newLabels.isEmpty()) {
-          new StoreNewClusterNodeLabels(labels));
+          new StoreNewClusterNodeLabels(newLabels));
-      
-      if (labels == null || labels.isEmpty()) {
+
+      // the labels will never be null
+      if (labels.isEmpty()) {
-      if (!originalLabels.containsAll(labels)) {
+      // originalLabels may be null,
+      // because when a Node is created, Node.labels can be null.
+      if (originalLabels == null || !originalLabels.containsAll(labels)) {

MOV8 INS60 INS74 INS59 INS8 INS27 INS43 INS43 INS42 INS14 INS25 MOV27 INS38 INS42 INS42 INS74 INS27 MOV8 INS32 MOV32 INS27 INS43 INS43 INS32 INS33 INS21 INS42 INS42 INS27 MOV38 INS42 INS42 INS22 INS42 INS42 INS32 UPD42 INS42 INS33 INS52 INS42 INS42 INS42 INS42 DEL42 DEL40 DEL32 DEL25 DEL8 DEL42 DEL33 DEL27 DEL27