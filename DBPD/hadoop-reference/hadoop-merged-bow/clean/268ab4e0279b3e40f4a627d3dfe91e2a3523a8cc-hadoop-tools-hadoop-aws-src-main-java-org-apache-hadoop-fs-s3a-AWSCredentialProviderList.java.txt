HADOOP-15141 Support IAM Assumed roles in S3A. Contributed by Steve Loughran.

+import org.apache.hadoop.io.IOUtils;
+
+import java.io.Closeable;
+import java.util.stream.Collectors;
-public class AWSCredentialProviderList implements AWSCredentialsProvider {
+public class AWSCredentialProviderList implements AWSCredentialsProvider,
+    AutoCloseable {
-   * Reuse the last provider?
-   * @param reuseLastProvider flag to indicate the last provider should
-   * be re-used
-   */
-  public void setReuseLastProvider(boolean reuseLastProvider) {
-    this.reuseLastProvider = reuseLastProvider;
-  }
-
-  /**
-   * query the {@link #reuseLastProvider} flag.
-   * @return the current flag state.
-   */
-  public boolean isReuseLastProvider() {
-    return reuseLastProvider;
-  }
-
-  /**
-    StringBuilder sb = new StringBuilder(providers.size() * 32);
-    for (AWSCredentialsProvider provider : providers) {
-      sb.append(provider.getClass().getSimpleName());
-      sb.append(' ');
-    }
-    return sb.toString();
+    return providers.stream()
+        .map(provider -> provider.getClass().getSimpleName() + ' ')
+        .collect(Collectors.joining());
+
+  /**
+   * Close routine will close all providers in the list which implement
+   * {@code Closeable}.
+   * This matters because some providers start a background thread to
+   * refresh their secrets.
+   */
+  @Override
+  public void close() {
+    for(AWSCredentialsProvider p: providers) {
+      if (p instanceof Closeable) {
+        IOUtils.closeStream((Closeable)p);
+      }
+    }
+  }

INS26 INS26 INS26 INS40 INS40 INS40 INS43 INS31 INS31 INS42 MOV29 MOV83 MOV43 INS42 MOV8 MOV29 INS78 MOV83 UPD39 MOV39 UPD42 MOV42 INS8 INS41 INS65 INS42 INS70 INS32 UPD66 MOV66 UPD65 MOV65 UPD66 MOV66 INS66 UPD66 MOV66 MOV44 INS42 INS8 MOV32 INS42 INS32 INS66 UPD42 INS25 INS32 UPD42 INS86 INS42 INS42 INS62 INS8 INS42 UPD42 MOV42 INS59 INS27 INS42 INS43 MOV21 INS42 MOV32 INS13 UPD42 MOV42 UPD42 UPD42 INS11 INS43 INS42 INS42 DEL66 DEL65 DEL42 DEL66 DEL66 DEL65 DEL29 DEL39 DEL42 DEL39 DEL42 DEL44 DEL31 DEL42 DEL41 DEL8 DEL31 DEL52 DEL42 DEL22 DEL42 DEL7 DEL21 DEL83 DEL42 DEL42 DEL43 DEL42 DEL43 DEL42 DEL42 DEL32 DEL34 DEL27 DEL14 DEL59 DEL60 DEL42 DEL21 DEL8 DEL70 DEL42 DEL42 DEL32 DEL41 DEL8 DEL31 DEL42 DEL67 DEL65 DEL65 DEL13