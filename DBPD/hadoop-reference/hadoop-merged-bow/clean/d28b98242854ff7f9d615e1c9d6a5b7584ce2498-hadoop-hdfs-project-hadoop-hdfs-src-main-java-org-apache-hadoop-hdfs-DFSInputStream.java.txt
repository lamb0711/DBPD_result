HDFS-3222. DFSInputStream#openInfo should not silently get the length as 0 when locations length is zero for last partial block. Contributed by Uma Maheswara Rao G.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1331061 13f79535-47bb-0310-9956-ffa450edef68

+    lastBlockBeingWrittenLength = fetchLocatedBlocksAndGetLastBlockLength();
+    int retriesForLastBlockLength = 3;
+    while (retriesForLastBlockLength > 0) {
+      // Getting last block length as -1 is a special case. When cluster
+      // restarts, DNs may not report immediately. At this time partial block
+      // locations will not be available with NN for getting the length. Lets
+      // retry for 3 times to get the length.
+      if (lastBlockBeingWrittenLength == -1) {
+        DFSClient.LOG.warn("Last block locations not available. "
+            + "Datanodes might not have reported blocks completely."
+            + " Will retry for " + retriesForLastBlockLength + " times");
+        waitFor(4000);
+        lastBlockBeingWrittenLength = fetchLocatedBlocksAndGetLastBlockLength();
+      } else {
+        break;
+      }
+      retriesForLastBlockLength--;
+    }
+    if (retriesForLastBlockLength == 0) {
+      throw new IOException("Could not obtain the last block locations.");
+    }
+  }
+
+  private void waitFor(int waitTime) throws IOException {
+    try {
+      Thread.sleep(waitTime);
+    } catch (InterruptedException e) {
+      throw new IOException(
+          "Interrupted while getting the last block length.");
+    }
+  }
+
+  private long fetchLocatedBlocksAndGetLastBlockLength() throws IOException {
-    lastBlockBeingWrittenLength = 0;
+    long lastBlockBeingWrittenLength = 0;
+        if (last.getLocations().length == 0) {
+          return -1;
+        }
+    return lastBlockBeingWrittenLength;
-    if (locatedblock == null || locatedblock.getLocations().length == 0) {
-      return 0;
-    }
+    assert locatedblock != null : "LocatedBlock cannot be null";

INS31 INS31 MOV29 INS83 INS39 INS42 INS43 MOV43 INS8 INS83 INS39 INS42 INS44 INS43 INS8 UPD83 UPD39 UPD42 INS42 INS21 INS60 INS61 INS25 INS39 INS42 INS42 INS54 INS60 INS41 INS6 INS7 INS39 INS59 INS27 INS8 INS27 INS8 INS8 INS12 INS39 INS59 INS42 INS27 INS45 INS42 INS32 INS42 INS34 INS42 INS34 INS25 INS21 INS42 INS34 INS53 INS21 INS44 INS8 INS42 INS34 MOV42 MOV33 INS42 INS27 INS8 INS8 INS37 INS14 INS32 INS43 INS42 INS53 INS42 INS38 INS21 INS21 INS21 INS10 INS42 INS43 INS45 INS42 INS42 INS42 INS42 INS14 INS25 INS34 INS32 INS32 INS7 INS42 INS43 INS45 INS27 INS8 INS40 INS42 INS27 INS42 INS34 INS42 INS32 INS42 INS22 INS34 INS41 INS27 INS42 INS45 INS42 INS32 INS42 INS38 INS45 INS45 INS45 INS42 INS42 INS34 DEL42 DEL34 DEL7 DEL21 DEL27 DEL42 DEL42 DEL32 DEL42 DEL22 DEL34 DEL27 DEL27 DEL34 DEL41 DEL8 DEL25