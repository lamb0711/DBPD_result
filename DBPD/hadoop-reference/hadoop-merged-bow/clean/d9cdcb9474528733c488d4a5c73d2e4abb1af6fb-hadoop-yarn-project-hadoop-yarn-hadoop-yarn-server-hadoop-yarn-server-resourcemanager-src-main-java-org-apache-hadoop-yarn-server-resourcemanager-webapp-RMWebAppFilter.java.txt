YARN-1658. Modified web-app framework to let standby RMs redirect web-service calls to the active RM. Contributed by Cindy Li.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1577408 13f79535-47bb-0310-9956-ffa450edef68

+import javax.inject.Inject;
+import javax.inject.Singleton;
+import javax.servlet.FilterChain;
-import org.apache.hadoop.classification.InterfaceAudience;
-import org.apache.hadoop.yarn.webapp.Dispatcher;
-import org.apache.hadoop.yarn.webapp.Router;
-import org.apache.hadoop.yarn.webapp.WebApp;
-import com.google.inject.Inject;
-import com.google.inject.Singleton;
+import com.sun.jersey.guice.spi.container.servlet.GuiceContainer;
-@InterfaceAudience.LimitedPrivate({ "YARN", "MapReduce" })
-public class RMDispatcher extends Dispatcher {
+public class RMWebAppFilter extends GuiceContainer {
+  private Injector injector;
-   *
+   * 
-  RMDispatcher(WebApp webApp, Injector injector, Router router) {
-    super(webApp, injector, router);
+  public RMWebAppFilter(Injector injector) {
+    super(injector);
+    this.injector=injector;
-  public void service(HttpServletRequest req, HttpServletResponse res)
-      throws ServletException, IOException {
-    res.setCharacterEncoding("UTF-8");
-    String uri = HtmlQuoting.quoteHtmlChars(req.getRequestURI());
+  public void doFilter(HttpServletRequest request,
+      HttpServletResponse response, FilterChain chain) throws IOException,
+      ServletException {
+    response.setCharacterEncoding("UTF-8");
+    String uri = HtmlQuoting.quoteHtmlChars(request.getRequestURI());
-
-    RMWebApp rmWebApp = (RMWebApp) webApp;
+    RMWebApp rmWebApp = injector.getInstance(RMWebApp.class);
+        && !uri.equals("/" + rmWebApp.wsName() + "/v1/cluster/info")
+
-        res.addHeader("Refresh", "3; url=" + redirectPath);
-        PrintWriter out = res.getWriter();
+        response.addHeader("Refresh", "3; url=" + redirectPath);
+        PrintWriter out = response.getWriter();
-    super.service(req, res);
+
+    super.doFilter(request, response, chain);
+
+

MOV26 MOV26 MOV26 UPD40 UPD40 UPD40 UPD40 UPD42 UPD43 INS23 INS31 MOV43 UPD42 INS83 INS43 INS59 MOV78 INS83 INS42 MOV44 MOV8 UPD42 INS44 UPD42 MOV42 INS42 INS46 INS21 UPD42 UPD42 INS43 INS42 UPD42 MOV42 INS7 INS42 INS22 INS42 UPD42 INS32 INS38 UPD42 UPD42 UPD42 INS42 INS52 INS42 INS42 INS42 INS57 INS32 UPD42 MOV43 INS42 INS42 INS27 INS45 INS32 INS45 INS42 INS42 UPD42 UPD42 DEL40 DEL26 DEL40 DEL26 DEL40 DEL45 DEL45 DEL4 DEL79 DEL42 DEL42 DEL46 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL44 DEL31 DEL42 DEL11