Merging r1547121 through r1547473 from trunk to branch HDFS-2832

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2832@1547492 13f79535-47bb-0310-9956-ffa450edef68

-  private static class StatefulBlockInfo {
+  static class StatefulBlockInfo {
+    final Block reportedBlock;
-        ReplicaState reportedState) {
+        Block reportedBlock, ReplicaState reportedState) {
+      this.reportedBlock = reportedBlock;
-      addStoredBlockUnderConstruction(b.storedBlock, node,
-          storage.getStorageID(), b.reportedState);
+      addStoredBlockUnderConstruction(b, node, storage.getStorageID());
-          (BlockInfoUnderConstruction)storedBlock, reportedState));
+          (BlockInfoUnderConstruction)storedBlock, block, reportedState));
-  
-  void addStoredBlockUnderConstruction(
-      BlockInfoUnderConstruction block, 
-      DatanodeDescriptor node, String storageID, 
-      ReplicaState reportedState) 
-  throws IOException {
-    block.addReplicaIfNotPresent(node.getStorageInfo(storageID), block, reportedState);
-    if (reportedState == ReplicaState.FINALIZED && block.findDatanode(node) < 0) {
+
+  void addStoredBlockUnderConstruction(StatefulBlockInfo ucBlock,
+      DatanodeDescriptor node, String storageID) throws IOException {
+    BlockInfoUnderConstruction block = ucBlock.storedBlock;
+    block.addReplicaIfNotPresent(node.getStorageInfo(storageID),
+        ucBlock.reportedBlock, ucBlock.reportedState);
+
+    if (ucBlock.reportedState == ReplicaState.FINALIZED && block.findDatanode(node) < 0) {
-  }
-  
+  } 
+
-      addStoredBlockUnderConstruction(b.storedBlock, node, storageID, b.reportedState);
+      addStoredBlockUnderConstruction(b, node, storageID);

MOV44 INS23 INS83 INS43 INS59 INS44 UPD43 UPD42 INS60 INS42 INS42 INS43 INS42 INS21 UPD42 MOV43 INS59 INS42 INS7 INS42 INS40 INS40 INS40 INS22 INS42 INS40 INS52 INS42 INS42 INS42 INS42 DEL83 DEL40 DEL40 DEL42 DEL44 DEL42 DEL42 DEL42 DEL40 DEL40