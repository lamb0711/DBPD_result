HDFS-4446. Support file snapshots with diff lists.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1443825 13f79535-47bb-0310-9956-ffa450edef68

-  void checkAndInitINode(N snapshotCopy) {
+  void checkAndInitINode(N currentINode, N snapshotCopy) {
-        @SuppressWarnings("unchecked")
-        final N right = (N)getCurrentINode().createSnapshotCopy().right;
-        snapshotCopy = right;
+        snapshotCopy = createSnapshotCopyOfCurrentINode(currentINode);
-  /** @return the current inode. */
-  abstract N getCurrentINode();
+  /** @return a snapshot copy of the current inode. */
+  abstract N createSnapshotCopyOfCurrentINode(N currentINode);
-    // get from this diff, then the posterior diff and then the current inode
+    // get from this diff, then the posterior diff
+    // and then null for the current inode
-        return getCurrentINode();
+        return null;
-  abstract void combinePosteriorAndCollectBlocks(final D posterior,
-      final BlocksMapUpdateInfo collectedBlocks);
+  abstract void combinePosteriorAndCollectBlocks(final N currentINode,
+      final D posterior, final BlocksMapUpdateInfo collectedBlocks);
+
+  @Override
+  public String toString() {
+    return getClass().getSimpleName() + ": " + snapshot + " (post="
+        + (posteriorDiff == null? null: posteriorDiff.snapshot) + ")";
+  }

INS31 INS44 INS42 INS44 INS44 INS78 INS83 INS43 INS42 INS8 MOV43 INS42 INS43 INS42 INS83 MOV43 INS42 INS42 INS42 INS41 UPD66 INS42 INS27 INS32 INS45 INS42 INS45 INS36 INS45 INS32 INS42 INS16 INS42 INS27 INS33 INS40 INS42 INS33 INS32 INS33 INS42 INS42 DEL42 DEL45 DEL79 DEL83 DEL42 DEL42 DEL32 DEL42 DEL32 DEL42 DEL22 DEL11 DEL59 DEL60 DEL42 DEL42 DEL42 DEL32