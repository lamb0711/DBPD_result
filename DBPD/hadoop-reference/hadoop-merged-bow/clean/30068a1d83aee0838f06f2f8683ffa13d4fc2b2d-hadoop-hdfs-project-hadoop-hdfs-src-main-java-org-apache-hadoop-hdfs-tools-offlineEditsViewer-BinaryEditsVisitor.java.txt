Merge trunk into auto-failover branch.

Addressed two semantic conflicts after the commit of HADOOP-8077 -- test code was referencing the old constant for the fencing methods config key.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-3042@1310174 13f79535-47bb-0310-9956-ffa450edef68

-import java.io.FileOutputStream;
-import java.io.DataOutputStream;
+import java.io.File;
+import org.apache.hadoop.hdfs.server.namenode.FSEditLogOp;
+import org.apache.hadoop.hdfs.server.namenode.EditLogFileOutputStream;
-public class BinaryEditsVisitor extends EditsVisitor {
-  final private DataOutputStream out;
+public class BinaryEditsVisitor implements OfflineEditsVisitor {
+  final private EditLogFileOutputStream elfos;
-   * Create a processor that writes to a given file and
-   * reads using a given Tokenizer
+   * Create a processor that writes to a given file
-   * @param tokenizer Input tokenizer
-  public BinaryEditsVisitor(String filename, Tokenizer tokenizer)
-    throws IOException {
-
-    this(filename, tokenizer, false);
-  }
-
-  /**
-   * Create a processor that writes to a given file and reads using
-   * a given Tokenizer, may also print to screen
-   *
-   * @param filename Name of file to write output to
-   * @param tokenizer Input tokenizer
-   * @param printToScreen Mirror output to screen? (ignored for binary)
-   */
-  public BinaryEditsVisitor(String filename,
-    Tokenizer tokenizer,
-    boolean printToScreen) throws IOException {
-
-    super(tokenizer);
-    out = new DataOutputStream(new FileOutputStream(filename));
+  public BinaryEditsVisitor(String outputName) throws IOException {
+    this.elfos = new EditLogFileOutputStream(new File(outputName), 0);
+    elfos.create();
-  void start() throws IOException {
-    // nothing to do for binary format
+  public void start(int version) throws IOException {
-  void finish() throws IOException {
-    close();
+  public void close(Throwable error) throws IOException {
+    elfos.setReadyToFlush();
+    elfos.flushAndSync();
+    elfos.close();
-  /**
-   * Finish the visitor and indicate an error
-   */
-  void finishAbnormally() throws IOException {
-    System.err.println("Error processing EditLog file.  Exiting.");
-    close();
+  public void visitOp(FSEditLogOp op) throws IOException {
+    elfos.write(op);
-
-  /**
-   * Close output stream and prevent further writing
-   */
-  private void close() throws IOException {
-    out.close();
-  }
-
-  /**
-   * Visit a enclosing element (element that has other elements in it)
-   */
-  @Override
-  void visitEnclosingElement(Tokenizer.Token value) throws IOException {
-    // nothing to do for binary format
-  }
-
-  /**
-   * End of eclosing element
-   */
-  @Override
-  void leaveEnclosingElement() throws IOException {
-    // nothing to do for binary format
-  }  
-
-  /**
-   * Visit a Token
-   */
-  @Override
-  Tokenizer.Token visit(Tokenizer.Token value) throws IOException {
-    value.toBinary(out);
-    return value;
-  }
-}
+}

MOV26 INS26 UPD40 INS40 UPD40 UPD43 INS31 INS31 INS31 UPD42 UPD43 MOV29 MOV83 MOV42 MOV44 MOV43 INS8 INS83 INS44 MOV29 MOV78 UPD83 MOV83 MOV39 MOV42 INS44 MOV43 INS8 MOV78 INS83 MOV39 UPD42 MOV42 MOV44 MOV43 MOV8 UPD42 UPD42 UPD42 MOV21 MOV21 INS39 INS42 INS43 INS42 MOV21 INS21 INS21 UPD43 UPD42 UPD66 UPD42 MOV42 INS32 INS32 INS42 INS22 INS42 UPD42 UPD42 UPD42 INS42 INS42 INS42 INS42 UPD42 UPD42 UPD42 INS52 INS42 UPD43 INS34 UPD42 UPD43 UPD42 UPD42 DEL66 DEL42 DEL66 DEL65 DEL42 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL42 DEL9 DEL17 DEL8 DEL31 DEL66 DEL66 DEL65 DEL42 DEL66 DEL65 DEL42 DEL66 DEL65 DEL42 DEL66 DEL65 DEL29 DEL83 DEL42 DEL42 DEL43 DEL42 DEL44 DEL42 DEL43 DEL42 DEL44 DEL39 DEL42 DEL44 DEL42 DEL43 DEL42 DEL46 DEL8 DEL31 DEL40 DEL42 DEL41 DEL39 DEL42 DEL8 DEL31 DEL66 DEL65 DEL29 DEL39 DEL42 DEL40 DEL42 DEL45 DEL32 DEL21 DEL42 DEL32 DEL21 DEL8 DEL31 DEL66 DEL65 DEL29 DEL43 DEL8 DEL31 DEL66 DEL65 DEL29 DEL42 DEL78 DEL39 DEL42 DEL40 DEL43 DEL42 DEL44 DEL8 DEL31 DEL66 DEL65 DEL29 DEL42 DEL78 DEL42 DEL42 DEL43 DEL8 DEL31 DEL66 DEL65 DEL29 DEL42 DEL78 DEL40 DEL43 DEL42 DEL43 DEL31