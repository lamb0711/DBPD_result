HDFS-8418. Fix the isNeededReplication calculation for Striped block in NN. Contributed by Yi Liu.

-import org.apache.hadoop.hdfs.protocol.HdfsConstants;
+import static org.apache.hadoop.hdfs.protocol.HdfsConstants.BLOCK_STRIPED_CELL_SIZE;
-      final BlockInfoStriped sblock = (BlockInfoStriped) block;
-      short dataBlockNum = sblock.getDataBlockNum();
-      if (sblock.isComplete() ||
-          sblock.getBlockUCState() == BlockUCState.COMMITTED) {
-        // if the sblock is committed/completed and its length is less than a
-        // full stripe, the minimum storage number needs to be adjusted
-        dataBlockNum = (short) Math.min(dataBlockNum,
-            (sblock.getNumBytes() - 1) / HdfsConstants.BLOCK_STRIPED_CELL_SIZE + 1);
-      }
-      return dataBlockNum;
+      return getStripedDataBlockNum(block);
-        b.stored.getBlockCollection().getPreferredBlockReplication();
+        getExpectedReplicaNum(b.stored.getBlockCollection(), b.stored);
-            requiredReplication = bc.getPreferredBlockReplication();
+            requiredReplication = getExpectedReplicaNum(bc, block);
-          requiredReplication = bc.getPreferredBlockReplication();
+          requiredReplication = getExpectedReplicaNum(bc, block);
-                  HdfsConstants.BLOCK_STRIPED_CELL_SIZE,
+                  BLOCK_STRIPED_CELL_SIZE,
-    short fileReplication = bc.getPreferredBlockReplication();
+    short fileReplication = getExpectedReplicaNum(bc, storedBlock);
-        block.getBlockCollection().getPreferredBlockReplication();
+        getExpectedReplicaNum(block.getBlockCollection(), block);
-    final short expected = bc.getPreferredBlockReplication();
+      short expected = getExpectedReplicaNum(bc, block);
-  private int getReplication(Block block) {
+  private int getReplication(BlockInfo block) {
-    return bc == null? 0: bc.getPreferredBlockReplication();
+    return bc == null? 0: getExpectedReplicaNum(bc, block);
+  public short getExpectedReplicaNum(BlockCollection bc, BlockInfo block) {
+    if (block.isStriped()) {
+      return (short) (getStripedDataBlockNum(block) + 
+          ((BlockInfoStriped) block).getParityBlockNum());
+    } else {
+      return bc.getPreferredBlockReplication();
+    }
+  }
+  
+  short getStripedDataBlockNum(BlockInfo block) {
+    assert block.isStriped();
+    final BlockInfoStriped sblock = (BlockInfoStriped) block;
+    short dataBlockNum = sblock.getDataBlockNum();
+    if (sblock.isComplete() ||
+        sblock.getBlockUCState() == BlockUCState.COMMITTED) {
+      // if the sblock is committed/completed and its length is less than a
+      // full stripe, the minimum storage number needs to be adjusted
+      dataBlockNum = (short) Math.min(dataBlockNum,
+          (sblock.getNumBytes() - 1) / BLOCK_STRIPED_CELL_SIZE + 1);
+    }
+    return dataBlockNum;
+  }
+  

MOV26 MOV31 UPD40 INS31 INS31 INS83 INS39 INS42 INS44 INS8 INS83 INS39 INS42 INS44 INS44 INS8 UPD42 MOV8 INS43 INS42 INS25 UPD43 INS43 INS42 INS43 INS42 INS25 INS6 INS42 MOV32 INS8 MOV8 UPD42 INS42 INS42 INS32 INS8 INS8 INS32 INS41 MOV32 MOV32 INS60 INS42 INS42 INS41 INS41 INS42 INS42 INS32 UPD42 INS40 INS42 UPD42 UPD42 INS42 INS39 INS59 INS42 UPD42 INS11 MOV32 INS42 INS42 INS42 INS32 INS39 INS36 INS42 INS42 INS42 INS27 INS32 INS32 INS42 INS42 INS36 INS42 INS42 INS11 INS42 INS42 UPD42 INS43 INS42 INS42 INS42 UPD42 DEL40 DEL83 DEL39 DEL42 DEL59 DEL60 DEL83 DEL40 DEL25 DEL8