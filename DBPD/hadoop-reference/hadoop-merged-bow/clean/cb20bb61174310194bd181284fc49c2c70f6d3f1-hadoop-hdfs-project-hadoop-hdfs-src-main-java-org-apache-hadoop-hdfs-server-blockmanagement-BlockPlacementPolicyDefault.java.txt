Merge from trunk to branch

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/fs-encryption@1612403 13f79535-47bb-0310-9956-ffa450edef68

-      double avgLoad = 0;
-      if (stats != null) {
-        int size = stats.getNumDatanodesInService();
-        if (size != 0) {
-          avgLoad = (double)stats.getTotalLoad()/size;
-        }
-      }
-      if (node.getXceiverCount() > (2.0 * avgLoad)) {
-        logNodeIsNotChosen(storage, "the node is too busy ");
+      final double maxLoad = 2.0 * stats.getInServiceXceiverAverage();
+      final int nodeLoad = node.getXceiverCount();
+      if (nodeLoad > maxLoad) {
+        logNodeIsNotChosen(storage,
+            "the node is too busy (load:"+nodeLoad+" > "+maxLoad+") ");
-  public DatanodeDescriptor chooseReplicaToDelete(BlockCollection bc,
+  public DatanodeStorageInfo chooseReplicaToDelete(BlockCollection bc,
-      Collection<DatanodeDescriptor> first,
-      Collection<DatanodeDescriptor> second) {
+      Collection<DatanodeStorageInfo> first,
+      Collection<DatanodeStorageInfo> second) {
-    DatanodeDescriptor oldestHeartbeatNode = null;
+    DatanodeStorageInfo oldestHeartbeatStorage = null;
-    DatanodeDescriptor minSpaceNode = null;
+    DatanodeStorageInfo minSpaceStorage = null;
-    for(DatanodeDescriptor node : pickupReplicaSet(first, second)) {
+    for(DatanodeStorageInfo storage : pickupReplicaSet(first, second)) {
+      final DatanodeDescriptor node = storage.getDatanodeDescriptor();
-        oldestHeartbeatNode = node;
+        oldestHeartbeatStorage = storage;
-        minSpaceNode = node;
+        minSpaceStorage = storage;
-    return oldestHeartbeatNode != null ? oldestHeartbeatNode : minSpaceNode;
+
+    return oldestHeartbeatStorage != null? oldestHeartbeatStorage
+        : minSpaceStorage;
-  protected Collection<DatanodeDescriptor> pickupReplicaSet(
-      Collection<DatanodeDescriptor> first,
-      Collection<DatanodeDescriptor> second) {
+  protected Collection<DatanodeStorageInfo> pickupReplicaSet(
+      Collection<DatanodeStorageInfo> first,
+      Collection<DatanodeStorageInfo> second) {

MOV44 MOV44 UPD43 UPD74 MOV74 UPD42 UPD74 UPD42 UPD74 UPD42 UPD43 UPD74 MOV74 UPD42 UPD74 UPD42 INS43 UPD43 UPD43 UPD43 UPD42 UPD43 UPD43 MOV60 INS42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD43 UPD42 INS60 UPD42 UPD42 UPD42 UPD42 INS83 INS83 UPD42 INS83 MOV43 INS59 UPD42 UPD42 INS27 INS42 MOV32 INS42 UPD42 MOV42 INS42 INS32 INS34 INS32 INS42 INS42 INS42 INS42 INS27 UPD42 UPD42 UPD42 UPD42 INS45 INS42 INS45 INS42 INS45 DEL34 DEL42 DEL42 DEL42 DEL32 DEL42 DEL33 DEL27 DEL42 DEL34 DEL27 DEL42 DEL39 DEL42 DEL42 DEL32 DEL11 DEL42 DEL27 DEL7 DEL21 DEL8 DEL25 DEL8 DEL25 DEL34 DEL27 DEL36 DEL45