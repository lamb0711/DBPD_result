HDFS-3086. Change Datanode not to send storage list in registration.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1303318 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.DFSConfigKeys;
+import org.apache.hadoop.hdfs.HdfsConfiguration;
-import org.apache.hadoop.hdfs.HdfsConfiguration;
-import org.apache.hadoop.hdfs.DFSConfigKeys;
-    @SuppressWarnings("deprecation")
-    @SuppressWarnings("deprecation")
+    DatanodeStorage storage; //only one storage 
-      
-      DatanodeStorage[] storages = { new DatanodeStorage(
-          dnRegistration.getStorageID(), DatanodeStorage.State.NORMAL) };
-      dnRegistration = nameNodeProto.registerDatanode(dnRegistration, storages);
+      dnRegistration = nameNodeProto.registerDatanode(dnRegistration);
+      //first block reports
+      storage = new DatanodeStorage(dnRegistration.getStorageID());
+      final StorageBlockReport[] reports = {
+          new StorageBlockReport(storage,
+              new BlockListAsLongs(null, null).getBlockListAsLongs())
+      };
+      nameNodeProto.blockReport(dnRegistration, 
+          nameNode.getNamesystem().getBlockPoolId(), reports);
-          dn.dnRegistration.getStorageID(), dn.getBlockReportList()) };
+          dn.storage, dn.getBlockReportList()) };

MOV26 MOV26 INS23 MOV43 INS59 INS42 INS21 INS21 INS7 INS7 INS83 UPD5 INS32 INS42 INS32 INS42 MOV14 INS43 UPD42 MOV42 UPD42 MOV42 MOV42 INS32 UPD42 MOV42 INS42 INS42 INS42 INS42 INS14 INS32 INS42 INS43 INS42 INS32 INS42 INS42 INS40 INS42 INS14 INS42 INS43 INS33 INS33 INS42 DEL42 DEL45 DEL79 DEL42 DEL45 DEL79 DEL40 DEL42 DEL32 DEL7 DEL40 DEL42 DEL32