Merge remote-tracking branch 'apache/trunk' into HDFS-7285

+import org.apache.hadoop.hdfs.server.protocol.DatanodeStorage.State;
-  private final BlockQueue<BlockInfo> recoverBlocks =
-      new BlockQueue<>();
+  private final BlockQueue<BlockInfo> recoverBlocks = new BlockQueue<>();
-   * @return Approximate number of blocks currently scheduled to be written 
+   * Return the sum of remaining spaces of the specified type. If the remaining
+   * space of a storage is less than minSize, it won't be counted toward the
+   * sum.
+   *
+   * @param t The storage type. If null, the type is ignored.
+   * @param minSize The minimum free space required.
+   * @return the sum of remaining spaces that are bigger than minSize.
-  public long getRemaining(StorageType t) {
+  public long getRemaining(StorageType t, long minSize) {
-    for(DatanodeStorageInfo s : getStorageInfos()) {
-      if (s.getStorageType() == t) {
-        remaining += s.getRemaining();
+    for (DatanodeStorageInfo s : getStorageInfos()) {
+      if (s.getState() == State.NORMAL &&
+          (t == null || s.getStorageType() == t)) {
+        long r = s.getRemaining();
+        if (r >= minSize) {
+          remaining += r;
+        }
-    return remaining;    
+    return remaining;

INS26 INS40 INS44 INS65 INS65 INS65 INS39 INS42 INS66 INS66 INS66 INS42 INS66 INS42 INS66 UPD66 INS8 INS25 INS27 INS8 INS27 INS36 INS60 MOV25 INS32 INS40 INS27 INS39 INS59 INS27 INS42 INS42 INS27 MOV27 INS42 MOV32 INS42 INS42 INS42 INS33 INS42 DEL8