HDFS-2149. Move EditLogOp serialization formats into FsEditLogOp implementations. Contributed by Ivan Kelly.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1151238 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.ByteArrayOutputStream;
-  private ArrayList<JournalRecord> bufCurrent;  // current buffer for writing
-  private ArrayList<JournalRecord> bufReady;    // buffer ready for flushing
+  private ArrayList<BufferedOp> bufCurrent;  // current buffer for writing
+  private ArrayList<BufferedOp> bufReady;    // buffer ready for flushing
-  static class JournalRecord {
-    byte op;
-    Writable[] args;
+  
+  private static class BufferedOp { 
+    public final FSEditLogOpCodes opCode;
+    public final byte[] bytes;
-    JournalRecord(byte op, Writable ... writables) {
-      this.op = op;
-      this.args = writables;
-    }
-
-    void write(DataOutputStream out) throws IOException {
-      out.write(op);
-      if(args == null)
-        return;
-      for(Writable w : args)
-        w.write(out);
+    public BufferedOp(FSEditLogOpCodes opCode, byte[] bytes) {
+      this.opCode = opCode;
+      this.bytes = bytes;
-    this.bufCurrent = new ArrayList<JournalRecord>();
-    this.bufReady = new ArrayList<JournalRecord>();
+    this.bufCurrent = new ArrayList<BufferedOp>();
+    this.bufReady = new ArrayList<BufferedOp>();
-  public void write(int b) throws IOException {
-    throw new IOException("Not implemented");
+  void write(FSEditLogOp op) throws IOException {
+    ByteArrayOutputStream baos = new ByteArrayOutputStream();
+    DataOutputStream s = new DataOutputStream(baos);
+    FSEditLogOp.Writer w = new FSEditLogOp.Writer(s);
+    w.writeOp(op);
+
+    bufCurrent.add(new BufferedOp(op.opCode, baos.toByteArray()));
-  @Override // EditLogOutputStream
-  void write(byte op, Writable ... writables) throws IOException {
-    bufCurrent.add(new JournalRecord(op, writables));
+  @Override
+  void writeRaw(byte[] bytes, int offset, int length) throws IOException {
+    throw new IOException("Not supported");
-    ArrayList<JournalRecord>  tmp = bufReady;
+    ArrayList<BufferedOp>  tmp = bufReady;
-      JournalRecord jRec = null;
+      BufferedOp jRec = null;
-        if(jRec.op >= FSEditLogOpCodes.OP_JSPOOL_START.getOpCode())
+        if(jRec.opCode.getOpCode() 
+           >= FSEditLogOpCodes.OP_JSPOOL_START.getOpCode())
-        jRec.write(out);
+        out.write(jRec.bytes, 0, jRec.bytes.length);
-      jRec.write(out);
-      send(jRec.op);
+      out.write(jRec.bytes, 0, jRec.bytes.length);
+      send(jRec.opCode.getOpCode());

INS26 INS40 INS55 INS31 UPD74 UPD74 INS83 MOV83 UPD42 MOV42 MOV23 MOV23 MOV31 MOV21 MOV78 MOV39 MOV42 MOV44 MOV43 INS8 UPD42 INS44 MOV8 UPD43 UPD43 INS83 INS83 INS43 INS83 INS83 UPD5 INS83 UPD42 INS43 UPD42 INS60 INS60 INS60 INS21 INS21 INS5 UPD42 INS39 INS42 INS39 INS42 UPD42 UPD42 INS42 UPD42 INS39 UPD42 INS43 UPD42 INS5 UPD42 INS42 INS43 INS59 MOV43 INS59 INS43 INS59 MOV32 INS32 INS39 INS85 UPD74 INS42 INS39 INS85 MOV22 MOV22 UPD42 MOV42 INS42 INS14 INS42 INS14 INS40 INS42 INS14 UPD42 UPD42 INS42 INS42 INS14 UPD45 UPD43 UPD42 UPD42 UPD74 UPD74 INS43 INS43 INS42 INS43 INS42 INS43 INS40 INS32 UPD42 UPD43 UPD42 UPD42 UPD43 UPD43 INS42 INS42 INS40 INS42 INS42 INS42 UPD42 UPD42 INS40 INS34 INS40 INS32 UPD42 UPD42 UPD40 MOV40 INS42 INS32 UPD42 INS40 INS34 INS40 INS40 INS42 DEL39 DEL42 DEL43 DEL39 DEL42 DEL43 DEL43 DEL42 DEL42 DEL42 DEL32 DEL21 DEL42 DEL33 DEL27 DEL41 DEL25 DEL42 DEL43 DEL42 DEL44 DEL42 DEL21 DEL70 DEL8 DEL31 DEL55 DEL83 DEL39 DEL42 DEL39 DEL42 DEL44 DEL31 DEL39 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL43 DEL42 DEL42 DEL14 DEL32 DEL21 DEL8 DEL40 DEL42 DEL42