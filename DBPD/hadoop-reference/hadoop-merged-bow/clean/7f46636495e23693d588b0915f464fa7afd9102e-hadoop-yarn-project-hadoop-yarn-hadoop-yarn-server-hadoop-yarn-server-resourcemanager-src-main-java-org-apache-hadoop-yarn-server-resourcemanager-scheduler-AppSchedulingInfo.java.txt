YARN-4519. Potential deadlock of CapacityScheduler between decrease container and assign containers. Contributed by Meng Ding

+import org.apache.hadoop.yarn.exceptions.YarnException;
+import org.apache.hadoop.yarn.server.resourcemanager.RMServerUtils;
+      if (r.getRMContainer().getState() != RMContainerState.RUNNING) {
+        LOG.warn("rmContainer's state is not RUNNING, for increase request with"
+            + " container-id=" + r.getContainerId());
+        continue;
+      }
+      try {
+        RMServerUtils.checkSchedContainerChangeRequest(r, true);
+      } catch (YarnException e) {
+        LOG.warn("Error happens when checking increase request, Ignoring.."
+            + " exception=", e);
+        continue;
+      }
-          + " delta=" + request.getDeltaCapacity());
+          + " delta=" + delta);
-    
+    Resource deltaCapacity = increaseRequest.getDeltaCapacity();
+
-          + increaseRequest.getDeltaCapacity());
+          + deltaCapacity);
-    
-    queue.getMetrics().allocateResources(user,
-        increaseRequest.getDeltaCapacity());
-    
+    queue.getMetrics().allocateResources(user, deltaCapacity);
-    
-    appResourceUsage.incUsed(increaseRequest.getNodePartition(),
-        increaseRequest.getDeltaCapacity());
+    appResourceUsage.incUsed(increaseRequest.getNodePartition(), deltaCapacity);

INS26 INS26 INS40 INS40 INS60 INS43 INS59 INS25 INS54 INS42 INS42 MOV32 UPD42 MOV42 INS42 INS27 INS8 INS8 INS12 INS32 INS40 INS21 INS18 INS21 INS44 INS8 INS32 INS42 INS32 INS32 INS43 INS42 INS21 INS18 INS42 INS42 INS42 INS42 INS42 INS42 INS27 INS42 INS42 INS42 INS9 INS42 INS32 INS45 INS45 INS32 INS42 INS42 INS27 INS42 INS42 INS42 INS45 INS45 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL32