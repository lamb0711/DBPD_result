YARN-3021. YARN's delegation-token handling disallows certain trust setups to operate properly over DistCp. Contributed by Yongjun Zhang

-  
+  @VisibleForTesting
+  public static final Text HDFS_DELEGATION_KIND =
+      new Text("HDFS_DELEGATION_TOKEN");
-      if (token.getKind().equals(new Text("HDFS_DELEGATION_TOKEN"))) {
+      if (token.getKind().equals(HDFS_DELEGATION_KIND)) {
-        if (token.getKind().equals(new Text("HDFS_DELEGATION_TOKEN"))) {
+        if (token.getKind().equals(HDFS_DELEGATION_KIND)) {
+        if (skipTokenRenewal(token)) {
+          continue;
+        }
-  
+
+  /*
+   * Skip renewing token if the renewer of the token is set to ""
+   * Caller is expected to have examined that token.isManaged() returns
+   * true before calling this method.
+   */
+  private boolean skipTokenRenewal(Token<?> token)
+      throws IOException {
+    @SuppressWarnings("unchecked")
+    Text renewer = ((Token<AbstractDelegationTokenIdentifier>)token).
+        decodeIdentifier().getRenewer();
+    return (renewer != null && renewer.toString().equals(""));
+  }
+
-      
-        && dttr.token.getKind().equals(new Text("HDFS_DELEGATION_TOKEN"))) {
+        && dttr.token.getKind().equals(HDFS_DELEGATION_KIND)) {
-            if (t.token.getKind().equals(new Text("HDFS_DELEGATION_TOKEN"))) {
+            if (t.token.getKind().equals(HDFS_DELEGATION_KIND)) {

INS23 INS31 INS78 INS83 INS83 INS83 INS43 INS59 INS83 INS39 INS42 INS44 INS43 INS8 INS42 INS42 INS42 MOV14 INS74 INS42 INS42 INS60 INS41 INS43 INS76 INS79 INS43 INS59 INS36 INS42 INS42 INS45 INS42 INS42 INS32 INS27 INS42 INS32 INS42 INS27 INS32 INS42 INS25 INS36 INS42 INS42 INS33 INS32 INS42 INS45 INS32 INS8 INS11 INS42 INS42 INS42 INS42 INS42 INS18 INS74 INS42 INS43 INS43 INS42 INS42 INS42 DEL42 DEL43 DEL45 DEL14 DEL42 DEL43 DEL45 DEL14 DEL42 DEL43 DEL45 DEL14