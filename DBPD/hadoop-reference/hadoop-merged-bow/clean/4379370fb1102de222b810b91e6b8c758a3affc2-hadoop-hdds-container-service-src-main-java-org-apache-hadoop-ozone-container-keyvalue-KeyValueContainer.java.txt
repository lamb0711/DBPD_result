HDDS-1981: Datanode should sync db when container is moved to CLOSED or QUASI_CLOSED state (#1319)


+    .Result.ERROR_IN_DB_SYNC;
+import static org.apache.hadoop.hdds.protocol.datanode.proto.ContainerProtos
+    // The DB must be synced during close operation
+    flushAndSyncDB();
+
+      // Second sync should be a very light operation as sync has already
+      // been done outside the lock.
+      flushAndSyncDB();
+    // The DB must be synced during close operation
+    flushAndSyncDB();
+
+      // Second sync should be a very light operation as sync has already
+      // been done outside the lock.
+      flushAndSyncDB();
-
-    // It is ok if this operation takes a bit of time.
-    // Close container is not expected to be instantaneous.
-    compactDB();
+  private void flushAndSyncDB() throws StorageContainerException {
+    try {
+      try (ReferenceCountedDB db = BlockUtils.getDB(containerData, config)) {
+        db.getStore().flushDB(true);
+        LOG.info("Container {} is synced with bcsId {}.",
+            containerData.getContainerID(),
+            containerData.getBlockCommitSequenceId());
+      }
+    } catch (StorageContainerException ex) {
+      throw ex;
+    } catch (IOException ex) {
+      LOG.error("Error in DB sync while closing container", ex);
+      throw new StorageContainerException(ex, ERROR_IN_DB_SYNC);
+    }
+  }
+

INS26 INS40 INS31 MOV21 INS83 INS39 INS42 INS43 INS8 INS21 INS42 INS54 INS32 INS8 INS12 INS12 INS42 INS21 UPD42 INS21 INS54 INS44 INS8 INS44 INS8 INS32 INS32 INS58 INS8 INS43 INS42 INS53 INS43 INS42 INS21 INS53 INS42 INS42 INS43 INS59 INS21 INS21 INS42 INS42 INS42 INS32 INS14 INS42 INS42 INS32 INS32 INS32 INS42 INS42 INS45 INS42 INS43 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS9 INS42 INS42 INS45 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42