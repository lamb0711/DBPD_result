HDFS-12217. HDFS snapshots doesn't capture all open files when one of the open files is deleted.

-  public Set<INodesInPath> getINodeWithLeases() {
+  @VisibleForTesting
+  Set<INodesInPath> getINodeWithLeases() throws IOException {
-    int inodeCount = 0;
-    INode[] inodes = new INode[leasesById.size()];
+    List<INode> inodes = new ArrayList<>(leasesById.size());
+    INode currentINode;
-      inodes[inodeCount] = fsnamesystem.getFSDirectory().getInode(inodeId);
-      inodeCount++;
+      currentINode = fsnamesystem.getFSDirectory().getInode(inodeId);
+      // A file with an active lease could get deleted, or its
+      // parent directories could get recursively deleted.
+      if (currentINode != null &&
+          currentINode.isFile() &&
+          !fsnamesystem.isFileDeleted(currentINode.asFile())) {
+        inodes.add(currentINode);
+      }
-    return inodes;
+    return inodes.toArray(new INode[0]);
-      ancestorDir) {
+      ancestorDir) throws IOException {
-        LOG.warn("INode filter task encountered exception: ", e);
+        throw new IOException("Failed to get files with active leases", e);

INS78 INS43 INS43 INS42 INS42 INS42 INS74 INS43 INS8 INS32 INS43 INS43 UPD42 INS14 MOV42 UPD42 MOV21 INS25 INS42 INS42 MOV3 INS42 INS42 INS74 MOV32 INS27 INS8 INS34 INS43 INS42 INS27 INS38 MOV21 INS42 INS27 INS32 INS32 INS32 INS53 INS42 INS33 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS14 INS42 INS42 INS43 INS45 INS42 INS42 DEL83 DEL39 DEL34 DEL43 DEL85 DEL5 DEL42 DEL42 DEL2 DEL42 DEL37 DEL8 DEL42 DEL42 DEL42 DEL45 DEL42 DEL32 DEL21