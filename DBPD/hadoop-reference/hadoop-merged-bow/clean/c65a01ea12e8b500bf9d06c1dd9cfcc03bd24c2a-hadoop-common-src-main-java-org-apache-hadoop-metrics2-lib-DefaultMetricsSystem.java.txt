Merge trunk into HDFS-1623 branch.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1158072 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.concurrent.atomic.AtomicReference;
-  private MetricsSystem impl = new MetricsSystemImpl();
+  private AtomicReference<MetricsSystem> impl =
+      new AtomicReference<MetricsSystem>(new MetricsSystemImpl());
-  synchronized MetricsSystem init(String prefix) {
-    return impl.init(prefix);
+  MetricsSystem init(String prefix) {
+    return impl.get().init(prefix);
-  synchronized void shutdownInstance() {
-    if (impl.shutdown()) {
+  void shutdownInstance() {
+    boolean last = impl.get().shutdown();
+    if (last) synchronized(this) {
-  synchronized MetricsSystem setImpl(MetricsSystem ms) {
-    MetricsSystem old = impl;
-    impl = ms;
-    return old;
+  MetricsSystem setImpl(MetricsSystem ms) {
+    return impl.getAndSet(ms);
-  synchronized MetricsSystem getImpl() { return impl; }
+  MetricsSystem getImpl() { return impl.get(); }

INS26 INS40 INS74 MOV43 INS43 MOV43 INS14 INS60 INS41 INS42 INS74 MOV14 INS39 INS59 INS42 INS51 INS32 INS32 INS43 MOV43 INS32 INS42 INS32 INS52 MOV8 INS42 INS42 INS42 INS42 INS42 INS42 MOV42 INS42 INS32 INS42 INS42 INS42 DEL83 DEL83 DEL42 DEL42 DEL32 DEL83 DEL42 DEL42 DEL59 DEL60 DEL42 DEL42 DEL7 DEL21 DEL42 DEL41 DEL83 DEL42