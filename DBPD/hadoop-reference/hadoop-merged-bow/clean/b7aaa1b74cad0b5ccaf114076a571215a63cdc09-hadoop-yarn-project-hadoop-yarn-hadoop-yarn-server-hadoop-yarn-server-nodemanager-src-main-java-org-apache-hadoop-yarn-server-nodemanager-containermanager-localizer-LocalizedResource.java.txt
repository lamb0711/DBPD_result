Merge trunk into the HDFS-347 branch.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-347@1467511 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerResourceFailedEvent;
+import org.apache.hadoop.yarn.server.nodemanager.containermanager.localizer.event.ResourceFailedLocalizationEvent;
+    .addTransition(ResourceState.DOWNLOADING, ResourceState.FAILED,
+        ResourceEventType.LOCALIZATION_FAILED, new FetchFailedTransition())
-    if (!ref.remove(container)) {
-      LOG.info("Attempt to release claim on " + this +
-               " from unregistered container " + container);
-      assert false; // TODO: FIX
+    if (ref.remove(container)) {
+      // updating the timestamp only in case of success.
+      timestamp.set(currentTime());
+    } else {
+      LOG.info("Container " + container
+          + " doesn't exist in the container list of the Resource " + this
+          + " to which it sent RELEASE event");
-    timestamp.set(currentTime());
+   * Resource localization failed, notify waiting containers.
+   */
+  @SuppressWarnings("unchecked")
+  private static class FetchFailedTransition extends ResourceTransition {
+    @Override
+    public void transition(LocalizedResource rsrc, ResourceEvent event) {
+      ResourceFailedLocalizationEvent failedEvent =
+          (ResourceFailedLocalizationEvent) event;
+      Queue<ContainerId> containers = rsrc.ref;
+      Throwable failureCause = failedEvent.getCause();
+      for (ContainerId container : containers) {
+        rsrc.dispatcher.getEventHandler().handle(
+          new ContainerResourceFailedEvent(container, failedEvent
+            .getLocalResourceRequest(), failureCause));
+      }
+    }
+  }
+
+  /**

INS26 INS26 INS40 INS40 INS55 INS29 INS79 INS83 INS83 INS42 INS43 INS31 INS32 INS65 INS42 INS45 INS42 INS78 INS83 INS39 INS42 INS44 INS44 INS8 MOV32 INS42 MOV32 INS8 INS66 INS42 INS43 INS42 INS43 INS42 INS60 INS60 INS60 INS70 UPD42 INS40 INS40 INS40 MOV14 MOV21 INS42 INS42 INS43 INS59 INS74 INS59 INS43 INS59 INS44 INS42 INS8 UPD40 INS42 INS42 INS11 INS43 INS43 INS42 INS40 INS42 INS42 INS32 INS43 INS42 INS21 UPD40 MOV14 INS43 INS42 INS42 INS42 INS42 INS42 INS42 INS32 UPD40 UPD40 UPD40 INS14 UPD45 INS45 INS52 INS45 INS42 INS32 INS42 INS14 INS43 INS40 INS42 INS43 INS42 INS32 INS42 INS42 INS42 INS42 INS42 DEL38 DEL45 DEL52 DEL9 DEL6