HDFS-14202. dfs.disk.balancer.max.disk.throughputInMBperSec property is not working as per set value. Contributed by Ranith Sardar.

-import static java.util.concurrent.TimeUnit.MILLISECONDS;
-import static java.util.concurrent.TimeUnit.SECONDS;
-
-    private long computeDelay(long bytesCopied, long timeUsed,
+    @VisibleForTesting
+    public long computeDelay(long bytesCopied, long timeUsed,
+      if (bytesCopied < megaByte) {
+        return 0;
+      }
-      long lastThroughput = bytesInMB / SECONDS.convert(timeUsed,
-          TimeUnit.MILLISECONDS);
-      long delay = (bytesInMB / getDiskBandwidth(item)) - lastThroughput;
-      return (delay <= 0) ? 0 : MILLISECONDS.convert(delay, TimeUnit.SECONDS);
+
+      // converting disk bandwidth in MB/millisec
+      float bandwidth = getDiskBandwidth(item) / 1000f;
+      float delay = ((long) (bytesInMB / bandwidth) - timeUsed);
+      return (delay <= 0) ? 0 : (long) delay;
-            Thread.sleep(computeDelay(block.getNumBytes(), timeUsed, item));
+            Thread.sleep(computeDelay(block.getNumBytes(), TimeUnit.NANOSECONDS
+                .toMillis(timeUsed), item));

INS78 UPD83 MOV60 INS42 INS25 INS27 INS8 UPD39 UPD39 INS42 INS42 INS41 UPD42 MOV27 UPD42 INS36 INS11 INS34 INS34 INS27 INS39 INS42 INS11 INS42 INS39 INS36 INS27 MOV42 INS42 INS32 INS40 INS42 MOV42 DEL40 DEL26 DEL40 DEL26 DEL42 DEL36 DEL42 DEL27 DEL42 DEL42 DEL42 DEL40 DEL32 DEL27 DEL42 DEL42 DEL42 DEL40 DEL32