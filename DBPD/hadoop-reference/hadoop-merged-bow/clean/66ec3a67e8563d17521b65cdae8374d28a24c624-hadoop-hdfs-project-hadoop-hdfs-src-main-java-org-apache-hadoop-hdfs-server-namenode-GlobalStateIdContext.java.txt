HDFS-13767. Add msync server implementation. Contributed by Chen Liang.

+import org.apache.hadoop.ha.HAServiceProtocol;
-    header.setStateId(namesystem.getLastWrittenTransactionId());
+    // Using getCorrectLastAppliedOrWrittenTxId will acquire the lock on
+    // FSEditLog. This is needed so that ANN will return the correct state id
+    // it currently has. But this may not be necessary for Observer, may want
+    // revisit for optimization. Same goes to receiveRequestState.
+    header.setStateId(getLastSeenStateId());
-  public void receiveRequestState(RpcRequestHeaderProto header) {
-    long serverStateId = namesystem.getLastWrittenTransactionId();
+  public long receiveRequestState(RpcRequestHeaderProto header) {
+    long serverStateId =
+        namesystem.getFSImage().getCorrectLastAppliedOrWrittenTxId();
-    if (clientStateId > serverStateId) {
+    if (clientStateId > serverStateId &&
+        HAServiceProtocol.HAServiceState.ACTIVE.equals(namesystem.getState())) {
+    return clientStateId;
+  @Override
+  public long getLastSeenStateId() {
+    return namesystem.getFSImage().getCorrectLastAppliedOrWrittenTxId();
+  }

INS26 INS40 INS31 UPD39 INS78 INS83 INS39 INS42 INS8 INS41 INS42 INS41 INS27 INS42 INS32 MOV27 INS32 INS32 INS42 UPD42 INS32 UPD42 INS40 INS42 INS32 INS42 INS42 MOV42 INS42 INS42 INS42 DEL42