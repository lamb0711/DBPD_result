HDFS-14856. Fetch file ACLs while mounting external store. (#1478)


+import com.google.common.annotations.VisibleForTesting;
+import org.apache.hadoop.fs.permission.AclStatus;
+  private final AclStatus acls;
-  protected TreePath(FileStatus stat, long parentId, TreeWalk.TreeIterator i,
-      FileSystem fs) {
+  @VisibleForTesting
+  public TreePath(FileStatus stat, long parentId, TreeWalk.TreeIterator i) {
+    this(stat, parentId, i, null, null);
+  }
+
+  public TreePath(FileStatus stat, long parentId, TreeWalk.TreeIterator i,
+      FileSystem fs, AclStatus acls) {
+    this.acls = acls;
+  public AclStatus getAclStatus() {
+    return acls;
+  }
+
+  public TreeWalk.TreeIterator getIterator() {
+    return i;
+  }
+
-  void accept(long id) {
-    this.id = id;
+  public void accept(long pathId) {
+    this.id = pathId;
-    ugi.addUser(s.getOwner());
-    ugi.addGroup(s.getGroup());
+    final AclStatus aclStatus = getAclStatus();
+    long permissions = ugi.getPermissionsProto(s, aclStatus);
-        .setPermission(ugi.resolve(s))
+        .setPermission(permissions)
-    // TODO: storage policy should be configurable per path; use BlockResolver
+    if (aclStatus != null) {
+      throw new UnsupportedOperationException(
+          "ACLs not supported by ImageWriter");
+    }
+    //TODO: storage policy should be configurable per path; use BlockResolver
-    ugi.addUser(s.getOwner());
-    ugi.addGroup(s.getGroup());
+    final AclStatus aclStatus = getAclStatus();
+    long permissions = ugi.getPermissionsProto(s, aclStatus);
-        .setPermission(ugi.resolve(s));
+        .setPermission(permissions);
+    if (aclStatus != null) {
+      throw new UnsupportedOperationException(
+          "ACLs not supported by ImageWriter");
+    }

INS26 INS26 INS40 INS40 INS23 INS31 INS31 INS31 INS83 INS83 INS43 INS59 INS78 INS83 INS42 INS44 INS44 INS44 INS8 UPD83 INS44 INS83 INS43 INS42 INS8 INS83 INS43 INS42 INS8 INS83 INS42 INS42 INS42 INS43 INS42 INS39 INS42 INS43 INS42 INS17 INS43 INS42 INS21 INS42 INS41 INS40 INS41 UPD42 INS60 INS60 INS25 INS60 INS60 INS25 INS42 INS40 INS42 INS42 INS42 INS33 INS33 INS42 INS7 INS42 INS42 INS83 INS43 INS59 INS39 INS59 INS27 INS8 INS83 INS43 INS59 INS39 INS59 INS27 INS8 INS22 INS42 UPD42 INS42 INS42 INS32 INS42 INS32 INS42 INS33 INS53 INS42 INS42 INS32 INS42 INS32 INS42 INS33 INS53 INS52 INS42 UPD42 MOV42 MOV42 UPD42 MOV42 MOV42 UPD42 MOV42 INS14 UPD42 MOV42 MOV42 UPD42 MOV42 MOV42 UPD42 MOV42 UPD42 MOV42 INS14 UPD42 MOV42 INS43 INS45 INS43 INS45 INS42 INS42 DEL42 DEL42 DEL42 DEL32 DEL32 DEL21 DEL32 DEL32 DEL21 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32 DEL32 DEL21 DEL32 DEL32 DEL21 DEL42 DEL42 DEL32