HDFS-3731. 2.0 release upgrade must handle blocks being written from 1.0. Contributed by Colin Patrick McCabe


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1377137 13f79535-47bb-0310-9956-ffa450edef68

+    File bbwDir = new File(sd.getRoot(), Storage.STORAGE_1_BBW);
+
-    linkAllBlocks(tmpDir, new File(curBpDir, STORAGE_DIR_CURRENT));
+    linkAllBlocks(tmpDir, bbwDir, new File(curBpDir, STORAGE_DIR_CURRENT));
+    final File bbwDir = new File(sd.getRoot(), Storage.STORAGE_1_BBW);
+    // Also delete the blocksBeingWritten from HDFS 1.x and earlier, if
+    // it exists.
+            if (bbwDir.exists()) {
+              deleteDir(bbwDir);
+            }
-   * @param fromDir directory where the snapshot is stored
-   * @param toDir the current data directory
-   * @throws IOException if error occurs during hardlink
+   *
+   * @param fromDir      The directory where the 'from' snapshot is stored
+   * @param fromBbwDir   In HDFS 1.x, the directory where blocks
+   *                     that are under construction are stored.
+   * @param toDir        The current data directory
+   *
+   * @throws IOException If error occurs during hardlink
-  private void linkAllBlocks(File fromDir, File toDir) throws IOException {
+  private void linkAllBlocks(File fromDir, File fromBbwDir, File toDir)
+      throws IOException {
-      // hardlink rbw blocks in tmpDir/finalized
+      // hardlink rbw blocks in tmpDir/rbw
+      if (fromBbwDir.exists()) {
+        /*
+         * We need to put the 'blocksBeingWritten' from HDFS 1.x into the rbw
+         * directory.  It's a little messy, because the blocksBeingWriten was
+         * NOT underneath the 'current' directory in those releases.  See
+         * HDFS-3731 for details.
+         */
+        linkBlocks(fromBbwDir,
+            new File(toDir, STORAGE_DIR_RBW), diskLayoutVersion, hardLink);
+      }

INS44 INS60 INS60 INS65 INS43 INS42 INS43 INS59 INS83 INS43 INS59 UPD66 INS42 INS66 INS66 UPD66 UPD66 INS42 INS42 INS42 INS14 INS42 INS42 INS42 INS14 INS25 INS43 INS32 INS40 INS43 INS32 INS40 INS32 INS8 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS21 INS32 INS42 INS42 INS14 INS42 INS42 INS43 INS42 INS42 INS42 INS25 INS32 INS8 INS42 INS42 INS21 INS32 INS42 INS42