YARN-60. Fixed a bug in ResourceManager which causes all NMs to get NPEs and thus causes all containers to be rejected. Contributed by Vinod Kumar Vavilapalli.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1379550 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.yarn.server.api.records.MasterKey;
+import org.apache.hadoop.yarn.server.api.records.RegistrationResponse;
+  private MasterKey currentMasterKey;
-  MockNM(String nodeIdStr, int memory, ResourceTrackerService resourceTracker) {
+  public MockNM(String nodeIdStr, int memory, ResourceTrackerService resourceTracker) {
-  public NodeId registerNode() throws Exception {
+  public RegistrationResponse registerNode() throws Exception {
-    resourceTracker.registerNodeManager(req);
-    return nodeId;
+    RegistrationResponse registrationResponse =
+        resourceTracker.registerNodeManager(req).getRegistrationResponse();
+    this.currentMasterKey = registrationResponse.getMasterKey();
+    return registrationResponse;
-  public HeartbeatResponse nodeHeartbeat(boolean b) throws Exception {
+  public HeartbeatResponse nodeHeartbeat(boolean isHealthy) throws Exception {
-        b, ++responseId);
+        isHealthy, ++responseId);
-    return resourceTracker.nodeHeartbeat(req).getHeartbeatResponse();
+    req.setLastKnownMasterKey(this.currentMasterKey);
+    HeartbeatResponse heartbeatResponse =
+        resourceTracker.nodeHeartbeat(req).getHeartbeatResponse();
+    MasterKey masterKeyFromRM = heartbeatResponse.getMasterKey();
+    this.currentMasterKey =
+        (masterKeyFromRM != null
+            && masterKeyFromRM.getKeyId() != this.currentMasterKey.getKeyId()
+            ? masterKeyFromRM : this.currentMasterKey);
+    return heartbeatResponse;

INS26 INS26 INS40 INS40 INS23 INS83 INS43 INS59 INS83 UPD43 INS42 INS42 UPD42 INS60 UPD42 INS21 INS60 INS60 INS21 INS43 INS59 INS7 UPD42 INS32 INS43 INS59 INS43 INS59 INS7 INS42 INS42 INS42 INS32 INS22 INS32 UPD42 INS42 INS42 INS22 INS42 INS42 MOV32 INS42 INS42 INS32 INS22 INS36 MOV32 INS42 INS52 INS42 INS42 INS42 INS52 INS42 INS42 INS42 INS52 INS42 INS16 INS27 INS42 INS22 INS27 INS27 INS52 INS42 INS42 INS33 INS32 INS32 INS42 INS42 INS22 INS42 INS52 INS42