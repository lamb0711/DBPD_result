Merge trunk into auto-failover branch


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-3042@1309164 13f79535-47bb-0310-9956-ffa450edef68

-  // allow appending to hdfs files
-  private boolean supportAppends = true;
+
+  private boolean supportAppends;
-    if (supportAppends == false) {
-      throw new UnsupportedOperationException("Append to hdfs not supported." +
-                            " Please refer to dfs.support.append configuration parameter.");
+    if (!supportAppends) {
+      throw new UnsupportedOperationException(
+          "Append is not enabled on this NameNode. Use the " +
+          DFS_SUPPORT_APPEND_KEY + " configuration option to enable it.");
-      } else if (supportAppends) {
+      } else {
-        // only if append is supported or we're explicitly told to
-    if (supportAppends || persistBlocks) {
-      getEditLog().logSync();
-    }
+    getEditLog().logSync();
-    // persist blocks only if append is supported
-    if (supportAppends) {
-      dir.persistBlocks(src, pendingFile);
-    }
+    dir.persistBlocks(src, pendingFile);

MOV21 MOV21 INS38 INS42 MOV25 UPD42 MOV8 UPD45 INS42 UPD45 DEL9 DEL42 DEL9 DEL27 DEL42 DEL25 DEL42 DEL42 DEL27 DEL8 DEL25 DEL42 DEL8 DEL25