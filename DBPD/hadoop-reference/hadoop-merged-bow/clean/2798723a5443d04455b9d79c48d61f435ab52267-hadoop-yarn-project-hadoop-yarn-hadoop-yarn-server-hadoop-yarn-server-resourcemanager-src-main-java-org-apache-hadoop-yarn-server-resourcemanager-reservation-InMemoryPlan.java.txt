YARN-3739. Add reservation system recovery to RM recovery process. Contributed by  Subru Krishnan.

+import org.apache.hadoop.yarn.server.resourcemanager.recovery.RMStateStore;
-  private final RMContext rmContext;
+  private final RMStateStore rmStateStore;
-    this.rmContext = rmContext;
+    this.rmStateStore = rmContext.getStateStore();
-  public boolean addReservation(ReservationAllocation reservation)
-      throws PlanningException {
+  public boolean addReservation(ReservationAllocation reservation,
+      boolean isRecovering) throws PlanningException {
-      policy.validate(this, inMemReservation);
-      // we record here the time in which the allocation has been accepted
-      reservation.setAcceptanceTimestamp(clock.getTime());
+      if (!isRecovering) {
+        policy.validate(this, inMemReservation);
+        // we record here the time in which the allocation has been accepted
+        reservation.setAcceptanceTimestamp(clock.getTime());
+        if (rmStateStore != null) {
+          rmStateStore.storeNewReservation(
+              ReservationSystemUtil.buildStateProto(inMemReservation),
+              getQueueName(), inMemReservation.getReservationId().toString());
+        }
+      }
-      rmContext.getStateStore().storeNewReservation(
-          ReservationSystemUtil.buildStateProto(inMemReservation),
-          getQueueName(), inMemReservation.getReservationId().toString());
-        result = addReservation(reservation);
+        result = addReservation(reservation, false);
-        addReservation(currReservation);
+        addReservation(currReservation, false);
+      if (rmStateStore != null) {
+        rmStateStore.removeReservation(getQueueName(),
+            reservation.getReservationId().toString());
+      }
-    rmContext.getStateStore().removeReservation(
-        getQueueName(), reservation.getReservationId().toString());

INS26 INS40 UPD43 INS44 UPD42 UPD42 INS39 INS42 MOV32 INS25 INS25 UPD42 INS42 INS38 INS8 INS27 INS8 INS42 MOV21 MOV21 INS25 INS42 INS33 INS21 INS27 INS8 INS32 INS42 INS33 MOV21 INS9 INS42 INS42 MOV32 MOV32 INS9 UPD42 MOV42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL21