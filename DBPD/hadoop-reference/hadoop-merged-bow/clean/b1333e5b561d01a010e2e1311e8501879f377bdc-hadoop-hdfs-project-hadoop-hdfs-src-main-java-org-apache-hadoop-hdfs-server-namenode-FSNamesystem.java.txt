HDFS-4545. With snapshots, FSDirectory.unprotectedSetReplication(..) always changes file replication but it may or may not changes block replication.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1452636 13f79535-47bb-0310-9956-ffa450edef68

-      final short[] oldReplication = new short[1];
-      final Block[] blocks = dir.setReplication(src, replication, oldReplication);
+      final short[] blockRepls = new short[2]; // 0: old, 1: new
+      final Block[] blocks = dir.setReplication(src, replication, blockRepls);
-        blockManager.setReplication(oldReplication[0], replication, src, blocks);
+        blockManager.setReplication(blockRepls[0], blockRepls[1], src, blocks);
-    final INode myFile = iip.getLastINode();
-    if (myFile != null && myFile.isDirectory()) {
+    final INode inode = iip.getLastINode();
+    if (inode != null && inode.isDirectory()) {
+    final INodeFile myFile = INodeFile.valueOf(inode, src, true);
-  private void recoverLeaseInternal(INode fileInode, 
+  private void recoverLeaseInternal(INodeFile fileInode, 
-    final INodesInPath inodesInPath = dir.getINodesInPath4Write(src);
-    final INode[] inodes = inodesInPath.getINodes();
+    final INodesInPath iip = dir.getINodesInPath4Write(src);
-        = checkLease(src, fileId, clientName, inodes[inodes.length - 1]);
+        = checkLease(src, fileId, clientName, iip.getLastINode());
-        return inodesInPath;
+        return iip;
-    return inodesInPath;
+    return iip;
-      String holder, INode file) throws LeaseExpiredException,
+      String holder, INode inode) throws LeaseExpiredException,
-    if (file == null || !(file instanceof INodeFile)) {
+    if (inode == null || !inode.isFile()) {
+    final INodeFile file = inode.asFile();
-      if (inode != null && inode instanceof INodeFile && !inode.isUnderConstruction()) {
+      if (inode != null
+          && inode.isFile()
+          && !inode.asFile().isUnderConstruction()) {
-        final Block realLastBlock = ((INodeFile)inode).getLastBlock();
+        final Block realLastBlock = inode.asFile().getLastBlock();
-      INodeFile iFile = (INodeFile) storedBlock.getBlockCollection();
+      INodeFile iFile = ((INode)storedBlock.getBlockCollection()).asFile();
-    INodeFile file = (INodeFile) storedBlock.getBlockCollection();
+    final INodeFile file = ((INode)storedBlock.getBlockCollection()).asFile();
-        INode inode = (INodeFile) blockManager.getBlockCollection(blk);
+        final INode inode = (INode)blockManager.getBlockCollection(blk);

INS60 MOV43 UPD42 INS60 INS83 MOV43 INS59 UPD42 INS83 MOV43 INS59 INS83 MOV43 UPD42 INS42 INS32 UPD42 INS42 INS32 INS32 UPD42 UPD42 INS42 INS42 INS42 INS42 INS9 INS32 UPD42 INS32 INS42 INS42 MOV43 INS36 INS42 UPD42 INS42 INS42 INS42 INS42 INS32 MOV11 UPD34 UPD42 INS36 INS42 MOV43 INS83 INS43 INS2 UPD42 INS32 MOV11 INS42 UPD42 INS42 INS34 INS42 INS42 INS32 MOV43 MOV43 MOV42 INS42 INS32 INS42 INS42 DEL42 DEL83 DEL85 DEL5 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL42 DEL40 DEL34 DEL27 DEL2 DEL42 DEL62 DEL36 DEL42 DEL62 DEL42 DEL11 DEL36 DEL42 DEL43 DEL42 DEL43 DEL42 DEL43