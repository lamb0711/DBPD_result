HDFS-7056. Snapshot support for truncate. Contributed by Konstantin Shvachko and Plamen Jeliazkov.
-  private final int getPrior(int anchorId, boolean exclusive) {
+  public final int getPrior(int anchorId, boolean exclusive) {
-      return getLastSnapshotId();
+      int last = getLastSnapshotId();
+      if(exclusive && last == anchorId)
+        return Snapshot.NO_SNAPSHOT_ID;
+      return last;
-  public void saveSelf2Snapshot(int latestSnapshotId, N currentINode,
+  public D saveSelf2Snapshot(int latestSnapshotId, N currentINode,
+    D diff = null;
-      D diff = checkAndAddLatestSnapshotDiff(latestSnapshotId, currentINode);
+      diff = checkAndAddLatestSnapshotDiff(latestSnapshotId, currentINode);
+    return diff;
-}
+}

UPD83 MOV43 INS60 INS41 INS43 INS59 INS42 INS60 INS25 INS41 INS42 INS42 INS33 INS21 INS39 INS59 INS27 INS41 INS42 INS7 INS42 MOV32 INS42 INS27 INS40 INS42 MOV32 INS42 INS42 DEL41 DEL39 DEL42 DEL59 DEL60