merge trunk to branch HDFS-4949

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-4949@1532952 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.concurrent.atomic.AtomicReference;
-import org.mortbay.log.Log;
-  private volatile IOException lastException = null;
+  private final AtomicReference<IOException> lastException = new AtomicReference<IOException>();
-          lastException = new IOException("Failing write. Tried pipeline " +
-              "recovery 5 times without success.");
+          lastException.set(new IOException("Failing write. Tried pipeline " +
+              "recovery 5 times without success."));
-            lastException = new IOException("All datanodes " + pipelineMsg
-                + " are bad. Aborting...");
+            lastException.set(new IOException("All datanodes " + pipelineMsg
+                + " are bad. Aborting..."));
-          lastException = null;
+          lastException.set(null);
-        lastException = null;
+        lastException.set(null);
-      if (lastException == null) {
-        lastException = e;
-      }
+      lastException.compareAndSet(null, e);
-      IOException e = lastException;
+      IOException e = lastException.get();
+      try {
+      } catch (ClosedChannelException e) {
+      }
-          lastException = new IOException("IOException flush:" + e);
+          lastException.set(new IOException("IOException flush:" + e));
-    synchronized (dataQueue) {
-      while (!closed) {
-        checkClosed();
-        if (lastAckedSeqno >= seqno) {
-          break;
-        }
-        try {
-          dataQueue.wait(1000); // when we receive an ack, we notify on dataQueue
-        } catch (InterruptedException ie) {
-          throw new InterruptedIOException(
-            "Interrupted while waiting for data to be acknowledged by pipeline");
+    try {
+      synchronized (dataQueue) {
+        while (!closed) {
+          checkClosed();
+          if (lastAckedSeqno >= seqno) {
+            break;
+          }
+          try {
+            dataQueue.wait(1000); // when we receive an ack, we notify on
+                                  // dataQueue
+          } catch (InterruptedException ie) {
+            throw new InterruptedIOException(
+                "Interrupted while waiting for data to be acknowledged by pipeline");
+          }
+      checkClosed();
+    } catch (ClosedChannelException e) {
-    checkClosed();
-      IOException e = lastException;
+      IOException e = lastException.getAndSet(null);
+    } catch (ClosedChannelException e) {

MOV26 UPD40 UPD83 INS74 INS43 MOV43 INS14 INS8 INS54 INS42 INS74 MOV21 INS8 INS8 INS12 INS12 INS43 INS43 INS32 INS54 MOV51 MOV21 INS44 INS8 INS44 INS8 INS42 INS42 INS42 INS42 INS33 INS42 MOV8 INS12 INS43 INS42 INS43 INS42 INS32 INS32 INS44 INS8 INS42 INS32 INS42 INS42 INS42 INS33 INS42 INS42 INS43 INS42 INS42 INS42 INS33 INS32 INS32 INS42 INS42 INS42 MOV14 INS42 INS42 INS33 INS32 INS32 INS42 INS42 MOV14 INS42 INS42 MOV14 DEL33 DEL42 DEL7 DEL42 DEL7 DEL42 DEL33 DEL7 DEL42 DEL33 DEL7 DEL42 DEL42 DEL7 DEL42 DEL33 DEL27 DEL8 DEL25 DEL8 DEL42 DEL42 DEL7 DEL42