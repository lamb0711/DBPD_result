Merge trunk to HDFS-4685.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-4685@1556097 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.yarn.api.records.ApplicationId;
-import org.apache.hadoop.yarn.server.resourcemanager.scheduler.SchedulerApplication;
-  Map<ApplicationAttemptId, FiCaSchedulerApp> applicationsMap = 
+  Map<ApplicationAttemptId, FiCaSchedulerApp> applicationAttemptMap = 
-  public void submitApplication(FiCaSchedulerApp application, String userName,
+  public void submitApplicationAttempt(FiCaSchedulerApp application,
+      String userName) {
+    // Careful! Locking order is important!
+    synchronized (this) {
+      User user = getUser(userName);
+      // Add the attempt to our data-structures
+      addApplicationAttempt(application, user);
+    }
+
+    int attemptId = application.getApplicationAttemptId().getAttemptId();
+    metrics.submitApp(userName, attemptId);
+    getParent().submitApplicationAttempt(application, userName);
+  }
+
+  @Override
+  public void submitApplication(ApplicationId applicationId, String userName,
-        " is STOPPED. Cannot accept submission of application: " +
-        application.getApplicationId();
+        " is STOPPED. Cannot accept submission of application: " + applicationId;
-        " cannot accept submission of application: " + 
-        application.getApplicationId();
+        " cannot accept submission of application: " + applicationId;
-        " cannot accept submission of application: " + 
-        application.getApplicationId();
+        " cannot accept submission of application: " + applicationId;
-
-      // Add the application to our data-structures
-      addApplication(application, user);
-    int attemptId = application.getApplicationAttemptId().getAttemptId();
-    metrics.submitApp(userName, attemptId);
-
-      getParent().submitApplication(application, userName, queue);
+      getParent().submitApplication(applicationId, userName, queue);
-      removeApplication(application, user);
-  private synchronized void addApplication(FiCaSchedulerApp application, User user) {
+  private synchronized void addApplicationAttempt(FiCaSchedulerApp application, User user) {
-    applicationsMap.put(application.getApplicationAttemptId(), application);
+    applicationAttemptMap.put(application.getApplicationAttemptId(), application);
-  public void finishApplication(FiCaSchedulerApp application, String queue) {
-    // Careful! Locking order is important!
-    synchronized (this) {
-      removeApplication(application, getUser(application.getUser()));
-    }
-
+  public void finishApplication(ApplicationId application, String user) {
+    // Inform the activeUsersManager
+    activeUsersManager.deactivateApplication(user, application);
-    getParent().finishApplication(application, queue);
+    getParent().finishApplication(application, user);
-  public synchronized void removeApplication(FiCaSchedulerApp application, User user) {
+  @Override
+  public void finishApplicationAttempt(FiCaSchedulerApp application, String queue) {
+    // Careful! Locking order is important!
+    synchronized (this) {
+      removeApplicationAttempt(application, getUser(application.getUser()));
+    }
+    getParent().finishApplicationAttempt(application, queue);
+  }
+
+  public synchronized void removeApplicationAttempt(FiCaSchedulerApp application, User user) {
-    applicationsMap.remove(application.getApplicationAttemptId());
+    applicationAttemptMap.remove(application.getApplicationAttemptId());
-    
-    // Inform the activeUsersManager
-    synchronized (application) {
-      activeUsersManager.deactivateApplication(
-          application.getUser(), application.getApplicationId());
-    }
-    
+
-  
+
-    return applicationsMap.get(applicationAttemptId);
+    return applicationAttemptMap.get(applicationAttemptId);

MOV26 UPD40 INS31 INS31 INS78 INS83 INS39 INS42 MOV44 INS44 INS8 INS44 UPD42 INS78 INS83 INS39 INS42 INS44 INS44 INS8 UPD42 UPD42 UPD42 INS42 INS43 INS42 INS51 MOV60 MOV21 INS21 INS43 INS42 INS42 INS43 INS42 INS43 INS42 INS21 INS21 INS42 INS52 INS8 INS32 INS42 INS42 INS42 INS32 INS32 INS60 INS21 INS32 INS42 INS42 INS42 UPD42 INS42 INS42 INS42 INS42 MOV32 INS42 INS42 INS42 INS32 UPD42 UPD42 UPD42 INS43 INS59 INS32 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 UPD42 UPD42 INS42 INS42 INS42 INS42 INS42 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32 DEL21 DEL42 DEL42 DEL42 DEL32 DEL21 DEL42 DEL42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL32 DEL21 DEL8 DEL51