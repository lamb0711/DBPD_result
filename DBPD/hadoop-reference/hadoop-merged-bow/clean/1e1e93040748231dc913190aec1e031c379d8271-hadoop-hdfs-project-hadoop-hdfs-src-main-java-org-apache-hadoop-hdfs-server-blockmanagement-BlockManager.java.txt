HDFS-7837. Erasure Coding: allocate and persist striped blocks in NameNode. Contributed by Jing Zhao.

-  /**
-   * @return true if the block has minimum replicas
-   */
-  public boolean checkMinReplication(Block block) {
-    return (countNodes(block).liveReplicas() >= minReplication);
+  public int getDefaultStorageNum(BlockInfo block) {
+    return block.isStriped() ?
+        ((BlockInfoStriped) block).getTotalBlockNum() : defaultReplication;
+  }
+
+  public short getMinStorageNum(BlockInfo block) {
+    return block.isStriped() ?
+        ((BlockInfoStriped) block).getDataBlockNum() : minReplication;
+  }
+
+  public boolean checkMinStorage(BlockInfo block) {
+    return countNodes(block).liveReplicas() >= getMinStorageNum(block);
+  }
+
+  public boolean checkMinStorage(BlockInfo block, int liveNum) {
+    return liveNum >= getMinStorageNum(block);
-    if (countNodes(lastBlock).liveReplicas() >= minReplication) {
+    if (checkMinStorage(lastBlock)) {
-    if (!force && numNodes < minReplication) {
+    if (!force && !checkMinStorage(curBlock, numNodes)) {
-      final BlockInfoContiguousUnderConstruction block) throws IOException {
-    // TODO: support BlockInfoStripedUC for editlog
-    block.commitBlock(block);
+      final BlockInfo block) throws IOException {
+    BlockInfo.commitBlock(block, block);
-        targets.length >= minReplication ? -1 : 0,
+        checkMinStorage(oldBlock, targets.length) ? -1 : 0,
-    boolean minReplicationSatisfied =
-        numberOfReplicas.liveReplicas() >= minReplication;
+    boolean minReplicationSatisfied = checkMinStorage(b.stored,
+        numberOfReplicas.liveReplicas());
-        && numCurrentReplica >= minReplication) {
+        && checkMinStorage(storedBlock, numCurrentReplica)) {
-        numLiveReplicas >= minReplication) {
+        checkMinStorage(storedBlock, numLiveReplicas)) {
+   * For a striped block, this includes nodes storing blocks belonging to the
+   * striped block group.
-          new Block(BlockIdManager.convertToGroupID(block.getBlockId())));
+          new Block(BlockIdManager.convertToStripedID(block.getBlockId())));

INS31 INS31 INS31 INS83 INS39 INS42 INS44 INS8 INS83 INS39 INS42 INS44 INS8 UPD42 INS83 INS39 INS42 INS44 INS44 INS8 INS43 INS42 INS41 INS43 INS42 INS41 UPD43 INS43 INS42 INS39 INS42 INS41 UPD43 INS42 INS16 INS42 INS16 UPD42 MOV27 INS42 INS27 INS32 UPD42 INS66 INS66 INS32 INS32 INS42 INS32 INS32 INS42 INS32 INS42 INS32 UPD42 MOV42 MOV42 INS38 UPD42 INS42 INS32 INS32 INS32 INS42 INS42 INS36 INS42 INS42 INS42 INS36 INS42 INS42 INS42 INS42 INS42 INS32 INS32 INS42 INS40 MOV32 INS42 INS42 INS42 INS42 INS42 INS42 INS11 INS11 INS42 INS42 INS42 INS42 INS42 INS40 INS43 INS42 INS43 INS42 INS42 INS42 UPD42 DEL66 DEL65 DEL29 DEL42 DEL36 DEL32 DEL42 DEL32 DEL42 DEL27 DEL42 DEL42 DEL27 DEL40 DEL42 DEL27 DEL42 DEL27 DEL42 DEL42 DEL27 DEL42 DEL42 DEL27