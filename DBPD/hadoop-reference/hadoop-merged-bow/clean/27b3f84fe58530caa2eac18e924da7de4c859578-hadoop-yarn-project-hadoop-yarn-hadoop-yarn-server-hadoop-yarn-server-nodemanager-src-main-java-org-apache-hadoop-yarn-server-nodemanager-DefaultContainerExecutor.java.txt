Merge trunk to HDFS-2802 branch. This involves fixing many conflict with HDFS-4434.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1470225 13f79535-47bb-0310-9956-ffa450edef68

+import com.google.common.annotations.VisibleForTesting;
+
-    protected LocalWrapperScriptBuilder(Path wrapperScriptPath) {
-      this.wrapperScriptPath = wrapperScriptPath;
+    protected LocalWrapperScriptBuilder(Path containerWorkDir) {
+      this.wrapperScriptPath = new Path(containerWorkDir,
+        Shell.appendScriptExtension("default_container_executor"));
-      super(new Path(containerWorkDir, "default_container_executor.sh"));
+      super(containerWorkDir);
-      String exec = ContainerExecutor.isSetsidAvailable? "exec setsid" : "exec";
+      String exec = Shell.isSetsidAvailable? "exec setsid" : "exec";
-      super(new Path(containerWorkDir, "default_container_executor.cmd"));
+      super(containerWorkDir);
-    final String sigpid = ContainerExecutor.isSetsidAvailable
-        ? "-" + pid
-        : pid;
-    LOG.debug("Sending signal " + signal.getValue() + " to pid " + sigpid
+    LOG.debug("Sending signal " + signal.getValue() + " to pid " + pid
-    if (!containerIsAlive(sigpid)) {
+    if (!containerIsAlive(pid)) {
-      killContainer(sigpid, signal);
+      killContainer(pid, signal);
-      if (!containerIsAlive(sigpid)) {
+      if (!containerIsAlive(pid)) {
-  private boolean containerIsAlive(String pid) throws IOException {
+  @VisibleForTesting
+  public static boolean containerIsAlive(String pid) throws IOException {
-      new ShellCommandExecutor(getCheckProcessIsAliveCommand(pid)).execute();
+      new ShellCommandExecutor(Shell.getCheckProcessIsAliveCommand(pid))
+        .execute();
-    new ShellCommandExecutor(getSignalKillCommand(signal.getValue(), pid))
+    new ShellCommandExecutor(Shell.getSignalKillCommand(signal.getValue(), pid))

INS26 INS40 INS78 UPD83 INS83 INS42 INS43 INS42 MOV8 INS42 INS42 INS42 INS14 UPD42 UPD42 MOV43 INS42 INS32 UPD40 UPD42 MOV8 INS42 INS42 INS42 INS45 UPD42 INS42 DEL42 DEL42 DEL42 DEL43 DEL42 DEL45 DEL14 DEL42 DEL43 DEL42 DEL45 DEL14 DEL83 DEL42 DEL43 DEL42 DEL40 DEL45 DEL42 DEL27 DEL42 DEL16 DEL59 DEL60