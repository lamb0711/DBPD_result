HDFS-11419. HDFS specific network topology classes with storage type info included. Contributed by Chen Liang.

-    return ReflectionUtils.newInstance(
-        conf.getClass(CommonConfigurationKeysPublic.NET_TOPOLOGY_IMPL_KEY,
-        NetworkTopology.class, NetworkTopology.class), conf);
+    return getInstance(conf, InnerNodeImpl.FACTORY);
-  InnerNode.Factory factory = InnerNodeImpl.FACTORY;
+  public static NetworkTopology getInstance(Configuration conf,
+      InnerNode.Factory factory) {
+    NetworkTopology nt = ReflectionUtils.newInstance(
+        conf.getClass(CommonConfigurationKeysPublic.NET_TOPOLOGY_IMPL_KEY,
+            NetworkTopology.class, NetworkTopology.class), conf);
+    return nt.init(factory);
+  }
+
+  protected NetworkTopology init(InnerNode.Factory factory) {
+    if (!factory.equals(this.factory)) {
+      // the constructor has initialized the factory to default. So only init
+      // again if another factory is specified.
+      this.factory = factory;
+      this.clusterMap = factory.newInnerNode(NodeBase.ROOT);
+    }
+    return this;
+  }
+
+  InnerNode.Factory factory;
-  InnerNode clusterMap = factory.newInnerNode(NodeBase.ROOT);
+  InnerNode clusterMap;
+  // keeping the constructor because other components like MR still uses this.
+    this.factory = InnerNodeImpl.FACTORY;
+    this.clusterMap = factory.newInnerNode(NodeBase.ROOT);

INS31 INS31 MOV29 INS83 INS83 INS43 INS42 INS44 INS8 INS43 INS44 INS83 INS43 INS42 INS44 INS8 INS42 INS43 INS42 INS41 INS42 INS43 INS42 INS60 INS42 INS43 INS42 INS25 INS41 INS21 INS21 INS42 INS32 INS40 MOV43 INS59 INS32 INS40 INS38 INS8 INS52 INS7 INS7 INS42 INS42 INS40 INS42 MOV32 INS42 INS42 INS42 INS32 INS21 INS21 INS22 INS40 INS22 INS32 INS42 INS42 INS22 INS7 INS7 INS52 INS42 INS52 INS42 INS42 INS42 INS40 INS52 INS42 INS22 INS42 INS22 MOV32 INS52 INS42 INS52 INS42 DEL40