YARN-4519. Potential deadlock of CapacityScheduler between decrease container and assign containers. Contributed by Meng Ding

+import org.apache.hadoop.yarn.server.resourcemanager.RMContext;
-  RMContainer rmContainer;
-  Resource targetCapacity;
-  SchedulerNode schedulerNode;
-  Resource deltaCapacity;
+  private RMContext rmContext;
+  private RMContainer rmContainer;
+  private Resource targetCapacity;
+  private SchedulerNode schedulerNode;
+  private Resource deltaCapacity;
-  public SchedContainerChangeRequest(SchedulerNode schedulerNode,
+  public SchedContainerChangeRequest(
+      RMContext rmContext, SchedulerNode schedulerNode,
+    this.rmContext = rmContext;
-    deltaCapacity = Resources.subtract(targetCapacity,
-        rmContainer.getAllocatedResource());
+  public RMContext getRmContext() {
+    return this.rmContext;
+  }
-   * Delta capacity = before - target, so if it is a decrease request, delta
+   * Delta capacity = target - before, so if it is a decrease request, delta
-  public Resource getDeltaCapacity() {
+  public synchronized Resource getDeltaCapacity() {
+    // Only calculate deltaCapacity once
+    if (deltaCapacity == null) {
+      deltaCapacity = Resources.subtract(
+          targetCapacity, rmContainer.getAllocatedResource());
+    }
-  
+
-        + targetCapacity + ", delta=" + deltaCapacity + ", node="
-        + getNodeId().toString() + ">";
+        + targetCapacity + ", node=" + getNodeId().toString() + ">";

INS26 INS40 INS23 INS31 INS83 INS43 INS59 INS83 INS83 INS83 INS83 INS44 INS83 INS43 INS42 INS8 INS83 INS8 INS42 INS42 INS43 INS42 INS21 INS42 INS41 INS25 MOV41 INS42 INS7 INS22 UPD66 INS27 INS8 INS22 INS42 INS52 INS42 INS42 INS33 MOV21 INS52 INS42 DEL8 DEL45 DEL42