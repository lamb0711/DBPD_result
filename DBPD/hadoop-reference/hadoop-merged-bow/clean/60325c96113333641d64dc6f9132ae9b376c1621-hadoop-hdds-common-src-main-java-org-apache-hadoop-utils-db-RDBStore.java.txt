HDDS-1391 : Add ability in OM to serve delta updates through an API. (#1033)


+import org.rocksdb.TransactionLogIterator;
+  @Override
+  public DBUpdatesWrapper getUpdatesSince(long sequenceNumber)
+      throws SequenceNumberNotFoundException {
+
+    DBUpdatesWrapper dbUpdatesWrapper = new DBUpdatesWrapper();
+    try {
+      TransactionLogIterator transactionLogIterator =
+          db.getUpdatesSince(sequenceNumber);
+
+      // Only the first record needs to be checked if its seq number <
+      // ( 1 + passed_in_sequence_number). For example, if seqNumber passed
+      // in is 100, then we can read from the WAL ONLY if the first sequence
+      // number is <= 101. If it is 102, then 101 may already be flushed to
+      // SST. If it 99, we can skip 99 and 100, and then read from 101.
+
+      boolean checkValidStartingSeqNumber = true;
+
+      while (transactionLogIterator.isValid()) {
+        TransactionLogIterator.BatchResult result =
+            transactionLogIterator.getBatch();
+        long currSequenceNumber = result.sequenceNumber();
+        if (checkValidStartingSeqNumber &&
+            currSequenceNumber > 1 + sequenceNumber) {
+          throw new SequenceNumberNotFoundException("Unable to read data from" +
+              " RocksDB wal to get delta updates. It may have already been" +
+              "flushed to SSTs.");
+        }
+        // If the above condition was not satisfied, then it is OK to reset
+        // the flag.
+        checkValidStartingSeqNumber = false;
+        if (currSequenceNumber <= sequenceNumber) {
+          transactionLogIterator.next();
+          continue;
+        }
+        dbUpdatesWrapper.addWriteBatch(result.writeBatch().data(),
+            result.sequenceNumber());
+        transactionLogIterator.next();
+      }
+    } catch (RocksDBException e) {
+      LOG.error("Unable to get delta updates since sequenceNumber {} ",
+          sequenceNumber, e);
+    }
+    return dbUpdatesWrapper;
+  }
+

INS26 INS40 INS31 INS78 INS83 INS43 INS42 INS44 INS43 INS8 INS42 INS42 INS39 INS42 INS42 INS60 INS54 INS41 INS43 INS59 INS8 INS12 INS42 INS42 INS42 INS14 INS60 INS60 INS61 INS44 INS8 INS43 INS43 INS59 INS39 INS59 INS32 INS8 INS43 INS42 INS21 INS42 INS42 INS42 INS32 INS42 INS9 INS42 INS42 INS60 INS60 INS25 INS21 INS25 INS21 INS21 INS42 INS32 INS42 INS42 INS42 INS43 INS59 INS39 INS59 INS27 INS8 INS7 INS27 INS8 INS32 INS32 INS42 INS42 INS45 INS42 INS42 INS40 INS42 INS32 INS42 INS32 INS42 INS27 INS53 INS42 INS9 INS42 INS42 INS21 INS18 INS42 INS42 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS27 INS14 INS32 INS32 INS42 INS42 INS42 INS34 INS42 INS43 INS27 INS42 INS42 INS42 INS42 INS42 INS45 INS45 INS45