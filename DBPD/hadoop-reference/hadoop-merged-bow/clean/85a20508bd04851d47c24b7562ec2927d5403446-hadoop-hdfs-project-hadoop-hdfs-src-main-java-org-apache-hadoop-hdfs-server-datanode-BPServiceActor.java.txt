HDFS-10301. Interleaving processing of storages from repeated block reports causes false zombie storage detection, removes valid blocks. Contributed by Vinitha Gankidi.
-          StorageBlockReport singleReport[] = { reports[r] };
-          DatanodeCommand cmd = bpNamenode.blockReport(
-              bpRegistration, bpos.getBlockPoolId(), singleReport,
-              new BlockReportContext(reports.length, r, reportId,
-                  fullBrLeaseId, true));
+          StorageBlockReport[] singleReport = {reports[r]};
+          DatanodeCommand cmd;
+          if (r != reports.length - 1) {
+            cmd = bpNamenode.blockReport(bpRegistration, bpos.getBlockPoolId(),
+                singleReport, new BlockReportContext(reports.length, r,
+                    reportId, fullBrLeaseId, true));
+          } else {
+            StorageBlockReport[] lastSplitReport =
+                new StorageBlockReport[perVolumeBlockLists.size()];
+            // When block reports are split, the last RPC in the block report
+            // has the information about all storages in the block report.
+            // See HDFS-10301 for more details. To achieve this, the last RPC
+            // has 'n' storage reports, where 'n' is the number of storages in
+            // a DN. The actual block replicas are reported only for the
+            // last/n-th storage.
+            i = 0;
+            for(Map.Entry<DatanodeStorage, BlockListAsLongs> kvPair :
+                perVolumeBlockLists.entrySet()) {
+              lastSplitReport[i++] = new StorageBlockReport(
+                  kvPair.getKey(), BlockListAsLongs.STORAGE_REPORT);
+              if (i == r) {
+                lastSplitReport[i] = reports[r];
+                break;
+              }
+            }
+            cmd = bpNamenode.blockReport(
+                bpRegistration, bpos.getBlockPoolId(), lastSplitReport,
+                new BlockReportContext(reports.length, r, reportId,
+                    fullBrLeaseId, true));
+          }

INS8 MOV60 INS60 INS25 MOV21 MOV21 MOV25 INS5 MOV43 INS59 INS27 MOV8 INS8 MOV43 INS85 INS42 INS42 INS27 INS21 INS60 INS21 INS70 INS21 INS40 INS34 INS7 INS5 INS59 INS7 INS44 INS32 INS8 INS7 INS42 MOV32 INS43 INS85 INS42 INS3 INS42 INS34 INS74 INS42 INS42 INS42 INS21 INS25 INS42 INS32 INS42 INS5 INS32 INS43 INS43 INS43 INS7 INS27 INS8 INS42 INS42 INS42 INS32 INS42 INS14 INS43 INS85 INS42 INS42 INS40 INS42 INS42 INS2 INS14 INS42 INS42 INS21 INS10 INS42 INS42 INS43 INS40 INS42 INS42 INS42 INS9 INS42 INS42 INS37 INS43 INS32 INS40 INS7 INS42 INS42 INS42 INS42 INS42 INS2 INS2 INS42 INS42 INS42 INS42 DEL85 DEL42 DEL59 DEL60