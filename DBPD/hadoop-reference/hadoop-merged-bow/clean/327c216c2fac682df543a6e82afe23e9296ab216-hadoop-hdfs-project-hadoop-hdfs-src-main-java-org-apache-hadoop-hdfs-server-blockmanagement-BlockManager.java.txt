Merge trunk into HA branch.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1236965 13f79535-47bb-0310-9956-ffa450edef68

-      return storedBlock.isComplete();
+      if (!storedBlock.isComplete()) {
+        return false;
+      } else if (storedBlock.getGenerationStamp() != iblk.getGenerationStamp()) {
+        return true;
+      } else { // COMPLETE block, same genstamp
+        if (reportedState == ReplicaState.RBW) {
+          // If it's a RBW report for a COMPLETE block, it may just be that
+          // the block report got a little bit delayed after the pipeline
+          // closed. So, ignore this report, assuming we will get a
+          // FINALIZED replica later. See HDFS-2791
+          LOG.info("Received an RBW replica for block " + storedBlock +
+              " on " + dn.getName() + ": ignoring it, since the block is " +
+              "complete with the same generation stamp.");
+          return false;
+        } else {
+          return true;
+        }
+      }

INS25 INS38 INS8 INS25 MOV32 INS41 INS27 INS8 INS8 INS9 INS32 INS32 INS41 INS25 INS42 INS42 INS42 INS42 INS9 INS27 INS8 INS8 INS42 INS40 INS21 INS41 INS41 INS32 INS9 INS9 INS42 INS42 INS27 INS45 INS42 INS45 INS32 INS45 INS45 INS42 INS42 DEL41