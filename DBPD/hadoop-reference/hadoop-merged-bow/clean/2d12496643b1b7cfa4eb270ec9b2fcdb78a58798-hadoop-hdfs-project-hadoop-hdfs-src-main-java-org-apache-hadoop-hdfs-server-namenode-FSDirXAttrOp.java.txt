HDFS-15480. Ordered snapshot deletion: record snapshot deletion in XAttr (#2163)


-import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.CRYPTO_XATTR_ENCRYPTION_ZONE;
+import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.SNAPSHOT_XATTR_NAME;
+import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.CRYPTO_XATTR_ENCRYPTION_ZONE;
-class FSDirXAttrOp {
+public class FSDirXAttrOp {
-  static INode unprotectedSetXAttrs(
+  public static INode unprotectedSetXAttrs(
+
+      if (xaName.equals(SNAPSHOT_XATTR_NAME) && !(inode.isDirectory() &&
+          inode.getParent().isSnapshottable())) {
+        throw new IOException("Can only set '" +
+            SNAPSHOT_XATTR_NAME + "' on a snapshot root.");
+      }

MOV26 INS26 INS40 INS83 INS83 INS25 INS27 INS8 INS32 INS38 INS53 INS42 INS42 INS42 INS36 INS14 INS27 INS43 INS27 INS32 INS32 INS42 INS45 INS42 INS45 INS42 INS42 INS32 INS42 INS42 INS42