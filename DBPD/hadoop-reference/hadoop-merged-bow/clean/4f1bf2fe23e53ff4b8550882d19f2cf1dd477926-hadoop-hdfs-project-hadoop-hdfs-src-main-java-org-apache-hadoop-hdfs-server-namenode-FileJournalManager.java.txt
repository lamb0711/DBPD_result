HDFS-2738. FSEditLog.selectinputStreams is reading through in-progress streams even when non-in-progress are requested. Contributed by Aaron T. Myers


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1229931 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.server.namenode.JournalManager.CorruptionException;
-  synchronized public EditLogInputStream getInputStream(long fromTxId)
-      throws IOException {
+  synchronized public EditLogInputStream getInputStream(long fromTxId,
+      boolean inProgressOk) throws IOException {
+        if (!inProgressOk && elf.isInProgress()) {
+          continue;
+        }
-  public long getNumberOfTransactions(long fromTxId) 
+  public long getNumberOfTransactions(long fromTxId, boolean inProgressOk)
+        if (!inProgressOk && elf.isInProgress()) {
+          break;
+        }
+        
-    long max = findMaxTransaction();
+    long max = findMaxTransaction(inProgressOk);
-    findMaxTransaction();
+    findMaxTransaction(true);
-  private long findMaxTransaction()
+  private long findMaxTransaction(boolean inProgressOk)
+      if (elf.isInProgress() && !inProgressOk) {
+        continue;
+      }
+      

INS26 INS40 INS44 INS44 INS44 INS39 INS42 INS39 INS42 INS39 INS42 INS9 INS25 INS42 INS27 INS8 INS25 INS32 INS38 INS18 INS27 INS8 INS25 INS42 INS42 INS42 INS38 INS32 INS18 INS27 INS8 INS42 INS42 INS42 INS38 INS32 INS10 INS42 INS42 INS42