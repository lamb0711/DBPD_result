YARN-2073. Fair Scheduler: Add a utilization threshold to prevent preempting resources when cluster is free (Karthik Kambatla via Sandy Ryza)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1597209 13f79535-47bb-0310-9956-ffa450edef68

-  // How often tasks are preempted 
+  // Preemption related variables
+  protected boolean preemptionEnabled;
+  protected float preemptionUtilizationThreshold;
+
+  // How often tasks are preempted
-  protected boolean preemptionEnabled;
-    if (!preemptionEnabled) {
+    if (!shouldAttemptPreemption()) {
-    Resource resToPreempt = Resources.none();
-
+    Resource resToPreempt = Resources.clone(Resources.none());
-      resToPreempt = Resources.add(resToPreempt, resToPreempt(sched, curTime));
+      Resources.addTo(resToPreempt, resToPreempt(sched, curTime));
+  /**
+   * Check if preemption is enabled and the utilization threshold for
+   * preemption is met.
+   *
+   * @return true if preemption should be attempted, false otherwise.
+   */
+  private boolean shouldAttemptPreemption() {
+    if (preemptionEnabled) {
+      return (preemptionUtilizationThreshold < Math.max(
+          (float) rootMetrics.getAvailableMB() / clusterResource.getMemory(),
+          (float) rootMetrics.getAvailableVirtualCores() /
+              clusterResource.getVirtualCores()));
+    }
+    return false;
+  }
+
+      preemptionUtilizationThreshold =
+          this.conf.getPreemptionUtilizationThreshold();

MOV23 INS23 INS31 INS83 INS39 INS59 INS29 INS83 INS39 INS42 INS8 INS42 INS65 INS65 INS25 INS41 INS66 INS66 INS66 INS42 INS8 INS9 INS32 INS32 INS41 INS21 INS42 INS42 INS42 MOV32 MOV32 INS36 INS7 UPD42 INS27 INS42 INS32 INS42 INS32 INS22 INS42 INS42 INS42 INS27 INS27 INS52 INS42 INS11 INS32 INS11 INS32 INS39 INS32 INS42 INS42 INS39 INS32 INS42 INS42 INS42 INS42 INS42 INS42 DEL42 DEL42 DEL7