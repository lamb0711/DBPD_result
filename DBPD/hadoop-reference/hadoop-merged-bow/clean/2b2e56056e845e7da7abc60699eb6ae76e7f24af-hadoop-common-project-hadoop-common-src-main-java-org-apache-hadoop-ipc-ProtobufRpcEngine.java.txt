Merge trunk into HA branch.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1236936 13f79535-47bb-0310-9956-ffa450edef68

-import java.io.Closeable;
-import java.lang.reflect.InvocationHandler;
+import org.apache.hadoop.ipc.Client.ConnectionId;
-import com.google.protobuf.InvalidProtocolBufferException;
+  
+  @Override
+  public ProtocolProxy<ProtocolMetaInfoPB> getProtocolMetaInfoProxy(
+      ConnectionId connId, Configuration conf, SocketFactory factory)
+      throws IOException {
+    Class<ProtocolMetaInfoPB> protocol = ProtocolMetaInfoPB.class;
+    return new ProtocolProxy<ProtocolMetaInfoPB>(protocol,
+        (ProtocolMetaInfoPB) Proxy.newProxyInstance(protocol.getClassLoader(),
+            new Class[] { protocol }, new Invoker(protocol, connId, conf,
+                factory)), false);
+  }
-  private static class Invoker implements InvocationHandler, Closeable {
+  private static class Invoker implements RpcInvocationHandler {
-      this.remoteId = Client.ConnectionId.getConnectionId(addr, protocol,
-          ticket, rpcTimeout, conf);
-      this.client = CLIENTS.getClient(conf, factory,
-          RpcResponseWritable.class);
-      this.clientProtocolVersion = RPC.getProtocolVersion(protocol);
+      this(protocol, Client.ConnectionId.getConnectionId(addr, protocol,
+          ticket, rpcTimeout, conf), conf, factory);
+    }
+    
+    /**
+     * This constructor takes a connectionId, instead of creating a new one.
+     */
+    public Invoker(Class<?> protocol, Client.ConnectionId connId,
+        Configuration conf, SocketFactory factory) {
+      this.remoteId = connId;
+      this.client = CLIENTS.getClient(conf, factory, RpcResponseWritable.class);
+      this.clientProtocolVersion = RPC
+          .getProtocolVersion(protocol);
+
+    @Override //RpcInvocationHandler
+    public ConnectionId getConnectionId() {
+      return remoteId;
+    }

MOV26 UPD40 INS31 INS78 INS83 INS74 INS42 INS44 INS44 INS44 INS43 INS8 UPD43 INS31 INS31 INS42 INS43 INS43 INS43 INS42 INS43 INS42 INS43 INS42 INS42 INS60 INS41 UPD42 INS83 INS42 INS44 MOV44 MOV44 INS44 INS44 MOV44 MOV43 INS8 INS29 INS44 MOV21 INS78 INS83 INS43 INS42 INS8 INS42 INS42 INS42 INS42 INS42 INS74 INS59 INS14 INS74 INS42 INS43 INS42 INS43 INS42 INS17 INS65 INS43 INS42 INS42 INS42 INS41 INS43 INS43 INS42 INS57 INS74 INS42 INS11 INS9 INS43 INS76 INS42 INS42 INS42 MOV32 INS42 INS42 INS66 INS40 INS42 INS42 INS42 INS43 INS43 INS43 INS43 INS32 UPD42 MOV42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS3 INS14 INS42 INS42 INS5 INS4 INS43 INS42 INS42 INS42 INS42 INS43 INS85 INS42 INS42 INS42 DEL40 DEL26 DEL40 DEL26 DEL43