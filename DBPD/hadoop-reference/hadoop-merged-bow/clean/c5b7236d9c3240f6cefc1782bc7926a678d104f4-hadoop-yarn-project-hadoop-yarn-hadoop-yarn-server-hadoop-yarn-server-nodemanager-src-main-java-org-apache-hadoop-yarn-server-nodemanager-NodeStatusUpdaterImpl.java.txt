merge from trunk r1602933

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/fs-encryption@1602947 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.yarn.server.api.protocolrecords.NMContainerStatus;
-    List<ContainerStatus> containerStatuses = getContainerStatuses();
+    List<NMContainerStatus> containerReports = getNMContainerStatuses();
-          nodeManagerVersionId, containerStatuses);
-    if (containerStatuses != null) {
-      LOG.info("Registering with RM using finished containers :"
-          + containerStatuses);
+          nodeManagerVersionId, containerReports);
+    if (containerReports != null) {
+      LOG.info("Registering with RM using containers :" + containerReports);
+  // These NMContainerStatus are sent on NM registration and used by YARN only.
+  private List<NMContainerStatus> getNMContainerStatuses() {
+    List<NMContainerStatus> containerStatuses =
+        new ArrayList<NMContainerStatus>();
+    for (Container container : this.context.getContainers().values()) {
+      NMContainerStatus status =
+          container.getNMContainerStatus();
+      containerStatuses.add(status);
+      if (status.getContainerState().equals(ContainerState.COMPLETE)) {
+        // Adding to finished containers cache. Cache will keep it around at
+        // least for #durationToTrackStoppedContainers duration. In the
+        // subsequent call to stop container it will get removed from cache.
+        updateStoppedContainersInCache(container.getContainerId());
+        addCompletedContainer(container);
+      }
+    }
+    LOG.info("Sending out " + containerStatuses.size()
+      + " NM container statuses: " + containerStatuses);
+    return containerStatuses;
+  }
+

INS26 INS40 INS31 INS83 INS74 INS42 INS8 INS43 INS43 INS60 INS70 INS21 INS41 UPD74 INS42 INS42 INS74 INS59 INS44 INS32 INS8 INS32 INS42 UPD43 UPD42 UPD42 INS43 INS43 INS42 INS14 INS43 INS42 INS32 INS42 INS60 INS21 INS25 INS42 INS42 INS27 UPD42 UPD42 UPD42 INS42 INS42 INS74 INS42 INS22 INS42 INS43 INS59 INS32 INS32 INS8 INS45 INS32 INS45 INS42 INS43 INS43 INS52 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS32 INS42 INS40 INS21 INS21 INS42 INS42 UPD45 UPD42 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS32 INS42 INS32 INS42 INS42 INS42 INS42