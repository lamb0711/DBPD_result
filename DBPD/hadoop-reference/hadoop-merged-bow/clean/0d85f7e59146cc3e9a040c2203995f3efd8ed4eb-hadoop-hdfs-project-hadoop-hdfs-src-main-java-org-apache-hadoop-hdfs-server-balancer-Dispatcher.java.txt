HDFS-7034. Archival Storage: Fix TestBlockPlacement and TestStorageMover. Contributed by Jing Zhao.

+import org.apache.hadoop.hdfs.DFSConfigKeys;
-  private static final long DELAY_AFTER_ERROR = 10 * 1000L; // 10 seconds
+  /**
+   * the period of time to delay the usage of a DataNode after hitting
+   * errors when using it for migrating data
+   */
+  private static long delayAfterErrors = 10 * 1000;
+
-      final Block b = block.getBlock();
-      return b + " with size=" + b.getNumBytes() + " from "
-          + source.getDisplayName() + " to " + target.getDisplayName()
-          + " through " + proxySource.datanode;
+      final Block b = block != null ? block.getBlock() : null;
+      String bStr = b != null ? (b + " with size=" + b.getNumBytes() + " ")
+          : " ";
+      return bStr + "from " + source.getDisplayName() + " to " + target
+          .getDisplayName() + " through " + (proxySource != null ? proxySource
+          .datanode : "");
-        proxySource.activateDelay(DELAY_AFTER_ERROR);
-        target.getDDatanode().activateDelay(DELAY_AFTER_ERROR);
+        proxySource.activateDelay(delayAfterErrors);
+        target.getDDatanode().activateDelay(delayAfterErrors);
+  @VisibleForTesting
+  public static void setDelayAfterErrors(long time) {
+    delayAfterErrors = time;
+  }
+

INS26 INS40 INS31 INS29 INS78 INS83 INS83 INS39 INS42 INS44 INS8 INS65 UPD42 INS42 INS39 INS42 INS21 INS66 INS66 UPD34 INS60 INS7 INS43 INS59 INS42 INS42 INS16 INS42 INS42 INS16 UPD42 UPD45 INS36 INS27 MOV32 INS33 INS27 INS36 INS45 INS16 INS42 INS33 INS42 INS33 INS27 INS27 INS40 INS45 INS42 INS45 MOV32 INS45 INS42 INS33 UPD42 UPD42 DEL83 DEL45 DEL40