MAPREDUCE-3034. Ensure NodeManager reboots itself on direction from ResourceManager. Contributed by Devaraj K & Eric Payne. 


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1297310 13f79535-47bb-0310-9956-ffa450edef68

-
+  private static CompositeServiceShutdownHook nodeManagerShutdownHook; 
+  
-    // Shutdown the Nodemanager when the NodeStatusUpdater is stopped.
+
+      boolean hasToReboot = ((NodeStatusUpdaterImpl) service).hasToRebootNode();
+
+      // Shutdown the Nodemanager when the NodeStatusUpdater is stopped.      
+
+      // Reboot the whole node-manager if NodeStatusUpdater got a reboot command
+      // from the RM.
+      if (hasToReboot) {
+        LOG.info("Rebooting the node manager.");
+        NodeManager nodeManager = createNewNodeManager();
+        nodeManager.initAndStartNodeManager(hasToReboot);
+      }
-  public static void main(String[] args) {
-    StringUtils.startupShutdownMessage(NodeManager.class, args, LOG);
+  private void initAndStartNodeManager(boolean hasToReboot) {
-      NodeManager nodeManager = new NodeManager();
-      Runtime.getRuntime().addShutdownHook(
-          new CompositeServiceShutdownHook(nodeManager));
+
+      // Remove the old hook if we are rebooting.
+      if (hasToReboot && null != nodeManagerShutdownHook) {
+        Runtime.getRuntime().removeShutdownHook(nodeManagerShutdownHook);
+      }
+
+      nodeManagerShutdownHook = new CompositeServiceShutdownHook(this);
+      Runtime.getRuntime().addShutdownHook(nodeManagerShutdownHook);
+
-      nodeManager.init(conf);
-      nodeManager.start();
+      this.init(conf);
+      this.start();
+
+  // For testing
+  NodeManager createNewNodeManager() {
+    return new NodeManager();
+  }
+
+  public static void main(String[] args) {
+    StringUtils.startupShutdownMessage(NodeManager.class, args, LOG);
+    NodeManager nodeManager = new NodeManager();
+    nodeManager.initAndStartNodeManager(false);
+  }

INS23 INS31 INS31 INS83 INS83 INS43 INS59 UPD83 UPD42 INS44 INS43 INS42 INS8 INS83 INS83 INS39 INS42 MOV44 INS8 INS42 INS42 INS39 INS42 INS42 INS41 MOV21 MOV60 INS21 INS8 INS14 INS32 INS60 MOV21 INS25 INS25 INS21 INS21 INS43 INS42 INS42 INS9 INS39 INS59 INS42 MOV8 INS27 INS8 INS7 INS32 INS42 INS42 INS32 INS21 INS60 INS21 INS42 INS27 MOV21 INS42 MOV14 INS32 INS42 INS42 INS52 INS52 INS36 INS42 INS32 INS43 INS59 INS32 INS33 INS42 INS52 INS42 INS42 INS11 INS42 INS42 INS45 INS42 INS42 INS32 INS42 INS42 INS42 UPD42 INS42 INS43 INS42 INS42 INS42 DEL83 DEL42 DEL42 DEL42