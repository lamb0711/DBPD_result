Merge trunk into HA branch


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1242635 13f79535-47bb-0310-9956-ffa450edef68

+      // There three cases here:
+      // 1. OP_ADD to create a new file
+      // 2. OP_ADD to update file blocks
+      // 3. OP_ADD to open file for append
-      if (oldFile == null) { // this is OP_ADD on a new file
+      INodeFile newFile = oldFile;
+      if (oldFile == null) { // this is OP_ADD on a new file (case 1)
+
+        // Versions of HDFS prior to 0.17 may log an OP_ADD transaction
+        // which includes blocks in it. When we update the minimum
+        // upgrade version to something more recent than 0.17, we can
+        // simplify this code by asserting that OP_ADD transactions
+        // don't have any blocks.
-        // TODO: We should do away with this add-then-replace dance.
-
-        INodeFile node = (INodeFile)fsDir.unprotectedAddFile(
+        newFile = (INodeFile)fsDir.unprotectedAddFile(
-            addCloseOp.atime, blockSize);
+            addCloseOp.atime, blockSize,
+            true, addCloseOp.clientName, addCloseOp.clientMachine);
+        fsNamesys.leaseManager.addLease(addCloseOp.clientName, addCloseOp.path);
-        fsNamesys.prepareFileForWrite(addCloseOp.path, node,
-            addCloseOp.clientName, addCloseOp.clientMachine, null,
-            false);
-          // This is a call to append() on an already-closed file.
+          // This is case 3: a call to append() on an already-closed file.
-          oldFile = getINodeFile(fsDir, addCloseOp.path);
+          newFile = getINodeFile(fsDir, addCloseOp.path);
-        
-        updateBlocks(fsDir, addCloseOp, oldFile);
+      // Fall-through for case 2.
+      // Regardless of whether it's a new file or an updated file,
+      // update the block list.
+      updateBlocks(fsDir, addCloseOp, newFile);

INS60 INS21 MOV43 INS59 INS32 INS42 INS42 INS21 INS42 INS42 INS42 INS42 INS7 INS42 INS11 UPD40 UPD42 UPD40 MOV43 MOV32 INS9 INS40 INS40 UPD42 DEL42 DEL11 DEL59 DEL60 DEL42 DEL42 DEL33 DEL9 DEL42 DEL42 DEL42 DEL42 DEL32 DEL21