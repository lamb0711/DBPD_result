HDFS-7435. PB encoding of block reports is very inefficient. Contributed by Daryn Sharp.

+import org.apache.hadoop.hdfs.protocol.BlockListAsLongs;
+import org.apache.hadoop.hdfs.server.protocol.NamespaceInfo.Capability;
+import com.google.common.annotations.VisibleForTesting;
+  @VisibleForTesting
+  public DatanodeProtocolClientSideTranslatorPB(DatanodeProtocolPB rpcProxy) {
+    this.rpcProxy = rpcProxy;
+  }
+
+    boolean useBlocksBuffer = registration.getNamespaceInfo()
+        .isCapabilitySupported(Capability.STORAGE_BLOCK_REPORT_BUFFERS);
+
-      long[] blocks = r.getBlocks();
-      for (int i = 0; i < blocks.length; i++) {
-        reportBuilder.addBlocks(blocks[i]);
+      BlockListAsLongs blocks = r.getBlocks();
+      if (useBlocksBuffer) {
+        reportBuilder.setNumberOfBlocks(blocks.getNumberOfBlocks());
+        reportBuilder.addAllBlocksBuffers(blocks.getBlocksBuffers());
+      } else {
+        for (long value : blocks.getBlockListAsLongs()) {
+          reportBuilder.addBlocks(value);
+        }

INS26 INS26 INS26 INS40 INS40 INS40 INS31 INS78 INS83 INS42 INS44 INS8 INS42 INS43 INS42 INS21 INS60 INS42 INS7 INS39 INS59 INS22 INS42 INS42 INS32 INS25 INS52 INS42 INS32 INS42 INS40 INS43 INS42 INS8 INS8 INS42 INS42 INS42 INS21 INS21 INS70 INS32 INS32 INS44 INS32 INS8 INS42 INS42 INS32 INS42 INS42 INS32 INS39 INS42 INS42 INS42 MOV21 INS42 INS42 INS42 INS42 INS42 DEL39 DEL85 DEL5 DEL42 DEL42 DEL2 DEL39 DEL42 DEL34 DEL59 DEL58 DEL42 DEL40 DEL27 DEL42 DEL37 DEL8 DEL24