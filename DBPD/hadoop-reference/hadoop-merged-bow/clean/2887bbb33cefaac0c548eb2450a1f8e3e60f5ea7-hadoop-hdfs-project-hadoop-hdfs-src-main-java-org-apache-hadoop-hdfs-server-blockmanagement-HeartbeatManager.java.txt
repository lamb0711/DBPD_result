HDFS-3912. Detect and avoid stale datanodes for writes. Contributed by Jing Zhao

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1397211 13f79535-47bb-0310-9956-ffa450edef68

+import com.google.common.base.Preconditions;
+
-
+  /**
+   * The initial setting of end user which indicates whether or not to avoid
+   * writing to stale datanodes.
+   */
+  private final boolean initialAvoidWriteStaleNodes;
+  /**
+   * When the ratio of stale datanodes reaches this number, stop avoiding 
+   * writing to stale datanodes, i.e., continue using stale nodes for writing.
+   */
+  private final float ratioUseStaleDataNodesForWrite;
+    
-  HeartbeatManager(final Namesystem namesystem, final BlockManager blockManager,
-      final Configuration conf) {
-    this.heartbeatRecheckInterval = conf.getInt(
-        DFSConfigKeys.DFS_NAMENODE_HEARTBEAT_RECHECK_INTERVAL_KEY, 
-        DFSConfigKeys.DFS_NAMENODE_HEARTBEAT_RECHECK_INTERVAL_DEFAULT); // 5 minutes
-
+  HeartbeatManager(final Namesystem namesystem,
+      final BlockManager blockManager, final Configuration conf) {
+    boolean checkStaleNodes = conf.getBoolean(
+        DFSConfigKeys.DFS_NAMENODE_CHECK_STALE_DATANODE_KEY,
+        DFSConfigKeys.DFS_NAMENODE_CHECK_STALE_DATANODE_DEFAULT);
+    long recheckInterval = conf.getInt(
+        DFSConfigKeys.DFS_NAMENODE_HEARTBEAT_RECHECK_INTERVAL_KEY, 
+        DFSConfigKeys.DFS_NAMENODE_HEARTBEAT_RECHECK_INTERVAL_DEFAULT); // 5 min
+    long staleInterval = conf.getLong(
+        DFSConfigKeys.DFS_NAMENODE_STALE_DATANODE_INTERVAL_KEY, 
+        DFSConfigKeys.DFS_NAMENODE_STALE_DATANODE_INTERVAL_DEFAULT);// 30s
+    this.initialAvoidWriteStaleNodes = DatanodeManager
+        .getAvoidStaleForWriteFromConf(conf, checkStaleNodes);
+    this.ratioUseStaleDataNodesForWrite = conf.getFloat(
+        DFSConfigKeys.DFS_NAMENODE_USE_STALE_DATANODE_FOR_WRITE_RATIO_KEY,
+        DFSConfigKeys.DFS_NAMENODE_USE_STALE_DATANODE_FOR_WRITE_RATIO_DEFAULT);
+    Preconditions.checkArgument(
+        (ratioUseStaleDataNodesForWrite > 0 && 
+            ratioUseStaleDataNodesForWrite <= 1.0f),
+        DFSConfigKeys.DFS_NAMENODE_USE_STALE_DATANODE_FOR_WRITE_RATIO_KEY +
+        " = '" + ratioUseStaleDataNodesForWrite + "' is invalid. " +
+        "It should be a positive non-zero float value, not greater than 1.0f.");
+    
+    this.heartbeatRecheckInterval = (checkStaleNodes 
+        && initialAvoidWriteStaleNodes 
+        && staleInterval < recheckInterval) ? staleInterval : recheckInterval;
+    boolean checkStaleNodes = dm.isCheckingForStaleDataNodes();
+      // check the number of stale nodes
+      int numOfStaleNodes = 0;
-          if (dm.isDatanodeDead(d)) {
+          if (dead == null && dm.isDatanodeDead(d)) {
-            break;
+            if (!checkStaleNodes) {
+              break;
+            }
+          }
+          if (checkStaleNodes && 
+              d.isStale(dm.getStaleInterval())) {
+            numOfStaleNodes++;
+          }
+        }
+        
+        // Change whether to avoid using stale datanodes for writing
+        // based on proportion of stale datanodes
+        if (checkStaleNodes) {
+          dm.setNumStaleNodes(numOfStaleNodes);
+          if (numOfStaleNodes > 
+                datanodes.size() * ratioUseStaleDataNodesForWrite) {
+            dm.setAvoidStaleDataNodesForWrite(false);
+          } else {
+            if (this.initialAvoidWriteStaleNodes) {
+              dm.setAvoidStaleDataNodesForWrite(true);
+            }

INS26 INS40 INS23 INS23 INS29 INS83 INS83 INS39 INS59 INS29 INS83 INS83 INS39 INS59 MOV21 INS65 INS42 INS65 INS42 INS60 INS60 INS60 INS21 INS21 INS21 INS60 INS66 INS66 INS66 INS66 INS39 INS59 INS39 INS59 INS39 INS59 INS7 INS32 INS7 INS39 INS59 INS42 INS32 INS42 MOV32 INS42 INS32 INS22 INS32 INS22 INS32 INS42 INS42 INS36 INS27 MOV22 INS16 INS42 INS32 INS60 INS42 INS42 INS40 INS40 INS42 INS42 INS40 INS40 INS52 INS42 INS42 INS42 INS42 INS42 INS52 INS42 INS42 INS42 INS40 INS40 INS27 INS40 INS45 INS42 INS45 INS45 INS36 INS42 INS42 INS42 INS42 INS39 INS59 INS8 INS27 INS27 INS27 INS42 INS34 MOV70 INS25 INS42 INS34 INS42 INS34 INS42 INS42 INS27 INS42 INS8 INS42 INS42 INS25 INS21 INS25 INS27 INS27 INS8 INS32 INS27 INS8 INS8 INS27 MOV32 INS25 INS42 INS32 INS21 INS42 INS42 INS42 INS42 INS27 INS21 INS25 INS42 INS33 INS38 INS8 INS42 INS42 INS32 INS37 INS32 INS42 INS32 INS22 INS8 INS42 MOV10 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS9 INS52 INS42 INS21 INS32 INS42 INS42 INS9 DEL8