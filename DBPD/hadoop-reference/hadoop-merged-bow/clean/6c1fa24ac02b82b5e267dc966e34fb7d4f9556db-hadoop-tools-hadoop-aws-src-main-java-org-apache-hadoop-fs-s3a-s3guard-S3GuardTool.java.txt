HADOOP-16732. S3Guard to support encrypted DynamoDB table (#1752). Contributed by Mingliang Liu.


+import static org.apache.hadoop.fs.s3a.s3guard.DynamoDBMetadataStoreTableManager.SSE_DEFAULT_MASTER_KEY;
+  public static final String SSE_FLAG = "sse";
+  public static final String CMK_FLAG = "cmk";
+        "  -" + SSE_FLAG + " - Enable server side encryption\n" +
+        "  -" + CMK_FLAG + " KEY - Customer managed CMK\n" +
-      super(conf);
+      super(conf, SSE_FLAG);
+      // customer managed customer master key (CMK) for server side encryption
+      getCommandFormat().addOptionWithValue(CMK_FLAG);
-
-      String readCap = getCommandFormat().getOptValue(READ_FLAG);
+      CommandFormat commands = getCommandFormat();
+      String readCap = commands.getOptValue(READ_FLAG);
-      String writeCap = getCommandFormat().getOptValue(WRITE_FLAG);
+      String writeCap = commands.getOptValue(WRITE_FLAG);
-      String tags = getCommandFormat().getOptValue(TAG_FLAG);
+      String cmk = commands.getOptValue(CMK_FLAG);
+      if (commands.getOpt(SSE_FLAG)) {
+        getConf().setBoolean(S3GUARD_DDB_TABLE_SSE_ENABLED, true);
+        LOG.debug("SSE flag is passed to command {}", this.getName());
+        if (!StringUtils.isEmpty(cmk)) {
+          if (SSE_DEFAULT_MASTER_KEY.equals(cmk)) {
+            LOG.warn("Ignoring default DynamoDB table KMS Master Key " +
+                "alias/aws/dynamodb in configuration");
+          } else {
+            LOG.debug("Setting customer managed CMK {}", cmk);
+            getConf().set(S3GUARD_DDB_TABLE_SSE_CMK, cmk);
+          }
+        }
+      } else if (!StringUtils.isEmpty(cmk)) {
+        throw invalidArgs("Option %s can only be used with option %s",
+            CMK_FLAG, SSE_FLAG);
+      }
+
+      String tags = commands.getOptValue(TAG_FLAG);

INS26 INS40 INS23 INS23 INS83 INS83 INS83 INS43 INS59 INS83 INS83 INS83 INS43 INS59 INS42 INS42 INS45 INS42 INS42 INS45 INS21 INS60 INS60 INS25 INS42 INS45 INS45 INS42 INS45 INS45 INS42 INS32 INS43 INS59 MOV43 MOV43 MOV43 INS59 INS32 INS8 INS25 INS43 MOV32 INS42 INS42 INS42 INS42 MOV32 INS42 INS32 INS42 INS42 INS42 INS21 INS21 INS25 INS38 INS8 INS42 INS42 UPD42 MOV42 INS42 INS42 INS42 INS42 INS32 INS32 INS38 INS8 INS32 INS53 UPD42 MOV42 INS32 INS42 INS42 INS9 INS42 INS42 INS45 INS32 INS32 INS25 INS42 INS42 INS42 INS32 INS42 INS52 INS42 INS42 INS42 INS42 INS32 INS8 INS8 INS42 INS45 INS42 INS42 INS42 INS42 INS42 INS21 INS21 INS21 INS32 INS32 INS32 INS42 INS42 INS27 INS42 INS42 INS45 INS42 INS32 INS42 INS42 INS42 INS45 INS45 INS42 DEL32