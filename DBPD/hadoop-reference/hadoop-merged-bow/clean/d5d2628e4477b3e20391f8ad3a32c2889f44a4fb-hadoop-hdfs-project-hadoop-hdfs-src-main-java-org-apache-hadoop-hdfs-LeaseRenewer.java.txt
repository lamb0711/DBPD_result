Merge r1360400 through r1399945 from trunk.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1399950 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.util.Time;
-  private final String clienNamePostfix = DFSUtil.getRandom().nextInt()
-      + "_" + Thread.currentThread().getId();
-
-  /** @return the client name for the given id. */
-  String getClientName(final String id) {
-    return "DFSClient_" + id + "_" + clienNamePostfix;
-  }
-
+
+  /** Does this renewer have nothing to renew? */
+  public boolean isEmpty() {
+    return dfsclients.isEmpty();
+  }
-        && System.currentTimeMillis() - emptyTime > gracePeriod;
+        && Time.now() - emptyTime > gracePeriod;
+      if (dfsc.isFilesBeingWrittenEmpty()) {
+        dfsclients.remove(dfsc);
+      }
-        emptyTime = System.currentTimeMillis();
+        emptyTime = Time.now();
-        emptyTime = System.currentTimeMillis();
+        emptyTime = Time.now();
-    for(long lastRenewed = System.currentTimeMillis();
-        clientsRunning() && !Thread.interrupted();
+    for(long lastRenewed = Time.now(); !Thread.interrupted();
-      final long elapsed = System.currentTimeMillis() - lastRenewed;
+      final long elapsed = Time.now() - lastRenewed;
-          lastRenewed = System.currentTimeMillis();
+          lastRenewed = Time.now();
+
+        // if no clients are in running state or there is no more clients
+        // registered with this renewer, stop the daemon after the grace
+        // period.
+        if (!clientsRunning() && emptyTime == Long.MAX_VALUE) {
+          emptyTime = Time.now();
+        }

INS26 MOV31 INS40 INS83 INS39 INS42 UPD65 UPD66 INS32 MOV38 INS42 INS42 INS25 INS32 INS8 INS42 INS42 INS21 UPD42 UPD42 INS25 UPD42 UPD42 INS32 INS27 INS8 INS42 INS42 INS42 UPD42 UPD42 INS38 INS27 INS21 UPD42 UPD42 UPD42 UPD42 MOV32 INS42 INS40 INS7 INS42 INS32 UPD42 UPD42 INS42 INS42 DEL83 DEL83 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL45 DEL42 DEL42 DEL32 DEL42 DEL32 DEL27 DEL59 DEL23 DEL42 DEL43 DEL42 DEL83 DEL42 DEL43 DEL42 DEL44 DEL45 DEL42 DEL45 DEL42 DEL27 DEL27