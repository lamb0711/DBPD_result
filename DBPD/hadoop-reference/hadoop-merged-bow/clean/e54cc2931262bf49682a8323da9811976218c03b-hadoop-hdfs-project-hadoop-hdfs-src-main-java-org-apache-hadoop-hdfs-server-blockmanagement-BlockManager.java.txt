HDFS-9818. Correctly handle EC reconstruction work caused by not enough racks. Contributed by Jing Zhao.

-      return new ErasureCodingWork(block, bc, srcNodes,
+      return new ErasureCodingWork(getBlockPoolId(), block, bc, srcNodes,
+  private boolean isInNewRack(DatanodeDescriptor[] srcs,
+      DatanodeDescriptor target) {
+    for (DatanodeDescriptor src : srcs) {
+      if (src.getNetworkLocation().equals(target.getNetworkLocation())) {
+        return false;
+      }
+    }
+    return true;
+  }
+
-      if (rw.getSrcNodes()[0].getNetworkLocation().equals(
-          targets[0].getDatanodeDescriptor().getNetworkLocation())) {
-        //No use continuing, unless a new rack in this case
+      if (!isInNewRack(rw.getSrcNodes(), targets[0].getDatanodeDescriptor())) {
+        // No use continuing, unless a new rack in this case
-    // Add block to the to be reconstructed list
-    if (block.isStriped()) {
-      assert rw instanceof ErasureCodingWork;
-      assert rw.getTargets().length > 0;
-      assert pendingNum == 0 : "Should wait the previous reconstruction"
-          + " to finish";
-      final ErasureCodingPolicy ecPolicy =
-          ((BlockInfoStriped) block).getErasureCodingPolicy();
-      assert ecPolicy != null;
-
-      rw.getTargets()[0].getDatanodeDescriptor().addBlockToBeErasureCoded(
-          new ExtendedBlock(getBlockPoolId(), block),
-          rw.getSrcNodes(), rw.getTargets(),
-          ((ErasureCodingWork) rw).getLiveBlockIndicies(), ecPolicy);
-    } else {
-      rw.getSrcNodes()[0].addBlockToBeReplicated(block, targets);
-    }
-
+    // Add block to the datanode's task list
+    rw.addTaskToDatanode();
-    return placementPolicy.verifyBlockPlacement(locs, numReplicas).isPlacementPolicySatisfied();
+    return placementPolicy.verifyBlockPlacement(locs, numReplicas)
+        .isPlacementPolicySatisfied();

INS31 INS83 INS39 INS42 INS44 INS44 INS8 INS5 INS42 INS43 INS42 INS70 INS41 MOV21 INS43 INS85 INS42 INS44 INS42 INS8 INS9 INS32 INS42 INS43 INS42 INS25 MOV42 UPD42 MOV42 INS42 INS32 INS8 INS38 MOV32 INS32 INS42 INS32 INS41 MOV32 INS42 INS42 INS42 INS42 INS9 INS42 MOV32 DEL42 DEL42 DEL32 DEL34 DEL2 DEL42 DEL32 DEL42 DEL32 DEL42 DEL32 DEL34 DEL2 DEL32 DEL42 DEL42 DEL43 DEL42 DEL14 DEL42 DEL42 DEL32 DEL42 DEL43 DEL42 DEL11 DEL36 DEL42 DEL32 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL42 DEL43 DEL62 DEL6 DEL42 DEL42 DEL32 DEL42 DEL22 DEL34 DEL27 DEL6 DEL42 DEL34 DEL27 DEL45 DEL45 DEL27 DEL6 DEL83 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL11 DEL36 DEL42 DEL32 DEL59 DEL60 DEL42 DEL33 DEL27 DEL6 DEL8 DEL42 DEL42 DEL32 DEL34 DEL2 DEL42 DEL42 DEL42 DEL32 DEL21 DEL8 DEL25