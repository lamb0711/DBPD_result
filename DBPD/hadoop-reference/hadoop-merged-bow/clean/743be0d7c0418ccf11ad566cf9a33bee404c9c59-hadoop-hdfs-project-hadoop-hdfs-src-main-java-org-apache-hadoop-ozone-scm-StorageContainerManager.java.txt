HDFS-12235. Ozone: DeleteKey-3: KSM SCM block deletion message and ACK interactions. Contributed by Weiwei Yang and Yuanbo Liu.

+import org.apache.hadoop.ozone.common.DeleteBlockGroupResult;
+import org.apache.hadoop.ozone.common.BlockGroup;
+import java.util.ArrayList;
-   * Delete blocks.
-   * @param keys batch of block keys to delete.
+   * Delete blocks for a set of object keys.
+   *
+   * @param keyBlocksInfoList list of block keys with object keys to delete.
-  public List<DeleteBlockResult> deleteBlocks(final Set<String> keys) {
-    List<DeleteBlockResult> results = new LinkedList<>();
-    for (String key: keys) {
+  public List<DeleteBlockGroupResult> deleteKeyBlocks(
+      List<BlockGroup> keyBlocksInfoList) throws IOException {
+    LOG.info("SCM is informed by KSM to delete {} blocks",
+        keyBlocksInfoList.size());
+    List<DeleteBlockGroupResult> results = new ArrayList<>();
+    for (BlockGroup keyBlocks : keyBlocksInfoList) {
-        scmBlockManager.deleteBlock(key);
+        // We delete blocks in an atomic operation to prevent getting
+        // into state like only a partial of blocks are deleted,
+        // which will leave key in an inconsistent state.
+        scmBlockManager.deleteBlocks(keyBlocks.getBlockIDList());
-        LOG.warn("Fail to delete block: {}", key, scmEx);
+        LOG.warn("Fail to delete block: {}", keyBlocks.getGroupID(), scmEx);
-        LOG.warn("Fail to delete block: {}", key, ex);
+        LOG.warn("Fail to delete blocks for object key: {}",
+            keyBlocks.getGroupID(), ex);
-      results.add(new DeleteBlockResult(key, resultCode));
+      List<DeleteBlockResult> blockResultList = new ArrayList<>();
+      for (String blockKey : keyBlocks.getBlockIDList()) {
+        blockResultList.add(new DeleteBlockResult(blockKey, resultCode));
+      }
+      results.add(new DeleteBlockGroupResult(keyBlocks.getGroupID(),
+          blockResultList));

INS26 INS26 INS26 INS40 INS40 INS40 UPD74 UPD42 INS43 UPD43 UPD74 UPD42 INS42 INS21 UPD66 UPD42 UPD66 UPD42 UPD43 UPD43 INS32 INS74 INS44 INS42 UPD42 UPD42 INS42 INS42 INS45 INS32 INS43 INS43 INS43 INS42 INS60 INS70 INS21 INS42 INS42 INS42 INS42 UPD74 INS42 MOV74 INS59 MOV44 INS32 INS8 INS32 UPD43 INS42 INS14 UPD42 INS42 INS42 MOV21 INS42 INS42 INS14 UPD42 INS74 INS43 INS32 INS42 UPD42 INS32 INS43 UPD42 INS42 INS42 INS42 UPD42 MOV42 INS42 INS32 UPD45 INS32 INS42 UPD42 UPD42 MOV42 INS42 UPD42 MOV42 INS42 DEL83 DEL42