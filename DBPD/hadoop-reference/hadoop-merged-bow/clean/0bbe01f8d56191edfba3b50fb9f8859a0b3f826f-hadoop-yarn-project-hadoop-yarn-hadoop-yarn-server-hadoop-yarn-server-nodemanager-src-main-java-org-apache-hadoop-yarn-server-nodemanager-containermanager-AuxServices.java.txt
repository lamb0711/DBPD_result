YARN-4577. Enable aux services to have their own custom classpath/jar file (Xuan Gong via sale)

-        Class<? extends AuxiliaryService> sClass = conf.getClass(
-              String.format(YarnConfiguration.NM_AUX_SERVICE_FMT, sName), null,
-              AuxiliaryService.class);
-        if (null == sClass) {
-          throw new RuntimeException("No class defined for " + sName);
+        String classKey = String.format(
+            YarnConfiguration.NM_AUX_SERVICE_FMT, sName);
+        String className = conf.get(classKey);
+        final String appClassPath = conf.get(String.format(
+            YarnConfiguration.NM_AUX_SERVICES_CLASSPATH, sName));
+        AuxiliaryService s = null;
+        boolean useCustomerClassLoader = appClassPath != null
+            && !appClassPath.isEmpty() && className != null
+            && !className.isEmpty();
+        if (useCustomerClassLoader) {
+          s = AuxiliaryServiceWithCustomClassLoader.getInstance(
+              conf, className, appClassPath);
+          LOG.info("The aux service:" + sName
+              + " are using the custom classloader");
+        } else {
+          Class<? extends AuxiliaryService> sClass = conf.getClass(
+              classKey, null, AuxiliaryService.class);
+
+          if (sClass == null) {
+            throw new RuntimeException("No class defined for " + sName);
+          }
+          s = ReflectionUtils.newInstance(sClass, conf);
-        AuxiliaryService s = ReflectionUtils.newInstance(sClass, conf);
+        if (s == null) {
+          throw new RuntimeException("No object created for " + sName);
+        }
-                  +"configuration is for "+sClass+" which has "
-                  +"a name of '"+s.getName()+"'. Because these are "
-                  +"not the same tools trying to send ServiceData and read "
-                  +"Service Meta Data may have issues unless the refer to "
-                  +"the name in the config.");
+              +"configuration is for "+s.getClass()+" which has "
+              +"a name of '"+s.getName()+"'. Because these are "
+              +"not the same tools trying to send ServiceData and read "
+              +"Service Meta Data may have issues unless the refer to "
+              +"the name in the config.");
-}
+}

INS60 INS60 INS60 INS60 INS25 INS25 INS43 MOV59 INS43 INS59 INS83 INS43 INS59 INS39 INS59 INS42 INS8 INS8 INS27 INS8 INS42 UPD42 MOV32 INS42 INS42 INS32 INS42 INS42 INS32 INS33 INS42 INS27 INS21 INS21 MOV60 MOV25 INS21 INS42 INS33 INS53 INS42 INS42 INS42 INS42 INS42 INS32 INS27 INS38 INS7 INS32 INS59 INS7 INS14 INS42 INS42 INS40 INS42 INS27 INS27 INS32 INS42 INS32 INS42 INS42 INS27 INS42 INS32 INS33 INS42 MOV32 INS43 INS27 INS27 INS38 INS42 INS33 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS45 INS42 INS45 INS42 INS42 INS42 INS33 MOV57 INS42 INS45 INS42 INS32 INS42 INS33 INS32 INS42 INS42 INS42 INS42 DEL42 DEL42 DEL33 DEL32 DEL33 DEL42