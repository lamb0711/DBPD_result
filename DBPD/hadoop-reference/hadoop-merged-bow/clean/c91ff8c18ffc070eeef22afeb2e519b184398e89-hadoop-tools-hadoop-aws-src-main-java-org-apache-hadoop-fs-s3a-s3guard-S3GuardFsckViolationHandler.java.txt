HADOOP-16858. S3Guard fsck: Add option to remove orphaned entries (#1851). Contributed by Gabor Bota.

Adding a new feature to S3GuardTool's fsck: -fix. 

Change-Id: I2cdb6601fea1d859b54370046b827ef06eb1107d
+import java.io.IOException;
+import org.apache.hadoop.fs.Path;
+  public enum HandleMode {
+    FIX, LOG
+  }
+
-  public void handle(S3GuardFsck.ComparePair comparePair) {
+  public void logError(S3GuardFsck.ComparePair comparePair) throws IOException {
-    handleComparePair(comparePair, sB);
+    handleComparePair(comparePair, sB, HandleMode.LOG);
+  public void doFix(S3GuardFsck.ComparePair comparePair) throws IOException {
+    if (!comparePair.containsViolation()) {
+      LOG.debug("There is no violation in the compare pair: {}", comparePair);
+      return;
+    }
+
+    StringBuilder sB = new StringBuilder();
+    sB.append(newLine)
+        .append("On path: ").append(comparePair.getPath()).append(newLine);
+
+    handleComparePair(comparePair, sB, HandleMode.FIX);
+
+    LOG.info(sB.toString());
+  }
+
-  protected static void handleComparePair(S3GuardFsck.ComparePair comparePair,
-      StringBuilder sB) {
+  protected void handleComparePair(S3GuardFsck.ComparePair comparePair,
+      StringBuilder sB, HandleMode handleMode) throws IOException {
-        final String errorStr = handler.getError();
-        sB.append(errorStr);
+
+        switch (handleMode) {
+          case FIX:
+            final String errorStr = handler.getError();
+            sB.append(errorStr);
+            break;
+          case LOG:
+            final String fixStr = handler.fixViolation(rawFs, metadataStore);
+            sB.append(fixStr);
+            break;
+          default:
+            throw new UnsupportedOperationException("Unknown handleMode: " + handleMode);
+        }
+
+
+    public String fixViolation(S3AFileSystem fs,
+        DynamoDBMetadataStore ddbms) throws IOException {
+      return String.format("Fixing of violation: %s is not supported yet.",
+          this.getClass().getSimpleName());
+    }
+
+    @Override
+    public String fixViolation(S3AFileSystem fs, DynamoDBMetadataStore ddbms)
+        throws IOException {
+      final Path path = getPathMetadata().getFileStatus().getPath();
+      ddbms.forgetMetadata(path);
+      return String.format(
+          "Fixing violation by removing metadata entry from the " +
+              "MS on path: %s", path);
+    }

INS26 INS26 INS40 INS40 INS71 INS31 INS83 INS42 INS72 INS72 UPD42 INS43 INS83 INS39 INS42 INS44 INS43 INS8 INS44 INS43 INS31 INS31 INS42 INS42 INS42 INS43 INS42 INS42 INS25 INS60 INS21 INS21 INS21 INS43 INS42 INS42 INS83 INS43 INS42 INS44 INS44 INS43 INS8 INS78 INS83 INS43 INS42 INS44 INS44 INS43 INS8 INS40 INS38 INS8 INS43 INS59 INS32 INS32 INS32 INS42 INS42 INS43 INS42 INS43 INS42 INS42 INS41 INS42 INS42 INS43 INS42 INS43 INS42 INS42 INS60 INS21 INS41 INS40 INS32 INS21 INS41 INS42 INS42 INS14 INS32 INS42 INS42 INS42 INS42 INS42 INS40 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS83 INS43 INS59 INS32 INS32 INS42 INS42 INS32 INS43 INS32 INS42 INS32 INS42 INS42 INS42 INS42 INS45 INS32 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS27 INS42 INS42 INS42 INS45 INS42 INS42 INS32 INS42 INS45 INS42 INS42 INS50 INS32 INS42 INS32 INS42 INS45 INS45 INS42 INS42 INS42 INS42 INS49 MOV60 MOV21 INS10 INS49 INS60 INS21 INS10 INS49 INS53 INS52 INS42 INS32 INS42 INS42 INS42 INS83 INS43 INS59 INS32 INS14 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS43 INS27 INS42 INS42 INS42 INS42 INS42 INS45 INS42 DEL83