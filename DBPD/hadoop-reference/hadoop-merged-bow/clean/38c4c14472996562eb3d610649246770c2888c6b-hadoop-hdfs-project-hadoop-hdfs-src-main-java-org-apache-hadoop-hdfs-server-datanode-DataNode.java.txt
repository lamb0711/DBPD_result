HDFS-9574. Reduce client failures during datanode restart. Contributed by Kihwal Lee.

+    DataNodeFaultInjector.get().noRegistration();
-    checkBlockToken(blk, token, BlockTokenIdentifier.AccessMode.READ);
+    // Make sure this node has registered for the block pool.
+    try {
+      getDNRegistrationForBP(block.getBlockPoolId());
+    } catch (IOException e) {
+      // if it has not registered with the NN, throw an exception back.
+      throw new org.apache.hadoop.ipc.RetriableException(
+          "Datanode not registered. Try again later.");
+    }
+

INS21 INS54 INS32 INS8 INS12 INS32 INS42 INS21 INS44 INS8 INS42 INS42 INS32 INS43 INS42 INS53 INS42 INS32 INS42 INS14 INS42 INS42 INS43 INS45 INS40 DEL42 DEL42 DEL42 DEL40 DEL32 DEL21