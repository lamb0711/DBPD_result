Merge r1476010 through r1476452 from trunk.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1476453 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.server.blockmanagement.DatanodeDescriptor;
+import org.apache.hadoop.net.NodeBase;
-      final long blocksize) throws IOException {
-    // choose targets for the new block to be allocated.
+      final long blocksize, List<String> favoredNodes) throws IOException {
+    List<DatanodeDescriptor> favoredDatanodeDescriptors = 
+        getDatanodeDescriptors(favoredNodes);
-        numOfReplicas, client, new ArrayList<DatanodeDescriptor>(), false,
-        excludedNodes, blocksize);
+        numOfReplicas, client, excludedNodes, blocksize, 
+        favoredDatanodeDescriptors);
+   * Get list of datanode descriptors for given list of nodes. Nodes are
+   * hostaddress:port or just hostaddress.
+   */
+  List<DatanodeDescriptor> getDatanodeDescriptors(List<String> nodes) {
+    List<DatanodeDescriptor> datanodeDescriptors = null;
+    if (nodes != null) {
+      datanodeDescriptors = new ArrayList<DatanodeDescriptor>(nodes.size());
+      for (int i = 0; i < nodes.size(); i++) {
+        DatanodeDescriptor node = datanodeManager.getDatanodeDescriptor(nodes.get(i));
+        if (node != null) {
+          datanodeDescriptors.add(node);
+        }
+      }
+    }
+    return datanodeDescriptors;
+  }
+
+  /**

INS26 INS26 INS40 INS40 INS31 INS44 INS29 INS74 INS42 INS44 INS8 INS74 INS42 INS60 INS65 INS43 INS43 INS74 INS42 INS60 INS25 INS41 INS43 INS43 INS74 INS59 INS43 INS66 INS66 INS42 INS42 INS43 INS43 INS74 INS59 INS27 INS8 INS42 INS42 INS42 INS43 MOV43 INS42 INS32 INS42 INS42 INS42 INS43 INS43 INS42 INS33 INS42 INS33 INS21 INS24 INS42 INS42 INS42 INS42 INS42 INS42 INS7 INS58 INS27 INS37 INS8 INS42 MOV14 INS39 INS59 INS42 INS32 INS42 INS60 INS25 INS32 INS42 INS34 INS42 INS42 INS43 INS59 INS27 INS8 INS42 INS42 INS42 INS42 INS32 INS42 INS33 INS21 INS42 INS42 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 DEL9