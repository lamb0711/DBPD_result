HDDS-801. Quasi close the container when close is not executed via Ratis.
Contributed by Nanda kumar.

+    .ContainerDataProto;
+import org.apache.hadoop.hdds.protocol.datanode.proto.ContainerProtos
-  public void close() throws StorageContainerException {
+  public void markContainerForClose() throws StorageContainerException {
+    updateContainerData(() ->
+        containerData.setState(ContainerDataProto.State.CLOSING));
+  }
-    //TODO: writing .container file and compaction can be done
-    // asynchronously, otherwise rpc call for this will take a lot of time to
-    // complete this action
+  @Override
+  public void quasiClose() throws StorageContainerException {
+    updateContainerData(containerData::quasiCloseContainer);
+  }
+
+  @Override
+  public void close() throws StorageContainerException {
+    updateContainerData(containerData::closeContainer);
+    // It is ok if this operation takes a bit of time.
+    // Close container is not expected to be instantaneous.
+    compactDB();
+  }
+
+  private void updateContainerData(Runnable update)
+      throws StorageContainerException {
+    ContainerDataProto.State oldState = null;
-
-      containerData.closeContainer();
+      oldState = containerData.getState();
+      update.run();
-      // Failed to update .container file. Reset the state to CLOSING
-      containerData.setState(ContainerProtos.ContainerDataProto.State.CLOSING);
+      if (oldState != null) {
+        // Failed to update .container file. Reset the state to CLOSING
+        containerData.setState(oldState);
+      }
+  }
-    // It is ok if this operation takes a bit of time.
-    // Close container is not expected to be instantaneous.
+  private void compactDB() throws StorageContainerException {
+    case QUASI_CLOSED:
+      state = ContainerReplicaProto.State.QUASI_CLOSED;
+      break;

INS26 INS40 INS31 INS31 INS31 INS31 MOV78 INS83 INS39 INS42 INS43 INS8 INS78 INS83 INS39 INS42 INS43 INS8 INS78 INS83 INS39 INS42 INS43 INS8 INS83 INS39 INS42 INS44 INS43 INS8 UPD83 UPD42 INS42 INS21 INS42 INS42 INS21 INS42 INS42 INS21 INS21 INS43 INS42 INS42 INS60 MOV54 MOV10 INS32 INS32 INS32 INS32 INS42 INS43 INS59 INS49 INS21 INS10 INS42 INS86 INS42 INS90 INS42 INS90 INS42 INS40 INS42 INS33 INS21 INS8 INS42 INS7 INS32 INS42 INS42 INS42 INS42 INS7 INS32 INS25 MOV53 INS42 INS40 INS42 INS42 INS40 INS42 INS32 INS42 INS42 INS27 INS8 MOV42 UPD42 MOV42 INS42 INS33 MOV21 INS42 DEL32 DEL40 DEL8