YARN-1640. Fixed manual failover of ResourceManagers to work correctly in secure clusters. Contributed by Xuan Gong.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1579510 13f79535-47bb-0310-9956-ffa450edef68

+import java.security.PrivilegedExceptionAction;
+
+  private UserGroupInformation rmLoginUGI;
+    this.rmLoginUGI = UserGroupInformation.getCurrentUser();
+
-    startActiveServices();
+
+    // use rmLoginUGI to startActiveServices.
+    // in non-secure model, rmLoginUGI will be current UGI
+    // in secure model, rmLoginUGI will be LoginUser UGI
+    this.rmLoginUGI.doAs(new PrivilegedExceptionAction<Void>() {
+      @Override
+      public Void run() throws Exception {
+        startActiveServices();
+        return null;
+      }
+    });
+
+
+    // if security is enable, set rmLoginUGI as UGI of loginUser
+    if (UserGroupInformation.isSecurityEnabled()) {
+      this.rmLoginUGI = UserGroupInformation.getLoginUser();
+    }

INS26 INS40 INS23 INS83 INS43 INS59 INS42 INS42 INS21 INS21 INS25 INS7 INS32 INS32 INS8 INS22 INS32 INS22 INS42 INS14 INS42 INS42 INS21 INS52 INS42 INS42 INS42 INS52 INS42 INS74 INS1 INS7 INS43 INS43 INS31 INS22 INS32 INS42 INS42 INS78 INS83 INS43 INS42 INS43 INS8 INS52 INS42 INS42 INS42 INS42 INS42 INS42 MOV21 INS41 INS33