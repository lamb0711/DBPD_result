HDFS-13424. Ozone: Refactor MiniOzoneClassicCluster. Contributed by Nanda Kumar.

-  private Configuration conf;
+  private OzoneConfiguration conf;
+  /**
+   * Default constructor.
+   */
+  public HddsDatanodeService() {
+    this(null);
+  }
+
+  /**
+   * Constructs {@link HddsDatanodeService} using the provided {@code conf}
+   * value.
+   *
+   * @param conf OzoneConfiguration
+   */
+  public HddsDatanodeService(Configuration conf) {
+    if (conf == null) {
+      this.conf = new OzoneConfiguration();
+    } else {
+      this.conf = new OzoneConfiguration(conf);
+    }
+  }
+
+  /**
+   * Starts HddsDatanode services.
+   *
+   * @param service The service instance invoking this method
+   */
-    } else {
-      conf = new OzoneConfiguration();
+
+  /**
+   * Starts all the service plugins which are configured using
+   * OzoneConfigKeys.HDDS_DATANODE_PLUGINS_KEY.
+   */
-  public Configuration getConf() {
+  /**
+   * Returns the OzoneConfiguration used by this HddsDatanodeService.
+   *
+   * @return OzoneConfiguration
+   */
+  public OzoneConfiguration getConf() {
-  public void join() throws InterruptedException {
-    datanodeStateMachine.join();
+  public void join() {
+    try {
+      datanodeStateMachine.join();
+    } catch (InterruptedException e) {
+      Thread.currentThread().interrupt();
+      LOG.info("Interrupted during StorageContainerManager join.");
+    }
+    if (plugins != null) {
+      for (ServicePlugin plugin : plugins) {
+        try {
+          plugin.close();
+        } catch (Throwable t) {
+          LOG.warn("ServicePlugin {} could not be closed", plugin, t);
+        }
+      }
+    }
-  public static HddsDatanodeService createHddsDatanodeService(String args[]) {
-    StringUtils.startupShutdownMessage(HddsDatanodeService.class, args, LOG);
-    return new HddsDatanodeService();
+  public static HddsDatanodeService createHddsDatanodeService(
+      Configuration conf) {
+    return new HddsDatanodeService(conf);
-      HddsDatanodeService hddsDatanodeService = createHddsDatanodeService(args);
+      StringUtils.startupShutdownMessage(HddsDatanodeService.class, args, LOG);
+      HddsDatanodeService hddsDatanodeService =
+          createHddsDatanodeService(new OzoneConfiguration());
-      LOG.error("Exception in while starting HddsDatanodeService.", e);
+      LOG.error("Exception in HddsDatanodeService.", e);

INS31 INS31 INS43 INS29 INS83 INS42 INS8 INS29 INS83 INS42 INS44 INS8 INS29 INS29 INS29 INS43 INS8 INS8 INS44 INS8 INS42 INS65 INS17 INS65 INS65 MOV43 INS42 INS25 INS65 INS65 INS65 INS65 INS65 INS42 INS54 INS25 MOV43 INS42 INS41 INS66 INS33 INS66 INS65 INS66 INS65 INS66 INS42 INS66 INS27 MOV8 INS8 INS66 INS42 INS66 INS66 INS66 INS66 INS66 MOV8 INS12 INS27 INS8 INS14 MOV8 INS42 INS66 INS42 INS33 INS21 INS44 INS8 INS42 INS33 INS70 MOV43 INS42 INS60 MOV21 MOV21 INS7 MOV43 INS42 INS21 INS21 INS44 INS42 INS8 MOV43 INS59 INS22 INS22 INS14 INS32 INS32 INS43 INS42 INS54 INS42 INS32 INS52 INS42 INS52 INS42 INS43 INS42 INS32 INS42 INS42 INS42 INS45 INS42 INS8 INS12 INS42 INS14 UPD45 INS42 INS42 INS42 INS21 INS44 INS8 INS43 INS32 INS43 INS42 INS21 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS45 INS42 INS42 DEL42 DEL8 DEL42 DEL43 DEL42 DEL85 DEL44 DEL14 DEL41 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL8