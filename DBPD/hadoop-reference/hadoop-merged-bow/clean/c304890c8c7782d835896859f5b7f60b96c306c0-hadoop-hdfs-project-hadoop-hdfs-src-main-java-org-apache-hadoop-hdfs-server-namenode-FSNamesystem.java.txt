HDFS-9542. Move BlockIdManager from FSNamesystem to BlockManager. Contributed by Jing Zhao.

-import org.apache.hadoop.hdfs.server.blockmanagement.BlockIdManager;
+import org.apache.hadoop.hdfs.server.protocol.BlocksWithLocations;
-  private final BlockIdManager blockIdManager;
-
-    blockIdManager.clear();
-  
-  @Override
+
-      this.blockManager = new BlockManager(this, conf);
+      this.blockManager = new BlockManager(this, haEnabled, conf);
-      this.blockIdManager = new BlockIdManager(blockManager);
-  
-  @Override
+
-  
-  @Override
+
+   * return a list of blocks & their locations on <code>datanode</code> whose
+   * total size is <code>size</code>
+   *
+   * @param datanode on which blocks are located
+   * @param size total size of blocks
+   */
+  public BlocksWithLocations getBlocks(DatanodeID datanode, long size)
+      throws IOException {
+    checkOperation(OperationCategory.READ);
+    readLock();
+    try {
+      checkOperation(OperationCategory.READ);
+      return getBlockManager().getBlocksWithLocations(datanode, size);
+    } finally {
+      readUnlock();
+    }
+  }
+
+  /**
-          blockIdManager.isLegacyBlock(lastBlock));
+          blockManager.isLegacyBlock(lastBlock));
-      throws IOException, SafeModeException {
+      throws IOException {
-    long gs = blockIdManager.nextGenerationStamp(legacyBlock);
+    long gs = blockManager.nextGenerationStamp(legacyBlock);
-    final long blockId = isStriped ?
-        blockIdManager.nextStripedBlockId() : blockIdManager.nextContiguousBlockId();
+    final long blockId = blockManager.nextBlockId(isStriped);
-      block.setGenerationStamp(nextGenerationStamp(blockIdManager.isLegacyBlock(block.getLocalBlock())));
+      block.setGenerationStamp(nextGenerationStamp(
+          blockManager.isLegacyBlock(block.getLocalBlock())));
-  public BlockIdManager getBlockIdManager() {
-    return blockIdManager;
-  }
-
-  
-  @Override
-  public boolean isGenStampInFuture(Block block) {
-    return blockIdManager.isGenStampInFuture(block);
-  }

MOV26 UPD40 INS31 INS29 MOV83 UPD43 MOV43 UPD42 MOV42 INS44 INS44 INS43 INS8 INS65 INS65 INS65 UPD42 INS43 INS42 INS39 INS42 UPD42 MOV42 INS21 INS21 INS54 INS66 INS66 INS42 INS66 INS42 INS66 INS42 INS32 INS32 INS8 INS8 INS42 INS40 INS42 INS21 MOV41 INS21 INS32 INS32 INS32 UPD42 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 INS42 INS40 INS32 INS42 UPD42 UPD42 INS42 INS42 UPD42 MOV42 UPD42 UPD42 DEL83 DEL83 DEL42 DEL43 DEL42 DEL59 DEL23 DEL42 DEL42 DEL32 DEL21 DEL42 DEL78 DEL52 DEL42 DEL22 DEL42 DEL43 DEL42 DEL14 DEL7 DEL21 DEL42 DEL78 DEL42 DEL78 DEL42 DEL43 DEL42 DEL32 DEL42 DEL32 DEL16 DEL42 DEL41 DEL8 DEL31 DEL42 DEL78 DEL83 DEL39 DEL42 DEL43 DEL42 DEL44 DEL8 DEL31