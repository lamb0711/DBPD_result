HDFS-6289. HA failover can fail if there are pending DN messages for DNs which no longer exist. Contributed by Aaron T. Myers.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1591413 13f79535-47bb-0310-9956-ffa450edef68

+  /**
+   * Remove all pending DN messages which reference the given DN.
+   * @param dn the datanode whose messages we should remove.
+   */
+  void removeAllMessagesForDatanode(DatanodeDescriptor dn) {
+    for (Map.Entry<Block, Queue<ReportedBlockInfo>> entry :
+        queueByBlockId.entrySet()) {
+      Queue<ReportedBlockInfo> newQueue = Lists.newLinkedList();
+      Queue<ReportedBlockInfo> oldQueue = entry.getValue();
+      while (!oldQueue.isEmpty()) {
+        ReportedBlockInfo rbi = oldQueue.remove();
+        if (!rbi.getNode().equals(dn)) {
+          newQueue.add(rbi);
+        } else {
+          count--;
+        }
+      }
+      queueByBlockId.put(entry.getKey(), newQueue);
+    }
+  }
+  

INS31 INS29 INS39 INS42 INS44 INS8 INS65 INS65 INS43 INS42 INS70 INS66 INS42 INS66 INS42 INS44 INS32 INS8 INS74 INS42 INS42 INS42 INS60 INS60 INS61 INS21 INS43 INS43 INS74 INS74 INS59 INS74 INS59 INS38 INS8 INS32 INS40 INS42 INS43 INS43 INS43 INS43 INS42 INS32 INS43 INS43 INS42 INS32 INS32 INS60 INS25 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS43 INS59 INS38 INS8 INS8 INS42 INS42 INS42 INS42 INS32 INS32 INS21 INS21 INS42 INS42 INS32 INS42 INS42 INS32 INS37 INS42 INS42 INS42 INS42 INS42 INS42