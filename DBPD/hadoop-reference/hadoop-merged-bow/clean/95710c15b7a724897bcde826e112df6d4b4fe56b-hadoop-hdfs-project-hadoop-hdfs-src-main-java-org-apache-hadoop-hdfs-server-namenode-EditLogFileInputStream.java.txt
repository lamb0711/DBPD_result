HDFS-3335. check for edit log corruption at the end of the log. Contributed by Colin Patrick McCabe.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1338492 13f79535-47bb-0310-9956-ffa450edef68

-    return reader.readOp(false);
+    FSEditLogOp op = reader.readOp(false);
+    if ((op != null) && (op.hasTransactionId())) {
+      long txId = op.getTransactionId();
+      if ((txId >= lastTxId) &&
+          (lastTxId != HdfsConstants.INVALID_TXID)) {
+        //
+        // Sometimes, the NameNode crashes while it's writing to the
+        // edit log.  In that case, you can end up with an unfinalized edit log
+        // which has some garbage at the end.
+        // JournalManager#recoverUnfinalizedSegments will finalize these
+        // unfinished edit logs, giving them a defined final transaction 
+        // ID.  Then they will be renamed, so that any subsequent
+        // readers will have this information.
+        //
+        // Since there may be garbage at the end of these "cleaned up"
+        // logs, we want to be sure to skip it here if we've read everything
+        // we were supposed to read out of the stream.
+        // So we force an EOF on all subsequent reads.
+        //
+        long skipAmt = file.length() - tracker.getPos();
+        if (skipAmt > 0) {
+          FSImage.LOG.warn("skipping " + skipAmt + " bytes at the end " +
+              "of edit log  '" + getName() + "': reached txid " + txId +
+              " out of " + lastTxId);
+          tracker.skip(skipAmt);
+        }
+      }
+    }
+    return op;

INS43 INS42 INS60 INS25 MOV43 INS59 INS27 INS8 INS42 INS42 MOV32 INS36 INS36 INS60 INS25 INS27 INS32 INS39 INS59 INS27 INS8 INS42 INS33 INS42 INS42 INS42 INS32 INS36 INS36 INS60 INS25 INS42 INS42 INS27 INS27 INS39 INS59 INS27 INS8 INS42 INS42 INS42 INS40 INS42 INS27 INS42 INS34 INS21 INS21 INS32 INS32 INS32 INS32 INS42 INS42 INS42 INS42 INS40 INS42 INS27 INS42 INS42 INS42 INS45 INS42 INS45 INS45 INS32 INS45 INS42 INS45 INS42 INS42