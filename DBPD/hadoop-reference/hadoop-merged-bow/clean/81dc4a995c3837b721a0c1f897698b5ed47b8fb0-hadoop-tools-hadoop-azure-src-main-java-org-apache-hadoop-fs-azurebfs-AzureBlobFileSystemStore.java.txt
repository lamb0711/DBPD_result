HADOOP-15663. ABFS: Simplify configuration.
Contributed by Da Zhou.

+import org.apache.hadoop.fs.azurebfs.utils.UriUtils;
+import static org.apache.hadoop.fs.azurebfs.constants.ConfigurationKeys.AZURE_ABFS_ENDPOINT;
-    uriBuilder.setHost(hostName);
+
+    // For testing purposes, an IP address and port may be provided to override
+    // the host specified in the FileSystem URI.  Also note that the format of
+    // the Azure Storage Service URI changes from
+    // http[s]://[account][domain-suffix]/[filesystem] to
+    // http[s]://[ip]:[port]/[account]/[filesystem].
+    String endPoint = abfsConfiguration.getConfiguration().get(AZURE_ABFS_ENDPOINT);
+    if (endPoint == null || !endPoint.contains(AbfsHttpConstants.COLON)) {
+      uriBuilder.setHost(hostName);
+      return uriBuilder;
+    }
+
+    // Split ip and port
+    String[] data = endPoint.split(AbfsHttpConstants.COLON);
+    if (data.length != 2) {
+      throw new RuntimeException(String.format("ABFS endpoint is not set correctly : %s, "
+              + "Do not specify scheme when using {IP}:{PORT}", endPoint));
+    }
+    uriBuilder.setHost(data[0].trim());
+    uriBuilder.setPort(Integer.parseInt(data[1].trim()));
+    uriBuilder.setPath("/" + UriUtils.extractAccountNameFromHostName(hostName));

INS26 INS26 INS40 INS40 INS8 MOV60 MOV60 MOV21 INS60 INS25 INS60 INS25 INS21 INS21 INS21 MOV41 INS43 INS59 INS27 INS8 INS5 INS59 INS27 INS8 INS32 INS32 INS32 INS42 INS42 INS32 INS27 INS38 MOV21 INS41 INS43 INS85 INS42 INS32 INS40 INS34 INS53 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS27 INS32 INS42 INS42 INS42 INS33 INS32 INS42 INS42 INS42 INS42 INS40 INS14 INS2 INS42 INS42 INS42 INS32 INS45 INS32 INS42 INS42 INS42 INS42 INS40 INS43 INS32 INS42 INS34 INS2 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS27 INS42 INS42 INS34 INS45 INS45 DEL8