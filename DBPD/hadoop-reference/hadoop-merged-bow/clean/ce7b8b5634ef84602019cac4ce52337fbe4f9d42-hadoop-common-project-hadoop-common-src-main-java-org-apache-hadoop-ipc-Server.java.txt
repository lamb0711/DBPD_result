HDFS-15148. dfs.namenode.send.qop.enabled should not apply to primary NN port. Contributed by Chen Liang.

-   * set, and the SASL negotiation is done. Otherwise return null. Note
-   * that CurCall is thread local object. So in fact, different handler
-   * threads will process different CurCall object.
+   * set, and the SASL negotiation is done. Otherwise return null
+   * Note this only returns established QOP for auxiliary port, and
+   * returns null for primary (non-auxiliary) port.
+   *
+   * Also note that CurCall is thread local object. So in fact, different
+   * handler threads will process different CurCall object.
-  public static String getEstablishedQOP() {
+  public static String getAuxiliaryPortEstablishedQOP() {
-    if (call == null || !(call instanceof RpcCall)) {
+    if (!(call instanceof RpcCall)) {
-    return rpcCall.connection.getEstablishedQOP();
+    if (rpcCall.connection.isOnAuxiliaryPort()) {
+      return rpcCall.connection.getEstablishedQOP();
+    } else {
+      // Not sending back QOP for primary port
+      return null;
+    }
-    
+    private boolean isOnAuxiliaryPort;
+
+      this.isOnAuxiliaryPort = false;
+    }
+
+    void setIsAuxiliary() {
+      this.isOnAuxiliaryPort = true;
-        Connection c = connectionManager.register(channel, this.listenPort);
+        Connection c = connectionManager.register(channel,
+            this.listenPort, this.isOnAuxiliaryPort);
+    private boolean isOnAuxiliaryPort;
-        int ingressPort) {
+        int ingressPort, boolean isOnAuxiliaryPort) {
+      this.isOnAuxiliaryPort = isOnAuxiliaryPort;
-    
+
+    public boolean isOnAuxiliaryPort() {
+      return isOnAuxiliaryPort;
+    }
+
+    newListener.setIsAuxiliary();
+
-    Connection register(SocketChannel channel, int ingressPort) {
+    Connection register(SocketChannel channel, int ingressPort,
+        boolean isOnAuxiliaryPort) {
-      Connection connection = new Connection(channel, Time.now(), ingressPort);
+      Connection connection = new Connection(channel, Time.now(),
+          ingressPort, isOnAuxiliaryPort);

UPD42 INS23 INS31 INS23 INS31 INS25 INS83 INS39 INS59 INS39 INS42 INS8 INS83 INS39 INS59 INS44 INS83 INS39 INS42 INS8 INS21 INS44 UPD66 INS66 INS66 UPD66 UPD66 MOV38 INS32 INS8 INS8 INS42 INS21 INS21 INS42 INS39 INS42 INS21 INS41 INS32 INS39 INS42 INS40 INS42 MOV41 INS41 INS7 INS7 INS7 INS42 INS42 INS42 INS33 INS22 INS9 INS22 INS9 INS22 INS42 INS52 INS42 INS52 INS42 INS52 INS42 INS42 INS22 INS52 INS42 DEL42 DEL33 DEL27 DEL27