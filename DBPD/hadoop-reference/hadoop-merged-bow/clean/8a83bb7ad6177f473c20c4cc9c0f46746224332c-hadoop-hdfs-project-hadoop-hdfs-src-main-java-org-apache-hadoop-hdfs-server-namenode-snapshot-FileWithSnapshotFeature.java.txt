HDFS-4667. Capture renamed files/directories in snapshot diff report. Contributed by Jing Zhao and Binglin Chang.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1604488 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.server.namenode.INodeFileAttributes;
-  
+
+  boolean changedBetweenSnapshots(INodeFile file, Snapshot from, Snapshot to) {
+    int[] diffIndexPair = diffs.changedBetweenSnapshots(from, to);
+    if (diffIndexPair == null) {
+      return false;
+    }
+    int earlierDiffIndex = diffIndexPair[0];
+    int laterDiffIndex = diffIndexPair[1];
+
+    final List<FileDiff> diffList = diffs.asList();
+    final long earlierLength = diffList.get(earlierDiffIndex).getFileSize();
+    final long laterLength = laterDiffIndex == diffList.size() ? file
+        .computeFileSize(true, false) : diffList.get(laterDiffIndex)
+        .getFileSize();
+    if (earlierLength != laterLength) { // file length has been changed
+      return true;
+    }
+
+    INodeFileAttributes earlierAttr = null; // check the metadata
+    for (int i = earlierDiffIndex; i < laterDiffIndex; i++) {
+      FileDiff diff = diffList.get(i);
+      if (diff.snapshotINode != null) {
+        earlierAttr = diff.snapshotINode;
+        break;
+      }
+    }
+    if (earlierAttr == null) { // no meta-change at all, return false
+      return false;
+    }
+    INodeFileAttributes laterAttr = diffs.getSnapshotINode(
+        Math.max(Snapshot.getSnapshotId(from), Snapshot.getSnapshotId(to)),
+        file);
+    return !earlierAttr.metadataEquals(laterAttr);
+  }
+

INS26 INS40 INS31 INS39 INS42 INS44 INS44 INS44 INS8 INS43 INS42 INS43 INS42 INS43 INS42 INS60 INS25 INS60 INS60 INS60 INS60 INS60 INS25 INS60 INS24 INS25 INS60 INS41 INS42 INS42 INS42 INS5 INS59 INS27 INS8 INS39 INS59 INS39 INS59 INS83 INS74 INS59 INS83 INS39 INS59 INS83 INS39 INS59 INS27 INS8 INS43 INS59 INS58 INS27 INS37 INS8 INS27 INS8 INS43 INS59 INS38 INS39 INS85 INS42 INS32 INS42 INS33 INS41 INS42 INS2 INS42 INS2 INS43 INS43 INS42 INS32 INS42 INS32 INS42 INS16 INS42 INS42 INS41 INS42 INS42 INS33 INS39 INS59 INS42 INS42 INS42 INS60 INS25 INS42 INS33 INS41 INS42 INS42 INS32 INS32 INS42 INS42 INS42 INS42 INS9 INS42 INS34 INS42 INS34 INS42 INS42 INS42 INS42 INS32 INS42 INS27 INS32 INS32 INS9 INS42 INS42 INS43 INS59 INS27 INS8 INS9 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS9 INS9 INS32 INS42 INS42 INS42 INS32 INS40 INS33 INS21 INS10 INS42 INS42 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS7 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS40