HDFS-7621. Erasure Coding: update the Balancer/Mover data migration logic. Contributed by Walter Su.

+import org.apache.hadoop.io.erasurecode.ECSchema;
+import static org.apache.hadoop.hdfs.util.StripedBlockUtil.getInternalBlockLength;
+
-  DBlock newDBlock(Block block, List<MLocation> locations) {
-    final DBlock db = new DBlock(block);
+  DBlock newDBlock(LocatedBlock lb, List<MLocation> locations,
+                   ECSchema ecSchema) {
+    Block blk = lb.getBlock().getLocalBlock();
+    DBlock db;
+    if (lb.isStriped()) {
+      LocatedStripedBlock lsb = (LocatedStripedBlock) lb;
+      byte[] indices = new byte[lsb.getBlockIndices().length];
+      for (int i = 0; i < indices.length; i++) {
+        indices[i] = (byte) lsb.getBlockIndices()[i];
+      }
+      db = new DBlockStriped(blk, indices, (short) ecSchema.getNumDataUnits());
+    } else {
+      db = new DBlock(blk);
+    }
-      final List<StorageType> types = policy.chooseStorageTypes(
+      List<StorageType> types = policy.chooseStorageTypes(
+      final ECSchema ecSchema = status.getECSchema();
+        if (lb.isStriped()) {
+          types = policy.chooseStorageTypes((short) lb.getLocations().length);
+        }
-          if (scheduleMoves4Block(diff, lb)) {
+          if (scheduleMoves4Block(diff, lb, ecSchema)) {
-    boolean scheduleMoves4Block(StorageTypeDiff diff, LocatedBlock lb) {
+    boolean scheduleMoves4Block(StorageTypeDiff diff, LocatedBlock lb,
+                                ECSchema ecSchema) {
-      Collections.shuffle(locations);
-      final DBlock db = newDBlock(lb.getBlock().getLocalBlock(), locations);
+      if (!(lb instanceof LocatedStripedBlock)) {
+        Collections.shuffle(locations);
+      }
+      final DBlock db = newDBlock(lb, locations, ecSchema);
-}
+}

INS26 INS26 INS40 INS40 INS44 INS8 INS43 INS42 INS43 INS42 MOV60 INS60 INS25 MOV70 MOV41 INS44 INS42 INS42 MOV43 MOV43 INS59 INS32 INS8 INS8 INS60 INS43 INS42 INS25 INS60 INS42 MOV32 INS42 INS42 INS42 MOV60 INS60 INS24 INS21 INS21 INS83 INS43 INS59 INS42 INS38 INS8 INS83 MOV43 INS59 INS43 INS5 INS59 INS58 INS27 INS37 INS8 INS7 INS7 INS42 INS42 INS32 INS25 INS36 MOV21 INS42 INS32 INS42 UPD42 INS11 INS39 INS85 INS42 INS3 INS39 INS59 INS42 INS40 INS42 INS21 INS42 INS14 INS42 INS14 INS42 INS42 INS32 INS8 INS62 INS42 INS42 INS42 INS42 INS43 INS42 INS5 INS22 INS42 INS34 INS7 INS43 INS42 INS42 INS11 MOV43 INS42 INS42 INS42 INS21 INS42 INS43 INS42 INS39 INS85 INS32 INS42 INS2 INS11 INS42 INS39 INS32 INS7 INS42 INS42 INS42 INS42 INS42 INS39 INS2 INS42 INS42 INS42 INS32 INS42 INS32 INS42 INS42 INS42 INS11 INS42 INS42 INS39 INS22 INS32 INS42 INS42 INS42 DEL42 DEL83 DEL42 DEL42 DEL42 DEL32 DEL83 DEL42 DEL14 DEL8 DEL83