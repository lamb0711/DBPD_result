HDFS-14388. RBF: Prevent loading metric system when disabled. Contributed by Inigo Goiri.

+import org.apache.hadoop.hdfs.server.federation.metrics.NullStateStoreMetrics;
-    // Create metrics for the State Store
-    this.metrics = StateStoreMetrics.create(conf);
+    if (conf.getBoolean(RBFConfigKeys.DFS_ROUTER_METRICS_ENABLE,
+        RBFConfigKeys.DFS_ROUTER_METRICS_ENABLE_DEFAULT)) {
+      // Create metrics for the State Store
+      this.metrics = StateStoreMetrics.create(conf);
-    // Adding JMX interface
-    try {
-      StandardMBean bean = new StandardMBean(metrics, StateStoreMBean.class);
-      ObjectName registeredObject =
-          MBeans.register("Router", "StateStore", bean);
-      LOG.info("Registered StateStoreMBean: {}", registeredObject);
-    } catch (NotCompliantMBeanException e) {
-      throw new RuntimeException("Bad StateStoreMBean setup", e);
-    } catch (MetricsException e) {
-      LOG.error("Failed to register State Store bean {}", e.getMessage());
+      // Adding JMX interface
+      try {
+        StandardMBean bean = new StandardMBean(metrics, StateStoreMBean.class);
+        ObjectName registeredObject =
+            MBeans.register("Router", "StateStore", bean);
+        LOG.info("Registered StateStoreMBean: {}", registeredObject);
+      } catch (NotCompliantMBeanException e) {
+        throw new RuntimeException("Bad StateStoreMBean setup", e);
+      } catch (MetricsException e) {
+        LOG.error("Failed to register State Store bean {}", e.getMessage());
+      }
+    } else {
+      LOG.info("State Store metrics not enabled");
+      this.metrics = new NullStateStoreMetrics();

INS26 INS40 INS25 INS32 INS8 INS8 INS42 INS42 INS40 INS40 MOV21 MOV54 INS21 INS21 INS32 INS7 INS42 INS42 INS45 INS22 INS14 INS52 INS42 INS43 INS42