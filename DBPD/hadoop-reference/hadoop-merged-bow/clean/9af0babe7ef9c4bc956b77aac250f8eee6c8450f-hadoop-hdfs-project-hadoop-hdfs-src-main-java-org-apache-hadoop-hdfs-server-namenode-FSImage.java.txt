Merging trunk after fixing conflict with HDFS-4434.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1470089 13f79535-47bb-0310-9956-ffa450edef68

-      updateCountForQuota(target.dir.rootDir);   
+      updateCountForQuota(target.dir, target.dir.rootDir);   
-  static void updateCountForQuota(INodeDirectoryWithQuota root) {
-    updateCountForQuotaRecursively(root, new Quota.Counts());
+  static void updateCountForQuota(FSDirectory fsd, 
+      INodeDirectoryWithQuota root) {
+    updateCountForQuotaRecursively(fsd, root, new Quota.Counts());
-  private static void updateCountForQuotaRecursively(INodeDirectory dir,
-      Quota.Counts counts) {
+  private static void updateCountForQuotaRecursively(FSDirectory fsd,
+      INodeDirectory dir, Quota.Counts counts) {
+      fsd.addToInodeMapUnprotected(child);
-        updateCountForQuotaRecursively(child.asDirectory(), counts);
+        updateCountForQuotaRecursively(fsd, child.asDirectory(), counts);

INS44 INS44 INS43 INS42 INS43 INS42 INS42 INS42 INS42 INS21 INS32 INS40 INS42 INS42 INS42 INS42