Merge branch 'HDFS-9806' into trunk

-  private final Map<String, DatanodeStorageInfo> storageMap =
+  protected final Map<String, DatanodeStorageInfo> storageMap =
+        if (StorageType.PROVIDED.equals(storage.getStorageType())) {
+          // to verify provided storage participated in this hb, requires
+          // check to pass DNDesc.
+          // e.g., storageInfo.verifyBlockReportId(this, curBlockReportId)
+          continue;
+        }
-      DatanodeStorageInfo storage = updateStorage(report.getStorage());
+
+      DatanodeStorageInfo storage =
+          storageMap.get(report.getStorage().getStorageID());
+      // skip accounting for capacity of PROVIDED storages!
+      if (StorageType.PROVIDED.equals(storage.getStorageType())) {
+        continue;
+      }
+
+  void injectStorage(DatanodeStorageInfo s) {
+    synchronized (storageMap) {
+      DatanodeStorageInfo storage = storageMap.get(s.getStorageID());
+      if (null == storage) {
+        LOG.info("Adding new storage ID {} for DN {}", s.getStorageID(),
+            getXferAddr());
+        DFSTopologyNodeImpl parent = null;
+        if (getParent() instanceof DFSTopologyNodeImpl) {
+          parent = (DFSTopologyNodeImpl) getParent();
+        }
+        StorageType type = s.getStorageType();
+        if (!hasStorageType(type) && parent != null) {
+          // we are about to add a type this node currently does not have,
+          // inform the parent that a new type is added to this datanode
+          parent.childAddStorage(getName(), type);
+        }
+        storageMap.put(s.getStorageID(), s);
+      } else {
+        assert storage == s : "found " + storage + " expected " + s;
+      }
+    }
+  }
+
-      storage.setBlockReportCount(0);
+      if (storage.getStorageType() != StorageType.PROVIDED) {
+        storage.setBlockReportCount(0);
+      }

INS31 UPD83 INS39 INS42 INS44 INS8 INS43 INS42 INS51 INS42 INS42 INS8 INS8 INS25 INS60 INS25 INS25 INS32 INS8 INS43 INS59 INS27 INS8 INS8 INS27 MOV8 INS25 INS32 INS40 INS42 INS32 INS18 INS42 INS42 INS32 INS33 INS42 INS21 INS60 INS25 INS60 INS25 INS21 INS6 INS32 INS40 INS32 INS8 INS42 INS42 MOV32 MOV42 INS42 INS42 INS42 INS42 INS32 INS32 INS43 INS59 INS62 INS8 INS43 INS59 INS27 INS8 INS32 INS27 INS27 INS42 INS42 INS40 INS42 INS32 INS18 UPD42 INS42 INS42 INS42 INS42 INS45 INS32 INS32 INS42 INS42 INS33 INS32 INS43 INS21 INS42 INS42 INS32 INS38 INS27 INS21 INS42 INS42 INS32 INS42 INS42 INS42 INS45 INS42 INS45 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS7 INS42 INS42 INS32 INS42 INS33 INS32 INS42 INS42 INS42 INS11 INS42 INS42 INS42 INS42 INS32 INS42 INS43 INS32 INS42 INS42 INS42