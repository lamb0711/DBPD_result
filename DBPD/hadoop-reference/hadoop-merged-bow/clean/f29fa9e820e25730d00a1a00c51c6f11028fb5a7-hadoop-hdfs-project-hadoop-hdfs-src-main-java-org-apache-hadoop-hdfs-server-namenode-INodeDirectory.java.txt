HDFS-4499. Fix file/directory/snapshot deletion for file diff.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1448504 13f79535-47bb-0310-9956-ffa450edef68

-  public int destroySubtreeAndCollectBlocksRecursively(final Snapshot snapshot,
+  /**
+   * Call {@link INode#cleanSubtree(SnapshotDeletionInfo, BlocksMapUpdateInfo)}
+   * recursively down the subtree.
+   */
+  public int cleanSubtreeRecursively(final Snapshot snapshot, Snapshot prior,
-    for (INode child : getChildrenList(snapshot)) {
-      total += child.destroySubtreeAndCollectBlocks(snapshot, collectedBlocks);
+    // in case of deletion snapshot, since this call happens after we modify
+    // the diff list, the snapshot to be deleted has been combined or renamed
+    // to its latest previous snapshot.
+    Snapshot s = snapshot != null && prior != null ? prior : snapshot;
+    for (INode child : getChildrenList(s)) {
+      total += child.cleanSubtree(snapshot, prior, collectedBlocks);
-  public int destroySubtreeAndCollectBlocks(final Snapshot snapshot,
+  public int destroyAndCollectBlocks(
-    int total = destroySubtreeAndCollectBlocksRecursively(
-        snapshot, collectedBlocks);
-    if (snapshot == null) {
-      total++; //count this dir only if this object is destroyed  
-      clearReferences();
+    int total = 0;
+    for (INode child : getChildrenList(null)) {
+      total += child.destroyAndCollectBlocks(collectedBlocks);
+    }
+    clearReferences();
+    total++;
+    return total;
+  }
+  
+  @Override
+  public int cleanSubtree(final Snapshot snapshot, Snapshot prior,
+      final BlocksMapUpdateInfo collectedBlocks) {
+    int total = 0;
+    if (prior == null && snapshot == null) {
+      // destroy the whole subtree and collect blocks that should be deleted
+      total += destroyAndCollectBlocks(collectedBlocks);
+    } else {
+      // process recursively down the subtree
+      total += cleanSubtreeRecursively(snapshot, prior, collectedBlocks);

INS31 INS29 UPD42 INS44 MOV78 INS83 INS39 INS42 MOV44 INS8 INS78 INS42 INS44 INS44 INS65 INS43 INS42 INS60 INS41 INS60 INS70 MOV21 MOV21 MOV41 INS42 INS43 INS42 INS83 INS43 INS42 INS60 INS25 MOV41 INS66 INS65 INS66 INS42 INS43 INS59 INS42 INS39 INS59 INS44 INS32 INS8 INS42 INS42 MOV39 INS59 INS27 INS8 INS8 INS68 INS42 INS42 INS16 UPD42 INS42 INS34 INS43 INS42 INS42 INS33 INS21 MOV42 INS34 INS27 MOV27 INS21 INS21 INS42 INS42 INS69 INS69 INS27 INS42 INS42 INS42 INS7 INS42 INS33 INS7 INS7 INS43 INS43 INS27 INS27 INS42 INS32 INS42 INS32 INS42 INS32 INS42 INS42 INS42 INS33 INS42 INS33 UPD42 INS42 INS42 INS42 INS42 INS42 INS42 UPD42 MOV42 MOV42 INS42 MOV42 DEL42 DEL32 DEL59 DEL60 DEL8 DEL25