YARN-6617. Services API delete call first attempt usually fails. Contributed by Jian He

+  private static EnumSet<YarnApplicationState> terminatedStates = EnumSet
+      .of(YarnApplicationState.FINISHED, YarnApplicationState.FAILED,
+          YarnApplicationState.KILLED);
-    submissionContext.setQueue(conf.get(KEY_YARN_QUEUE, DEFAULT_YARN_QUEUE));
+    submissionContext.setQueue(conf.get(KEY_YARN_QUEUE, app.getQueue()));
-    if (app.getYarnApplicationState().ordinal() >= YarnApplicationState.FINISHED
-        .ordinal()) {
-      log.info("Application {} is in a terminated state {}", appName,
+    if (terminatedStates.contains(app.getYarnApplicationState())) {
+      log.info("Application {} is already in a terminated state {}", appName,
-      log.info("Application " + appName + " is gracefully stopped.");
-    } catch (IOException | YarnException e){
+      log.info("Application " + appName + " is being gracefully stopped...");
+      long startTime = System.currentTimeMillis();
+      int pollCount = 0;
+      while (true) {
+        Thread.sleep(200);
+        ApplicationReport report =
+            yarnClient.getApplicationReport(app.getApplicationId());
+        if (terminatedStates.contains(report.getYarnApplicationState())) {
+          log.info("Application " + appName + " is stopped.");
+          break;
+        }
+        // kill after 10 seconds.
+        if ((System.currentTimeMillis() - startTime) > 10000) {
+          log.info("Stop operation timeout stopping, forcefully kill the app "
+              + appName);
+          yarnClient
+              .killApplication(app.getApplicationId(), freezeArgs.message);
+          break;
+        }
+        if (++pollCount % 10 == 0) {
+          log.info("Waiting for application " + appName + " to be stopped.");
+        }
+      }
+    } catch (IOException | YarnException | InterruptedException e) {

INS23 INS83 INS83 INS74 INS59 INS43 INS43 INS42 INS32 INS42 INS42 INS42 INS42 INS40 INS40 INS40 MOV32 MOV32 UPD42 INS42 INS60 INS60 INS61 INS32 INS39 INS59 INS39 INS59 INS9 INS8 UPD84 UPD42 MOV42 INS42 UPD45 INS42 INS32 INS42 INS34 INS21 INS60 INS25 INS25 INS25 INS43 UPD45 INS42 INS42 INS32 INS43 INS59 INS32 INS8 INS27 INS8 INS27 INS8 INS42 INS42 INS42 INS34 INS42 INS42 INS32 INS42 INS42 INS32 INS21 INS10 INS36 INS34 INS21 INS21 INS10 INS27 INS34 INS21 INS42 INS42 INS32 INS42 INS42 INS32 INS27 INS32 INS32 INS38 INS34 INS32 INS42 INS42 INS42 INS42 INS27 INS32 INS42 INS42 INS42 INS27 INS42 INS42 INS32 INS40 INS42 INS42 INS42 INS27 INS45 INS42 INS45 INS42 INS42 INS45 INS42 INS42 INS42 INS45 INS42 INS45 DEL40 DEL42 DEL32 DEL27