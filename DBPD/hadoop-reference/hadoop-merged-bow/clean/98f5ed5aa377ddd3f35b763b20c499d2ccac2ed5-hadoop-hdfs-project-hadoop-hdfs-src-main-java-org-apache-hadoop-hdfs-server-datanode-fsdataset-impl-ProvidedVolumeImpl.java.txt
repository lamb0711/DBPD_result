HDFS-11902. [READ] Merge BlockFormatProvider and FileRegionProvider.

-import org.apache.hadoop.hdfs.server.common.FileRegionProvider;
-import org.apache.hadoop.hdfs.server.common.TextFileRegionProvider;
+import org.apache.hadoop.hdfs.server.common.blockaliasmap.BlockAliasMap;
+import org.apache.hadoop.hdfs.server.common.blockaliasmap.impl.TextFileRegionAliasMap;
-    private FileRegionProvider provider;
+    private BlockAliasMap<FileRegion> aliasMap;
-      Class<? extends FileRegionProvider> fmt =
-          conf.getClass(DFSConfigKeys.DFS_PROVIDER_CLASS,
-              TextFileRegionProvider.class, FileRegionProvider.class);
-      provider = ReflectionUtils.newInstance(fmt, conf);
+      Class<? extends BlockAliasMap> fmt =
+          conf.getClass(DFSConfigKeys.DFS_PROVIDED_ALIASMAP_CLASS,
+              TextFileRegionAliasMap.class, BlockAliasMap.class);
+      aliasMap = ReflectionUtils.newInstance(fmt, conf);
-      LOG.info("Created provider: " + provider.getClass());
+      LOG.info("Created alias map using class: " + aliasMap.getClass());
-    FileRegionProvider getFileRegionProvider() {
-      return provider;
+    BlockAliasMap<FileRegion> getBlockAliasMap() {
+      return aliasMap;
-    void setFileRegionProvider(FileRegionProvider newProvider) {
-      this.provider = newProvider;
+    void setFileRegionProvider(BlockAliasMap<FileRegion> blockAliasMap) {
+      this.aliasMap = blockAliasMap;
-      Iterator<FileRegion> iter = provider.iterator();
+      BlockAliasMap.Reader<FileRegion> reader = aliasMap.getReader(null);
+      if (reader == null) {
+        LOG.warn("Got null reader from BlockAliasMap " + aliasMap
+            + "; no blocks will be populated");
+        return;
+      }
+      Iterator<FileRegion> iter = reader.iterator();
-      /* refresh the provider and return the list of blocks found.
+      /* refresh the aliasMap and return the list of blocks found.
-      provider.refresh();
-      Iterator<FileRegion> iter = provider.iterator();
+      aliasMap.refresh();
+      BlockAliasMap.Reader<FileRegion> reader = aliasMap.getReader(null);
+      if (reader == null) {
+        LOG.warn("Got null reader from BlockAliasMap " + aliasMap
+            + "; no blocks will be populated in scan report");
+        return;
+      }
+      Iterator<FileRegion> iter = reader.iterator();
-    private FileRegionProvider provider;
+    private BlockAliasMap<FileRegion> blockAliasMap;
-        FileRegionProvider provider) {
+        BlockAliasMap<FileRegion> blockAliasMap) {
-      this.provider = provider;
+      this.blockAliasMap = blockAliasMap;
-      blockIterator = provider.iterator();
+      BlockAliasMap.Reader<FileRegion> reader = null;
+      try {
+        reader = blockAliasMap.getReader(null);
+      } catch (IOException e) {
+        LOG.warn("Exception in getting reader from provided alias map");
+      }
+      if (reader != null) {
+        blockIterator = reader.iterator();
+      } else {
+        blockIterator = null;
+      }
-        bpSlices.get(bpid).getFileRegionProvider());
+        bpSlices.get(bpid).getBlockAliasMap());
-        bpSlices.get(bpid).getFileRegionProvider());
+        bpSlices.get(bpid).getBlockAliasMap());
-  FileRegionProvider getFileRegionProvider(String bpid) throws IOException {
-    return getProvidedBlockPoolSlice(bpid).getFileRegionProvider();
+  BlockAliasMap<FileRegion> getBlockFormat(String bpid) throws IOException {
+    return getProvidedBlockPoolSlice(bpid).getBlockAliasMap();
-  void setFileRegionProvider(String bpid, FileRegionProvider provider)
-      throws IOException {
+  void setFileRegionProvider(String bpid,
+      BlockAliasMap<FileRegion> blockAliasMap) throws IOException {
-    bp.setFileRegionProvider(provider);
+    bp.setFileRegionProvider(blockAliasMap);

MOV26 UPD40 UPD40 MOV8 MOV8 INS74 UPD42 INS74 INS74 UPD42 INS74 INS8 INS60 MOV21 INS43 INS43 INS74 UPD42 INS43 INS43 UPD42 INS43 INS43 INS74 UPD42 INS60 INS25 INS60 INS25 INS43 INS43 UPD42 INS74 UPD42 INS60 INS54 INS25 MOV21 MOV14 MOV43 INS59 MOV42 INS42 UPD42 MOV42 INS43 INS43 INS42 UPD42 MOV42 UPD74 INS42 UPD42 MOV42 UPD42 INS43 INS43 INS74 INS59 INS27 INS8 INS74 INS59 INS27 INS8 INS42 UPD42 MOV42 INS43 INS43 INS74 INS59 INS8 INS12 INS27 INS8 INS8 INS42 MOV14 UPD42 INS42 UPD42 MOV42 UPD42 UPD76 UPD42 INS42 UPD42 MOV42 UPD42 INS43 INS43 INS42 INS32 INS42 INS33 INS21 INS41 UPD42 INS43 INS43 INS42 INS32 INS42 INS33 INS21 INS41 INS42 UPD42 MOV42 UPD42 INS43 INS43 INS42 INS33 INS21 INS44 INS8 INS42 INS33 MOV21 INS21 UPD42 UPD43 UPD40 UPD45 UPD42 INS40 INS42 INS42 INS42 INS33 INS32 UPD42 INS40 INS42 INS42 INS42 INS33 INS32 UPD42 UPD42 INS40 INS42 INS7 INS43 INS42 INS21 INS7 UPD42 UPD42 UPD43 UPD43 UPD42 INS42 INS42 INS27 INS42 INS42 INS27 INS42 INS32 INS42 INS32 INS42 INS33 UPD42 UPD42 INS45 INS42 INS45 INS45 INS42 INS45 INS42 INS42 INS33 INS42 INS42 INS45 UPD42 DEL43 DEL43 DEL43 DEL43 DEL43 DEL8 DEL42 DEL59 DEL60 DEL43 DEL43