HDFS-4773. Fix bugs in quota usage computation and OfflineImageViewer.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1477367 13f79535-47bb-0310-9956-ffa450edef68

-   * Search for the snapshot whose id is 1) no larger than the given id, and 2)
-   * most close to the given id
-   */
-  public final Snapshot searchSnapshotById(final int snapshotId) {
-    final int i = Collections.binarySearch(diffs, snapshotId);
-    if (i == -1) {
-      return null;
-    } else {
-      int index = i < 0 ? -i - 2 : i;
-      return diffs.get(index).getSnapshot();
-    }
-  }
-  
-  /**
-    if (snapshot == null) {
-      // snapshot == null means the current state, therefore, return null.
+    return getDiffById(snapshot == null ? 
+        Snapshot.INVALID_ID : snapshot.getId());
+  }
+  
+  private final D getDiffById(final int snapshotId) {
+    if (snapshotId == Snapshot.INVALID_ID) {
-    final int i = Collections.binarySearch(diffs, snapshot.getId());
+    final int i = Collections.binarySearch(diffs, snapshotId);
-      // snapshot was not recorded.  Thus, return the next state.
+      // snapshot was not recorded. Thus, return the next state.
+   * Search for the snapshot whose id is 1) no less than the given id, 
+   * and 2) most close to the given id.
+   */
+  public final Snapshot getSnapshotById(final int snapshotId) {
+    D diff = getDiffById(snapshotId);
+    return diff == null ? null : diff.getSnapshot();
+  }
+  
+  /**

MOV31 INS31 MOV29 INS83 INS83 INS43 INS42 MOV44 INS8 UPD83 UPD42 MOV44 UPD42 INS44 INS8 INS42 INS41 MOV60 INS83 INS39 INS42 MOV60 MOV41 INS32 INS27 UPD66 UPD66 INS43 INS59 INS16 INS42 INS16 INS42 INS40 INS42 INS42 INS32 INS27 INS33 INS32 MOV27 INS40 MOV32 INS42 INS42 INS42 INS33 UPD42 MOV42 MOV42 DEL83 DEL39 DEL42 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL39 DEL42 DEL42 DEL34 DEL27 DEL42 DEL38 DEL34 DEL27 DEL42 DEL16 DEL59 DEL42 DEL42 DEL32 DEL32 DEL42 DEL34 DEL38 DEL27 DEL33 DEL41 DEL8 DEL8 DEL25 DEL8