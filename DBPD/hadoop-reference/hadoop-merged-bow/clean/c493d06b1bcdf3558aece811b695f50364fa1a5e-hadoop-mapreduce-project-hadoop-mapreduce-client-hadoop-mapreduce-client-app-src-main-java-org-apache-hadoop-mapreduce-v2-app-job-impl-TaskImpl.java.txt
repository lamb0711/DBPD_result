MAPREDUCE-4425. Speculation + Fetch failures can lead to a hung job (jlowe via bobby)


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1408360 13f79535-47bb-0310-9956-ffa450edef68

+    .addTransition(TaskStateInternal.SUCCEEDED, TaskStateInternal.SUCCEEDED,
+        TaskEventType.T_ATTEMPT_SUCCEEDED,
+        new AttemptSucceededAtSucceededTransition())
-            TaskEventType.T_ATTEMPT_SUCCEEDED,
+        task.finishedAttempts.add(castEvent.getTaskAttemptID());
+        task.inProgressAttempts.remove(castEvent.getTaskAttemptID());
+          task.finishedAttempts.add(castEvent.getTaskAttemptID());
+          task.inProgressAttempts.remove(castEvent.getTaskAttemptID());
+  private static class AttemptSucceededAtSucceededTransition
+    implements SingleArcTransition<TaskImpl, TaskEvent> {
+    @Override
+    public void transition(TaskImpl task, TaskEvent event) {
+      TaskTAttemptEvent castEvent = (TaskTAttemptEvent) event;
+      task.finishedAttempts.add(castEvent.getTaskAttemptID());
+      task.inProgressAttempts.remove(castEvent.getTaskAttemptID());
+    }
+  }
+

INS55 INS83 INS83 INS42 INS74 INS31 INS43 INS43 INS43 INS78 INS83 INS39 INS42 INS44 INS44 INS8 INS42 INS42 INS42 INS42 INS43 INS42 INS43 INS42 INS60 INS21 INS21 INS42 INS42 INS43 INS59 INS32 INS32 INS32 INS42 INS21 INS21 INS42 INS42 INS11 INS40 INS42 INS32 INS40 INS42 INS32 MOV32 MOV42 INS40 INS40 INS32 INS32 INS32 INS43 INS42 INS42 INS42 INS42 INS42 MOV40 INS14 INS42 INS42 INS40 INS40 INS40 INS40 INS40 INS42 INS32 INS40 INS42 INS32 INS21 INS21 INS42 INS43 INS42 INS42 INS42 INS42 INS32 INS32 INS42 INS40 INS42 INS32 INS40 INS42 INS32 INS42 INS42 INS42 INS42 DEL42 DEL42 DEL40 DEL40 DEL40 DEL40 DEL32