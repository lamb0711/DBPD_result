HDDS-2198. SCM should not consider containers in CLOSING state to come out of safemode. (#1540)


+import java.util.Optional;
-    if(containers != null) {
-      containers.forEach(c -> {
-        // TODO: There can be containers in OPEN state which were never
-        // created by the client. We are not considering these containers for
-        // now. These containers can be handled by tracking pipelines.
-        if (c != null && c.getState() != null &&
-            !c.getState().equals(HddsProtos.LifeCycleState.OPEN)) {
-          containerMap.put(c.getContainerID(), c);
-        }
-      });
-      maxContainer = containerMap.size();
-    }
+    containers.forEach(container -> {
+      // There can be containers in OPEN/CLOSING state which were never
+      // created by the client. We are not considering these containers for
+      // now. These containers can be handled by tracking pipelines.
+      Optional.ofNullable(container.getState())
+          .filter(state -> state != HddsProtos.LifeCycleState.OPEN)
+          .filter(state -> state != HddsProtos.LifeCycleState.CLOSING)
+          .ifPresent(s -> containerMap.put(container.getContainerID(),
+              container));
+    });
+    maxContainer = containerMap.size();

INS26 INS40 MOV21 MOV21 UPD42 INS21 INS32 INS32 INS42 INS86 INS32 INS42 INS86 INS59 INS32 INS32 UPD42 MOV42 INS86 INS59 INS27 INS42 MOV42 MOV42 MOV32 UPD42 MOV42 INS42 INS42 INS32 INS59 INS27 INS42 INS42 INS40 UPD42 UPD42 MOV42 MOV42 INS42 INS42 INS40 DEL42 DEL33 DEL27 DEL32 DEL33 DEL27 DEL27 DEL42 DEL32 DEL42 DEL40 DEL32 DEL38 DEL27 DEL32 DEL21 DEL8 DEL25 DEL42 DEL33 DEL27 DEL8 DEL25