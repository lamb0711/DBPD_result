YARN-4356. Ensure the timeline service v.2 is disabled cleanly and has no
impact when it's turned off. Contributed by Sangjin Lee.

-  final String flowName;
-  final String flowVersion;
-  final long flowRunId;
+  // flow context is set only if the timeline service v.2 is enabled
+  private FlowContext flowContext;
-  public ApplicationImpl(Dispatcher dispatcher, String user, String flowName,
-      String flowVersion, long flowRunId, ApplicationId appId,
-      Credentials credentials, Context context,
+  public ApplicationImpl(Dispatcher dispatcher, String user,
+      ApplicationId appId, Credentials credentials, Context context) {
+    this(dispatcher, user, null, appId, credentials, context, -1L);
+  }
+
+  public ApplicationImpl(Dispatcher dispatcher, String user,
+      ApplicationId appId, Credentials credentials, Context context,
+    this(dispatcher, user, null, appId, credentials, context,
+      recoveredLogInitedTime);
+  }
+
+  public ApplicationImpl(Dispatcher dispatcher, String user,
+      FlowContext flowContext, ApplicationId appId, Credentials credentials,
+      Context context, long recoveredLogInitedTime) {
-    this.flowName = flowName;
-    this.flowVersion = flowVersion;
-    this.flowRunId = flowRunId;
+    this.flowContext = flowContext;
-  public ApplicationImpl(Dispatcher dispatcher, String user, String flowId,
-      String flowVersion, long flowRunId, ApplicationId appId,
+  public ApplicationImpl(Dispatcher dispatcher, String user,
+      FlowContext flowContext, ApplicationId appId,
-    this(dispatcher, user, flowId, flowVersion, flowRunId, appId, credentials,
+    this(dispatcher, user, flowContext, appId, credentials,
-    if (YarnConfiguration.systemMetricsPublisherEnabled(conf)) {
-      createAndStartTimelineClient(conf);
+    if (YarnConfiguration.timelineServiceV2Enabled(conf)) {
+      if (flowContext == null) {
+        throw new IllegalArgumentException("flow context cannot be null");
+      }
+      this.flowContext = flowContext;
+      if (YarnConfiguration.systemMetricsPublisherEnabled(conf)) {
+        createAndStartTimelineClient(conf);
+      }
-  
+
+  /**
+   * Data object that encapsulates the flow context for the application purpose.
+   */
+  public static class FlowContext {
+    private final String flowName;
+    private final String flowVersion;
+    private final long flowRunId;
+
+    public FlowContext(String flowName, String flowVersion, long flowRunId) {
+      this.flowName = flowName;
+      this.flowVersion = flowVersion;
+      this.flowRunId = flowRunId;
+    }
+
+    public String getFlowName() {
+      return flowName;
+    }
+
+    public String getFlowVersion() {
+      return flowVersion;
+    }
+
+    public long getFlowRunId() {
+      return flowRunId;
+    }
+  }
+
-      app.context.getRegisteredCollectors().remove(app.getAppId());
+      Map<ApplicationId, String> registeredCollectors =
+          app.context.getRegisteredCollectors();
+      if (registeredCollectors != null) {
+        registeredCollectors.remove(app.getAppId());
+      }
-    return flowName;
+    return flowContext == null ? null : flowContext.getFlowName();
-    return flowVersion;
+    return flowContext == null ? null : flowContext.getFlowVersion();
-    return flowRunId;
+    return flowContext == null ? 0L : flowContext.getFlowRunId();

INS23 INS31 INS31 INS55 INS31 INS31 INS31 INS83 INS43 INS59 INS83 INS42 INS44 INS44 INS44 INS44 INS44 INS8 INS83 INS42 INS44 INS44 INS44 INS44 INS44 INS44 INS8 INS44 INS29 INS83 INS83 INS42 MOV23 MOV23 MOV23 INS31 MOV31 MOV31 MOV31 MOV78 INS83 MOV43 INS42 INS8 MOV78 INS83 INS43 INS42 INS8 MOV78 INS83 INS39 INS42 INS8 INS42 INS42 INS43 INS42 INS43 INS42 INS43 INS42 INS43 INS42 INS43 INS42 INS17 INS43 INS42 INS43 INS42 INS43 INS42 INS43 INS42 INS43 INS42 INS39 INS42 INS17 INS43 INS42 INS21 UPD43 UPD42 INS25 INS65 INS83 INS83 INS83 INS83 INS42 MOV44 MOV44 MOV44 INS8 INS41 INS42 INS41 INS41 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS33 INS42 INS42 INS42 INS38 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS33 INS42 INS42 INS42 INS42 INS42 INS7 UPD42 UPD42 INS32 INS8 INS66 MOV21 MOV21 MOV21 INS60 INS25 INS16 INS16 INS16 INS34 INS22 INS42 INS42 INS42 INS42 INS25 INS21 MOV25 INS74 INS59 INS27 INS8 INS27 INS33 INS32 INS27 INS33 INS32 INS27 INS34 INS32 INS52 INS42 INS27 INS8 INS7 INS43 INS43 INS43 INS42 MOV32 INS42 INS33 MOV21 INS42 INS33 INS42 INS42 INS42 INS33 INS42 INS42 INS42 INS33 INS42 INS42 INS42 INS33 INS53 INS22 INS42 INS42 INS42 INS42 INS14 INS52 INS42 INS42 INS43 INS45 INS42 DEL42 DEL44 DEL39 DEL42 DEL44 DEL42 DEL42