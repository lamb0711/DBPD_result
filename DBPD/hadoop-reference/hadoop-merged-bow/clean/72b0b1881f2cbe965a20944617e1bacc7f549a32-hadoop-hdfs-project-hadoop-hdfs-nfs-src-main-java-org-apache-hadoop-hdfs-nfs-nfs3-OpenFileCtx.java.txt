Merge trunk to HDFS-4685.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-4685@1552467 13f79535-47bb-0310-9956-ffa450edef68

+  private volatile long asyncWriteBackStartOffset;
+    asyncWriteBackStartOffset = 0;
+        asyncWriteBackStartOffset = writeCtx.getOffset();
-        "The openFileCtx has false async status");
+        "openFileCtx has false asyncStatus, fileId:" + latestAttr.getFileid());
+    final long startOffset = asyncWriteBackStartOffset;  
+        // asyncStatus could be changed to false in offerNextToWrite()
-      // make sure we reset asyncStatus to false
-      asyncStatus = false;
+      // Make sure to reset asyncStatus to false unless a race happens
+      synchronized (this) {
+        if (startOffset == asyncWriteBackStartOffset) {
+          asyncStatus = false;
+        } else {
+          LOG.info("Another asyn task is already started before this one"
+              + " is finalized. fileId:" + latestAttr.getFileid()
+              + " asyncStatus:" + asyncStatus + " original startOffset:"
+              + startOffset + " new startOffset:" + asyncWriteBackStartOffset
+              + ". Won't change asyncStatus here.");
+        }
+      }
-}
+}

INS23 INS83 INS83 INS39 INS59 INS42 INS21 INS60 INS7 INS83 INS39 INS59 INS8 INS42 INS34 INS27 INS42 INS42 INS51 INS45 INS32 INS52 INS8 INS21 INS42 INS42 INS25 INS7 INS27 MOV8 INS8 INS42 INS32 INS42 INS42 INS21 INS42 INS42 INS32 INS42 INS42 INS27 INS27 INS32 INS45 INS42 INS45 INS42 INS45 INS42 INS45 INS45 INS45 INS42 INS42 DEL45