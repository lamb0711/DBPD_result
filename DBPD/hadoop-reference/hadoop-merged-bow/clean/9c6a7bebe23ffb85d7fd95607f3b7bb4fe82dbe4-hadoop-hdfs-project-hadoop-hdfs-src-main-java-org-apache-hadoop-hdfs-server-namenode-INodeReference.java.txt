HDFS-4675. Fix rename across snapshottable directories.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1467540 13f79535-47bb-0310-9956-ffa450edef68

-public class INodeReference extends INode {
+public abstract class INodeReference extends INode {
+    WithCount wc = (WithCount) referred;
+    if (ref == wc.getParentReference()) {
+      wc.setParent(null);
+    }
-
+    if (this instanceof DstReference) {
+      out.print(", dstSnapshotId=" + ((DstReference) this).dstSnapshotId);
+    }
+  
+  public int getDstSnapshotId() {
+    return Snapshot.INVALID_ID;
+  }
+  
+  public static class DstReference extends INodeReference {
+    /**
+     * Record the latest snapshot of the dst subtree before the rename. For
+     * later operations on the moved/renamed files/directories, if the latest
+     * snapshot is after this dstSnapshot, changes will be recorded to the
+     * latest snapshot. Otherwise changes will be recorded to the snapshot
+     * belonging to the src of the rename.
+     * 
+     * {@link Snapshot#INVALID_ID} means no dstSnapshot (e.g., src of the
+     * first-time rename).
+     */
+    private final int dstSnapshotId;
+    
+    @Override
+    public final int getDstSnapshotId() {
+      return dstSnapshotId;
+    }
+    
+    public DstReference(INodeDirectory parent, WithCount referred,
+        final int dstSnapshotId) {
+      super(parent, referred);
+      this.dstSnapshotId = dstSnapshotId;
+    }
+  }

INS83 INS83 INS42 INS31 INS55 INS83 INS39 INS42 INS8 MOV83 INS83 INS42 INS43 INS23 INS31 INS31 INS60 INS25 INS25 INS41 INS42 INS29 INS83 INS83 INS39 INS59 INS78 INS83 INS83 INS39 INS42 INS8 INS83 INS42 INS44 INS44 INS44 INS8 INS43 INS59 INS27 INS8 INS62 INS8 INS40 INS65 INS42 INS42 INS41 INS43 INS42 INS43 INS42 INS83 INS39 INS42 INS46 INS21 INS42 INS42 INS11 INS42 INS32 INS21 INS52 INS43 INS21 INS66 INS66 INS66 INS66 INS66 INS65 INS66 INS66 INS42 INS42 INS42 INS42 INS42 INS7 INS43 INS42 INS42 INS42 INS32 INS42 INS32 INS67 INS22 INS42 INS42 INS42 INS42 INS33 INS42 INS42 INS27 INS42 INS42 INS52 INS42 INS45 INS22 INS36 INS42 INS11 INS43 INS52 INS42 DEL42