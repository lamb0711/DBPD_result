HDFS-12713. [READ] Refactor FileRegion and BlockAliasMap to separate out HDFS metadata and PROVIDED storage metadata. Contributed by Ewan Higgs

+import static org.apache.hadoop.hdfs.DFSConfigKeys.DFS_PROVIDED_ALIASMAP_LOAD_RETRIES;
+
+    private int numRetries;
+      this.numRetries = conf.getInt(DFS_PROVIDED_ALIASMAP_LOAD_RETRIES, 0);
-      BlockAliasMap.Reader<FileRegion> reader = aliasMap.getReader(null);
+      BlockAliasMap.Reader<FileRegion> reader = null;
+      int tries = 1;
+      do {
+        try {
+          reader = aliasMap.getReader(null, bpid);
+          break;
+        } catch (IOException e) {
+          tries++;
+          reader = null;
+        }
+      } while (tries <= numRetries);
+
-        LOG.warn("Got null reader from BlockAliasMap " + aliasMap
+        LOG.error("Got null reader from BlockAliasMap " + aliasMap
-        if (region.getBlockPoolId() != null
-            && region.getBlockPoolId().equals(bpid)
-            && containsBlock(providedVolume.baseURI,
-                region.getProvidedStorageLocation().getPath().toUri())) {
+        if (containsBlock(providedVolume.baseURI,
+            region.getProvidedStorageLocation().getPath().toUri())) {
-      BlockAliasMap.Reader<FileRegion> reader = aliasMap.getReader(null);
+      BlockAliasMap.Reader<FileRegion> reader = aliasMap.getReader(null, bpid);
-        if (region.getBlockPoolId().equals(bpid)) {
-          report.add(new ScanInfo(region.getBlock().getBlockId(),
-              providedVolume, region,
-              region.getProvidedStorageLocation().getLength()));
-        }
+        report.add(new ScanInfo(region.getBlock().getBlockId(),
+            providedVolume, region,
+            region.getProvidedStorageLocation().getLength()));
-        if (temp.getBlockPoolId().equals(bpid)) {
-          nextRegion = temp;
-        }
+        nextRegion = temp;
-        reader = blockAliasMap.getReader(null);
+        reader = blockAliasMap.getReader(null, bpid);

INS26 INS40 INS23 INS83 INS39 INS59 MOV8 INS42 INS21 INS60 INS60 INS19 MOV21 INS60 INS70 INS7 MOV74 INS59 INS39 INS59 INS8 INS27 MOV74 INS59 MOV44 INS42 MOV8 INS22 INS32 MOV42 INS33 INS42 INS34 INS54 INS42 INS42 INS42 INS32 MOV21 MOV21 INS52 INS42 INS42 INS42 INS42 INS34 INS8 INS12 MOV32 UPD42 MOV42 UPD42 MOV42 INS33 MOV42 INS21 INS10 INS44 INS8 UPD42 INS7 INS43 INS42 INS21 INS21 INS42 INS42 INS32 INS42 INS37 INS7 MOV42 MOV42 MOV33 INS42 INS42 INS42 INS33 DEL32 DEL59 DEL60 DEL42 DEL42 DEL32 DEL33 DEL27 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL27 DEL27 DEL42 DEL32 DEL32 DEL25 DEL42 DEL42 DEL42 DEL33 DEL32 DEL59 DEL60 DEL42 DEL70 DEL8 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL8 DEL25