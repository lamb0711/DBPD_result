MAPREDUCE-5649. Reduce cannot use more than 2G memory for the final merge. Contributed by Gera Shegalov

-  
-  private final long memoryLimit;
+
+  @VisibleForTesting
+  final long memoryLimit;
+
-    this.memoryLimit = 
-      (long)(jobConf.getLong(MRJobConfig.REDUCE_MEMORY_TOTAL_BYTES,
-          Math.min(Runtime.getRuntime().maxMemory(), Integer.MAX_VALUE))
-        * maxInMemCopyUse);
- 
+    this.memoryLimit = (long)(jobConf.getLong(
+        MRJobConfig.REDUCE_MEMORY_TOTAL_BYTES,
+        Runtime.getRuntime().maxMemory()) * maxInMemCopyUse);
+
-          + "maxSingleShuffleLimit should be less than mergeThreshold"
+          + "maxSingleShuffleLimit should be less than mergeThreshold "
+  @VisibleForTesting
+  final long getMaxInMemReduceLimit() {
+    final float maxRedPer =
+        jobConf.getFloat(MRJobConfig.REDUCE_INPUT_BUFFER_PERCENT, 0f);
+    if (maxRedPer > 1.0 || maxRedPer < 0.0) {
+      throw new RuntimeException(maxRedPer + ": "
+          + MRJobConfig.REDUCE_INPUT_BUFFER_PERCENT
+          + " must be a float between 0 and 1.0");
+    }
+    return (long)(memoryLimit * maxRedPer);
+  }
+
-    LOG.info("finalMerge called with " + 
-             inMemoryMapOutputs.size() + " in-memory map-outputs and " + 
-             onDiskMapOutputs.size() + " on-disk map-outputs");
-    
-    final float maxRedPer =
-      job.getFloat(MRJobConfig.REDUCE_INPUT_BUFFER_PERCENT, 0f);
-    if (maxRedPer > 1.0 || maxRedPer < 0.0) {
-      throw new IOException(MRJobConfig.REDUCE_INPUT_BUFFER_PERCENT +
-                            maxRedPer);
-    }
-    int maxInMemReduce = (int)Math.min(
-        Runtime.getRuntime().maxMemory() * maxRedPer, Integer.MAX_VALUE);
-    
-
+    LOG.info("finalMerge called with " +
+        inMemoryMapOutputs.size() + " in-memory map-outputs and " +
+        onDiskMapOutputs.size() + " on-disk map-outputs");
+    final long maxInMemReduce = getMaxInMemReduceLimit();

INS23 INS31 INS78 UPD83 MOV83 INS39 MOV59 INS78 INS83 INS39 INS42 INS8 INS42 INS42 INS60 INS25 INS41 INS83 INS39 INS59 MOV27 INS8 INS11 UPD39 INS42 INS32 INS53 INS39 INS36 UPD42 INS42 INS42 INS40 INS34 INS14 INS27 UPD42 INS43 INS27 INS42 INS42 MOV32 MOV32 INS42 INS42 INS45 INS40 INS45 UPD42 UPD42 UPD40 UPD45 DEL83 DEL39 DEL23 DEL42 DEL42 DEL40 DEL32 DEL42 DEL40 DEL34 DEL42 DEL43 DEL40 DEL42 DEL27 DEL14 DEL53 DEL8 DEL25 DEL39 DEL42 DEL39 DEL42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL42 DEL27 DEL40 DEL32 DEL11 DEL59 DEL60