HDFS-3884. Journal format() should reset cached values. Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-3077@1380979 13f79535-47bb-0310-9956-ffa450edef68

+    refreshCachedData();
+    
+    this.fjm = storage.getJournalManager();
+  }
+
+  /**
+   * Reload any data that may have been cached. This is necessary
+   * when we first load the Journal, but also after any formatting
+   * operation, since the cached data is no longer relevant.
+   */
+  private synchronized void refreshCachedData() {
+    IOUtils.closeStream(committedTxnId);
+    
-    
-    this.fjm = storage.getJournalManager();
+    refreshCachedData();
+
+  synchronized public long getLastWriterEpoch() throws IOException {
+    checkFormatted();
+    return lastWriterEpoch.get();
+  }

INS31 INS31 INS42 MOV44 MOV44 MOV43 INS8 INS29 INS83 INS83 INS39 UPD42 INS83 INS83 INS39 INS42 INS43 INS8 MOV21 INS21 MOV21 INS65 INS21 INS21 INS42 INS21 INS41 INS32 INS66 INS66 INS66 INS32 INS32 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42