HDFS-4417. Fix case where local reads get disabled incorrectly. Contributed by Colin Patrick McCabe.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-347@1437616 13f79535-47bb-0310-9956-ffa450edef68

+  private static class Key {
+    final DatanodeID dnID;
+    final boolean isDomain;
+    
+    Key(DatanodeID dnID, boolean isDomain) {
+      this.dnID = dnID;
+      this.isDomain = isDomain;
+    }
+    
+    @Override
+    public boolean equals(Object o) {
+      if (!(o instanceof Key)) {
+        return false;
+      }
+      Key other = (Key)o;
+      return dnID.equals(other.dnID) && isDomain == other.isDomain;
+    }
+
+    @Override
+    public int hashCode() {
+      return dnID.hashCode() ^ (isDomain ? 1 : 0);
+    }
+  }
+  
-  private static LinkedListMultimap<DatanodeID, Value> multimap =
+  private static LinkedListMultimap<Key, Value> multimap =
+   * @param isDomain     Whether to retrieve a DomainPeer or not.
+   *
-  public synchronized Peer get(DatanodeID dnId) {
+  public synchronized Peer get(DatanodeID dnId, boolean isDomain) {
-    List<Value> sockStreamList = multimap.get(dnId);
+    List<Value> sockStreamList = multimap.get(new Key(dnId, isDomain));
-    multimap.put(dnId, new Value(peer, Time.monotonicNow()));
+    multimap.put(new Key(dnId, peer.getDomainSocket() != null),
+        new Value(peer, Time.monotonicNow()));
-      Iterator<Entry<DatanodeID, Value>> iter =
+      Iterator<Entry<Key, Value>> iter =
-      Entry<DatanodeID, Value> entry = iter.next();
+      Entry<Key, Value> entry = iter.next();
-    Iterator<Entry<DatanodeID, Value>> iter =
+    Iterator<Entry<Key, Value>> iter =
-    Entry<DatanodeID, Value> entry = iter.next();
+    Entry<Key, Value> entry = iter.next();

INS55 INS83 INS83 INS42 INS23 INS23 INS31 INS31 INS31 UPD74 INS44 MOV60 INS83 MOV43 INS59 INS83 INS39 INS59 INS42 INS44 INS44 INS8 INS78 INS83 INS39 INS42 INS44 INS8 INS78 INS83 INS39 INS42 INS8 INS43 INS65 INS39 INS42 MOV60 INS42 INS42 MOV43 INS42 INS39 INS42 INS21 INS21 INS42 INS43 INS42 INS25 INS60 INS41 INS42 INS41 INS42 INS42 INS66 UPD74 UPD74 MOV74 MOV59 INS7 INS7 INS42 INS38 INS8 INS43 INS59 INS27 INS27 INS14 INS60 INS74 INS43 INS22 INS42 INS22 INS42 INS36 INS41 INS42 INS42 INS11 INS32 INS27 INS32 INS36 INS14 INS43 INS42 INS27 INS74 MOV59 INS74 MOV59 INS43 INS43 INS43 INS42 INS52 INS42 INS52 INS42 INS62 INS9 INS43 INS42 INS42 INS42 INS40 INS42 INS40 INS42 INS42 INS16 INS43 INS42 INS42 INS42 INS32 INS33 MOV43 INS74 MOV43 INS43 MOV43 INS42 INS42 INS42 INS42 INS43 INS42 INS42 INS34 INS34 INS42 INS42 INS42 MOV43 UPD43 MOV43 MOV43 INS42 INS42 MOV42 UPD42 MOV42 DEL42 DEL42 DEL74 DEL42 DEL43 DEL74 DEL74 DEL42 DEL43 DEL74 DEL60