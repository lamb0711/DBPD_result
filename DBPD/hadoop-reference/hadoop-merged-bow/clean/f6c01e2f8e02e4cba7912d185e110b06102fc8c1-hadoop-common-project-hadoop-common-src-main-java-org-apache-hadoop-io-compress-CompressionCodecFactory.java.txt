Merge trunk into auto-HA branch


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-3042@1333291 13f79535-47bb-0310-9956-ffa450edef68

+  
+  private static final ServiceLoader<CompressionCodec> CODEC_PROVIDERS =
+    ServiceLoader.load(CompressionCodec.class);
-   * Get the list of codecs listed in the configuration
+   * Get the list of codecs discovered via a Java ServiceLoader, or
+   * listed in the configuration. Codecs specified in configuration come
+   * later in the returned list, and are considered to override those
+   * from the ServiceLoader.
-   * @return a list of the Configuration classes or null if the attribute
-   *         was not set
+   * @return a list of the {@link CompressionCodec} classes
+    List<Class<? extends CompressionCodec>> result
+      = new ArrayList<Class<? extends CompressionCodec>>();
+    // Add codec classes discovered via service loading
+    for (CompressionCodec codec : CODEC_PROVIDERS) {
+      result.add(codec.getClass());
+    }
+    // Add codec classes from configuration
-      List<Class<? extends CompressionCodec>> result
-        = new ArrayList<Class<? extends CompressionCodec>>();
-      return result;
-    } else {
-      return null;
+    return result;
-   * Sets a list of codec classes in the configuration.
+   * Sets a list of codec classes in the configuration. In addition to any
+   * classes specified using this method, {@link CompressionCodec} classes on
+   * the classpath are discovered using a Java ServiceLoader.
-   * and register them. Defaults to gzip and zip.
+   * and register them. Defaults to gzip and deflate.
-    if (codecClasses == null) {
+    if (codecClasses == null || codecClasses.isEmpty()) {
-      Iterator<Class<? extends CompressionCodec>> itr = codecClasses.iterator();
-      while (itr.hasNext()) {
-        CompressionCodec codec = ReflectionUtils.newInstance(itr.next(), conf);
-        addCodec(codec);     
+      for (Class<? extends CompressionCodec> codecClass : codecClasses) {
+        addCodec(ReflectionUtils.newInstance(codecClass, conf));

INS23 INS83 INS83 INS83 INS74 INS59 MOV8 INS43 INS43 INS42 INS32 INS70 MOV60 INS25 INS42 INS42 INS42 INS42 INS57 INS66 UPD66 INS66 INS66 UPD66 INS65 UPD66 INS44 INS42 INS8 MOV27 INS8 UPD66 INS66 INS65 INS66 INS66 UPD66 INS27 INS8 INS43 INS42 MOV43 INS42 INS21 MOV60 MOV61 INS42 MOV27 INS32 INS70 INS42 INS32 MOV42 UPD42 MOV42 INS44 INS42 INS8 INS42 INS42 INS32 MOV74 INS42 INS21 INS42 INS42 INS32 INS42 INS32 MOV42 MOV42 UPD42 MOV42 MOV42 DEL33 DEL41 DEL8 DEL25 DEL8 DEL42 DEL43 DEL74 DEL42 DEL32 DEL59 DEL60 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL32 DEL59 DEL60 DEL42 DEL42 DEL32 DEL21 DEL8 DEL61 DEL8