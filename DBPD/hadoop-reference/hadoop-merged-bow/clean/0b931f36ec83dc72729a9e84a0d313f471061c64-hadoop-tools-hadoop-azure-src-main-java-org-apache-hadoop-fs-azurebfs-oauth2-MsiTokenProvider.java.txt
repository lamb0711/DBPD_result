Hadoop 16890. Change in expiry calculation for MSI token provider.


Contributed by Bilahari T H
+  private long tokenFetchTime = -1;
+
+  private static final long ONE_HOUR = 3600 * 1000;
+
+    tokenFetchTime = System.currentTimeMillis();
+
+  /**
+   * Checks if the token is about to expire as per base expiry logic.
+   * Otherwise try to expire every 1 hour
+   *
+   * @return true if the token is expiring in next 1 hour or if a token has
+   * never been fetched
+   */
+  @Override
+  protected boolean isTokenAboutToExpire() {
+    if (tokenFetchTime == -1 || super.isTokenAboutToExpire()) {
+      return true;
+    }
+
+    boolean expiring = false;
+    long elapsedTimeSinceLastTokenRefreshInMillis =
+        System.currentTimeMillis() - tokenFetchTime;
+    expiring = elapsedTimeSinceLastTokenRefreshInMillis >= ONE_HOUR
+        || elapsedTimeSinceLastTokenRefreshInMillis < 0;
+    // In case of, Token is not refreshed for 1 hr or any clock skew issues,
+    // refresh token.
+    if (expiring) {
+      LOG.debug("MSIToken: token renewing. Time elapsed since last token fetch:"
+          + " {} milli seconds", elapsedTimeSinceLastTokenRefreshInMillis);
+    }
+
+    return expiring;
+  }
+

INS23 INS23 INS31 INS83 INS39 INS59 INS83 INS83 INS83 INS39 INS59 INS29 INS78 INS83 INS39 INS42 INS8 INS42 INS38 INS42 INS27 INS21 INS65 INS65 INS42 INS25 INS60 INS60 INS21 INS25 INS41 INS34 INS34 INS34 INS7 INS66 INS66 INS66 INS66 INS27 INS8 INS39 INS59 INS39 INS59 INS7 INS42 INS8 INS42 INS42 INS32 INS27 INS48 INS41 INS42 INS9 INS42 INS27 INS42 INS27 INS21 INS42 INS42 INS42 INS38 INS42 INS9 INS32 INS42 INS27 INS27 INS32 INS34 INS42 INS42 INS42 INS42 INS42 INS34 INS42 INS42 INS27 INS42 INS45 INS45