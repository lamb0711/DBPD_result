MAPREDUCE-4801. ShuffleHandler can generate large logs due to prematurely closed channels (jlowe via bobby)


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1410131 13f79535-47bb-0310-9956-ffa450edef68

+import java.nio.channels.ClosedChannelException;
+import java.util.regex.Pattern;
+  // pattern to identify errors related to the client closing the socket early
+  // idea borrowed from Netty SslHandler
+  private static final Pattern IGNORABLE_ERROR_MESSAGE = Pattern.compile(
+      "^.*(?:connection.*reset|connection.*closed|broken.*pipe).*$",
+      Pattern.CASE_INSENSITIVE);
+
-  private HttpPipelineFactory pipelineFact;
+  protected HttpPipelineFactory pipelineFact;
+  protected Shuffle getShuffle(Configuration conf) {
+    return new Shuffle(conf);
+  }
+
-      SHUFFLE = new Shuffle(conf);
+      SHUFFLE = getShuffle(conf);
-    private void verifyRequest(String appid, ChannelHandlerContext ctx,
+    protected void verifyRequest(String appid, ChannelHandlerContext ctx,
-    private void sendError(ChannelHandlerContext ctx,
+    protected void sendError(ChannelHandlerContext ctx,
-    private void sendError(ChannelHandlerContext ctx, String message,
+    protected void sendError(ChannelHandlerContext ctx, String message,
+      } else if (cause instanceof IOException) {
+        if (cause instanceof ClosedChannelException) {
+          LOG.debug("Ignoring closed channel error", cause);
+          return;
+        }
+        String message = String.valueOf(cause.getMessage());
+        if (IGNORABLE_ERROR_MESSAGE.matcher(message).matches()) {
+          LOG.debug("Ignoring client socket close", cause);
+          return;
+        }

INS26 INS26 INS40 INS40 INS23 INS31 INS83 INS83 INS83 INS43 INS59 UPD83 INS83 INS43 INS42 INS44 INS8 INS42 INS42 INS32 INS42 INS43 INS42 INS41 UPD83 UPD83 UPD83 INS42 INS42 INS45 INS40 INS42 MOV14 INS25 MOV62 MOV8 INS25 INS32 INS62 INS8 INS42 INS42 INS42 INS43 MOV25 INS60 INS25 INS42 INS62 INS8 INS43 INS59 INS32 INS8 INS42 INS43 INS21 INS41 INS42 INS42 INS32 INS32 INS42 INS21 INS41 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS42 INS32 INS42 INS42 INS45 INS42 INS42 INS42 INS42 INS42 INS45 INS42