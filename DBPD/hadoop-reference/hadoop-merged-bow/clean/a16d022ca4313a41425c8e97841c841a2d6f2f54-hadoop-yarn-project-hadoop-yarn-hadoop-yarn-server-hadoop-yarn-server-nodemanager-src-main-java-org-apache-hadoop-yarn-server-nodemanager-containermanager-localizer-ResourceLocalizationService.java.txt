YARN-2704. Changed ResourceManager to optionally obtain tokens itself for the sake of localization and log-aggregation for long-running services. Contributed by Jian He.

-import org.apache.hadoop.yarn.ipc.RPCUtil;
+import org.apache.hadoop.yarn.server.nodemanager.Context;
+  private Context nmContext;
-      LocalDirsHandlerService dirsHandler, NMStateStoreService stateStore) {
+      LocalDirsHandlerService dirsHandler, Context context) {
-    this.stateStore = stateStore;
+    this.stateStore = context.getNMStateStore();
+    this.nmContext = context;
+    private Credentials getSystemCredentialsSentFromRM(
+        LocalizerContext localizerContext) throws IOException {
+      ApplicationId appId =
+          localizerContext.getContainerId().getApplicationAttemptId()
+            .getApplicationId();
+      Credentials systemCredentials =
+          nmContext.getSystemCredentialsForApps().get(appId);
+      if (systemCredentials == null) {
+        return null;
+      }
+      LOG.info("Adding new framework tokens from RM for " + appId);
+      for (Token<?> token : systemCredentials.getAllTokens()) {
+        LOG.info("Adding new application-token for localization: " + token);
+      }
+      return systemCredentials;
+    }
+    
+        if (UserGroupInformation.isSecurityEnabled()) {
+          Credentials systemCredentials =
+              getSystemCredentialsSentFromRM(context);
+          if (systemCredentials != null) {
+            credentials = systemCredentials;
+          }
+        }
+

MOV26 UPD40 INS23 INS83 INS43 INS59 INS31 INS42 INS42 UPD43 UPD42 INS21 INS83 INS43 INS42 INS44 INS43 INS8 UPD42 INS7 INS42 INS43 INS42 INS42 INS60 INS60 INS25 INS21 INS70 INS41 INS32 INS22 INS42 INS42 INS43 INS59 INS43 INS59 INS27 INS8 INS32 INS44 INS32 INS8 INS42 INS42 INS42 INS52 INS42 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS33 INS41 INS42 INS42 INS27 INS74 INS42 INS42 INS42 INS21 INS25 INS32 INS42 INS32 INS42 INS42 INS33 INS45 INS42 INS43 INS76 INS32 INS32 INS8 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS27 INS42 INS42 INS60 INS25 INS42 INS42 INS45 INS42 INS43 INS59 INS27 INS8 INS42 INS42 INS32 INS42 INS33 INS21 INS42 INS42 INS7 INS42 INS42 DEL42