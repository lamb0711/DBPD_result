HDFS-14810. Review FSNameSystem editlog sync. Contributed by Xiaoqiao He.

-    } finally {
-      getEditLog().logSync();
+    getEditLog().logSync();
-      logAuditEvent(success, operationName, src, dst, ret.auditStat);
+      logAuditEvent(true, operationName, src, dst, ret.auditStat);
+    boolean success = false;
-        return FSDirStatAndListingOp.isFileClosed(dir, pc, src);
+        success = FSDirStatAndListingOp.isFileClosed(dir, pc, src);
+    if (success) {
+      logAuditEvent(true, operationName, src);
+    }
+    return success;
-    } finally {
-      getEditLog().logSync();
+    getEditLog().logSync();
-    final boolean success;
-      success = true;
-    logAuditEvent(success, operationName, tokenId);
+    logAuditEvent(true, operationName, tokenId);
-    boolean success = false;
-      success = true;
-    logAuditEvent(success, operationName, path, null, null);
+    logAuditEvent(true, operationName, path, null, null);
-      logAuditEvent(false, operationName, snapshotRoot,
-          snapshotPath, null);
+      logAuditEvent(false, operationName, snapshotRoot);
-      logAuditEvent(false, operationName, null,
-          null, null);
+      logAuditEvent(false, operationName, null);
-    } finally {
-      getEditLog().logSync();
+    getEditLog().logSync();
-    logAuditEvent(true, operationName, effectiveDirectiveStr,
-        null, null);
+    logAuditEvent(true, operationName, effectiveDirectiveStr);
-    } finally {
-      getEditLog().logSync();
+    getEditLog().logSync();
-    logAuditEvent(true, operationName, idStr, null, null);
+    logAuditEvent(true, operationName, idStr, null, null);
-      logAuditEvent(false, operationName, filter.toString(), null,
-          null);
+      logAuditEvent(false, operationName, filter.toString());
-    logAuditEvent(true, operationName, filter.toString(), null,
-        null);
+    logAuditEvent(true, operationName, filter.toString());
-      logAuditEvent(false, operationName, poolInfoStr, null, null);
+      logAuditEvent(false, operationName, poolInfoStr);
-    logAuditEvent(true, operationName, poolInfoStr, null, null);
+    logAuditEvent(true, operationName, poolInfoStr);
+    getEditLog().logSync();
-
-    getEditLog().logSync();
-      logAuditEvent(false, operationName, poolNameStr, null, null);
+      logAuditEvent(false, operationName, poolNameStr);
-    logAuditEvent(true, operationName, poolNameStr, null, null);
+    logAuditEvent(true, operationName, poolNameStr);
-      logAuditEvent(false, operationName, null, null, null);
+      logAuditEvent(false, operationName, null);
-    logAuditEvent(true, operationName, null, null, null);
+    logAuditEvent(true, operationName, null);
+    final FileStatus resultingStat;
-      final FileStatus resultingStat;
-
-      getEditLog().logSync();
-      logAuditEvent(true, operationName, src, null, resultingStat);
+    getEditLog().logSync();
+    logAuditEvent(true, operationName, src, null, resultingStat);
-    boolean success = false;
-      success = true;
+    } catch (AccessControlException ace) {
+      logAuditEvent(false, operationName, srcArg);
+      throw ace;
-      if (success) {
-        getEditLog().logSync();
-      }
-      logAuditEvent(success, operationName, srcArg, null, resultingStat);
+    getEditLog().logSync();
+    logAuditEvent(true, operationName, srcArg, null, resultingStat);
-    boolean success = false;
-      success = true;
-      return responses.toArray(new AddErasureCodingPolicyResponse[0]);
-      if (success) {
-        getEditLog().logSync();
-      }
-      logAuditEvent(success, operationName, addECPolicyNames.toString(),
-          null, null);
+    getEditLog().logSync();
+    logAuditEvent(true, operationName, addECPolicyNames.toString());
+    return responses.toArray(new AddErasureCodingPolicyResponse[0]);
-    boolean success = false;
-      success = true;
-      if (success) {
-        getEditLog().logSync();
-      }
-      logAuditEvent(success, operationName, ecPolicyName, null, null);
+    getEditLog().logSync();
+    logAuditEvent(true, operationName, ecPolicyName, null, null);
-      logAuditEvent(false, operationName, ecPolicyName, null, null);
-    } finally {
-      if (success) {
-        getEditLog().logSync();
-        logAuditEvent(success, operationName, ecPolicyName, null, null);
-      }
+      logAuditEvent(false, operationName, ecPolicyName);
+      throw ace;
+    }
+    if (success) {
+      getEditLog().logSync();
+      logAuditEvent(true, operationName, ecPolicyName);
-      logAuditEvent(false, operationName, ecPolicyName, null, null);
-    } finally {
-      if (success) {
-        getEditLog().logSync();
-        logAuditEvent(success, operationName, ecPolicyName, null, null);
-      }
+      logAuditEvent(false, operationName, ecPolicyName);
+      throw ace;
+    }
+    if (success) {
+      getEditLog().logSync();
+      logAuditEvent(true, operationName, ecPolicyName);
-    boolean success = false;
-      success = true;
-      if (success) {
-        getEditLog().logSync();
-      }
-      logAuditEvent(success, operationName, srcArg, null, resultingStat);
+    getEditLog().logSync();
+    logAuditEvent(true, operationName, srcArg, null, resultingStat);
+    logAuditEvent(true, operationName, src);

MOV21 MOV21 MOV21 MOV21 MOV8 MOV21 MOV60 INS25 INS41 MOV21 MOV21 MOV21 MOV60 INS54 MOV21 INS21 MOV21 INS21 MOV41 MOV21 INS21 INS25 INS25 MOV21 INS21 INS21 INS42 INS8 INS42 INS8 MOV12 INS12 INS8 INS32 INS32 INS32 INS42 INS8 INS42 INS8 INS32 INS32 INS21 INS9 INS9 MOV32 MOV60 MOV60 MOV21 MOV21 MOV54 INS44 INS8 MOV21 INS42 INS9 INS42 INS42 INS33 INS42 INS42 INS9 INS42 MOV32 INS42 INS9 INS42 INS42 INS33 INS33 MOV21 INS21 MOV21 INS21 INS42 INS9 INS42 INS42 INS33 INS42 INS42 INS9 INS42 INS42 INS32 INS43 INS42 MOV21 INS53 INS53 INS32 INS53 INS32 INS9 INS21 INS42 INS9 INS42 INS42 INS42 INS42 UPD42 INS42 INS42 INS9 INS42 INS42 INS42 INS42 INS9 INS42 INS42 INS7 MOV32 UPD42 INS9 INS42 INS42 MOV32 DEL8 DEL42 DEL41 DEL8 DEL83 DEL39 DEL42 DEL59 DEL60 DEL42 DEL9 DEL7 DEL21 DEL42 DEL39 DEL42 DEL9 DEL59 DEL60 DEL42 DEL9 DEL7 DEL21 DEL42 DEL42 DEL33 DEL33 DEL33 DEL8 DEL33 DEL33 DEL8 DEL33 DEL33 DEL33 DEL33 DEL33 DEL33 DEL33 DEL33 DEL33 DEL33 DEL33 DEL33 DEL33 DEL33 DEL33 DEL33 DEL54 DEL8 DEL39 DEL42 DEL9 DEL59 DEL60 DEL42 DEL9 DEL7 DEL21 DEL42 DEL42 DEL33 DEL42 DEL42 DEL8 DEL25 DEL8 DEL39 DEL42 DEL9 DEL59 DEL60 DEL42 DEL9 DEL7 DEL21 DEL42 DEL8 DEL25 DEL42 DEL42 DEL42 DEL33 DEL33 DEL32 DEL21 DEL42 DEL9 DEL7 DEL21 DEL42 DEL8 DEL25 DEL42 DEL42 DEL42 DEL42 DEL33 DEL33 DEL32 DEL21 DEL33 DEL33 DEL42 DEL42 DEL42 DEL42 DEL42 DEL33 DEL33 DEL32 DEL21 DEL8 DEL25 DEL8 DEL33 DEL33 DEL42 DEL42 DEL42 DEL42 DEL42 DEL33 DEL33 DEL32 DEL21 DEL8 DEL25 DEL8 DEL39 DEL42 DEL9 DEL59 DEL60 DEL42 DEL9 DEL7 DEL21 DEL42 DEL8 DEL25 DEL42 DEL42 DEL42 DEL42 DEL33 DEL42 DEL32 DEL21