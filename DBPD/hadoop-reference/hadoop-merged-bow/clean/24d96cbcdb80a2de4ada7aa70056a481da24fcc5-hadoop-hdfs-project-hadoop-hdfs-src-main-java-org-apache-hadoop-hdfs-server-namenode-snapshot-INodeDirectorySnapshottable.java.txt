HDFS-4414. Add support for getting snapshot diff from DistributedFileSystem. Contributed by Jing Zhao.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1441808 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.hdfs.protocol.SnapshotDiffReport;
+import org.apache.hadoop.hdfs.protocol.SnapshotDiffReport.DiffReportEntry;
+import org.apache.hadoop.hdfs.protocol.SnapshotDiffReport.DiffType;
-  public static class SnapshotDiffReport {
+  public static class SnapshotDiffInfo {
-    public SnapshotDiffReport(INodeDirectorySnapshottable snapshotRoot,
+    public SnapshotDiffInfo(INodeDirectorySnapshottable snapshotRoot,
-    /**
-     * dump the diff
+    /** 
+     * Get the name of the given snapshot. 
+     * @param s The given snapshot.
+     * @return The name of the snapshot, or an empty string if {@code s} is null
-    public String dump() {
-      StringBuilder strBuffer = new StringBuilder();
-      String fromStr = from == null ? "current directory" : "snapshot "
-          + from.getRoot().getLocalName();
-      String toStr = to == null ? "current directory" : "snapshot "
-          + to.getRoot().getLocalName();
-      strBuffer.append("Diffence between snapshot " + fromStr + " and " + toStr
-          + " under directory " + snapshotRoot.getFullPathName() + ":\n");
-      
-      if (!diffMap.isEmpty()) {
-        for (Map.Entry<INodeDirectoryWithSnapshot, ChildrenDiff> entry : diffMap
-            .entrySet()) {
-          strBuffer.append("M\t" + entry.getKey().getFullPathName() + "\n");
-          entry.getValue().printDiff(strBuffer, entry.getKey(),
-              from == null || 
-              (to != null && Snapshot.ID_COMPARATOR.compare(from, to) > 0));
-        }
+    private static String getSnapshotName(Snapshot s) {
+      return s != null ? s.getRoot().getLocalName() : "";
+    }
+    
+    /** @return True if {@link #from} is earlier than {@link #to} */
+    private boolean isFromEarlier() {
+      return to == null
+          || (from != null && Snapshot.ID_COMPARATOR.compare(from, to) < 0);
+    }
+    
+    /**
+     * Generate a {@link SnapshotDiffReport} based on detailed diff information.
+     * @return A {@link SnapshotDiffReport} describing the difference
+     */
+    public SnapshotDiffReport generateReport() {
+      List<DiffReportEntry> diffList = new ArrayList<DiffReportEntry>();
+      for (Map.Entry<INodeDirectoryWithSnapshot, ChildrenDiff> entry : diffMap
+          .entrySet()) {
+        diffList.add(new DiffReportEntry(DiffType.MODIFY, entry.getKey()
+            .getFullPathName()));
+        List<DiffReportEntry> subList = entry.getValue().generateReport(
+            entry.getKey(), isFromEarlier());
+        diffList.addAll(subList);
-      return strBuffer.toString();
+      return new SnapshotDiffReport(snapshotRoot.getFullPathName(),
+          getSnapshotName(from), getSnapshotName(to), diffList);
-  SnapshotDiffReport computeDiff(final String from, final String to)
+  SnapshotDiffInfo computeDiff(final String from, final String to)
-    SnapshotDiffReport diffs = new SnapshotDiffReport(this, fromSnapshot,
+    SnapshotDiffInfo diffs = new SnapshotDiffInfo(this, fromSnapshot,
-      SnapshotDiffReport diffReport) {
+      SnapshotDiffInfo diffReport) {

INS26 INS26 INS26 INS40 INS40 INS40 UPD42 INS31 INS31 INS31 UPD43 UPD42 MOV29 INS83 UPD83 MOV83 MOV43 UPD42 MOV42 INS44 INS8 INS29 INS83 INS39 INS42 MOV8 INS29 INS83 INS43 INS42 INS8 UPD42 UPD43 INS65 INS65 INS43 INS42 INS41 INS65 INS41 INS65 INS65 INS42 INS60 MOV70 MOV41 UPD43 UPD42 UPD66 INS42 INS66 INS66 INS65 INS66 UPD42 MOV42 INS16 INS66 INS65 INS66 INS65 INS66 MOV27 INS66 INS65 INS66 INS66 INS65 INS66 INS74 INS59 INS8 INS14 UPD42 INS66 UPD27 MOV27 INS32 INS45 INS67 INS67 MOV27 INS42 INS42 INS43 INS43 INS42 INS14 MOV21 INS60 INS21 INS43 MOV32 INS32 INS32 INS42 UPD43 UPD42 MOV32 MOV42 INS42 INS42 INS42 INS42 INS74 INS74 INS59 INS32 INS42 INS42 INS42 UPD42 MOV42 UPD42 MOV42 UPD42 UPD42 UPD27 INS43 INS43 UPD42 UPD42 INS14 INS43 INS43 INS42 INS32 INS42 INS42 INS42 UPD42 INS42 INS42 INS43 INS40 MOV32 INS42 INS42 MOV32 INS42 MOV32 INS32 INS42 INS42 DEL42 DEL33 DEL27 DEL42 DEL42 DEL32 DEL21 DEL45 DEL45 DEL27 DEL32 DEL43 DEL42 DEL42 DEL43 DEL14 DEL59 DEL60 DEL42 DEL43 DEL42 DEL45 DEL45 DEL32 DEL27 DEL16 DEL59 DEL60 DEL42 DEL43 DEL42 DEL45 DEL45 DEL42 DEL42 DEL32 DEL42 DEL32 DEL27 DEL16 DEL59 DEL60 DEL42 DEL42 DEL45 DEL42 DEL45 DEL42 DEL45 DEL45 DEL27 DEL32 DEL21 DEL42 DEL42 DEL32 DEL38 DEL8 DEL25 DEL8 DEL31