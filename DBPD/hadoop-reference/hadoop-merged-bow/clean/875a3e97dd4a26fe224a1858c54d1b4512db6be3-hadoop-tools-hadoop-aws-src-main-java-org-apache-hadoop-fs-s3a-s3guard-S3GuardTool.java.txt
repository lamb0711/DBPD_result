HADOOP-16424. S3Guard fsck: Check internal consistency of the MetadataStore (#1691). Contributed by Gabor Bota.


+    public static final String DDB_MS_CONSISTENCY_FLAG = "internal";
-        + "not fix any issues.\n";
+        + "not fix any issues.\n"+
+        "  -" + DDB_MS_CONSISTENCY_FLAG + " Check the dynamodb metadata store "
+        + "for internal consistency.\n";
-      super(conf, CHECK_FLAG);
+      super(conf, CHECK_FLAG, DDB_MS_CONSISTENCY_FLAG);
+      final CommandFormat commandFormat = getCommandFormat();
+
+      // check if there's more than one arguments
+      int flags = 0;
+      if (commandFormat.getOpt(CHECK_FLAG)) {
+        flags++;
+      }
+      if (commandFormat.getOpt(DDB_MS_CONSISTENCY_FLAG)) {
+        flags++;
+      }
+      if (flags > 1) {
+        out.println(USAGE);
+        throw invalidArgs("There should be only one parameter used for checking.");
+      }
+
-        errorln(s3Path + " path uses MS: " + ms);
+        errorln(s3Path + " path uses metadata store: " + ms);
-      final CommandFormat commandFormat = getCommandFormat();
+      List<S3GuardFsck.ComparePair> violations;
+
-          final List<S3GuardFsck.ComparePair> comparePairs
-              = s3GuardFsck.compareS3ToMs(fs.qualify(root));
-          if (comparePairs.size() > 0) {
-            exitValue = EXIT_FAIL;
-          }
+          violations = s3GuardFsck.compareS3ToMs(fs.qualify(root));
+      } else if (commandFormat.getOpt(DDB_MS_CONSISTENCY_FLAG)) {
+        S3GuardFsck s3GuardFsck = new S3GuardFsck(fs, ms);
+        violations = s3GuardFsck.checkDdbInternalConsistency(fs.qualify(root));
+
+      // We fail if there were compare pairs, as the returned compare pairs
+      // contain issues.
+      if (violations == null || violations.size() > 0) {
+        exitValue = EXIT_FAIL;
+      }

INS23 INS83 INS83 INS83 INS43 INS59 MOV60 INS42 INS42 INS45 INS60 INS25 INS25 INS25 INS60 INS25 INS45 INS42 INS45 INS45 INS42 INS39 INS59 INS32 INS8 INS32 INS8 INS27 INS8 MOV74 INS59 INS25 INS27 MOV8 INS42 INS34 INS42 INS42 INS42 INS21 INS42 INS42 INS42 INS21 INS42 INS34 INS21 INS53 INS42 INS32 INS8 MOV8 INS27 INS27 INS37 INS37 INS32 INS32 INS42 INS42 INS42 INS60 INS21 INS42 INS33 INS32 INS34 INS42 INS42 INS42 INS42 INS42 INS42 INS45 INS21 INS43 INS59 INS7 INS42 INS42 UPD45 INS7 INS42 INS42 INS14 INS42 INS32 INS42 MOV32 INS43 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 DEL83 DEL42 DEL59 DEL60 DEL42 DEL42 DEL32 DEL34 DEL27 DEL25