HADOOP-15808. Harden Token service loader use.

Contributed by Steve Loughran.

+import java.util.Iterator;
+import java.util.ServiceConfigurationError;
-        for (TokenIdentifier id : ServiceLoader.load(TokenIdentifier.class)) {
-          tokenKindMap.put(id.getKind(), id.getClass());
+        // start the service load process; it's only in the "next()" calls
+        // where implementations are loaded.
+        final Iterator<TokenIdentifier> tokenIdentifiers =
+            ServiceLoader.load(TokenIdentifier.class).iterator();
+        while (tokenIdentifiers.hasNext()) {
+          try {
+            TokenIdentifier id = tokenIdentifiers.next();
+            tokenKindMap.put(id.getKind(), id.getClass());
+          } catch (ServiceConfigurationError e) {
+            // failure to load a token implementation
+            // log at debug and continue.
+            LOG.debug("Failed to load token identifier implementation", e);
+          }
-      LOG.debug("Cannot find class for token kind " + kind);
+      LOG.debug("Cannot find class for token kind {}", kind);
-   * @return the token identifier, or null
-   * @throws IOException
+   * @return the token identifier, or null if there was no class found for it
+   * @throws IOException failure to unmarshall the data
+   * @throws RuntimeException if the token class could not be instantiated.
-        LOG.debug("Cloned private token " + this + " from " + publicToken);
+        LOG.debug("Cloned private token {} from {}", this, publicToken);
-      for (TokenRenewer canidate : renewers) {
-        if (canidate.handleKind(this.kind)) {
-          renewer = canidate;
-          return renewer;
+      Iterator<TokenRenewer> it = renewers.iterator();
+      while (it.hasNext()) {
+        try {
+          TokenRenewer candidate = it.next();
+          if (candidate.handleKind(this.kind)) {
+            renewer = candidate;
+            return renewer;
+          }
+        } catch (ServiceConfigurationError e) {
+          // failure to load a token implementation
+          // log at debug and continue.
+          LOG.debug("Failed to load token renewer implementation", e);
-    LOG.warn("No TokenRenewer defined for token kind " + this.kind);
+    LOG.warn("No TokenRenewer defined for token kind {}", kind);

INS26 INS26 INS40 INS40 INS65 UPD66 INS66 INS42 INS66 INS8 INS60 INS61 INS45 INS42 INS74 INS59 INS32 MOV8 INS60 INS61 INS45 INS42 INS43 INS43 INS42 INS32 INS42 INS42 INS54 INS83 INS74 INS59 INS32 INS8 INS45 INS52 INS42 INS42 INS42 INS42 INS42 MOV8 INS12 INS43 INS43 INS42 INS32 INS42 INS42 INS54 INS60 INS44 INS8 INS42 INS42 MOV32 INS42 MOV8 INS12 MOV43 INS59 INS43 UPD42 MOV42 INS21 INS60 INS44 INS8 INS42 INS32 UPD42 INS42 INS32 MOV43 INS59 INS43 INS42 INS21 INS42 INS42 INS42 INS42 INS45 INS42 INS42 INS32 INS42 INS32 UPD42 INS42 INS42 INS42 INS42 INS45 INS42 DEL42 DEL44 DEL70 DEL45 DEL42 DEL27 DEL45 DEL52 DEL45 DEL42 DEL27 DEL44 DEL42 DEL70 DEL45 DEL52 DEL42 DEL22 DEL27