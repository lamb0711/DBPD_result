Fix issue with NN/DN re-registration.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1358347 13f79535-47bb-0310-9956-ffa450edef68

+    // Add the initial block token secret keys to the DN's secret manager.
+    if (dn.isBlockTokenEnabled) {
+      dn.blockPoolTokenSecretManager.addKeys(getBlockPoolId(),
+          reg.getExportedKeys());
+    }
-        dn.blockPoolTokenSecretManager.setKeys(
+        dn.blockPoolTokenSecretManager.addKeys(
-      LOG.info("DatanodeCommand action: DNA_REGISTER");
+      LOG.info("DatanodeCommand action from standby: DNA_REGISTER");
-      return true;
+      break;
+    case DatanodeProtocol.DNA_ACCESSKEYUPDATE:
+      LOG.info("DatanodeCommand action from standby: DNA_ACCESSKEYUPDATE");
+      if (dn.isBlockTokenEnabled) {
+        dn.blockPoolTokenSecretManager.addKeys(
+            getBlockPoolId(), 
+            ((KeyUpdateCommand) cmd).getExportedKeys());
+      }
+      break;
-    case DatanodeProtocol.DNA_ACCESSKEYUPDATE:
-      return true;   
+      break;

INS25 MOV49 INS40 INS8 INS10 INS21 INS25 INS10 INS10 INS21 INS32 INS40 INS8 INS32 UPD45 INS42 INS42 INS45 INS21 INS40 INS42 INS32 INS32 INS32 INS42 INS42 INS42 UPD42 INS40 INS42 INS32 INS32 INS42 INS36 INS42 INS11 INS43 INS42 INS42 DEL9 DEL41 DEL9 DEL41