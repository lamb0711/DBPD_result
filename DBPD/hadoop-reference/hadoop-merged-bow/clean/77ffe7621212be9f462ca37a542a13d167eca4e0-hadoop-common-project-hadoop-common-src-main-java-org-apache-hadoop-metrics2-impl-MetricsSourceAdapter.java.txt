HADOOP-11361. Fix a race condition in MetricsSourceAdapter.updateJmxCache. Contributed by Vinayakumar B, Yongjun Zhang, and Brahma Reddy Battula. (ozawa)

+import com.google.common.base.Preconditions;
-  private Iterable<MetricsRecordImpl> lastRecs;
+    // HADOOP-11361: Release lock here for avoid deadlock between
+    // MetricsSystemImpl's lock and MetricsSourceAdapter's lock.
+    Iterable<MetricsRecordImpl> lastRecs = null;
-      MetricsCollectorImpl builder = new MetricsCollectorImpl();
-      getMetrics(builder, true);
+      lastRecs = getMetrics(new MetricsCollectorImpl(), true);
-    synchronized(this) {
-      updateAttrCache();
-      if (getAllMetrics) {
-        updateInfoCache();
+    synchronized (this) {
+      if (lastRecs != null) {
+        updateAttrCache(lastRecs);
+        updateInfoCache(lastRecs);
-      lastRecs = null;  // in case regular interval update is not running
-    synchronized(this) {
-      if (lastRecs == null && jmxCacheTS == 0) {
-        all = true; // Get all the metrics to populate the sink caches
-      }
-    }
-    synchronized(this) {
-      lastRecs = builder.getRecords();
-      return lastRecs;
-    }
+    return builder.getRecords();
-  private void updateInfoCache() {
+  private void updateInfoCache(Iterable<MetricsRecordImpl> lastRecs) {
+    Preconditions.checkNotNull(lastRecs, "LastRecs should not be null");
-  private int updateAttrCache() {
+  private int updateAttrCache(Iterable<MetricsRecordImpl> lastRecs) {
+    Preconditions.checkNotNull(lastRecs, "LastRecs should not be null");

INS26 INS40 INS44 INS44 INS60 MOV41 INS74 INS42 INS21 INS74 INS42 INS21 MOV74 INS59 INS8 MOV32 INS43 INS43 INS32 INS43 INS43 INS32 INS42 INS33 INS21 INS25 MOV21 MOV21 INS42 INS42 INS42 INS42 INS42 INS45 INS42 INS42 INS42 INS42 INS42 INS45 INS7 INS27 INS8 INS42 INS32 INS42 INS33 MOV21 MOV21 MOV42 MOV14 MOV9 INS42 INS42 DEL83 DEL42 DEL59 DEL23 DEL42 DEL43 DEL42 DEL59 DEL60 DEL42 DEL32 DEL21 DEL42 DEL8 DEL25 DEL42 DEL33 DEL7 DEL21 DEL8 DEL52 DEL42 DEL33 DEL27 DEL42 DEL34 DEL27 DEL27 DEL42 DEL9 DEL7 DEL21 DEL8 DEL25 DEL8 DEL51 DEL42 DEL52 DEL42 DEL7 DEL21 DEL8 DEL51