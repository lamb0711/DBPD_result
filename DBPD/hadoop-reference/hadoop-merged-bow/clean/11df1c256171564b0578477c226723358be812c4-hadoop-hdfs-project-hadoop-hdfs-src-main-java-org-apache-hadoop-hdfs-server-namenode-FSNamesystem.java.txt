HDFS-2874. Edit log should log to shared dirs before local dirs. Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1240445 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.LinkedHashSet;
-import com.google.common.base.Joiner;
-
-import com.google.common.annotations.VisibleForTesting;
+import com.google.common.collect.Lists;
-    Collection<URI> namespaceEditsDirs = 
+    List<URI> namespaceEditsDirs = 
-  public static Collection<URI> getNamespaceEditsDirs(Configuration conf) {
-    Collection<URI> editsDirs = getStorageDirs(conf, DFS_NAMENODE_EDITS_DIR_KEY);
-    editsDirs.addAll(getSharedEditsDirs(conf));
-    Set<URI> uniqueEditsDirs = new HashSet<URI>();
-    uniqueEditsDirs.addAll(editsDirs);
-    if (uniqueEditsDirs.size() != editsDirs.size()) {
-      // clearing and re-initializing editsDirs to preserve Collection semantics
-      // assigning finalEditsDirs to editsDirs would leak Set semantics in the 
-      // return value and cause unexpected results downstream. eg future addAll
-      // calls. Perf is not an issue since these are small lists.
-      editsDirs.clear();
-      editsDirs.addAll(uniqueEditsDirs);
-      LOG.warn("Overlapping entries in " + DFS_NAMENODE_EDITS_DIR_KEY 
-          + " and/or " + DFS_NAMENODE_SHARED_EDITS_DIR_KEY
-          + ". Using the following entries: " + Joiner.on(',').join(editsDirs));
+  /**
+   * Return an ordered list of edits directories to write to.
+   * The list is ordered such that all shared edits directories
+   * are ordered before non-shared directories, and any duplicates
+   * are removed. The order they are specified in the configuration
+   * is retained.
+   */
+  public static List<URI> getNamespaceEditsDirs(Configuration conf) {
+    // Use a LinkedHashSet so that order is maintained while we de-dup
+    // the entries.
+    LinkedHashSet<URI> editsDirs = new LinkedHashSet<URI>();
+    
+    // First add the shared edits dirs. It's critical that the shared dirs
+    // are added first, since JournalSet syncs them in the order they are listed,
+    // and we need to make sure all edits are in place in the shared storage
+    // before they are replicated locally. See HDFS-2874.
+    for (URI dir : getSharedEditsDirs(conf)) {
+      if (!editsDirs.add(dir)) {
+        LOG.warn("Edits URI " + dir + " listed multiple times in " + 
+            DFS_NAMENODE_SHARED_EDITS_DIR_KEY + ". Ignoring duplicates.");
+      }
+    
+    // Now add the non-shared dirs.
+    for (URI dir : getStorageDirs(conf, DFS_NAMENODE_EDITS_DIR_KEY)) {
+      if (!editsDirs.add(dir)) {
+        LOG.warn("Edits URI " + dir + " listed multiple times in " + 
+            DFS_NAMENODE_SHARED_EDITS_DIR_KEY + " and " +
+            DFS_NAMENODE_EDITS_DIR_KEY + ". Ignoring duplicates.");
+      }
+    }
+
-      return getNamespaceDirs(conf);
+      return Lists.newArrayList(getNamespaceDirs(conf));
-      return editsDirs;
+      return Lists.newArrayList(editsDirs);
-  public static Collection<URI> getSharedEditsDirs(Configuration conf) {
+  public static List<URI> getSharedEditsDirs(Configuration conf) {

MOV26 UPD40 UPD40 INS29 UPD74 MOV74 UPD74 INS65 UPD43 INS70 INS70 UPD43 UPD74 INS66 INS66 INS66 INS66 INS66 UPD42 UPD74 MOV74 INS44 MOV32 INS8 INS44 MOV32 INS8 UPD42 UPD43 UPD43 INS14 MOV43 INS42 INS25 INS43 INS42 INS25 UPD42 UPD42 UPD74 MOV74 INS38 INS8 INS42 INS38 INS8 INS32 INS32 UPD43 INS32 MOV21 INS32 MOV21 INS42 INS42 MOV32 INS42 INS42 INS42 UPD42 MOV42 UPD42 MOV42 INS42 MOV42 UPD42 MOV42 UPD42 MOV42 UPD42 UPD42 INS27 INS45 INS42 INS45 INS42 INS45 INS45 INS42 UPD45 UPD42 UPD45 UPD42 UPD45 DEL42 DEL42 DEL42 DEL13 DEL32 DEL42 DEL42 DEL32 DEL32 DEL21 DEL42 DEL42 DEL43 DEL74 DEL14 DEL59 DEL60 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL27 DEL42 DEL42 DEL32 DEL21 DEL32 DEL21 DEL8 DEL25 DEL42