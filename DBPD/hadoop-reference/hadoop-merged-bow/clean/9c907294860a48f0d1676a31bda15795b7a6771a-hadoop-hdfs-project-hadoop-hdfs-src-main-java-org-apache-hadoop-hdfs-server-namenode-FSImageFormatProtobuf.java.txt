HDFS-13694. Making md5 computing being in parallel with image loading.


+    /**
+     * Thread to compute the MD5 of a file as this can be in parallel while
+     * loading the image without interfering much.
+     */
+    private static class DigestThread extends Thread {
+
+      /**
+       * Exception thrown when computing the digest if it cannot be calculated.
+       */
+      private volatile IOException ioe = null;
+
+      /**
+       * Calculated digest if there are no error.
+       */
+      private volatile MD5Hash digest = null;
+
+      /**
+       * FsImage file computed MD5.
+       */
+      private final File file;
+
+      DigestThread(File inFile) {
+        file = inFile;
+        setName(inFile.getName() + " MD5 compute");
+        setDaemon(true);
+      }
+
+      public MD5Hash getDigest() throws IOException {
+        if (ioe != null) {
+          throw ioe;
+        }
+        return digest;
+      }
+
+      public IOException getException() {
+        return ioe;
+      }
+
+      @Override
+      public void run() {
+        try {
+          digest = MD5FileUtils.computeMd5ForFile(file);
+        } catch (IOException e) {
+          ioe = e;
+        } catch (Throwable t) {
+          ioe = new IOException(t);
+        }
+      }
+
+      @Override
+      public String toString() {
+        return "DigestThread{ ThreadName=" + getName() + ", digest=" + digest
+            + ", file=" + file + '}';
+      }
+    }
+
-      imgDigest = MD5FileUtils.computeMd5ForFile(file);
+      DigestThread dt = new DigestThread(file);
+      dt.start();
+        try {
+          dt.join();
+          imgDigest = dt.getDigest();
+        } catch (InterruptedException ie) {
+          throw new IOException(ie);
+        }

INS55 INS29 INS83 INS83 INS42 INS43 INS23 INS23 INS23 INS31 INS31 INS31 INS31 INS31 INS65 INS42 INS29 INS83 INS83 INS43 INS59 INS29 INS83 INS83 INS43 INS59 INS29 INS83 INS83 INS43 INS59 INS42 INS44 INS8 INS83 INS43 INS42 INS43 INS8 INS83 INS43 INS42 INS8 INS78 INS83 INS39 INS42 INS8 INS78 INS83 INS43 INS42 INS8 INS60 INS21 INS66 INS66 INS65 INS42 INS42 INS33 INS65 INS42 INS42 INS33 INS65 INS42 INS42 INS43 INS42 INS21 INS21 INS21 INS42 INS42 INS25 INS41 INS42 INS41 INS42 INS54 INS42 INS42 INS41 INS43 INS59 INS32 INS66 INS66 INS66 INS42 INS7 INS32 INS32 INS27 INS8 INS42 INS42 INS8 INS12 INS12 INS27 INS42 INS42 INS14 INS42 INS42 INS54 INS42 INS42 INS42 INS27 INS42 INS9 INS42 INS33 INS53 MOV21 INS44 INS8 INS44 INS8 INS45 INS32 INS45 INS42 INS45 INS42 INS13 INS43 INS42 INS8 INS12 INS32 INS45 INS42 INS43 INS42 INS21 INS43 INS42 INS21 INS42 INS42 INS21 INS21 INS44 INS8 INS42 INS42 UPD42 INS42 INS7 INS42 INS7 INS32 INS7 INS43 INS42 INS53 INS42 INS42 INS42 INS14 INS42 INS42 INS42 INS32 INS42 INS14 INS43 INS42 INS42 INS42 INS43 INS42 INS42 INS42