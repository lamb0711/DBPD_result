HDFS-5614. NameNode: implement handling of ACLs in combination with snapshots. Contributed by Chris Nauroth.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-4685@1563304 13f79535-47bb-0310-9956-ffa450edef68

+    writeAclFeature(file, out);
+    writeAclFeature(a, out);
-  private static void writeAclFeature(INodeWithAdditionalFields node,
-      DataOutput out) throws IOException {
-    AclFsImageProto.Builder b = AclFsImageProto.newBuilder();
-    OutputStream os = (OutputStream) out;
+  private static void writeAclFeature(INodeAttributes node, DataOutput out)
+      throws IOException {
+    if (node.getFsPermission().getAclBit()) {
+      AclFsImageProto.Builder b = AclFsImageProto.newBuilder();
+      OutputStream os = (OutputStream) out;
-    AclFeature feature = node.getAclFeature();
-    if (feature != null)
-      b.addAllEntries(PBHelper.convertAclEntryProto(feature.getEntries()));
+      AclFeature feature = node.getAclFeature();
+      if (feature != null)
+        b.addAllEntries(PBHelper.convertAclEntryProto(feature.getEntries()));
-    b.build().writeDelimitedTo(os);
+      b.build().writeDelimitedTo(os);
+    }

INS8 INS21 INS21 UPD43 INS25 INS32 INS32 UPD42 INS32 MOV8 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS42