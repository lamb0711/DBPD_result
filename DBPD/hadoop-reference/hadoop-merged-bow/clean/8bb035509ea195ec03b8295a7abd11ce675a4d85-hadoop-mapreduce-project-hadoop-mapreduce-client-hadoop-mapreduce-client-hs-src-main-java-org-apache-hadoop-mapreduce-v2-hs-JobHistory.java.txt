MAPREDUCE-5411. Refresh size of loaded job cache on history server. Contributed by Ashwin Shankar


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1508220 13f79535-47bb-0310-9956-ffa450edef68

+import com.google.common.annotations.VisibleForTesting;
-    storage = ReflectionUtils.newInstance(conf.getClass(
-        JHAdminConfig.MR_HISTORY_STORAGE, CachedHistoryStorage.class,
-        HistoryStorage.class), conf);
+    storage = createHistoryStorage();
+    
+  protected HistoryStorage createHistoryStorage() {
+    return ReflectionUtils.newInstance(conf.getClass(
+        JHAdminConfig.MR_HISTORY_STORAGE, CachedHistoryStorage.class,
+        HistoryStorage.class), conf);
+  }
+  
+  public void refreshLoadedJobCache() {
+    if (getServiceState() == STATE.STARTED) {
+      if (storage instanceof CachedHistoryStorage) {
+        ((CachedHistoryStorage) storage).refreshLoadedJobCache();
+      } else {
+        throw new UnsupportedOperationException(storage.getClass().getName()
+            + " is expected to be an instance of "
+            + CachedHistoryStorage.class.getName());
+      }
+    } else {
+      LOG.warn("Failed to execute refreshLoadedJobCache: JobHistory service is not started");
+    }
+  }
+
+  @VisibleForTesting
+  HistoryStorage getHistoryStorage() {
+    return storage;
+  }
+  

INS26 INS40 INS31 INS31 INS31 INS83 INS43 INS42 INS8 INS83 INS39 INS42 INS8 INS78 INS43 INS42 INS8 INS42 INS41 INS25 INS42 INS42 INS41 MOV32 INS27 INS8 INS8 INS42 INS32 INS32 INS40 INS25 INS21 INS42 INS42 INS62 INS8 INS8 INS32 INS42 INS43 INS21 INS53 INS42 INS42 INS45 INS42 INS32 INS14 INS36 INS42 INS43 INS27 INS11 INS42 INS32 INS45 INS32 INS43 INS42 INS32 INS42 INS57 INS42 INS42 INS42 INS42 INS43 INS42