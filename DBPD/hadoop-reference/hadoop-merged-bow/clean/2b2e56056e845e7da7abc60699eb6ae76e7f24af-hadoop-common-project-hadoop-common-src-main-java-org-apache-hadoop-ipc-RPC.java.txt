Merge trunk into HA branch.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1236936 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.ipc.protobuf.ProtocolInfoProtos.ProtocolInfoService;
+import com.google.protobuf.BlockingService;
+
-  private static synchronized RpcEngine getProtocolEngine(Class<?> protocol,
-                                                          Configuration conf) {
+  static synchronized RpcEngine getProtocolEngine(Class<?> protocol,
+      Configuration conf) {
-
+  
+  /**
+   * Returns the server address for a given proxy.
+   */
+  public static InetSocketAddress getServerAddress(Object proxy) {
+    RpcInvocationHandler inv = (RpcInvocationHandler) Proxy
+        .getInvocationHandler(proxy);
+    return inv.getConnectionId().getAddress();
+  }
+   
+      initProtocolMetaInfo(conf);
+    }
+    
+    private void initProtocolMetaInfo(Configuration conf)
+        throws IOException {
+      RPC.setProtocolEngine(conf, ProtocolMetaInfoPB.class,
+          ProtobufRpcEngine.class);
+      ProtocolMetaInfoServerSideTranslatorPB xlator = 
+          new ProtocolMetaInfoServerSideTranslatorPB(this);
+      BlockingService protocolInfoBlockingService = ProtocolInfoService
+          .newReflectiveBlockingService(xlator);
+      addProtocol(RpcKind.RPC_PROTOCOL_BUFFER, ProtocolMetaInfoPB.class,
+          protocolInfoBlockingService);

INS26 INS26 INS40 INS40 INS31 INS29 INS83 INS83 INS43 INS42 INS44 INS8 INS31 INS65 INS42 INS43 INS42 INS60 INS41 INS83 INS39 INS42 INS44 INS43 INS8 INS66 INS42 INS43 INS59 INS32 INS21 INS43 INS42 INS42 INS21 INS60 INS60 INS21 INS42 INS42 INS11 INS32 INS42 INS32 INS42 INS32 INS43 INS59 INS43 INS59 INS32 INS43 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS57 INS57 INS42 INS42 INS14 INS42 INS42 INS32 INS42 INS40 INS57 INS42 INS42 INS42 INS42 INS42 INS43 INS43 INS43 INS52 INS42 INS42 INS42 INS43 INS42 INS42 INS42 INS42 DEL83