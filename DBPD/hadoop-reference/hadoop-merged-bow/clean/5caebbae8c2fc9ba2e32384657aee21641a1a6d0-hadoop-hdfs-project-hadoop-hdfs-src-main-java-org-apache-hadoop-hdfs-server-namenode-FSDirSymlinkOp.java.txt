HDFS-7484. Make FSDirectory#addINode take existing INodes as its parameter. Contributed by Jing Zhao.

+import java.util.Map;
-  static INodeSymlink unprotectedAddSymlink(
-      FSDirectory fsd, INodesInPath iip, long id, String target, long mtime,
-      long atime, PermissionStatus perm)
+  static INodeSymlink unprotectedAddSymlink(FSDirectory fsd, INodesInPath iip,
+      byte[] localName, long id, String target, long mtime, long atime,
+      PermissionStatus perm)
-    return fsd.addINode(iip, symlink) ? symlink : null;
+    symlink.setLocalName(localName);
+    return fsd.addINode(iip, symlink) != null ? symlink : null;
-  private static INodeSymlink addSymlink(
-      FSDirectory fsd, String path, INodesInPath iip, String target,
-      PermissionStatus dirPerms, boolean createParent, boolean logRetryCache)
-      throws IOException {
+  private static INodeSymlink addSymlink(FSDirectory fsd, String path,
+      INodesInPath iip, String target, PermissionStatus dirPerms,
+      boolean createParent, boolean logRetryCache) throws IOException {
+    final byte[] localName = iip.getLastLocalName();
-      INodesInPath parentIIP = iip.getParentINodesInPath();
-      if (parentIIP == null || (parentIIP = FSDirMkdirOp.mkdirsRecursively(
-          fsd,
-          parentIIP, dirPerms, true, mtime)) == null) {
+      Map.Entry<INodesInPath, String> e = FSDirMkdirOp
+          .createAncestorDirectories(fsd, iip, dirPerms);
+      if (e == null) {
-      } else {
-        iip = INodesInPath.append(parentIIP, null, iip.getLastLocalName());
+      iip = INodesInPath.append(e.getKey(), null, localName);
-    INodeSymlink newNode =
-        unprotectedAddSymlink(fsd, iip, id, target, mtime, mtime, perm);
+    INodeSymlink newNode = unprotectedAddSymlink(fsd, iip.getExistingINodes(),
+        localName, id, target, mtime, mtime, perm);

INS26 INS40 INS44 INS5 INS42 INS21 MOV60 MOV25 INS39 INS85 INS32 INS83 INS5 INS42 INS8 INS42 INS42 INS42 INS27 INS39 INS85 UPD42 MOV32 INS60 INS25 MOV21 MOV32 INS33 INS74 INS59 INS27 MOV8 INS32 INS42 INS43 MOV43 INS43 INS42 INS32 INS42 MOV33 MOV42 INS42 INS40 INS42 MOV42 UPD42 MOV42 MOV42 UPD42 MOV42 MOV42 INS32 INS42 UPD42 MOV42 INS42 DEL42 DEL42 DEL32 DEL42 DEL33 DEL27 DEL42 DEL9 DEL42 DEL32 DEL7 DEL36 DEL27 DEL27 DEL8 DEL42 DEL8 DEL25