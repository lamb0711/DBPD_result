Merge r1455389 through r1457712 from trunk.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1457716 13f79535-47bb-0310-9956-ffa450edef68

+import java.security.PrivilegedExceptionAction;
-  private HttpURLConnection getHttpUrlConnection(URL url)
-      throws IOException, AuthenticationException {
-    final HttpURLConnection conn;
-    if (ugi.hasKerberosCredentials()) { 
-      conn = new AuthenticatedURL(AUTH).openConnection(url, authToken);
-    } else {
-      conn = (HttpURLConnection)url.openConnection();
-    }
-    return conn;
-  }
-
+    private HttpURLConnection getHttpUrlConnection(final URL url)
+        throws IOException, AuthenticationException {
+      UserGroupInformation connectUgi = ugi.getRealUser();
+      if (connectUgi == null) {
+        connectUgi = ugi;
+      }
+      try {
+        return connectUgi.doAs(
+            new PrivilegedExceptionAction<HttpURLConnection>() {
+              @Override
+              public HttpURLConnection run() throws IOException {
+                return openHttpUrlConnection(url);
+              }
+            });
+      } catch (IOException ioe) {
+        Throwable cause = ioe.getCause();
+        if (cause != null && cause instanceof AuthenticationException) {
+          throw (AuthenticationException)cause;
+        }
+        throw ioe;
+      } catch (InterruptedException e) {
+        throw new IOException(e);
+      }
+    }
+    
+    private HttpURLConnection openHttpUrlConnection(final URL url)
+        throws IOException {
+      final HttpURLConnection conn;
+      try {
+        if (op.getRequireAuth()) {
+          LOG.debug("open AuthenticatedURL connection");
+          conn = new AuthenticatedURL(AUTH).openConnection(url, authToken);
+        } else {
+          LOG.debug("open URL connection");
+          conn = (HttpURLConnection)url.openConnection();
+        }
+      } catch (AuthenticationException e) {
+        throw new IOException(e);
+      }
+      return conn;
+    }
+  

INS26 INS40 INS31 MOV31 INS83 INS43 INS42 MOV44 INS43 MOV43 INS8 UPD42 INS44 INS42 INS83 INS42 INS60 INS25 INS54 INS83 INS43 INS42 INS54 INS43 INS59 INS27 INS8 INS8 INS12 INS12 INS42 INS8 INS12 INS42 INS42 INS32 INS42 INS33 INS21 INS41 INS44 INS8 INS44 INS8 MOV25 INS44 INS8 INS42 INS42 INS7 INS32 INS43 INS42 INS60 INS25 INS53 INS43 INS42 INS53 INS43 INS42 INS53 INS42 INS42 INS42 INS42 INS14 INS42 INS43 INS59 INS27 INS8 INS42 INS42 INS14 UPD42 UPD42 INS21 INS21 INS42 INS14 INS74 INS1 INS42 INS42 INS32 INS27 INS62 INS53 INS43 INS42 INS32 INS32 INS43 INS42 INS43 INS43 INS31 INS42 INS42 INS42 INS33 INS42 INS43 INS11 INS42 INS42 INS42 INS45 INS42 INS42 INS45 INS42 INS42 INS42 INS78 INS83 INS43 INS42 INS43 INS8 INS42 INS43 INS42 INS42 INS42 INS42 INS41 INS42 INS32 INS42 INS42