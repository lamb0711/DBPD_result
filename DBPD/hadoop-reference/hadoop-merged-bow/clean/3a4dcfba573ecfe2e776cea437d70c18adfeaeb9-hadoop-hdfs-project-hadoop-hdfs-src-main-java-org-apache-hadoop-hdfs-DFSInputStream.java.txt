HDFS-2757. Cannot read a local block that's being written to when using the local read short circuit. Contributed by Jean-Daniel Cryans


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1382409 13f79535-47bb-0310-9956-ffa450edef68

+  private synchronized boolean blockUnderConstruction() {
+    return locatedBlocks.isUnderConstruction();
+  }
+
-    if (dfsClient.shouldTryShortCircuitRead(dnAddr)) {
+    // Can't local read a block under construction, see HDFS-2757
+    if (dfsClient.shouldTryShortCircuitRead(dnAddr) &&
+        !blockUnderConstruction()) {

INS31 INS83 INS83 INS39 INS42 INS8 INS41 INS32 INS27 INS42 INS42 MOV32 INS38 INS32 INS42