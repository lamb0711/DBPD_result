HADOOP-15612. Improve exception when tfile fails to load LzoCodec. (gera)

- * 
+ *
- * 
+ *
+import com.google.common.annotations.VisibleForTesting;
+      private transient ClassNotFoundException cnf;
+      private transient boolean reinitCodecInTests;
+      private transient String clazz;
+      private String getLzoCodecClass() {
+        String extClazzConf = conf.get(CONF_LZO_CLASS);
+        String extClazz = (extClazzConf != null) ?
+            extClazzConf : System.getProperty(CONF_LZO_CLASS);
+        return (extClazz != null) ? extClazz : defaultClazz;
+      }
+
-        if (!checked) {
+        if (!checked || reinitCodecInTests) {
-          String extClazzConf = conf.get(CONF_LZO_CLASS);
-          String extClazz = (extClazzConf != null) ?
-              extClazzConf : System.getProperty(CONF_LZO_CLASS);
-          String clazz = (extClazz != null) ? extClazz : defaultClazz;
+          reinitCodecInTests = conf.getBoolean("test.reload.lzo.codec", false);
+          clazz = getLzoCodecClass();
-            // that is okay
+            cnf = e;
-          throw new IOException(
-              "LZO codec class not specified. Did you forget to set property "
-                  + CONF_LZO_CLASS + "?");
+          throw new IOException(String.format(
+              "LZO codec %s=%s could not be loaded", CONF_LZO_CLASS, clazz),
+                  cnf);

INS26 INS40 INS23 INS23 INS23 INS31 INS83 INS83 INS43 INS59 INS83 INS83 INS39 INS59 INS83 INS83 INS43 INS59 INS83 MOV43 INS42 MOV8 INS42 INS42 INS42 INS42 INS42 INS41 MOV16 INS27 INS8 MOV38 INS42 MOV21 INS21 INS21 MOV54 INS7 INS7 INS42 INS32 INS42 INS32 INS32 INS42 INS42 INS42 INS45 INS9 INS42 INS21 INS42 INS42 INS45 INS42 INS42 INS7 INS42 INS42 DEL42 DEL59 DEL60 DEL45 DEL42 DEL45 DEL27