HADOOP-6323. Add comparators to the serialization API.  Contributed by Aaron Kimball.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@889877 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.Map;
+
+import org.apache.hadoop.io.RawComparator;
-public class JavaSerialization implements Serialization<Serializable> {
-  
+public class JavaSerialization extends SerializationBase<Serializable> {
+
-    implements Deserializer<T> {
+    extends DeserializerBase<T> {
-  
-  static class JavaSerializationSerializer
-    implements Serializer<Serializable> {
+
+  static class JavaSerializationSerializer<T extends Serializable>
+      extends SerializerBase<T> {
+    private Map<String, String> metadata;
+
+    public JavaSerializationSerializer(Map<String, String> metadata) {
+      this.metadata = metadata;
+    }
-    public void serialize(Serializable object) throws IOException {
+    public void serialize(T object) throws IOException {
+    @Override
+    public Map<String, String> getMetadata() throws IOException {
+      return metadata;
+    }
-  public boolean accept(Class<?> c) {
+  public boolean accept(Map<String, String> metadata) {
+    String intendedSerializer = metadata.get(SERIALIZATION_KEY);
+    if (intendedSerializer != null &&
+        !getClass().getName().equals(intendedSerializer)) {
+      return false;
+    }
+
+    Class<?> c = getClassFromMetadata(metadata);
-  public Deserializer<Serializable> getDeserializer(Class<Serializable> c) {
+  public DeserializerBase<Serializable> getDeserializer(
+      Map<String, String> metadata) {
-  public Serializer<Serializable> getSerializer(Class<Serializable> c) {
-    return new JavaSerializationSerializer();
+  public SerializerBase<Serializable> getSerializer(
+      Map<String, String> metadata) {
+    return new JavaSerializationSerializer<Serializable>(metadata);
+  @SuppressWarnings("unchecked")
+  @Override
+  public RawComparator<Serializable> getRawComparator(
+      Map<String, String> metadata) {
+    Class<?> klazz = getClassFromMetadata(metadata);
+    if (null == klazz) {
+      throw new IllegalArgumentException(
+          "Cannot get comparator without " + SerializationBase.CLASS_KEY
+          + " set in metadata");
+    }
+
+    if (Serializable.class.isAssignableFrom(klazz)) {
+      try {
+        return (RawComparator<Serializable>) new JavaSerializationComparator();
+      } catch (IOException ioe) {
+        throw new IllegalArgumentException(
+            "Could not instantiate JavaSerializationComparator for type "
+            + klazz.getName(), ioe);
+      }
+    } else {
+      throw new IllegalArgumentException("Class " + klazz.getName()
+          + " is incompatible with JavaSerialization");
+    }
+  }

INS26 INS26 INS40 INS40 UPD74 INS31 UPD43 UPD74 INS73 INS74 INS23 INS31 INS31 INS8 UPD74 MOV74 UPD74 INS79 INS78 INS83 UPD74 MOV74 INS42 INS44 INS8 UPD42 UPD43 INS42 INS43 INS43 INS43 INS83 INS74 INS59 INS83 INS42 INS44 INS8 INS78 INS83 INS74 INS42 INS43 INS8 INS74 INS42 INS60 INS25 INS60 MOV41 UPD43 INS74 INS42 UPD43 INS74 INS42 INS42 INS45 INS42 UPD43 INS74 INS42 INS60 INS25 INS25 UPD42 INS42 INS42 INS42 INS43 INS43 INS43 INS42 INS74 INS42 INS21 INS43 INS42 INS43 INS43 INS43 INS42 INS41 INS43 INS43 INS43 INS43 INS59 INS27 INS8 MOV74 INS59 UPD42 INS43 INS43 INS43 UPD42 INS43 INS43 INS43 UPD42 INS43 INS43 INS43 INS74 INS59 INS27 INS8 INS32 INS8 INS8 INS42 INS42 INS42 INS43 INS43 INS43 INS7 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS27 INS38 INS41 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 UPD74 MOV74 INS42 INS42 INS42 INS42 INS43 INS76 INS42 INS32 INS33 INS42 INS53 INS57 INS42 INS42 INS54 INS53 INS42 INS42 INS42 INS22 INS42 INS42 INS42 INS42 INS42 INS33 INS32 INS9 INS42 INS42 UPD43 INS42 INS42 INS42 INS14 MOV43 INS8 INS12 INS14 INS52 INS42 INS32 INS42 INS42 UPD42 INS43 INS27 INS41 INS44 INS8 INS43 INS27 INS32 INS42 INS42 INS45 INS40 INS45 INS11 INS43 INS42 INS53 INS42 INS45 INS32 INS45 INS42 UPD74 MOV74 INS14 INS42 INS14 INS42 INS42 UPD43 INS43 INS43 INS27 INS42 UPD42 INS42 INS42 INS45 INS32 INS42 INS42 DEL42 DEL8 DEL42 DEL42