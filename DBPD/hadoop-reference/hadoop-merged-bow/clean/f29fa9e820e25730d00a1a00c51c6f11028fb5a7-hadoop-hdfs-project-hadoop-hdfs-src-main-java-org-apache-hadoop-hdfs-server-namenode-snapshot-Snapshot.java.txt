HDFS-4499. Fix file/directory/snapshot deletion for file diff.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1448504 13f79535-47bb-0310-9956-ffa450edef68

-  /** @return the latest snapshot taken on the given inode. */
-  public static Snapshot findLatestSnapshot(INode inode) {
+  /**
+   * Find the latest snapshot that 1) covers the given inode (which means the
+   * snapshot was either taken on the inode or taken on an ancestor of the
+   * inode), and 2) was taken before the given snapshot (if the given snapshot 
+   * is not null).
+   * 
+   * @param inode the given inode that the returned snapshot needs to cover
+   * @param anchor the returned snapshot should be taken before this snapshot.
+   * @return the latest snapshot covers the given inode and was taken before the
+   *         the given snapshot (if it is not null).
+   */
+  public static Snapshot findLatestSnapshot(INode inode, Snapshot anchor) {
-      if (inode instanceof INodeDirectorySnapshottable) {
-        final Snapshot s = ((INodeDirectorySnapshottable)inode).getLastSnapshot();
+      if (inode instanceof INodeDirectoryWithSnapshot) {
+        final Snapshot s = ((INodeDirectoryWithSnapshot) inode).getDiffs()
+            .getPrior(anchor);

INS44 INS65 INS65 INS65 INS43 INS42 INS66 INS66 INS66 INS66 INS42 INS66 INS42 INS66 UPD66 INS66 INS42 UPD43 UPD42 INS32 INS32 INS42 INS42 MOV36 UPD42 MOV42 UPD43 UPD42 DEL32