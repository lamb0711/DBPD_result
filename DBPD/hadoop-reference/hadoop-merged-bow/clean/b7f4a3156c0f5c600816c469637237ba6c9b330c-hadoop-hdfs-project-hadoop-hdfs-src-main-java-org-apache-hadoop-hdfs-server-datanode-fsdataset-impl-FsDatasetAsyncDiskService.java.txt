HDFS-7496. Fix FsVolume removal race conditions on the DataNode by reference-counting the volume instances (lei via cmccabe)

+import java.io.IOException;
+import org.apache.hadoop.hdfs.server.datanode.fsdataset.FsVolumeReference;
+import org.apache.hadoop.io.IOUtils;
-  void deleteAsync(FsVolumeImpl volume, File blockFile, File metaFile,
+  void deleteAsync(FsVolumeReference volumeRef, File blockFile, File metaFile,
-        volume, blockFile, metaFile, block, trashDirectory);
-    execute(volume.getCurrentDir(), deletionTask);
+        volumeRef, blockFile, metaFile, block, trashDirectory);
+    execute(((FsVolumeImpl) volumeRef.getVolume()).getCurrentDir(), deletionTask);
+    final FsVolumeReference volumeRef;
-    ReplicaFileDeleteTask(FsVolumeImpl volume, File blockFile,
+    ReplicaFileDeleteTask(FsVolumeReference volumeRef, File blockFile,
-      this.volume = volume;
+      this.volumeRef = volumeRef;
+      this.volume = (FsVolumeImpl) volumeRef.getVolume();
+      IOUtils.cleanup(null, volumeRef);

INS26 INS26 INS26 INS40 INS40 INS40 INS23 INS43 UPD42 INS83 INS43 INS59 INS42 MOV43 INS42 INS42 UPD43 UPD42 INS21 INS21 UPD42 INS7 INS32 MOV43 UPD42 INS36 INS22 INS42 INS11 INS42 INS42 INS33 INS42 INS11 INS52 INS42 MOV43 INS32 INS43 INS32 INS42 INS42 INS42 UPD42 MOV42 INS42 DEL42