HDFS-5557. Write pipeline recovery for the last packet in the block may cause rejection of valid replicas. Contributed by Kihwal Lee.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1547173 13f79535-47bb-0310-9956-ffa450edef68

-  private static class StatefulBlockInfo {
+  static class StatefulBlockInfo {
+    final Block reportedBlock;
-        ReplicaState reportedState) {
+        Block reportedBlock, ReplicaState reportedState) {
+      this.reportedBlock = reportedBlock;
-      addStoredBlockUnderConstruction(b.storedBlock, node, b.reportedState);
+      addStoredBlockUnderConstruction(b, node);
-          (BlockInfoUnderConstruction)storedBlock, reportedState));
+          (BlockInfoUnderConstruction)storedBlock, block, reportedState));
-  void addStoredBlockUnderConstruction(
-      BlockInfoUnderConstruction block, 
-      DatanodeDescriptor node, 
-      ReplicaState reportedState) 
-  throws IOException {
-    block.addReplicaIfNotPresent(node, block, reportedState);
-    if (reportedState == ReplicaState.FINALIZED && block.findDatanode(node) < 0) {
+  void addStoredBlockUnderConstruction(StatefulBlockInfo ucBlock,
+      DatanodeDescriptor node) throws IOException {
+    BlockInfoUnderConstruction block = ucBlock.storedBlock;
+    block.addReplicaIfNotPresent(node, ucBlock.reportedBlock, ucBlock.reportedState);
+    if (ucBlock.reportedState == ReplicaState.FINALIZED && block.findDatanode(node) < 0) {
-      addStoredBlockUnderConstruction(b.storedBlock, node, b.reportedState);
+      addStoredBlockUnderConstruction(b, node);

MOV44 INS23 INS83 INS43 INS59 INS44 UPD43 UPD42 INS60 INS42 INS42 INS43 INS42 INS21 UPD42 MOV43 INS59 INS42 INS7 INS42 INS40 INS40 INS40 INS22 INS42 INS40 INS52 INS42 INS42 INS42 INS42 DEL83 DEL40 DEL40 DEL42 DEL44 DEL42 DEL42 DEL42 DEL40 DEL40