HADOOP-3205. Read multiple chunks directly from FSInputChecker subclass into user buffers. Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@896243 13f79535-47bb-0310-9956-ffa450edef68

+
-      if(needChecksum()) {
-        try {
-          long checksumPos = getChecksumFilePos(pos); 
-          if(checksumPos != sums.getPos()) {
-            sums.seek(checksumPos);
-          }
-          sums.readFully(checksum);
-        } catch (EOFException e) {
-          eof = true;
+      if (needChecksum()) {
+        assert checksum != null; // we have a checksum buffer
+        assert checksum.length % CHECKSUM_SIZE == 0; // it is sane length
+        assert len >= bytesPerSum; // we must read at least one chunk
+
+        final int checksumsToRead = Math.min(
+          len/bytesPerSum, // number of checksums based on len to read
+          checksum.length / CHECKSUM_SIZE); // size of checksum buffer
+        long checksumPos = getChecksumFilePos(pos); 
+        if(checksumPos != sums.getPos()) {
+          sums.seek(checksumPos);
-        len = bytesPerSum;
+
+        int sumLenRead = sums.read(checksum, 0, CHECKSUM_SIZE * checksumsToRead);
+        if (sumLenRead >= 0 && sumLenRead % CHECKSUM_SIZE != 0) {
+          throw new ChecksumException(
+            "Checksum file not a length multiple of checksum size " +
+            "in " + file + " at " + pos + " checksumpos: " + checksumPos +
+            " sumLenread: " + sumLenRead,
+            pos);
+        }
+        if (sumLenRead <= 0) { // we're at the end of the file
+          eof = true;
+        } else {
+          // Adjust amount of data to read based on how many checksum chunks we read
+          len = Math.min(len, bytesPerSum * (sumLenRead / CHECKSUM_SIZE));
+        }
-      if( eof && nread > 0) {
+      if (eof && nread > 0) {

INS6 INS6 INS6 INS60 MOV60 MOV25 INS60 INS25 INS25 INS27 INS27 INS27 INS83 INS39 INS59 INS39 INS59 INS27 INS8 INS27 MOV8 INS8 INS42 INS33 INS27 INS34 INS42 INS42 INS42 INS32 INS42 INS32 INS27 INS27 INS53 INS42 INS34 MOV21 INS40 INS42 INS42 INS42 INS27 INS27 MOV42 UPD42 MOV42 MOV42 INS34 INS27 INS42 INS34 INS27 INS34 INS14 INS42 INS42 INS40 INS42 INS42 INS42 INS42 INS42 INS43 INS27 INS42 INS32 UPD42 MOV42 INS27 INS42 INS45 INS42 INS45 INS42 INS45 INS42 INS42 INS42 INS42 INS27 INS45 INS45 INS42 INS36 INS27 INS42 INS42 DEL42 DEL32 DEL21 DEL8 DEL43 DEL42 DEL44 DEL12 DEL54