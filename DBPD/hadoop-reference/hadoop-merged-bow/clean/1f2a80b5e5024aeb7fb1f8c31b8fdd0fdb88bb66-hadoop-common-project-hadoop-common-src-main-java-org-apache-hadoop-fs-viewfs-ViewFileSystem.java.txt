HDFS-15430. create should work when parent dir is internalDir and fallback configured. Contributed by Uma Maheswara Rao G.


+import com.google.common.base.Preconditions;
-        final Progressable progress) throws AccessControlException {
+        final Progressable progress) throws IOException {
+      Preconditions.checkNotNull(f, "File cannot be null.");
+      if (InodeTree.SlashPath.equals(f)) {
+        throw new FileAlreadyExistsException(
+            "/ is not a file. The directory / already exist at: "
+                + theInternalDir.fullPath);
+      }
+
+      if (this.fsState.getRootFallbackLink() != null) {
+
+        if (theInternalDir.getChildren().containsKey(f.getName())) {
+          throw new FileAlreadyExistsException(
+              "A mount path(file/dir) already exist with the requested path: "
+                  + theInternalDir.getChildren().get(f.getName()).fullPath);
+        }
+
+        FileSystem linkedFallbackFs =
+            this.fsState.getRootFallbackLink().getTargetFileSystem();
+        Path parent = Path.getPathWithoutSchemeAndAuthority(
+            new Path(theInternalDir.fullPath));
+        String leaf = f.getName();
+        Path fileToCreate = new Path(parent, leaf);
+
+        try {
+          return linkedFallbackFs
+              .create(fileToCreate, permission, overwrite, bufferSize,
+                  replication, blockSize, progress);
+        } catch (IOException e) {
+          StringBuilder msg =
+              new StringBuilder("Failed to create file:").append(fileToCreate)
+                  .append(" at fallback : ").append(linkedFallbackFs.getUri());
+          LOG.error(msg.toString(), e);
+          throw e;
+        }
+      }

INS26 INS40 UPD43 INS8 UPD42 INS21 INS25 INS25 MOV53 INS32 INS32 INS8 INS27 INS8 INS42 INS42 INS42 INS45 INS40 INS42 INS42 INS53 INS32 INS33 INS25 INS60 INS60 INS60 INS60 INS54 INS14 INS22 INS42 INS32 INS8 INS43 INS59 INS43 INS59 INS43 INS59 INS43 INS59 INS8 INS12 INS43 INS27 INS52 INS42 INS32 INS42 INS32 INS53 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS14 INS41 INS44 INS8 INS42 INS45 INS40 INS42 INS42 INS42 INS42 INS14 INS32 INS42 INS42 INS42 INS14 INS42 INS42 INS43 INS42 INS42 INS32 INS43 INS42 INS60 INS21 INS53 INS43 INS27 INS22 INS42 INS43 INS40 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS43 INS59 INS32 INS42 INS42 INS45 INS22 INS52 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS32 INS42 INS32 INS42 INS32 INS42 INS42 INS32 INS42 INS32 INS32 INS42 INS45 INS42 INS42 INS42 INS42 INS42 INS42 INS14 INS42 INS42 INS43 INS45 INS42 DEL8