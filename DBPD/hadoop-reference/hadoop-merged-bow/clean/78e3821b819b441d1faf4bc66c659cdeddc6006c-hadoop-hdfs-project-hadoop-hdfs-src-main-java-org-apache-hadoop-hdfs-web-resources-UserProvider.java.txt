HDFS-2318. Provide authentication to webhdfs using SPNEGO and delegation tokens.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1171611 13f79535-47bb-0310-9956-ffa450edef68

+import java.io.IOException;
-import java.security.Principal;
+import javax.servlet.http.HttpServletRequest;
+import org.apache.hadoop.conf.Configuration;
+import org.apache.hadoop.hdfs.server.common.JspHelper;
+import org.apache.hadoop.security.UserGroupInformation;
+import org.apache.hadoop.security.UserGroupInformation.AuthenticationMethod;
+
+/** Inject user information to http operations. */
-public class UserProvider extends AbstractHttpContextInjectable<Principal>
+public class UserProvider
+    extends AbstractHttpContextInjectable<UserGroupInformation>
+  @Context HttpServletRequest request;
-  public Principal getValue(final HttpContext context) {
-    //get principal from the request
-    final Principal principal = context.getRequest().getUserPrincipal();
-    if (principal != null) {
-      return principal;
+  public UserGroupInformation getValue(final HttpContext context) {
+    final Configuration conf = (Configuration)context.getProperties().get(
+        JspHelper.CURRENT_CONF);
+    try {
+      return JspHelper.getUGI(null, request, conf,
+          AuthenticationMethod.KERBEROS, false);
+    } catch (IOException e) {
+      throw new RuntimeException(e);
-
-    //get username from the parameter
-    final String username = context.getRequest().getQueryParameters().getFirst(
-        UserParam.NAME);
-    if (username != null) {
-      final UserParam userparam = new UserParam(username);
-      return new Principal() {
-        @Override
-        public String getName() {
-          return userparam.getValue();
-        }
-      };
-    }
-
-    //user not found
-    return null;
-  public Injectable<Principal> getInjectable(
+  public Injectable<UserGroupInformation> getInjectable(
-    return type.equals(Principal.class)? this : null;
+    return type.equals(UserGroupInformation.class)? this : null;

MOV26 INS26 INS26 INS26 INS26 INS26 UPD40 INS40 INS40 INS40 INS40 INS40 INS29 UPD74 INS23 INS65 UPD43 INS78 INS43 INS59 UPD43 UPD74 INS66 UPD42 INS42 INS42 INS42 UPD42 INS54 UPD43 UPD43 INS8 INS12 UPD42 UPD42 UPD42 INS11 INS41 INS44 INS8 INS43 INS32 INS32 INS43 INS42 INS53 INS42 MOV32 UPD42 MOV42 INS40 UPD42 MOV42 UPD42 MOV42 INS33 UPD42 MOV42 UPD42 MOV42 UPD40 MOV40 INS9 UPD42 MOV42 INS14 UPD43 UPD42 UPD43 MOV43 INS42 UPD42 UPD42 DEL32 DEL42 DEL33 DEL27 DEL42 DEL41 DEL8 DEL25 DEL83 DEL42 DEL43 DEL42 DEL32 DEL32 DEL32 DEL59 DEL60 DEL42 DEL33 DEL27 DEL83 DEL43 DEL42 DEL42 DEL43 DEL42 DEL14 DEL59 DEL60 DEL42 DEL78 DEL83 DEL42 DEL43 DEL42 DEL42 DEL42 DEL32 DEL41 DEL8 DEL31 DEL1 DEL14 DEL41 DEL8 DEL25 DEL33 DEL41