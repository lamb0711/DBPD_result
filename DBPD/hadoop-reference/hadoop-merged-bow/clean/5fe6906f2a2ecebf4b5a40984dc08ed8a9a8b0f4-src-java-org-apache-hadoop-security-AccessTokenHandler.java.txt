HADOOP-6176. Add a couple package private methods to AccessTokenHandler for testing.  Contributed by Kan Zhang


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@802224 13f79535-47bb-0310-9956-ffa450edef68

-  private final long tokenLifetime;
+  private long tokenLifetime;
-  private synchronized Boolean verifyToken(long keyID, AccessToken token)
+  private synchronized boolean verifyToken(long keyID, AccessToken token)
-  public Boolean checkAccess(AccessToken token, String userID, long blockID,
+  public boolean checkAccess(AccessToken token, String userID, long blockID,
-        && System.currentTimeMillis() < oExpiry && oModes.contains(mode)
+        && !isExpired(oExpiry) && oModes.contains(mode)
+  private static boolean isExpired(long expiryDate) {
+    return System.currentTimeMillis() > expiryDate;
+  }
+
+  /** check if a token is expired. for unit test only.
+   *  return true when token is expired, false otherwise */
+  static boolean isTokenExpired(AccessToken token) throws IOException {
+    ByteArrayInputStream buf = new ByteArrayInputStream(token.getTokenID()
+        .getBytes());
+    DataInputStream in = new DataInputStream(buf);
+    long expiryDate = WritableUtils.readVLong(in);
+    return isExpired(expiryDate);
+  }
+
+  /** set token lifetime. for unit test only */
+  synchronized void setTokenLifetime(long tokenLifetime) {
+    this.tokenLifetime = tokenLifetime;
+  }

INS23 INS31 INS31 INS31 MOV83 INS39 MOV59 INS39 INS39 INS83 INS83 INS39 INS42 INS44 INS8 INS29 INS83 INS39 INS42 INS44 INS43 INS8 INS29 INS83 INS39 INS42 INS44 INS8 INS39 INS42 INS41 INS65 INS43 INS42 INS42 INS60 INS60 INS60 INS41 INS65 INS39 INS42 INS21 UPD27 MOV27 INS66 INS66 INS42 INS43 INS59 INS43 INS59 INS39 INS59 INS32 INS66 INS7 UPD42 INS42 INS42 INS14 INS42 INS42 INS14 INS42 INS32 INS42 INS42 INS22 INS42 INS43 INS32 INS43 INS42 INS42 INS42 INS42 INS52 INS42 INS38 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS42 INS42 DEL83 DEL39 DEL23 DEL42 DEL43 DEL42 DEL43