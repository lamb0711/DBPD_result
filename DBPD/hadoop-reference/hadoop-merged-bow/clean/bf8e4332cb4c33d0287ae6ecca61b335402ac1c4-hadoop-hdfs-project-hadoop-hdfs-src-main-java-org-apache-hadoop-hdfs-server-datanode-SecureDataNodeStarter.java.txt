HDFS-7279. Use netty to implement DatanodeWebHdfsMethods. Contributed by Haohui Mai.

-import java.net.InetSocketAddress;
-import java.net.ServerSocket;
-import java.nio.channels.ServerSocketChannel;
-
+import com.google.common.annotations.VisibleForTesting;
-import org.apache.hadoop.http.HttpServer2;
-import org.mortbay.jetty.Connector;
-import com.google.common.annotations.VisibleForTesting;
+import java.net.InetSocketAddress;
+import java.net.ServerSocket;
+import java.nio.channels.ServerSocketChannel;
-    private final Connector listener;
-    public SecureResources(ServerSocket streamingSocket,
-        Connector listener) {
-
+    private final ServerSocketChannel httpServerSocket;
+    public SecureResources(ServerSocket streamingSocket, ServerSocketChannel httpServerSocket) {
-      this.listener = listener;
+      this.httpServerSocket = httpServerSocket;
-    public Connector getListener() { return listener; }
+    public ServerSocketChannel getHttpServerChannel() {
+      return httpServerSocket;
+    }
-    Connector listener = null;
+    final ServerSocketChannel httpChannel;
-      listener = HttpServer2.createDefaultChannelConnector();
+      httpChannel = ServerSocketChannel.open();
-      listener.setHost(infoSocAddr.getHostName());
-      listener.setPort(infoSocAddr.getPort());
-      // Open listener here in order to bind to port as root
-      listener.open();
-      if (listener.getPort() != infoSocAddr.getPort()) {
+      httpChannel.socket().bind(infoSocAddr);
+      InetSocketAddress localAddr = (InetSocketAddress) httpChannel.socket()
+        .getLocalSocketAddress();
+
+      if (localAddr.getPort() != infoSocAddr.getPort()) {
-          + ss + " ) (http listener port = " + listener.getConnection() +")");
+          + ss + " ) (http listener port = " + localAddr.getPort() +")");
-      if (listener.getPort() > 1023 && isSecure) {
+      if (localAddr.getPort() > 1023 && isSecure) {
+    } else {
+      httpChannel = null;
-    return new SecureResources(ss, listener);
+    return new SecureResources(ss, httpChannel);

MOV26 MOV26 MOV26 MOV26 UPD43 UPD43 UPD42 UPD42 UPD42 UPD43 UPD42 UPD42 INS83 UPD43 INS8 UPD42 UPD42 UPD42 UPD42 INS60 INS21 UPD42 UPD42 INS43 INS59 INS7 UPD42 UPD42 INS32 INS42 MOV42 INS42 INS42 INS11 INS42 INS33 UPD42 UPD42 UPD42 MOV42 UPD42 MOV42 INS43 INS32 UPD42 INS42 INS32 INS42 UPD42 UPD42 UPD42 UPD42 MOV42 UPD42 MOV42 DEL40 DEL26 DEL40 DEL26 DEL33 DEL42 DEL32 DEL42 DEL42 DEL42 DEL42 DEL32 DEL32 DEL21 DEL32 DEL21