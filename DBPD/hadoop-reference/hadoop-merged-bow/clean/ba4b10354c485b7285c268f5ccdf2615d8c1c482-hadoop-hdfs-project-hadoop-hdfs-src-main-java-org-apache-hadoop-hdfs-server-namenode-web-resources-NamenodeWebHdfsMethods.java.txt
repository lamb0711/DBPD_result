Merging r1566359 through r1568420 from trunk.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535@1568437 13f79535-47bb-0310-9956-ffa450edef68

+import com.google.common.annotations.VisibleForTesting;
+  @VisibleForTesting
-      final long blocksize, final Configuration conf) throws IOException {
+      final long blocksize) throws IOException {
-          return JspHelper.bestNode(locations.get(0).getLocations(), false, conf);
+          return bestNode(locations.get(0).getLocations());
+  /**
+   * Choose the datanode to redirect the request. Note that the nodes have been
+   * sorted based on availability and network distances, thus it is sufficient
+   * to return the first element of the node here.
+   */
+  private static DatanodeInfo bestNode(DatanodeInfo[] nodes) throws IOException {
+    if (nodes.length == 0 || nodes[0].isDecommissioned()) {
+      throw new IOException("No active nodes contain this block");
+    }
+    return nodes[0];
+  }
+
-    Text kind = request.getScheme().equals("http") ? WebHdfsFileSystem.TOKEN_KIND : SWebHdfsFileSystem.TOKEN_KIND;
+    Text kind = request.getScheme().equals("http") ? WebHdfsFileSystem.TOKEN_KIND
+        : SWebHdfsFileSystem.TOKEN_KIND;
-    final Configuration conf = (Configuration)context.getAttribute(JspHelper.CURRENT_CONF);
-        blocksize, conf);
+        blocksize);

INS26 INS40 INS31 INS78 INS29 INS83 INS83 INS43 INS42 INS44 INS43 INS8 INS42 INS65 INS42 INS5 INS42 INS42 INS25 INS41 INS66 INS66 INS66 INS43 INS85 INS27 INS8 INS2 INS42 INS27 INS32 INS53 INS42 INS34 INS40 INS34 INS2 INS42 INS14 INS42 INS34 INS43 INS45 INS42 DEL83 DEL42 DEL43 DEL42 DEL44 DEL42 DEL9 DEL42 DEL83 DEL42 DEL43 DEL42 DEL42 DEL43 DEL42 DEL42 DEL40 DEL32 DEL11 DEL59 DEL60 DEL42