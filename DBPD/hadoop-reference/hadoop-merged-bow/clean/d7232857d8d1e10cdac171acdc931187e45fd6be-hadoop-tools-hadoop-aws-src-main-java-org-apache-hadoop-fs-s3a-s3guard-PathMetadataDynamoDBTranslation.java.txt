HADOOP-14154 Persist isAuthoritative bit in DynamoDBMetaStore (Contributed by Gabor Bota)

+import java.util.List;
+import java.util.stream.Collectors;
+  static final String IS_AUTHORITATIVE = "is_authoritative";
-   * Converts a DynamoDB item to a {@link PathMetadata}.
+   * Converts a DynamoDB item to a {@link DDBPathMetadata}.
-   * @return {@code item} converted to a {@link PathMetadata}
+   * @return {@code item} converted to a {@link DDBPathMetadata}
-  static PathMetadata itemToPathMetadata(Item item, String username)
+  static DDBPathMetadata itemToPathMetadata(Item item, String username)
+      throws IOException {
+    return itemToPathMetadata(item, username, false);
+  }
+
+  /**
+   * Converts a DynamoDB item to a {@link DDBPathMetadata}.
+   * Can ignore {@code IS_AUTHORITATIVE} flag if {@code ignoreIsAuthFlag} is
+   * true.
+   *
+   * @param item DynamoDB item to convert
+   * @param ignoreIsAuthFlag if true, ignore the authoritative flag on item
+   * @return {@code item} converted to a {@link DDBPathMetadata}
+   */
+  static DDBPathMetadata itemToPathMetadata(Item item, String username,
+      boolean ignoreIsAuthFlag)
+    boolean isAuthoritativeDir = false;
+      if (!ignoreIsAuthFlag) {
+        isAuthoritativeDir = item.hasAttribute(IS_AUTHORITATIVE)
+            && item.getBoolean(IS_AUTHORITATIVE);
+      }
-    return new PathMetadata(fileStatus, Tristate.UNKNOWN, isDeleted);
+    return new DDBPathMetadata(fileStatus, Tristate.UNKNOWN, isDeleted,
+        isAuthoritativeDir);
-   * Converts a {@link PathMetadata} to a DynamoDB item.
+   * Converts a {@link DDBPathMetadata} to a DynamoDB item.
-   * @param meta {@link PathMetadata} to convert
+   * @param meta {@link DDBPathMetadata} to convert
-  static Item pathMetadataToItem(PathMetadata meta) {
+  static Item pathMetadataToItem(DDBPathMetadata meta) {
+    return pathMetadataToItem(meta, false);
+  }
+
+  /**
+   * Converts a {@link DDBPathMetadata} to a DynamoDB item.
+   *
+   * Can ignore {@code IS_AUTHORITATIVE} flag if {@code ignoreIsAuthFlag} is
+   * true.
+   *
+   * @param meta {@link DDBPathMetadata} to convert
+   * @param ignoreIsAuthFlag if true, ignore the authoritative flag on item
+   * @return {@code meta} converted to DynamoDB item
+   */
+  static Item pathMetadataToItem(DDBPathMetadata meta,
+      boolean ignoreIsAuthFlag) {
+      if (!ignoreIsAuthFlag) {
+        item.withBoolean(IS_AUTHORITATIVE, meta.isAuthoritativeDir());
+      }
-   * Converts a collection {@link PathMetadata} to a collection DynamoDB items.
+   * Converts a collection {@link DDBPathMetadata} to a collection DynamoDB
+   * items.
-   * @see #pathMetadataToItem(PathMetadata)
+   * @see #pathMetadataToItem(DDBPathMetadata)
-  static Item[] pathMetadataToItem(Collection<PathMetadata> metas) {
+  static Item[] pathMetadataToItem(Collection<DDBPathMetadata> metas) {
-    for (PathMetadata meta : metas) {
+    for (DDBPathMetadata meta : metas) {
+  static List<DDBPathMetadata> pathMetaToDDBPathMeta(
+      Collection<PathMetadata> pathMetadatas) {
+    return pathMetadatas.stream().map(p -> new DDBPathMetadata(p))
+        .collect(Collectors.toList());
+  }
+

INS26 INS26 INS40 INS40 INS23 INS31 INS31 INS31 INS83 INS83 INS43 INS59 INS29 INS83 INS43 INS42 INS44 INS44 INS43 INS8 UPD43 INS44 INS29 INS83 INS43 INS42 INS44 INS8 INS44 INS44 INS83 INS74 INS42 MOV44 INS8 INS42 INS42 INS45 INS65 MOV65 INS65 INS42 INS43 INS42 INS43 INS42 INS42 INS41 INS65 INS65 UPD42 INS39 INS42 INS60 INS65 INS65 MOV65 INS42 INS43 INS42 INS41 INS65 INS65 UPD43 INS39 INS42 INS74 INS42 INS43 INS43 UPD42 INS41 INS66 INS65 INS66 INS66 MOV65 INS66 INS65 INS42 INS42 INS32 INS66 INS65 INS66 INS65 INS66 INS66 INS42 INS66 INS42 INS66 INS65 INS39 INS59 INS66 INS65 INS66 INS42 INS66 INS65 INS66 INS42 INS32 INS66 INS65 INS66 INS65 INS66 INS66 INS42 INS66 INS66 INS65 INS66 UPD42 UPD66 INS66 INS43 INS43 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS9 UPD42 INS66 INS66 INS66 UPD42 INS42 INS9 INS25 UPD43 INS42 INS42 INS42 INS42 INS42 INS9 UPD42 INS66 INS66 UPD42 INS66 INS25 UPD42 INS42 INS42 UPD43 INS32 INS42 INS32 INS38 INS8 UPD42 INS38 INS8 UPD43 UPD42 INS32 INS42 INS86 INS42 INS42 INS42 INS21 INS42 INS21 UPD42 INS42 INS42 INS59 INS14 INS7 INS32 INS42 INS43 INS42 INS42 INS27 INS42 INS42 INS42 INS32 INS42 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42