YARN-27. Failed refreshQueues due to misconfiguration prevents further refreshing of queues (Arun Murthy via tgraves)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1375066 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.classification.InterfaceAudience.Private;
-  public static QueueMetrics forQueue(MetricsSystem ms, String queueName,
+  /**
+   * Helper method to clear cache - used only for unit tests.
+   */
+  @Private
+  public synchronized static void clearQueueMetrics() {
+    queueMetrics.clear();
+  }
+  
+  /**
+   * Simple metrics cache to help prevent re-registrations.
+   */
+  private static Map<String, QueueMetrics> queueMetrics =
+      new HashMap<String, QueueMetrics>();
+  
+  public synchronized 
+  static QueueMetrics forQueue(MetricsSystem ms, String queueName,
-    QueueMetrics metrics = 
-      new QueueMetrics(ms, queueName, parent, enableUserMetrics, conf
-		       ).tag(QUEUE_INFO, queueName);
-    return ms == null ? metrics : ms.register(sourceName(queueName).toString(),
-        "Metrics for queue: " + queueName, metrics);
+    QueueMetrics metrics = queueMetrics.get(queueName);
+    if (metrics == null) {
+      metrics =
+          new QueueMetrics(ms, queueName, parent, enableUserMetrics, conf).
+          tag(QUEUE_INFO, queueName);
+      
+      // Register with the MetricsSystems
+      if (ms != null) {
+        metrics = 
+            ms.register(
+                sourceName(queueName).toString(), 
+                "Metrics for queue: " + queueName, metrics);
+      }
+      queueMetrics.put(queueName, metrics);
+    }
+
+    return metrics;

INS26 INS40 INS31 INS23 INS29 INS78 INS83 INS83 INS83 INS39 INS42 INS8 INS29 INS83 INS83 INS74 INS59 INS83 INS8 INS65 INS42 INS21 INS65 INS43 INS43 INS43 INS42 INS14 INS60 INS25 INS41 INS66 INS32 INS66 INS42 INS42 INS42 INS74 MOV43 INS59 INS27 MOV8 INS42 INS42 INS42 INS43 INS43 INS43 INS42 INS32 INS42 INS33 INS21 INS25 INS21 INS42 INS42 INS42 INS42 INS42 INS42 INS7 INS27 INS8 INS32 INS42 MOV32 MOV42 MOV33 INS21 INS42 INS42 INS42 INS42 INS7 INS42 MOV32 DEL42 DEL59 DEL60 DEL27 DEL42 DEL16 DEL41