HDFS-8567. Erasure Coding: SafeMode handles file smaller than a full stripe. Contributed by Walter Su.

+  /**
+   * If the block is committed/completed and its length is less than a full
+   * stripe, it returns the the number of actual data blocks.
+   * Otherwise it returns the number of data units specified by schema.
+   */
+  public short getRealDataBlockNum() {
+    if (isComplete() || getBlockUCState() == BlockUCState.COMMITTED) {
+      return (short) Math.min(getDataBlockNum(),
+          (getNumBytes() - 1) / BLOCK_STRIPED_CELL_SIZE + 1);
+    } else {
+      return getDataBlockNum();
+    }
+  }
+
+  public short getRealTotalBlockNum() {
+    return (short) (getRealDataBlockNum() + getParityBlockNum());
+  }
+

INS31 INS31 INS29 INS83 INS39 INS42 INS8 INS83 INS39 INS42 INS8 INS65 INS25 INS41 INS66 INS66 INS66 INS27 INS8 INS8 INS11 INS32 INS27 INS41 INS41 INS39 INS36 INS42 INS32 INS40 INS11 INS32 INS27 INS42 INS39 INS32 INS42 INS32 INS32 INS42 INS42 INS32 INS27 INS42 INS42 INS42 INS27 INS34 INS36 INS42 INS27 INS32 INS34 INS42