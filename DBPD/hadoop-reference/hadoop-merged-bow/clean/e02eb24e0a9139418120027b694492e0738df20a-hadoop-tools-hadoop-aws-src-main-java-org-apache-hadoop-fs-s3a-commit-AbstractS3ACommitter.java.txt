HADOOP-15183. S3Guard store becomes inconsistent after partial failure of rename.

Contributed by Steve Loughran.

Change-Id: I825b0bc36be960475d2d259b1cdab45ae1bb78eb

-    Tasks.foreach(pending)
-        .stopOnFailure()
-        .executeWith(buildThreadPool(context))
-        .onFailure((commit, exception) ->
-                getCommitOperations().abortSingleCommit(commit))
-        .abortWith(commit -> getCommitOperations().abortSingleCommit(commit))
-        .revertWith(commit -> getCommitOperations().revertCommit(commit))
-        .run(commit -> getCommitOperations().commitOrFail(commit));
+    try(CommitOperations.CommitContext commitContext
+            = initiateCommitOperation()) {
+      Tasks.foreach(pending)
+          .stopOnFailure()
+          .executeWith(buildThreadPool(context))
+          .onFailure((commit, exception) ->
+              commitContext.abortSingleCommit(commit))
+          .abortWith(commitContext::abortSingleCommit)
+          .revertWith(commitContext::revertCommit)
+          .run(commitContext::commitOrFail);
+    }
+  }
+
+  /**
+   * Start the final commit/abort commit operations.
+   * @return a commit context through which the operations can be invoked.
+   * @throws IOException failure.
+   */
+  protected CommitOperations.CommitContext initiateCommitOperation()
+      throws IOException {
+    return getCommitOperations().initiateCommitOperation(getOutputPath());
-                 dest)) {
+                 dest);
+         CommitOperations.CommitContext commitContext
+             = initiateCommitOperation()) {
-          .run(u -> ops.abortMultipartCommit(u.getKey(), u.getUploadId()));
+          .run(u -> commitContext.abortMultipartCommit(
+              u.getKey(), u.getUploadId()));
-          "Aborting %s uploads", pending.size())) {
+          "Aborting %s uploads", pending.size());
+           CommitOperations.CommitContext commitContext
+               = initiateCommitOperation()) {
-            .run(commit -> getCommitOperations().abortSingleCommit(commit));
+            .run(commitContext::abortSingleCommit);

INS31 INS29 INS83 INS43 INS42 INS43 INS8 INS54 INS65 INS65 INS65 INS40 INS42 INS41 INS58 INS8 INS66 INS66 INS42 INS66 INS32 INS58 INS43 INS59 MOV21 MOV32 INS42 INS32 INS43 INS59 INS40 INS42 INS32 INS42 INS40 INS42 INS32 INS58 INS42 INS90 INS42 INS43 INS59 INS90 INS42 INS42 INS40 INS42 INS32 INS90 INS42 INS42 UPD42 INS42 INS90 INS42 INS42 INS42 INS42 UPD42 MOV42 DEL32 DEL42 DEL59 DEL42 DEL32 DEL42 DEL42 DEL32 DEL86 DEL42 DEL59 DEL42 DEL32 DEL42 DEL42 DEL32 DEL86 DEL42 DEL59 DEL42 DEL42 DEL32 DEL86 DEL42 DEL59 DEL42 DEL32 DEL42 DEL42 DEL32 DEL86