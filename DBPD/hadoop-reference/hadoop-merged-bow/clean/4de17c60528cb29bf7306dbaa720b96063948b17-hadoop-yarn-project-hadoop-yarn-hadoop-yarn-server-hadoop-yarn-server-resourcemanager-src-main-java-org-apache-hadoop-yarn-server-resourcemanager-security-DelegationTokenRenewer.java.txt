YARN-1812. Fixed ResourceManager to synchrously renew tokens after recovery and thus recover app itself synchronously and avoid races with resyncing NodeManagers. Contributed by Jian He.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1576843 13f79535-47bb-0310-9956-ffa450edef68

+    renewalTimer = new Timer(true);
-    renewalTimer = new Timer(true);
-      processDelegationTokenRewewerEvent(pendingEventQueue.take());
+      processDelegationTokenRenewerEvent(pendingEventQueue.take());
-  private void processDelegationTokenRewewerEvent(
+  private void processDelegationTokenRenewerEvent(
-   * Add application tokens for renewal.
+   * Asynchronously add application tokens for renewal.
-  public void addApplication(
-      ApplicationId applicationId, Credentials ts, boolean shouldCancelAtEnd,
-      boolean isApplicationRecovered) {
-    processDelegationTokenRewewerEvent(new DelegationTokenRenewerAppSubmitEvent(
-        applicationId, ts,
-        shouldCancelAtEnd, isApplicationRecovered));
+  public void addApplicationAsync(ApplicationId applicationId, Credentials ts,
+      boolean shouldCancelAtEnd) {
+    processDelegationTokenRenewerEvent(new DelegationTokenRenewerAppSubmitEvent(
+      applicationId, ts, shouldCancelAtEnd));
+  }
+
+  /**
+   * Synchronously renew delegation tokens.
+   */
+  public void addApplicationSync(ApplicationId applicationId, Credentials ts,
+      boolean shouldCancelAtEnd) throws IOException{
+    handleAppSubmitEvent(new DelegationTokenRenewerAppSubmitEvent(
+      applicationId, ts, shouldCancelAtEnd));
-    processDelegationTokenRewewerEvent(new DelegationTokenRenewerEvent(
+    processDelegationTokenRenewerEvent(new DelegationTokenRenewerEvent(
-            .handle(new RMAppEvent(event.getApplicationId(),
-                event.isApplicationRecovered() ? RMAppEventType.RECOVER
-                    : RMAppEventType.START));
+            .handle(new RMAppEvent(event.getApplicationId(), RMAppEventType.START));
-  class DelegationTokenRenewerAppSubmitEvent extends
+  private static class DelegationTokenRenewerAppSubmitEvent extends
-    private boolean isAppRecovered;
-        Credentials credentails, boolean shouldCancelAtEnd,
-        boolean isApplicationRecovered) {
+        Credentials credentails, boolean shouldCancelAtEnd) {
-      this.isAppRecovered = isApplicationRecovered;
-
-    public boolean isApplicationRecovered() {
-      return isAppRecovered;
-    }
-  class DelegationTokenRenewerEvent extends
+  private static class DelegationTokenRenewerEvent extends

INS31 UPD42 UPD42 INS29 INS83 INS39 INS42 INS44 INS44 INS44 INS43 INS8 INS83 INS83 INS42 INS83 INS83 MOV21 INS65 INS43 INS42 INS43 INS42 INS39 INS42 INS42 INS21 UPD66 INS66 INS42 INS42 INS32 UPD42 INS42 INS14 UPD42 INS43 INS42 INS42 INS42 UPD42 INS42 INS40 DEL39 DEL42 DEL44 DEL42 DEL42 DEL42 DEL32 DEL40 DEL40 DEL16 DEL42 DEL83 DEL39 DEL42 DEL59 DEL23 DEL39 DEL42 DEL44 DEL52 DEL42 DEL22 DEL42 DEL7 DEL21 DEL83 DEL39 DEL42 DEL42 DEL41 DEL8 DEL31