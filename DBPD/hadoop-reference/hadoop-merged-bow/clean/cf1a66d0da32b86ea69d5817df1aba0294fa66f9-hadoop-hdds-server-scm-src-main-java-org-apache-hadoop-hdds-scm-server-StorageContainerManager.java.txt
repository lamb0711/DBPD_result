HDDS-1101. SCM CA: Write Certificate information to SCM Metadata. Contributed by Anu Engineer.

+    if (OzoneSecurityUtil.isSecurityEnabled(conf)) {
+      loginAsSCMUser(conf);
+    }
-    // Authenticate SCM if security is enabled
+    // Creates the SCM DBs or opens them if it exists.
+    // A valid pointer to the store is required by all the other services below.
+    initalizeMetadataStore(conf, configurator);
+
+    // Authenticate SCM if security is enabled, this initialization can only
+    // be done after the metadata store is initialized.
-    // Creates the SCM DBs or opens them if it exists.
-    initalizeMetadataStore(conf, configurator);
-      throws IOException, AuthenticationException {
-    loginAsSCMUser(conf);
+      throws IOException {
+      // This assumes that SCM init has run, and DB metadata stores are created.
-    return new DefaultCAServer(subject, clusterID, scmID);
+    if(this.scmMetadataStore == null) {
+      LOG.error("Cannot initialize Certificate Server without a valid meta " +
+          "data layer.");
+      throw new SCMException("Cannot initialize CA without a valid metadata " +
+          "store", ResultCodes.SCM_NOT_INITIALIZED);
+    }
+    SCMCertStore certStore = new SCMCertStore(this.scmMetadataStore);
+    return new DefaultCAServer(subject, clusterID, scmID, certStore);

MOV25 INS25 INS25 INS60 INS32 INS8 INS27 INS8 INS43 INS59 INS42 INS42 INS42 MOV21 INS22 INS33 INS21 INS53 INS42 INS42 INS14 INS42 INS52 INS42 INS32 INS14 INS43 INS22 INS42 INS42 INS27 INS43 INS27 INS40 INS42 INS52 INS42 INS45 INS45 INS42 INS45 INS45 DEL42 DEL43