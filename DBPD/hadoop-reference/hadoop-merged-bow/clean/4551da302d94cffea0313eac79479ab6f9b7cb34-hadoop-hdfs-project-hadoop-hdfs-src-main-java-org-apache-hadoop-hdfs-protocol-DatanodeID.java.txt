HDFS-5233. Use Datanode UUID to identify Datanodes.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2832@1525407 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.UUID;
+
-  private String storageID;  // unique per cluster storageID
+  // UUID identifying a given datanode. For upgraded Datanodes this is the
+  // same as the StorageID that was previously used by this Datanode. For
+  // newly formatted Datanodes it is a UUID.
+  private String datanodeUuid = null;
+
-        from.getHostName(),
-        from.getStorageID(),
-        from.getXferPort(),
-        from.getInfoPort(),
-        from.getIpcPort());
+         from.getHostName(),
+         from.getDatanodeUuid(),
+         from.getXferPort(),
+         from.getInfoPort(),
+         from.getIpcPort());
-  
+
-   * @param storageID data storage ID
+   * @param datanodeUuid data node ID, UUID for new Datanodes, may be the
+   *                     storage ID for pre-UUID datanodes. NULL if unknown
+   *                     e.g. if this is a new datanode. A new UUID will
+   *                     be assigned by the namenode.
-  public DatanodeID(String ipAddr, String hostName, String storageID,
-      int xferPort, int infoPort, int ipcPort) {
+  public DatanodeID(String ipAddr, String hostName, String datanodeUuid,
+                    int xferPort, int infoPort, int ipcPort) {
-    this.storageID = storageID;
+    this.datanodeUuid = checkDatanodeUuid(datanodeUuid);
-  public void setStorageID(String storageID) {
-    this.storageID = storageID;
+  /**
+   * @return data node ID.
+   */
+  public String getDatanodeUuid() {
+    return datanodeUuid;
+  }
+
+  public void setDatanodeUuid(String datanodeUuid) {
+    this.datanodeUuid = datanodeUuid;
+  }
+
+  private String checkDatanodeUuid(String uuid) {
+    if (uuid == null || uuid.isEmpty()) {
+      return null;
+    } else {
+      return uuid;
+    }
+  }
+
+  public String generateNewDatanodeUuid() {
+    datanodeUuid = UUID.randomUUID().toString();
+    return datanodeUuid;
-   * @return data storage ID.
-   */
-  public String getStorageID() {
-    return storageID;
-  }
-
-  /**
-            storageID.equals(((DatanodeID)to).getStorageID()));
+        datanodeUuid.equals(((DatanodeID)to).getDatanodeUuid()));
-    return getXferAddr().hashCode()^ storageID.hashCode();
+    return getXferAddr().hashCode()^ datanodeUuid.hashCode();

INS26 MOV23 MOV31 INS40 INS31 INS31 INS29 INS83 MOV43 INS42 INS8 UPD42 INS83 INS43 INS42 INS44 INS8 INS43 UPD42 UPD42 INS33 UPD42 INS65 INS41 UPD42 INS42 INS43 INS42 INS25 INS42 INS21 UPD42 INS66 UPD66 INS66 INS66 INS66 INS42 INS42 INS27 INS8 INS8 INS7 UPD42 UPD42 INS32 UPD42 INS27 INS32 INS41 INS41 INS42 INS32 UPD42 INS42 INS42 UPD42 INS42 INS33 INS42 INS42 INS33 INS42 INS32 INS42 UPD42 INS42 INS42 UPD42 UPD42 DEL42 DEL66 DEL65 DEL29