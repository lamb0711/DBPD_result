HADOOP-10346. Deadlock while logging tokens. Contributed by Jason Lowe


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1569382 13f79535-47bb-0310-9956-ffa450edef68

-  private static synchronized Class<? extends TokenIdentifier>
+  private static Class<? extends TokenIdentifier>
-    if (tokenKindMap == null) {
-      tokenKindMap = Maps.newHashMap();
-      for (TokenIdentifier id : ServiceLoader.load(TokenIdentifier.class)) {
-        tokenKindMap.put(id.getKind(), id.getClass());
+    Class<? extends TokenIdentifier> cls = null;
+    synchronized (Token.class) {
+      if (tokenKindMap == null) {
+        tokenKindMap = Maps.newHashMap();
+        for (TokenIdentifier id : ServiceLoader.load(TokenIdentifier.class)) {
+          tokenKindMap.put(id.getKind(), id.getClass());
+        }
+      cls = tokenKindMap.get(kind);
-    Class<? extends TokenIdentifier> cls = tokenKindMap.get(kind);
-       return null;
+      return null;

INS51 INS57 INS8 INS33 INS43 MOV25 INS21 INS42 INS7 INS42 MOV32 DEL83