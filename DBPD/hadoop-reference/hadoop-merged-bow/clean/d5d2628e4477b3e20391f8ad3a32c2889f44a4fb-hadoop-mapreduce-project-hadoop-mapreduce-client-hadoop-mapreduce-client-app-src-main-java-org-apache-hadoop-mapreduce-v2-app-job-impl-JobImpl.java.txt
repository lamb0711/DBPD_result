Merge r1360400 through r1399945 from trunk.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1399950 13f79535-47bb-0310-9956-ffa450edef68

+      StringBuilder diagsb = new StringBuilder();
+      for (String s : getDiagnostics()) {
+        diagsb.append(s).append("\n");
+      }
+
-            cleanupProgress, jobFile, amInfos, isUber);
+            cleanupProgress, jobFile, amInfos, isUber, diagsb.toString());
-      return MRBuilderUtils.newJobReport(jobId, jobName, username, state,
-          appSubmitTime, startTime, finishTime, setupProgress,
+      JobReport report = MRBuilderUtils.newJobReport(jobId, jobName, username,
+          state, appSubmitTime, startTime, finishTime, setupProgress,
-          cleanupProgress, jobFile, amInfos, isUber);
+          cleanupProgress, jobFile, amInfos, isUber, diagsb.toString());
+      return report;
-        job.logJobHistoryFinishedEvent();
+        job.addDiagnostic("Job commit failed: " + e.getMessage());
+        job.abortJob(org.apache.hadoop.mapreduce.JobStatus.State.FAILED);
-  private void abortJob(
+  protected void abortJob(
-        float failureRate = (float) fetchFailures / runningReduceTasks;
+        float failureRate = runningReduceTasks == 0 ? 1.0f : 
+          (float) fetchFailures / runningReduceTasks;
-  private void addDiagnostic(String diag) {
+  protected void addDiagnostic(String diag) {
-    jobConf.addResource(fc.open(confPath));
+    jobConf.addResource(fc.open(confPath), confPath.toString());

UPD83 UPD83 INS60 INS70 INS60 INS41 INS32 INS43 INS59 INS44 INS32 INS8 INS43 INS59 INS42 INS42 INS42 INS42 INS42 INS14 INS43 INS42 INS42 INS21 INS42 INS42 INS32 INS43 INS42 INS32 MOV42 MOV42 MOV42 MOV42 MOV42 MOV42 MOV42 MOV42 MOV42 MOV42 MOV22 MOV22 MOV42 MOV42 MOV42 MOV42 INS32 INS21 INS16 INS42 INS32 INS42 INS45 INS32 INS42 INS42 INS32 INS27 INS34 MOV27 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS27 UPD42 INS40 INS42 INS34 INS45 INS32 INS42 INS42 DEL32 DEL41