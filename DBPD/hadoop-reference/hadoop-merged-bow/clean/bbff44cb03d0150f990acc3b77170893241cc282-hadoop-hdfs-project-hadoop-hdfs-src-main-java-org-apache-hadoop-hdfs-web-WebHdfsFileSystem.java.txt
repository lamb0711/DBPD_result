HDFS-6776. Using distcp to copy data between insecure and secure cluster via webdhfs doesn't work. (yzhangal via tucu)

+import org.apache.hadoop.fs.CommonConfigurationKeys;
+
+  @VisibleForTesting
+  public static final String CANT_FALLBACK_TO_INSECURE_MSG =
+      "The client is configured to only allow connecting to secure cluster";
+
+  private boolean disallowFallbackToInsecureCluster;
+    this.disallowFallbackToInsecureCluster = !conf.getBoolean(
+        CommonConfigurationKeys.IPC_CLIENT_FALLBACK_TO_SIMPLE_AUTH_ALLOWED_KEY,
+        CommonConfigurationKeys.IPC_CLIENT_FALLBACK_TO_SIMPLE_AUTH_ALLOWED_DEFAULT);
-    token.setService(tokenServiceName);
+    if (token != null) {
+      token.setService(tokenServiceName);
+    } else {
+      if (disallowFallbackToInsecureCluster) {
+        throw new AccessControlException(CANT_FALLBACK_TO_INSECURE_MSG);
+      }
+    }

INS26 INS40 INS23 INS23 INS78 INS83 INS83 INS83 INS43 INS59 INS83 INS39 INS59 INS42 INS42 INS42 INS45 INS42 INS21 INS25 INS7 INS27 INS8 INS8 INS22 INS38 INS42 INS33 MOV21 INS25 INS52 INS42 INS32 INS42 INS8 INS42 INS42 INS40 INS40 INS53 INS14 INS43 INS42 INS42