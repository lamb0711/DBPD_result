HDFS-11194. Maintain aggregated peer performance metrics on NameNode.

+import java.util.HashMap;
+
+import javax.annotation.Nullable;
+
+
+  @Nullable
+
-   * @param windowSize
-   *          The number of seconds of each window for which sub set of samples
-   *          are gathered to compute the rolling average, A.K.A. roll over
-   *          interval.
+   * @param windowSizeMs
+   *          The number of milliseconds of each window for which subset
+   *          of samples are gathered to compute the rolling average, A.K.A.
+   *          roll over interval.
-      final int windowSize,
+      final long windowSizeMs,
-    avgInfoNameTemplate = "%s" + "RollingAvg"+ uvName;
+    avgInfoNameTemplate = "[%s]" + "RollingAvg"+ uvName;
-        windowSize, windowSize, TimeUnit.SECONDS);
+        windowSizeMs, windowSizeMs, TimeUnit.MILLISECONDS);
-   * @param windowSize
+   * @param windowSizeMs
-      final int windowSize,
+      final long windowSizeMs,
-    this(windowSize, numWindows, "Time");
+    this(windowSizeMs, numWindows, "Time");
-  private void rollOverAvgs() {
+  private synchronized void rollOverAvgs() {
+
+  /**
+   * Retrieve a map of metric name -> (aggregate).
+   * Filter out entries that don't have at least minSamples.
+   *
+   * @return a map of peer DataNode Id to the average latency to that
+   *         node seen over the measurement period.
+   */
+  public synchronized Map<String, Double> getStats(long minSamples) {
+    final Map<String, Double> stats = new HashMap<>();
+
+    for (final Entry<String, LinkedBlockingDeque<SumAndCount>> entry
+        : averages.entrySet()) {
+      final String name = entry.getKey();
+      double totalSum = 0;
+      long totalCount = 0;
+
+      for (final SumAndCount sumAndCount : entry.getValue()) {
+        totalCount += sumAndCount.getCount();
+        totalSum += sumAndCount.getSum();
+      }
+
+      if (totalCount > minSamples) {
+        stats.put(name, totalSum / totalCount);
+      }
+    }
+    return stats;
+  }

INS26 INS26 INS40 INS40 INS31 INS78 INS83 INS29 INS83 INS83 INS74 INS42 INS44 INS8 INS42 UPD39 UPD42 UPD39 UPD42 INS65 INS65 INS43 INS43 INS43 INS39 INS42 INS60 INS70 INS41 UPD42 UPD66 UPD66 UPD66 UPD42 UPD42 INS66 INS66 INS66 INS66 INS42 INS42 INS42 INS83 INS74 INS59 INS44 INS32 INS8 INS42 INS43 INS43 INS43 INS42 INS14 INS83 INS74 INS42 INS42 INS42 INS60 INS60 INS60 INS70 INS25 UPD45 UPD42 UPD42 UPD40 INS42 INS42 INS42 INS74 INS43 INS43 INS74 INS83 INS43 INS59 INS39 INS59 INS39 INS59 INS44 INS32 INS8 INS27 INS8 INS43 INS42 INS42 INS43 INS43 INS42 INS42 INS32 INS42 INS34 INS42 INS34 INS83 INS43 INS42 INS42 INS42 INS21 INS21 INS42 INS42 INS21 INS42 INS42 INS42 INS42 INS42 INS42 INS7 INS7 INS32 INS42 INS32 INS42 INS32 INS42 INS42 INS42 INS27 INS42 INS42 INS42 INS42 INS42 INS42