MAPREDUCE-7079: JobHistory#ServiceStop implementation is incorrect. Contributed by  Ahmed Hussein (ahussein)

-  
+
-      boolean interrupted = false;
-      long currentTime = System.currentTimeMillis();
-      while (!scheduledExecutor.isShutdown()
-          && System.currentTimeMillis() > currentTime + 1000l && !interrupted) {
-        try {
-          Thread.sleep(20);
-        } catch (InterruptedException e) {
-          interrupted = true;
+      int retryCnt = 50;
+      try {
+        while (!scheduledExecutor.awaitTermination(20,
+            TimeUnit.MILLISECONDS)) {
+          if (--retryCnt == 0) {
+            scheduledExecutor.shutdownNow();
+            break;
+          }
+        }
+      } catch (InterruptedException iex) {
+        LOG.warn("HistoryCleanerService/move to done shutdown may not have " +
+            "succeeded, Forcing a shutdown", iex);
+        if (!scheduledExecutor.isShutdown()) {
+          scheduledExecutor.shutdownNow();
-      if (!scheduledExecutor.isShutdown()) {
-        LOG.warn("HistoryCleanerService/move to done shutdown may not have " +
-        		"succeeded, Forcing a shutdown");
-        scheduledExecutor.shutdownNow();
-      }
+      scheduledExecutor = null;
+    // Stop the other services.

INS54 MOV21 UPD39 INS8 INS12 UPD42 INS34 INS61 MOV44 MOV8 UPD42 INS33 INS38 INS8 UPD42 INS25 MOV32 INS25 MOV38 INS8 UPD42 INS34 INS40 INS27 INS8 INS42 MOV21 INS38 UPD34 MOV34 MOV21 INS10 INS42 UPD42 UPD42 DEL9 DEL34 DEL9 DEL39 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL38 DEL42 DEL42 DEL32 DEL42 DEL27 DEL27 DEL27 DEL42 DEL38 DEL27 DEL8 DEL8 DEL12 DEL54 DEL8 DEL61 DEL25