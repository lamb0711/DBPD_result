HDFS-2188. Make FSEditLog create its journals from a list of URIs rather than NNStorage. Contributed by Ivan Kelly.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1185354 13f79535-47bb-0310-9956-ffa450edef68

-
+import java.net.URI;
+import java.util.Collections;
+import org.apache.hadoop.conf.Configuration;
+import com.google.common.collect.Lists;
+  final private Collection<URI> editsDirs;
+
+  /**
+   * Construct FSEditLog with default configuration, taking editDirs from NNStorage
+   * @param storage Storage object used by namenode
+   */
+  @VisibleForTesting
+    this(new Configuration(), storage, Collections.<URI>emptyList());
+  }
+
+  /**
+   * Constructor for FSEditLog. Add underlying journals are constructed, but 
+   * no streams are opened until open() is called.
+   * 
+   * @param conf The namenode configuration
+   * @param storage Storage object used by namenode
+   * @param editsDirs List of journals to use
+   */
+  FSEditLog(Configuration conf, NNStorage storage, Collection<URI> editsDirs) {
+    
+    if (editsDirs.isEmpty()) { 
+      // if this is the case, no edit dirs have been explictly configured
+      // image dirs are to be used for edits too
+      try {
+        editsDirs = Lists.newArrayList(storage.getEditsDirectories());
+      } catch (IOException ioe) {
+        // cannot get list from storage, so the empty editsDirs 
+        // will be assigned. an error will be thrown on first use
+        // of the editlog, as no journals will exist
+      }
+      this.editsDirs = editsDirs;
+    } else {
+      this.editsDirs = Lists.newArrayList(editsDirs);
+    }
-    for (StorageDirectory sd : storage.dirIterable(NameNodeDirType.EDITS)) {
-      journalSet.add(new FileJournalManager(sd));
+    for (URI u : this.editsDirs) {
+      StorageDirectory sd = storage.getStorageDirectory(u);
+      if (sd != null) {
+        journalSet.add(new FileJournalManager(sd));
+      }
-    
+ 
-  
+
+  /**
+   * Get the list of URIs the editlog is using for storage
+   * @return collection of URIs in use by the edit log
+   */
+  Collection<URI> getEditURIs() {
+    return editsDirs;
+  }
+

INS26 INS26 INS26 INS26 INS40 INS40 INS40 INS40 INS23 INS31 INS31 INS83 INS83 INS74 INS59 INS29 INS78 INS42 INS44 INS8 INS29 INS44 INS44 INS29 INS74 INS42 INS8 INS43 INS43 INS42 INS65 INS65 INS42 INS43 INS42 INS17 INS65 INS65 INS65 INS65 INS43 INS42 INS74 INS42 INS25 INS65 INS65 INS43 INS43 INS41 INS42 INS42 INS66 INS42 INS66 INS42 INS14 INS42 INS32 INS66 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS42 INS43 INS43 INS32 INS8 INS8 INS44 INS22 INS8 INS66 INS66 INS42 INS42 INS42 INS43 INS42 INS43 INS42 INS42 INS42 INS42 INS42 INS54 INS21 INS21 INS43 INS42 INS52 INS42 INS60 INS25 INS42 INS42 INS8 INS12 INS7 INS7 INS42 MOV43 INS59 INS27 MOV8 INS21 INS44 INS8 INS22 INS42 INS22 INS32 INS42 INS32 INS42 INS33 INS7 INS43 INS42 INS52 INS42 INS52 INS42 INS42 INS42 INS42 MOV42 UPD42 MOV42 INS42 INS42 INS32 INS42 INS42 INS42 INS32 INS42 INS42 DEL42 DEL44 DEL40 DEL32