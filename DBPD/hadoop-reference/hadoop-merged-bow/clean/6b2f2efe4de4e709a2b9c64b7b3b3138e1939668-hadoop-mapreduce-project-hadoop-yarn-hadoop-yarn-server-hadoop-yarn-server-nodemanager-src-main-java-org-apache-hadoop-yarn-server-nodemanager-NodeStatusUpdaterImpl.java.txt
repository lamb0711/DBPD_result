MAPREDUCE-2749. Ensure NM registers with RM after starting all its services correctly. Contributed by Thomas Graves.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1169621 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.yarn.server.security.ContainerTokenSecretManager;
+  private ContainerTokenSecretManager containerTokenSecretManager;
-      NodeHealthCheckerService healthChecker, NodeManagerMetrics metrics) {
+      NodeHealthCheckerService healthChecker, NodeManagerMetrics metrics, 
+      ContainerTokenSecretManager containerTokenSecretManager) {
+    this.containerTokenSecretManager = containerTokenSecretManager;
+    // do this now so that its set before we start heartbeating to RM
+    if (UserGroupInformation.isSecurityEnabled()) {
+      LOG.info("Security enabled - updating secret keys now");
+      // It is expected that status updater is started by this point and
+      // RM gives the shared secret in registration during StatusUpdater#start().
+      this.containerTokenSecretManager.setSecretKey(
+          this.getContainerManagerBindAddress(),
+          this.getRMNMSharedSecret());
+    }
+

INS26 INS40 INS23 INS83 INS43 INS59 INS44 INS42 INS42 INS43 INS42 INS21 INS25 INS42 INS7 INS32 INS8 INS22 INS42 INS42 INS42 INS21 INS21 INS52 INS42 INS32 INS32 INS42 INS42 INS45 INS22 INS42 INS32 INS32 INS52 INS42 INS52 INS42 INS52 INS42