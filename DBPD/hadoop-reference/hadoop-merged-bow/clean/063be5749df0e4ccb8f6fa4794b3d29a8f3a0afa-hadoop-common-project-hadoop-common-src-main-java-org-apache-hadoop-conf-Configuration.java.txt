HADOOP-6502. Improve the performance of Configuration.getClassByName when the class is not found by caching negative results. Contributed by Sharad Agarwal and Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1244620 13f79535-47bb-0310-9956-ffa450edef68

+    Class<?> ret = getClassByNameOrNull(name);
+    if (ret == null) {
+      throw new ClassNotFoundException("Class " + name + " not found");
+    }
+    return ret;
+  }
+  
+  /**
+   * Load a class by name, returning null rather than throwing an exception
+   * if it couldn't be loaded. This is to avoid the overhead of creating
+   * an exception.
+   * 
+   * @param name the class name
+   * @return the class object, or null if it could not be found.
+   */
+  public Class<?> getClassByNameOrNull(String name) {
-    Class<?> clazz = map.get(name);
-    if (clazz == null) {
-      clazz = Class.forName(name, true, classLoader);
-      if (clazz != null) {
-        // two putters can race here, but they'll put the same class
-        map.put(name, clazz);
+    Class<?> clazz = null;
+    if (!map.containsKey(name)) {
+      try {
+        clazz = Class.forName(name, true, classLoader);
+      } catch (ClassNotFoundException e) {
+        map.put(name, null); //cache negative that class is not found
+        return null;
+      }
+      // two putters can race here, but they'll put the same class
+      map.put(name, clazz);
+    } else { // check already performed on this class name
+      clazz = map.get(name);
+      if (clazz == null) { // found the negative
+        return null;

INS31 MOV29 INS83 INS74 INS42 INS44 MOV43 INS8 INS29 UPD42 INS43 INS76 INS43 INS42 INS60 INS25 INS41 INS65 INS65 INS65 INS42 INS42 INS74 INS59 INS27 INS8 INS42 INS66 INS66 INS66 INS42 INS66 INS66 INS38 INS8 INS8 INS43 INS76 INS42 INS32 INS42 INS33 INS53 INS33 INS32 INS54 MOV21 INS21 INS25 INS42 INS42 INS42 INS14 INS42 INS42 INS42 MOV8 INS12 INS7 MOV27 INS8 INS43 INS27 INS44 INS8 INS42 MOV32 INS41 INS42 INS45 INS42 INS45 INS43 INS42 INS21 INS41 INS33 INS42 INS32 INS33 INS42 INS42 INS42 INS33 DEL42 DEL33 DEL27 DEL8 DEL25