Hadoop 16857. ABFS: Stop CustomTokenProvider retry logic to depend on AbfsRestOp retry policy

Contributed by Sneha Vijayarajan
+import org.apache.hadoop.fs.azurebfs.oauth2.AzureADAuthenticator.HttpException;
+  private final int fetchTokenRetryCount;
+   * @param customTokenFetchRetryCount max retry count for customTokenFetch
-  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee) {
+  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee, int customTokenFetchRetryCount) {
+    fetchTokenRetryCount = customTokenFetchRetryCount;
-    azureADToken.setAccessToken(adaptee.getAccessToken());
+
+    String accessToken = null;
+
+    Exception ex;
+    boolean succeeded = false;
+    // Custom token providers should have their own retry policies,
+    // Providing a linear retry option for the the retry count
+    // mentioned in config "fs.azure.custom.token.fetch.retry.count"
+    int retryCount = fetchTokenRetryCount;
+    do {
+      ex = null;
+      try {
+        accessToken = adaptee.getAccessToken();
+        LOG.trace("CustomTokenProvider Access token fetch was successful with retry count {}",
+            (fetchTokenRetryCount - retryCount));
+      } catch (Exception e) {
+        LOG.debug("CustomTokenProvider Access token fetch failed with retry count {}",
+            (fetchTokenRetryCount - retryCount));
+        ex = e;
+      }
+
+      succeeded = (ex == null);
+      retryCount--;
+    } while (!succeeded && (retryCount) >= 0);
+
+    if (!succeeded) {
+      HttpException httpEx = new HttpException(
+          -1,
+          "",
+          String.format("CustomTokenProvider getAccessToken threw %s : %s",
+              ex.getClass().getTypeName(), ex.getMessage()),
+          "",
+          "",
+          ""
+      );
+      throw httpEx;
+    }
+
+    azureADToken.setAccessToken(accessToken);

INS26 INS40 INS23 INS83 INS83 INS39 INS59 INS44 INS8 INS42 INS65 INS39 INS42 INS21 MOV21 MOV60 INS60 INS60 INS60 INS60 INS19 INS25 INS21 MOV21 MOV41 INS42 INS66 INS7 INS43 INS59 INS43 INS59 INS39 INS59 INS39 INS59 INS8 INS27 INS38 INS8 INS32 INS42 INS42 INS42 INS42 INS33 INS42 INS42 INS42 INS9 INS42 INS42 INS21 INS54 INS21 INS21 INS38 INS27 INS42 INS60 INS53 INS42 INS42 INS42 INS7 INS8 INS12 INS7 INS37 INS42 INS36 INS34 INS43 INS59 INS42 INS42 INS33 MOV21 INS21 INS44 INS8 INS42 INS36 INS42 INS42 INS42 INS42 INS14 INS7 INS32 INS43 INS42 INS21 INS21 INS27 INS43 INS38 INS45 INS32 INS45 INS45 INS45 INS42 MOV32 INS42 INS42 INS45 INS36 INS42 INS32 INS7 INS42 INS33 INS42 INS34 INS42 INS42 INS45 INS32 INS32 INS27 INS42 INS42 INS45 INS36 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS27 INS42 INS42 INS42 INS42 DEL42 DEL42 DEL32 DEL8