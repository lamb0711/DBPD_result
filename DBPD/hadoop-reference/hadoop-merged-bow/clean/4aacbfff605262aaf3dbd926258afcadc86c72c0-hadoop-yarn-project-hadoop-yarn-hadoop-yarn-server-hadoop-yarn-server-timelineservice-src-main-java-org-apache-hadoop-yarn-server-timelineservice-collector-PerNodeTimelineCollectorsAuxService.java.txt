YARN-8679. [ATSv2] If HBase cluster is down for long time, high chances that NM ContainerManager dispatcher get blocked. Contributed by Wangda Tan.

-  public boolean addApplication(ApplicationId appId, String user) {
+  public boolean addApplicationIfAbsent(ApplicationId appId, String user) {
-      synchronized (appIdToContainerId) {
+      synchronized (appIdToContainerId){
-        addApplication(appId, context.getUser());
+      addApplicationIfAbsent(appId, context.getUser());
+        boolean shouldRemoveApplication = false;
-            removeApplication(appId);
+            shouldRemoveApplication = true;
+
+        if (shouldRemoveApplication) {
+          removeApplication(appId);
+        }

UPD42 MOV21 UPD42 INS60 INS25 INS39 INS59 INS42 MOV8 INS42 INS9 INS8 INS21 MOV21 INS7 INS42 INS9