HDDS-726. Ozone Client should update SCM to move the container out of allocation path in case a write transaction fails. Contributed by Shashikant Banerjee.

+import org.apache.hadoop.hdds.scm.container.ContainerID;
+import org.apache.hadoop.hdds.scm.container.common.helpers.ExcludeList;
+import java.util.function.Predicate;
+
+   * @param excludeList List of datanodes/containers to exclude during block
+   *                    allocation.
-  public AllocatedBlock allocateBlock(final long size,
-      ReplicationType type, ReplicationFactor factor, String owner)
+  public AllocatedBlock allocateBlock(final long size, ReplicationType type,
+      ReplicationFactor factor, String owner, ExcludeList excludeList)
-      List<Pipeline> availablePipelines = pipelineManager
-          .getPipelines(type, factor, Pipeline.PipelineState.OPEN);
+      List<Pipeline> availablePipelines =
+          pipelineManager
+              .getPipelines(type, factor, Pipeline.PipelineState.OPEN,
+                  excludeList.getDatanodes(), excludeList.getPipelineIds());
-      if (containerInfo != null) {
+
+      // TODO: if getMachingContainer results in containers which are in exclude
+      // list, we may end up in this loop forever. This case needs to be
+      // addressed.
+      if (containerInfo != null && (excludeList.getContainerIds() == null
+          || !discardContainer(containerInfo.containerID(),
+          excludeList.getContainerIds()))) {
+  private boolean discardContainer(ContainerID containerId,
+      List<ContainerID> containers) {
+    Predicate<ContainerID> predicate = p -> p.equals(containerId);
+    return containers.parallelStream().anyMatch(predicate);
+  }

INS26 INS26 INS26 INS40 INS40 INS40 INS31 INS44 INS83 INS39 INS42 INS44 INS44 INS8 INS65 INS43 INS42 INS43 INS42 INS74 INS42 INS60 INS41 INS42 INS66 INS66 INS42 INS42 INS43 INS43 INS74 INS59 INS32 INS42 INS42 INS43 INS43 INS42 INS86 INS32 INS42 INS42 INS27 INS42 INS42 INS59 INS32 INS42 INS42 MOV27 INS36 INS42 INS42 INS42 INS42 INS32 INS32 INS27 INS42 INS42 INS42 INS42 INS27 INS38 INS32 INS33 INS32 INS42 INS42 INS42 INS32 INS32 INS42 INS42 INS42 INS42