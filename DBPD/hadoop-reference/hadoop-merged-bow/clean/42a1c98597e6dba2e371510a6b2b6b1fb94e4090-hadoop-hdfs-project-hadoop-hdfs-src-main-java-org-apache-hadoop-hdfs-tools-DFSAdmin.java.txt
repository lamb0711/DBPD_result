HDFS-11847. Enhance dfsadmin listOpenFiles command to list files blocking datanode decommissioning.

+import java.util.EnumSet;
+import org.apache.hadoop.hdfs.protocol.OpenFilesIterator.OpenFilesType;
-    "\t[-listOpenFiles]\n" +
+    "\t[-listOpenFiles [-blockingDecommission]]\n" +
+   * @param argv
-  public int listOpenFiles() throws IOException {
+  public int listOpenFiles(String[] argv) throws IOException {
+    List<OpenFilesType> types = new ArrayList<>();
+    if (argv != null) {
+      List<String> args = new ArrayList<>(Arrays.asList(argv));
+      if (StringUtils.popOption("-blockingDecommission", args)) {
+        types.add(OpenFilesType.BLOCKING_DECOMMISSION);
+      }
+    }
+    if (types.isEmpty()) {
+      types.add(OpenFilesType.ALL_OPEN_FILES);
+    }
+    EnumSet<OpenFilesType> openFilesTypes = EnumSet.copyOf(types);
+
-          FsTracer.get(dfsConf));
+          FsTracer.get(dfsConf), openFilesTypes);
-      openFilesRemoteIterator = dfs.listOpenFiles();
+      openFilesRemoteIterator = dfs.listOpenFiles(openFilesTypes);
-    String listOpenFiles = "-listOpenFiles\n"
+    String listOpenFiles = "-listOpenFiles [-blockingDecommission]\n"
-        + "\twith client name and client machine accessing them.\n";
+        + "\twith client name and client machine accessing them.\n"
+        + "\tIf 'blockingDecommission' option is specified, it will list the\n"
+        + "\topen files only that are blocking the ongoing Decommission.";
-      System.err.println("Usage: hdfs dfsadmin [-listOpenFiles]");
+      System.err.println("Usage: hdfs dfsadmin"
+          + " [-listOpenFiles [-blockingDecommission]]");
-      if (argv.length != 1) {
+      if ((argv.length != 1) && (argv.length != 2)) {
-        exitCode = listOpenFiles();
+        exitCode = listOpenFiles(argv);

INS26 INS26 INS40 INS40 INS44 INS65 INS5 INS42 INS60 INS25 INS25 INS60 MOV25 UPD45 INS42 INS43 INS85 INS74 INS59 INS27 INS8 INS32 INS8 INS74 INS59 MOV32 MOV8 INS42 INS43 INS43 INS42 INS14 INS42 INS33 INS60 INS25 INS42 INS42 INS21 INS43 INS43 INS42 INS32 MOV32 MOV8 INS42 INS42 INS74 INS74 INS59 INS32 INS8 INS32 INS42 INS42 INS42 INS42 INS42 UPD45 INS45 INS45 MOV32 MOV8 INS43 INS43 INS43 INS42 INS14 INS42 INS42 INS45 INS42 INS21 INS42 INS42 INS40 MOV32 MOV8 INS42 INS42 INS42 INS74 INS32 INS32 INS42 INS42 MOV32 MOV8 INS43 INS42 INS42 INS42 INS42 INS42 INS40 MOV32 MOV8 INS42 MOV32 MOV8 MOV32 MOV8 MOV32 MOV8 MOV32 MOV8 MOV32 MOV8 MOV32 MOV8 MOV32 MOV8 MOV32 MOV8 MOV32 MOV8 MOV32 MOV8 MOV32 MOV8 MOV32 MOV8 MOV32 MOV8 MOV32 MOV8 INS25 MOV32 MOV8 INS25 MOV32 MOV8 MOV25 MOV8 MOV8 MOV8 INS27 INS36 INS36 INS27 INS27 MOV40 MOV34 INS40 INS34 INS27 INS45 INS45 INS42 DEL45 DEL27 DEL25 DEL25