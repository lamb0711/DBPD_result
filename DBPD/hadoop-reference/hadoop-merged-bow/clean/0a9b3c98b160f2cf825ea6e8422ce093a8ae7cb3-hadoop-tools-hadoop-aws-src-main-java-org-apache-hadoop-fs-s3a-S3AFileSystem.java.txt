HADOOP-15430. hadoop fs -mkdir -p path-ending-with-slash/ fails with s3guard (#1646)


Contributed by Steve Loughran

* move qualify logic to S3AFileSystem.makeQualified()
* make S3AFileSystem.qualify() a private redirect to that
* ITestS3GuardFsShell turned off

+   * This includes fixing up the URI so that if it ends with a trailing slash,
+   * that is corrected, similar to {@code Path.normalizePath()}.
+  @Override
+  public Path makeQualified(final Path path) {
+    Path q = super.makeQualified(path);
+    if (!q.isRoot()) {
+      String urlString = q.toUri().toString();
+      if (urlString.endsWith(Path.SEPARATOR)) {
+        // this is a path which needs root stripping off to avoid
+        // confusion, See HADOOP-15430
+        LOG.debug("Stripping trailing '/' from {}", q);
+        // deal with an empty "/" at the end by mapping to the parent and
+        // creating a new path from it
+        q = new Path(urlString.substring(0, urlString.length() - 1));
+      }
+    }
+    if (!q.isRoot() && q.getName().isEmpty()) {
+      q = q.getParent();
+    }
+    return q;
+  }
+
+   * This includes fixing up the URI so that if it ends with a trailing slash,
+   * that is corrected, similar to {@code Path.normalizePath()}.
-    return path.makeQualified(uri, workingDir);
+    return makeQualified(path);

INS31 INS78 INS83 INS43 INS42 INS44 INS8 INS42 INS42 INS83 INS43 INS42 INS60 INS25 INS25 INS41 INS66 INS66 INS65 INS66 INS42 INS43 INS59 INS38 INS8 INS27 INS8 INS42 INS66 INS66 INS65 INS66 INS66 INS42 INS42 INS48 INS32 INS60 INS25 INS38 INS32 INS21 INS66 UPD42 INS42 INS42 INS42 INS42 INS43 INS59 INS32 INS8 INS32 INS32 INS42 INS7 INS42 INS42 INS32 INS42 INS42 INS40 INS21 INS21 INS42 INS42 INS42 INS42 INS42 INS32 INS32 INS42 INS32 INS7 INS42 INS42 INS42 INS42 INS42 INS42 INS45 INS42 INS42 INS14 INS43 INS32 INS42 INS42 INS42 INS34 INS27 INS32 INS34 INS42 INS42 DEL42 DEL42