HADOOP-16801. S3Guard listFiles will not query S3 if all listings are authoritative (#1815). Contributed by Mustafa Ä°man.


+  private final boolean recursivelyAuthoritative;
-    prefetch(meta);
+    this.recursivelyAuthoritative = prefetch(meta);
-  private void prefetch(PathMetadata meta) throws IOException {
+  /**
+   * Walks the listing tree, starting from given metadata path. All
+   * encountered files and empty directories are added to
+   * {@link leafNodesIterator} unless a directory seems to be empty
+   * and at least one of the following conditions hold:
+   * <ul>
+   *   <li>
+   *     The directory listing is not marked authoritative
+   *   </li>
+   *   <li>
+   *     Authoritative mode is not allowed
+   *   </li>
+   * </ul>
+   * @param meta starting point for tree walk
+   * @return {@code true} if all encountered directory listings
+   *          are marked as authoritative
+   * @throws IOException
+   */
+  private boolean prefetch(PathMetadata meta) throws IOException {
+    boolean allListingsAuthoritative = true;
+          if (!rootListing.isAuthoritative()) {
+            allListingsAuthoritative = false;
+          }
+    } else {
+      allListingsAuthoritative = false;
+          if (!children.isAuthoritative()) {
+            allListingsAuthoritative = false;
+          }
+        } else {
+          // we do not have a listing, so directory definitely non-authoritative
+          allListingsAuthoritative = false;
+    return allListingsAuthoritative;
+  public boolean isRecursivelyAuthoritative() {
+    return recursivelyAuthoritative;
+  }
+

INS23 INS31 INS83 INS83 INS39 INS59 INS29 UPD39 INS83 INS39 INS42 INS8 INS42 INS65 INS65 INS65 INS65 INS60 INS41 INS41 INS7 INS66 INS66 INS65 INS66 INS66 INS66 INS66 INS66 INS66 INS66 INS66 INS66 INS66 INS42 INS66 INS66 INS65 INS66 INS66 INS42 INS39 INS59 INS8 INS42 INS42 INS22 MOV32 INS42 INS66 INS42 INS9 INS21 INS52 INS42 INS7 INS42 INS9 INS8 INS25 INS25 INS21 INS38 INS8 INS38 INS8 INS7 INS32 INS21 INS32 INS21 INS42 INS9 INS42 INS42 INS7 INS42 INS42 INS7 INS42 INS9 INS42 INS9