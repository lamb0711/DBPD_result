YARN-4066. Large number of queues choke fair scheduler. (Johan Gustavsson via kasha)

-    FSQueue queue = getQueue(name, create, FSQueueType.LEAF);
+    return getLeafQueue(name, create, true);
+  }
+
+  public FSLeafQueue getLeafQueue(
+      String name,
+      boolean create,
+      boolean recomputeSteadyShares) {
+    FSQueue queue = getQueue(
+        name,
+        create,
+        FSQueueType.LEAF,
+        recomputeSteadyShares
+    );
-    FSQueue queue = getQueue(name, create, FSQueueType.PARENT);
+    return getParentQueue(name, create, true);
+  }
+
+  public FSParentQueue getParentQueue(
+      String name,
+      boolean create,
+      boolean recomputeSteadyShares) {
+    FSQueue queue = getQueue(
+        name,
+        create,
+        FSQueueType.PARENT,
+        recomputeSteadyShares
+    );
-  
-  private FSQueue getQueue(String name, boolean create, FSQueueType queueType) {
+
+  private FSQueue getQueue(
+      String name,
+      boolean create,
+      FSQueueType queueType,
+      boolean recomputeSteadyShares) {
+    boolean recompute = recomputeSteadyShares;
+    FSQueue queue;
-      FSQueue queue = queues.get(name);
+      queue = queues.get(name);
-
-        // Update steady fair share for all queues
-        if (queue != null) {
-          rootQueue.recomputeSteadyShares();
-        }
+      } else {
+        recompute = false;
-      return queue;
+    if (recompute) {
+      rootQueue.recomputeSteadyShares();
+    }
+    return queue;
-    for (String name : queueConf.getConfiguredQueues().get(FSQueueType.LEAF)) {
-      if (removeEmptyIncompatibleQueues(name, FSQueueType.LEAF)) {
-        getLeafQueue(name, true);
+    synchronized (queues) {
+      for (String name : queueConf.getConfiguredQueues().get(
+              FSQueueType.LEAF)) {
+        if (removeEmptyIncompatibleQueues(name, FSQueueType.LEAF)) {
+          getLeafQueue(name, true, false);
+        }
+      }
+      // At this point all leaves and 'parents with
+      // at least one child' would have been created.
+      // Now create parents with no configured leaf.
+      for (String name : queueConf.getConfiguredQueues().get(
+          FSQueueType.PARENT)) {
+        if (removeEmptyIncompatibleQueues(name, FSQueueType.PARENT)) {
+          getParentQueue(name, true, false);
+        }
+    rootQueue.recomputeSteadyShares();
-    // At this point all leaves and 'parents with at least one child' would have been created.
-    // Now create parents with no configured leaf.
-    for (String name : queueConf.getConfiguredQueues().get(
-        FSQueueType.PARENT)) {
-      if (removeEmptyIncompatibleQueues(name, FSQueueType.PARENT)) {
-        getParentQueue(name, true);
-      }
-    }
-    

INS31 INS31 MOV29 INS83 INS43 INS42 INS44 INS44 INS8 INS44 MOV29 INS83 INS43 INS42 INS44 INS44 INS8 INS44 INS44 INS42 INS43 INS42 INS39 INS42 INS41 INS39 INS42 INS42 INS43 INS42 INS39 INS42 INS41 INS39 INS42 INS39 INS42 INS60 INS60 MOV25 MOV41 INS51 INS21 INS42 INS32 INS42 INS32 MOV43 INS39 INS59 MOV43 INS59 INS42 INS42 INS8 INS32 INS42 INS42 INS42 INS9 INS42 INS42 INS42 INS9 INS42 INS42 INS42 INS21 MOV70 MOV70 INS42 INS42 INS42 INS42 INS7 INS8 INS42 MOV32 INS21 INS7 INS42 INS9 INS9 INS9 DEL42 DEL59 DEL60 DEL42 DEL33 DEL27