HDFS-4686. Update quota computation for rename and INodeReference.  Contributed by Jing Zhao


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1471647 13f79535-47bb-0310-9956-ffa450edef68

+    Quota.Counts oldSrcCounts = Quota.Counts.newInstance();
-          .replaceChild4ReferenceWithName(srcChild); 
+          .replaceChild4ReferenceWithName(srcChild, srcIIP.getLatestSnapshot()); 
+      // get the counts before rename
+      withCount.getReferredINode().computeQuotaUsage(oldSrcCounts, true,
+          Snapshot.INVALID_ID);
-        withCount.setParentReference(ref);
-        withCount.incrementReferenceCount();
-        getFSNamesystem().unprotectedChangeLease(src, dst);        
+        getFSNamesystem().unprotectedChangeLease(src, dst);     
+        // update the quota usage in src tree
+        if (isSrcInSnapshot) {
+          // get the counts after rename
+          Quota.Counts newSrcCounts = srcChild.computeQuotaUsage(
+              Quota.Counts.newInstance(), false, Snapshot.INVALID_ID);
+          newSrcCounts.subtract(oldSrcCounts);
+          srcParent.addSpaceConsumed(newSrcCounts.get(Quota.NAMESPACE),
+              newSrcCounts.get(Quota.DISKSPACE), false, Snapshot.INVALID_ID);
+        }
+        
+          // the withCount node will no longer be used thus no need to update
+          // its reference number here
+          withCount.removeReference(oldSrcChild.asReference());
-          withCount.setParentReference(originalRef);
+          // srcParent must be an INodeDirectoryWithSnapshot instance since
+          // isSrcInSnapshot is true and src node has been removed from 
+          // srcParent 
+    Quota.Counts oldSrcCounts = Quota.Counts.newInstance();    
-          .replaceChild4ReferenceWithName(srcChild); 
+          .replaceChild4ReferenceWithName(srcChild, srcIIP.getLatestSnapshot()); 
+      // get the counts before rename
+      withCount.getReferredINode().computeQuotaUsage(oldSrcCounts, true,
+          Snapshot.INVALID_ID);
-        withCount.setParentReference(ref);
-        withCount.incrementReferenceCount();
+        
+        // update the quota usage in src tree
+        if (isSrcInSnapshot) {
+          // get the counts after rename
+          Quota.Counts newSrcCounts = srcChild.computeQuotaUsage(
+              Quota.Counts.newInstance(), false, Snapshot.INVALID_ID);
+          newSrcCounts.subtract(oldSrcCounts);
+          srcParent.addSpaceConsumed(newSrcCounts.get(Quota.NAMESPACE),
+              newSrcCounts.get(Quota.DISKSPACE), false, Snapshot.INVALID_ID);
+        }
+        
+          // the withCount node will no longer be used thus no need to update
+          // its reference number here
+          withCount.removeReference(oldSrcChild.asReference());
-          withCount.setParentReference(originalRef);
+        if (removedDst.isReference()) {
+          final INodeReference removedDstRef = removedDst.asReference();
+          final INodeReference.WithCount wc = 
+              (WithCount) removedDstRef.getReferredINode().asReference();
+          wc.addReference(removedDstRef);
+        }
-          -counts.get(Quota.DISKSPACE), true);
+          -counts.get(Quota.DISKSPACE), true, Snapshot.INVALID_ID);
-      public Counts computeQuotaUsage(Counts counts, boolean useCache) {
+      public Counts computeQuotaUsage(Counts counts, boolean useCache,
+          int lastSnapshotId) {

INS60 INS60 INS43 INS59 INS43 INS59 INS40 INS42 INS32 INS21 INS40 INS42 INS32 INS21 INS40 INS42 INS32 INS40 INS42 INS32 INS32 INS42 INS42 INS9 INS40 INS25 INS32 INS42 INS42 INS9 INS40 INS25 INS25 INS40 INS32 INS42 INS42 INS42 INS8 INS32 INS42 INS42 INS42 INS8 INS32 INS8 INS44 INS42 INS42 INS60 INS21 INS21 MOV60 INS42 INS42 INS60 INS21 INS21 MOV60 INS42 INS42 INS60 INS60 INS21 INS39 INS42 INS43 INS59 INS32 INS32 INS43 INS59 INS32 INS32 INS83 INS43 INS59 INS83 INS43 INS59 INS32 INS40 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS32 INS32 INS9 INS40 INS40 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS32 INS32 INS9 INS40 INS42 INS42 INS32 INS40 INS42 INS11 INS42 INS42 INS42 INS42 INS42 INS32 INS9 INS40 INS42 INS42 INS40 INS42 INS42 INS40 UPD42 INS32 INS42 INS42 INS32 INS9 INS40 INS42 INS42 INS40 INS42 INS42 INS40 UPD42 INS32 INS42 INS42 INS43 INS32 INS40 INS42 UPD42 MOV42 INS42 INS40 INS42 UPD42 MOV42 INS42 INS42 INS32 INS42 INS42 INS42 DEL42 DEL42 DEL42 DEL32 DEL21 DEL42 DEL42 DEL32 DEL21 DEL42 DEL42 DEL42 DEL32 DEL21 DEL42 DEL42 DEL32 DEL21