HDFS-9516. Truncate file fails with data dirs on multiple disks. Contributed by Plamen Jeliazkov.

+        FsVolumeSpi volume = rur.getVolume();
+        String blockPath = blockFile.getAbsolutePath();
+        String volumePath = volume.getBasePath();
+        assert blockPath.startsWith(volumePath) :
+            "New block file: " + blockPath + " must be on " +
+                "same volume as recovery replica: " + volumePath;
-            newBlockId, recoveryId, rur.getVolume(), blockFile.getParentFile(),
+            newBlockId, recoveryId, volume, blockFile.getParentFile(),
-    try (FsVolumeReference ref = volumes.getNextVolume(
-        replicaInfo.getVolume().getStorageType(), replicaInfo.getNumBytes())) {
-      FsVolumeImpl v = (FsVolumeImpl) ref.getVolume();
-      final File tmpDir = v.getBlockPoolSlice(bpid).getTmpDir();
-      final File destDir = DatanodeUtil.idToBlockDir(tmpDir, newBlkId);
-      final File dstBlockFile = new File(destDir, blockFileName);
-      final File dstMetaFile = FsDatasetUtil.getMetaFile(dstBlockFile, newGS);
-      return copyBlockFiles(replicaInfo.getMetaFile(),
-          replicaInfo.getBlockFile(),
-          dstMetaFile, dstBlockFile, true, smallBufferSize, conf);
-    }
+    FsVolumeImpl v = (FsVolumeImpl) replicaInfo.getVolume();
+    final File tmpDir = v.getBlockPoolSlice(bpid).getTmpDir();
+    final File destDir = DatanodeUtil.idToBlockDir(tmpDir, newBlkId);
+    final File dstBlockFile = new File(destDir, blockFileName);
+    final File dstMetaFile = FsDatasetUtil.getMetaFile(dstBlockFile, newGS);
+    return copyBlockFiles(replicaInfo.getMetaFile(),
+        replicaInfo.getBlockFile(),
+        dstMetaFile, dstBlockFile, true, smallBufferSize, conf);

MOV8 MOV60 MOV43 MOV43 MOV32 INS60 INS60 INS60 INS6 INS43 INS59 INS43 INS59 INS43 INS59 INS32 INS27 INS42 INS42 MOV32 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS42 INS45 INS42 INS45 INS45 INS42 INS42 INS42 INS42 INS42 INS42 DEL42 DEL42 DEL32 DEL42 DEL43 DEL42 DEL42 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL32 DEL59 DEL58 DEL54 DEL8