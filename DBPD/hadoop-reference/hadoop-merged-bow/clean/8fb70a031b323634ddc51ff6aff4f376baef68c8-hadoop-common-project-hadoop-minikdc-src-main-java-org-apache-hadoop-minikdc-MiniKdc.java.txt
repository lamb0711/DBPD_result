HADOOP-12656. MiniKdc throws "address in use" BindException. (Contributed by Wei-Chiu Chuang)

+import org.apache.directory.server.protocol.shared.transport.AbstractTransport;
-import java.net.InetAddress;
-import java.net.ServerSocket;
+import java.net.InetSocketAddress;
-    if (port == 0) {
-      ServerSocket ss = new ServerSocket(0, 1, InetAddress.getByName
-              (conf.getProperty(KDC_BIND_ADDRESS)));
-      port = ss.getLocalPort();
-      ss.close();
-    }
+    AbstractTransport absTransport;
-      kdc.addTransports(new TcpTransport(bindAddress, port, 3, 50));
+      absTransport = new TcpTransport(bindAddress, port, 3, 50);
-      kdc.addTransports(new UdpTransport(port));
+      absTransport = new UdpTransport(port);
+    kdc.addTransports(absTransport);
+    // if using ephemeral port, update port number for binding
+    if (port == 0) {
+      InetSocketAddress addr =
+          (InetSocketAddress)absTransport.getAcceptor().getLocalAddress();
+      port = addr.getPort();
+    }

MOV26 UPD40 UPD40 INS60 INS21 INS25 INS43 INS59 INS32 MOV27 INS8 INS42 INS42 INS42 INS42 INS42 INS60 INS21 INS7 INS43 INS59 INS7 INS42 MOV14 INS7 INS42 INS42 INS11 INS42 INS32 INS42 MOV14 INS43 INS32 INS42 INS42 INS42 INS32 INS42 INS42 INS42 DEL42 DEL43 DEL42 DEL42 DEL43 DEL34 DEL34 DEL42 DEL42 DEL42 DEL42 DEL42 DEL32 DEL32 DEL14 DEL59 DEL60 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL42 DEL42 DEL32 DEL21 DEL8 DEL25 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32