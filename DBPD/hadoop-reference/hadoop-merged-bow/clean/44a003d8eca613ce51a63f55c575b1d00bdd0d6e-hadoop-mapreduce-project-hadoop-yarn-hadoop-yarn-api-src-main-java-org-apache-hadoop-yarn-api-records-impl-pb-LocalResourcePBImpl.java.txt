MAPREDUCE-3931. Changed PB implementation of LocalResource to take locks so that race conditions don't fail tasks by inadvertantly changing the timestamps. Contributed by Siddarth Seth.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1294970 13f79535-47bb-0310-9956-ffa450edef68

-public class LocalResourcePBImpl extends ProtoBase<LocalResourceProto> implements LocalResource {
+public class LocalResourcePBImpl extends ProtoBase<LocalResourceProto>
+    implements LocalResource {
-  
+
-  
-  
+
-  
-  public LocalResourceProto getProto() {
-    mergeLocalToProto();
+
+  public synchronized LocalResourceProto getProto() {
+    mergeLocalToBuilder();
-  private void mergeLocalToBuilder() {
-    if (this.url != null) {
+  private synchronized void mergeLocalToBuilder() {
+    LocalResourceProtoOrBuilder l = viaProto ? proto : builder;
+    if (this.url != null
+        && !(l.getResource().equals(((URLPBImpl) url).getProto()))) {
+      maybeInitBuilder();
+      l = builder;
-  private void mergeLocalToProto() {
-    if (viaProto) 
-      maybeInitBuilder();
-    mergeLocalToBuilder();
-    proto = builder.build();
-    viaProto = true;
-  }
-
-  private void maybeInitBuilder() {
+  private synchronized void maybeInitBuilder() {
-    
-  
+
-  public long getSize() {
+  public synchronized long getSize() {
-  public void setSize(long size) {
+  public synchronized void setSize(long size) {
-  public long getTimestamp() {
+  public synchronized long getTimestamp() {
-  public void setTimestamp(long timestamp) {
+  public synchronized void setTimestamp(long timestamp) {
-  public LocalResourceType getType() {
+  public synchronized LocalResourceType getType() {
-  public void setType(LocalResourceType type) {
+  public synchronized void setType(LocalResourceType type) {
-  public URL getResource() {
+  public synchronized URL getResource() {
-  public void setResource(URL resource) {
+  public synchronized void setResource(URL resource) {
-  public LocalResourceVisibility getVisibility() {
+  public synchronized LocalResourceVisibility getVisibility() {
-  public void setVisibility(LocalResourceVisibility visibility) {
+  public synchronized void setVisibility(LocalResourceVisibility visibility) {
-
-
-

INS83 INS83 INS83 INS83 INS83 INS83 INS83 INS83 INS83 INS83 INS83 INS83 INS83 MOV21 INS60 MOV32 INS43 INS59 INS27 MOV42 INS42 INS42 INS16 MOV27 INS38 MOV21 INS21 INS42 INS42 INS42 INS36 INS7 INS32 INS42 INS42 INS32 INS42 INS32 INS42 INS42 INS36 INS42 INS11 INS43 INS42 INS42 DEL83 DEL39 DEL42 DEL42 DEL25 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL42 DEL9 DEL7 DEL21 DEL8 DEL31