HDDS-708. Validate BCSID while reading blocks from containers in datanodes. Contributed by Shashikant Banerjee.

-
+import static org.apache.hadoop.hdds.protocol.datanode.proto.ContainerProtos.Result.UNKNOWN_BCSID;
+import static org.apache.hadoop.hdds.protocol.datanode.proto.ContainerProtos.Result.BCSID_MISMATCH;
-    long blockCommitSequenceId = data.getBlockCommitSequenceId();
-    byte[] blockCommitSequenceIdValue = db.get(blockCommitSequenceIdKey);
+    long bcsId = data.getBlockCommitSequenceId();
+    long containerBCSId = ((KeyValueContainerData) container.getContainerData())
+        .getBlockCommitSequenceId();
-    if (blockCommitSequenceIdValue != null && blockCommitSequenceId != 0) {
-      if (blockCommitSequenceId <= Longs
-          .fromByteArray(blockCommitSequenceIdValue)) {
+    if (bcsId != 0) {
+      if (bcsId <= containerBCSId) {
-        LOG.warn("blockCommitSequenceId " + Longs
-            .fromByteArray(blockCommitSequenceIdValue)
+        LOG.warn("blockCommitSequenceId " + containerBCSId
-            + blockCommitSequenceId + " .Ignoring it");
+            + bcsId + " .Ignoring it");
-        Longs.toByteArray(blockCommitSequenceId));
+        Longs.toByteArray(bcsId));
-    container.updateBlockCommitSequenceId(blockCommitSequenceId);
+    container.updateBlockCommitSequenceId(bcsId);
+   * @param bcsId latest commit Id of the block
-  public BlockData getBlock(Container container, BlockID blockID)
+  @Override
+  public BlockData getBlock(Container container, BlockID blockID, long bcsId)
+
+    long containerBCSId = containerData.getBlockCommitSequenceId();
+    if (containerBCSId < bcsId) {
+      throw new StorageContainerException(
+          "Unable to find the block with bcsID " + bcsId + " .Container "
+              + container.getContainerData().getContainerID() + " bcsId is "
+              + containerBCSId + ".", UNKNOWN_BCSID);
+    }
+    long id = blockData.getBlockCommitSequenceId();
+    if (id < bcsId) {
+      throw new StorageContainerException(
+          "bcsId " + bcsId + " mismatches with existing block Id "
+              + id + " for block " + blockID + ".", BCSID_MISMATCH);
+    }

INS26 INS26 INS40 INS40 INS78 INS44 INS65 INS42 INS39 INS42 INS60 INS25 INS60 INS25 INS39 INS27 INS42 INS66 INS39 INS59 INS27 INS8 INS39 INS59 INS27 INS8 UPD42 UPD42 UPD42 MOV42 MOV34 UPD42 INS42 INS32 INS42 INS42 INS53 INS42 INS32 INS42 INS42 INS53 INS36 UPD42 UPD42 INS42 INS42 INS14 INS42 INS42 INS14 INS11 UPD42 INS42 INS43 INS27 INS42 INS43 INS27 INS42 INS43 INS32 INS42 INS45 INS42 INS45 INS32 INS45 INS42 INS45 INS42 INS45 INS42 INS45 INS42 INS45 INS42 INS45 INS42 INS42 UPD42 MOV42 INS32 INS42 INS42 UPD42 INS42 INS42 DEL39 DEL85 DEL5 DEL42 DEL42 DEL33 DEL27 DEL27 DEL27 DEL42 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32