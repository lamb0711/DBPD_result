MAPREDUCE-3871. Allow symlinking in LocalJobRunner DistributedCache.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1348997 13f79535-47bb-0310-9956-ffa450edef68

+import java.net.URI;
+import org.apache.hadoop.fs.FileUtil;
+  private List<File> symlinksCreated = new ArrayList<File>();
+  
-      // This is not supported largely because, 
-      // for a Child subprocess, the cwd in LocalJobRunner
-      // is not a fresh slate, but rather the user's working directory.
-      // This is further complicated because the logic in
-      // setupWorkDir only creates symlinks if there's a jarfile
-      // in the configuration.
-      LOG.warn("LocalJobRunner does not support " +
-          "symlinking into current working dir.");
+      File workDir = new File(System.getProperty("user.dir"));
+      URI[] archives = DistributedCache.getCacheArchives(conf);
+      URI[] files = DistributedCache.getCacheFiles(conf);
+      Path[] localArchives = DistributedCache.getLocalCacheArchives(conf);
+      Path[] localFiles = DistributedCache.getLocalCacheFiles(conf);
+      if (archives != null) {
+        for (int i = 0; i < archives.length; i++) {
+          String link = archives[i].getFragment();
+          String target = new File(localArchives[i].toUri()).getPath();
+          symlink(workDir, target, link);
+        }
+      }
+      if (files != null) {
+        for (int i = 0; i < files.length; i++) {
+          String link = files[i].getFragment();
+          String target = new File(localFiles[i].toUri()).getPath();
+          symlink(workDir, target, link);
+        }
+      }
+  /**
+   * Utility method for creating a symlink and warning on errors.
+   *
+   * If link is null, does nothing.
+   */
+  private void symlink(File workDir, String target, String link)
+      throws IOException {
+    if (link != null) {
+      link = workDir.toString() + Path.SEPARATOR + link;
+      File flink = new File(link);
+      if (!flink.exists()) {
+        LOG.info(String.format("Creating symlink: %s <- %s", target, link));
+        if (0 != FileUtil.symLink(target, link)) {
+          LOG.warn(String.format("Failed to create symlink: %s <- %s", target,
+              link));
+        } else {
+          symlinksCreated.add(new File(link));
+        }
+      }
+    }
+  }
+  
+    for (File symlink : symlinksCreated) {
+      if (!symlink.delete()) {
+        LOG.warn("Failed to delete symlink created by the local job runner: " +
+            symlink);
+      }
+    }

INS26 INS26 INS40 INS40 INS23 INS31 INS83 INS74 INS59 INS29 INS83 INS39 INS42 INS44 INS44 INS44 INS43 INS8 INS43 INS43 INS42 INS14 INS25 INS65 INS43 INS42 INS43 INS42 INS43 INS42 INS42 INS25 INS70 INS42 INS42 INS74 MOV32 INS8 INS66 INS66 INS42 INS42 INS42 INS27 INS8 INS44 INS42 INS8 INS43 INS43 INS60 INS60 INS60 INS60 INS60 MOV25 INS25 INS42 INS33 INS21 INS60 INS25 INS43 INS42 INS25 INS42 INS42 INS43 INS59 INS5 INS59 INS5 INS59 INS5 INS59 INS5 INS59 INS27 INS8 INS27 INS8 INS7 INS43 INS59 INS38 INS8 INS42 INS38 INS8 INS42 INS42 INS14 INS43 INS85 INS42 INS32 INS43 INS85 INS42 INS32 INS43 INS85 INS42 INS32 INS43 INS85 INS42 INS32 INS42 INS33 INS24 INS42 INS33 INS24 INS42 INS27 INS42 INS42 INS14 INS32 INS21 INS25 INS32 INS21 INS43 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS58 INS27 INS37 INS8 INS58 INS27 INS37 INS8 INS32 INS40 INS42 INS43 INS42 INS42 INS42 INS32 INS27 INS8 INS8 INS42 INS42 INS32 INS42 INS42 INS42 INS45 INS39 INS59 INS42 INS40 INS42 INS60 INS60 MOV21 INS39 INS59 INS42 INS40 INS42 INS60 INS60 INS21 INS42 INS42 INS42 INS42 INS42 INS32 INS34 INS32 INS21 INS21 INS42 INS42 INS27 INS42 INS34 INS43 INS59 INS43 INS59 INS42 INS34 INS43 INS59 INS43 INS59 INS32 INS42 INS42 INS45 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS32 INS45 INS42 INS42 INS42 INS32 INS42 INS42 INS32 UPD42 UPD42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS42 INS42 INS14 INS2 INS42 INS14 INS42 INS2 INS42 INS14 INS42 INS42 INS42 INS45 INS42 INS42 INS43 INS42 INS42 INS42 INS43 INS32 INS42 INS42 INS43 INS32 INS42 INS42 INS2 INS42 INS42 INS2 INS42 INS42 INS42 INS42 INS42 DEL45 DEL45 DEL27 DEL8