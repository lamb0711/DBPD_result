HDFS-5922. DN heartbeat thread can get stuck in tight loop. (Arpit Agarwal)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1571542 13f79535-47bb-0310-9956-ffa450edef68

-  private volatile int pendingReceivedRequests = 0;
+  // IBR = Incremental Block Report. If this flag is set then an IBR will be
+  // sent immediately by the actor thread without waiting for the IBR timer
+  // to elapse.
+  private volatile boolean sendImmediateIBR = false;
-          pendingReceivedRequests =
-              (pendingReceivedRequests > rdbi.length ?
-                  (pendingReceivedRequests - rdbi.length) : 0);
+      sendImmediateIBR = false;
-            pendingReceivedRequests +=
-                perStorageMap.putMissingBlockInfos(report.getBlocks());
+            perStorageMap.putMissingBlockInfos(report.getBlocks());
+            sendImmediateIBR = true;
-      pendingReceivedRequests++;
+      sendImmediateIBR = true;
+  @VisibleForTesting
+  boolean hasPendingIBR() {
+    return sendImmediateIBR;
+  }
+
-        if (pendingReceivedRequests > 0
-            || (startTime - lastDeletedReport > dnConf.deleteReportInterval)) {
+        if (sendImmediateIBR ||
+            (startTime - lastDeletedReport > dnConf.deleteReportInterval)) {
-          if (waitTime > 0 && pendingReceivedRequests == 0) {
+          if (waitTime > 0 && !sendImmediateIBR) {

INS31 UPD39 INS78 INS39 INS42 INS8 UPD42 INS9 INS42 INS41 INS42 INS21 INS7 INS7 INS42 INS9 INS42 INS9 UPD42 MOV42 INS21 INS38 MOV32 INS7 INS42 INS42 INS9 DEL34 DEL42 DEL42 DEL40 DEL27 DEL42 DEL40 DEL27 DEL36 DEL34 DEL16 DEL36 DEL7 DEL21 DEL42 DEL7 DEL42 DEL37 DEL34 DEL27 DEL42 DEL34 DEL27