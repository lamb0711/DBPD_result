Merging trunk to HDFS-2802 branch.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1416603 13f79535-47bb-0310-9956-ffa450edef68

-      file.setModificationTimeForce(now);
+      file.setModificationTime(now);
-        srcInodes[srcInodes.length-2].setModificationTime(timestamp);
-        dstInodes[dstInodes.length-2].setModificationTime(timestamp);
+        srcInodes[srcInodes.length-2].updateModificationTime(timestamp);
+        dstInodes[dstInodes.length-2].updateModificationTime(timestamp);
+        // update moved leases with new filename
+        getFSNamesystem().unprotectedChangeLease(src, dst);        
-        srcInodes[srcInodes.length - 2].setModificationTime(timestamp);
-        dstInodes[dstInodes.length - 2].setModificationTime(timestamp);
+        srcInodes[srcInodes.length - 2].updateModificationTime(timestamp);
+        dstInodes[dstInodes.length - 2].updateModificationTime(timestamp);
+        // update moved lease with new filename
+        getFSNamesystem().unprotectedChangeLease(src, dst);
-      trgParent.removeChild(nodeToRemove);
+      trgParent.removeChild(nodeToRemove, trgINodesInPath.getLatestSnapshot());
-    trgInode.setModificationTimeForce(timestamp);
-    trgParent.setModificationTime(timestamp);
+    trgInode.setModificationTime(timestamp);
+    trgParent.updateModificationTime(timestamp);
-    inodes[inodes.length - 2].setModificationTime(mtime);
+    inodes[inodes.length - 2].updateModificationTime(mtime);
-  private void replaceINodeUnsynced(String path, INode oldnode, INode newnode
-      ) throws IOException {    
+  private void replaceINodeUnsynced(String path, INode oldnode, INode newnode,
+      Snapshot latestSnapshot) throws IOException {    
-    if (!oldnode.removeNode()) {
+    if (!oldnode.removeNode(latestSnapshot)) {
-      INodeDirectory newnode) throws IOException {    
+      INodeDirectory newnode, Snapshot latestSnapshot) throws IOException {    
-      replaceINodeUnsynced(path, oldnode, newnode);
+      replaceINodeUnsynced(path, oldnode, newnode, latestSnapshot);
-  public void replaceNode(String path, INodeFile oldnode, INodeFile newnode
-      ) throws IOException {    
+  public void replaceNode(String path, INodeFile oldnode, INodeFile newnode,
+      Snapshot latestSnapshot) throws IOException {
-      replaceINodeUnsynced(path, oldnode, newnode);
+      replaceINodeUnsynced(path, oldnode, newnode, latestSnapshot);
-      INode targetNode = rootDir.getNode(srcs, resolveLink);
-      if (targetNode == null) {
-        return null;
-      }
-      else {
-        return createFileStatus(HdfsFileStatus.EMPTY_NAME, targetNode);
-      }
+      final INodesInPath inodesInPath = rootDir.getINodesInPath(srcs, resolveLink);
+      final INode i = inodesInPath.getINode(0);
+      return i == null? null: createFileStatus(HdfsFileStatus.EMPTY_NAME, i);
+    return getINodesInPath(src).getINode(0);
+  }
+
+  /**
+   * Get {@link INode} associated with the file / directory.
+   */
+  public INodesInPath getINodesInPath(String src) throws UnresolvedLinkException {
-      return rootDir.getNode(src, true);
+      return rootDir.getINodesInPath(src, true);
-    final boolean added = ((INodeDirectory)inodes[pos-1]).addChild(child, true);
+    final boolean added = ((INodeDirectory)inodes[pos-1]).addChild(child, true,
+        inodesInPath.getLatestSnapshot());
-    INode removedNode = ((INodeDirectory)inodes[pos-1]).removeChild(inodes[pos]);
+    INode removedNode = ((INodeDirectory)inodes[pos-1]).removeChild(inodes[pos],
+        inodesInPath.getLatestSnapshot());
-    final INode[] inodes = rootDir.getMutableINodesInPath(srcs, true)
-        .getINodes();
+    final INodesInPath inodesInPath = rootDir.getMutableINodesInPath(srcs, true);
+    final INode[] inodes = inodesInPath.getINodes();
-          parent.replaceChild(newNode);
+          parent.replaceChild(newNode, inodesInPath.getLatestSnapshot());
-        parent.replaceChild(newNode);
+        parent.replaceChild(newNode, inodesInPath.getLatestSnapshot());
-      inode.setModificationTimeForce(mtime);
+      inode.setModificationTime(mtime);

INS31 INS44 INS44 INS44 INS8 INS29 INS83 INS43 INS42 INS44 INS43 MOV8 INS43 INS42 INS43 INS42 INS43 INS42 INS41 INS65 INS42 INS43 INS42 INS42 INS60 INS42 INS42 INS42 INS32 INS66 INS65 INS66 INS42 INS43 INS83 INS5 INS59 UPD42 UPD42 UPD42 INS60 INS41 INS32 INS42 INS34 INS42 UPD42 MOV42 UPD42 MOV32 INS43 INS85 INS42 INS32 INS42 INS83 INS43 INS83 MOV43 INS59 INS16 INS42 INS42 INS32 INS32 INS42 INS42 INS42 UPD42 INS21 INS21 INS32 INS42 INS42 INS42 UPD42 INS42 INS32 INS27 INS33 INS32 UPD42 INS42 INS42 INS42 INS42 UPD42 INS32 INS32 INS42 INS42 UPD42 INS42 INS42 INS34 UPD42 MOV42 MOV33 MOV42 MOV40 UPD42 MOV42 UPD42 UPD42 INS32 INS42 INS42 INS42 UPD42 UPD42 INS32 INS42 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS32 INS42 INS42 DEL27 DEL33 DEL41 DEL8 DEL32 DEL41 DEL8 DEL25 DEL43 DEL85 DEL5 DEL42 DEL32