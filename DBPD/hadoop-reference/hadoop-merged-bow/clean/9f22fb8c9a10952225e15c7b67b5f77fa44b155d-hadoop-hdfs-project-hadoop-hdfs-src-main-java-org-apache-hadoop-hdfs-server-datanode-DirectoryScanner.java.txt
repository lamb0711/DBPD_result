HDFS-6978. Directory scanner should correctly reconcile blocks on RAM disk. (Arpit Agarwal)

+    long duplicateBlocks = 0;
-          Block memBlock = memReport[Math.min(m, memReport.length - 1)];
+          FinalizedReplica memBlock = memReport[Math.min(m, memReport.length - 1)];
+          } else if (info.getBlockFile().compareTo(memBlock.getBlockFile()) != 0) {
+            // volumeMap record and on-disk files don't match.
+            statsRecord.duplicateBlocks++;
+            addDifference(diffRecord, statsRecord, info);
-          m++;
+
+          if (d < blockpoolReport.length) {
+            // There may be multiple on-disk records for the same block, don't increment
+            // the memory record pointer if so.
+            ScanInfo nextInfo = blockpoolReport[Math.min(d, blockpoolReport.length - 1)];
+            if (nextInfo.getBlockId() != info.blockId) {
+              ++m;
+            }
+          } else {
+            ++m;
+          }

INS23 INS39 INS59 INS42 INS34 INS25 UPD43 INS27 INS8 INS8 UPD42 INS25 INS42 INS40 INS60 INS25 INS21 INS27 INS8 INS43 INS59 INS27 INS8 INS38 INS32 INS34 INS21 INS21 INS42 INS42 INS2 INS32 INS40 MOV21 INS42 INS32 INS42 INS32 INS37 INS32 INS42 INS32 INS42 INS42 INS38 INS42 INS42 INS42 INS42 INS40 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS27 INS42 INS40 INS34 DEL42 DEL37