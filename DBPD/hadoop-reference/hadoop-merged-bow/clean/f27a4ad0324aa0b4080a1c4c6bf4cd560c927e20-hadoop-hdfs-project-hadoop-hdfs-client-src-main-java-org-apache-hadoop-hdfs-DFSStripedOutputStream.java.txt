HDFS-12612. DFSStripedOutputStream.close will throw if called a second time with a failed streamer. (Lei (Eddy) Xu)

+  /**
+   * OutputStream level last exception, will be used to indicate the fatal
+   * exception of this stream, i.e., being aborted.
+   */
+  private final ExceptionLastSeen exceptionLastSeen = new ExceptionLastSeen();
+
-      for (StripedDataStreamer streamer : streamers) {
-        streamer.getLastException().set(
-            new IOException("Lease timeout of "
-                + (dfsClient.getConf().getHdfsTimeout() / 1000)
-                + " seconds expired."));
-      }
+      exceptionLastSeen.set(new IOException("Lease timeout of "
+          + (dfsClient.getConf().getHdfsTimeout() / 1000)
+          + " seconds expired."));
+      exceptionLastSeen.check(true);
+
+      // Writing to at least {dataUnits} replicas can be considered as success,
+      // and the rest of data can be recovered.
+      final int minReplication = ecPolicy.getNumDataUnits();
+      int goodStreamers = 0;
-      for(int i = 0; i < streamers.size(); i++) {
-        final StripedDataStreamer si = getStripedDataStreamer(i);
+      for (final StripedDataStreamer si : streamers) {
+          goodStreamers++;
-      final IOException ioe = b.build();
-      if (ioe != null) {
-        throw ioe;
+      if (goodStreamers < minReplication) {
+        final IOException ioe = b.build();
+        if (ioe != null) {
+          throw ioe;
+        }
-        // may be thrown if more than 3 streamers fail, or updatePipeline RPC
-        // fails. Streamers may keep waiting for the new block/GS information.
-        // Thus need to force closing these threads.
+        // may be thrown if the number of failed streamers is more than the
+        // number of parity blocks, or updatePipeline RPC fails. Streamers may
+        // keep waiting for the new block/GS information. Thus need to force
+        // closing these threads.

INS23 INS29 INS83 INS83 INS43 INS59 MOV8 INS65 INS42 INS42 INS14 MOV60 INS51 MOV21 MOV60 MOV25 INS66 INS66 INS43 INS52 MOV8 INS42 MOV25 MOV54 INS21 INS60 INS60 INS70 INS25 MOV42 INS32 INS83 INS39 INS59 INS39 INS59 INS44 INS42 MOV8 INS27 INS8 UPD42 MOV42 INS42 INS42 INS9 INS42 INS32 UPD42 MOV42 MOV34 INS83 MOV43 INS42 INS42 INS42 MOV60 MOV25 INS42 INS42 INS42 INS21 INS42 INS42 INS37 INS42 DEL42 DEL32 DEL42 DEL43 DEL42 DEL44 DEL42 DEL70 DEL52 DEL51 DEL8 DEL83 DEL42 DEL42 DEL42 DEL32 DEL59 DEL60 DEL39 DEL59 DEL58 DEL42 DEL42 DEL42 DEL32 DEL27 DEL42 DEL37 DEL24