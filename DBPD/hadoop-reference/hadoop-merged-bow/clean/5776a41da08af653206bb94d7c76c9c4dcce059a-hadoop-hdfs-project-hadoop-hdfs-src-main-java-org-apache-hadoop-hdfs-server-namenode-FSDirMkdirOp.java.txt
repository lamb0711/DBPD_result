HDFS-7498. Simplify the logic in INodesInPath. Contributed by Jing Zhao.

-    INodesInPath iip = fsd.getExistingPathINodes(components);
-    INode[] inodes = iip.getINodes();
-    final int pos = inodes.length - 1;
-    unprotectedMkdir(fsd, inodeId, iip, pos, components[pos], permissions,
-        aclEntries, timestamp);
-    return inodes[pos];
+    final INodesInPath iip = fsd.getExistingPathINodes(components);
+    final int pos = iip.length() - 1;
+    final INodesInPath newiip = unprotectedMkdir(fsd, inodeId, iip, pos,
+        components[pos], permissions, aclEntries, timestamp);
+    return newiip.getINode(pos);
-      INode[] inodes = iip.getINodes();
-
+      final int length = iip.length();
-      for(; i < inodes.length && inodes[i] != null; i++) {
+      INode curNode;
+      for(; i < length && (curNode = iip.getINode(i)) != null; i++) {
-        if (!inodes[i].isDirectory()) {
+        if (!curNode.isDirectory()) {
-                  + pathbuilder + " "+inodes[i].getLocalName());
+                  + pathbuilder + " " + curNode.getLocalName());
-        FsPermission parentFsPerm = inheritPermission
-                ? inodes[i-1].getFsPermission() : permissions.getPermission();
+        FsPermission parentFsPerm = inheritPermission ?
+            iip.getINode(i-1).getFsPermission() : permissions.getPermission();
-      for(; i < inodes.length; i++) {
+      for(; i < length; i++) {
-        unprotectedMkdir(fsd, fsd.allocateNewInodeId(), iip, i, components[i],
-            (i < lastInodeIndex) ? parentPermissions : permissions, null, now);
-        if (inodes[i] == null) {
+        iip = unprotectedMkdir(fsd, fsd.allocateNewInodeId(), iip, i,
+            components[i], (i < lastInodeIndex) ? parentPermissions :
+                permissions, null, now);
+        if (iip.getINode(i) == null) {
-        fsd.getEditLog().logMkDir(cur, inodes[i]);
+        fsd.getEditLog().logMkDir(cur, iip.getINode(i));
-  private static void unprotectedMkdir(
+  private static INodesInPath unprotectedMkdir(
-      inodesInPath.setINode(pos, dir);
+      return INodesInPath.replace(inodesInPath, pos, dir);
+    } else {
+      return inodesInPath;

INS43 INS42 INS83 INS83 INS39 INS43 INS32 INS8 UPD42 INS27 INS42 UPD42 MOV32 INS42 INS42 INS42 INS60 INS41 INS41 INS32 INS34 INS83 INS39 MOV43 INS59 INS32 INS42 MOV42 UPD42 MOV42 UPD42 INS42 INS42 UPD42 MOV42 UPD42 MOV42 INS42 MOV42 MOV42 UPD42 INS42 INS36 INS7 INS7 INS42 MOV32 INS32 INS32 INS42 INS32 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 MOV32 INS42 INS42 UPD42 MOV27 INS42 DEL42 DEL43 DEL85 DEL5 DEL32 DEL39 DEL40 DEL34 DEL27 DEL21 DEL42 DEL42 DEL2 DEL85 DEL5 DEL40 DEL42 DEL42 DEL2 DEL42 DEL42 DEL2 DEL42 DEL42 DEL2 DEL42 DEL2 DEL40 DEL42 DEL42 DEL2 DEL42 DEL42 DEL2 DEL39 DEL32 DEL21