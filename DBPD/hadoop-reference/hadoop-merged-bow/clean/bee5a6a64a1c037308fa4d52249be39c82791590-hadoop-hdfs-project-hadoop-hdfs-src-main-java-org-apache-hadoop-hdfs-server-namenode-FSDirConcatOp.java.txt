HDFS-7943. Append cannot handle the last block with length greater than the preferred block size. Contributed by Jing Zhao.

+/**
+ * Restrictions for a concat operation:
+ * <pre>
+ * 1. the src file and the target file are in the same dir
+ * 2. all the source files are not in snapshot
+ * 3. any source file cannot be the same with the target file
+ * 4. source files cannot be under construction or empty
+ * 5. source file's preferred block size cannot be greater than the target file
+ * </pre>
+ */
+      // source file cannot be the same with the target file
+      // source file cannot be under construction or empty
+      // source file's preferred block size cannot be greater than the target
+      // file
+      if (srcINodeFile.getPreferredBlockSize() >
+          targetINode.getPreferredBlockSize()) {
+        throw new HadoopIllegalArgumentException("concat: source file " + src
+            + " has preferred block size " + srcINodeFile.getPreferredBlockSize()
+            + " which is greater than the target file's preferred block size "
+            + targetINode.getPreferredBlockSize());
+      }
-  private static QuotaCounts computeQuotaDeltas(FSDirectory fsd, INodeFile target, INodeFile[] srcList) {
+  private static QuotaCounts computeQuotaDeltas(FSDirectory fsd,
+      INodeFile target, INodeFile[] srcList) {
-    short targetRepl = target.getBlockReplication();
+    final short targetRepl = target.getBlockReplication();

INS29 INS65 INS66 INS66 INS66 INS66 INS66 INS66 INS66 INS66 INS83 INS25 INS27 INS8 INS32 INS32 INS53 INS42 INS42 INS42 INS42 INS14 INS43 INS27 INS42 INS45 INS42 INS45 INS32 INS45 INS32 INS42 INS42 INS42 INS42