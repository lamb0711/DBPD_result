HADOOP-7991. HA: the FailoverController should check the standby is ready before failing over. Contributed by Eli Collins


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1239774 13f79535-47bb-0310-9956-ffa450edef68

+   * An option to ignore toSvc if it claims it is not ready to
+   * become active is provided in case performing a failover will
+   * allow it to become active, eg because it triggers a log roll
+   * so the standby can learn about new blocks and leave safemode.
+   *
+   * @param forceActive ignore toSvc if it reports that it is not ready
-                                        InetSocketAddress toSvcAddr)
+                                        InetSocketAddress toSvcAddr,
+                                        boolean forceActive)
-    // TODO(HA): ask toSvc if it's capable. Eg not in SM.
+    try {
+      if (!toSvc.readyToBecomeActive()) {
+        if (!forceActive) {
+          throw new FailoverFailedException(
+              toSvcAddr + " is not ready to become active");
+        }
+      }
+    } catch (IOException e) {
+      throw new FailoverFailedException(
+          "Got an IO exception", e);
+    }
+   * @param forceActive try to make toSvc active even if it is not ready
-                              NodeFencer fencer, boolean forceFence)
+                              NodeFencer fencer,
+                              boolean forceFence,
+                              boolean forceActive)
-    preFailoverChecks(toSvc, toSvcAddr);
+    preFailoverChecks(toSvc, toSvcAddr, forceActive);
-          failover(toSvc, toSvcAddr, fromSvc, fromSvcAddr, fencer, true);
+          // Unconditionally force fromSvc to become active since it
+          // was previously active when we initiated failover.
+          failover(toSvc, toSvcAddr, fromSvc, fromSvcAddr, fencer, true, true);

INS44 INS44 INS65 INS39 INS42 INS54 INS65 INS39 INS42 INS66 INS66 INS66 INS66 INS42 INS66 INS8 INS12 INS42 INS66 INS25 INS44 INS8 INS42 INS38 INS8 INS43 INS42 INS53 INS32 INS25 INS42 INS14 INS42 INS42 INS38 INS8 INS43 INS45 INS42 INS42 INS53 INS42 INS14 INS43 INS27 INS9 INS42 INS42 INS45