YARN-8273. Log aggregation does not warn if HDFS quota in target directory is exceeded (grepas via rkanter)

+import org.apache.hadoop.yarn.logaggregation.filecontroller.LogAggregationDFSException;
-  private void uploadLogsForContainers(boolean appFinished) {
+  private void uploadLogsForContainers(boolean appFinished)
+      throws LogAggregationDFSException {
+    DeletionTask deletionTask = null;
-          DeletionTask deletionTask = new FileDeletionTask(delService,
+          deletionTask = new FileDeletionTask(delService,
-          delService.delete(deletionTask);
+      LogAggregationDFSException exc = null;
+      try {
+        this.logAggregationFileController.closeWriter();
+      } catch (LogAggregationDFSException e) {
+        diagnosticMessage = e.getMessage();
+        renameTemporaryLogFileFailed = true;
+        logAggregationSucceedInThisCycle = false;
+        exc = e;
+      }
+      if (logAggregationSucceedInThisCycle && deletionTask != null) {
+        delService.delete(deletionTask);
+      }
-      logAggregationFileController.closeWriter();
+      if (exc != null) {
+        throw exc;
+      }
-  @SuppressWarnings("unchecked")
+    } catch (LogAggregationDFSException e) {
+      // if the log aggregation could not be performed due to DFS issues
+      // let's not clean up the log files, since that can result in
+      // loss of logs
+      LOG.error("Error occurred while aggregating the log for the application "
+          + appId, e);
-      // do post clean up of log directories on any exception
+      // do post clean up of log directories on any other exception
-  @SuppressWarnings("unchecked")
-  private void doAppLogAggregation() {
+  private void doAppLogAggregation() throws LogAggregationDFSException {
+        } catch (LogAggregationDFSException e) {
+          this.appFinishing.set(true);
+          throw e;
-    // App is finished, upload the container logs.
-    uploadLogsForContainers(true);
+    try {
+      // App is finished, upload the container logs.
+      uploadLogsForContainers(true);
-    doAppLogAggregationPostCleanUp();
+      doAppLogAggregationPostCleanUp();
+    } catch (LogAggregationDFSException e) {
+      LOG.error("Error during log aggregation", e);
+    }

INS26 INS40 INS43 INS43 INS42 INS60 INS42 INS54 MOV43 INS59 INS8 INS12 INS8 INS12 INS42 INS33 INS60 INS54 INS25 MOV21 INS25 INS44 INS8 MOV21 MOV21 INS44 INS8 INS43 INS59 MOV8 INS12 INS27 INS8 INS27 INS8 INS43 INS42 INS21 INS43 INS42 INS21 INS42 INS42 INS33 INS44 INS8 INS42 INS27 MOV21 INS42 INS33 INS53 INS42 INS32 INS42 INS32 INS43 INS42 INS21 INS21 INS21 INS21 INS42 INS33 INS42 INS42 INS42 INS27 INS42 INS12 INS42 INS42 INS45 INS42 INS21 INS22 INS42 INS7 INS7 INS7 INS7 INS45 INS42 INS44 INS8 INS7 INS52 INS42 INS42 INS32 INS42 INS9 INS42 INS9 INS42 INS42 INS43 INS42 INS21 INS53 INS42 MOV14 INS42 INS42 INS42 INS32 INS42 INS22 INS42 INS9 INS52 INS42 DEL42 DEL59 DEL60 DEL42 DEL42 DEL45 DEL79 DEL42 DEL45 DEL79