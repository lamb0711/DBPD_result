HADOOP-7938. HA: the FailoverController should optionally fence the active during failover. Contributed by Eli Collins


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1238058 13f79535-47bb-0310-9956-ffa450edef68

+import java.net.InetSocketAddress;
+import com.google.common.base.Preconditions;
+
-                                        String toSvcName)
+                                        InetSocketAddress toSvcAddr)
-      String msg = "Unable to get service state for " + toSvcName;
+      String msg = "Unable to get service state for " + toSvcAddr;
-          "Got an io exception", e);
+          "Got an IO exception", e);
-   * @param fromSvcName name of currently active service
+   * @param fromSvcAddr addr of the currently active service
-   * @param toSvcName name of service to make active
+   * @param toSvcAddr addr of the service to make active
+   * @param fencer for fencing fromSvc
+   * @param forceFence to fence fromSvc even if not strictly necessary
-  public static void failover(HAServiceProtocol fromSvc, String fromSvcName,
-                              HAServiceProtocol toSvc, String toSvcName)
+  public static void failover(HAServiceProtocol fromSvc,
+                              InetSocketAddress fromSvcAddr,
+                              HAServiceProtocol toSvc,
+                              InetSocketAddress toSvcAddr,
+                              NodeFencer fencer, boolean forceFence)
-    preFailoverChecks(toSvc, toSvcName);
+    Preconditions.checkArgument(fencer != null, "failover requires a fencer");
+    preFailoverChecks(toSvc, toSvcAddr);
+    boolean tryFence = true;
+      // We should try to fence if we failed or it was forced
+      tryFence = forceFence ? true : false;
-      LOG.warn("Unable to make " + fromSvcName + " standby (" +
+      LOG.warn("Unable to make " + fromSvcAddr + " standby (" +
-    } catch (Exception e) {
-      LOG.warn("Unable to make " + fromSvcName +
-          " standby (unable to connect)", e);
-      // TODO(HA): fence fromSvc and unfence on failback
+    } catch (IOException ioe) {
+      LOG.warn("Unable to make " + fromSvcAddr +
+          " standby (unable to connect)", ioe);
+    }
+
+    // Fence fromSvc if it's required or forced by the user
+    if (tryFence) {
+      if (!fencer.fence(fromSvcAddr)) {
+        throw new FailoverFailedException("Unable to fence " +
+            fromSvcAddr + ". Fencing failed.");
+      }
-      LOG.error("Unable to make " + toSvcName + " active (" +
-          sfe.getMessage() + "). Failing back");
+      LOG.error("Unable to make " + toSvcAddr + " active (" +
+          sfe.getMessage() + "). Failing back.");
-    } catch (Exception e) {
-      LOG.error("Unable to make " + toSvcName +
-          " active (unable to connect). Failing back", e);
+    } catch (IOException ioe) {
+      LOG.error("Unable to make " + toSvcAddr +
+          " active (unable to connect). Failing back.", ioe);
-      cause = e;
+      cause = ioe;
-    // Try to failback if we failed to make toSvc active
+    // We failed to make toSvc active
-      String msg = "Unable to failover to " + toSvcName;
-      try {
-        HAServiceProtocolHelper.transitionToActive(fromSvc);
-      } catch (ServiceFailedException sfe) {
-        msg = "Failback to " + fromSvcName + " failed (" +
-              sfe.getMessage() + ")";
-        LOG.fatal(msg);
-      } catch (Exception e) {
-        msg = "Failback to " + fromSvcName + " failed (unable to connect)";
-        LOG.fatal(msg);
+      String msg = "Unable to failover to " + toSvcAddr;
+      // Only try to failback if we didn't fence fromSvc
+      if (!tryFence) {
+        try {
+          // Unconditionally fence toSvc in case it is still trying to
+          // become active, eg we timed out waiting for its response.
+          failover(toSvc, toSvcAddr, fromSvc, fromSvcAddr, fencer, true);
+        } catch (FailoverFailedException ffe) {
+          msg += ". Failback to " + fromSvcAddr +
+            " failed (" + ffe.getMessage() + ")";
+          LOG.fatal(msg);
+        }

INS26 INS26 INS40 INS40 INS44 INS44 UPD43 UPD42 INS65 INS65 UPD43 UPD42 UPD43 UPD42 INS43 INS42 INS39 INS42 INS21 INS60 INS25 UPD42 UPD42 UPD66 UPD42 UPD66 INS42 INS66 INS42 INS66 UPD42 UPD42 INS42 INS32 INS39 INS59 INS42 INS8 INS42 INS42 INS27 INS45 UPD42 INS42 INS9 INS21 INS25 INS25 INS42 INS33 INS7 UPD43 UPD42 INS38 INS8 UPD43 UPD42 INS38 INS8 INS42 INS16 UPD42 INS32 INS53 UPD42 INS42 MOV54 UPD45 INS42 INS9 INS9 UPD42 INS42 INS42 INS42 INS14 UPD42 UPD42 UPD42 UPD42 UPD42 MOV32 UPD42 INS43 INS27 UPD42 INS32 UPD45 UPD42 UPD45 INS42 INS45 INS42 INS45 INS42 INS42 UPD43 UPD42 MOV21 UPD42 UPD42 INS42 INS42 INS42 INS9 UPD42 UPD7 UPD45 UPD42 UPD42 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32 DEL21 DEL42 DEL43 DEL42 DEL44 DEL42 DEL45 DEL42 DEL45 DEL27 DEL7 DEL21 DEL8 DEL12