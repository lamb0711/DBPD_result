HDFS-14311. Multi-threading conflict at layoutVersion when loading block pool storage. Contributed by Yicong Cai.

+    Map<StorageLocation, List<Callable<StorageDirectory>>> upgradeCallableMap =
+        new HashMap<>();
-        final List<Callable<StorageDirectory>> callables = Lists.newArrayList();
+        final List<Callable<StorageDirectory>> sdCallables =
+            Lists.newArrayList();
-            nsInfo, dataDir, startOpt, callables, datanode.getConf());
-        if (callables.isEmpty()) {
+            nsInfo, dataDir, startOpt, sdCallables, datanode.getConf());
+        if (sdCallables.isEmpty()) {
-          for(Callable<StorageDirectory> c : callables) {
-            tasks.add(new UpgradeTask(dataDir, executor.submit(c)));
-          }
+          upgradeCallableMap.put(dataDir, sdCallables);
+    for (Map.Entry<StorageLocation, List<Callable<StorageDirectory>>> entry :
+        upgradeCallableMap.entrySet()) {
+      for(Callable<StorageDirectory> c : entry.getValue()) {
+        tasks.add(new UpgradeTask(entry.getKey(), executor.submit(c)));
+      }
+    }
+

INS60 INS70 INS74 INS59 INS44 INS32 MOV8 INS43 INS43 INS74 INS42 INS14 INS74 INS42 INS42 INS42 INS42 INS42 INS43 INS74 INS74 INS43 INS43 INS74 INS32 INS42 INS43 INS43 INS43 INS40 INS42 INS43 INS74 INS42 INS42 INS42 INS42 INS42 INS8 INS42 INS43 INS43 UPD42 UPD42 INS21 INS42 INS42 UPD42 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 DEL42 DEL42