HDFS-2692. Fix bugs related to failover from/into safe mode. Contributed by Todd Lipcon.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1225709 13f79535-47bb-0310-9956-ffa450edef68

+    writeLock();
+      writeUnlock();
-      assert isConsistent() : " SafeMode: Inconsistent filesystem state: "
-        + "Total num of blocks, active blocks, or "
-        + "total safe blocks don't match.";
+      doConsistencyCheck();
+      // Have to have write-lock since leaving safemode initializes
+      // repl queues, which requires write lock
+      assert hasWriteLock();
-     * This is costly and currently called only in assert.
-     * @throws IOException 
+     * This is costly so only runs if asserts are enabled.
-    private boolean isConsistent() {
-      if (blockTotal == -1 && blockSafe == -1) {
-        return true; // manual safe mode
-      }
+    private void doConsistencyCheck() {
+      boolean assertsOn = false;
+      assert assertsOn = true; // set to true if asserts are on
+      if (!assertsOn) return;
+      
+      
-      return (blockTotal == activeBlocks) ||
-        (blockSafe >= 0 && blockSafe <= blockTotal);
+      if (blockTotal == -1 && blockSafe == -1) {
+        return; // manual safe mode
+      }
+      if ((blockTotal != activeBlocks) &&
+          !(blockSafe >= 0 && blockSafe <= blockTotal)) {
+        throw new AssertionError(
+            " SafeMode: Inconsistent filesystem state: "
+        + "SafeMode data: blockTotal=" + blockTotal
+        + " blockSafe=" + blockSafe + "; "
+        + "BlockManager data: active="  + activeBlocks);
+      }
-  void setBlockTotal() {
+  public void setBlockTotal() {
-    LOG.info("=> notified of genstamp update for: " + gs);
+    if (LOG.isDebugEnabled()) {
+      LOG.debug("Generation stamp " + gs + " has been reached. " +
+          "Processing pending messages from DataNodes...");
+    }
-      LOG.info("processing message: " + msg);
+      if (LOG.isDebugEnabled()) {
+        LOG.debug("Processing previously pending message: " + msg);
+      }

INS83 INS21 UPD39 UPD42 MOV25 INS25 INS32 INS21 INS6 INS60 INS6 INS25 INS25 INS32 INS8 INS42 INS21 INS32 INS32 UPD66 INS39 INS59 INS7 INS38 INS41 UPD27 MOV27 INS8 INS42 INS42 MOV21 INS25 INS32 UPD42 MOV42 INS42 INS42 INS9 INS42 INS9 INS42 INS38 INS53 INS32 INS8 INS42 UPD27 MOV36 INS14 UPD42 INS42 INS42 MOV21 INS43 INS27 UPD45 INS45 INS45 INS42 INS27 INS42 INS45 INS42 INS45 INS45 INS42 UPD42 INS45 INS45 UPD45 DEL32 DEL45 DEL45 DEL45 DEL27 DEL6 DEL42 DEL66 DEL65 DEL9 DEL41