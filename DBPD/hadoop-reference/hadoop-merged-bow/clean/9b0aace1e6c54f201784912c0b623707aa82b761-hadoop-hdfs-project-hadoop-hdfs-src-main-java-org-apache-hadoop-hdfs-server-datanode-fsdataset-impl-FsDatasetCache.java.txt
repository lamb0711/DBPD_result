HDFS-14401. Refine the implementation for HDFS cache on SCM. Contributed by Feilong He.

-import org.apache.hadoop.util.ReflectionUtils;
-    Class<? extends MappableBlockLoader> cacheLoaderClass =
-        dataset.datanode.getDnConf().getCacheLoaderClass();
-    this.cacheLoader = ReflectionUtils.newInstance(cacheLoaderClass, null);
+    this.cacheLoader = MappableBlockLoaderFactory.createCacheLoader(
+        this.getDnConf());
-    return cacheLoader.getCachedPath(key);
+    return PmemVolumeManager.getInstance().getCachePath(key);
-      long newUsedBytes = cacheLoader.reserve(length);
+      long newUsedBytes = cacheLoader.reserve(key, length);
-          LOG.warn("Failed to cache " + key + ": could not reserve " + length +
-              " more bytes in the cache: " +
-              cacheLoader.getCacheCapacityConfigKey() +
-              " of " + cacheLoader.getCacheCapacity() + " exceeded.");
+          LOG.warn("Failed to cache " + key + ": could not reserve " +
+              "more bytes in the cache: " + cacheLoader.getCacheCapacity() +
+              " exceeded when try to reserve " + length + "bytes.");
-            cacheLoader.release(length);
+            cacheLoader.release(key, length);
-                  + "bytes in total.", key, memCacheStats.getCacheUsed());
+                  + "bytes in total.", key, cacheLoader.getCacheUsed());
-      long newUsedBytes = cacheLoader.release(value.mappableBlock.getLength());
+      long newUsedBytes = cacheLoader.
+          release(key, value.mappableBlock.getLength());
+
+  /**
+   * This method can be executed during DataNode shutdown.
+   */
+  void shutdown() {
+    cacheLoader.shutdown();
+  }

INS31 INS29 INS39 INS42 INS8 INS65 INS21 INS66 INS32 INS32 UPD42 INS42 INS42 UPD42 UPD42 INS32 UPD42 MOV42 INS42 INS52 UPD42 MOV42 INS42 INS42 MOV45 UPD45 UPD45 INS42 UPD45 UPD42 INS42 DEL40 DEL26 DEL42 DEL43 DEL42 DEL43 DEL76 DEL74 DEL42 DEL40 DEL42 DEL32 DEL42 DEL32 DEL59 DEL60 DEL33 DEL42 DEL42 DEL42 DEL32