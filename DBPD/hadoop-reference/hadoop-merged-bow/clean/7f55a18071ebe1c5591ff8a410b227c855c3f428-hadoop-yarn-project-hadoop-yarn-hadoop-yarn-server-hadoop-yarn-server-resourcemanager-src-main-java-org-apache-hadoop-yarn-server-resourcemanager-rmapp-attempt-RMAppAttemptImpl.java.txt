YARN-4347. Resource manager fails with Null pointer exception. (Jian He via wangda)

+import org.apache.hadoop.yarn.server.resourcemanager.rmapp.RMAppState;
+      RMApp rmApp = appAttempt.rmContext.getRMApps().get(
+          appAttempt.getAppAttemptId().getApplicationId());
+
-        RMApp rmApp =appAttempt.rmContext.getRMApps().get(
-            appAttempt.getAppAttemptId().getApplicationId());
-      } else {
+      } else if (RMAppImpl.isAppInFinalState(rmApp))  {
+        // Somehow attempt final state was not saved but app final state was saved.
+        // Skip adding the attempt into scheduler
+        RMAppState appState = ((RMAppImpl) rmApp).getRecoveredFinalState();
+        LOG.warn(rmApp.getApplicationId() + " final state (" + appState
+            + ") was recorded, but " + appAttempt.applicationAttemptId
+            + " final state (" + appAttempt.recoveredFinalState
+            + ") was not recorded.");
+        switch (appState) {
+        case FINISHED:
+          return RMAppAttemptState.FINISHED;
+        case FAILED:
+          return RMAppAttemptState.FAILED;
+        case KILLED:
+          return RMAppAttemptState.KILLED;
+        }
+        return RMAppAttemptState.FAILED;
+      } else{
+

INS26 INS40 MOV60 INS25 INS32 INS8 MOV8 INS42 INS42 INS42 INS60 INS21 INS50 INS41 INS43 INS59 INS32 INS42 INS49 INS41 INS49 INS41 INS49 INS41 INS40 INS42 INS42 INS32 INS42 INS42 INS27 INS42 INS40 INS42 INS40 INS42 INS40 INS36 INS42 INS32 INS45 INS42 INS45 INS40 INS45 INS40 INS45 INS11 INS42 INS42 INS43 INS42 INS42