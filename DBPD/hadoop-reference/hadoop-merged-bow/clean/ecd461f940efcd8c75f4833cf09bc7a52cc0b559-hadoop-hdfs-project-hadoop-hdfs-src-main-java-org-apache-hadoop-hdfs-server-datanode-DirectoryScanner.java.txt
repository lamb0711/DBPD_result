HDFS-14751. Synchronize on diffs in DirectoryScanner. Contributed by Lisheng Sun.

-    diffs.clear();
+    synchronized (diffs) {
+      diffs.clear();
+    }
-    for (final Map.Entry<String, ScanInfo> entry : diffs.getEntries()) {
-      dataset.checkAndUpdate(entry.getKey(), entry.getValue());
+    synchronized (diffs) {
+      for (final Map.Entry<String, ScanInfo> entry : diffs.getEntries()) {
+        dataset.checkAndUpdate(entry.getKey(), entry.getValue());
-      if (loopCount % RECONCILE_BLOCKS_BATCH_SIZE == 0) {
-        try {
-          Thread.sleep(2000);
-        } catch (InterruptedException e) {
-          // do nothing
+        if (loopCount % RECONCILE_BLOCKS_BATCH_SIZE == 0) {
+          try {
+            Thread.sleep(2000);
+          } catch (InterruptedException e) {
+            // do nothing
+          }
+        loopCount++;
-      loopCount++;
-        diffs.addAll(bpid, diffRecord);
+        synchronized (diffs) {
+          diffs.addAll(bpid, diffRecord);
+        }

INS51 INS51 INS42 INS8 INS42 INS8 MOV21 MOV70 INS51 INS42 INS8 MOV21