YARN-9607. Auto-configuring rollover-size of IFile format for non-appendable filesystems. Contributed by Adam Antal

+import org.apache.hadoop.fs.CommonPathCapabilities;
+import org.apache.hadoop.fs.FileSystem;
+import org.apache.hadoop.fs.LocalFileSystem;
-import org.apache.hadoop.yarn.exceptions.YarnRuntimeException;
-    // Currently, we need the underlying File System to support append
-    // operation. Will remove this check after we finish
-    // LogAggregationIndexedFileController for non-append mode.
-    boolean append = conf.getBoolean(LOG_AGGREGATION_FS_SUPPORT_APPEND, true);
-    if (!append) {
-      throw new YarnRuntimeException("The configuration:"
-          + LOG_AGGREGATION_FS_SUPPORT_APPEND + " is set as False. We can only"
-          + " use LogAggregationIndexedFileController when the FileSystem "
-          + "support append operations.");
-    }
-    return 1024L * 1024 * 1024 * conf.getInt(
-        LOG_ROLL_OVER_MAX_FILE_SIZE_GB, 10);
+    boolean supportAppend = false;
+    try {
+      FileSystem fs = FileSystem.get(remoteRootLogDir.toUri(), conf);
+      if (fs instanceof LocalFileSystem || fs.hasPathCapability(
+          remoteRootLogDir, CommonPathCapabilities.FS_APPEND)) {
+        supportAppend = true;
+      }
+    } catch (Exception ioe) {
+      LOG.warn("Unable to determine if the filesystem supports " +
+          "append operation", ioe);
+    }
+    if (supportAppend) {
+      return 1024L * 1024 * 1024 * conf.getInt(
+          LOG_ROLL_OVER_MAX_FILE_SIZE_GB, 10);
+    } else {
+      return 0L;
+    }

MOV26 INS26 INS26 INS40 UPD40 INS40 INS8 INS60 INS54 INS25 INS39 INS59 INS8 INS12 INS42 MOV8 INS8 INS42 INS9 INS60 INS25 INS44 INS8 INS41 INS43 INS59 INS27 INS8 INS43 INS42 INS21 INS34 INS42 INS42 INS32 INS62 INS32 INS21 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS43 INS42 INS42 INS42 INS40 INS7 INS42 INS42 INS27 INS42 INS42 INS42 INS42 INS42 INS9 INS45 INS45 DEL39 DEL42 DEL42 DEL42 DEL42 DEL9 DEL32 DEL59 DEL60 DEL42 DEL38 DEL42 DEL43 DEL45 DEL42 DEL45 DEL45 DEL45 DEL27 DEL14 DEL53 DEL8 DEL25