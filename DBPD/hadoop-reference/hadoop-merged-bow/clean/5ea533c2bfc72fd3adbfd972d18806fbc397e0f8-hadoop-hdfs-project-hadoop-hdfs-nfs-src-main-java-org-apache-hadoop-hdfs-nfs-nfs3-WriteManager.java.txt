HDFS-5563. NFS gateway should commit the buffered data when read request comes after write to the same file. Contributed by Brandon Li

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1546233 13f79535-47bb-0310-9956-ffa450edef68

-import java.util.concurrent.ConcurrentMap;
-import org.apache.hadoop.util.Daemon;
-import com.google.common.collect.Maps;
+  // Do a possible commit before read request in case there is buffered data
+  // inside DFSClient which has been flushed but not synced.
+  int commitBeforeRead(DFSClient dfsClient, FileHandle fileHandle,
+      long commitOffset) {
+    int status;
+    OpenFileCtx openFileCtx = fileContextCache.get(fileHandle);
+
+    if (openFileCtx == null) {
+      if (LOG.isDebugEnabled()) {
+        LOG.debug("No opened stream for fileId:" + fileHandle.getFileId()
+            + " commitOffset=" + commitOffset
+            + ". Return success in this case.");
+      }
+      status = Nfs3Status.NFS3_OK;
+
+    } else {
+      COMMIT_STATUS ret = openFileCtx.checkCommit(dfsClient, commitOffset,
+          null, 0, null, true);
+      switch (ret) {
+      case COMMIT_FINISHED:
+      case COMMIT_INACTIVE_CTX:
+        status = Nfs3Status.NFS3_OK;
+        break;
+      case COMMIT_INACTIVE_WITH_PENDING_WRITE:
+      case COMMIT_ERROR:
+        status = Nfs3Status.NFS3ERR_IO;
+        break;
+      case COMMIT_WAIT:
+        /**
+         * This should happen rarely in some possible cases, such as read
+         * request arrives before DFSClient is able to quickly flush data to DN,
+         * or Prerequisite writes is not available. Won't wait since we don't
+         * want to block read.
+         */     
+        status = Nfs3Status.NFS3ERR_JUKEBOX;
+        break;
+      default:
+        LOG.error("Should not get commit return code:" + ret.name());
+        throw new RuntimeException("Should not get commit return code:"
+            + ret.name());
+      }
+    }
+    return status;
+  }
+  
-          channel, xid, preOpAttr);
+          channel, xid, preOpAttr, false);
-      case COMMIT_DO_SYNC:
+        LOG.error("Should not get commit return code:" + ret.name());

INS31 INS39 INS42 INS44 INS44 INS44 INS8 INS43 INS42 INS43 INS42 INS39 INS42 INS60 INS60 INS25 INS41 INS42 INS42 INS39 INS59 INS43 INS59 INS27 INS8 INS8 INS42 INS42 INS42 INS42 INS32 INS42 INS33 INS25 INS21 INS60 INS50 INS42 INS42 INS42 INS32 INS8 INS7 MOV43 INS59 INS42 MOV49 MOV49 MOV21 INS10 MOV49 MOV49 MOV21 INS10 MOV49 INS21 INS10 INS49 INS21 INS53 INS43 INS49 INS21 INS49 INS49 INS21 INS49 INS21 INS42 INS42 INS21 INS42 INS40 INS42 INS32 INS7 INS32 INS14 INS42 UPD42 INS42 INS7 INS42 INS42 INS7 INS42 INS32 INS32 INS42 INS42 INS42 INS42 INS33 INS34 INS33 INS9 INS42 INS40 INS42 INS42 INS27 INS43 INS27 INS9 INS42 INS40 INS42 INS40 INS42 INS42 INS27 INS42 INS42 INS27 INS45 INS32 INS42 INS45 INS32 INS45 INS32 INS45 INS32 INS45 INS42 INS45 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL40 DEL26 DEL40 DEL26 DEL40 DEL26