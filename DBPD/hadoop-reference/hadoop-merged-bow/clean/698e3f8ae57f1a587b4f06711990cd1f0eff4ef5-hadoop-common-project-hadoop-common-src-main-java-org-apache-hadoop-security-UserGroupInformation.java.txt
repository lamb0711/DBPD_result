Merging trunk to branch HDFS-2802

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-2802@1460410 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.fs.Path;
-import org.apache.hadoop.security.authentication.util.KerberosName;
-  /** Are the static variables that depend on configuration initialized? */
-  private static boolean isInitialized = false;
-    if (!isInitialized) {
-        initialize(new Configuration(), KerberosName.hasRulesBeenSet());
+    if (conf == null) {
+      initialize(new Configuration(), false);
-  private static synchronized void initialize(Configuration conf, boolean skipRulesSetting) {
-    initUGI(conf);
-    // give the configuration on how to translate Kerberos names
-    try {
-      if (!skipRulesSetting) {
-        HadoopKerberosName.setConfiguration(conf);
-      }
-    } catch (IOException ioe) {
-      throw new RuntimeException("Problem with Kerberos auth_to_local name " +
-          "configuration", ioe);
-    }
-  }
-  
-  /**
-   * Set the configuration values for UGI.
-   * @param conf the configuration to use
-   */
-  private static synchronized void initUGI(Configuration conf) {
+  private static synchronized void initialize(Configuration conf,
+                                              boolean overrideNameRules) {
+    if (overrideNameRules || !HadoopKerberosName.hasRulesBeenSet()) {
+      try {
+        HadoopKerberosName.setConfiguration(conf);
+      } catch (IOException ioe) {
+        throw new RuntimeException(
+            "Problem with Kerberos auth_to_local name configuration", ioe);
+      }
+    }
-    isInitialized = true;
-    initialize(conf, false);
+    initialize(conf, true);
+  }
+  
+  @InterfaceAudience.Private
+  @VisibleForTesting
+  static void reset() {
+    authenticationMethod = null;
+    conf = null;
+    groups = null;
+    kerberosMinSecondsBeforeRelogin = 0;
+    setLoginUser(null);
+    HadoopKerberosName.setRules(null);

INS31 MOV29 UPD42 INS44 INS78 INS78 MOV83 MOV39 UPD42 MOV42 INS8 INS39 INS42 INS25 INS40 INS42 INS21 INS21 INS21 INS21 INS21 INS21 INS27 INS27 MOV8 INS7 INS7 INS7 INS7 INS32 INS32 INS42 INS33 INS42 INS38 UPD9 INS42 INS33 INS42 INS33 INS42 INS33 INS42 INS34 INS42 INS33 INS42 INS42 INS33 INS32 MOV8 INS9 INS42 INS42 INS45 DEL40 DEL26 DEL40 DEL26 DEL66 DEL65 DEL29 DEL83 DEL83 DEL39 DEL42 DEL9 DEL59 DEL23 DEL42 DEL38 DEL42 DEL42 DEL32 DEL83 DEL83 DEL42 DEL43 DEL42 DEL44 DEL39 DEL42 DEL44 DEL31 DEL66 DEL65 DEL42 DEL66 DEL65 DEL29 DEL42 DEL42 DEL32 DEL21 DEL42 DEL38 DEL25 DEL8 DEL45 DEL45 DEL27 DEL42 DEL9 DEL7 DEL21