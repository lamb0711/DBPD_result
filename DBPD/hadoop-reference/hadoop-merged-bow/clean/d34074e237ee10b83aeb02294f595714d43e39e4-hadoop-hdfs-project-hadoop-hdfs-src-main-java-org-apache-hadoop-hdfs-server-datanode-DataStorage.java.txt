HDFS-7575. Upgrade should generate a unique storage ID for each volume. (Contributed by Arpit Agarwal)

+import org.apache.hadoop.hdfs.server.blockmanagement.DatanodeStorageInfo;
-  /** Create an ID for this storage. */
-  public synchronized void createStorageID(StorageDirectory sd) {
-    if (sd.getStorageUuid() == null) {
+  /** Create an ID for this storage.
+   * @return true if a new storage ID was generated.
+   * */
+  public synchronized boolean createStorageID(
+      StorageDirectory sd, boolean regenerateStorageIds) {
+    final String oldStorageID = sd.getStorageUuid();
+    if (oldStorageID == null || regenerateStorageIds) {
+      LOG.info("Generated new storageID " + sd.getStorageUuid() +
+          " for directory " + sd.getRoot() +
+          (oldStorageID == null ? "" : (" to replace " + oldStorageID)));
+      return true;
+    return false;
-    
-    // After addition of the federation feature, ctime check is only 
-    // meaningful at BlockPoolSliceStorage level. 
-    // regular start up. 
+    // Clusters previously upgraded from layout versions earlier than
+    // ADD_DATANODE_AND_STORAGE_UUIDS failed to correctly generate a
+    // new storage ID. We check for that and fix it now.
+    boolean haveValidStorageId =
+        DataNodeLayoutVersion.supports(
+            LayoutVersion.Feature.ADD_DATANODE_AND_STORAGE_UUIDS, layoutVersion) &&
+            DatanodeStorage.isValidStorageId(sd.getStorageUuid());
+
+    // regular start up.
-      createStorageID(sd);
+      createStorageID(sd, !haveValidStorageId);
-    
+
-      createStorageID(sd);
+      createStorageID(sd, !haveValidStorageId);

INS26 INS40 UPD39 INS44 INS65 INS39 INS42 INS60 INS41 INS60 UPD66 INS66 INS83 INS43 INS59 INS27 INS9 INS39 INS59 INS42 INS42 INS32 INS27 INS42 INS21 INS41 INS42 INS27 INS42 INS42 INS42 MOV33 INS32 INS9 INS32 INS32 INS42 INS42 INS27 INS42 INS42 INS40 INS42 INS42 INS42 INS32 INS38 INS38 INS45 MOV32 INS45 INS32 INS36 INS42 INS42 INS42 INS42 INS42 INS42 INS16 INS27 INS45 INS36 INS42 INS33 INS27 INS45 INS42 DEL27