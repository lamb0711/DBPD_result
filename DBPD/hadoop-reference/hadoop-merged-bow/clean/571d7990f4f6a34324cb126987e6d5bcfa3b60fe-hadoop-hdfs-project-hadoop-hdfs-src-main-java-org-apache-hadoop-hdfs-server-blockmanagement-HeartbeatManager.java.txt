Merge trunk into HA branch


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-1623@1196458 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.hdfs.server.namenode.FSNamesystem;
+import org.apache.hadoop.hdfs.server.namenode.Namesystem;
-  final FSNamesystem namesystem;
+  final Namesystem namesystem;
+  final BlockManager blockManager;
-  HeartbeatManager(final FSNamesystem namesystem, final Configuration conf) {
+  HeartbeatManager(final Namesystem namesystem, final BlockManager blockManager,
+      final Configuration conf) {
+    this.blockManager = blockManager;
+  @Override
+  public synchronized int getExpiredHeartbeats() {
+    return stats.expiredHeartbeats;
+  }
+
-    final DatanodeManager dm = namesystem.getBlockManager().getDatanodeManager();
+    final DatanodeManager dm = blockManager.getDatanodeManager();
-            namesystem.incrExpiredHeartbeats();
+            stats.incrExpiredHeartbeats();
-          if (namesystem.getBlockManager().shouldUpdateBlockKey(
-              now - lastBlockKeyUpdate)) {
+          if (blockManager.shouldUpdateBlockKey(now - lastBlockKeyUpdate)) {
+    private int expiredHeartbeats = 0;
+
+    
+    /** Increment expired heartbeat counter. */
+    private void incrExpiredHeartbeats() {
+      expiredHeartbeats++;
+    }

UPD40 INS23 INS31 UPD43 INS83 INS43 INS59 INS44 INS78 INS83 INS83 INS39 INS42 INS8 INS23 INS31 UPD42 INS42 INS42 UPD43 INS83 INS43 INS42 INS21 INS42 INS41 INS83 INS39 INS59 INS29 INS83 INS39 INS42 INS8 UPD42 INS42 INS7 INS40 INS42 INS34 INS65 INS21 INS22 INS42 INS66 INS37 INS52 INS42 UPD42 MOV42 INS42 UPD42 MOV42 UPD42 DEL42 DEL32 DEL42 DEL32