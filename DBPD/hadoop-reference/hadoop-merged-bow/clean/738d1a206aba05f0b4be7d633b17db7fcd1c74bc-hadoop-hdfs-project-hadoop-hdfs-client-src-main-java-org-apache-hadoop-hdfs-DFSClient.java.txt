HDFS-12754. Lease renewal can hit a deadlock. Contributed by Kuhu Shukla.

-    getLeaseRenewer().put(inodeId, out, this);
+    synchronized (filesBeingWritten) {
+      putFileBeingWritten(inodeId, out);
+      getLeaseRenewer().put(this);
+    }
-    getLeaseRenewer().closeFile(inodeId, this);
+    synchronized (filesBeingWritten) {
+      removeFileBeingWritten(inodeId);
+      // remove client from renewer if no files are open
+      if (filesBeingWritten.isEmpty()) {
+        getLeaseRenewer().closeClient(this);
+      }
+    }
+      // lease renewal stops when all files are closed
-      getLeaseRenewer().closeClient(this);

INS8 INS8 INS51 INS51 INS42 INS8 INS42 INS8 MOV21 INS21 MOV21 INS25 INS32 INS32 INS8 UPD42 MOV32 INS42 INS52 UPD42 INS42 INS42 MOV21 DEL52 DEL8 DEL42 DEL32 DEL52 DEL8