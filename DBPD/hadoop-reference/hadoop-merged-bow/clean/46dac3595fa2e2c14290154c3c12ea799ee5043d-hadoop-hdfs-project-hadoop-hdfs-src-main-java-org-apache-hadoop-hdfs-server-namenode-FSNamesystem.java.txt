HDFS-7864. Erasure Coding: Update safemode calculation for striped blocks. Contributed by GAO Rui.

+import org.apache.hadoop.hdfs.server.blockmanagement.BlockInfoStriped;
-     * @param replication current replication 
+     * @param storageNum current number of replicas or number of internal blocks
+     *                   of a striped block group
+     * @param storedBlock current storedBlock which is either a
+     *                    BlockInfoContiguous or a BlockInfoStriped
-    private synchronized void incrementSafeBlockCount(short replication) {
-      if (replication == safeReplication) {
+    private synchronized void incrementSafeBlockCount(short storageNum,
+        BlockInfo storedBlock) {
+      final int safe = storedBlock.isStriped() ?
+          ((BlockInfoStriped) storedBlock).getDataBlockNum() : safeReplication;
+      if (storageNum == safe) {
-  public void incrementSafeBlockCount(int replication) {
+  public void incrementSafeBlockCount(int storageNum, BlockInfo storedBlock) {
-    safeMode.incrementSafeBlockCount((short)replication);
+    safeMode.incrementSafeBlockCount((short) storageNum, storedBlock);

INS26 INS40 INS44 INS44 UPD42 INS43 INS42 INS65 UPD42 INS43 INS42 INS60 INS42 UPD42 UPD66 INS66 INS42 INS66 INS66 INS42 INS83 INS39 INS59 INS42 INS42 INS16 UPD42 UPD42 UPD42 INS32 INS32 INS42 INS42 INS42 INS36 INS42 INS11 INS43 INS42 INS42