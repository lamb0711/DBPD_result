HDFS-4877. Snapshot: fix the scenario where a directory is renamed under its prior descendant. Contributed by Jing Zhao.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1490421 13f79535-47bb-0310-9956-ffa450edef68

-      final BlocksMapUpdateInfo collectedBlocks, final List<INode> removedINodes)
+      final BlocksMapUpdateInfo collectedBlocks,
+      final List<INode> removedINodes, boolean countDiffChange) 
-        counts.add(Quota.NAMESPACE, 1);
-        // We add 1 to the namespace quota usage since we delete a diff. 
-        // The quota change will be propagated to 
-        // 1) ancestors in the current tree, and 
-        // 2) src tree of any renamed ancestor.
-        // Because for 2) we do not calculate the number of diff for quota 
-        // usage, we need to compensate this diff change for 2)
-        currentINode.addSpaceConsumedToRenameSrc(1, 0, false, snapshot.getId());
+        if (countDiffChange) {
+          counts.add(Quota.NAMESPACE, 1);
+        } else {
+          // the currentINode must be a descendant of a WithName node, which set
+          // countDiffChange to false. In that case we should count in the diff
+          // change when updating the quota usage in the current tree
+          currentINode.addSpaceConsumed(-1, 0, false);
+        }
-        counts.add(Quota.NAMESPACE, 1);
-        currentINode.addSpaceConsumedToRenameSrc(1, 0, false, snapshot.getId());
+        if (countDiffChange) {
+          counts.add(Quota.NAMESPACE, 1);
+        } else {
+          currentINode.addSpaceConsumed(-1, 0, false);
+        }
-    currentINode.addSpaceConsumed(1, 0, true, Snapshot.INVALID_ID);
+    currentINode.addSpaceConsumed(1, 0, true);

INS44 INS39 INS42 INS25 INS42 INS8 INS8 INS25 MOV21 MOV21 INS42 INS8 INS8 MOV21 MOV21 UPD42 INS38 INS34 UPD42 INS38 INS34 DEL34 DEL42 DEL42 DEL32 DEL34 DEL42 DEL42 DEL32 DEL40