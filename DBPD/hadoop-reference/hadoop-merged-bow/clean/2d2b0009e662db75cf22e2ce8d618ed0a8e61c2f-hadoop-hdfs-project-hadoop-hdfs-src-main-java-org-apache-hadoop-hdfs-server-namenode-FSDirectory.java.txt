Merge branch 'trunk' into HDFS-6584

Conflicts:
	hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java

-import org.apache.hadoop.hdfs.protocol.FsAclPermission;
+import org.apache.hadoop.hdfs.protocol.FsPermissionExtension;
+     final boolean isEncrypted;
+
+     final FileEncryptionInfo feInfo = isRawPath ? null :
+         getFileEncryptionInfo(node, snapshot);
+
+       isEncrypted = (feInfo != null) ||
+           (isRawPath && isInAnEZ(INodesInPath.fromINode(node)));
+     } else {
+       isEncrypted = isInAnEZ(INodesInPath.fromINode(node));
+
-     FileEncryptionInfo feInfo = isRawPath ? null :
-         getFileEncryptionInfo(node, snapshot);
-        getPermissionForFileStatus(node, snapshot),
+        getPermissionForFileStatus(node, snapshot, isEncrypted),
+    final boolean isEncrypted;
+      isEncrypted = (feInfo != null) ||
+          (isRawPath && isInAnEZ(INodesInPath.fromINode(node)));
+    } else {
+      isEncrypted = isInAnEZ(INodesInPath.fromINode(node));
-          getPermissionForFileStatus(node, snapshot),
+          getPermissionForFileStatus(node, snapshot, isEncrypted),
-   * inode has an ACL, then this method will convert to a FsAclPermission.
+   * inode has an ACL or is for an encrypted file/dir, then this method will
+   * return an FsPermissionExtension.
+   * @param isEncrypted boolean true if the file/dir is encrypted
+   * and encrypted bit on if it represents an encrypted file/dir.
-      int snapshot) {
+      int snapshot, boolean isEncrypted) {
-    if (node.getAclFeature(snapshot) != null) {
-      perm = new FsAclPermission(perm);
+    boolean hasAcl = node.getAclFeature(snapshot) != null;
+    if (hasAcl || isEncrypted) {
+      perm = new FsPermissionExtension(perm, hasAcl, isEncrypted);

UPD40 MOV60 INS44 INS60 INS60 INS65 INS39 INS42 INS60 INS83 INS39 INS59 INS83 INS8 INS83 INS39 INS59 INS8 MOV43 UPD66 INS66 INS42 INS66 INS66 INS39 INS59 INS27 INS42 INS21 INS21 INS42 INS21 INS21 INS42 MOV27 INS42 INS42 INS7 INS7 INS42 INS7 INS7 MOV43 INS42 INS27 INS42 INS32 INS42 INS27 INS42 INS32 INS42 INS36 INS36 INS42 INS32 INS36 INS36 INS42 INS32 UPD43 INS42 INS42 INS27 INS27 INS42 INS42 INS42 INS27 INS27 INS42 INS42 INS42 UPD42 INS42 INS33 INS42 INS32 INS42 INS33 INS42 INS32 INS42 INS32 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42