HDFS-3177. Update DFSClient and DataXceiver to handle different checkum types in file checksum computation.  Contributed by Kihwal Lee


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1376928 13f79535-47bb-0310-9956-ffa450edef68

+import org.apache.hadoop.fs.MD5MD5CRC32CastagnoliFileChecksum;
+import org.apache.hadoop.fs.MD5MD5CRC32GzipFileChecksum;
-    int bytesPerCRC = 0;
+    int bytesPerCRC = -1;
+    DataChecksum.Type crcType = DataChecksum.Type.DEFAULT;
+          // read crc-type
+          final DataChecksum.Type ct = HdfsProtoUtil.
+              fromProto(checksumData.getCrcType());
+          if (i == 0) { // first block
+            crcType = ct;
+          } else if (crcType != DataChecksum.Type.MIXED
+              && crcType != ct) {
+            // if crc types are mixed in a file
+            crcType = DataChecksum.Type.MIXED;
+          }
+
-    return new MD5MD5CRC32FileChecksum(bytesPerCRC, crcPerBlock, fileMD5);
+    switch (crcType) {
+      case CRC32:
+        return new MD5MD5CRC32GzipFileChecksum(bytesPerCRC,
+            crcPerBlock, fileMD5);
+      case CRC32C:
+        return new MD5MD5CRC32CastagnoliFileChecksum(bytesPerCRC,
+            crcPerBlock, fileMD5);
+      default:
+        // we should never get here since the validity was checked
+        // when getCrcType() was called above.
+        return null;
+    }

INS26 INS26 INS40 INS40 INS60 INS50 INS43 INS59 INS42 INS49 INS41 INS49 INS41 INS49 INS41 INS38 INS40 INS42 INS40 INS42 MOV14 INS42 INS14 INS33 INS34 UPD43 INS43 INS42 INS42 INS42 UPD42 INS42 INS60 INS25 INS83 INS43 INS59 INS27 INS8 INS25 INS40 INS42 INS32 INS42 INS34 INS21 INS27 INS8 INS42 INS42 INS32 INS7 INS27 INS27 INS21 INS42 INS42 INS42 INS42 INS42 INS40 INS42 INS42 INS7 INS42 INS40 DEL34 DEL41