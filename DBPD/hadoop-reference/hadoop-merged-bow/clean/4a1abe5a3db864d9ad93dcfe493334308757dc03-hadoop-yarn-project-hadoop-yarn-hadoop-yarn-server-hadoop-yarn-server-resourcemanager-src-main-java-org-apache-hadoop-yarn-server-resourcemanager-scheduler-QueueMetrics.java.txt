Merge r1555021 through r1558254 from trunk.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/HDFS-5535@1558303 13f79535-47bb-0310-9956-ffa450edef68

-import org.apache.hadoop.yarn.server.resourcemanager.rmapp.attempt.RMAppAttemptState;
+import org.apache.hadoop.yarn.server.resourcemanager.rmapp.RMAppState;
-  @Metric("# of apps failed") MutableGaugeInt appsFailed;
+  @Metric("# of apps failed") MutableCounterInt appsFailed;
-  public void submitApp(String user, int attemptId) {
-    if (attemptId == 1) {
-      appsSubmitted.incr();
-    } else {
-      appsFailed.decr();
-    }
-    appsPending.incr();
+  public void submitApp(String user) {
+    appsSubmitted.incr();
-      userMetrics.submitApp(user, attemptId);
+      userMetrics.submitApp(user);
-      parent.submitApp(user, attemptId);
+      parent.submitApp(user);
-  public void incrAppsRunning(AppSchedulingInfo app, String user) {
-    runBuckets.add(app.getApplicationId(), System.currentTimeMillis());
+  public void submitAppAttempt(String user) {
+    appsPending.incr();
+    QueueMetrics userMetrics = getUserMetrics(user);
+    if (userMetrics != null) {
+      userMetrics.submitAppAttempt(user);
+    }
+    if (parent != null) {
+      parent.submitAppAttempt(user);
+    }
+  }
+
+  public void runAppAttempt(ApplicationId appId, String user) {
+    runBuckets.add(appId, System.currentTimeMillis());
-      userMetrics.incrAppsRunning(app, user);
+      userMetrics.runAppAttempt(appId, user);
-      parent.incrAppsRunning(app, user);
+      parent.runAppAttempt(appId, user);
-  public void finishApp(AppSchedulingInfo app,
-      RMAppAttemptState rmAppAttemptFinalState) {
-    runBuckets.remove(app.getApplicationId());
-    switch (rmAppAttemptFinalState) {
-      case KILLED: appsKilled.incr(); break;
-      case FAILED: appsFailed.incr(); break;
-      default: appsCompleted.incr();  break;
-    }
-    if (app.isPending()) {
+  public void finishAppAttempt(
+      ApplicationId appId, boolean isPending, String user) {
+    runBuckets.remove(appId);
+    if (isPending) {
-    QueueMetrics userMetrics = getUserMetrics(app.getUser());
+    QueueMetrics userMetrics = getUserMetrics(user);
-      userMetrics.finishApp(app, rmAppAttemptFinalState);
+      userMetrics.finishAppAttempt(appId, isPending, user);
-      parent.finishApp(app, rmAppAttemptFinalState);
+      parent.finishAppAttempt(appId, isPending, user);
+    }
+  }
+
+  public void finishApp(String user, RMAppState rmAppFinalState) {
+    switch (rmAppFinalState) {
+      case KILLED: appsKilled.incr(); break;
+      case FAILED: appsFailed.incr(); break;
+      default: appsCompleted.incr();  break;
+    }
+    QueueMetrics userMetrics = getUserMetrics(user);
+    if (userMetrics != null) {
+      userMetrics.finishApp(user, rmAppFinalState);
+    }
+    if (parent != null) {
+      parent.finishApp(user, rmAppFinalState);
+  
+  public MetricsSystem getMetricsSystem() {
+    return metricsSystem;
+  }

UPD40 INS31 INS31 INS31 UPD43 INS83 INS39 INS42 MOV44 INS8 UPD42 UPD42 UPD42 INS44 INS83 INS39 INS42 INS44 INS44 INS8 INS83 INS43 INS42 INS8 UPD42 MOV21 MOV60 INS25 INS25 INS43 INS42 INS60 UPD43 UPD42 UPD43 UPD42 INS39 INS42 UPD43 UPD42 INS43 INS42 INS43 INS42 MOV50 INS60 INS25 INS25 INS42 INS41 MOV27 INS8 MOV27 INS8 INS42 INS43 INS59 INS27 INS27 UPD42 UPD42 UPD42 INS42 INS42 INS42 UPD42 INS43 INS59 INS27 INS8 INS27 INS8 INS42 INS21 INS21 INS42 INS42 INS32 INS42 INS33 INS42 INS33 UPD42 MOV42 UPD42 MOV42 INS42 INS42 INS32 INS42 INS33 INS21 INS42 INS33 INS21 INS32 INS32 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 INS42 INS42 INS32 INS32 INS42 INS42 INS42 INS42 INS42 INS42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 INS42 UPD42 UPD42 UPD42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL39 DEL42 DEL42 DEL34 DEL27 DEL8 DEL32 DEL21 DEL8 DEL25 DEL42 DEL42 DEL42 DEL32 DEL42 DEL32 DEL42 DEL42 DEL32 DEL42 DEL32