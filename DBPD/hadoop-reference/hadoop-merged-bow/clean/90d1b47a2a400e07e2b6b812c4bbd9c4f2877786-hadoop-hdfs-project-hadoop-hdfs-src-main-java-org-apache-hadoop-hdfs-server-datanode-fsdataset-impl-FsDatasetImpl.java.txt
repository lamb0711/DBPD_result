HDFS-12776. [READ] Increasing replication for PROVIDED files should create local replicas

+  private boolean isReplicaProvided(ReplicaInfo replicaInfo) {
+    if (replicaInfo == null) {
+      return false;
+    }
+    return replicaInfo.getVolume().getStorageType() == StorageType.PROVIDED;
+  }
+
-           * If the current block is old, reject.
+           * If the current block is not PROVIDED and old, reject.
+           * If current block is PROVIDED, ignore the replica.
-          if ((currentReplicaInfo.getGenerationStamp() >= b.getGenerationStamp())
-              || (!isTransfer && !isInPipeline)) {
+          if (((currentReplicaInfo.getGenerationStamp() >= b
+              .getGenerationStamp()) || (!isTransfer && !isInPipeline))
+              && !isReplicaProvided(currentReplicaInfo)) {
+      // if lastFoundReplicaInfo is PROVIDED and FINALIZED,
+      // stopWriter isn't required.
+      if (isReplicaProvided(lastFoundReplicaInfo) &&
+          lastFoundReplicaInfo.getState() == ReplicaState.FINALIZED) {
+        continue;
+      }
-
-    if (lastFoundReplicaInfo != null) {
+    if (lastFoundReplicaInfo != null
+        && !isReplicaProvided(lastFoundReplicaInfo)) {

INS31 INS83 INS39 INS42 INS44 INS8 INS43 INS42 INS25 INS41 INS42 INS27 INS8 INS27 INS27 INS42 INS33 INS41 INS32 INS40 INS25 MOV27 INS38 INS9 INS32 INS42 INS27 INS8 INS32 INS42 INS42 INS32 INS27 INS18 INS42 INS42 INS42 INS42 INS32 INS40 INS42 INS42 INS27 INS36 INS38 MOV27 INS32 INS42 INS42