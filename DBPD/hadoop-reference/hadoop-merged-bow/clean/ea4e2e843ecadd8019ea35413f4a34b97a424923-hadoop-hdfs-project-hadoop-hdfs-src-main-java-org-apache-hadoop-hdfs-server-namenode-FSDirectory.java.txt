HDFS-6705. Create an XAttr that disallows the HDFS admin from accessing a file. (clamb via wang)

+import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.SECURITY_XATTR_UNREADABLE_BY_SUPERUSER;
+import org.apache.hadoop.security.AccessControlException;
+  private final XAttr UNREADABLE_BY_SUPERUSER_XATTR =
+      XAttrHelper.buildXAttr(SECURITY_XATTR_UNREADABLE_BY_SUPERUSER, null);
-      final List<XAttr> toFilter, final List<XAttr> filtered) {
+      final List<XAttr> toFilter, final List<XAttr> filtered)
+    throws AccessControlException {
+        if (UNREADABLE_BY_SUPERUSER_XATTR.equalsIgnoreValue(filter)) {
+          throw new AccessControlException("The xattr '" +
+              SECURITY_XATTR_UNREADABLE_BY_SUPERUSER + "' can not be deleted.");
+        }
+    final boolean isFile = inode.isFile();
-    /*
-     * If we're adding the encryption zone xattr, then add src to the list
-     * of encryption zones.
-     */
+
+      /*
+       * If we're adding the encryption zone xattr, then add src to the list
+       * of encryption zones.
+       */
+
+      if (!isFile && SECURITY_XATTR_UNREADABLE_BY_SUPERUSER.equals(xaName)) {
+        throw new IOException("Can only set '" +
+            SECURITY_XATTR_UNREADABLE_BY_SUPERUSER + "' on a file.");
+      }
-      return XAttrStorage.readINodeXAttrs(inode, snapshotId);
+      return unprotectedGetXAttrs(inode, snapshotId);
+  List<XAttr> getXAttrs(INode inode, int snapshotId) throws IOException {
+    readLock();
+    try {
+      return unprotectedGetXAttrs(inode, snapshotId);
+    } finally {
+      readUnlock();
+    }
+  }
+
+  private List<XAttr> unprotectedGetXAttrs(INode inode, int snapshotId)
+      throws IOException {
+    return XAttrStorage.readINodeXAttrs(inode, snapshotId);
+  }
+

INS26 INS26 INS40 INS40 INS23 INS31 INS31 INS83 INS83 INS43 INS59 INS43 INS74 INS42 INS44 INS44 INS43 INS8 INS83 INS74 INS42 INS44 INS44 INS43 INS8 INS42 INS42 INS32 INS42 INS60 INS43 INS43 INS43 INS42 INS39 INS42 INS42 INS21 INS54 INS43 INS43 INS43 INS42 INS39 INS42 INS42 MOV41 INS42 INS42 INS42 INS33 INS83 INS39 INS59 INS42 INS42 INS42 INS32 INS8 INS8 INS42 INS42 INS42 INS42 INS32 INS25 INS41 INS42 INS41 INS21 INS42 INS42 INS27 INS8 INS32 INS32 INS32 INS25 INS38 INS32 INS53 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS8 INS42 INS42 INS42 INS42 INS14 INS42 INS42 INS42 INS53 INS43 INS27 INS14 INS42 INS45 INS42 INS45 INS43 INS27 INS42 INS45 INS42 INS45