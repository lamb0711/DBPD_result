HDFS-4477. Secondary namenode may retain old tokens. Contributed by Daryn Sharp.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1467307 13f79535-47bb-0310-9956-ffa450edef68

+import java.util.HashSet;
+import java.util.Set;
+  protected void logExpireToken(TokenIdent ident) throws IOException {
+    return;
+  }
+
-  private synchronized void removeExpiredToken() {
+  private void removeExpiredToken() throws IOException {
-    Iterator<DelegationTokenInformation> i = currentTokens.values().iterator();
-    while (i.hasNext()) {
-      long renewDate = i.next().getRenewDate();
-      if (now > renewDate) {
-        i.remove();
+    Set<TokenIdent> expiredTokens = new HashSet<TokenIdent>();
+    synchronized (this) {
+      Iterator<Map.Entry<TokenIdent, DelegationTokenInformation>> i =
+          currentTokens.entrySet().iterator();
+      while (i.hasNext()) {
+        Map.Entry<TokenIdent, DelegationTokenInformation> entry = i.next();
+        long renewDate = entry.getValue().getRenewDate();
+        if (renewDate < now) {
+          expiredTokens.add(entry.getKey());
+          i.remove();
+        }
+    // don't hold lock on 'this' to avoid edit log updates blocking token ops
+    for (TokenIdent ident : expiredTokens) {
+      logExpireToken(ident);
+    }

INS26 INS26 INS40 INS40 INS31 INS83 INS39 INS42 INS44 INS43 INS8 INS43 INS8 INS43 INS42 INS42 INS41 INS42 MOV60 INS60 INS51 INS70 INS42 INS74 INS59 INS52 INS8 INS44 INS42 INS8 INS43 INS43 INS42 INS14 MOV60 MOV61 INS43 INS42 INS21 INS42 INS42 INS74 UPD74 INS42 INS32 INS43 INS43 INS74 INS60 INS42 INS42 INS42 INS42 INS43 INS43 MOV43 INS74 INS39 INS59 UPD27 INS40 INS42 UPD42 INS43 INS43 INS43 UPD42 MOV32 INS42 INS32 INS42 INS21 INS40 INS42 INS42 INS32 INS42 INS32 INS42 INS42 INS42 INS42 INS32 INS42 INS42 DEL83 DEL39 DEL42 DEL32 DEL42 DEL8