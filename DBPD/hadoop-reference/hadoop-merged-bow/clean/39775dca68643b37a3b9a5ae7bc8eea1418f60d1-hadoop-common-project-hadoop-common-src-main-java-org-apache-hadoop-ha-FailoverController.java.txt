Revert HADOOP-8193 from r1304967. Patch introduced some NPEs in a test case.


git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/trunk@1305152 13f79535-47bb-0310-9956-ffa450edef68

+import java.net.InetSocketAddress;
-   * @param target service to make active
+   * @param toSvc service to make active
+   * @param toSvcName name of service to make active
-  private static void preFailoverChecks(HAServiceTarget target,
+  private static void preFailoverChecks(HAServiceProtocol toSvc,
+                                        InetSocketAddress toSvcAddr,
-    HAServiceProtocol toSvc;
-      toSvc = target.getProxy();
-      String msg = "Unable to get service state for " + target;
+      String msg = "Unable to get service state for " + toSvcAddr;
-            target + " is not ready to become active: " +
+            toSvcAddr + " is not ready to become active: " +
+   * @param fromSvcAddr addr of the currently active service
+   * @param toSvcAddr addr of the service to make active
+   * @param fencer for fencing fromSvc
-  public static void failover(HAServiceTarget fromSvc,
-                              HAServiceTarget toSvc,
+  public static void failover(HAServiceProtocol fromSvc,
+                              InetSocketAddress fromSvcAddr,
+                              HAServiceProtocol toSvc,
+                              InetSocketAddress toSvcAddr,
+                              NodeFencer fencer,
-    Preconditions.checkArgument(fromSvc.getFencer() != null,
-        "failover requires a fencer");
-    preFailoverChecks(toSvc, forceActive);
+    Preconditions.checkArgument(fencer != null, "failover requires a fencer");
+    preFailoverChecks(toSvc, toSvcAddr, forceActive);
-      HAServiceProtocolHelper.transitionToStandby(fromSvc.getProxy());
+      HAServiceProtocolHelper.transitionToStandby(fromSvc);
-      LOG.warn("Unable to make " + fromSvc + " standby (" +
+      LOG.warn("Unable to make " + fromSvcAddr + " standby (" +
-      LOG.warn("Unable to make " + fromSvc +
+      LOG.warn("Unable to make " + fromSvcAddr +
-      if (!fromSvc.getFencer().fence(fromSvc)) {
+      if (!fencer.fence(fromSvcAddr)) {
-            fromSvc + ". Fencing failed.");
+            fromSvcAddr + ". Fencing failed.");
-      HAServiceProtocolHelper.transitionToActive(toSvc.getProxy());
+      HAServiceProtocolHelper.transitionToActive(toSvc);
-      LOG.error("Unable to make " + toSvc + " active (" +
+      LOG.error("Unable to make " + toSvcAddr + " active (" +
-      LOG.error("Unable to make " + toSvc +
+      LOG.error("Unable to make " + toSvcAddr +
-      String msg = "Unable to failover to " + toSvc;
+      String msg = "Unable to failover to " + toSvcAddr;
-          failover(toSvc, fromSvc, true, true);
+          failover(toSvc, toSvcAddr, fromSvc, fromSvcAddr, fencer, true, true);
-          msg += ". Failback to " + fromSvc +
+          msg += ". Failback to " + fromSvcAddr +

INS26 INS40 INS44 INS44 INS44 INS44 INS65 MOV43 INS42 UPD43 UPD42 INS65 INS65 INS65 UPD43 INS43 INS42 UPD43 INS43 INS42 INS43 INS42 UPD42 INS42 INS66 UPD42 INS42 INS66 INS42 INS66 INS42 INS66 UPD42 INS42 UPD42 INS42 INS42 INS42 INS42 MOV42 MOV42 UPD42 MOV42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 UPD42 INS42 INS42 INS42 UPD42 DEL42 DEL59 DEL60 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL42 DEL42 DEL32 DEL42 DEL32 DEL42 DEL32 DEL42 DEL32