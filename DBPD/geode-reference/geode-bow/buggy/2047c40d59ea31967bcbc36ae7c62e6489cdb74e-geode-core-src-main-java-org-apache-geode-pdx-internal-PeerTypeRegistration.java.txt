Revert "GEODE-6973: Use cachelistener to synchronize typeToId with IdToType râ€¦ (#3853)"

This reverts commit 181e3a4a

-import org.apache.geode.annotations.VisibleForTesting;
-          updateLocalMaps((PdxType) value);
+          updateClassToTypeMap((PdxType) value);
-
-      if (typeToId.isEmpty()) {
-        buildTypeToIdFromIdToType();
-      }
-      // double check if my type is in region in case the typeToId map has been updated while
-      // waiting to obtain a lock
-      existingId = typeToId.get(newType);
-      if (existingId != null) {
-        return existingId;
+      int id = getExistingIdForType(newType);
+      if (id != -1) {
+        return id;
-      int id = allocateTypeId(newType);
+      id = allocateTypeId(newType);
+
+
+      typeToId.put(newType, id);
+
-  private void buildTypeToIdFromIdToType() {
+  /** Should be called holding the dlock */
+  private int getExistingIdForType(PdxType newType) {
+      int result = -1;
-            if (totalPdxTypeIdInDS >= this.maxTypeId) {
-              throw new InternalGemFireError(
-                  "Used up all of the PDX type ids for this distributed system. The maximum number of PDX types is "
-                      + this.maxTypeId);
-            }
+          if (foundType.equals(newType)) {
+            result = foundType.getTypeId();
+          }
+      if (totalPdxTypeIdInDS == this.maxTypeId) {
+        throw new InternalGemFireError(
+            "Used up all of the PDX type ids for this distributed system. The maximum number of PDX types is "
+                + this.maxTypeId);
+      }
+      return result;
-  private void updateLocalMaps(PdxType type) {
+  private void updateClassToTypeMap(PdxType type) {
-      typeToId.put(type, type.getTypeId());
-
-  @VisibleForTesting
-  public int getTypeToIdSize() {
-    return typeToId.size();
-  }
