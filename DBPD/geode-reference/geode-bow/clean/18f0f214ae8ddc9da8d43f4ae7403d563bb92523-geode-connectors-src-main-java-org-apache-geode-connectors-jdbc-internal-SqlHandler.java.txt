GEODE-6461: Report errors when table metadata and region mapping do not match (#3256)

Co-authored-by: Ben Ross <bross@pivotal.io>
Co-authored-by: Darrel Schneider <dschneider@pivotal.io>
Co-authored-by: Jianxia Chen <jchen@pivotal.io>

-  private final TableMetaDataManager tableMetaDataManager;
+  private final TableMetaDataView tableMetaData;
-  private final Map<String, FieldMapping> jdbcToFieldMappings = new HashMap<>();
-    this.tableMetaDataManager = tableMetaDataManager;
+    this.tableMetaData = getTableMetaDataView(tableMetaDataManager);
+    cache.getService(JdbcConnectorService.class).validateMapping(regionMapping, dataSource);
+  private TableMetaDataView getTableMetaDataView(TableMetaDataManager tableMetaDataManager) {
+    try (Connection connection = getConnection()) {
+      return tableMetaDataManager.getTableMetaDataView(connection, regionMapping);
+    } catch (SQLException ex) {
+      throw new JdbcConnectorException("Could not connect to datasource \""
+          + regionMapping.getDataSourceName() + "\" because: " + ex);
+    }
+  }
+
-      this.jdbcToFieldMappings.put(fieldMapping.getJdbcName(), fieldMapping);
-      if (!fieldMapping.getPdxName().isEmpty()) {
-        this.pdxToFieldMappings.put(fieldMapping.getPdxName(), fieldMapping);
-      }
+      this.pdxToFieldMappings.put(fieldMapping.getPdxName(), fieldMapping);
-    FieldMapping exactMatch = this.pdxToFieldMappings.get(fieldName);
-    if (exactMatch != null) {
-      return exactMatch.getJdbcName();
+    FieldMapping match = this.pdxToFieldMappings.get(fieldName);
+    if (match != null) {
+      return match.getJdbcName();
-    exactMatch = this.jdbcToFieldMappings.get(fieldName);
-    if (exactMatch != null) {
-      this.pdxToFieldMappings.put(fieldName, exactMatch);
-      return exactMatch.getJdbcName();
-    }
-    FieldMapping inexactMatch = null;
-    for (FieldMapping fieldMapping : regionMapping.getFieldMappings()) {
-      if (fieldMapping.getJdbcName().equalsIgnoreCase(fieldName)) {
-        if (inexactMatch != null) {
-          throw new JdbcConnectorException(
-              "Multiple columns matched the pdx field \"" + fieldName + "\".");
-        }
-        inexactMatch = fieldMapping;
-      }
-    }
-    if (inexactMatch == null) {
-      throw new JdbcConnectorException("No column matched the pdx field \"" + fieldName + "\".");
-    }
-    this.pdxToFieldMappings.put(fieldName, inexactMatch);
-    return inexactMatch.getJdbcName();
+    return null;
-      TableMetaDataView tableMetaData =
-          this.tableMetaDataManager.getTableMetaDataView(connection, regionMapping);
-      TableMetaDataView tableMetaData =
-          this.tableMetaDataManager.getTableMetaDataView(connection, regionMapping);
-        if (!keyColumnNames.contains(columnName)) {
+        if (columnName == null || !keyColumnNames.contains(columnName)) {
+      if (columnName == null) {
+        // The user must have added a new field to their pdx domain class.
+        // To support PDX class versioning we will ignore this field.
+        continue;
+      }
