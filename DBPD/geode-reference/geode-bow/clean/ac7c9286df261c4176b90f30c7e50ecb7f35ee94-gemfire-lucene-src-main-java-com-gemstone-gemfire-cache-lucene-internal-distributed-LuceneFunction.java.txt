GEODE-11: Use QueryProvider in LuceneFunction

LuceneFunction needs query object for execution. If the argement is missing,
fail the function execution

https://reviews.apache.org/r/38513/

+import org.apache.lucene.search.Query;
+import com.gemstone.gemfire.cache.lucene.LuceneQueryProvider;
+import com.gemstone.gemfire.cache.query.QueryException;
-  private RepositoryManager repoManager;
+  private static RepositoryManager repoManager;
-    if (logger.isDebugEnabled()) {
-      logger.debug("Executing lucene query on region:" + region.getFullPath());
+
+    LuceneFunctionContext<IndexResultCollector> searchContext = (LuceneFunctionContext) ctx.getArguments();
+    if (searchContext == null) {
+      resultSender.sendException(new IllegalArgumentException("Missing search context"));
+      return;
-    LuceneFunctionContext searchContext = (LuceneFunctionContext) ctx.getArguments();
+    LuceneQueryProvider queryProvider = searchContext.getQueryProvider();
+    if (queryProvider == null) {
+      resultSender.sendException(new IllegalArgumentException("Missing query provider"));
+      return;
+    }
+
+    Query query = null;
+    try {
+      query = queryProvider.getQuery();
+    } catch (QueryException e) {
+      resultSender.sendException(e);
+      return;
+    }
+
+    if (logger.isDebugEnabled()) {
+      logger.debug("Executing lucene query: {}, on region {}", query, region.getFullPath());
+    }
-      Collection<IndexRepository> repositories = repoManager.getRepositories(region, ctx);
+      Collection<IndexRepository> repositories = getIndexRepositories(ctx, region);
-        repo.query(null, 0, collector);
+        repo.query(query, 0, collector);
-  void setRepositoryManager(RepositoryManager manager) {
-    this.repoManager = manager;
+  private Collection<IndexRepository> getIndexRepositories(RegionFunctionContext ctx, Region region) throws BucketNotFoundException {
+    synchronized (LuceneFunction.class) {
+      return repoManager.getRepositories(region, ctx);
+    }
+  }
+
+  static synchronized void setRepositoryManager(RepositoryManager manager) {
+    repoManager = manager;
