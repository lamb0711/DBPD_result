GEODE-8298: Fix multicast version detection (#5370)

Membership decides whether or not use multicast based on the versions
of view members and surprise members. Surprise member version comparison
was backward. Correct version comparison by unifying view and surprise
member processing.

Co-authored-by: Kamilla Aslami <kamilla.1201@gmail.com>
Co-authored-by: Bill Burcham <bill.burcham@gmail.com>
+import java.util.stream.Stream;
-import org.apache.geode.internal.serialization.Version;
-  public void processView(long newViewId, MembershipView<ID> newView) {
+  public void processView(MembershipView<ID> newView) {
-      // first determine the version for multicast message serialization
-      Version version = KnownVersion.CURRENT;
-      for (final Entry<ID, Long> internalIDLongEntry : surpriseMembers
-          .entrySet()) {
-        ID mbr = internalIDLongEntry.getKey();
-        final Version itsVersion = mbr.getVersion();
-        if (itsVersion != null && version.compareTo(itsVersion) < 0) {
-          version = itsVersion;
-        }
-      }
-      for (ID mbr : newView.getMembers()) {
-        final Version itsVersion = mbr.getVersion();
-        if (itsVersion != null && itsVersion.compareTo(version) < 0) {
-          version = mbr.getVersion();
-        }
-      }
-      disableMulticastForRollingUpgrade = !version.equals(KnownVersion.CURRENT);
-
+      setIsMulticastAllowedFrom(newView, surpriseMembers);
-      if (newViewId < priorView.getViewId()) {
+      if (newView.getViewId() < priorView.getViewId()) {
-      long newlatestViewId = newViewId;
+  private void setIsMulticastAllowedFrom(final MembershipView<ID> newView,
+      final Map<ID, Long> surpriseMembers) {
+    disableMulticastForRollingUpgrade =
+        anyMemberHasOlderVersion(
+            Stream.concat(surpriseMembers.keySet().stream(), newView.getMembers().stream()));
+  }
+
+  private boolean anyMemberHasOlderVersion(final Stream<ID> members) {
+    return members
+        .anyMatch(member -> KnownVersion.CURRENT.isNewerThan(member.getVersion()));
+  }
+
-      viewExecutor.submit(() -> processView(viewArg.getViewId(), viewArg));
+      viewExecutor.submit(() -> processView(viewArg));
-      processView(o.gmsView.getViewId(), o.gmsView);
+      processView(o.gmsView);
