GEODE-7663: Fix delta update inconsistency in client cache. (#4618)

* GEODE-7663: Fix delta update inconsistency in client cache.

 * When performing delta update on client, there is a possibility that
   some delta update is not yet applied on client cache.
 * If apply delta update, some queued delta update would be lost -- as
   entry versioning will discard these delta updates when received later.
 * Now it will check if there is a versioning mismatch, if it happened,
   the full value from server will be applied instead of just the delta.


+import org.apache.geode.internal.cache.RegionEntry;
+import org.apache.geode.internal.cache.versions.VersionStamp;
-
-          event.setVersionTag(tag);
+          checkForDeltaConflictAndSetVersionTag(tag, con);
+    void checkForDeltaConflictAndSetVersionTag(VersionTag versionTag, Connection connection)
+        throws Exception {
+      RegionEntry regionEntry = ((EntryEventImpl) event).getRegionEntry();
+      if (regionEntry == null) {
+        event.setVersionTag(versionTag);
+        return;
+      }
+      VersionStamp versionStamp = regionEntry.getVersionStamp();
+      if (deltaSent && versionTag.getEntryVersion() > versionStamp.getEntryVersion() + 1) {
+        // Delta can't be applied, need to get full value.
+        if (logger.isDebugEnabled()) {
+          logger.debug("Version is out of order. Need to get from server to perform delta update.");
+        }
+        Object object = getFullValue(connection);
+        event.setNewValue(object);
+      } else {
+        event.setVersionTag(versionTag);
+      }
+    }
+
+    Object getFullValue(Connection connection) throws Exception {
+      GetOp.GetOpImpl getOp =
+          new GetOp.GetOpImpl(region, key, callbackArg, prSingleHopEnabled, event);
+      return getOp.attempt(connection);
+    }
+
