Merge pull request #3044 from gesterzhou/feature/GEODE-3967

GEODE-3967: fix the offheap memory leak in serial gateway sender's unâ€¦
+import org.apache.geode.internal.VersionedDataSerializable;
+import org.apache.geode.internal.cache.tier.sockets.Message;
-    implements AsyncEvent, DataSerializableFixedID, Conflatable, Sizeable, Releasable {
+    implements AsyncEvent, DataSerializableFixedID, Conflatable, Sizeable, Releasable,
+    VersionedDataSerializable {
-  protected static final short VERSION = 0x11;
+  // It should use current version. But it was hard-coded to be 0x11, i.e. GEODE_120_ORDINAL,
+  // by mistake since 120 to pre-190
+  protected static final short VERSION = Version.GEODE_190.ordinal();
-   * @see org.apache.geode.internal.cache.tier.sockets.Message
+   * @see Message
+  private transient boolean isConcurrencyConflict = false;
+
+  private short version;
+
+    this.isConcurrencyConflict = event.isConcurrencyConflict();
+  @Override
+    toDataPre_GEODE_1_9_0_0(out);
+    DataSerializer.writeBoolean(this.isConcurrencyConflict, out);
+  }
+
+  public void toDataPre_GEODE_1_9_0_0(DataOutput out) throws IOException {
+  @Override
-    short version = in.readShort();
-    if (version != VERSION) {
-      // warning?`
+    fromDataPre_GEODE_1_9_0_0(in);
+    if (version >= Version.GEODE_190.ordinal()) {
+      this.isConcurrencyConflict = DataSerializer.readBoolean(in);
+  }
+
+  public void fromDataPre_GEODE_1_9_0_0(DataInput in) throws IOException, ClassNotFoundException {
+    version = in.readShort();
-        .append(";bucketId=").append(this.bucketId).append("]");
+        .append(";bucketId=").append(this.bucketId).append(";isConcurrencyConflict=")
+        .append(this.isConcurrencyConflict).append("]");
+  public boolean isConcurrencyConflict() {
+    return isConcurrencyConflict;
+  }
+
-    return null;
+    return new Version[] {Version.GEODE_190};
