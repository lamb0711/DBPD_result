Merge branch 'release/1.4.0'

+import org.apache.geode.internal.cache.entries.AbstractRegionEntry;
- * 
+ *
- * 
+ *
- * 
+ *
-   * 
+   *
+    {
+      TXStateProxy curProxy = txContext.get();
+      if (curProxy == PAUSED) {
+        throw new java.lang.IllegalStateException(
+            "Current thread has paused its transaction so it can not start a new transaction");
+      }
+    }
+    if (tsp == PAUSED) {
+      // treats paused transaction as no transaction.
+      return null;
+    }
-   * 
+   *
+    assert tsp != PAUSED;
+  private static final TXStateProxy PAUSED = new PausedTXStateProxyImpl();
+
+  /**
+   * If the current thread is in a transaction then pause will cause it to no longer be in a
+   * transaction. The same thread is expected to unpause/resume the transaction later. The thread
+   * should not start a new transaction after it paused a transaction.
+   *
+   * @return the state of the transaction or null. Pass this value to
+   *         {@link TXManagerImpl#unpauseTransaction} to reactivate the puased/suspended
+   *         transaction.
+   */
+  public TXStateProxy pauseTransaction() {
+    return internalSuspend(true);
+  }
+
+  /**
+   * If the current thread is in a transaction then internal suspend will cause it to no longer be
+   * in a transaction. The thread can start a new transaction after it internal suspended a
+   * transaction.
+   *
+   * @return the state of the transaction or null. to reactivate the suspended transaction.
+   */
+  public TXStateProxy internalSuspend() {
+    return internalSuspend(false);
+  }
+
-   * 
-   * @return the state of the transaction or null. Pass this value to {@link TXManagerImpl#resume}
-   *         to reactivate the suspended transaction.
+   *
+   * @param needToResumeBySameThread whether a suspended transaction needs to be resumed by the same
+   *        thread.
+   * @return the state of the transaction or null. Pass this value to
+   *         {@link TXManagerImpl#internalResume(TXStateProxy, boolean)} to reactivate the suspended
+   *         transaction.
-  public TXStateProxy internalSuspend() {
+  private TXStateProxy internalSuspend(boolean needToResumeBySameThread) {
-      setTXState(null);
+      if (needToResumeBySameThread) {
+        setTXState(PAUSED);
+      } else {
+        setTXState(null);
+      }
-   * Activates the specified transaction on the calling thread.
-   * 
+   * Activates the specified transaction on the calling thread. Only the same thread that pause the
+   * transaction can unpause it.
+   *
+   * @param tx the transaction to be unpaused.
+   * @throws IllegalStateException if this thread already has an active transaction or this thread
+   *         did not pause the transaction.
+   */
+  public void unpauseTransaction(TXStateProxy tx) {
+    internalResume(tx, true);
+  }
+
+  /**
+   * Activates the specified transaction on the calling thread. Does not require the same thread to
+   * resume it.
+   *
+    internalResume(tx, false);
+  }
+
+  /**
+   * Activates the specified transaction on the calling thread.
+   *
+   * @param tx the transaction to activate.
+   * @param needToResumeBySameThread whether a suspended transaction needs to be resumed by the same
+   *        thread.
+   * @throws IllegalStateException if this thread already has an active transaction
+   */
+  private void internalResume(TXStateProxy tx, boolean needToResumeBySameThread) {
+      if (needToResumeBySameThread) {
+        TXStateProxy result = txContext.get();
+        if (result != PAUSED) {
+          throw new java.lang.IllegalStateException(
+              "try to unpause a transaction not paused by the same thread");
+        }
+      }
+
+  public boolean isTransactionPaused() {
+    return txContext.get() == PAUSED;
+  }
+
-    if (t != null) {
+    if (t != null && t != PAUSED) {
-   * 
+   *
-   * 
+   *
-   * 
+   *
-   * 
+   *
-   * 
+   *
-   * 
+   *
-   * 
+   *
-   * 
+   *
-   * 
+   *
-   * 
+   *
-      internalSuspend();
+      result.suspend();
+      setTXState(null);
-    internalResume(txProxy);
+    assert getTXState() == null;
+    setTXState(txProxy);
+    txProxy.resume();
-   * 
+   *
-   * 
+   *
-   * 
+   *
-   * 
+   *
-   * 
+   *
-   * 
+   *
