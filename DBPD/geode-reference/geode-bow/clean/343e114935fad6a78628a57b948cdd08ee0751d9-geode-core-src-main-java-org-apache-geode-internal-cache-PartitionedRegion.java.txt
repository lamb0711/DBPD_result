GEODE-8127: Reintroduces changes that account for primary bucket changing (#5179)

* flaky test ignored

Co-authored-by: john Hutchison <hutchisonjo@vmware.com>
Co-authored-by: Jens Deppe <jdeppe@pivotal.io>
+import org.apache.geode.internal.cache.execute.BucketMovedException;
+  public void computeWithPrimaryLocked(Object key, Runnable r) {
+    int bucketId = PartitionedRegionHelper.getHashKey(this, null, key, null, null);
+
+    BucketRegion br;
+    try {
+      br = this.dataStore.getInitializedBucketForId(key, bucketId);
+    } catch (ForceReattemptException e) {
+      throw new BucketMovedException(e);
+    }
+
+    try {
+      br.doLockForPrimary(false);
+    } catch (PrimaryBucketException e) {
+      throw new BucketMovedException(e);
+    }
+
+    try {
+      r.run();
+    } finally {
+      br.doUnlockForPrimary();
+    }
+  }
+
