GEODE-5010: have post interceptor uses ResultModel as an input if comâ€¦ (#1974)



-    CommandResult commandResult = null;
-    Object response = null;
+    boolean useResultModel = false;
+        useResultModel = true;
+    Object response = null;
-    // the response could be a string which is a json representation of the CommandResult object
+    // the response could be a string which is a json representation of the
+    // CommandResult/ResultModel object
+    Object commandResult = null;
-        // TODO: stuff when failedToPersist...
-        // TODO: stuff for debug info...
-        commandResult = ResultBuilder.createModelBasedCommandResult((String) response);
+        // if it's ResultModel
+        commandResult = ResultModel.fromJson((String) response);
+        useResultModel = true;
+        // if it's a CommandResult
-      CommandResult postExecResult =
-          interceptor.postExecution(parseResult, commandResult, tempFile);
-      if (postExecResult != null) {
-        if (Status.ERROR.equals(postExecResult.getStatus())) {
-          if (logWrapper.infoEnabled()) {
-            logWrapper.info("Post execution Result :: " + postExecResult);
-          }
-        } else if (logWrapper.fineEnabled()) {
-          logWrapper.fine("Post execution Result :: " + postExecResult);
+      try {
+        if (useResultModel) {
+          commandResult =
+              interceptor.postExecution(parseResult, (ResultModel) commandResult, tempFile);
+        } else {
+          commandResult =
+              interceptor.postExecution(parseResult, (CommandResult) commandResult, tempFile);
-        commandResult = postExecResult;
+      } catch (Exception e) {
+        logWrapper.severe("error running post interceptor", e);
+        commandResult = ResultBuilder.createGemFireErrorResult(e.getMessage());
-    return commandResult;
+    CommandResult gfshResult;
+    if (commandResult instanceof ResultModel) {
+      gfshResult = new ModelCommandResult((ResultModel) commandResult);
+    } else {
+      gfshResult = (CommandResult) commandResult;
+    }
+
+    return gfshResult;
