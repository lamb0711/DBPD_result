GEODE-3895: Add Handshake/Message version byte (#1001)

Signed-off-by: Galen O'Sullivan <gosullivan@pivotal.io>
+import org.apache.geode.internal.cache.client.protocol.exception.ServiceLoadingFailureException;
+import org.apache.geode.internal.cache.client.protocol.exception.ServiceVersionNotFoundException;
-      StatisticsFactory statisticsFactory, String serverName) {
+      StatisticsFactory statisticsFactory, String serverName, int protocolVersion) {
-      clientProtocolService = clientProtocolServiceLoader.lookupService();
+      clientProtocolService = clientProtocolServiceLoader.lookupService(protocolVersion);
+        int protocolVersion = readProtocolVersionByte(socket);
-              socketBufferSize, communicationModeStr, communicationMode, acceptor, securityService);
+              socketBufferSize, communicationModeStr, communicationMode, acceptor, securityService,
+              protocolVersion);
+        } catch (ServiceVersionNotFoundException ex) {
+          throw new IOException("No service matching provided version byte", ex);
+  private int readProtocolVersionByte(Socket socket) throws IOException {
+    return socket.getInputStream().read();
+  }
+
-      SecurityService securityService) {
-    ClientProtocolService service =
-        getClientProtocolService(cache.getDistributedSystem(), acceptor.getServerName());
+      SecurityService securityService, int protocolVersion) {
+    ClientProtocolService service = getClientProtocolService(cache.getDistributedSystem(),
+        acceptor.getServerName(), protocolVersion);
