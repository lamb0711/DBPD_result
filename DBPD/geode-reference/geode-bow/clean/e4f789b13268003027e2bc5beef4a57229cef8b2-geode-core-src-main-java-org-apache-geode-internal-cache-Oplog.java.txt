GEODE-5302: set totalLiveCount to 0 after successfuly compacted the oplog. (#2041)


-  private static final byte END_OF_RECORD_ID = 21;
+  private static final byte END_OF_RECORD_ID = 21;
-  static final int OPLOG_DISK_STORE_REC_SIZE = 1 + 16 + 1;
+  static final int OPLOG_DISK_STORE_REC_SIZE = 1 + 16 + 1;
+
-
-  private boolean calledByCompactorThread() {
+  boolean calledByCompactorThread() {
-  private void handleNoLiveValues() {
+  void handleNoLiveValues() {
-        if (!compactFailed) {
-          // Need to still remove the oplog even if it had nothing to compact.
-          handleNoLiveValues();
-
-          // We can't assert hasNoLiveValues() because a race condition exists
-          // in which our liveEntries list is empty but the liveCount has not
-          // yet been decremented.
-        }
+        cleanupAfterCompaction(compactFailed);
+  void cleanupAfterCompaction(boolean compactFailed) {
+    if (!compactFailed) {
+      // all data has been copied forward to new oplog so no live entries remain
+      getTotalLiveCount().set(0);
+      // Need to still remove the oplog even if it had nothing to compact.
+      handleNoLiveValues();
+    }
+  }
+
+  AtomicLong getTotalLiveCount() {
+    return totalLiveCount;
+  }
+
