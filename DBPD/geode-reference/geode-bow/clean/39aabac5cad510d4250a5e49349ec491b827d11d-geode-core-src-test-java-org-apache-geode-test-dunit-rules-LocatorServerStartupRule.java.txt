Merge remote-tracking branch 'origin/develop' into feature/GEODE-3239

-import java.util.Arrays;
-import java.util.Objects;
+import java.util.stream.IntStream;
+import org.apache.geode.test.junit.rules.Locator;
+import org.apache.geode.test.junit.rules.LocatorStarterRule;
+import org.apache.geode.test.junit.rules.Member;
+import org.apache.geode.test.junit.rules.MemberStarterRule;
+import org.apache.geode.test.junit.rules.Server;
+import org.apache.geode.test.junit.rules.ServerStarterRule;
-
-    members = new MemberVM[4];
+    members = new MemberVM[DUnitLauncher.NUM_VMS];
-    DUnitLauncher.closeAndCheckForSuspects();
-    Arrays.stream(members).filter(Objects::nonNull).forEach(MemberVM::stopMember);
-    if (useTempWorkingDir()) {
-      tempWorkingDir.delete();
+    try {
+      DUnitLauncher.closeAndCheckForSuspects();
+    } finally {
+      MemberStarterRule.disconnectDSIfAny();
+      IntStream.range(0, DUnitLauncher.NUM_VMS).forEach(this::stopVM);
+
+      if (useTempWorkingDir()) {
+        tempWorkingDir.delete();
+      }
+      restoreSystemProperties.after();
-    restoreSystemProperties.after();
-    VM locatorVM = getHost(0).getVM(index);
+    VM locatorVM = getVM(index);
-    VM serverVM = getHost(0).getVM(index);
+    VM serverVM = getVM(index);
+    return startServerAsEmbededLocator(index, new Properties());
+  }
+
+  public MemberVM startServerAsEmbededLocator(int index, Properties properties) throws IOException {
-    VM serverVM = getHost(0).getVM(index);
+    VM serverVM = getVM(index);
-      serverStarter.withEmbeddedLocator().withName(name).withJMXManager().withAutoStart();
+      serverStarter.withEmbeddedLocator().withProperties(properties).withName(name).withJMXManager()
+          .withAutoStart();
-  public void stopMember(int index) {
+  public void stopVM(int index) {
-    member.stopMember();
+    // user has started a server/locator in this VM
+    if (member != null) {
+      member.stopMember();
+    }
+    // user may have used this VM as a client VM
+    else {
+      getVM(index).invoke(() -> MemberStarterRule.disconnectDSIfAny());
+    }
