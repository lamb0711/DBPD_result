GEODE-6863: Ignoring IllegalStateException (#3719)

        * Ignoring IllegalStateException if the server is no more running.
	* If the server is not running then getting external address will result in IllegalStateException.
	* The server may shut down in between isRunning and getExternalAddress calls.
	* If this happens then the server is not added to the location list of the servers hosting bucket.


+import static org.apache.geode.internal.cache.CacheServerImpl.CACHE_SERVER_BIND_ADDRESS_NOT_AVAILABLE_EXCEPTION_MESSAGE;
+
-      InternalCache cache = getProxyBucketRegion().getCache();
-      List<CacheServer> servers = cache.getCacheServers();
-
-      HashSet<BucketServerLocation66> serverLocations = new HashSet<>();
-      for (CacheServer cacheServer : servers) {
-        CacheServerImpl server = (CacheServerImpl) cacheServer;
-        if (server.isRunning() && (server.getExternalAddress() != null)) {
-          BucketServerLocation66 location = new BucketServerLocation66(getBucket().getId(),
-              server.getPort(), server.getExternalAddress(), getBucket().isPrimary(),
-              Integer.valueOf(version).byteValue(), server.getCombinedGroups());
-          serverLocations.add(location);
-        }
-      }
-      if (serverLocations.size() > 0) {
-        return new ServerBucketProfile(memberId, version, getBucket(), serverLocations);
+      Set<BucketServerLocation66> serverLocations = getBucketServerLocations(version);
+      if (!serverLocations.isEmpty()) {
+        return new ServerBucketProfile(memberId, version, getBucket(), (HashSet) serverLocations);
+  protected Set<BucketServerLocation66> getBucketServerLocations(int version) {
+    InternalCache cache = getProxyBucketRegion().getCache();
+    List<CacheServer> servers = cache.getCacheServers();
+    if (servers.isEmpty()) {
+      return Collections.emptySet();
+    }
+    HashSet<BucketServerLocation66> serverLocations = new HashSet<>();
+    for (CacheServer cacheServer : servers) {
+      CacheServerImpl server = (CacheServerImpl) cacheServer;
+      try {
+        String serverExternalAddress;
+        if (server.isRunning() && ((serverExternalAddress = server.getExternalAddress()) != null)) {
+          BucketServerLocation66 location = new BucketServerLocation66(getBucket().getId(),
+              server.getPort(), serverExternalAddress, getBucket().isPrimary(),
+              Integer.valueOf(version).byteValue(), server.getCombinedGroups());
+          serverLocations.add(location);
+        }
+      } catch (IllegalStateException e) {
+        if (!(e.getMessage() != null
+            && e.getMessage().equals(CACHE_SERVER_BIND_ADDRESS_NOT_AVAILABLE_EXCEPTION_MESSAGE))) {
+          throw e;
+        }
+      }
+    }
+    return serverLocations;
+  }
+
