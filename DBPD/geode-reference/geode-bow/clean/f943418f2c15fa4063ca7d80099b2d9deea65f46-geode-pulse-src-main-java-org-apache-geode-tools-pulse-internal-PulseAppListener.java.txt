GEODE-6683: Set java SSL properties when Pulse runs in non-embedded mode (#3525)

* GEODE-6683: Set java SSL properties when Pulse runs in non-embedded mode

Co-authored-by: Aaron Lindsey <alindsey@pivotal.io>
Co-authored-by: Michael Oleske <moleske@pivotal.io>
Co-authored-by: Mark Hanson <mhanson@pivotal.io>
-import java.util.Iterator;
+import java.util.function.BiFunction;
-  private final ResourceBundle resourceBundle = Repository.get().getResourceBundle();
-  private Properties pulseProperties;
-  private Properties pulseSecurityProperties;
+  private final boolean isEmbedded;
+  private final Repository repository;
+  private final ResourceBundle resourceBundle;
+  private final BiFunction<String, ResourceBundle, Properties> propertiesFileLoader;
+
+  public PulseAppListener() {
+    this(Boolean.getBoolean(PulseConstants.SYSTEM_PROPERTY_PULSE_EMBEDDED), Repository.get(),
+        PulseAppListener::loadPropertiesFromFile);
+  }
+
+  public PulseAppListener(boolean isEmbedded, Repository repository,
+      BiFunction<String, ResourceBundle, Properties> propertiesFileLoader) {
+    this.isEmbedded = isEmbedded;
+    this.repository = repository;
+    this.resourceBundle = repository.getResourceBundle();
+    this.propertiesFileLoader = propertiesFileLoader;
+  }
-    Repository.get().removeAllClusters();
+    repository.removeAllClusters();
-    // Load Pulse Properties
-    pulseProperties = loadProperties(PulseConstants.PULSE_PROPERTIES_FILE);
-    // load pulse security properties
-    pulseSecurityProperties = loadProperties(PulseConstants.PULSE_SECURITY_PROPERTIES_FILE);
-
-    // Reference to repository
-    Repository repository = Repository.get();
-
-    boolean sysIsEmbedded = Boolean.getBoolean(PulseConstants.SYSTEM_PROPERTY_PULSE_EMBEDDED);
-
-    if (sysIsEmbedded) {
+    if (isEmbedded) {
+
+      // Load Pulse Properties
+      Properties pulseProperties =
+          propertiesFileLoader.apply(PulseConstants.PULSE_PROPERTIES_FILE, resourceBundle);
+
+      // load pulse security properties
+      Properties pulseSecurityProperties =
+          propertiesFileLoader.apply(PulseConstants.PULSE_SECURITY_PROPERTIES_FILE, resourceBundle);
+
-        Set entrySet = pulseSecurityProperties.entrySet();
-        for (Iterator it = entrySet.iterator(); it.hasNext();) {
-          Entry<String, String> entry = (Entry<String, String>) it.next();
-          String key = entry.getKey();
+        Set<Entry<Object, Object>> entrySet = pulseSecurityProperties.entrySet();
+        for (Entry<Object, Object> entry : entrySet) {
+          String key = (String) entry.getKey();
-            String val = entry.getValue();
+            String val = (String) entry.getValue();
+
+        repository.setJavaSslProperties(pulseSecurityProperties);
-    Properties properties = loadProperties(PulseConstants.PULSE_VERSION_PROPERTIES_FILE);
+    Properties properties =
+        propertiesFileLoader.apply(PulseConstants.PULSE_VERSION_PROPERTIES_FILE, resourceBundle);
-  private Properties loadProperties(String propertyFile) {
+  private static Properties loadPropertiesFromFile(String propertyFile,
+      ResourceBundle resourceBundle) {
