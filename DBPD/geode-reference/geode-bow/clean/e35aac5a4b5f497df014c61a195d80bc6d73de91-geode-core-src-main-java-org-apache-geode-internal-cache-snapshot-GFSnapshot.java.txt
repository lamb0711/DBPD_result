Merge branch 'release/1.5.0'

-    GFSnapshotImporter imp = new GFSnapshotImporter(new File(args[0]));
+    GFSnapshotImporter imp = new GFSnapshotImporter(new File(args[0]), null);
+   * @param cache
-  public static SnapshotWriter create(File snapshot, String region) throws IOException {
-    final GFSnapshotExporter out = new GFSnapshotExporter(snapshot, region);
+  public static SnapshotWriter create(File snapshot, String region, InternalCache cache)
+      throws IOException {
+    final GFSnapshotExporter out = new GFSnapshotExporter(snapshot, region, cache);
-  public static <K, V> SnapshotIterator<K, V> read(final File snapshot)
+  public static <K, V> SnapshotIterator<K, V> read(final File snapshot, TypeRegistry typeRegistry)
-      GFSnapshotImporter in = new GFSnapshotImporter(snapshot);
+      GFSnapshotImporter in = new GFSnapshotImporter(snapshot, typeRegistry);
+    private final InternalCache cache;
-    public GFSnapshotExporter(File out, String region) throws IOException {
+    public GFSnapshotExporter(File out, String region, InternalCache cache) throws IOException {
+      this.cache = cache;
-        InternalCache cache = GemFireCacheImpl
-            .getForPdx("PDX registry is unavailable because the Cache has been closed.");
-    public GFSnapshotImporter(File in) throws IOException, ClassNotFoundException {
+    public GFSnapshotImporter(File in, TypeRegistry typeRegistry)
+        throws IOException, ClassNotFoundException {
-      checkPdxTypeCompatibility();
-      checkPdxEnumCompatibility();
+      checkPdxTypeCompatibility(typeRegistry);
+      checkPdxEnumCompatibility(typeRegistry);
-    private TypeRegistry getRegistry() {
-      InternalCache gfc = GemFireCacheImpl.getInstance();
-      if (gfc != null) {
-        return gfc.getPdxRegistry();
-      }
-      return null;
-    }
-
-    private void checkPdxTypeCompatibility() {
-      TypeRegistry tr = getRegistry();
+    private void checkPdxTypeCompatibility(TypeRegistry tr) {
-    private void checkPdxEnumCompatibility() {
-      TypeRegistry tr = getRegistry();
+    private void checkPdxEnumCompatibility(TypeRegistry tr) {
