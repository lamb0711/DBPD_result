GEODE-4746: Handle exceptions and return failures to protobuf clients

Catching exceptions that happen before sending a response to the
protobuf client and sending an error message to the client instead of
closing the connection.

Cleaning up extraneous catch blocks.

+import org.apache.geode.internal.protocol.protobuf.v1.state.exception.ExceptionWithErrorCode;
+import org.apache.geode.internal.protocol.protobuf.v1.state.exception.OperationNotAuthorizedException;
-  public static <T> Failure<T> of(ConnectionStateException exception) {
-    return of(exception.getErrorCode(), exception.getMessage());
+  public static <T> Failure<T> of(Throwable exception) {
+    BasicTypes.ErrorCode errorCode = getErrorCode(exception);
+
+    return of(errorCode, getErrorMessage(exception));
-  public static <T> Failure<T> of(Exception exception) {
-    if (exception instanceof ConnectionStateException) {
-      return of((ConnectionStateException) exception);
+  private static BasicTypes.ErrorCode getErrorCode(Throwable exception) {
+    BasicTypes.ErrorCode errorCode = BasicTypes.ErrorCode.SERVER_ERROR;
+    if (exception instanceof ExceptionWithErrorCode) {
+      errorCode = ((ExceptionWithErrorCode) exception).getErrorCode();
-    return of(BasicTypes.ErrorCode.SERVER_ERROR, exception.toString());
+    return errorCode;
+  }
+
+  private static String getErrorMessage(Throwable exception) {
+
+    StringBuilder message = new StringBuilder(exception.toString());
+    while (exception.getCause() != null) {
+      message.append(" Caused by: " + exception.getCause());
+      exception = exception.getCause();
+    }
+
+    return message.toString();
