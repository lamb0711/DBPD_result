Merge branch 'release/1.5.0'

-import org.apache.geode.cache.Cache;
-    try {
-      this.locks.obtain();
-      // for now check account the dlock service time
-      // later this stat end should be moved to a finally block
-      if (CachePerfStats.enableClockStats)
-        this.proxy.getTxMgr().getCachePerfStats()
-            .incTxConflictCheckTime(CachePerfStats.getStatTime() - conflictStart);
-      if (this.internalAfterReservation != null) {
-        this.internalAfterReservation.run();
-      }
-      checkForConflicts();
-    } catch (CommitConflictException conflict) {
-      throw conflict;
+    this.locks.obtain(getCache().getInternalDistributedSystem());
+    // for now check account the dlock service time
+    // later this stat end should be moved to a finally block
+    if (CachePerfStats.enableClockStats)
+      this.proxy.getTxMgr().getCachePerfStats()
+          .incTxConflictCheckTime(CachePerfStats.getStatTime() - conflictStart);
+    if (this.internalAfterReservation != null) {
+      this.internalAfterReservation.run();
+    checkForConflicts();
-          this.locks.cleanup();
+          this.locks.cleanup(getCache().getInternalDistributedSystem());
-          this.proxy.getTxMgr().setTXState(null);
+          proxy.getTxMgr().setTXState(null);
+          saveTXCommitMessageForClientFailover();
+        saveTXCommitMessageForClientFailover();
+  private void saveTXCommitMessageForClientFailover() {
+    proxy.getTxMgr().saveTXStateForClientFailover(proxy);
+  }
-  public Cache getCache() {
-    return this.proxy.getTxMgr().getCache();
+  public InternalCache getCache() {
+    return this.proxy.getCache();
