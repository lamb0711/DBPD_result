GEODE-5262: fix race condition in RemoteGfManagerAgent between removeâ€¦ (#2001)


-  protected InternalDistributedSystem system;
+  protected volatile InternalDistributedSystem system;
+  private final Object systemLock = new Object();
-  private volatile Map membersMap = Collections.EMPTY_MAP;
+  protected volatile Map membersMap = Collections.EMPTY_MAP;
-        if (system != null && ClusterDistributionManager.isDedicatedAdminVM()
-            && system.isConnected()) {
-          system.disconnect();
+        synchronized (systemLock) {
+          if (system != null && ClusterDistributionManager.isDedicatedAdminVM()
+              && system.isConnected()) {
+            system.disconnect();
+          }
+          this.system = null;
-
-        this.system = null;
-        this.system.getCancelCriterion().checkCancelInProgress(null);
+        synchronized (systemLock) {
+          if (system == null) {
+            return null;
+          }
+          this.system.getCancelCriterion().checkCancelInProgress(null);
+        }
+
-
-    if (system != null) {
-      system.disconnect();
-      system = null;
-    }
-
-    this.system = (InternalDistributedSystem) InternalDistributedSystem.connectForAdmin(props);
+
+    synchronized (systemLock) {
+      if (system != null) {
+        system.disconnect();
+        system = null;
+      }
+      this.system = (InternalDistributedSystem) InternalDistributedSystem.connectForAdmin(props);
+    }
+
