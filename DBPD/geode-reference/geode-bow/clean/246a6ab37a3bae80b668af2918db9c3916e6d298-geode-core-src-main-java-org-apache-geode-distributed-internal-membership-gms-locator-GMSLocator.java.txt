Merge pull request #3118 from apache/feature/GEODE-6309

GEODE-6309 ClusterConfigLocatorRestartDUnitTest fails to spin up a new server
-      this.locators = new ArrayList<HostAddress>(0);
+      this.locators = new ArrayList<>(0);
-        this.view = newView;
-      } else if (localAddress != null) {
-        synchronized (this.registrants) {
-          this.registrants.add(localAddress);
+        view = newView;
+        recoveredView = null;
+      } else {
+        // if we are auto-reconnecting we may already have a membership view
+        // and should use it as a "recovered view" which only hints at who is
+        // the current membership coordinator
+        if (view != null) {
+          view.setViewId(-100); // no longer a valid view
+          recoveredView = view; // auto-reconnect will be based on the recovered view
+          view = null;
+        }
+        if (localAddress != null) {
+          if (recoveredView != null) {
+            recoveredView.remove(localAddress);
+          }
+          synchronized (this.registrants) {
+            this.registrants.add(localAddress);
+          }
-  public File setViewFile(File file) {
+  File setViewFile(File file) {
-      } catch (InterruptedException e) {
+      } catch (InterruptedException ignored) {
-  public Object processRequest(Object request) throws IOException {
+  public Object processRequest(Object request) {
+          fromView = false;
-        oos.flush();
-        oos.close();
+        if (oos != null) {
+          oos.flush();
+          oos.close();
+        }
-      if (response != null && (response instanceof GetViewResponse)) {
+      if (response instanceof GetViewResponse) {
-    } catch (IOException | ClassNotFoundException ignore) {
+    } catch (IOException | ClassNotFoundException ex) {
-          ignore.getMessage());
+          ex.getMessage());
