GEODE-8048: change redis sets to use functions and deltas (#5009)


Co-authored-by: Darrel Schneider <dschneider@pivotal.io>
Co-authored-by: Sarah Abbey <sabbey@pivotal.io>
Co-authored-by: John Hutchison <jhutchison@pivotal.io>
Co-authored-by: Jens Deppe <jdeppe@pivotal.io>
-import java.util.HashSet;
+import java.util.ArrayList;
+import java.util.Collections;
-import java.util.Set;
-    Region<ByteArrayWrapper, Set<ByteArrayWrapper>> region = getRegion(context);
+    Region<ByteArrayWrapper, DeltaSet> region = getRegion(context);
-      Set<ByteArrayWrapper> sourceSet = region.get(source);
+      DeltaSet sourceSet = region.get(source);
-      sourceSet = new HashSet<>(sourceSet); // copy to support transactions;
-      boolean removed = sourceSet.remove(member);
+      boolean removed =
+          DeltaSet.srem(region, source, new ArrayList<>(Collections.singletonList(member)),
+              null) == 1;
+      // TODO: what should SMOVE do with a source that it empties? We probably need to delete it.
-          Set<ByteArrayWrapper> destinationSet = region.get(destination);
-
-          if (destinationSet == null) {
-            destinationSet = new HashSet<>();
-          } else {
-            destinationSet = new HashSet<>(destinationSet); // copy to support transactions
-          }
-
-          destinationSet.add(member);
-
-          region.put(destination, destinationSet);
+          // TODO: this should invoke a function in case the primary for destination is remote
+          DeltaSet.sadd(region, destination, new ArrayList<>(Collections.singletonList(member)));
-
-          region.put(source, sourceSet);
