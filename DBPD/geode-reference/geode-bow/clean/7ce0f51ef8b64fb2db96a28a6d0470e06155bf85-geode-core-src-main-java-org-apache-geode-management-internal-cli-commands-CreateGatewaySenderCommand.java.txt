GEODE-6777: Create gateway senders command should only return when DistributedSystemMXBean reflects creation status (#3643)


+import java.util.concurrent.TimeUnit;
+import org.apache.logging.log4j.Logger;
+import org.apache.geode.annotations.VisibleForTesting;
+import org.apache.geode.internal.logging.LogService;
+import org.apache.geode.management.DistributedSystemMXBean;
+  private static final Logger logger = LogService.getLogger();
+  private static final int MBEAN_CREATION_WAIT_TIME = 10000;
+
+    if (!waitForGatewaySenderMBeanCreation(id, membersToCreateGatewaySenderOn)) {
+      resultModel.addInfo()
+          .addLine("Did not complete waiting for GatewaySenderMBean proxy creation");
+    }
+
+  /*
+   * Wait for up tp 3 seconds for the proxy MBeans to be created.
+   */
+  @VisibleForTesting
+  boolean waitForGatewaySenderMBeanCreation(String id,
+      Set<DistributedMember> membersToCreateGatewaySenderOn) {
+    DistributedSystemMXBean dsMXBean = getManagementService().getDistributedSystemMXBean();
+
+    return poll(MBEAN_CREATION_WAIT_TIME, TimeUnit.MILLISECONDS,
+        () -> membersToCreateGatewaySenderOn.stream()
+            .allMatch(m -> gatewaySenderBeanExists(dsMXBean, m.getName(), id)));
+  }
+
+  static boolean gatewaySenderBeanExists(DistributedSystemMXBean dsMXBean, String member,
+      String id) {
+    try {
+      // This throws a vanilla Exception if this call does not find anything
+      dsMXBean.fetchGatewaySenderObjectName(member, id);
+      return true;
+    } catch (Exception e) {
+      if (!e.getMessage().toLowerCase().contains("not found")) {
+        logger.warn("Unable to retrieve GatewaySender ObjectName for member: {}, id: {} - {}",
+            member, id, e.getMessage());
+      }
+    }
+    return false;
+  }
+
