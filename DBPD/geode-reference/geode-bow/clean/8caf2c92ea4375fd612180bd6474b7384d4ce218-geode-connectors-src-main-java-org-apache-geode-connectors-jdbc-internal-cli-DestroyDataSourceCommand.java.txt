GEODE-6102: fail destroy data-source if in use  (#2996)



+import org.springframework.shell.core.annotation.CliAvailabilityIndicator;
+import org.apache.geode.cache.configuration.RegionConfig;
+import org.apache.geode.connectors.jdbc.internal.configuration.RegionMapping;
+
+      try {
+        checkIfDataSourceIsInUse(service, dataSourceName);
+      } catch (IllegalStateException ex) {
+        return ResultModel.createError(CliStrings.format(
+            "Data source named \"{0}\" is still being used by region \"{1}\". Use destroy jdbc-mapping --region={1} and then try again.",
+            dataSourceName, ex.getMessage()));
+
+      }
+  /**
+   * @throws IllegalStateException if the data source is used by a jdbc-mapping. The exception
+   *         message names the region using this data source
+   */
+  private void checkIfDataSourceIsInUse(InternalConfigurationPersistenceService service,
+      String dataSourceName) {
+    CacheConfig cacheConfig = service.getCacheConfig(null);
+    for (RegionConfig regionConfig : cacheConfig.getRegions()) {
+      for (CacheElement cacheElement : regionConfig.getCustomRegionElements()) {
+        if (cacheElement instanceof RegionMapping) {
+          RegionMapping regionMapping = (RegionMapping) cacheElement;
+          if (dataSourceName.equals(regionMapping.getDataSourceName())) {
+            throw new IllegalStateException(regionConfig.getName());
+          }
+        }
+      }
+    }
+  }
+
+
+  @CliAvailabilityIndicator({DESTROY_DATA_SOURCE})
+  public boolean commandAvailable() {
+    return isOnlineCommandAvailable();
+  }
