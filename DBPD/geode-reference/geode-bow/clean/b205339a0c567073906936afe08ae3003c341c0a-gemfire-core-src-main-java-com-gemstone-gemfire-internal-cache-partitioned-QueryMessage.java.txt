Merge branch 'feature/GEODE-8' into develop

+import com.gemstone.gemfire.cache.query.internal.types.ObjectTypeImpl;
+import com.gemstone.gemfire.cache.query.types.ObjectType;
+import com.gemstone.gemfire.cache.query.Struct;
-  private transient Collection<Collection> resultCollector = new ArrayList<Collection>();
+  private transient List<Collection> resultCollector = new ArrayList<Collection>();
+  private transient boolean isTraceInfoIteration = false;
+  private transient boolean isStructType = false;
+    
+        if(this.isTraceInfoIteration && this.currentResultIterator != null) {
+          this.isTraceInfoIteration = false;
+        }
-    return this.currentResultIterator.next();
+    Object data = this.currentResultIterator.next();
+    boolean isPostGFE_8_1 = this.getSender().getVersionObject().compareTo(Version.GFE_81) > 0 ;
+    //Asif: There is a bug in older versions of GFE such that the query node expects the structs to have
+    // type as ObjectTypes only & not specific types. So the new version needs to send the inaccurate 
+    //struct type for backward compatibility.
+    if(this.isStructType && !this.isTraceInfoIteration && isPostGFE_8_1) {
+      return ((Struct)data).getFieldValues(); 
+    }else if(this.isStructType && !this.isTraceInfoIteration) {
+      Struct s = (Struct)data;
+      ObjectType[] fieldTypes = s.getStructType().getFieldTypes();
+      for(int i = 0; i < fieldTypes.length; ++i) {
+        fieldTypes[i] = new ObjectTypeImpl(Object.class);
+      }
+      return data;
+    }else {
+      return data;
+    }
-    DefaultQuery query = new DefaultQuery(this.queryString, r.getCache());
+    DefaultQuery query = new DefaultQuery(this.queryString, r.getCache(), false);
-
+    boolean isQueryTraced = false;
-
+      isQueryTraced = query.isTraced() && this.sender.getVersionObject().compareTo(Version.GFE_81) >= 0;
-      if (query.isTraced() && this.sender.getVersionObject().compareTo(Version.GFE_81) >= 0) {
+      if (isQueryTraced) {
+        this.isTraceInfoIteration = true;
-        this.resultCollector.add(queryTraceList);
+        
-      qp.executeQuery(this.resultCollector);
+      this.isStructType = qp.executeQuery(this.resultCollector);
+      //Add the trace info list object after the NWayMergeResults is created so as to 
+      //exclude it from the sorted collection of NWayMergeResults
+      if(isQueryTraced) {
+        this.resultCollector.add(0,queryTraceList);
+      }
-      if (query.isTraced() && this.sender.getVersionObject().compareTo(Version.GFE_81) >= 0) {
+      if (isQueryTraced) {
-      if (query.isTraced() && this.sender.getVersionObject().compareTo(Version.GFE_81) >= 0) {
+      if (isQueryTraced) {
