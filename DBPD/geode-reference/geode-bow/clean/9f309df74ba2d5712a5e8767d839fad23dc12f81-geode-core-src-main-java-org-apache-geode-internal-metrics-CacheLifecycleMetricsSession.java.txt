GEODE-6609: Protect from MetricsPublishingService exceptions (#3429)

Catch and log Errors and RuntimeExceptions thrown from instantiation
of or calls to MetricsPublishingService implementations.

Co-authored-by: Michael Oleske <moleske@pivotal.io>

+import org.apache.logging.log4j.Logger;
+import org.apache.geode.SystemFailure;
+import org.apache.geode.internal.logging.LogService;
+  private static final Logger logger = LogService.getLogger();
+
+  private final ErrorLogger errorLogger;
+    this(cacheLifecycle, registry, metricsPublishingServices, logger::error);
+  }
+
+  @VisibleForTesting
+  CacheLifecycleMetricsSession(CacheLifecycle cacheLifecycle, CompositeMeterRegistry registry,
+      Collection<MetricsPublishingService> metricsPublishingServices, ErrorLogger errorLogger) {
+    this.errorLogger = errorLogger;
-      metricsPublishingService.start(this);
+      try {
+        metricsPublishingService.start(this);
+      } catch (VirtualMachineError e) {
+        SystemFailure.initiateFailure(e);
+        throw e;
+      } catch (Error | RuntimeException e) {
+        logError(errorLogger, "start", metricsPublishingService.getClass().getName(), e);
+      }
-      metricsPublishingService.stop();
+      try {
+        metricsPublishingService.stop();
+      } catch (VirtualMachineError e) {
+        SystemFailure.initiateFailure(e);
+        throw e;
+      } catch (Error | RuntimeException e) {
+        logError(errorLogger, "stop", metricsPublishingService.getClass().getName(), e);
+      }
+  private static void logError(ErrorLogger errorLogger, String methodName, String className,
+      Throwable throwable) {
+    errorLogger.logError("Error invoking {} for MetricsPublishingService implementation {}",
+        methodName, className, throwable);
+  }
+
+  interface ErrorLogger {
+    void logError(String message, String methodName, String className, Throwable throwable);
+  }
+
