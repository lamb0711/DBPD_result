GEODE-4604: rest api function execution needs to check the required pâ€¦ (#1388)



+import java.util.Collection;
+import org.apache.geode.management.internal.cli.exceptions.EntityNotFoundException;
+import org.apache.geode.security.ResourcePermission;
-  @PreAuthorize("@securityService.authorize('DATA', 'WRITE')")
-    Execution function = null;
+
+    Function function = FunctionService.getFunction(functionId);
+
+    // this exception will be handled by BaseControllerAdvice to eventually return a 404
+    if (function == null) {
+      throw new EntityNotFoundException(
+          String.format("The function %s is not registered.", functionId));
+    }
+
+    // check for required permissions of the function
+    Collection<ResourcePermission> requiredPermissions = function.getRequiredPermissions(region);
+    for (ResourcePermission requiredPermission : requiredPermissions) {
+      securityService.authorize(requiredPermission);
+    }
+
+    Execution execution = null;
-        function = FunctionService.onRegion(getRegion(region));
+        execution = FunctionService.onRegion(getRegion(region));
-        function = FunctionService.onMembers(getMembers(members));
+        execution = FunctionService.onMembers(getMembers(members));
-        function = FunctionService.onMembers(groups);
+        execution = FunctionService.onMembers(groups);
-        function = FunctionService.onMembers(getAllMembersInDS());
+        execution = FunctionService.onMembers(getAllMembersInDS());
-      function = function.withFilter(filter1);
+      execution = execution.withFilter(filter1);
-          results = function.setArguments(args[0]).execute(functionId);
+          results = execution.setArguments(args[0]).execute(functionId);
-          results = function.setArguments(args).execute(functionId);
+          results = execution.setArguments(args).execute(functionId);
-        results = function.execute(functionId);
+        results = execution.execute(functionId);
