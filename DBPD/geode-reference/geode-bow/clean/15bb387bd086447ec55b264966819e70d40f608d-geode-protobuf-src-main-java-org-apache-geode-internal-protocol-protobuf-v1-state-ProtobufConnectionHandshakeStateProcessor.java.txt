GEODE-4059: Changing protobuf handshake to not need communication mode bytes

This closes pull request #1137

Squashed commit of the following:

commit d9f5144cd7f7ddcf42eb7eb5febed531cbf67362
Merge: 6fa9bf6c8 8fd707201
Author: Bruce Schuchardt <bschuchardt@pivotal.io>
Date:   Fri Dec 8 09:34:55 2017 -0800

    Merge branch 'feature/GEODE-4059' of https://github.com/WireBaron/geode into WireBaron-feature/GEODE-4059

commit 8fd707201f0e02b1fdf81c1596f93d3fd9ccb0cf
Author: Brian Rowe <browe@pivotal.io>
Date:   Thu Dec 7 14:53:28 2017 -0800

    Removing extra handshake from a unit test.

    Signed-off-by: Galen O'Sullivan <gosullivan@pivotal.io>

commit 7d07c6f5163d99b92a12ca856a1b397fda6e0eb4
Author: Galen O'Sullivan <gosullivan@pivotal.io>
Date:   Wed Dec 6 16:20:25 2017 -0800

    GEODE-4059: Changing protobuf handshake to not need communication mode bytes

    - Moved handshake proto messages into top level handshake.proto
    - Changed protobuf communication mode to match leading byte of handshake
    - Updated handshake handler and tests to handle changes
    - Modified locator to accept protobuf communication mode in lieu of gossip

    Signed-off-by: Brian Rowe <browe@pivotal.io>

+import java.io.IOException;
+import java.io.InputStream;
+import java.io.OutputStream;
+import java.io.PushbackInputStream;
+
+import org.apache.geode.internal.cache.tier.CommunicationMode;
-import org.apache.geode.internal.protocol.protobuf.v1.operations.HandshakeRequestOperationHandler;
-import org.apache.geode.internal.protocol.state.ConnectionHandshakingStateProcessor;
+import org.apache.geode.internal.protocol.protobuf.v1.operations.HandshakeHandler;
-public class ProtobufConnectionHandshakeStateProcessor
-    implements ConnectionHandshakingStateProcessor {
+public class ProtobufConnectionHandshakeStateProcessor implements ConnectionStateProcessor {
-    if (!(operationContext.getOperationHandler() instanceof HandshakeRequestOperationHandler)) {
-      throw new ConnectionStateException(ProtocolErrorCode.HANDSHAKE_REQUIRED,
-          "Protobuf handshake must be completed before any other operation.");
-    }
+    throw new ConnectionStateException(ProtocolErrorCode.GENERIC_FAILURE,
+        "Connection processing should never be asked to validate an operation");
-  @Override
-  public ConnectionStateProcessor handshakeSucceeded() {
+  private ConnectionStateProcessor nextConnectionState() {
+
+  @Override
+  public boolean handleMessageIndependently(InputStream inputStream, OutputStream outputStream,
+      MessageExecutionContext executionContext) throws IOException {
+    // inputStream will have had the first byte stripped off to determine communication mode, add
+    // that byte back before processing message
+    PushbackInputStream messageStream = new PushbackInputStream(inputStream);
+    messageStream.unread(CommunicationMode.ProtobufClientServerProtocol.getModeNumber());
+
+    if (HandshakeHandler.handleHandshake(messageStream, outputStream,
+        executionContext.getStatistics())) {
+      executionContext.setConnectionStateProcessor(nextConnectionState());
+    }
+    return true;
+  }
