GEODE-5087: send a BatchDestroyOperation for each dropped event at serial primary sender (#1924)


-        for (long k = (Long) this.key; k <= this.tailKey; k++) {
+        for (long k = (Long) this.key; k <= this.tailKey && this.tailKey != -1; k++) {
+
+        // destroy dropped event from unprocessedKeys
+        if (this.tailKey == -1) {
+          SerialGatewaySenderEventProcessor ep = null;
+          int index = ((Long) this.key).intValue();
+          if (index == -1) {
+            // this is SerialGatewaySenderEventProcessor
+            ep = (SerialGatewaySenderEventProcessor) rgn.getSerialGatewaySender()
+                .getEventProcessor();
+          } else {
+            ConcurrentSerialGatewaySenderEventProcessor csgep =
+                (ConcurrentSerialGatewaySenderEventProcessor) rgn.getSerialGatewaySender()
+                    .getEventProcessor();
+            ep = csgep.processors.get(index);
+          }
+          if (ep != null) {
+            // if sender is being shutdown, the ep could be null
+            boolean removed = ep.basicHandlePrimaryDestroy(ev.getEventId());
+            if (removed) {
+              if (isDebugEnabled) {
+                logger.debug("Removed a dropped event {} from unprocessedEvents.",
+                    (EntryEventImpl) event);
+              }
+            }
+          }
+        }
