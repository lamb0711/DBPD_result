GEODE-5562 Reading the values of LocalRegion.memoryThresholdReached and DistributedRegion.memoryThresholdReachedMembers must be atomic (#2320)

* GEODE-5562 Reading the values of LocalRegion.memoryThresholdReached and
           DistributedRegion.memoryThresholdReachedMembers must be atomic.
+import java.util.Collections;
-import org.apache.geode.cache.LowMemoryException;
-import org.apache.geode.internal.SetUtils;
-import org.apache.geode.internal.cache.control.MemoryThresholds;
-    if (function.optimizeForWrite() && cache != null
-        && cache.getInternalResourceManager().getHeapMonitor().containsHeapCriticalMembers(dest)
-        && !MemoryThresholds.isLowMemoryExceptionDisabled()) {
-      Set<InternalDistributedMember> hcm = cache.getResourceAdvisor().adviseCritialMembers();
-      Set<DistributedMember> sm = SetUtils.intersection(hcm, dest);
-      throw new LowMemoryException(
-          LocalizedStrings.ResourceManager_LOW_MEMORY_FOR_0_FUNCEXEC_MEMBERS_1
-              .toLocalizedString(function.getId(), sm),
-          sm);
+    if (cache != null) {
+      cache.getInternalResourceManager().getHeapMonitor().checkForLowMemory(function,
+          Collections.unmodifiableSet(dest));
-    if (cache != null && cache.getTxManager().getTXState() != null) {
+    if (cache == null) {
+      return;
+    }
+    if (cache.getTxManager().getTXState() != null) {
-    if (function.optimizeForWrite() && cache.getInternalResourceManager().getHeapMonitor()
-        .containsHeapCriticalMembers(targetMembers)
-        && !MemoryThresholds.isLowMemoryExceptionDisabled()) {
-      Set<InternalDistributedMember> hcm = cache.getResourceAdvisor().adviseCritialMembers();
-      Set<DistributedMember> sm = SetUtils.intersection(hcm, targetMembers);
-      throw new LowMemoryException(
-          LocalizedStrings.ResourceManager_LOW_MEMORY_FOR_0_FUNCEXEC_MEMBERS_1
-              .toLocalizedString(function.getId(), sm),
-          sm);
-    }
+    cache.getInternalResourceManager().getHeapMonitor().checkForLowMemory(function, targetMembers);
