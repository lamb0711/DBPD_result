Merge branch 'develop' of https://git-wip-us.apache.org/repos/asf/incubator-geode into develop

-    if (value != null && context != null && (this instanceof OffHeapRegionEntry) 
-        && context instanceof LocalRegion && ((LocalRegion)context).isThisRegionBeingClosedOrDestroyed()) {
-      ((OffHeapRegionEntry)this).release();
-      ((LocalRegion)context).checkReadiness();
-    }
+    releaseOffHeapRefIfRegionBeingClosedOrDestroyed(context, value);
+  public void releaseOffHeapRefIfRegionBeingClosedOrDestroyed(
+      RegionEntryContext context, Object ref) {
+    if (isOffHeapReference(ref) && isThisRegionBeingClosedOrDestroyed(context)) {
+      ((OffHeapRegionEntry)this).release();
+    }
+  }
+
+  private boolean isThisRegionBeingClosedOrDestroyed(RegionEntryContext context) {
+    return context instanceof LocalRegion
+        && ((LocalRegion)context).isThisRegionBeingClosedOrDestroyed();
+  }
+
+  private boolean isOffHeapReference(Object ref) {
+    return ref != Token.REMOVED_PHASE1 && this instanceof OffHeapRegionEntry
+        && ref instanceof StoredObject && ((StoredObject)ref).hasRefCount();
+  }
+
-              _setValue(prepareValueForCache(region, value, false));
-              if (value != null && region != null && (this instanceof OffHeapRegionEntry) && region.isThisRegionBeingClosedOrDestroyed()) {
-                ((OffHeapRegionEntry)this).release();
-                region.checkReadiness();
-              }
+                Object preparedValue = prepareValueForCache(region, value, false);
+                _setValue(preparedValue);
+                releaseOffHeapRefIfRegionBeingClosedOrDestroyed(region, preparedValue);
