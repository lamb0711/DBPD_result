GEODE-7219 BufferUnderflowException in PutReplyMessage deserialization (#4073)

* GEODE-7219 BufferUnderflowException in PutReplyMessage deserialization

VersionTag serialization was being affected by concurrent modification
of its memberId/previousMemberId fields, causing the HAS_PREVIOUS_MEMBER_ID
flag bit to be set and the DUPLICATE_MEMBER_IDS flag to _not_ be set.
It then went on to perform the same checks later in toData() and make
different decisions, winding up by not serializing the previousMemberId
field because it was then == to the memberId field.

1) decide on what the flags are going to be in toData and do not perform
the same calculations again.

2) use equals() when seeing if memberId and previousMemberId are equal.

* record used ints to avoid flakiness

+import java.nio.BufferUnderflowException;
+import java.util.Objects;
+import org.apache.geode.internal.serialization.Version;
-  private static final int HAS_MEMBER_ID = 0x01;
-  private static final int HAS_PREVIOUS_MEMBER_ID = 0x02;
-  private static final int VERSION_TWO_BYTES = 0x04;
-  private static final int DUPLICATE_MEMBER_IDS = 0x08;
-  private static final int HAS_RVV_HIGH_BYTE = 0x10;
+  static final int HAS_MEMBER_ID = 0x01;
+  static final int HAS_PREVIOUS_MEMBER_ID = 0x02;
+  static final int VERSION_TWO_BYTES = 0x04;
+  static final int DUPLICATE_MEMBER_IDS = 0x08;
+  static final int HAS_RVV_HIGH_BYTE = 0x10;
-    if (this.previousMemberID != null) {
+    boolean writePreviousMemberID = false;
+    if (this.previousMemberID != null && includeMember) {
-      if (this.previousMemberID == this.memberID && includeMember) {
+      if (Objects.equals(this.previousMemberID, this.memberID)) {
+      } else {
+        writePreviousMemberID = true;
-    if (this.previousMemberID != null
-        && (this.previousMemberID != this.memberID || !includeMember)) {
+    if (writePreviousMemberID) {
-        this.previousMemberID = readMember(in);
+        try {
+          this.previousMemberID = readMember(in);
+        } catch (BufferUnderflowException e) {
+          if (context.getSerializationVersion().compareTo(Version.GEODE_1_11_0) < 0) {
+            // GEODE-7219: older versions may report HAS_PREVIOUS_MEMBER_ID but not transmit it
+            logger.info("Buffer underflow encountered while reading a version tag - ignoring");
+          } else {
+            throw e;
+          }
+        }
