GEODE-8200: Rebalance operations stuck in "IN_PROGRESS" state forever (#5350)

Record the locator that issues the original Rest API request. If the locator is offline afterwards, report an error.

Co-authored-by: Jianxia Chen <jchen21@apache.org>
Co-authored-by: Jinmei Liao <jiliao@pivotal.io>
+import org.apache.geode.internal.cache.InternalCache;
+  private final InternalCache cache;
-   * set a default retention policy to keep results for 2 hours after completion
+   * set a default retention policy to keep results for 7 days after completion
-      OperationStateStore operationStateStore) {
-    this(Duration.ofDays(7), operationStateStore);
+      OperationStateStore operationStateStore, InternalCache cache) {
+    this(Duration.ofDays(7), operationStateStore, cache);
-      OperationStateStore operationStateStore) {
+      OperationStateStore operationStateStore,
+      InternalCache cache) {
+    this.cache = cache;
+        .map(this::validateLocator)
+  private OperationState<?, ?> validateLocator(OperationState<?, ?> operationState) {
+    if (isLocatorOffline(operationState)) {
+      operationState.setOperationEnd(new Date(), null,
+          new RuntimeException("Locator that initiated the Rest API operation is offline: "
+              + operationState.getLocator()));
+    }
+
+    return operationState;
+  }
+
+  private boolean isLocatorOffline(OperationState operationState) {
+    return operationState.getOperationEnd() == null
+        && (operationState.getLocator() != null)
+        && !cache.getMyId().toString().equals(operationState.getLocator())
+        && (!cache.getDistributedSystem().getAllOtherMembers().stream().map(Object::toString)
+            .collect(Collectors.toSet()).contains(operationState.getLocator()));
+  }
+
-  public String recordStart(ClusterManagementOperation<?> op) {
+  public String recordStart(ClusterManagementOperation<?> op, String locator) {
-    return operationStateStore.recordStart(op);
+    return operationStateStore.recordStart(op, locator);
