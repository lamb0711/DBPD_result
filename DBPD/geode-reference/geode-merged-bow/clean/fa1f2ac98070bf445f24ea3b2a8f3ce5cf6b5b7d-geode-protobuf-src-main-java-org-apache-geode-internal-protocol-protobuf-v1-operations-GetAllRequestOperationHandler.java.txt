GEODE-4406: Improve authorization granularity for protobuf (#1514)


+import org.apache.shiro.authz.AuthorizationException;
+import org.apache.shiro.util.ThreadState;
+import org.apache.geode.internal.protocol.protobuf.v1.state.ProtobufConnectionAuthorizingStateProcessor;
+import org.apache.geode.internal.security.SecurityService;
+import org.apache.geode.security.NotAuthorizedException;
+import org.apache.geode.security.ResourcePermission;
+    ThreadState threadState = null;
+    SecurityService securityService = messageExecutionContext.getCache().getSecurityService();
+    boolean perKeyAuthorization = false;
+    if (messageExecutionContext
+        .getConnectionStateProcessor() instanceof ProtobufConnectionAuthorizingStateProcessor) {
+      threadState = ((ProtobufConnectionAuthorizingStateProcessor) messageExecutionContext
+          .getConnectionStateProcessor()).prepareThreadForAuthorization();
+      // Check if authorized for entire region
+      try {
+        securityService.authorize(new ResourcePermission(ResourcePermission.Resource.DATA,
+            ResourcePermission.Operation.READ, regionName));
+        ((ProtobufConnectionAuthorizingStateProcessor) messageExecutionContext
+            .getConnectionStateProcessor()).restoreThreadState(threadState);
+        threadState = null;
+      } catch (NotAuthorizedException ex) {
+        // Not authorized for the region, have to check keys individually
+        perKeyAuthorization = true;
+      }
+    }
+    final boolean authorizeKeys = perKeyAuthorization; // Required for use in lambda
+
+    long startTime = messageExecutionContext.getStatistics().startOperation();
-      request.getKeyList().stream()
-          .forEach((key) -> processSingleKey(responseBuilder, serializationService, region, key));
+      request.getKeyList().stream().forEach((key) -> processSingleKey(responseBuilder,
+          serializationService, region, key, securityService, authorizeKeys));
+      messageExecutionContext.getStatistics().endOperation(startTime);
+      if (threadState != null) {
+        ((ProtobufConnectionAuthorizingStateProcessor) messageExecutionContext
+            .getConnectionStateProcessor()).restoreThreadState(threadState);
+      }
-      ProtobufSerializationService serializationService, Region region,
-      BasicTypes.EncodedValue key) {
+      ProtobufSerializationService serializationService, Region region, BasicTypes.EncodedValue key,
+      SecurityService securityService, boolean authorizeKeys) {
+      if (authorizeKeys) {
+        securityService.authorize(new ResourcePermission(ResourcePermission.Resource.DATA,
+            ResourcePermission.Operation.READ, region.getName(), decodedKey.toString()));
+      }
+    } catch (NotAuthorizedException ex) {
+      responseBuilder.addFailures(
+          buildKeyedError(key, "Unauthorized access", BasicTypes.ErrorCode.AUTHORIZATION_FAILED));

INS26 INS26 INS26 INS26 INS26 INS26 INS40 INS40 INS40 INS40 INS40 INS40 INS44 INS44 INS60 INS60 INS60 INS25 INS60 INS60 INS43 INS42 INS39 INS42 INS43 INS59 INS43 INS59 INS39 INS59 INS62 INS8 INS83 INS39 INS59 INS39 INS59 INS8 INS42 INS12 INS42 INS42 INS33 INS42 INS42 INS32 INS42 INS9 INS32 INS43 INS21 INS54 INS42 INS42 INS42 INS32 MOV21 INS21 INS25 INS25 INS44 INS8 INS32 INS42 INS42 INS42 INS42 INS7 INS8 INS12 INS32 INS42 INS32 INS27 INS8 INS42 INS8 INS43 INS42 INS21 INS42 INS42 INS42 INS32 INS21 INS21 INS21 INS44 INS8 INS42 INS42 INS32 INS42 INS42 INS42 INS33 INS21 INS21 INS42 INS32 INS36 INS42 INS32 INS32 INS7 INS43 INS42 INS21 INS42 INS42 INS32 INS32 INS42 INS42 INS32 INS11 INS42 INS42 INS14 INS36 INS42 INS42 INS42 INS33 INS42 INS7 INS42 INS42 INS36 INS42 INS42 INS42 INS42 INS14 INS42 INS42 INS45 INS40 INS43 INS32 INS43 INS40 INS40 INS42 INS11 INS42 INS9 INS11 INS43 INS40 INS40 INS32 INS32 INS42 INS42 INS42 INS42 INS43 INS32 INS43 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL8