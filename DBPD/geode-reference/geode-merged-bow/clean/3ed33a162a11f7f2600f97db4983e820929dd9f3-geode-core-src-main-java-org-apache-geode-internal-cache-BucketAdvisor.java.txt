GEODE-5307 Hang with servers all in waitForPrimaryMember and one server in NO_PRIMARY_HOSTING state

Ignore the primaryElector if it is no longer known to the RegionAdvisor.
This means that the elector has somehow gone away - either it crashed,
shut down or destroyed its region.

-    if (this.primaryElector != null && this.primaryElector.equals(profile.getDistributedMember())) {
+    ProfileId elector = this.primaryElector;
+    if (elector != null && elector.equals(profile.getDistributedMember())) {
-    if (primaryElector != null) {
+    InternalDistributedMember elector = primaryElector;
+    if (elector != null && regionAdvisor.hasPartitionedRegion(elector)) {
+      // another server will determine the primary node
+
+    primaryElector = null;
+
+
-        this.volunteeringDelegate = new VolunteeringDelegate();
+        setVolunteeringDelegate(new VolunteeringDelegate());
+
+  protected void setVolunteeringDelegate(VolunteeringDelegate delegate) {
+    this.volunteeringDelegate = delegate;
+  }
+
-  public void clearPrimaryElector() {
-    synchronized (this) {
-      primaryElector = null;
-    }
+  public synchronized void clearPrimaryElector() {
+    primaryElector = null;
-  public void setPrimaryElector(InternalDistributedMember newPrimaryElector) {
-    synchronized (this) {
-      // Only set the new primary elector if we have not yet seen
-      // a primary for this bucket.
-      if (primaryElector != null) {
+  public synchronized void setPrimaryElector(InternalDistributedMember newPrimaryElector) {
+    // Only set the new primary elector if we have not yet seen
+    // a primary for this bucket.
+    if (this.primaryElector != null) {
+      if (newPrimaryElector != null && !regionAdvisor.hasPartitionedRegion(newPrimaryElector)) {
+        // no longer a participant - don't use it
+        this.primaryElector = null;
+      } else {
-  public synchronized void initializePrimaryElector(InternalDistributedMember primaryElector) {
+  public synchronized void initializePrimaryElector(InternalDistributedMember newPrimaryElector) {
-      this.primaryElector = primaryElector;
+      if (newPrimaryElector != null && !regionAdvisor.hasPartitionedRegion(newPrimaryElector)) {
+        // no longer a participant - don't use it
+        this.primaryElector = null;
+      } else {
+        this.primaryElector = newPrimaryElector;
+      }
-      if (this.primaryElector == null) {
-        volunteerForPrimary();
-      }
+      volunteerForPrimary();

INS31 INS83 INS39 INS42 INS44 MOV8 INS83 MOV8 INS83 INS8 INS60 INS60 INS21 INS43 INS42 INS25 UPD42 INS25 MOV25 INS43 INS59 INS43 INS59 INS27 INS7 INS42 MOV27 INS8 MOV27 INS8 INS42 INS42 INS42 MOV22 INS27 INS42 INS42 INS42 INS27 INS32 INS42 INS33 INS42 MOV25 MOV25 INS42 INS33 INS42 UPD42 MOV42 MOV33 INS42 INS42 INS42 INS8 INS27 MOV8 INS27 INS8 INS8 INS21 INS27 INS38 INS27 INS38 INS21 INS21 INS32 UPD42 MOV42 MOV33 INS32 INS42 INS33 INS32 INS7 INS7 INS42 MOV14 INS42 INS42 INS42 INS33 INS42 INS42 INS42 MOV22 INS33 INS22 INS42 INS52 INS42 DEL27 DEL52 DEL51 DEL8 DEL42 DEL27 DEL52 DEL8 DEL51 DEL8 DEL33 DEL27 DEL42 DEL8 DEL25