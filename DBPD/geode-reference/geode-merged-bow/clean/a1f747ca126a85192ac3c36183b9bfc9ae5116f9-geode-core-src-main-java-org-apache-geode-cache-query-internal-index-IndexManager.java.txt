GEODE-5440: when we need re-evaluate a entry in a index, we need to pass in the outer value key in the equiJoin. (#2338)

* rewrite the flaky test with an integration test
* pass in the value key when doing the equiJoin
* code clean up.
-   * @param operationTime the last modified time from version tag
+   * @param lastModifiedTime the last modified time from version tag
-  public static boolean setIndexBufferTime(long operationTime, long currentCacheTime) {
-    long timeDifference = currentCacheTime - operationTime;
-    return setNewLargestValue(SAFE_QUERY_TIME, currentCacheTime + timeDifference);
+  public static void setIndexBufferTime(long lastModifiedTime, long currentCacheTime) {
+    long oldValue = SAFE_QUERY_TIME.get();
+    long newValue = currentCacheTime + currentCacheTime - lastModifiedTime;
+    if (oldValue < newValue) {
+      // use compare and set in case the value has been changed since we got the old value
+      SAFE_QUERY_TIME.compareAndSet(oldValue, newValue);
+    }
-    return ENABLE_UPDATE_IN_PROGRESS_INDEX_CALCULATION
-        && queryStartTime <= SAFE_QUERY_TIME.get() - queryStartTime + lastModifiedTime;
-  }
-
-  private static boolean setNewLargestValue(AtomicLong value, long newValue) {
-    boolean done = false;
-    while (!done) {
-      long oldValue = value.get();
-      if (oldValue < newValue) {
-        return value.compareAndSet(oldValue, newValue);
-      } else {
-        done = true;
-      }
-    }
-    return false;
+    boolean needsRecalculate =
+        (queryStartTime <= (lastModifiedTime + (SAFE_QUERY_TIME.get() - queryStartTime)));
+    return ENABLE_UPDATE_IN_PROGRESS_INDEX_CALCULATION && needsRecalculate;

INS31 MOV29 MOV83 MOV83 UPD39 MOV39 MOV42 MOV44 MOV44 INS8 UPD42 INS60 MOV60 MOV25 INS60 UPD42 MOV39 INS59 INS39 INS59 INS42 INS32 UPD42 INS27 INS21 INS42 INS36 INS42 MOV42 INS42 INS27 INS42 INS32 MOV27 INS42 INS42 UPD42 MOV42 MOV42 MOV42 MOV42 INS36 MOV27 INS36 MOV27 DEL42 DEL42 DEL32 DEL32 DEL41 DEL42 DEL9 DEL7 DEL21 DEL8 DEL42 DEL42 DEL42 DEL27 DEL59 DEL60 DEL42 DEL42 DEL42 DEL27 DEL32 DEL41 DEL8 DEL31 DEL83 DEL83 DEL39 DEL42 DEL42 DEL43 DEL42 DEL44 DEL39 DEL42 DEL44 DEL39 DEL42 DEL9 DEL59 DEL60 DEL42 DEL38 DEL8 DEL61 DEL9 DEL41 DEL8 DEL31