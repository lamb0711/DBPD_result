GEODE-7237: Fix race condition in GfshRule (#4153)

GfshRule.execute() now blocks while the ProcessLogger is still
collecting output from the GFSH process. This fixes a race condition
that causes ConnectCommandAcceptanceTest.invalidHostname() to fail
intermittently.

Co-authored-by: Aaron Lindsey <alindsey@pivotal.io>
Co-authored-by: Kirk Lund <klund@apache.org>
+import static java.lang.System.lineSeparator;
-import static java.util.stream.Collectors.toList;
-import java.util.List;
+import java.util.concurrent.ExecutionException;
+import java.util.concurrent.TimeUnit;
+import java.util.concurrent.TimeoutException;
-public class ProcessLogger {
+public class ProcessLogger implements AutoCloseable {
-  private final Queue<OutputLine> outputLines = new ConcurrentLinkedQueue<>();
+  private final Queue<OutputLine> outputLines;
+  private final StreamGobbler stdoutGobbler;
+  private final StreamGobbler stderrGobbler;
+    outputLines = new ConcurrentLinkedQueue<>();
+    stdoutGobbler = new StreamGobbler(process.getInputStream(), this::consumeInfoMessage);
+    stderrGobbler = new StreamGobbler(process.getErrorStream(), this::consumeErrorMessage);
+  }
-    StreamGobbler stdOutGobbler =
-        new StreamGobbler(process.getInputStream(), this::consumeInfoMessage);
-    StreamGobbler stdErrGobbler =
-        new StreamGobbler(process.getErrorStream(), this::consumeErrorMessage);
+  public void start() {
+    stdoutGobbler.start();
+    stderrGobbler.start();
+  }
-    stdOutGobbler.startInNewThread();
-    stdErrGobbler.startInNewThread();
+  public String getOutputText() {
+    return outputLines.stream()
+        .map(OutputLine::getLine)
+        .collect(joining(lineSeparator()));
+  }
+
+  @Override
+  public void close() {
+    stdoutGobbler.close();
+    stderrGobbler.close();
+  }
+
+  /**
+   * Blocks until the ProcessLogger finishes collecting the process's output
+   *
+   * @throws InterruptedException if the ProcessLogger's threads are interrupted
+   * @throws ExecutionException if the ProcessLogger's threads throw
+   * @throws TimeoutException if the ProcessLogger does not finish collecting output before the
+   *         timeout
+   */
+  public void awaitTermination(long timeout, TimeUnit unit)
+      throws InterruptedException, ExecutionException, TimeoutException {
+    stdoutGobbler.awaitTermination(timeout, unit);
+    stderrGobbler.awaitTermination(timeout, unit);
-
-  public List<String> getStdOutLines() {
-    return getOutputLines(OutputLine.OutputSource.STD_OUT);
-  }
-
-  public List<String> getStdErrLines() {
-    return getOutputLines(OutputLine.OutputSource.STD_ERR);
-  }
-
-  public List<String> getOutputLines() {
-    return outputLines.stream().map(OutputLine::getLine).collect(toList());
-  }
-
-  public String getOutputText() {
-    return outputLines.stream().map(OutputLine::getLine)
-        .collect(joining(System.lineSeparator()));
-  }
-
-  private List<String> getOutputLines(OutputLine.OutputSource source) {
-    return outputLines.stream().filter(line -> line.getSource().equals(source))
-        .map(OutputLine::getLine).collect(toList());
-  }

MOV26 MOV26 INS26 INS26 MOV31 MOV31 INS40 UPD40 UPD40 INS40 INS43 INS23 INS23 INS42 INS83 INS83 MOV43 INS59 INS83 INS83 MOV43 INS59 INS39 INS42 INS8 MOV43 UPD42 INS78 INS39 INS42 INS29 UPD83 INS39 INS42 INS44 INS43 INS43 INS43 INS8 INS42 INS42 INS21 INS21 INS21 INS42 INS21 INS21 INS65 INS65 INS65 INS65 INS39 INS42 UPD43 UPD42 INS42 INS42 INS42 INS21 INS21 INS7 INS7 INS7 INS32 INS32 INS32 INS32 INS66 INS42 INS66 INS42 INS66 INS42 INS66 INS66 INS42 INS32 INS32 INS42 MOV14 INS42 MOV14 INS42 MOV14 INS42 INS42 UPD42 MOV42 INS42 INS32 UPD42 MOV42 INS42 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 UPD42 MOV42 INS42 UPD42 MOV42 UPD42 MOV42 INS42 MOV32 UPD42 DEL42 DEL59 DEL60 DEL42 DEL59 DEL60 DEL42 DEL42 DEL32 DEL42 DEL42 DEL32 DEL83 DEL42 DEL43 DEL74 DEL42 DEL42 DEL40 DEL32 DEL41 DEL8 DEL31 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL40 DEL32 DEL41 DEL8 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL43 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL90 DEL32 DEL42 DEL42 DEL32 DEL32 DEL32 DEL41 DEL42 DEL43 DEL42 DEL43 DEL74 DEL42 DEL40 DEL42 DEL42 DEL32 DEL42 DEL42 DEL59 DEL32 DEL32 DEL86 DEL32 DEL42 DEL42 DEL90 DEL32 DEL32 DEL32 DEL41 DEL8