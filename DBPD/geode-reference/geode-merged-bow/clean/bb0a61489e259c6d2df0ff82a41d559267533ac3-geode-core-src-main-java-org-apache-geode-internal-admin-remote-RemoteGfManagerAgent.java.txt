GEODE-5262: fix race condition in RemoteGfManagerAgent between removeâ€¦ (#2001)


-  protected InternalDistributedSystem system;
+  protected volatile InternalDistributedSystem system;
+  private final Object systemLock = new Object();
-  private volatile Map membersMap = Collections.EMPTY_MAP;
+  protected volatile Map membersMap = Collections.EMPTY_MAP;
-        if (system != null && ClusterDistributionManager.isDedicatedAdminVM()
-            && system.isConnected()) {
-          system.disconnect();
+        synchronized (systemLock) {
+          if (system != null && ClusterDistributionManager.isDedicatedAdminVM()
+              && system.isConnected()) {
+            system.disconnect();
+          }
+          this.system = null;
-
-        this.system = null;
-        this.system.getCancelCriterion().checkCancelInProgress(null);
+        synchronized (systemLock) {
+          if (system == null) {
+            return null;
+          }
+          this.system.getCancelCriterion().checkCancelInProgress(null);
+        }
+
-
-    if (system != null) {
-      system.disconnect();
-      system = null;
-    }
-
-    this.system = (InternalDistributedSystem) InternalDistributedSystem.connectForAdmin(props);
+
+    synchronized (systemLock) {
+      if (system != null) {
+        system.disconnect();
+        system = null;
+      }
+      this.system = (InternalDistributedSystem) InternalDistributedSystem.connectForAdmin(props);
+    }
+

INS23 INS83 INS83 INS83 INS43 INS59 UPD83 INS42 INS42 INS14 INS51 INS43 INS42 INS8 INS42 MOV25 MOV21 INS51 INS51 INS42 INS8 INS42 INS8 MOV25 MOV21 INS25 MOV21 INS27 INS8 INS42 INS33 INS41 INS33