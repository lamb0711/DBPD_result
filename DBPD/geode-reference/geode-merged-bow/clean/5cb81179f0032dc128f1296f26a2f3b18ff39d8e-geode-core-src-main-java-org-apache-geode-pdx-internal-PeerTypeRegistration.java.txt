Merge geode develop branch

+import org.apache.geode.annotations.VisibleForTesting;
-          updateClassToTypeMap((PdxType) value);
+          updateLocalMaps((PdxType) value);
+
-      int id = getExistingIdForType(newType);
-      if (id != -1) {
-        return id;
+      if (typeToId.isEmpty()) {
+        buildTypeToIdFromIdToType();
+      }
+      // double check if my type is in region in case the typeToId map has been updated while
+      // waiting to obtain a lock
+      existingId = typeToId.get(newType);
+      if (existingId != null) {
+        return existingId;
-      id = allocateTypeId(newType);
+      int id = allocateTypeId(newType);
-
-
-      typeToId.put(newType, id);
-
-  /** Should be called holding the dlock */
-  private int getExistingIdForType(PdxType newType) {
+  private void buildTypeToIdFromIdToType() {
-      int result = -1;
+            if (totalPdxTypeIdInDS >= this.maxTypeId) {
+              throw new InternalGemFireError(
+                  "Used up all of the PDX type ids for this distributed system. The maximum number of PDX types is "
+                      + this.maxTypeId);
+            }
-          if (foundType.equals(newType)) {
-            result = foundType.getTypeId();
-          }
-      if (totalPdxTypeIdInDS == this.maxTypeId) {
-        throw new InternalGemFireError(
-            "Used up all of the PDX type ids for this distributed system. The maximum number of PDX types is "
-                + this.maxTypeId);
-      }
-      return result;
-  private void updateClassToTypeMap(PdxType type) {
+  private void updateLocalMaps(PdxType type) {
+      typeToId.put(type, type.getTypeId());
+
+  @VisibleForTesting
+  public int getTypeToIdSize() {
+    return typeToId.size();
+  }

INS26 INS40 INS31 UPD39 INS42 UPD42 INS78 INS83 INS39 INS42 INS8 INS42 INS41 INS32 INS25 INS21 INS60 INS21 INS42 INS42 INS32 INS8 INS7 INS39 INS59 INS32 INS42 INS42 INS21 INS42 INS32 UPD42 INS33 INS42 MOV32 INS42 INS42 INS42 INS32 INS32 INS42 UPD42 MOV42 MOV42 UPD42 INS42 INS42 INS42 INS8 MOV21 INS25 INS27 MOV8 UPD42 INS42 MOV22 MOV53 DEL39 DEL42 DEL32 DEL59 DEL60 DEL34 DEL38 DEL42 DEL7 DEL21 DEL42 DEL42 DEL42 DEL42 DEL32 DEL21 DEL66 DEL65 DEL29 DEL42 DEL42 DEL43 DEL42 DEL44 DEL39 DEL42 DEL34 DEL38 DEL59 DEL60 DEL42 DEL42 DEL42 DEL32 DEL42 DEL42 DEL42 DEL32 DEL7 DEL21 DEL8 DEL25 DEL42 DEL27 DEL25 DEL42 DEL41