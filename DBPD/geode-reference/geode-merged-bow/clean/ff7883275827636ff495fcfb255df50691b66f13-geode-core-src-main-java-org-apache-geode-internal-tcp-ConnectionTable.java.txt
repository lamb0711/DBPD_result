GEODE-6927 make getThreadOwnedConnection code thread safe (#4085)

* GEODE-6927 make getThreadOwnedConnection code thread safe

* changes due to comments

* fix spotlessAply

* fix clean method

* remove null checks

* empty commit to re-trigger CI

+import org.apache.geode.internal.util.JavaWorkarounds;
-  private ConcurrentMap threadConnectionMap;
+  private final ConcurrentMap threadConnectionMap;
-    if (this.threadConnectionMap == null) {
-      // This instance is being destroyed; fail the operation
-      closeCon(
-          "Connection table being destroyed",
-          result);
-      return null;
-    }
-
-    ArrayList al = (ArrayList) this.threadConnectionMap.get(id);
+    ArrayList al = (ArrayList) threadConnectionMap.get(id);
-      Object o = this.threadConnectionMap.putIfAbsent(id, al);
+      ArrayList tempAl = al;
+      Object o = JavaWorkarounds.computeIfAbsent(this.threadConnectionMap, id, k -> tempAl);
+
-      this.threadConnectionMap = null;
+      synchronized (this.threadConnectionMap) {
+        for (Iterator it = this.threadConnectionMap.values().iterator(); it.hasNext();) {
+          ArrayList al = (ArrayList) it.next();
+          if (al != null) {
+            synchronized (al) {
+              for (Object o : al) {
+                closeCon("Connection table being destroyed", o);
+              }
+            }
+          }
+        }
+        this.threadConnectionMap.clear();
+      }

INS26 INS40 INS83 INS60 INS25 INS43 MOV59 MOV27 INS8 INS42 INS60 INS51 MOV43 INS32 MOV43 INS59 MOV43 INS59 MOV22 INS8 INS42 INS42 INS42 INS42 INS42 INS42 INS32 INS24 INS21 INS42 INS42 MOV22 INS42 INS86 INS58 INS32 INS8 MOV32 INS59 INS42 INS43 MOV59 INS42 INS42 INS60 MOV25 UPD42 INS42 INS42 UPD42 INS32 INS43 INS59 INS27 INS8 MOV32 INS42 INS42 INS42 INS11 INS42 INS33 INS51 UPD42 INS43 INS32 INS42 INS8 INS42 INS42 INS42 INS70 INS44 INS42 INS8 INS43 INS42 MOV21 INS42 INS32 INS42 INS45 INS42 DEL33 DEL27 DEL42 DEL45 DEL42 DEL32 DEL21 DEL33 DEL41 DEL8 DEL25 DEL60 DEL42 DEL42 DEL33 DEL7 DEL8 DEL42