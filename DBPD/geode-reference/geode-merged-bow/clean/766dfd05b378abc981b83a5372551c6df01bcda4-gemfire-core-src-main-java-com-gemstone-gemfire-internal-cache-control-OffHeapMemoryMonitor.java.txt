merge of develop to feature/GEODE-77

Merge remote-tracking branch 'origin/develop' into feature/GEODE-77

Conflicts:
	gemfire-core/build.gradle
	gemfire-core/src/main/java/com/gemstone/gemfire/internal/cache/LocalRegion.java
	gemfire-jgroups/build.gradle

+    Thread threadToWaitFor = null;
-
-      if (waitForThread && this.memoryListenerThread != null) {
-        try {
-          this.memoryListenerThread.join();
-        } catch (InterruptedException e) {
-          Thread.currentThread().interrupt();
-        }
+      if (waitForThread) {
+        threadToWaitFor = this.memoryListenerThread;
+    if (threadToWaitFor != null) {
+      try {
+        threadToWaitFor.join();
+      } catch (InterruptedException e) {
+        Thread.currentThread().interrupt();
+      }
+    }
-          if (lastOffHeapMemoryUsed == this.offHeapMemoryUsed && !this.stopRequested) {
-            try {
+          long newOffHeapMemoryUsed = this.offHeapMemoryUsed;
+          if (this.stopRequested) {
+            // no need to wait since we are stopping
+          } else if (lastOffHeapMemoryUsed != newOffHeapMemoryUsed) {
+            // no need to wait since memory used has changed
+            // This fixes a race like bug GEODE-500
+            lastOffHeapMemoryUsed = newOffHeapMemoryUsed;
+          } else {
+            // wait for memory used to change
+            try {  
-                if (this.offHeapMemoryUsed == lastOffHeapMemoryUsed) {
+                newOffHeapMemoryUsed = this.offHeapMemoryUsed;
+                if (newOffHeapMemoryUsed == lastOffHeapMemoryUsed) {
-                  lastOffHeapMemoryUsed = this.offHeapMemoryUsed;
+                  lastOffHeapMemoryUsed = newOffHeapMemoryUsed;

MOV8 INS60 INS51 INS43 INS59 INS52 INS8 INS27 INS42 INS42 INS33 MOV25 MOV21 MOV21 MOV51 INS25 MOV21 MOV21 INS42 MOV33 INS42 MOV8 INS8 INS21 INS7 INS32 INS60 INS25 INS42 MOV22 INS42 INS42 INS39 INS59 INS22 INS8 MOV25 INS42 MOV22 INS52 INS42 INS27 INS8 MOV42 INS42 INS21 INS7 INS42 INS42 MOV21 UPD42 INS42 INS21 INS7 INS42 INS42 DEL42 DEL32 DEL42 DEL52 DEL42 DEL22 DEL27 DEL27 DEL52 DEL51 DEL8 DEL27 DEL52 DEL42 DEL22 DEL38 DEL27 DEL52 DEL42 DEL22