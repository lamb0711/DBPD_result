GEODE-8174: Fix ConcurrentModificationException when using JTA transaction. (#5161)


+
-import java.util.ArrayList;
-import java.util.Collections;
-import java.util.HashSet;
+import java.util.concurrent.CopyOnWriteArrayList;
+import org.apache.geode.internal.CopyOnWriteHashSet;
-  private final List<ConnectionEventListener> listeners;
+  private final List<ConnectionEventListener> listeners = new CopyOnWriteArrayList<>();;
-  private final Set<GFConnectionImpl> connections;
+  private final Set<GFConnectionImpl> connections = new CopyOnWriteHashSet<>();;
-  private volatile JCALocalTransaction localTransaction;
+  private volatile JCALocalTransaction localTransaction = new JCALocalTransaction();;
-    this.listeners = Collections.synchronizedList(new ArrayList<>());
-    this.localTransaction = new JCALocalTransaction();
-    this.connections = Collections.synchronizedSet(new HashSet<>());
-      if (this.initialized && !this.cache.isClosed()) {
+      if (this.initialized && !isCacheClosed()) {
+  private boolean isCacheClosed() {
+    if (this.cache != null) {
+      return this.cache.isClosed();
+    }
+    return true;
+  }
+
-    if (!this.initialized || this.cache.isClosed()) {
+    if (!this.initialized || isCacheClosed()) {
+    if (this.cache == null) {
+      throw new RuntimeException("Cache could not be found in JCAManagedConnection");
+    }
-    if (this.initialized && !this.cache.isClosed()) {
+    if (this.initialized && !isCacheClosed()) {
-      if (this.initialized && !this.cache.isClosed()) {
+      if (this.initialized && !isCacheClosed()) {

MOV26 MOV26 UPD40 UPD40 INS31 INS31 MOV42 MOV44 INS8 INS83 INS39 INS42 INS8 INS14 INS14 MOV14 MOV21 INS25 INS41 INS25 INS74 INS74 INS27 INS8 INS9 INS27 INS8 INS43 INS43 INS22 INS33 INS41 INS22 INS33 INS53 INS42 INS42 MOV52 UPD42 MOV42 MOV32 UPD42 INS52 INS42 INS14 INS43 INS45 UPD42 INS32 INS42 INS42 UPD42 DEL40 DEL26 DEL52 DEL42 DEL22 DEL42 DEL42 DEL42 DEL43 DEL74 DEL14 DEL32 DEL7 DEL21 DEL52 DEL42 DEL22 DEL7 DEL21 DEL22 DEL42 DEL42 DEL42 DEL43 DEL74 DEL14 DEL32 DEL7 DEL21 DEL8 DEL31 DEL52 DEL42 DEL22 DEL52 DEL42 DEL22 DEL52 DEL42 DEL22