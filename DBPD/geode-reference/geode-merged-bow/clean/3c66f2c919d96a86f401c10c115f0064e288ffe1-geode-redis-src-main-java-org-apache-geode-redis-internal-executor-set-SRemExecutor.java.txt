GEODE-8048: change redis sets to use functions and deltas (#5009)


Co-authored-by: Darrel Schneider <dschneider@pivotal.io>
Co-authored-by: Sarah Abbey <sabbey@pivotal.io>
Co-authored-by: John Hutchison <jhutchison@pivotal.io>
Co-authored-by: Jens Deppe <jdeppe@pivotal.io>
+import java.util.ArrayList;
+import java.util.concurrent.atomic.AtomicBoolean;
-    List<ByteArrayWrapper> commandElems = command.getProcessedCommandWrappers();
+    List<ByteArrayWrapper> commandElements = command.getProcessedCommandWrappers();
-    if (commandElems.size() < 3) {
+    if (commandElements.size() < 3) {
-    RedisSet set = new GeodeRedisSetSynchronized(key, context);
-    long numRemoved = set.srem(commandElems.subList(2, commandElems.size()));
-    command.setResponse(Coder.getIntegerResponse(context.getByteBufAllocator(), numRemoved));
+    RedisSet geodeRedisSet =
+        new GeodeRedisSetWithFunctions(key, context.getRegionProvider().getSetRegion());
+
+
+    ArrayList<ByteArrayWrapper> membersToRemove =
+        new ArrayList<>(commandElements.subList(2, commandElements.size()));
+    AtomicBoolean setWasDeleted = new AtomicBoolean();
+    long membersRemoved = geodeRedisSet.srem(membersToRemove, setWasDeleted);
+    if (setWasDeleted.get()) {
+      context.getKeyRegistrar().unregisterIfType(key, RedisDataType.REDIS_SET);
+    }
+    command.setResponse(Coder.getIntegerResponse(context.getByteBufAllocator(), membersRemoved));

INS26 INS26 INS40 INS40 INS60 INS60 INS25 INS74 INS43 INS59 INS39 INS59 INS32 INS8 UPD42 UPD42 INS43 INS43 UPD42 INS14 INS42 INS42 INS14 INS42 INS32 INS42 INS42 INS21 UPD42 UPD43 INS32 INS42 INS42 INS74 INS32 INS43 INS42 INS42 INS42 INS42 INS32 UPD42 UPD42 INS32 INS42 INS43 UPD42 MOV42 MOV42 MOV34 MOV32 INS42 INS32 INS42 INS42 INS40 INS42 INS42 INS42 UPD42 INS42 INS42 DEL42 DEL39 DEL42 DEL42 DEL32 DEL32