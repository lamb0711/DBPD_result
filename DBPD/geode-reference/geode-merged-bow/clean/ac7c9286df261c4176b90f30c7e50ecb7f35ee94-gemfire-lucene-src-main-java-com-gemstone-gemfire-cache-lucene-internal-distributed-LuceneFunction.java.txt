GEODE-11: Use QueryProvider in LuceneFunction

LuceneFunction needs query object for execution. If the argement is missing,
fail the function execution

https://reviews.apache.org/r/38513/

+import org.apache.lucene.search.Query;
+import com.gemstone.gemfire.cache.lucene.LuceneQueryProvider;
+import com.gemstone.gemfire.cache.query.QueryException;
-  private RepositoryManager repoManager;
+  private static RepositoryManager repoManager;
-    if (logger.isDebugEnabled()) {
-      logger.debug("Executing lucene query on region:" + region.getFullPath());
+
+    LuceneFunctionContext<IndexResultCollector> searchContext = (LuceneFunctionContext) ctx.getArguments();
+    if (searchContext == null) {
+      resultSender.sendException(new IllegalArgumentException("Missing search context"));
+      return;
-    LuceneFunctionContext searchContext = (LuceneFunctionContext) ctx.getArguments();
+    LuceneQueryProvider queryProvider = searchContext.getQueryProvider();
+    if (queryProvider == null) {
+      resultSender.sendException(new IllegalArgumentException("Missing query provider"));
+      return;
+    }
+
+    Query query = null;
+    try {
+      query = queryProvider.getQuery();
+    } catch (QueryException e) {
+      resultSender.sendException(e);
+      return;
+    }
+
+    if (logger.isDebugEnabled()) {
+      logger.debug("Executing lucene query: {}, on region {}", query, region.getFullPath());
+    }
-      Collection<IndexRepository> repositories = repoManager.getRepositories(region, ctx);
+      Collection<IndexRepository> repositories = getIndexRepositories(ctx, region);
-        repo.query(null, 0, collector);
+        repo.query(query, 0, collector);
-  void setRepositoryManager(RepositoryManager manager) {
-    this.repoManager = manager;
+  private Collection<IndexRepository> getIndexRepositories(RegionFunctionContext ctx, Region region) throws BucketNotFoundException {
+    synchronized (LuceneFunction.class) {
+      return repoManager.getRepositories(region, ctx);
+    }
+  }
+
+  static synchronized void setRepositoryManager(RepositoryManager manager) {
+    repoManager = manager;

INS26 INS26 INS26 INS40 INS40 INS40 INS31 INS83 MOV25 INS83 MOV74 INS42 INS44 INS44 INS43 INS8 INS83 INS83 INS25 INS60 INS25 INS60 INS54 INS43 INS42 INS43 INS42 INS42 INS51 INS74 INS27 INS8 INS43 INS59 INS27 INS8 INS43 INS59 INS8 INS12 INS42 INS42 INS57 INS8 MOV43 INS43 INS42 INS33 INS21 INS41 INS42 INS42 INS32 INS42 INS33 INS21 INS41 INS42 INS42 INS33 INS21 INS44 INS8 INS43 INS41 INS42 INS42 INS32 INS42 INS42 INS32 INS7 INS43 INS42 INS21 INS41 INS74 INS42 MOV32 INS42 INS42 INS14 INS42 INS42 INS14 INS42 INS32 INS42 INS32 INS45 INS42 MOV32 INS43 INS43 INS32 INS43 INS45 INS43 INS45 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL45 DEL27 DEL33 DEL52 DEL42 DEL22