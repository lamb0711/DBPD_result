GEODE-6897: implement CMS rebalance operation (#3820)


+import java.util.Date;
+import java.util.List;
-import java.util.function.Function;
+import java.util.function.BiFunction;
+import org.apache.geode.cache.Cache;
+import org.apache.geode.internal.cache.InternalCache;
-import org.apache.geode.management.api.JsonSerializable;
+import org.apache.geode.management.operation.RebalanceOperation;
+import org.apache.geode.management.runtime.OperationResult;
-  private final Map<Class<? extends ClusterManagementOperation>, Function> performers;
+  private final Map<Class<? extends ClusterManagementOperation>, BiFunction> performers;
+  private final InternalCache cache;
-  public OperationManager(OperationHistoryManager historyManager) {
+  public OperationManager(InternalCache cache, OperationHistoryManager historyManager) {
+    this.cache = cache;
+    registerOperation(RebalanceOperation.class, RebalanceOperationPerformer::perform);
-  public <A extends ClusterManagementOperation<V>, V extends JsonSerializable> void registerOperation(
-      Class<A> operationClass, Function<A, V> operationPerformer) {
+  public <A extends ClusterManagementOperation<V>, V extends OperationResult> void registerOperation(
+      Class<A> operationClass, BiFunction<Cache, A, V> operationPerformer) {
-  public <A extends ClusterManagementOperation<V>, V extends JsonSerializable> OperationInstance<A, V> submit(
+  public <A extends ClusterManagementOperation<V>, V extends OperationResult> OperationInstance<A, V> submit(
-    Function<A, V> performer = getPerformer(op);
+    BiFunction<Cache, A, V> performer = getPerformer(op);
-        CompletableFuture.supplyAsync(() -> performer.apply(op), executor);
+        CompletableFuture.supplyAsync(() -> performer.apply(cache, op), executor);
-    OperationInstance<A, V> inst = new OperationInstance<>(future, opId, op);
+    OperationInstance<A, V> inst = new OperationInstance<>(future, opId, op, new Date());
-  private <A extends ClusterManagementOperation<V>, V extends JsonSerializable> Function<A, V> getPerformer(
+  private <C extends Cache, A extends ClusterManagementOperation<V>, V extends OperationResult> BiFunction<C, A, V> getPerformer(
-    return performers.get(op.getClass());
+    Class<? extends ClusterManagementOperation> aClass = op.getClass();
+
+    if (op instanceof TaggedWithOperator
+        && ClusterManagementOperation.class.isAssignableFrom(aClass.getSuperclass())) {
+      aClass = (Class<? extends ClusterManagementOperation>) aClass.getSuperclass();
+    }
+
+    return performers.get(aClass);
-  @SuppressWarnings("unchecked")
-  public <V extends JsonSerializable> CompletableFuture<V> getStatus(String opId) {
-    return historyManager.getStatus(opId);
+  public <A extends ClusterManagementOperation<V>, V extends OperationResult> OperationInstance<A, V> getOperationInstance(
+      String opId) {
+    return historyManager.getOperationInstance(opId);
+  }
+
+  public <A extends ClusterManagementOperation<V>, V extends OperationResult> List<OperationInstance<A, V>> listOperationInstances(
+      A opType) {
+    return historyManager.listOperationInstances(opType);

MOV26 INS26 INS26 INS26 INS26 INS26 INS40 INS40 UPD40 INS40 INS40 INS40 UPD40 INS23 INS31 UPD74 INS83 INS83 INS43 INS59 INS44 MOV79 INS83 INS73 MOV73 INS73 UPD74 MOV74 INS42 MOV44 INS8 MOV29 UPD83 INS73 UPD74 UPD42 MOV44 INS73 INS74 UPD42 INS44 UPD43 INS42 INS42 INS43 INS42 INS21 INS21 UPD43 INS74 UPD43 INS42 INS43 INS42 INS43 UPD43 INS43 INS60 INS25 INS41 INS42 INS74 UPD43 UPD43 INS42 INS74 UPD43 INS43 INS74 INS43 INS42 UPD42 INS42 INS7 INS32 UPD42 INS43 INS43 INS43 INS43 UPD42 UPD74 INS42 INS42 UPD42 INS42 INS74 INS59 INS27 INS8 INS32 INS43 INS43 UPD42 UPD42 INS43 INS43 UPD42 INS42 UPD43 MOV43 INS43 MOV43 INS42 INS22 INS42 INS42 INS57 INS90 INS42 INS42 INS42 INS42 UPD43 INS43 INS43 INS76 INS42 MOV32 INS62 INS32 INS21 INS42 INS42 INS42 INS42 INS42 UPD42 UPD42 INS42 INS42 INS42 UPD42 INS42 UPD42 UPD42 INS52 INS42 INS43 INS42 INS42 UPD42 INS42 INS14 INS42 INS43 INS42 INS43 INS57 INS42 INS32 INS7 INS42 INS43 INS42 INS42 INS43 INS42 INS42 INS42 INS11 INS42 INS42 INS42 INS74 INS32 INS43 INS76 INS42 INS42 INS42 INS43 INS42 DEL42 DEL45 DEL79 DEL74