GEODE-5559: Improve runtime of RegionVersionHolder.canonicalExceptions (#2298)

This modifies the RVVException to iterate over the received version newest to
oldest, which makes generating the canonical exceptions much more
straightforward.


-    int size = 0;
-    long[] deltas = null;
-    long last = this.previousVersion;
+    final int size = received == null ? 1 : received.length() + 1;
+
+    int deltaIndex = size - 1;
+    long[] deltas = new long[size];
+    long last = this.nextVersion;
-    for (ReceivedVersionsIterator it = receivedVersionsIterator(); it.hasNext();) {
+    for (ReceivedVersionsReverseIterator it = receivedVersionsReverseIterator(); it.hasNext();) {
-      long delta = version.longValue() - last;
-      if (deltas == null) {
-        deltas = new long[this.received.length()];
-      }
-      deltas[size++] = delta;
+      long delta = last - version.longValue();
+      deltas[--deltaIndex] = delta;
-    InternalDataSerializer.writeUnsignedVL(size, out);
+    deltas[0] = last - this.previousVersion;
+    InternalDataSerializer.writeUnsignedVL(size - 1, out);
-    for (int i = 0; i < size; i++) {
-      InternalDataSerializer.writeUnsignedVL(deltas[i], out);
+    for (long value : deltas) {
+      InternalDataSerializer.writeUnsignedVL(value, out);
-
-    // Write each version in the exception as a delta from the previous version
-    // this will likely be smaller than the absolute value, so it will
-    // be more likely to fit into a byte or a short.
-    long delta = this.nextVersion - last;
-    InternalDataSerializer.writeUnsignedVL(delta, out);
-  // @Override
-  // public int hashCode() {
-  // final int prime = 31;
-  // int result = 1;
-  // result = prime * result + (int) (nextVersion ^ (nextVersion >>> 32));
-  // result = prime * result
-  // + (int) (previousVersion ^ (previousVersion >>> 32));
-  // result = prime * result + ((this.received == null) ? 0 : this.received.hashCode());
-  // return result;
-  // }
-
-  public ReceivedVersionsIterator receivedVersionsIterator() {
-    ReceivedVersionsIteratorB result = new ReceivedVersionsIteratorB();
-    result.initForForwardIteration();
-    return result;
+  public ReceivedVersionsReverseIterator receivedVersionsReverseIterator() {
+    return new ReceivedVersionsReverseIteratorB();
-
-
-  protected class ReceivedVersionsIteratorB extends ReceivedVersionsIterator {
+  protected class ReceivedVersionsReverseIteratorB extends ReceivedVersionsReverseIterator {
-    void initForForwardIteration() {
+    ReceivedVersionsReverseIteratorB() {
-        this.nextIndex = -1;
+        nextIndex = -1;
-        this.nextIndex = received.nextSetBit((int) (previousVersion - receivedBaseVersion + 1));
-        if (this.nextIndex + receivedBaseVersion >= nextVersion) {
-          this.nextIndex = -1;
+        this.nextIndex = received.previousSetBit((int) (nextVersion - receivedBaseVersion - 1));
+        if (nextIndex + receivedBaseVersion <= previousVersion) {
+          nextIndex = -1;
-      advance();
+      this.nextIndex = received.previousSetBit(this.index - 1);
+      if (nextIndex + receivedBaseVersion <= previousVersion) {
+        nextIndex = -1;
+      }
-
-    private void advance() {
-      this.nextIndex = received.nextSetBit(this.index + 1);
-      if ((this.nextIndex + receivedBaseVersion) >= nextVersion) {
-        this.nextIndex = -1;
-      }
-    }
-

MOV60 UPD43 UPD42 UPD42 UPD43 INS21 INS70 UPD42 INS41 UPD42 UPD42 INS83 INS39 MOV5 INS7 INS44 INS42 INS8 INS14 INS25 INS16 UPD42 INS27 UPD42 MOV3 INS42 MOV22 UPD43 INS2 INS27 INS27 INS39 INS42 MOV21 UPD43 MOV43 MOV8 INS7 INS27 MOV8 INS27 INS34 INS27 INS42 INS34 INS42 UPD42 INS42 INS34 INS42 MOV22 INS42 INS34 UPD42 MOV22 INS32 INS27 INS42 INS42 INS33 INS32 INS34 UPD42 MOV32 INS42 UPD27 MOV8 UPD42 MOV42 INS42 INS27 INS42 INS42 INS42 INS42 INS38 INS42 MOV22 UPD42 MOV22 INS34 INS42 INS42 UPD42 INS42 INS42 UPD27 UPD42 MOV42 MOV42 DEL34 DEL33 DEL39 DEL52 DEL42 DEL22 DEL42 DEL32 DEL42 DEL42 DEL27 DEL42 DEL33 DEL27 DEL42 DEL7 DEL21 DEL8 DEL25 DEL42 DEL37 DEL42 DEL42 DEL42 DEL2 DEL39 DEL42 DEL34 DEL59 DEL58 DEL42 DEL42 DEL27 DEL42 DEL37 DEL8 DEL24 DEL42 DEL42 DEL42 DEL42 DEL32 DEL21 DEL42 DEL43 DEL42 DEL14 DEL59 DEL60 DEL42 DEL42 DEL32 DEL21 DEL42 DEL41 DEL39 DEL52 DEL42 DEL22 DEL52 DEL42 DEL22 DEL27 DEL52 DEL42 DEL22 DEL32 DEL52 DEL42 DEL22 DEL83 DEL39 DEL42 DEL42 DEL42 DEL34 DEL27 DEL32 DEL7 DEL21 DEL52 DEL42 DEL22 DEL42 DEL27 DEL36 DEL42 DEL27 DEL25 DEL8 DEL31