GEODE-3245: Flattening LuceneSerializer should support PDX values (#965)


+import java.lang.reflect.Array;
+import org.apache.geode.pdx.PdxInstance;
-      Object[] array = (Object[]) fieldValue;
-      for (Object item : array) {
+      for (int i = 0; i < Array.getLength(fieldValue); i++) {
+        Object item = Array.get(fieldValue, i);
-    Class<?> clazz = value.getClass();
-    if (fieldName.equals(LuceneService.REGION_VALUE_FIELD)
-        && SerializerUtil.supportedPrimitiveTypes().contains(clazz)) {
-      return value;
-    }
-    try {
-      Field field = clazz.getDeclaredField(fieldName);
-      field.setAccessible(true);
-      return field.get(value);
-    } catch (Exception e) {
-      return null;
+    if (value instanceof PdxInstance) {
+      PdxInstance pdx = (PdxInstance) value;
+      Object fieldValue = null;
+      if (pdx.hasField(fieldName)) {
+        fieldValue = pdx.getField(fieldName);
+      }
+      return fieldValue;
+    } else {
+      Class<?> clazz = value.getClass();
+      if (fieldName.equals(LuceneService.REGION_VALUE_FIELD)
+          && SerializerUtil.supportedPrimitiveTypes().contains(clazz)) {
+        return value;
+      }
+      try {
+        Field field = clazz.getDeclaredField(fieldName);
+        field.setAccessible(true);
+        return field.get(value);
+      } catch (Exception e) {
+        return null;
+      }

INS26 INS26 INS40 INS40 INS8 INS25 INS62 INS8 MOV8 INS24 INS42 INS43 INS60 INS60 INS25 INS41 INS58 INS27 INS37 MOV8 INS42 INS43 INS59 MOV43 INS59 INS32 INS8 INS42 INS39 INS59 INS42 INS32 INS42 INS60 INS42 INS42 INS11 INS42 INS33 INS42 INS42 INS42 INS21 INS42 INS34 INS42 INS42 INS42 MOV43 INS59 INS43 INS42 INS7 INS42 INS32 INS42 INS42 INS32 INS42 INS42 INS42 INS42 INS42 INS42 INS42 DEL42 DEL43 DEL85 DEL5 DEL42 DEL85 DEL5 DEL42 DEL11 DEL59 DEL60 DEL42 DEL44 DEL42 DEL70